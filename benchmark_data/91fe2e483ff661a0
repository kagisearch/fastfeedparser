<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://pikku.dev/blog</id>
    <title>Pikku Blog</title>
    <updated>2025-11-09T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://pikku.dev/blog"/>
    <subtitle>Pikku Blog</subtitle>
    <icon>https://pikku.dev/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Pikku 0.10 â€” Smart Tree-Shaking and CLI support!]]></title>
        <id>https://pikku.dev/blog/2025/11/09/pikku-0.10</id>
        <link href="https://pikku.dev/blog/2025/11/09/pikku-0.10"/>
        <updated>2025-11-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Pikku 0.10 delivers production-ready tree-shaking with service aggregation, a revolutionized CLI framework, and major middleware improvements.]]></summary>
        <content type="html"><![CDATA[<p>Pikku 0.10 represents a massive leap in <strong>production readiness</strong> and <strong>developer experience</strong>. This release focuses on <strong>intelligent tree-shaking</strong> that dramatically reduces bundle sizes, a way to create CLI's from your functions that run locally or remote and major middleware improvements.</p>
<blockquote>
<p>tl;dr: smaller bundles via service aggregation, CLI-over-Channel streaming, and middleware/permission factories.</p>
</blockquote>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-cli-framework">âš¡ CLI Framework<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#-cli-framework" class="hash-link" aria-label="Direct link to âš¡ CLI Framework" title="Direct link to âš¡ CLI Framework" translate="no">â€‹</a></h2>
<p>The CLI has been completely rewritten for 0.10 with streaming, RPC support, and channel execution.</p>
<p>CLI commands are Pikku RPCs, enabling:</p>
<ul>
<li class=""><strong>Type safety</strong> for all commands</li>
<li class=""><strong>Middleware</strong> and <strong>permissions</strong> support</li>
<li class=""><strong>Local or remote</strong> execution</li>
<li class=""><strong>Streaming output</strong> via websockets when remote</li>
</ul>
<p>To wire up a CLI you simply mention the CLI layout you want,
with full type support on functions.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wireCLI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  program</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'calc-tool'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Mathematical calculator CLI'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Global options (inherited by all commands)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verbose</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Enable verbose output'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      short</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'v'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  commands</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Command group with subcommands</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    calc</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Mathematical calculations'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      subcommands</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pikkuCLICommand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          parameters</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'&lt;a&gt; &lt;b&gt;'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> addNumbers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Add two numbers'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          render</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> calcRenderer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        subtract</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pikkuCLICommand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          parameters</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'&lt;a&gt; &lt;b&gt;'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> subtractNumbers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Subtract two numbers'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          render</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> calcRenderer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="creating-your-cli">Creating your CLI<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#creating-your-cli" class="hash-link" aria-label="Direct link to Creating your CLI" title="Direct link to Creating your CLI" translate="no">â€‹</a></h3>
<p>To create a CLI, simply add the cli name to your <code>pikku.config.json</code></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"cli"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"entrypoints"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"my-cli"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"local"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"src/cli-local.ts"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"channel"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cli"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"route"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/cli"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"wirePath"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"src/cli-channel.ts"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"path"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"src/cli-remote.ts"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>This will create a local CLI (think commander JS), and would also create a Remote Websocket CLI server you can run your commands against!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="renderering-output">Renderering Output<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#renderering-output" class="hash-link" aria-label="Direct link to Renderering Output" title="Direct link to Renderering Output" translate="no">â€‹</a></h3>
<p>CLI output can then be rendered either directly via your functions (as we normally do with a logger), or a via render function. This is what allows you to run against a server but have it render as if it's local.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Calculator result renderer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> calcRenderer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuCLIRender</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  expression</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  result</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">number</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Expression: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">output</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">expression</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Result: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">output</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">result</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// JSON fallback renderer (global)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> jsonRenderer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pikkuCLIRender</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Table renderer for lists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> tableRenderer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuCLIRender</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> items</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">any</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">[</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">]</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">;</span><span class="token generic-function generic class-name"> total</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">number</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Found </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">output</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">total</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> items:</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="get-started">Get Started<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#get-started" class="hash-link" aria-label="Direct link to Get Started" title="Direct link to Get Started" translate="no">â€‹</a></h3>
<p>Try the CLI template:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npm create pikku@latest -- --template cli</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a class="" href="https://pikku.dev/?wiring=cli#code-examples">View CLI examples â†’</a></strong> â€¢ <strong><a href="https://pikku.dev/docs/wiring/cli" target="_blank" rel="noopener noreferrer" class="">CLI docs â†’</a></strong></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="intelligent-tree-shaking-only-bundle-what-you-use">Intelligent Tree-Shaking: Only Bundle What You Use<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#intelligent-tree-shaking-only-bundle-what-you-use" class="hash-link" aria-label="Direct link to Intelligent Tree-Shaking: Only Bundle What You Use" title="Direct link to Intelligent Tree-Shaking: Only Bundle What You Use" translate="no">â€‹</a></h2>
<p>Pikku 0.10 introduces <strong>service awareness</strong>, built into the inspection phase that analyzes your entire codebase to determine exactly which services are actually used.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-it-works">How It Works<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#how-it-works" class="hash-link" aria-label="Direct link to How It Works" title="Direct link to How It Works" translate="no">â€‹</a></h3>
<p>Pikku now tracks service usage across:</p>
<ul>
<li class="">Functions themselves</li>
<li class="">Middleware chains</li>
<li class="">Permission guards</li>
<li class="">Session factories</li>
<li class="">Tag-based registrations</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Generate optimized bundle with service tracking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pikku --tags 'web,api' --types 'http,channel'</span><br></span></code></pre></div></div>
<p>The result? <strong>Dramatically smaller bundles</strong> with only the services you actually need.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="service-map-generation">Service Map Generation<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#service-map-generation" class="hash-link" aria-label="Direct link to Service Map Generation" title="Direct link to Service Map Generation" translate="no">â€‹</a></h3>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Generated service map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> serviceMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  logger</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  database</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  jwt</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//- not used, excluded from bundle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  s3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// - not used, excluded from bundle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>This enables <strong>lazy loading</strong> of optional services:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">singletonServices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">email</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> EmailService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">import</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'@my-app/email'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EmailService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="advanced-filtering">Advanced Filtering<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#advanced-filtering" class="hash-link" aria-label="Direct link to Advanced Filtering" title="Direct link to Advanced Filtering" translate="no">â€‹</a></h3>
<p>Wildcard and name-based filtering for precise control:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Include only admin and API routes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pikku --tags 'admin,api'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Exclude edge-incompatible functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pikku --exclude-tags 'server-only'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Filter by function name patterns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pikku --names 'user*,auth*'</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/pikku-cli/tree-shaking" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ Tree-Shaking and Filtering</a></strong></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="middleware--permissions-evolution">Middleware &amp; Permissions Evolution<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#middleware--permissions-evolution" class="hash-link" aria-label="Direct link to Middleware &amp; Permissions Evolution" title="Direct link to Middleware &amp; Permissions Evolution" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="factory-pattern-with-metadata">Factory Pattern with Metadata<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#factory-pattern-with-metadata" class="hash-link" aria-label="Direct link to Factory Pattern with Metadata" title="Direct link to Factory Pattern with Metadata" translate="no">â€‹</a></h3>
<p>Middleware and permissions now support <strong>factories</strong> with <strong>optional metadata</strong>:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> requireRole </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuMiddlewareFactory</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> role</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'requireRole'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Enforce user role requirement'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> role </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> interaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">role </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> role</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">UnauthorizedError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Requires </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">role</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> role</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Usage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireHTTP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/admin'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  middleware</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">requireRole</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> role</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'admin'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="permission-factories">Permission Factories<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#permission-factories" class="hash-link" aria-label="Direct link to Permission Factories" title="Direct link to Permission Factories" translate="no">â€‹</a></h3>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> canEditResource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuPermissionFactory</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  resourceType</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'canEditResource'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Check if user can edit resource'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> resourceType </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> resource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resourceType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ownerId </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="developer-experience-improvements">Developer Experience Improvements<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#developer-experience-improvements" class="hash-link" aria-label="Direct link to Developer Experience Improvements" title="Direct link to Developer Experience Improvements" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="react-style-error-codes">React-Style Error Codes<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#react-style-error-codes" class="hash-link" aria-label="Direct link to React-Style Error Codes" title="Direct link to React-Style Error Codes" translate="no">â€‹</a></h3>
<p>Errors now include documentation codes so you can look it up on the website.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="mcp-uri-validation">MCP URI Validation<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#mcp-uri-validation" class="hash-link" aria-label="Direct link to MCP URI Validation" title="Direct link to MCP URI Validation" translate="no">â€‹</a></h3>
<p>Compile-time validation for Model Context Protocol resources:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wireMCPResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uri</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'user/{userId}/posts/{postId}'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Validated at build time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> getPost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance-optimizations">Performance Optimizations<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#performance-optimizations" class="hash-link" aria-label="Direct link to Performance Optimizations" title="Direct link to Performance Optimizations" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="caching-system">Caching System<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#caching-system" class="hash-link" aria-label="Direct link to Caching System" title="Direct link to Caching System" translate="no">â€‹</a></h3>
<ul>
<li class=""><strong>Middleware resolution</strong> cached at startup</li>
<li class=""><strong>Permission lookups</strong> cached per route</li>
<li class=""><strong>HTTP meta</strong> converted to Map (faster lookups)</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="smaller-bundles">Smaller Bundles<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#smaller-bundles" class="hash-link" aria-label="Direct link to Smaller Bundles" title="Direct link to Smaller Bundles" translate="no">â€‹</a></h3>
<ul>
<li class="">Split type generation (one file per wiring)</li>
<li class="">Only import functions used by RPCs</li>
<li class="">Tree-shakeable service dependencies</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="whats-next">What's Next<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#whats-next" class="hash-link" aria-label="Direct link to What's Next" title="Direct link to What's Next" translate="no">â€‹</a></h2>
<p>Pikku 0.10 sets the foundation for:</p>
<ul>
<li class=""><strong>Workflows</strong> (coming really, really soon)</li>
<li class=""><strong>Pluggable routers</strong> (choose your routing strategy)</li>
<li class=""><strong>Enhanced MCP support</strong> (OAuth, notifications)</li>
<li class=""><strong>Documentation expansion</strong> (tutorials, examples)</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="try-it-now">Try It Now<a href="https://pikku.dev/blog/2025/11/09/pikku-0.10#try-it-now" class="hash-link" aria-label="Direct link to Try It Now" title="Direct link to Try It Now" translate="no">â€‹</a></h2>
<p>Pikku 0.10 represents months of production hardening, developer experience improvements, and architectural refinements. <strong>Intelligent tree-shaking</strong> makes this the most production-ready Pikku release yet.</p>
<ul>
<li class="">ðŸ§ª <strong><a href="https://pikku.dev/docs/quickstart" target="_blank" rel="noopener noreferrer" class="">Get Started</a></strong></li>
<li class="">ðŸ’» <strong><a href="https://github.com/vramework/pikku" target="_blank" rel="noopener noreferrer" class="">View on GitHub</a></strong></li>
<li class="">ðŸ’¬ <strong><a href="https://github.com/vramework/pikku/discussions" target="_blank" rel="noopener noreferrer" class="">Join the conversation</a></strong></li>
</ul>
<p>Thanks for building with Pikku.</p>
<p>â€” Yasser</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Pikku 0.9 â€” cleaner naming, tagâ€‘driven crossâ€‘cutting, RPC exposure]]></title>
        <id>https://pikku.dev/blog/2025/08/23/pikku-0.9</id>
        <link href="https://pikku.dev/blog/2025/08/23/pikku-0.9"/>
        <updated>2025-08-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[0.9 standardizes wireX naming (with real APIs), adds tag-driven middleware/permissions across transports, introduces interaction objects for queues & scheduled tasks, clarifies RPC exposure via `expose`, and lays groundwork for swappable HTTP routing.]]></summary>
        <content type="html"><![CDATA[<p>Pikku 0.9 is a clarity release. Fewer naming footguns, explicit RPC exposure, transport-wide tagging for middleware/permissions, and early interaction objects that make non-HTTP middleware practical. It also refactors the HTTP router to make <strong>swapping strategies feasible next</strong>, though that toggle isnâ€™t user-facing yet.</p>
<blockquote>
<p>tl;dr: predictable names, safer RPC boundaries, and a single tagâ€‘driven model for crossâ€‘cutting concerns across HTTP, channels, queues and scheduled tasks.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-consistent-wiring-names">1) Consistent wiring names<a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#1-consistent-wiring-names" class="hash-link" aria-label="Direct link to 1) Consistent wiring names" title="Direct link to 1) Consistent wiring names" translate="no">â€‹</a></h2>
<p>Pikku now uses a consistent â€œwireXâ€ shape across transports. Concretely:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// HTTP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireHTTP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'get'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/health'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> healthCheck </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// WebSockets / channels</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'chat'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onOpen</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> joinChat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onMessage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> handleChatMessage </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Queues</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireQueueWorker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> queueName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'thumbnail'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> generateThumbnail </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Scheduled tasks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireScheduledTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> schedule</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0 * * * *'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'hourlyReindex'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> reindex </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// MCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireMCPTool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'disableTool'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Disable a tool by name'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> disableTool </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Note:</p>
<ul>
<li class="">There is <strong>no</strong> <code>wireRPC(...)</code>. RPC exposure is controlled per function (see section 4).</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-naming-pikkupermission-and-pikkumiddleware">2) Naming: <code>pikkuPermission</code> and <code>pikkuMiddleware</code><a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#2-naming-pikkupermission-and-pikkumiddleware" class="hash-link" aria-label="Direct link to 2-naming-pikkupermission-and-pikkumiddleware" title="Direct link to 2-naming-pikkupermission-and-pikkumiddleware" translate="no">â€‹</a></h2>
<p>Standardized constructors bring consistency without losing type safety:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> requireOwner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuPermission</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> todoId</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todoService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todoId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> ownerId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> todoService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todoId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ownerId </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> withSession </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pikkuMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> http </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// attach session, enforce timeouts, set headers, etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-tags-like-routers-but-for-all-wirings">3) Tags: like routers, but for all wirings<a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#3-tags-like-routers-but-for-all-wirings" class="hash-link" aria-label="Direct link to 3) Tags: like routers, but for all wirings" title="Direct link to 3) Tags: like routers, but for all wirings" translate="no">â€‹</a></h2>
<p>Tags make HTTPâ€‘style routing power available to <strong>all</strong> transports.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">addMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'admin'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'web'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">withSession</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> auditTrail</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">addPermission</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'admin'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">requireAdminUser</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">addMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'logging'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">logMiddleware</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Attach tags on wires</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireQueueWorker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queueName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'thumbnail'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> generateThumbnail</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'logging'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// resolves queue-scoped middleware/permissions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Outcome: the same â€œattach by tagâ€ model applies to HTTP, channels, queues, scheduled tasks, and RPC functions.</p>
<p>You can still directly set permissions / middleware on the function or wiring.</p>
<p>The order of execution is:</p>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-interaction-objects-for-queue-and-scheduledtask">4) Interaction objects for <strong>Queue</strong> and <strong>ScheduledTask</strong><a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#4-interaction-objects-for-queue-and-scheduledtask" class="hash-link" aria-label="Direct link to 4-interaction-objects-for-queue-and-scheduledtask" title="Direct link to 4-interaction-objects-for-queue-and-scheduledtask" translate="no">â€‹</a></h2>
<p>Middleware/permissions can now read rich context for nonâ€‘HTTP transports.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="queue">Queue<a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#queue" class="hash-link" aria-label="Direct link to Queue" title="Direct link to Queue" translate="no">â€‹</a></h3>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">PikkuQueue</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** The name of the queue being processed */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queueName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** The current job ID */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  jobId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Update job progress (0-100 or custom value) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">updateProgress</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">progress</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> object</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Fail the current job with optional reason */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">fail</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reason</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Discard/delete the job without retrying */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">discard</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reason</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scheduled-task">Scheduled task<a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#scheduled-task" class="hash-link" aria-label="Direct link to Scheduled task" title="Direct link to Scheduled task" translate="no">â€‹</a></h3>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * Represents a scheduled task interaction object for middleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * Provides information about the current scheduled task execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">PikkuScheduledTask</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** The name of the scheduled task being executed */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** The cron schedule expression */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schedule</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Current execution timestamp */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  executionTime</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Skip the current task execution */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">skip</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reason</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="using-them-in-middleware">Using them in middleware<a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#using-them-in-middleware" class="hash-link" aria-label="Direct link to Using them in middleware" title="Direct link to Using them in middleware" translate="no">â€‹</a></h3>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> queueGuard </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pikkuMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> queue </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queue</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">queueName </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'thumbnail'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'wrong-queue'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> scheduleGuard </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pikkuMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> scheduledTask </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scheduledTask</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">schedule </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'0 * * * *'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* throttle, log, etc. */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<blockquote>
<p>Status: these interaction objects are available in the codebase and rolling out to all runtimes. If a runtime hasnâ€™t implemented one yet, the field is <code>undefined</code>. Use optional chaining until parity lands.</p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="using-them-in-functions">Using them in functions<a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#using-them-in-functions" class="hash-link" aria-label="Direct link to Using them in functions" title="Direct link to Using them in functions" translate="no">â€‹</a></h3>
<p>This would work for SSE, Queues (if supported) and websocket connections.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> progressUpdate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunction</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#00009f">void</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> progress</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">number</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> queue </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> progress </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name builtin">Promise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">delay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">queue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onProgress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">progress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> progress </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<blockquote>
<p>Status: these interaction objects are available in the codebase and rolling out to all runtimes. If a runtime hasnâ€™t implemented one yet, the field is <code>undefined</code>. Use optional chaining until parity lands.</p>
</blockquote>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-rpc-exposure-expose-true">5) RPC exposure: <code>expose: true</code><a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#5-rpc-exposure-expose-true" class="hash-link" aria-label="Direct link to 5-rpc-exposure-expose-true" title="Direct link to 5-rpc-exposure-expose-true" translate="no">â€‹</a></h2>
<p>Public vs internal RPCs are explicit at the function definition via an <code>expose</code> flag and the functionâ€™s name.</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Example: sessionless RPC with recursion depth guard</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> rpcTest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuSessionlessFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#00009f">in</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">number</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rpc </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">RPC Test with RPC: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">rpc</span><span class="token template-string interpolation operator" style="color:#393A34">?.</span><span class="token template-string interpolation">depth</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">depth </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> rpc</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">depth </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">in </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'rpcTest'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  expose</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// makes it available on the public RPC surface</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Notes:</p>
<ul>
<li class="">Internal RPCs: use <code>expose: false</code> (default) and omit them from any public client surface.</li>
<li class="">The <code>rpc</code> interaction object provides helpers like <code>depth</code> (for loop protection) and <code>invoke(name, data)</code> to chain RPC calls safely.</li>
<li class="">Two RPC clients are created, one for internal use, and another for public APIs.</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-router-refactor--swapping-soon-not-today">6) Router refactor â†’ swapping <strong>soon</strong>, not today<a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#6-router-refactor--swapping-soon-not-today" class="hash-link" aria-label="Direct link to 6-router-refactor--swapping-soon-not-today" title="Direct link to 6-router-refactor--swapping-soon-not-today" translate="no">â€‹</a></h2>
<p>Internally, the HTTP router has been refactored toward a factory-based design so different lookup strategies can be swapped in. That said, <strong>the public switch is not shipped yet</strong>. Itâ€™s on the immediate roadmap; 0.9 just removes the architectural blockers so we can ship the toggle cleanly in the next minor.</p>
<p>What this means for you right now: no API change; futureâ€‘proofing is in place.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-agents-workspace-early-days">7) Agents workspace (early days)<a href="https://pikku.dev/blog/2025/08/23/pikku-0.9#7-agents-workspace-early-days" class="hash-link" aria-label="Direct link to 7) Agents workspace (early days)" title="Direct link to 7) Agents workspace (early days)" translate="no">â€‹</a></h2>
<p>A new Yarn workspace is accumulating â€œAgent filesâ€ to guide Claude/other LLMs to generate <strong>idiomatic Pikku</strong> code:</p>
<ul>
<li class="">project structure</li>
<li class="">services</li>
<li class="">system</li>
<li class="">how to use kysely with pikku</li>
<li class="">errors and mapping</li>
</ul>
<p>This is intentionally opinionated. Constraints improve model output quality.</p>
<hr>
<h1>Closing</h1>
<p>0.9 is about <strong>sharp edges and fewer surprises</strong>: consistent names, explicit public boundaries, one tagging model across transports, and the ergonomics needed to treat queues &amp; cron as firstâ€‘class citizens in middleware. The router work is teed up; once the switch exists, choosing a strategy will be a config changeâ€”not a refactor.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[PikkuÂ 0.8 â€” Our Biggest Release Yet!]]></title>
        <id>https://pikku.dev/blog/2025/07/18/pikku-0.8</id>
        <link href="https://pikku.dev/blog/2025/07/18/pikku-0.8"/>
        <updated>2025-07-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Pikku 0.8 introduces RPCs, queue workers, MCP server integration, and bundle-level service shaking â€” setting a new baseline for what a modern typed backend framework should offer.]]></summary>
        <content type="html"><![CDATA[<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Updated for Pikku v0.11</div><div class="admonitionContent_BuS1"><p>This post contains code examples from Pikku 0.8. In v0.11, function signatures changed to use the <code>wire</code> parameter pattern. See the <a class="" href="https://pikku.dev/docs">current documentation</a> for updated examples.</p></div></div>
<p>After months of focused work, I'm thrilled to introduce <strong><a href="https://pikku.dev/" target="_blank" rel="noopener noreferrer" class="">Pikku&nbsp;0.8</a></strong> â€” the biggest update yet to the typed backend framework Iâ€™ve been building to simplify full-stack infrastructure.</p>
<p>This release marks a turning point: <strong>Pikku is no longer just for HTTP / Websockets and CronJobs â€” itâ€™s now a complete platform for building scalable, typed, multi-transport backends</strong>. Whether you're targeting HTTP, queues, RPCs, or even AI agents â€” you now write your logic once, then connect it anywhere.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-quick-recap-what-is-pikku">ðŸ§  Quick Recap: What is Pikku?<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#-quick-recap-what-is-pikku" class="hash-link" aria-label="Direct link to ðŸ§  Quick Recap: What is Pikku?" title="Direct link to ðŸ§  Quick Recap: What is Pikku?" translate="no">â€‹</a></h2>
<p>At its core, Pikku is a developer-first framework for declaring backend logic as <strong>typed functions</strong>, then wiring those functions up to various transports â€” like HTTP, WebSocket, RPC, queues, or AI agent servers.</p>
<p>If you're familiar with <a href="https://vercel.com/blog/what-are-serverless-functions" target="_blank" rel="noopener noreferrer" class="">function-based backends</a> or serverless APIs, youâ€™ll feel right at home â€” but Pikku brings full typings, permissions, and tooling to the party.</p>
<p>Hereâ€™s what a typical Pikku function looks like:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> updateTodo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">Todo</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> updated</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">boolean</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> todoService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todoId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">data </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> todoService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">todoId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> updated</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function-variable function" style="color:#d73a49">canEditTodo</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todoService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> ownerId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> todoService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">todoId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ownerId </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Then you wire it up to the desired transport:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wireHTTP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'patch'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> updateTodo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/core/functions" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ Function Basics</a></strong>
ðŸ“š <strong><a href="https://pikku.dev/docs/core/http" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ HTTP APIs &amp; Routing</a></strong></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-new-in08-remote-procedure-calls-rpcs">âš¡ New in&nbsp;0.8: Remote Procedure Calls (RPCs)<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#-new-in08-remote-procedure-calls-rpcs" class="hash-link" aria-label="Direct link to âš¡ New in&nbsp;0.8: Remote Procedure Calls (RPCs)" title="Direct link to âš¡ New in&nbsp;0.8: Remote Procedure Calls (RPCs)" translate="no">â€‹</a></h2>
<p>You can now invoke Pikku functions via RPC â€” from clients, other services, or across your infrastructure.</p>
<p>If you're unfamiliar with RPCs, here's a primer:
ðŸ§  <a href="https://martinfowler.com/articles/distributed-objects-microservices.html" target="_blank" rel="noopener noreferrer" class="">What is RPC? â†’ Martin Fowler</a></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="server-side-usage">Server-side usage:<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#server-side-usage" class="hash-link" aria-label="Direct link to Server-side usage:" title="Direct link to Server-side usage:" translate="no">â€‹</a></h3>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'send-Email'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'todo-changed'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> todoId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="typed-client-usage">Typed client usage:<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#typed-client-usage" class="hash-link" aria-label="Direct link to Typed client usage:" title="Direct link to Typed client usage:" translate="no">â€‹</a></h3>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> rpc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PikkuRPC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'update-todo'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> todoId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>RPCs in Pikku:</p>
<ul>
<li class="">Are <strong>typed</strong> with schema validation</li>
<li class="">Respect <strong>permissions</strong> and <strong>sessions</strong></li>
<li class="">Work identically whether local or remote</li>
<li class="">Are <strong>tree-shakeable</strong> for minimal bundles</li>
</ul>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/core/rpcs" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ RPCs</a></strong></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-queue-workers">ðŸ§µ Queue Workers<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#-queue-workers" class="hash-link" aria-label="Direct link to ðŸ§µ Queue Workers" title="Direct link to ðŸ§µ Queue Workers" translate="no">â€‹</a></h2>
<p>Pikku now supports async job queues with the same function-first philosophy.</p>
<blockquote>
<p>Think of it like typed background workers â€” perfect for sending emails, processing images, or handling long-running tasks.</p>
</blockquote>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> queueWorker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuSessionlessFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> message</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">;</span><span class="token generic-function generic class-name"> fail</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">boolean</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> result</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fail</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Job failed intentionally'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> result</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">echo: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">data</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">message</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireQueueWorker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queueName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'hello-world-queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> queueWorker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Run your preferred queue system (e.g., <a href="https://docs.bullmq.io/" target="_blank" rel="noopener noreferrer" class="">BullMQ</a> or <a href="https://github.com/timgit/pg-boss" target="_blank" rel="noopener noreferrer" class="">pg-boss</a>):</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bullQueueWorkers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">BullQueueWorkers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  singletonServices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createSessionServices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> bullQueueWorkers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">registerQueues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Client usage:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// The QueueService is literally just a typed wrapper</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> queueService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PikkuQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">BullQueueService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> queueService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'hello-world-queue'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Hello'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fail</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/wiring/queue" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ Queues</a></strong></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-mcp-server-build-agent-compatible-backends">ðŸ¤– MCP Server: Build Agent-Compatible Backends<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#-mcp-server-build-agent-compatible-backends" class="hash-link" aria-label="Direct link to ðŸ¤– MCP Server: Build Agent-Compatible Backends" title="Direct link to ðŸ¤– MCP Server: Build Agent-Compatible Backends" translate="no">â€‹</a></h2>
<blockquote>
<p>The <strong>MCP Server</strong> allows your Pikku functions to be used by AI agents â€” as tools, resources, or prompt generators. You can build your own local agent server, integrate with LLMs, or support emerging agent standards.</p>
</blockquote>
<p>If you're new to agents or tool-calling:
ðŸ§  <a href="https://blog.langchain.dev/what-are-agents/" target="_blank" rel="noopener noreferrer" class="">What are AI agents? â†’ LangChain Blog</a>
ðŸ§  <a href="https://platform.openai.com/docs/guides/function-calling" target="_blank" rel="noopener noreferrer" class="">Tool-Use in LLMs â†’ OpenAI</a></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="tools">Tools<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#tools" class="hash-link" aria-label="Direct link to Tools" title="Direct link to Tools" translate="no">â€‹</a></h3>
<p>Declare a function as a callable â€œtoolâ€:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sayHello </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuMCPToolFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> name</span><span class="token generic-function generic class-name operator" style="color:#393A34">?</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> logger </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'World'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hello </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'text'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hello, </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">!</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireMCPTool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'sayHello'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Greet someone with a friendly message'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sayHello</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/wiring/mcp/tools" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ MCP Tools</a></strong></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="resources">Resources<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#resources" class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources" translate="no">â€‹</a></h3>
<p>Expose structured data as accessible agent resources:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getUserInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuMCPResourceFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> userId</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> users </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> userId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> users</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">NotFoundError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">User not found</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> uri</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">getUserInfo/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">userId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/wiring/mcp/resources" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ MCP Resources</a></strong></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="prompts">Prompts<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#prompts" class="hash-link" aria-label="Direct link to Prompts" title="Direct link to Prompts" translate="no">â€‹</a></h3>
<p>Dynamically generate prompts for LLMs:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> dynamicPromptGenerator </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuMCPPromptFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  topic</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  complexity</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name string" style="color:#e3116c">'beginner'</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name operator" style="color:#393A34">|</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name string" style="color:#e3116c">'intermediate'</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name operator" style="color:#393A34">|</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name string" style="color:#e3116c">'advanced'</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  includeExamples</span><span class="token generic-function generic class-name operator" style="color:#393A34">?</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">boolean</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> logger </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> topic</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> complexity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> includeExamples </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c"># Learning </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">topic</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c"> (</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">complexity</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">)\n\n</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  content </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> complexity </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'beginner'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Start with the basics.\n</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> complexity </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'intermediate'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Go deeper.\n</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Covering edge cases.\n</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">includeExamples</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> content </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">\n## Examples\n- Example 1\n- Example 2\n</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> role</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'user'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'text'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> text</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> content </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/wiring/mcp/prompts" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ MCP Prompts</a></strong></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="running-the-mcp-server">Running the MCP Server<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#running-the-mcp-server" class="hash-link" aria-label="Direct link to Running the MCP Server" title="Direct link to Running the MCP Server" translate="no">â€‹</a></h3>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PikkuMCPServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'pikku-mcp-server'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1.0.0'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mcpJsonPath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__dirname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'../../functions/.pikku/mcp.gen.json'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capabilities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> logging</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tools</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prompts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> singletonServices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StdioServerTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wrapLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/runtimes/mcp-server" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ MCP Server</a></strong></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-service-shaking-smarter-smaller-builds">ðŸŽ¯ Service Shaking: Smarter, Smaller Builds<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#-service-shaking-smarter-smaller-builds" class="hash-link" aria-label="Direct link to ðŸŽ¯ Service Shaking: Smarter, Smaller Builds" title="Direct link to ðŸŽ¯ Service Shaking: Smarter, Smaller Builds" translate="no">â€‹</a></h2>
<blockquote>
<p>Think tree-shaking, but for backend services.</p>
</blockquote>
<p>You can now exclude unused services from your production bundle using <strong>tag-based CLI filters</strong>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pikku --tags 'web,queue'</span><br></span></code></pre></div></div>
<p>This tells Pikku to only include services used by functions tagged with <code>web</code> or <code>queue</code>.</p>
<p>Benefits:</p>
<ul>
<li class="">Smaller bundles</li>
<li class="">Lazy-loaded service dependencies</li>
<li class="">More precise deployments</li>
</ul>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">singletonServices</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jwt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> JoseJWTService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">import</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'@pikku/jose'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  jwt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">JoseJWTService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>ðŸ“š <strong><a href="https://pikku.dev/docs/deployment/service-shaking" target="_blank" rel="noopener noreferrer" class="">Learn more â†’ Service Shaking</a></strong></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-coming-next">ðŸš§ Coming Next<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#-coming-next" class="hash-link" aria-label="Direct link to ðŸš§ Coming Next" title="Direct link to ðŸš§ Coming Next" translate="no">â€‹</a></h2>
<p>We consider Pikku 0.8 <strong>feature complete</strong>, in the sense we won't be adding more transports or core library changes.</p>
<p>In the near future, weâ€™ll focus on:</p>
<ul>
<li class="">ðŸ› Fixing minor bugs</li>
<li class="">ðŸ§‘ðŸ½â€ðŸ’» Adding APIs to exising wrappers like Queues or oAuth/Notifications to MCP</li>
<li class="">ðŸ§¾ Improving docs and examples</li>
<li class="">ðŸ’¬ Expanding tutorials and templates</li>
<li class="">âœ¨ Polish across CLI and DX</li>
</ul>
<p>If you're building something and get stuck â€” please <a href="https://github.com/vlandor/pikku/issues" target="_blank" rel="noopener noreferrer" class="">open an issue</a> or <a href="https://github.com/vlandor/pikku/discussions" target="_blank" rel="noopener noreferrer" class="">ask us on GitHub Discussions</a>.</p>
<hr>
<p>ðŸ” Peek: AI-Assisted Lookup
One of the things I love about Pikku is that everything is statically documented â€” from services to queues to functions.</p>
<p>Iâ€™m exploring the idea of a Pikku-powered MCP agent â€” a local AI assistant that gives instant answers like:</p>
<p>â€œWhat queues are available in this service?â€
â€œWhich function handles updating a todo?â€</p>
<p>No need to crawl the codebase or guess â€” just ask. If this sounds interesting, stay tuned.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-final-thoughts">ðŸ™Œ Final Thoughts<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#-final-thoughts" class="hash-link" aria-label="Direct link to ðŸ™Œ Final Thoughts" title="Direct link to ðŸ™Œ Final Thoughts" translate="no">â€‹</a></h2>
<p>Pikku&nbsp;0.8 isnâ€™t just a version bump â€” itâ€™s a foundational leap forward.</p>
<p>By treating <strong>functions as your backend contract</strong>, you gain:</p>
<ul>
<li class="">âœ… Full TypeScript safety</li>
<li class="">ðŸ” Auth &amp; permission guards</li>
<li class="">ðŸ” Transport-agnostic logic</li>
<li class="">ðŸ§µ Queue &amp; background job support</li>
<li class="">ðŸ§  Agent / AI integration</li>
<li class="">ðŸ§¼ Tree-shaken builds for tighter deployments</li>
</ul>
<p>Whether you're building real-time apps, internal tools, microservices, or intelligent agents â€” <strong>Pikku&nbsp;0.8</strong> gives you a fast, typed, and scalable foundation.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="-try-it-now">ðŸš€ Try It Now<a href="https://pikku.dev/blog/2025/07/18/pikku-0.8#-try-it-now" class="hash-link" aria-label="Direct link to ðŸš€ Try It Now" title="Direct link to ðŸš€ Try It Now" translate="no">â€‹</a></h2>
<ul>
<li class="">ðŸ§ª <strong><a href="https://pikku.dev/docs/quickstart" target="_blank" rel="noopener noreferrer" class="">Get Started</a></strong></li>
<li class="">ðŸ’» <strong><a href="https://github.com/vlandor/pikku" target="_blank" rel="noopener noreferrer" class="">View on GitHub</a></strong></li>
<li class="">ðŸ’¬ <strong><a href="https://github.com/vlandor/pikku/discussions" target="_blank" rel="noopener noreferrer" class="">Join the conversation</a></strong></li>
<li class="">ðŸ›  <strong><a href="https://github.com/vlandor/pikku/issues" target="_blank" rel="noopener noreferrer" class="">Contribute or file an issue</a></strong></li>
</ul>
<p>Thanks for reading â€” I can't wait to see what you build.</p>
<p>â€”â€¯Yasser</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Pikku Now Uses Fetch!]]></title>
        <id>https://pikku.dev/blog/2025/04/30/native-fetch</id>
        <link href="https://pikku.dev/blog/2025/04/30/native-fetch"/>
        <updated>2025-04-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Simplifying Server Support with Native Request/Response APIs]]></summary>
        <content type="html"><![CDATA[<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Updated for Pikku v0.11</div><div class="admonitionContent_BuS1"><p>This post contains historical code examples. In v0.11, function signatures changed to use the <code>wire</code> parameter pattern, and <code>pikkuSessionServices</code> was renamed to <code>pikkuWireServices</code>. See the <a class="" href="https://pikku.dev/docs">current documentation</a> for updated examples.</p></div></div>
<p>We're excited to announce that <strong>Pikku now uses <code>fetch</code> directly</strong> within its APIsâ€”taking inspiration from frameworks like Hono and pushing even closer to modern web standards.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-this-matters">Why This Matters<a href="https://pikku.dev/blog/2025/04/30/native-fetch#why-this-matters" class="hash-link" aria-label="Direct link to Why This Matters" title="Direct link to Why This Matters" translate="no">â€‹</a></h2>
<p>With this change, Pikku APIs now operate against the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request" target="_blank" rel="noopener noreferrer" class="">standard <code>Request</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response" target="_blank" rel="noopener noreferrer" class="">standard <code>Response</code></a> objects.<br>
<!-- -->As long as a server or runtime implements these APIs, Pikku can support it <strong>out of the box</strong> â€” no complex adapters or server-specific workarounds required!</p>
<p>This massively expands where Pikku can run, including:</p>
<ul>
<li class="">Cloudflare Workers</li>
<li class="">Vercel Edge Functions</li>
<li class="">Node.js (18+ with experimental Fetch)</li>
<li class="">Bun</li>
<li class="">Deno</li>
<li class="">Future platforms that follow the Fetch standard</li>
</ul>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="flexibility-remains">Flexibility Remains<a href="https://pikku.dev/blog/2025/04/30/native-fetch#flexibility-remains" class="hash-link" aria-label="Direct link to Flexibility Remains" title="Direct link to Flexibility Remains" translate="no">â€‹</a></h2>
<p>While we now natively use <code>fetch</code>, <strong>Pikku still allows you to create your own server wrappers</strong> if needed.</p>
<p>If you're working with an environment that doesn't provide full <code>Request</code>/<code>Response</code> objects (or provides custom versions), you can still implement a simple wrapper without needing to constantly convert back and forth.</p>
<p>This means:</p>
<ul>
<li class=""><strong>Better performance</strong> where native APIs exist.</li>
<li class=""><strong>Maximum compatibility</strong> for custom servers.</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="quick-example">Quick Example<a href="https://pikku.dev/blog/2025/04/30/native-fetch#quick-example" class="hash-link" aria-label="Direct link to Quick Example" title="Direct link to Quick Example" translate="no">â€‹</a></h2>
<p>When calling Pikku routes internally, you now use a standard <code>Request</code> object and the native <code>fetch</code> function:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> fetch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RunHTTPWiringOptions </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@pikku/core/http'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'https://example.com/api/hello'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'GET'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  singletonServices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createSessionServices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>fetch</code> expects a standard <code>Request</code>.</li>
<li class="">You still pass <code>singletonServices</code> and <code>createSessionServices</code> the same way.</li>
<li class="">The response is a standard <code>Response</code> object.</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="wrapping-up">Wrapping Up<a href="https://pikku.dev/blog/2025/04/30/native-fetch#wrapping-up" class="hash-link" aria-label="Direct link to Wrapping Up" title="Direct link to Wrapping Up" translate="no">â€‹</a></h2>
<p>Pikkuâ€™s move to native <code>fetch</code> APIs brings us even closer to a universal runtime futureâ€”where your APIs can run anywhere without changes.</p>
<p>If your server or hosting environment follows modern standards, you can plug Pikku in and get moving immediately.</p>
<p>This change is live in the latest version of Pikkuâ€”go try it out and let us know what you build!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Content Management in Pikku]]></title>
        <id>https://pikku.dev/blog/2025/04/29/content-mangement</id>
        <link href="https://pikku.dev/blog/2025/04/29/content-mangement"/>
        <updated>2025-04-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[How Pikku Simplifies and Secures Your Content Operations]]></summary>
        <content type="html"><![CDATA[<p>We're excited to walk you through how <strong>content management</strong> works in Pikku! Unlike traditional frameworks, Pikku deliberately delegates content handlingâ€”such as file uploads and downloadsâ€”to external platforms. This keeps Pikku lightweight, secure, and easy to integrate into your existing workflow.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-pikku-delegates-content-management">Why Pikku Delegates Content Management<a href="https://pikku.dev/blog/2025/04/29/content-mangement#why-pikku-delegates-content-management" class="hash-link" aria-label="Direct link to Why Pikku Delegates Content Management" title="Direct link to Why Pikku Delegates Content Management" translate="no">â€‹</a></h2>
<p>Managing files directly inside your server framework can complicate deployments, introduce security risks, and bloat your application size. Pikku addresses this by:</p>
<ul>
<li class=""><strong>Delegating file uploads/downloads</strong> to specialized cloud providers (e.g., AWS S3, Azure Blob Storage).</li>
<li class=""><strong>Reducing library footprint</strong> by excluding built-in file management.</li>
<li class=""><strong>Leveraging established tools</strong> like Express middleware and cloud SDKs for handling content efficiently.</li>
<li class=""><strong>Keeping API services small and efficient</strong> by avoiding the need to stream or buffer large files, which can dramatically increase memory and CPU usage.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-content-operations-typically-work">How Content Operations Typically Work<a href="https://pikku.dev/blog/2025/04/29/content-mangement#how-content-operations-typically-work" class="hash-link" aria-label="Direct link to How Content Operations Typically Work" title="Direct link to How Content Operations Typically Work" translate="no">â€‹</a></h2>
<p>Secure content operations using signed URLs generally involve three steps:</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-request-a-signed-upload-url">1. Request a Signed Upload URL<a href="https://pikku.dev/blog/2025/04/29/content-mangement#1-request-a-signed-upload-url" class="hash-link" aria-label="Direct link to 1. Request a Signed Upload URL" title="Direct link to 1. Request a Signed Upload URL" translate="no">â€‹</a></h3>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-upload-the-object-directly">2. Upload the Object Directly<a href="https://pikku.dev/blog/2025/04/29/content-mangement#2-upload-the-object-directly" class="hash-link" aria-label="Direct link to 2. Upload the Object Directly" title="Direct link to 2. Upload the Object Directly" translate="no">â€‹</a></h3>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-retrieve-content-securely-with-signed-urls">3. Retrieve Content Securely with Signed URLs<a href="https://pikku.dev/blog/2025/04/29/content-mangement#3-retrieve-content-securely-with-signed-urls" class="hash-link" aria-label="Direct link to 3. Retrieve Content Securely with Signed URLs" title="Direct link to 3. Retrieve Content Securely with Signed URLs" translate="no">â€‹</a></h3>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="pikkus-contentservice-interface">Pikku's ContentService Interface<a href="https://pikku.dev/blog/2025/04/29/content-mangement#pikkus-contentservice-interface" class="hash-link" aria-label="Direct link to Pikku's ContentService Interface" title="Direct link to Pikku's ContentService Interface" translate="no">â€‹</a></h2>
<p>At the heart of content management is the <code>ContentService</code> interface:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ContentService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Signs a content key to generate a secure, time-limited access URL. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">signContentKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contentKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dateLessThan</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dateGreaterThan</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Signs an arbitrary URL to generate a secure, time-limited access URL. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">signURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dateLessThan</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dateGreaterThan</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Generates a signed URL for uploading a file directly to storage. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">getUploadURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contentType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> uploadUrl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> assetKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Deletes a file from the storage backend. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">deleteFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">boolean</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Uploads a file stream to storage under a specified asset key. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">writeFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">assetKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stream</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ReadStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">boolean</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Copies a file from a local absolute path into storage under a new asset key. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">copyFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">assetKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fromAbsolutePath</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">boolean</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Reads a file from storage as a readable stream. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">readFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">assetKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ReadStream</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="switching-between-local-and-cloud-content-management">Switching Between Local and Cloud Content Management<a href="https://pikku.dev/blog/2025/04/29/content-mangement#switching-between-local-and-cloud-content-management" class="hash-link" aria-label="Direct link to Switching Between Local and Cloud Content Management" title="Direct link to Switching Between Local and Cloud Content Management" translate="no">â€‹</a></h2>
<p>Pikku allows you to easily switch between a local or cloud-backed content service based on your environment:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ContentService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">LocalContent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isProduction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">S3Content</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      bucketName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">content.</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">config</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">domain</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      region</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">awsRegion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> secrets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSecretJSON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">secrets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>This mirrors how most services in Pikku work: run locally for fast iteration, then switch automatically to managed services in production.<br>
<em>(If your cloud resources live inside a private VPC, you might need tunnelingâ€”blog post for another time!)</em></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="adding-http-endpoints-for-content-management">Adding HTTP Endpoints for Content Management<a href="https://pikku.dev/blog/2025/04/29/content-mangement#adding-http-endpoints-for-content-management" class="hash-link" aria-label="Direct link to Adding HTTP Endpoints for Content Management" title="Direct link to Adding HTTP Endpoints for Content Management" translate="no">â€‹</a></h2>
<p>Uploading and signing files through Pikku requires simple endpoints:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getSignedUploadUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  name</span><span class="token generic-function generic class-name operator" style="color:#393A34">?</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">;</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  contentType</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">;</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  uploadUrl</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">;</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name">  assetKey</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">;</span><span class="token generic-function generic class-name"></span><br></span><span class="token-line" style="color:#393A34"><span class="token generic-function generic class-name"></span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> content </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contentType </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'uuid'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">randomUUID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> contentTypeSuffix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> contentType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">session</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">userId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">/checkin/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">.</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">contentTypeSuffix</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUploadURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contentType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getSignedContentUrls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuSessionlessFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> assetKeys</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">[</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">]</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">[</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">]</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> content </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assetKeys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">assetKey </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">signContentKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">assetKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">addRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'post'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/content/upload-objects'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> getSignedUploadUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">addRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'post'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/content/sign-content-key'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> getSignedContentUrls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="client-side-upload-example">Client-side Upload Example<a href="https://pikku.dev/blog/2025/04/29/content-mangement#client-side-upload-example" class="hash-link" aria-label="Direct link to Client-side Upload Example" title="Direct link to Client-side Upload Example" translate="no">â€‹</a></h2>
<p>On the frontend, uploading a file with a signed URL requires just the following:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> uploadFile </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> file </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> file</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Blob </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> signedUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> pikkuFetch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/content/upload-objects'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contentType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">signedUrl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uploadUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'PUT'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    body</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    headers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">'Content-Type'</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string-property property" style="color:#36acaa">'Content-Disposition'</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'inline'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> signedUrl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assetKey</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<!-- -->
<p><em>Pro tip:</em> You can customize this flow further by passing entity types or folder paths into your upload request to organize your storage structure!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="bonus-example-streaming-content-to-external-apis">Bonus Example: Streaming Content to External APIs<a href="https://pikku.dev/blog/2025/04/29/content-mangement#bonus-example-streaming-content-to-external-apis" class="hash-link" aria-label="Direct link to Bonus Example: Streaming Content to External APIs" title="Direct link to Bonus Example: Streaming Content to External APIs" translate="no">â€‹</a></h2>
<p>Pikku's <code>ContentService</code> also makes it simple to integrate file streams directly into external APIs within functions:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> transcribeAudioFile </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> audioSrc</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> transcription</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> openai </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> audioSrc </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> audioFileStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">audioSrc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> transcription </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> openai</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">audio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transcriptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> audioFileStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'whisper'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response_format</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'text'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> transcription </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<!-- -->
<p>This allows you to manage content efficiently across any service without changing your core application code.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="wrapping-up">Wrapping Up<a href="https://pikku.dev/blog/2025/04/29/content-mangement#wrapping-up" class="hash-link" aria-label="Direct link to Wrapping Up" title="Direct link to Wrapping Up" translate="no">â€‹</a></h2>
<p>By delegating content management to external platforms, Pikku stays lightweight, secure, and highly flexible.<br>
<!-- -->Your API services remain fast and resilientâ€”and your cloud storage stays organized, scalable, and secure.</p>
<p>We hope this gives you a clear insight into how content operations work in Pikku.<br>
<!-- -->Try it out in your projects and let us know how it helps simplify your workflow!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Run JS WebSockets anywhere!]]></title>
        <id>https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture</id>
        <link href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture"/>
        <updated>2025-03-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[How Pikku Bridges Serverless and Server-Based Websocket Connections]]></summary>
        <content type="html"><![CDATA[<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>This post was co-written by AI research</summary><div><div class="collapsibleContent_i85q"><p>Real-time communication is a cornerstone of modern web appsâ€”from live chats and collaborative tools to instant notifications. WebSockets have emerged as the go-to solution for these use cases, enabling persistent, two-way connections between clients and servers (<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API#:~:text=The%20WebSocket%20API%20makes%20it,the%20server%20for%20a%20reply" target="_blank" rel="noopener noreferrer" class="">The WebSocket API (WebSockets) - Web APIs | MDN</a>). However, implementing WebSockets in <strong>serverless</strong> environments (like AWS Lambda or Cloudflare Workers) can be challenging due to their stateless nature (<a href="https://tsh.io/blog/implementing-websocket-with-aws-lambda-and-api-gateway/#:~:text=The%20answer%20is%20simple,to%20send%20messages%20to%20them" target="_blank" rel="noopener noreferrer" class="">How I implemented WebSocket API Gateway with AWS Lambda</a>). This is where <strong>Pikku</strong> comes in. In this post, we'll explore WebSocket fundamentals, examine the hurdles of using WebSockets on Cloudflare and AWS, and see how Pikku's hybrid approach makes running WebSocket channels effortless across serverless <em>and</em> traditional servers.</p><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction-to-websockets">Introduction to WebSockets<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#introduction-to-websockets" class="hash-link" aria-label="Direct link to Introduction to WebSockets" title="Direct link to Introduction to WebSockets" translate="no">â€‹</a></h2><p><strong>WebSockets</strong> are a protocol that provides a full-duplex (two-way) communication channel over a single, long-lived connection. Unlike HTTP, which follows a request-response pattern, a WebSocket connection stays open, allowing the server to push data to the client at any time and the client to send messages to the server as needed (<a href="https://tsh.io/blog/implementing-websocket-with-aws-lambda-and-api-gateway/#:~:text=The%20WebSocket%20API%20is%20a,charts%2C%20or%20even%20gaming%20platforms" target="_blank" rel="noopener noreferrer" class="">How I implemented WebSocket API Gateway with AWS Lambda</a>). This eliminates the need for constant polling and reduces latency, making WebSockets ideal for real-time features like chat applications, live dashboards, online games, and collaborative editing tools (<a href="https://tsh.io/blog/implementing-websocket-with-aws-lambda-and-api-gateway/#:~:text=The%20WebSocket%20API%20is%20a,charts%2C%20or%20even%20gaming%20platforms" target="_blank" rel="noopener noreferrer" class="">How I implemented WebSocket API Gateway with AWS Lambda</a>).</p><p>Once a WebSocket connection is established (after an initial HTTP handshake), both the client and server use a simple event-driven API to communicate:</p><ul>
<li class=""><strong>Open</strong>: Triggered when the connection is successfully opened. For example, in the browser you can listen for the <code>'open'</code> event (via <code>socket.onopen</code> or an event listener) to know the channel is ready (<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket#:~:text=message" target="_blank" rel="noopener noreferrer" class="">WebSocket - Web APIs | MDN</a>).</li>
<li class=""><strong>Message</strong>: Fired whenever a message is received on the connection. You handle this with an <code>'onmessage'</code> event handler to process incoming data (<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket#:~:text=message" target="_blank" rel="noopener noreferrer" class="">WebSocket - Web APIs | MDN</a>). For instance, a chat app might display incoming chat messages in this handler.</li>
<li class=""><strong>Close</strong>: Fired when the connection is closed, either intentionally or due to network issues. The <code>'onclose'</code> event lets you react to disconnections (e.g. cleaning up state or attempting reconnection) (<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket#:~:text=close" target="_blank" rel="noopener noreferrer" class="">WebSocket - Web APIs | MDN</a>).</li>
</ul><p>These events (<code>open</code>, <code>message</code>, <code>close</code>) form the core of the WebSocket API and are supported in all modern browsers and frameworks. Under the hood, once <code>open</code> fires, either side can <code>send</code> data at will, and every <code>message</code> event carries that data for processing. This low-level simplicity is powerfulâ€”developers can build interactive, low-latency experiences on the web without the overhead of repeated HTTP requests (<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API#:~:text=The%20WebSocket%20API%20makes%20it,the%20server%20for%20a%20reply" target="_blank" rel="noopener noreferrer" class="">The WebSocket API (WebSockets) - Web APIs | MDN</a>).</p><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="websockets-in-cloudflare--aws">WebSockets in Cloudflare &amp; AWS<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#websockets-in-cloudflare--aws" class="hash-link" aria-label="Direct link to WebSockets in Cloudflare &amp; AWS" title="Direct link to WebSockets in Cloudflare &amp; AWS" translate="no">â€‹</a></h2><p>Running WebSockets on a single server (or VM) is straightforward: the server process can hold many open connections in memory, and you maintain session state as long as the process lives. In <strong>serverless environments</strong> like AWS Lambda or Cloudflare Workers, itâ€™s more complex. These platforms are designed to be <strong>stateless</strong> and ephemeral â€“ they spin up instances on demand to handle events and then shut them down. But a WebSocket by definition is <strong>stateful</strong> and long-lived, which creates a mismatch (<a href="https://tsh.io/blog/implementing-websocket-with-aws-lambda-and-api-gateway/#:~:text=The%20answer%20is%20simple,to%20send%20messages%20to%20them" target="_blank" rel="noopener noreferrer" class="">How I implemented WebSocket API Gateway with AWS Lambda</a>).</p><p>Letâ€™s consider <strong>AWS (Amazon Web Services)</strong> first. AWS offers WebSocket support via API Gateway, which keeps client connections open at the edge and triggers your Lambda functions on events (connect, message, disconnect). The challenge is that each Lambda invocation has no memory of any prior invocations. When a client sends a message, API Gateway calls a Lambda, which runs independently and then terminates. If you want to broadcast that message to other connected clients, how do you find them? The typical solution is to <strong>persist connection info in a database</strong>. For example, one common approach is storing active WebSocket connection IDs in DynamoDB (Amazonâ€™s NoSQL database). On each message, the Lambda function will query the database for all connections (perhaps all users in a chat room), then loop through and call the API Gatewayâ€™s <code>postToConnection</code> API for each ID to push out the message (<a href="https://aws.amazon.com/blogs/compute/building-serverless-multi-region-websocket-apis/#:~:text=To%20that%20end%2C%20the%20function,message%20to%20the%20respective%20clients" target="_blank" rel="noopener noreferrer" class="">Building serverless multi-Region WebSocket APIs | AWS Compute Blog</a>) (<a href="https://aws.amazon.com/blogs/compute/building-serverless-multi-region-websocket-apis/#:~:text=The%20first%20target%20is%20a,where%20the%20message%20was%20received" target="_blank" rel="noopener noreferrer" class="">Building serverless multi-Region WebSocket APIs | AWS Compute Blog</a>). This works, but as you can imagine, it introduces complexity and latency â€“ youâ€™re effectively bolting statefulness onto a stateless architecture. In short, <strong>AWS developers must implement their own connection registry</strong> (often DynamoDB or another store) to track whoâ€™s connected and store session data (<a href="https://tsh.io/blog/implementing-websocket-with-aws-lambda-and-api-gateway/#:~:text=The%20answer%20is%20simple,to%20send%20messages%20to%20them" target="_blank" rel="noopener noreferrer" class="">How I implemented WebSocket API Gateway with AWS Lambda</a>). Managing disconnects (removing stale IDs) and scaling that database for many connections are additional hurdles.</p><p>Now onto <strong>Cloudflare Workers</strong>. Cloudflare allows code to run at the edge, closer to users, and it recently added support for WebSockets. A Cloudflare Worker can act as a WebSocket server, but since Workers are also designed to be event-driven and short-lived, Cloudflare introduced <strong>Durable Objects</strong> to handle stateful needs. A Durable Object is essentially a single-threaded, stateful instance that can be used to coordinate data or hold state between events. In practice, when using WebSockets on Cloudflare, you often delegate the WebSocket handling to a Durable Object that will accept connections and manage messages. This Durable Object becomes a <strong>single point of coordination</strong> for a given set of clients (for example, all clients in a chat room connect to the same Durable Object) (<a href="https://developers.cloudflare.com/durable-objects/best-practices/websockets/#:~:text=WebSockets%20are%20long,when%20combined%20with%20Durable%20Objects" target="_blank" rel="noopener noreferrer" class="">Using WebSockets Â· Cloudflare Durable Objects docs</a>) (<a href="https://developers.cloudflare.com/durable-objects/best-practices/websockets/#:~:text=Because%20Durable%20Objects%20provide%20a,using%20Durable%20Objects%20with%20WebSockets" target="_blank" rel="noopener noreferrer" class="">Using WebSockets Â· Cloudflare Durable Objects docs</a>). The Durable Object can keep track of connected sockets, broadcast messages, and maintain any per-connection session data, all within the Cloudflare edge network. Cloudflare even offers a <strong>WebSocket Hibernation</strong> feature â€“ if a Durable Object has no activity, it can hibernate (persist state and free resources) while keeping the connections alive, and wake up when needed (<a href="https://pikku.dev/blog/2024/12/23/pikku-goes-serverless#:~:text=Last%20but%20definitely%20not%20least%3A,external%20database%20like%20on%20AWS" target="_blank" rel="noopener noreferrer" class="">Pikku has gone serverless  | Pikku</a>). This is great for cost savings, but it underscores how <strong>non-trivial</strong> WebSockets can be in a serverless model â€“ you need special mechanisms to avoid holding compute instances open 24/7.</p><p><strong>In summary</strong>, implementing WebSockets in AWS or Cloudflare serverless environments means dealing with state in a place that doesnâ€™t naturally have it. AWS developers struggle with external data stores to track connections (<a href="https://tsh.io/blog/implementing-websocket-with-aws-lambda-and-api-gateway/#:~:text=The%20answer%20is%20simple,to%20send%20messages%20to%20them" target="_blank" rel="noopener noreferrer" class="">How I implemented WebSocket API Gateway with AWS Lambda</a>), and Cloudflare developers leverage Durable Objects to manage state and concurrency (<a href="https://developers.cloudflare.com/durable-objects/best-practices/websockets/#:~:text=WebSockets%20are%20long,when%20combined%20with%20Durable%20Objects" target="_blank" rel="noopener noreferrer" class="">Using WebSockets Â· Cloudflare Durable Objects docs</a>). These solutions work, but require extra infrastructure and careful architecture. Wouldnâ€™t it be nice if you could write your real-time logic without worrying about <em>how</em> it persists across function invocations or scales at the edge? <strong>Thatâ€™s exactly the gap Pikku aims to bridge.</strong></p><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-pikku-bridges-the-gap">How Pikku Bridges the Gap<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#how-pikku-bridges-the-gap" class="hash-link" aria-label="Direct link to How Pikku Bridges the Gap" title="Direct link to How Pikku Bridges the Gap" translate="no">â€‹</a></h2><p><strong>Pikku</strong> is a function-first TypeScript framework that takes a hybrid approach to WebSockets, letting you run real-time channels on both serverless platforms and traditional servers with minimal changes. Pikku provides an abstraction called <strong>Channels</strong> (its WebSocket support) that decouples your application logic from the underlying WebSocket implementation. In essence, you write your WebSocket handlers (connect, message, disconnect, etc.) once, and Pikku adapts them to the environment you deploy on â€“ whether itâ€™s a Node.js server, AWS API Gateway + Lambda, Cloudflare Workers, or anything in between (<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#:~:text=This%20approach%20keeps%20your%20real,plug%20in%20the%20right%20adapter" target="_blank" rel="noopener noreferrer" class="">Announcing Pikku 0.6: WebSockets, Scheduled Tasks, and a More Flexible, Typed Future | Pikku</a>).</p><p>One of Pikkuâ€™s key innovations for serverless support is the <strong><code>channelstore</code></strong>. The channel store is a built-in mechanism to persist WebSocket connections and associated user sessions outside of any single runtime instance. This means when a user connects via WebSocket, Pikku can record that connection (and any session data you attach to it) in a durable store. Later, if another serverless function instance needs to send a message to that user, it can retrieve the connection from the channel store and route the message appropriately. Practically, the channel store might be backed by different technologies depending on the platform: for example, in AWS you could use DynamoDB or an SQL database (Pikkuâ€™s AWS example uses PostgreSQL as a channel store) (<a href="https://pikku.dev/blog/2024/12/23/pikku-goes-serverless#:~:text=This%20is%20also%20powered%20by,stores%20in%20the%20next%20release" target="_blank" rel="noopener noreferrer" class="">Pikku has gone serverless  | Pikku</a>), while on Cloudflare, a Durable Object can serve as the channel store (maintaining connections in-memory with persistence via Cloudflareâ€™s infrastructure) (<a href="https://pikku.dev/blog/2024/12/23/pikku-goes-serverless#:~:text=Last%20but%20definitely%20not%20least%3A,external%20database%20like%20on%20AWS" target="_blank" rel="noopener noreferrer" class="">Pikku has gone serverless  | Pikku</a>). The beauty of Pikkuâ€™s approach is that as a developer, <strong>you donâ€™t have to manually implement all this plumbing</strong> â€“ Pikku provides the interface and helpers to handle storing and retrieving connections.</p><p>Hereâ€™s how it works in practice: Suppose a client connects to your Pikku WebSocket channel. In your Pikku <code>onConnect</code> handler, you might authenticate the user and call <code>userSession.set({ userId: 'Bob' })</code>. Under the hood, Pikku will ensure that this session data (â€œuserId: Bobâ€) is saved in the channel store <em>against that specific WebSocket connection</em>. If youâ€™re on a serverless platform, that means even if the next message from Bob is handled by a fresh function instance (with no memory of Bob), Pikku will fetch Bobâ€™s session from the store and know that this connection is associated with user Bob. Similarly, if you want to broadcast a message to all users in a certain group, Pikku can query the channel store for all active connections in that group and send out the messages, regardless of which physical instance those connections are attached to. This effectively <strong>mimics the convenience of in-memory WebSocket servers</strong> (where you have a list of connections readily available) while operating on stateless serverless infrastructure.</p><p>Crucially, Pikkuâ€™s channel abstraction doesnâ€™t lock you into one environment. You could run your Pikku app on a single Node.js server with a WebSocket library like <code>ws</code> or <code>uWebSockets.js</code> during development or for an on-prem deployment. Later, if you decide to move to AWS for scalability, you can deploy the same code with an AWS adapter and a DynamoDB/Postgres channel store with minimal changes (<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#:~:text=This%20approach%20keeps%20your%20real,plug%20in%20the%20right%20adapter" target="_blank" rel="noopener noreferrer" class="">Announcing Pikku 0.6: WebSockets, Scheduled Tasks, and a More Flexible, Typed Future | Pikku</a>). Pikku will handle wiring your channel events to AWS API Gateway and use the configured channel store to keep everything in sync. Likewise, you could deploy the same service to Cloudflare Workers â€“ Pikku will use Cloudflareâ€™s WebSocket server + Durable Object behind the scenes. This flexibility is the hallmark of Pikkuâ€™s hybrid approach: <strong>write once, run anywhere</strong> for WebSockets. It bridges the gap by providing the state management layer (sessions + connection persistence) and a uniform API for real-time events, so developers can focus on the application logic instead of the intricacies of each cloudâ€™s WebSocket quirks.</p><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="key-benefits-of-pikku">Key Benefits of Pikku<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#key-benefits-of-pikku" class="hash-link" aria-label="Direct link to Key Benefits of Pikku" title="Direct link to Key Benefits of Pikku" translate="no">â€‹</a></h2><p>Pikkuâ€™s approach to WebSocket channels brings several compelling benefits to developers:</p><ul>
<li class="">
<p><strong>Hybrid Architecture (Serverless + Traditional)</strong> â€“ Pikku enables truly hybrid deployments. You can run WebSocket channels in a serverless environment (AWS Lambda, Cloudflare Workers, etc.) <em>or</em> on a traditional server/VM with the <strong>same codebase</strong> (<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#:~:text=This%20approach%20keeps%20your%20real,plug%20in%20the%20right%20adapter" target="_blank" rel="noopener noreferrer" class="">Announcing Pikku 0.6: WebSockets, Scheduled Tasks, and a More Flexible, Typed Future | Pikku</a>). This means you arenâ€™t forced to choose between the convenience of serverless and the stability of a dedicated server; Pikku lets you have both. For example, develop and test locally on a Node.js server with an in-memory WebSocket, then deploy to AWS without rewriting your real-time logic. The frameworkâ€™s abstractions ensure your <code>onConnect</code>, <code>onMessage</code>, and other handlers behave consistently across environments. Switching from one runtime to another is as simple as plugging in the appropriate adapter, with no overhaul of your application code (<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#:~:text=This%20approach%20keeps%20your%20real,plug%20in%20the%20right%20adapter" target="_blank" rel="noopener noreferrer" class="">Announcing Pikku 0.6: WebSockets, Scheduled Tasks, and a More Flexible, Typed Future | Pikku</a>). This hybrid capability protects your investment in code and gives you freedom to use the architecture that fits your needs (or even a mix of both).</p>
</li>
<li class="">
<p><strong>Deployment Flexibility with Multiple WebSocket Implementations</strong> â€“ Whether you prefer the simplicity of the popular Node.js <code>ws</code> library, the high performance of <code>uWebSockets.js (uWS)</code>, or youâ€™re using cloud-specific implementations like AWS API Gateway WebSockets or Cloudflareâ€™s Workers/Durable Objects, Pikku has you covered. It is <strong>transport-agnostic</strong>, meaning your WebSocket channel logic is not tied to a specific server or library. Pikku provides adapters for major runtimes and WebSocket engines (<a href="https://pikku.dev/#:~:text=Deploy%20Anywhere%2C%20Integrate%20Seamlessly" target="_blank" rel="noopener noreferrer" class="">Pikku - A Function-First Framework for Node.js | Pikku</a>). For instance, you can use the Express or Fastify adapter for HTTP and pair it with <code>ws</code> for WebSockets, or use Pikkuâ€™s integration with uWS for a blazing-fast server. In serverless, the AWS adapter knows how to handle API Gateway WebSocket events, and the Cloudflare adapter uses the edge network. This flexibility simplifies deployment pipelines â€” you can confidently deploy Pikku on AWS, Azure, Cloudflare, or even inside Docker containers, knowing the WebSocket pieces will just work. No more writing custom glue code for each provider or worrying that your WebSocket library isnâ€™t supported on platform X. Pikku abstracts those differences away (<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#:~:text=,WebSocket%20environments%20without%20painful%20rewrites" target="_blank" rel="noopener noreferrer" class="">Announcing Pikku 0.6: WebSockets, Scheduled Tasks, and a More Flexible, Typed Future | Pikku</a>), allowing you to focus on your appâ€™s real-time features instead of low-level compatibility issues.</p>
</li>
<li class="">
<p><strong>TypeScript Support &amp; Auto-Generated Client</strong> â€“ Pikku is built with <strong>TypeScript</strong> at its core, which means you get static type checking and intellisense for your WebSocket messages and data structures. When you define a channel and the types of messages it sends or receives, Pikku leverages that to ensure type safety end-to-end. Even more impressive: Pikku can <strong>automatically generate a client library</strong> for your channels (<a href="https://pikku.dev/#:~:text=%2A%20,Clients" target="_blank" rel="noopener noreferrer" class="">Pikku - A Function-First Framework for Node.js | Pikku</a>). This client is a tiny TypeScript/JavaScript module that knows how to connect to your WebSocket channel and has methods for each message type or action you define. For example, if you have a channel where clients can send a <code>{action: "join", roomId: 123}</code> message and receive a <code>"welcome"</code> event, the auto-generated client will have the corresponding methods/types to send and handle those properly. Developers no longer need to write repetitive front-end WebSocket code or manually keep client-server message contracts in sync. The generated client is fully-typed, so if you change a data format on the server, your front-end code will catch the mismatch at compile time. This <strong>tight coupling of front-end and back-end types</strong> eliminates an entire class of bugs and makes building real-time features much more ergonomic. In short, Pikku treats WebSockets as first-class citizens in the TypeScript world, bringing the kind of productivity and safety that developers typically enjoy with REST/HTTP (through OpenAPI, etc.) to the realm of WebSockets.</p>
</li>
</ul><p>Each of these benefits on its own is valuable, but together they make Pikku a <strong>game-changer for WebSocket development</strong> in cloud environments. You get the real-time responsiveness users crave, without the usual DevOps headache of maintaining stateful servers or the fear that serverless will complicate your design. Pikku handles the heavy lifting under the hood â€“ from connection persistence to client generation â€“ so you can deliver interactive features faster and with confidence.</p><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion-and-call-to-action">Conclusion and Call to Action<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#conclusion-and-call-to-action" class="hash-link" aria-label="Direct link to Conclusion and Call to Action" title="Direct link to Conclusion and Call to Action" translate="no">â€‹</a></h2><p>WebSockets no longer have to be a black box of state management hacks or provider-specific code. With Pikkuâ€™s hybrid architecture and channel store magic, you can build real-time channels that <strong>just work</strong>, whether youâ€™re on AWS, Cloudflare, or a classic server setup. Weâ€™ve seen how the framework abstracts the nuances of WebSocket events and session persistence across environments, letting you write clean, expressive TypeScript functions for your real-time logic. The result is less boilerplate, fewer edge-case bugs, and a more enjoyable developer experience when tackling features like live chats, IoT feeds, or multiplayer games.</p><p><strong>Ready to try Pikku for yourself?</strong> The best way to appreciate its simplicity is to see it in action. Head over to the Pikku documentation and get started with a quick tutorial, or spin up the Pikku starter project (which includes examples for AWS and Cloudflare) to deploy a WebSocket channel in minutes. Give Pikku a spin in your next project and experience how effortless real-time web development can be. With Pikku handling your WebSockets, you can focus on building awesome features â€” and let the framework bridge the gap between serverless scale and real-time state. Happy coding, and welcome to the future of WebSocket development with Pikku!</p></div></div></details>
<!-- -->
<h1>Bridging the Gap: Real-Time WebSocket Channels with Pikku</h1>
<p>Real-time applicationsâ€”from live chats and collaborative tools to gaming and IoT dashboardsâ€”rely on persistent, two-way communication. WebSockets provide this vital connection, yet building and scaling WebSocket channels across serverless environments (like AWS or Cloudflare) and traditional servers can be challenging. <strong>Pikku</strong> bridges this gap with its hybrid architecture and a powerful API set: <strong>onConnect</strong>, <strong>onMessage</strong>, <strong>onDisconnect</strong>, and <strong>wireChannel</strong>.</p>
<p>One of Pikkuâ€™s standout features is its built-in sync/async <strong>channelstore interface</strong>. This flexible interface isnâ€™t tied to any specific datastoreâ€”it can be implemented against any desired backend (be it a SQL database, NoSQL store, or even Cloudflare Durable Objects). This means that whether youâ€™re working in a serverless environment or on a traditional server, you have a consistent way to persist connection states and user sessions without being locked into one storage solution.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-quick-dive-into-websockets">A Quick Dive into WebSockets<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#a-quick-dive-into-websockets" class="hash-link" aria-label="Direct link to A Quick Dive into WebSockets" title="Direct link to A Quick Dive into WebSockets" translate="no">â€‹</a></h2>
<p>WebSockets keep the conversation open. Unlike HTTPâ€™s strict requestâ€“response model, they maintain an open connection, allowing both client and server to send data at any time. This is managed by a few key events:</p>
<ul>
<li class=""><strong>onConnect</strong>: Triggered when a client connectsâ€”ideal for authenticating users and initializing state.</li>
<li class=""><strong>onMessage</strong>: Fires when a message is received, letting you process and route the data.</li>
<li class=""><strong>onDisconnect</strong>: Called when the connection closes, ensuring resources are properly cleaned up.</li>
</ul>
<p>Pikku bridges these events inside its <strong>wireChannel</strong> API, making it easy to deploy the same logic anywhereâ€”from a local server using <code>ws</code> or <code>uWebSockets.js</code> to serverless setups on AWS and Cloudflare.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="websocket-lifecycle-diagram">WebSocket Lifecycle Diagram<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#websocket-lifecycle-diagram" class="hash-link" aria-label="Direct link to WebSocket Lifecycle Diagram" title="Direct link to WebSocket Lifecycle Diagram" translate="no">â€‹</a></h3>
<!-- -->
<p><em>Figure: The lifecycle of a WebSocket connection in Pikku.</em></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="deep-dive-pikku-channel-apis--onmessageroute">Deep Dive: Pikku Channel APIs &amp; onMessageRoute<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#deep-dive-pikku-channel-apis--onmessageroute" class="hash-link" aria-label="Direct link to Deep Dive: Pikku Channel APIs &amp; onMessageRoute" title="Direct link to Deep Dive: Pikku Channel APIs &amp; onMessageRoute" translate="no">â€‹</a></h2>
<p>Pikkuâ€™s intuitive API surface streamlines real-time communication. Its standout featureâ€”<strong>onMessageRoute</strong>â€”is inspired by AWSâ€™s native WebSocket routing. Much like how AWS API Gateway routes messages to dedicated Lambda functions based on custom route keys, onMessageRoute lets you define granular sub-routes under a common namespace.</p>
<p>Consider this simplified backend snippet:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> onConnect</span><span class="token imports punctuation" style="color:#393A34">,</span><span class="token imports"> onMessage</span><span class="token imports punctuation" style="color:#393A34">,</span><span class="token imports"> </span><span class="token imports spread operator" style="color:#393A34">...</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./events.functions.js'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'events'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Called on Open</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onConnect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Called on Close</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onDisconnect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Whether a user session is required</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">auth</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">onMessageRoute</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If payload has a key "action", it will forward to the correct handler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Auth isn't needed for this message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">auth</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> authenticate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">auth</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// We could add custom permissions for certain messages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">subscribe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> subscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      unsubscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">emit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> emitMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Whatâ€™s happening here?</strong></p>
<ul>
<li class=""><strong>wireChannel</strong> registers the channel and bundles your lifecycle functions.</li>
<li class=""><strong>onConnect/onDisconnect/onMessage</strong> manage the core connection events.</li>
<li class=""><strong>onMessageRoute</strong>â€”inspired by AWSâ€™s routing mechanismâ€”lets you define specific handlers (like <code>auth</code>, <code>subscribe</code>, etc.) for different actions. This modular approach makes your code clean, secure, and highly scalable.</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="leveraging-the-auto-generated-client-on-the-frontend">Leveraging the Auto-Generated Client on the Frontend<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#leveraging-the-auto-generated-client-on-the-frontend" class="hash-link" aria-label="Direct link to Leveraging the Auto-Generated Client on the Frontend" title="Direct link to Leveraging the Auto-Generated Client on the Frontend" translate="no">â€‹</a></h2>
<p>Pikku doesnâ€™t just simplify backend logic; it also auto-generates a TypeScript-friendly client for your frontend. This means you get a fully typed, ready-to-use API that mirrors your backend channels without additional boilerplate.</p>
<p><code>PikkuWebSocket</code> is a tiny wrapper ontop of <code>WebSocket</code> powered by types, which aren't included in the actual application. This keeps your realtime SDKs tiny!</p>
<p>A simplified frontend snippet might look like this:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">PikkuWebSocket</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'../pikku-websocket.gen.js'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">websocket</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">serverUrl</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> apiKey</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> userId</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> onClose</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> authState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'initial'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> socket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PikkuWebSocket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'events'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serverUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> apiKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onopen</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'WebSocket connected'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Subscribe to global messages.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Global message:'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the route for action-based messages.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> route </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'action'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'auth'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      authState </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">authResult</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'authenticated'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'unauthenticated'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Authentication </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">authState</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Send an auth message.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'auth'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">token</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'valid'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> userId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Wait for authentication to complete.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">authState </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'initial'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">resolve</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resolve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Send other messages: subscribing and emitting.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'subscribe'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'test'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'emit'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'test'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Close the connection after a short period.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">onclose</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> onClose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onerror</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'WebSocket error:'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Key Points:</strong></p>
<ul>
<li class=""><strong>Auto-Generated Client</strong>: Enjoy a client that mirrors your backend channels exactlyâ€”no extra glue code required.</li>
<li class=""><strong>Type Safety</strong>: With TypeScript, you get end-to-end type checking, ensuring client and server stay in sync.</li>
<li class=""><strong>Seamless Integration</strong>: Build your demo or production app with the same confidence, whether youâ€™re deploying on traditional servers or using serverless platforms.</li>
</ul>
<p>For a complete working exampleâ€”including support for <code>ws</code>, <code>uWS</code>, Cloudflare, and Lambdaâ€”check out the <a href="https://github.com/pikkujs/yarn-workspace-starter" target="_blank" rel="noopener noreferrer" class="">Yarn Workspace Starter Repository</a>.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="websockets-in-the-cloud-aws--cloudflare">WebSockets in the Cloud: AWS &amp; Cloudflare<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#websockets-in-the-cloud-aws--cloudflare" class="hash-link" aria-label="Direct link to WebSockets in the Cloud: AWS &amp; Cloudflare" title="Direct link to WebSockets in the Cloud: AWS &amp; Cloudflare" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="aws-api-gateway--lambda">AWS API Gateway &amp; Lambda<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#aws-api-gateway--lambda" class="hash-link" aria-label="Direct link to AWS API Gateway &amp; Lambda" title="Direct link to AWS API Gateway &amp; Lambda" translate="no">â€‹</a></h3>
<ul>
<li class=""><strong>Challenge</strong>: AWS Lambda functions are ephemeral, making persistent WebSocket connections difficult. Developers often need external databases (like DynamoDB) to track connection state.</li>
<li class=""><strong>Pikkuâ€™s Solution</strong>: Pikku leverages its built-in channelstore interfaceâ€”which can be implemented against any datastoreâ€”to persist connection and session data. This means that even if a new Lambda instance handles the next message, it can retrieve the connectionâ€™s context seamlessly.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="cloudflare-workers--durable-objects">Cloudflare Workers &amp; Durable Objects<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#cloudflare-workers--durable-objects" class="hash-link" aria-label="Direct link to Cloudflare Workers &amp; Durable Objects" title="Direct link to Cloudflare Workers &amp; Durable Objects" translate="no">â€‹</a></h3>
<ul>
<li class=""><strong>Challenge</strong>: Cloudflare Workers, while powerful, are also stateless. Durable Objects help manage state, but the setup can be complex.</li>
<li class=""><strong>Pikkuâ€™s Solution</strong>: The uniform API lets you write your WebSocket logic once. Whether using Durable Objects on Cloudflare or an external store on AWS, your codeâ€”powered by onConnect, onMessage, onDisconnect, and onMessageRouteâ€”remains consistent.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="hybrid-architecture-diagram">Hybrid Architecture Diagram<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#hybrid-architecture-diagram" class="hash-link" aria-label="Direct link to Hybrid Architecture Diagram" title="Direct link to Hybrid Architecture Diagram" translate="no">â€‹</a></h3>
<!-- -->
<p><em>Figure: Pikkuâ€™s provides a runLocalChannel and runServerless channel interface that normalizes user code without losing any performance when running locally.</em></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-power-of-pikku">The Power of Pikku<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#the-power-of-pikku" class="hash-link" aria-label="Direct link to The Power of Pikku" title="Direct link to The Power of Pikku" translate="no">â€‹</a></h2>
<p>Pikku isnâ€™t just another WebSocket libraryâ€”itâ€™s a comprehensive framework designed for todayâ€™s diverse deployment needs. Hereâ€™s why it stands out:</p>
<ul>
<li class=""><strong>Hybrid Architecture</strong>: Write your WebSocket logic once and deploy it anywhereâ€”be it a Node.js server or a serverless environment like AWS/Cloudflare.</li>
<li class=""><strong>Deployment Flexibility</strong>: With adapters for multiple WebSocket implementations, you can deploy on your platform of choice without rewriting your real-time logic.</li>
<li class=""><strong>AWS-Inspired onMessageRoute</strong>: Modeled after AWSâ€™s native WebSocket routing, this feature offers a modular, structured approach to handling various message actions.</li>
<li class=""><strong>Built-In Channelstore Interface</strong>: Its channelstore isnâ€™t hardwired to one solution. You can implement it against any desired datastore, making it incredibly flexible for any backend.</li>
<li class=""><strong>Robust TypeScript Support &amp; Auto-Generated Client</strong>: Enjoy static type checking and an auto-generated client that minimizes bugs and streamlines development.</li>
<li class=""><strong>Intuitive APIs</strong>: With well-defined <strong>onConnect</strong>, <strong>onMessage</strong>, <strong>onDisconnect</strong>, and <strong>wireChannel</strong> APIs, Pikku abstracts away the complexities of state management and connection handling, letting you focus on building engaging real-time features.</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="https://pikku.dev/blog/2025/03/12/websockets-pikku-architecture#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">â€‹</a></h2>
<p>Managing real-time WebSocket channels across diverse environments has traditionally been complex and error-prone. With Pikkuâ€™s hybrid architecture, AWS-inspired onMessageRoute, and a built-in channelstore interface that can be implemented against any datastore, building robust real-time applications becomes a breeze.</p>
<p>Ready to revolutionize your real-time apps?</p>
<ul>
<li class=""><strong>Explore the <a href="https://pikku.dev/docs/wiring/channels/" target="_blank" rel="noopener noreferrer" class="">Pikku documentation</a></strong> for in-depth details.</li>
<li class=""><strong>Dive into the <a href="https://github.com/pikkujs/yarn-workspace-starter" target="_blank" rel="noopener noreferrer" class="">Yarn Workspace Starter Repository</a></strong> for complete examples covering ws, uws, Cloudflare, and Lambda.</li>
</ul>
<p>Harness the full potential of WebSockets with a framework that adapts to your deployment needs. With Pikku handling the heavy lifting, you can focus on delivering dynamic, engaging experiences to your users. Happy coding!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Pikku Tags And Middleware]]></title>
        <id>https://pikku.dev/blog/2025/03/11/pikku-tags-middleware</id>
        <link href="https://pikku.dev/blog/2025/03/11/pikku-tags-middleware"/>
        <updated>2025-03-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introducing Middleware & Tag Filtering in Pikku]]></summary>
        <content type="html"><![CDATA[<p>We're excited to roll out two powerful new features in Pikku: <strong>Middleware</strong> and <strong>Tag Filtering</strong>. These enhancements provide you with more control over your API routes and streamline deployments by bundling only the routes you need.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="middleware-flexible-and-powerful">Middleware: Flexible and Powerful<a href="https://pikku.dev/blog/2025/03/11/pikku-tags-middleware#middleware-flexible-and-powerful" class="hash-link" aria-label="Direct link to Middleware: Flexible and Powerful" title="Direct link to Middleware: Flexible and Powerful" translate="no">â€‹</a></h2>
<p>Taking cues from frameworks like <strong>Express</strong>, <strong>Koa</strong>, and <strong>Hono</strong>, we've built a robust middleware system. Middleware in Pikku lets you:</p>
<ul>
<li class=""><strong>Inject custom logic:</strong> Whether it's setting up user sessions, managing timeouts, or manipulating headers.</li>
<li class=""><strong>Keep your code clean:</strong> Separate cross-cutting concerns from your core route logic.</li>
<li class=""><strong>Enhance security:</strong> Easily validate API keys or perform other authentication tasks.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-it-works">How It Works<a href="https://pikku.dev/blog/2025/03/11/pikku-tags-middleware#how-it-works" class="hash-link" aria-label="Direct link to How It Works" title="Direct link to How It Works" translate="no">â€‹</a></h3>
<p>A middleware function is simply a function that intercepts a request before it reaches your route handler. For example:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> middleware</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">PikkuMiddleware</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> http </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Example: Check for a valid API key and set a user session</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">request</span><span class="token operator" style="color:#393A34">?.</span><span class="token function" style="color:#d73a49">getHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'x-api-key'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'my-token'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userSession</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* session data */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>You can add middleware globally or per route:</p>
<ul>
<li class="">
<p><strong>Global Middleware:</strong></p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wireMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/admin/*'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">adminMiddleware</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong>Route-Specific Middleware:</strong></p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wireHTTP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/admin'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'get'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> yourFunction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    middleware</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">adminMiddleware</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="tag-filtering-bundle-only-what-you-need">Tag Filtering: Bundle Only What You Need<a href="https://pikku.dev/blog/2025/03/11/pikku-tags-middleware#tag-filtering-bundle-only-what-you-need" class="hash-link" aria-label="Direct link to Tag Filtering: Bundle Only What You Need" title="Direct link to Tag Filtering: Bundle Only What You Need" translate="no">â€‹</a></h2>
<p>Tag filtering is designed to optimize your builds by including only the routes, channels, or transports that are necessary. This means:</p>
<ul>
<li class=""><strong>Lean deployments:</strong> Only bundle routes that match specific tags.</li>
<li class=""><strong>Customizable environments:</strong> Easily manage routes for different environments (e.g., admin vs. public).</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="example-usage">Example Usage<a href="https://pikku.dev/blog/2025/03/11/pikku-tags-middleware#example-usage" class="hash-link" aria-label="Direct link to Example Usage" title="Direct link to Example Usage" translate="no">â€‹</a></h3>
<p>In your CLI configuration, you might set up filters like this:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"filters"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"tags"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"admin"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>And then tag your routes accordingly:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">addRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/admin'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'get'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> yourFunction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'admin'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>For tag filtering to work correctly, please ensure that each route is defined in its own file.</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="looking-ahead">Looking Ahead<a href="https://pikku.dev/blog/2025/03/11/pikku-tags-middleware#looking-ahead" class="hash-link" aria-label="Direct link to Looking Ahead" title="Direct link to Looking Ahead" translate="no">â€‹</a></h2>
<p>These new features are just the beginning. With middleware, you're empowered to add HTTP (and other) logic without affecting your main code, and tag filtering ensures your deployments are as slim and efficient as possible. Weâ€™re committed to evolving Pikku in a way thatâ€™s as forward-thinking as the projects you build.</p>
<p>Try these features out today and let us know how they improve your workflow!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Pikku Rebrand!]]></title>
        <id>https://pikku.dev/blog/2025/03/05/pikku-rebrand</id>
        <link href="https://pikku.dev/blog/2025/03/05/pikku-rebrand"/>
        <updated>2025-03-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[The Pikku Rebrand!]]></summary>
        <content type="html"><![CDATA[<p>Hello again!</p>
<p>I'm excited to announce that our rebrand is officially here â€“ welcome to Pikku! This isnâ€™t just a facelift; itâ€™s a complete rethink of how we can make developers' lives easier. Inspired by awesome projects like <a href="https://hono.dev/" target="_blank" rel="noopener noreferrer" class="">Hono</a> and fueled by genuine feedback from our NodeJS meetup, we've revamped most things to be more streamlined.</p>
<p>I'm still sharpening my branding skills, but with the help of friends and a touch of MIT-inspired magic, we now have a look and feel that's as simple as the code we write.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="whats-new">Whatâ€™s New?<a href="https://pikku.dev/blog/2025/03/05/pikku-rebrand#whats-new" class="hash-link" aria-label="Direct link to Whatâ€™s New?" title="Direct link to Whatâ€™s New?" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-in-depth-explanations-and-flow-diagrams">ðŸ“Š In-Depth Explanations and Flow Diagrams<a href="https://pikku.dev/blog/2025/03/05/pikku-rebrand#-in-depth-explanations-and-flow-diagrams" class="hash-link" aria-label="Direct link to ðŸ“Š In-Depth Explanations and Flow Diagrams" title="Direct link to ðŸ“Š In-Depth Explanations and Flow Diagrams" translate="no">â€‹</a></h3>
<p>We tried to share as much information as we could without overloading the user. Mermaid diagrams and in-depth explanations are now located in multiple documents!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-create-with-a-single-command">ðŸš€ Create with a Single Command<a href="https://pikku.dev/blog/2025/03/05/pikku-rebrand#-create-with-a-single-command" class="hash-link" aria-label="Direct link to ðŸš€ Create with a Single Command" title="Direct link to ðŸš€ Create with a Single Command" translate="no">â€‹</a></h3>
<p>Kickstart your projects faster than ever:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npm run pikku@latest</span><br></span></code></pre></div></div>
<p>This one command sets up templates, including a Next.js app and a fully-fledged yarn workspace that's backed by a Postgres database, and even lays out deployment options (Docker files included).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-all-in-one-the-pikku-npm-package">ðŸ”— All-In-One: The Pikku npm Package<a href="https://pikku.dev/blog/2025/03/05/pikku-rebrand#-all-in-one-the-pikku-npm-package" class="hash-link" aria-label="Direct link to ðŸ”— All-In-One: The Pikku npm Package" title="Direct link to ðŸ”— All-In-One: The Pikku npm Package" translate="no">â€‹</a></h3>
<p>Streamline your imports with a single, centralized package:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'pikku'</span><br></span></code></pre></div></div>
<p>No more juggling a dozen individual packagesâ€”just one sleek entry point to supercharge your development workflow.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This is a change that will roll out as we ensure that package sizes don't grow.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-new-pikkuschema-cfworker-package">ðŸ›  New @pikku/schema-cfworker Package<a href="https://pikku.dev/blog/2025/03/05/pikku-rebrand#-new-pikkuschema-cfworker-package" class="hash-link" aria-label="Direct link to ðŸ›  New @pikku/schema-cfworker Package" title="Direct link to ðŸ›  New @pikku/schema-cfworker Package" translate="no">â€‹</a></h3>
<p>Introducing our versatile schema validator! It might be a bit slower since it skips precompilation, but itâ€™s designed to work seamlessly across all deployment platforms.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="-enhanced-apis--ci-improvements">ðŸ’¡ Enhanced APIs &amp; CI Improvements<a href="https://pikku.dev/blog/2025/03/05/pikku-rebrand#-enhanced-apis--ci-improvements" class="hash-link" aria-label="Direct link to ðŸ’¡ Enhanced APIs &amp; CI Improvements" title="Direct link to ðŸ’¡ Enhanced APIs &amp; CI Improvements" translate="no">â€‹</a></h3>
<ul>
<li class=""><strong>APIs:</strong> Our Next.js integrations and PikkuFetch now provide cleaner, more intuitive interfaces. Random TypeScript errors? Consider them history.</li>
<li class=""><strong>CI Enhancements:</strong> Every template now undergoes rigorous testing as part of our improved CI pipeline, ensuring that every build is solid from the get-go.</li>
</ul>
<hr>
<p>Iâ€™m excited for you to try out Pikku and see these improvements in action. Dive in, explore, and hit me with your feedbackâ€”this rebrand is just the start of a long journey, and I'm all in for making things better and faster.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Introducing Inspector Pikku]]></title>
        <id>https://pikku.dev/blog/2025/01/08/inspector-pikku</id>
        <link href="https://pikku.dev/blog/2025/01/08/inspector-pikku"/>
        <updated>2025-01-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Extracting pikku inspection into its own package]]></summary>
        <content type="html"><![CDATA[<p>Happy New Year everyone!</p>
<p>This release is pretty small, and completely backward-compatible.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="pikkuinspector">@pikku/inspector<a href="https://pikku.dev/blog/2025/01/08/inspector-pikku#pikkuinspector" class="hash-link" aria-label="Direct link to @pikku/inspector" title="Direct link to @pikku/inspector" translate="no">â€‹</a></h2>
<p>The biggest change is that we extracted the code that inspects the codebase into a separate package. The goal of this package is to produce a JSON file from the codebase it inspects, which will make testing much more robust and open up new avenues for integration.</p>
<p>This also lays the foundation for pikkuâ€™s upcoming dependency management system. Combined with ES6, it will provide a simple approach for loading/tree-shaking only the services needed for the subset of desired functions. Super excited about this (also the last large feature on the current roadmap!)</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="support-for-duplicate-names">Support for Duplicate Names<a href="https://pikku.dev/blog/2025/01/08/inspector-pikku#support-for-duplicate-names" class="hash-link" aria-label="Direct link to Support for Duplicate Names" title="Direct link to Support for Duplicate Names" translate="no">â€‹</a></h2>
<p>Another feature is that the inspector has been redesigned to treat all imports as unique, and only at the end does it attempt to resolve any duplicates.</p>
<p>This approach means we donâ€™t have to worry about duplicate types during development. While this wasnâ€™t high on my radar initially, I encountered name clashes in my current projectsâ€”leading to manual renaming across the codebase, which turned out to be more effort than necessary. Now, the inspectorâ€™s approach makes it much more convenient to work with similarly named imports.</p>
<hr>
<p>Enjoy the new version and keep an eye out for more updates soon!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Pikku has gone serverless ðŸš€]]></title>
        <id>https://pikku.dev/blog/2024/12/23/pikku-goes-serverless</id>
        <link href="https://pikku.dev/blog/2024/12/23/pikku-goes-serverless"/>
        <updated>2024-12-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Cloudflare and AWS support has been added]]></summary>
        <content type="html"><![CDATA[<p><em>Just in time for Christmas!</em></p>
<p>I know, the day before Christmas isnâ€™t exactly the best day for announcements, but Iâ€™m about to put away my keyboard until next year and wanted one final blog entry before taking a break. And Iâ€™m excited to share that Pikku now has <strong>official support</strong> for serverless on AWS and Cloudflare â€” complete with examples!</p>
<p>This milestone has been really interesting. Different serverless solutions definitely donâ€™t think alike, especially when it comes to websockets. My main goal was to prove Pikku can handle websockets (along with HTTP and scheduled tasks, which were a breeze) and do it all in a way that you can get up and running as quickly as possible.</p>
<p>After a few days of headbanging, we ended up with three new backends in the <a href="https://github.com/pikku/workspace-starter" target="_blank" rel="noopener noreferrer" class="">workspace-starter</a> repo, each offering a different serverless approach:</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-serverless-aws-lambda">1. Serverless (AWS Lambda)<a href="https://pikku.dev/blog/2024/12/23/pikku-goes-serverless#1-serverless-aws-lambda" class="hash-link" aria-label="Direct link to 1. Serverless (AWS Lambda)" title="Direct link to 1. Serverless (AWS Lambda)" translate="no">â€‹</a></h2>
<p>This is the classic <a href="https://www.serverless.com/" target="_blank" rel="noopener noreferrer" class="">Serverless</a> setup using a <code>yaml</code> file to deploy Lambda functions in AWS. If you want your scheduled tasks and HTTP APIs running in no time, this oneâ€™s a solid pick. Just grab the template, follow the instructions, and youâ€™re good to go.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-serverless-websocket-aws">2. Serverless Websocket (AWS)<a href="https://pikku.dev/blog/2024/12/23/pikku-goes-serverless#2-serverless-websocket-aws" class="hash-link" aria-label="Direct link to 2. Serverless Websocket (AWS)" title="Direct link to 2. Serverless Websocket (AWS)" translate="no">â€‹</a></h2>
<p>This is also powered by Serverless but kept separate since websockets arenâ€™t everyoneâ€™s cup of tea. For those who do need websockets, this example includes a PostgreSQL subscription and channel store. (Normally, AWS suggests DynamoDB, but since we're already on PostgreSQL, why not stick with it?) Iâ€™ll share more documentation on these stores in the next release.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-cloudflare-workers">3. Cloudflare Workers<a href="https://pikku.dev/blog/2024/12/23/pikku-goes-serverless#3-cloudflare-workers" class="hash-link" aria-label="Direct link to 3. Cloudflare Workers" title="Direct link to 3. Cloudflare Workers" translate="no">â€‹</a></h2>
<p>Last but definitely not least: <strong>Cloudflare Workers</strong>. This lets us deploy HTTP, scheduled tasks, and websocket connections via Cloudflareâ€”a more cost-efficient solution than AWS in many cases. They offer something called a <a href="https://developers.cloudflare.com/durable-objects/examples/websocket-hibernation-server/" target="_blank" rel="noopener noreferrer" class="">Websocket server with Hibernation</a>, which cuts down on costs by suspending the server when there are no connections. Combine that with <a href="https://developers.cloudflare.com/durable-objects/examples/durable-object-in-memory-state/" target="_blank" rel="noopener noreferrer" class="">Durable Objects</a>, and thereâ€™s no need for an external database like on AWS.</p>
<p>Iâ€™ve only tested this in Wrangler (the offline Cloudflare runner), so itâ€™s still in beta. Depending on feedback, we can also create adapters for other websocket solutions Cloudflare provides.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="wrapping-up">Wrapping Up<a href="https://pikku.dev/blog/2024/12/23/pikku-goes-serverless#wrapping-up" class="hash-link" aria-label="Direct link to Wrapping Up" title="Direct link to Wrapping Up" translate="no">â€‹</a></h2>
<p>Thatâ€™s it for now! There are some other improvements (and a few breaking changes) coming soon, but they can wait until next year.</p>
<p>Have a wonderful holiday season, and see you all in the new year!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Announcing Pikku 0.6: WebSockets, Scheduled Tasks, and a More Flexible, Typed Future]]></title>
        <id>https://pikku.dev/blog/2024/12/13/pikku-0.6</id>
        <link href="https://pikku.dev/blog/2024/12/13/pikku-0.6"/>
        <updated>2024-12-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Explore Pikku 0.6â€™s new Typed Streams/WebSocket support, scheduled tasks (including serverless deployments) and compile-time optimizations.]]></summary>
        <content type="html"><![CDATA[<p>Modern backend development can be messy. You might lock into a single runtime or server, and keeping frontend and backend types in sync is often painful. <strong><a href="https://github.com/pikkujs/pikku" target="_blank" rel="noopener noreferrer" class="">Pikku</a></strong> 0.6 aims to change thatâ€”offering a function-first, TypeScript-powered ecosystem that lets you build once and deploy anywhere with complete type safety.</p>
<p>Pikku isnâ€™t just another Node.js server framework. Instead, itâ€™s a lightweight abstraction layer that pairs seamlessly with servers like <a href="https://github.com/uNetworking/uWebSockets.js" target="_blank" rel="noopener noreferrer" class="">uWebSockets.js (uWS)</a>, <a href="https://expressjs.com/" target="_blank" rel="noopener noreferrer" class="">Express</a>, and <a href="https://www.fastify.io/" target="_blank" rel="noopener noreferrer" class="">Fastify</a>. It runs on <a href="https://nodejs.org/en" target="_blank" rel="noopener noreferrer" class="">Node.js</a> and will soon support <a href="https://bun.sh/" target="_blank" rel="noopener noreferrer" class="">Bun</a> or <a href="https://deno.land/" target="_blank" rel="noopener noreferrer" class="">Deno</a>. Whether you deploy to Docker containers on VMs or use a serverless platform like <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener noreferrer" class="">AWS Lambda</a> or <a href="https://azure.microsoft.com/en-us/products/functions" target="_blank" rel="noopener noreferrer" class="">Azure Functions</a>, Pikkuâ€™s abstractions help you switch infrastructure without massive rewrites.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="whats-new-in-pikku-06">Whatâ€™s New in Pikku 0.6<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#whats-new-in-pikku-06" class="hash-link" aria-label="Direct link to Whatâ€™s New in Pikku 0.6" title="Direct link to Whatâ€™s New in Pikku 0.6" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scheduled-tasks">Scheduled Tasks<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#scheduled-tasks" class="hash-link" aria-label="Direct link to Scheduled Tasks" title="Direct link to Scheduled Tasks" translate="no">â€‹</a></h3>
<p>You can now define scheduled tasks right alongside your API functionsâ€”no separate cron setup or external schedulers needed. These tasks can run in both traditional servers and serverless runtimes. For example, deploy them on AWS Lambda with EventBridge or Azure Functions Timer Triggers. Just one function and a simple configuration:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> addScheduledTask </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@pikku/core/scheduler'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> myScheduledTask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pikkuVoidFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Your scheduled logic here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">addScheduledTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'myScheduledTask'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schedule</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'*/1 * * * *'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// every minute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> myScheduledTask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This makes recurring jobs (like daily data syncs or periodic cleanups) straightforward and fully integratedâ€”no matter where you run them.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="channels-websockets-and-beyond">Channels (WebSockets and Beyond)<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#channels-websockets-and-beyond" class="hash-link" aria-label="Direct link to Channels (WebSockets and Beyond)" title="Direct link to Channels (WebSockets and Beyond)" translate="no">â€‹</a></h3>
<p>Real-time capabilities are now first-class citizens in Pikku. Weâ€™re introducing <strong>Channels</strong>, a unified interface for bi-directional communication. Inspired by <a href="https://www.asyncapi.com/" target="_blank" rel="noopener noreferrer" class="">AsyncAPI</a> and influenced by tools like <a href="https://deepstream.io/" target="_blank" rel="noopener noreferrer" class="">deepstream.io</a>, Channels let you:</p>
<ul>
<li class="">Manage WebSocket connections with type safety, session handling, and authentication.</li>
<li class="">Implement pub/sub patterns seamlessly with built-in subscription services.</li>
<li class="">Deploy to VMs, Docker containers, or serverless WebSocket environments without painful rewrites.</li>
</ul>
<hr>
<p><strong>Example Channel Functions:</strong></p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> onConnect</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ChannelConnection</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token string" style="color:#e3116c">'hello!'</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'New connection'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'hello!'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> authenticate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ChannelMessage</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> token</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> authResult</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> authResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">token </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'valid'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">authResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setSession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> userId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Bob'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> authResult </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<hr>
<p><strong>Linking Functions into a Channel:</strong></p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> wireChannel </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'../.pikku/pikku-types.gen.js'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> onConnect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onDisconnect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> subscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> unsubscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> emitMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> authenticate </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./events.functions.js'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wireChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/event'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Called when a client connects to the channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onConnect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Called when a client disconnects from the channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onDisconnect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// A global auth guard for all message routes (can be overridden)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Default message handler if no route is matched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    onMessageRoute</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        action</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Sets the user session, enabling authenticated routes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            auth</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> authenticate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                auth</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// A route with nested function config for applying permissions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            subscribe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> subscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Shorthand route definition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unsubscribe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// A route that references another function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            emit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> emitMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This approach keeps your real-time code organized and modular. Switch between servers or move to a serverless WebSocket platform without touching your message-handling logicâ€”just plug in the right adapter.</p>
<p><strong>Using websocket client side:</strong></p>
<p>We generate a really simple wrapper around WebSockets to provide typed methods. You can see how this works <a href="https://docs/25-clients/30-websocket.md" target="_blank" rel="noopener noreferrer" class="">here</a>.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="stronger-compile-time-insights">Stronger Compile-Time Insights<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#stronger-compile-time-insights" class="hash-link" aria-label="Direct link to Stronger Compile-Time Insights" title="Direct link to Stronger Compile-Time Insights" translate="no">â€‹</a></h3>
<p>Pikkuâ€™s CLI extracts type information at compile time. This approach lets you:</p>
<ul>
<li class="">Automatically generate <a href="https://www.openapis.org/" target="_blank" rel="noopener noreferrer" class="">OpenAPI</a> documentation from your TypeScript definitions.</li>
<li class="">Create typed clients that can be shared with frontends, ensuring zero-maintenance API contracts.</li>
<li class="">Reduce runtime overhead and catch schema errors before hitting production.</li>
</ul>
<p>For example, define your inputs and outputs inline:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> updateBirthday </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> userId</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">;</span><span class="token generic-function generic class-name"> birthday</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">number</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> success</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">boolean</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Implementation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Pikku will automatically generate <code>UpdateBirthdayInput</code> and <code>UpdateBirthdayOutput</code> typesâ€”no decorators or repetitive schema definitions required.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="dropping-the-dead-weight">Dropping the Dead Weight<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#dropping-the-dead-weight" class="hash-link" aria-label="Direct link to Dropping the Dead Weight" title="Direct link to Dropping the Dead Weight" translate="no">â€‹</a></h2>
<p>To move faster and focus on what matters, weâ€™ve made some clean breaks:</p>
<ul>
<li class=""><strong>CommonJS Support:</strong> Removed in favor of ESM.</li>
<li class=""><strong>Next.js Pages:</strong> Temporarily dropped to maintain a cleaner separation of concerns.</li>
<li class=""><strong>Embedded Inline Functions:</strong> Streamlined out for now to simplify the code-generation process.</li>
</ul>
<p>By shedding these complexities, Pikku stays lean, modern, and more maintainable going forward.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-greener-future-measuring-impact-and-carbon-offsets">A Greener Future: Measuring Impact and Carbon Offsets<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#a-greener-future-measuring-impact-and-carbon-offsets" class="hash-link" aria-label="Direct link to A Greener Future: Measuring Impact and Carbon Offsets" title="Direct link to A Greener Future: Measuring Impact and Carbon Offsets" translate="no">â€‹</a></h2>
<p>As infrastructure choices multiply, understanding their environmental impact becomes more important. Pikkuâ€™s flexibility makes it easier to experiment with different runtimes, servers, and deployment optionsâ€”be it on VMs, containers, or serverless. By observing how these choices affect <strong>CPU cycles and memory consumption</strong>, you can get a clearer picture of the carbon footprint associated with your applicationâ€™s workload.</p>
<p>Weâ€™re excited about the idea of using Pikku as a platform to help companies make environmentally informed decisions. Imagine comparing resource usage and emissions across deployments and automatically suggesting lower-impact configurations. While this is still in the concept stage, itâ€™s a direction weâ€™re exploring to align performance optimization with environmental responsibility.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="lets-collaborate">Letâ€™s Collaborate!<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#lets-collaborate" class="hash-link" aria-label="Direct link to Letâ€™s Collaborate!" title="Direct link to Letâ€™s Collaborate!" translate="no">â€‹</a></h2>
<p>Iâ€™m always excited to take on new projects and challenges, whether theyâ€™re about optimizing infrastructure, improving developer experiences, building real-time applications, or exploring innovative backend solutions. If you have a problem to solve, a product to scale, or an idea to bring to life, letâ€™s chat.</p>
<p><strong>How I can help:</strong></p>
<ul>
<li class="">Consulting on <strong>serverless transformations</strong>, <strong>real-time systems</strong>, and <strong>cloud infrastructure</strong>.</li>
<li class="">Building robust and scalable backend systems, tailored to your needs.</li>
<li class="">Exploring <strong>sustainable tech solutions</strong> to align with your environmental goals.</li>
</ul>
<p>Feel free to <a href="mailto:yasser.fadl@vlandor.com" target="_blank" rel="noopener noreferrer" class="">get in touch</a> or connect on <a href="https://github.com/pikkujs/pikku" target="_blank" rel="noopener noreferrer" class="">GitHub</a> to discuss your ideas or projects.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="get-involved">Get Involved<a href="https://pikku.dev/blog/2024/12/13/pikku-0.6#get-involved" class="hash-link" aria-label="Direct link to Get Involved" title="Direct link to Get Involved" translate="no">â€‹</a></h2>
<p>Try Pikku 0.6 today. Set up a scheduled task on serverless infrastructure, implement a fully typed WebSocket channel, or leverage compile-time type extraction for your next project. Check out the <a href="https://github.com/pikkujs/pikku" target="_blank" rel="noopener noreferrer" class="">docs</a>, open an issue, or join the discussion on <a href="https://github.com/pikkujs/pikku/discussions" target="_blank" rel="noopener noreferrer" class="">GitHub</a>.</p>
<p><a href="https://pikku.dev/docs/intro" target="_blank" rel="noopener noreferrer" class=""><strong>Get Started with Pikku 0.6</strong></a></p>
<p><a class="" href="https://pikku.dev/blog/2024/12/13/pikku-0.6"><strong>Read the in depth blog post</strong></a></p>
<p>Weâ€™re excited to hear your feedback and see what youâ€™ll build. Letâ€™s shape the future of flexible, typed, and environmentally conscious backend development together.</p>
<p><strong>Happy hacking!</strong></p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Announcing Pikku 0.5: Next.js Integration, HTTP Client, and OpenAPI Docs]]></title>
        <id>https://pikku.dev/blog/2024/10/31/pikku-0.5</id>
        <link href="https://pikku.dev/blog/2024/10/31/pikku-0.5"/>
        <updated>2024-10-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Explore the latest features in Pikku 0.5, including NextJS integration, a new HTTP client, and OpenAPI documentation.]]></summary>
        <content type="html"><![CDATA[<p>It's been a month since our last release (with version 0.4 serving as a test), and we're excited to share the many changes and improvements in Pikku 0.5!</p>
<p>Before diving into the new features, let's briefly reintroduce Pikku.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="pikku-reintroduction">Pikku (Re)Introduction<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#pikku-reintroduction" class="hash-link" aria-label="Direct link to Pikku (Re)Introduction" title="Direct link to Pikku (Re)Introduction" translate="no">â€‹</a></h2>
<p>Pikku is a lightweight, TypeScript-powered framework that focuses on normalizing all the different ways you can interact with Node.js servers today.</p>
<p>At the core of Pikku is the <code>pikkuFunc</code>. This function interacts with services created at server start-up (and some that are unique to a session). It handles the data it was invoked withâ€”without needing to know whether it came from params, query, or bodyâ€”and accesses the user session if the route is authenticated. Think of it like a multi-tool that simplifies handling different types of data sources, so you don't have to worry about where the data is coming from, how to authenticate or permission against it, or if it's valid â€” Pikku takes care of all that for you.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> updateTodo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">UpdateTodo</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#00009f">void</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> todoId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">data </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kysely</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateTable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'app.todo'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lastUpdatedBy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'todoId'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'='</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> todoId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeTakeFirstOrThrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>And you wire that up to a route:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">addRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// The method type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'patch'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// The method route</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/todo/:todoId'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// The function to call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> updateTodo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// The permissions to check before calling the function (supports both and ors)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isTodoCreator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">isTodoCreator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> withinAPILimits</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isAdmin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Whether the route needs a session</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  auth</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Info to use when generating OpenAPI docs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  docs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    errors</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NotFoundError</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Updates a todo'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'todos'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Run <code>npx @pikku/cli</code>, and that's about it!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="new-features">New Features<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#new-features" class="hash-link" aria-label="Direct link to New Features" title="Direct link to New Features" translate="no">â€‹</a></h2>
<p>In version 0.3, we started exploring static TypeScript inspection to improve the developer experience. This means we've gone from specifying schemas as strings to letting the CLI extract useful information about the endpoints, such as parameters, request and response types, and authentication requirements, ultimately allowing us to design better tools to make developers' lives easier.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="nextjs-integration">Next.js Integration<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#nextjs-integration" class="hash-link" aria-label="Direct link to Next.js Integration" title="Direct link to Next.js Integration" translate="no">â€‹</a></h3>
<p>This feature is especially exciting because it enables seamless integration with Next.js, allowing developers to easily use their backend functions for SSR without the need for a separate server. This will be its own blog one day, but having backend and frontend code separate (even if in the same process) just smells less in our opinion.</p>
<p>By running <code>@pikku/cli next</code> and specifying a <code>nextBackendFile</code>, we can now directly interact with our server routesâ€”fully typedâ€”without needing to run a separate server. This integration simplifies server-side rendering (SSR) and API use cases in Next.js applications.</p>
<p>Deploying Pikku with Next.js allows for code separation benefits without running a separate server. This means you can directly interact with your backend functions while using Next.js for SSR or API deployments.</p>
<p><img decoding="async" loading="lazy" alt="NextJS Coding" src="https://pikku.dev/assets/images/nextjs-coding-9f8dfa7d1d924249b9813b189166c3ef.gif" width="879" height="471" class="img_ev3q"></p>
<p>Since Pikku can be deployed in most Node.js frameworks (currently supporting uWS, Fastify, Express, and Nest), you can also deploy your API server separately elsewhere. Goodbye tightly coupling your backend code with your frontend!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fetch--http-client">Fetch / HTTP Client<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#fetch--http-client" class="hash-link" aria-label="Direct link to Fetch / HTTP Client" title="Direct link to Fetch / HTTP Client" translate="no">â€‹</a></h3>
<p>There are several ways we could implement an HTTP client. One approach is to create an SDK, but we prefer to avoid generating unnecessary code. Fewer generated files mean less code to test and maintainâ€”a win-win!</p>
<p>So, we've introduced <code>@pikku/fetch</code>, a tiny wrapper around <code>fetch</code> that validates API calls, ensuring you provide the required data and return the correct response.</p>
<p><img decoding="async" loading="lazy" alt="Pikku Client" src="https://pikku.dev/assets/images/fetch-55a7d8e68d3990944e088cd872fef532.gif" width="1128" height="470" class="img_ev3q"></p>
<p><code>@pikku/fetch</code> comes with a <code>PikkuClient</code> class containing two methods:</p>
<ul>
<li class=""><strong>api</strong>: Performs a fetch and returns the parsed data.</li>
<li class=""><strong>fetch</strong>: Performs a fetch and returns the response.</li>
</ul>
<p>All the typed goodness within just two methods.</p>
<p>By running <code>@pikku/cli next</code> and specifying a <code>fetchFile</code> option, you can automatically generate a wrapper that integrates directly with your backend routes!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="openapi-documentation">OpenAPI Documentation<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#openapi-documentation" class="hash-link" aria-label="Direct link to OpenAPI Documentation" title="Direct link to OpenAPI Documentation" translate="no">â€‹</a></h3>
<p>We now generate OpenAPI docs for all server routes. This feature is still a proof of concept (POC), but it can produce .yml or .json files adhering to the OpenAPI specification. It determines the contents of the params, query, and body, generating the correct input/output types for your APIs. For an example of the generated output, see our <a class="" href="https://pikku.dev/docs/wiring/http/openapi">OpenAPI</a> documentation guide, which provides more details and sample files.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="middleware-express-wrapper--fastify-plugin--uws-handler">Middleware Express Wrapper / Fastify Plugin / uWS Handler<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#middleware-express-wrapper--fastify-plugin--uws-handler" class="hash-link" aria-label="Direct link to Middleware Express Wrapper / Fastify Plugin / uWS Handler" title="Direct link to Middleware Express Wrapper / Fastify Plugin / uWS Handler" translate="no">â€‹</a></h3>
<p>We realized early on that creating a normalization layer for every aspect of a server would be overly complex, so we took a step back on setting up CORS and file uploads in our server implementations.</p>
<p>We believe adoption is more likely if developers can integrate Pikku into existing servers, without needing to run multiple servers concurrently. For example, a team maintaining an existing Express server can easily add Pikku logic without overhauling their entire infrastructure, making it possible to incrementally adopt Pikku while maintaining stability.</p>
<p>As such, we now have <code>@pikku/express-middleware</code>, <code>@pikku/fastify-plugin</code>, and <code>@pikku/uws-handler</code> to add Pikku logic to your servers.</p>
<p>You can still run Pikku directly using the servers provided by <code>@pikku/express</code>, <code>@pikku/fastify</code>, and <code>@pikku/uws</code>, but only if you just need to run your API endpoints without any extra server configuration.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pikku-bootstrap-file">Pikku Bootstrap File<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#pikku-bootstrap-file" class="hash-link" aria-label="Direct link to Pikku Bootstrap File" title="Direct link to Pikku Bootstrap File" translate="no">â€‹</a></h3>
<p>The Pikku bootstrap file is the only generated file that needs to be imported. It loads all the required routes and schemas.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="es6-modules">ES6 Modules<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#es6-modules" class="hash-link" aria-label="Direct link to ES6 Modules" title="Direct link to ES6 Modules" translate="no">â€‹</a></h3>
<p>Pikku is now exported using both module and CommonJS formats, as this ensures compatibility with a wide range of JavaScript environments. Supporting both formats allows developers to use Pikku regardless of whether their projects are using modern ES modules or traditional CommonJS, providing greater flexibility.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pikkudev-domain">Pikku.dev Domain<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#pikkudev-domain" class="hash-link" aria-label="Direct link to Pikku.dev Domain" title="Direct link to Pikku.dev Domain" translate="no">â€‹</a></h3>
<p>We have rebranded to <code>pikku.dev</code> instead of <code>pikku.io</code> due to the <a href="https://tamouse.github.io/blog/politics/2019/10/02/why-is-the-io-domain-problematic.html" target="_blank" rel="noopener noreferrer" class="">problematic nature</a> of the <code>.io</code> top-level domain. Additionally, <code>.dev</code> just feels more appropriate for our audience.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="three-template-repos">Three Template Repos<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#three-template-repos" class="hash-link" aria-label="Direct link to Three Template Repos" title="Direct link to Three Template Repos" translate="no">â€‹</a></h3>
<p>We now have <a href="https://github.com/pikku/express-middleware-starter" target="_blank" rel="noopener noreferrer" class="">express-middleware</a>, <a href="https://github.com/pikku/nextjs-app-starter" target="_blank" rel="noopener noreferrer" class="">nextjs-app</a>, and <a href="https://github.com/pikku/workspace-starter" target="_blank" rel="noopener noreferrer" class="">workspace-starter</a> template repos.</p>
<p>My personal favorite is the workspace repo using Yarn workspaces, but they all work well!</p>
<p>The workspace repo also has some Docker files that run in CI to ensure everything works as expected.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="summary">Summary<a href="https://pikku.dev/blog/2024/10/31/pikku-0.5#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary" translate="no">â€‹</a></h2>
<p>That concludes our update!</p>
<p>The three main components left on the roadmap are:</p>
<ol>
<li class="">Cron job scheduling.</li>
<li class="">Event source triggering.</li>
<li class="">Real-time/stream services.</li>
</ol>
<p>We're also looking forward to seeing how many places we can deploy Pikku! Edge, Cloudflare, Bun, Deno. The list goes on!</p>
<p>Thanks for reading!</p>
<p>We invite you to explore Pikku 0.5, try out the new features, and share your feedback. Your contributions help us make Pikku better for everyone!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Announcing Pikku 0.3]]></title>
        <id>https://pikku.dev/blog/2024/10/01/pikku-0.3</id>
        <link href="https://pikku.dev/blog/2024/10/01/pikku-0.3"/>
        <updated>2024-10-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A deeper dive into how Pikku registers routes]]></summary>
        <content type="html"><![CDATA[<p>I'm thrilled to announce Pikku version 0.3!</p>
<p>This update comes shortly after version 0.2 and focuses primarily on improving the developer experience. It introduces better API validation and reduces boilerplate, making it easier and more intuitive to build powerful APIs.</p>
<p>In a previous blog post, I mentioned my recent discovery of <a href="https://encore.dev/" target="_blank" rel="noopener noreferrer" class="">Encore.ts</a>. It was both validating and a little intimidating to see the similarities between our frameworks. Encore.ts has plenty of benefits, such as built-in infrastructure setup, a server written in RustJS that offers major performance gains, and the ability to automatically split repositories into microservices.</p>
<p>In terms of where Pikku fits, I believe it lives somewhere between NestJS and Encore. Pikku requires less boilerplate than NestJS while still allowing developers to leverage existing open-source NodeJS libraries like uWS, Fastify, or Express. It can also be used in dispatch patterns with Next.js and similar frameworks.</p>
<p>Personally, I like having the ability to control my infrastructure with a declarative language like Terraform. I recognize that this is a matter of preference, and I understand the value of Encore.ts as a fully integrated solution. However, the goal of Pikku is to focus on one core taskâ€”API routing and HTTP documentationâ€”and leave the rest to the user's preferences.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-changed">What Changed<a href="https://pikku.dev/blog/2024/10/01/pikku-0.3#what-changed" class="hash-link" aria-label="Direct link to What Changed" title="Direct link to What Changed" translate="no">â€‹</a></h2>
<p>TypeScript offers some powerful features that can be used to improve the developer experience beyond just type safety (as demonstrated by <a href="https://kysely.dev/" target="_blank" rel="noopener noreferrer" class="">Kysely</a>, my preferred SQL query builder).</p>
<p>With Pikku, we've leaned into TypeScript's compiler capabilities to automatically extract key information, which means we benefit from both stronger static type checking at compile time and improved runtime validation.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="improved-api-developer-experience">Improved API Developer Experience<a href="https://pikku.dev/blog/2024/10/01/pikku-0.3#improved-api-developer-experience" class="hash-link" aria-label="Direct link to Improved API Developer Experience" title="Direct link to Improved API Developer Experience" translate="no">â€‹</a></h3>
<p>In Pikku 0.2 and earlier, defining a route looked like this:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> routes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'post'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/blog/:blogId/comment'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'AddCommentToBlog'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> addCommentToBlog</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      canCommentOnBlog</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>The primary issue with this approach was that developers had to manually specify the <code>schema</code> property for validation.</p>
<p>In Pikku 0.3+, we now use the following API:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> addRoute </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./api'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">addRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'post'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/blog/:blogId/comment'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> addCommentToBlog</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      canCommentOnBlog</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>This approach allows us to leverage more advanced TypeScript validation:</p>
<ul>
<li class="">The <code>AddCommentToBlog</code> schema is automatically inferred from the function's generic parameters.</li>
<li class="">The <code>blogId</code> parameter must exist within <code>AddCommentToBlog</code>.</li>
<li class="">The <code>query</code> property is an array of fields in <code>AddCommentToBlog</code>, used for documentation purposes.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="api-interfaces">API Interfaces<a href="https://pikku.dev/blog/2024/10/01/pikku-0.3#api-interfaces" class="hash-link" aria-label="Direct link to API Interfaces" title="Direct link to API Interfaces" translate="no">â€‹</a></h3>
<p>Pikku now also generates an API interface, which can be used to apply type definitions in dispatchers like Next.js and other frameworks:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">RoutesInterface</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/books'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'post'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Books </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/book'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'post'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CreateBook</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Book </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/book/:id'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'get'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> JustBookId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Book </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/book/:id'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'patch'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Book </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/book/:id'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'delete'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> JustBookId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>This helps developers enforce consistency in API definitions and improves type safety across different parts of the application.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="addressing-the-contradiction-in-the-02-blog">Addressing the Contradiction in the 0.2 Blog<a href="https://pikku.dev/blog/2024/10/01/pikku-0.3#addressing-the-contradiction-in-the-02-blog" class="hash-link" aria-label="Direct link to Addressing the Contradiction in the 0.2 Blog" title="Direct link to Addressing the Contradiction in the 0.2 Blog" translate="no">â€‹</a></h2>
<p>In the 0.2 blog post, I wrote:</p>
<blockquote>
<p>Pikku avoids the "magic" often found in other frameworks, where hidden processes can make debugging challenging. By providing explicit and transparent code structures, you gain full control over your application's behavior.</p>
</blockquote>
<p>This statement reflects my dislike of using global state in codebases, especially singleton states, which conflicts with some popular Node.js frameworks.</p>
<p>Previously, we had developers export a <code>routes</code> array, which would then be concatenated during the build process. This allowed developers to split routes into different files and choose which routes to run by importing them selectivelyâ€”a pattern often used when deploying microservices.</p>
<p>However, this approach made TypeScript validation difficult. While exporting routes is still a common pattern in Node.js, it could become confusing as a long-term API decision. In Pikku 0.3, we've switched to using the <code>addRoute</code> method, which allows for direct registration of routes, better validation, and a more cohesive developer experience.</p>
<hr>
<p>I'm excited for you to try out Pikku 0.3 and see the improvements firsthand. The focus on reducing boilerplate, enhancing validation, and making APIs easier to work with is all aimed at making your development process smoother.</p>
<p>Let me know what you think! Are there features you'd like to see in future versions? Your feedback is always appreciated.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Announcing Pikku 0.2]]></title>
        <id>https://pikku.dev/blog/2024/09/21/pikku-0.2</id>
        <link href="https://pikku.dev/blog/2024/09/21/pikku-0.2"/>
        <updated>2024-09-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Discover how Pikku 0.2 transforms HTTP request handling in Node.js with new features, enhanced TypeScript support, and seamless integration with popular frameworks like Fastify, uWS, and Next.js.]]></summary>
        <content type="html"><![CDATA[<p>We are thrilled to announce the release of <strong>pikku 0.2</strong>!</p>
<p>For the past few years, pikku has been quietly powering bespoke projects as a submodule. With version 0.2, we're transforming it into a fully-fledged set of libraries designed to streamline your development experience.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="whats-new-in-pikku-02">What's New in Pikku 0.2?<a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#whats-new-in-pikku-02" class="hash-link" aria-label="Direct link to What's New in Pikku 0.2?" title="Direct link to What's New in Pikku 0.2?" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="supported-frameworks-currently-in-testing">Supported Frameworks (Currently in Testing)<a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#supported-frameworks-currently-in-testing" class="hash-link" aria-label="Direct link to Supported Frameworks (Currently in Testing)" title="Direct link to Supported Frameworks (Currently in Testing)" translate="no">â€‹</a></h3>
<ul>
<li class=""><strong>Fastify</strong></li>
<li class=""><strong>uWebSockets.js (uWS)</strong></li>
<li class=""><strong>Next.js</strong></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="development-enhancements">Development Enhancements<a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#development-enhancements" class="hash-link" aria-label="Direct link to Development Enhancements" title="Direct link to Development Enhancements" translate="no">â€‹</a></h3>
<ul>
<li class=""><strong>Comprehensive Documentation</strong>: We've added detailed guides to help you get started quickly.</li>
<li class=""><strong>CLI Tool for Schema and Route Generation</strong>: Automate your workflow with our new command-line interface.</li>
<li class=""><strong>Configuration File (<code>pikku.config.json</code>)</strong>: Easily customize pikku to suit your project's needs.</li>
<li class=""><strong>Robust Testing Suite</strong>: More tests for extra reliability.</li>
<li class=""><strong>Universal <code>fetch</code> Method</strong>: Call pikku from any framework seamlessly.</li>
<li class=""><strong><code>PikkuRequest</code> and <code>PikkuResponse</code> Wrappers</strong>: Compatibility with most Node.js HTTP libraries.</li>
<li class=""><strong>TypeScript Improvements</strong>: Enjoy a smoother development experience with enhanced TypeScript support.</li>
<li class=""><strong>Starter Workspace</strong>: Check out our <a href="https://github.com/pikku/workspace-starter" target="_blank" rel="noopener noreferrer" class="">example workspace</a> with everything set up.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-pikku">What Is Pikku?<a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#what-is-pikku" class="hash-link" aria-label="Direct link to What Is Pikku?" title="Direct link to What Is Pikku?" translate="no">â€‹</a></h2>
<p>Pikku is a lightweight abstraction layer between HTTP requests and your code. It allows you to focus on the core logic without worrying about the underlying HTTP mechanics. Simply put, it's all about data in, data out, and error handlingâ€”nothing more.</p>
<p><strong>Request Handling Workflow:</strong></p>
<ol>
<li class="">
<p><strong>Route Validation</strong>:<br>
<em>Does the route exist?</em><br>
<strong>No?</strong> Return <strong>404 Not Found</strong>.</p>
</li>
<li class="">
<p><strong>Data Validation</strong>:<br>
<em>Is the input data valid?</em><br>
<strong>No?</strong> Return <strong>400 Bad Request</strong>.</p>
</li>
<li class="">
<p><strong>Session Management</strong>:<br>
<em>Is a session required and present?</em><br>
<strong>No?</strong> Return <strong>401 Unauthorized</strong>.</p>
</li>
<li class="">
<p><strong>Permission Checks</strong>:<br>
<em>Does the user have the necessary permissions?</em><br>
<strong>No?</strong> Return <strong>403 Forbidden</strong>.</p>
</li>
<li class="">
<p><strong>Method Execution</strong>:<br>
<em>Did the method execute successfully?</em><br>
<strong>No?</strong> Map the error to the appropriate HTTP status code.</p>
</li>
<li class="">
<p><strong>Response Delivery</strong>:<br>
<!-- -->Send the response back to the client.</p>
</li>
</ol>
<p><strong>Example Code:</strong></p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> route</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pikkuFunc </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'../pikku-types'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> createTodo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">CreateTodo</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> JustTodoId</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kysely</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insertInto</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'app.todo'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      createdBy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">returning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'todoId'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeTakeFirstOrThrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> routes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'post'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/todo'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CreateTodo'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> createTodo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    permissions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      isUser</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>With pikku, you can effortlessly integrate with servers like Express, Fastify, or uWS, and even invoke functions directly within frameworks like Next.js or NestJS.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-choose-pikku-over-nestjs-trpc-or-encore">Why Choose Pikku Over NestJS, tRPC, or Encore?<a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#why-choose-pikku-over-nestjs-trpc-or-encore" class="hash-link" aria-label="Direct link to Why Choose Pikku Over NestJS, tRPC, or Encore?" title="Direct link to Why Choose Pikku Over NestJS, tRPC, or Encore?" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="less-magic-more-control"><strong>Less Magic, More Control</strong><a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#less-magic-more-control" class="hash-link" aria-label="Direct link to less-magic-more-control" title="Direct link to less-magic-more-control" translate="no">â€‹</a></h3>
<p>Pikku avoids the "magic" often found in other frameworks, where hidden processes can make debugging challenging. By providing explicit and transparent code structures, you gain full control over your application's behavior.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="lightweight-and-open-source"><strong>Lightweight and Open Source</strong><a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#lightweight-and-open-source" class="hash-link" aria-label="Direct link to lightweight-and-open-source" title="Direct link to lightweight-and-open-source" translate="no">â€‹</a></h3>
<p>Written entirely in TypeScript and open-sourced under the MIT license, pikku is minimalistic yet powerful. Its lean codebase makes it accessible for debugging and community contributions.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="infrastructure-agnostic"><strong>Infrastructure Agnostic</strong><a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#infrastructure-agnostic" class="hash-link" aria-label="Direct link to infrastructure-agnostic" title="Direct link to infrastructure-agnostic" translate="no">â€‹</a></h3>
<p>Unlike frameworks that lock you into specific infrastructure providers, pikku is flexible. You can choose any services or databases you prefer, whether it's AWS, Google Cloud, Backblaze, or a database of your choice.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="plain-typescript-usage"><strong>Plain TypeScript Usage</strong><a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#plain-typescript-usage" class="hash-link" aria-label="Direct link to plain-typescript-usage" title="Direct link to plain-typescript-usage" translate="no">â€‹</a></h3>
<p>Embrace the simplicity of plain TypeScript. Define services as regular classes and functions that receive services, data, and user sessionsâ€”no decorators or special syntax required.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="flexible-deployment"><strong>Flexible Deployment</strong><a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#flexible-deployment" class="hash-link" aria-label="Direct link to flexible-deployment" title="Direct link to flexible-deployment" translate="no">â€‹</a></h3>
<p>Deploy pikku in a way that suits you:</p>
<ul>
<li class="">Integrate with Express, Fastify, or uWS.</li>
<li class="">Use it directly within Next.js.</li>
<li class="">Plan for future support of gRPC and WebSocket protocols based on community interest.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="get-started-today">Get Started Today!<a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#get-started-today" class="hash-link" aria-label="Direct link to Get Started Today!" title="Direct link to Get Started Today!" translate="no">â€‹</a></h2>
<p>Explore the <a href="https://github.com/pikku/workspace-starter" target="_blank" rel="noopener noreferrer" class="">example workspace</a> to see pikku in action. We're excited to see how you leverage pikku 0.2 in your projects.</p>
<hr>
<blockquote>
<p><strong>Note:</strong> Pikku 0.2 is still a work in progress. While it has been used in multiple production environments, the latest changes are undergoing thorough testing. We invite the community to try it out and share feedback!</p>
</blockquote>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="about-me">About Me<a href="https://pikku.dev/blog/2024/09/21/pikku-0.2#about-me" class="hash-link" aria-label="Direct link to About Me" title="Direct link to About Me" translate="no">â€‹</a></h2>
<p>I'm currently contracting remotely with a strong background in Node.js, React, Terraform, AWS, real-time technologies, CI/CD, and the broader JavaScript ecosystem. If you're looking for expertise on your next project, feel free to reach out at <a href="mailto:yasser.fadl@vlandor.com" target="_blank" rel="noopener noreferrer" class="">yasser.fadl@vlandor.com</a>.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Why I haven't used nestJS]]></title>
        <id>https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs</id>
        <link href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs"/>
        <updated>2022-02-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A very high level / personal comparison between the two frameworks]]></summary>
        <content type="html"><![CDATA[<p>Before I begin, today is 20220222 as an ISO date. I had to blog something!</p>
<p>This article aims to explain why I went with writing Pikku instead of using nestJS. It's mostly for my sanity; since I just took a few months off of development and after returning wondered why I decided to create my own solution ðŸ˜….</p>
<p>So the nestJS philosophy verbatim is:</p>
<p>In recent years, thanks to Node.js, JavaScript has become the "lingua franca" of the web for both front and backend applications. This has given rise to awesome projects like Angular, React and Vue, which improve developer productivity and enable the creation of fast, testable, and extensible frontend applications. However, while plenty of superb libraries, helpers, and tools exist for Node (and server-side JavaScript), none of them effectively solve the main problem of - Architecture.</p>
<p>Nest provides an out-of-the-box application architecture which allows developers and teams to create highly testable, scalable, loosely coupled, and easily maintainable applications. The architecture is heavily inspired by Angular.</p>
<p>And having worked on (large) projects directly using express/other HTTP servers, I have to admit the Architectural benefits it provides significantly helps sort out the developer landscape.</p>
<p>So, why didn't I go with nestJS?</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="deployment-options">Deployment options<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#deployment-options" class="hash-link" aria-label="Direct link to Deployment options" title="Direct link to Deployment options" translate="no">â€‹</a></h3>
<p>My first requirement was to build something that can deploy to functionless servers without including the entire HTTP-server stack across with it. Projects like <a href="https://github.com/vendia/serverless-express" target="_blank" rel="noopener noreferrer" class="">serverless-express</a> and <a href="https://docs.nestjs.com/faq/serverless" target="_blank" rel="noopener noreferrer" class="">guides on how to do it with nest</a> exist, but the issue remains that it provides a lot of code bloat to get it working (resulting in increased runtime and costs per invocation). Serverless functions aren't for everyone, especially with their random latency and warm-up times. But at the end of the day, the cost-benefit can work in your favour, especially if you factor in all the extra monitoring required to scale docker/ec2 machines/non-functional services or services that barely ever compute anything.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="decorators">Decorators<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#decorators" class="hash-link" aria-label="Direct link to Decorators" title="Direct link to Decorators" translate="no">â€‹</a></h3>
<p>Certainly a pet peeve, but the fact both Angular and NestJS are relying so heavily on decorators <a href="https://github.com/tc39/proposal-decorators" target="_blank" rel="noopener noreferrer" class="">a language feature that hasn't yet passed stage 2</a> didn't boost my confidence levels (especially when I first wrote it two years ago). Stage two means it's most likely going to be included in the final spec, so this no longer matters as much.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="angular-inspiration--services-injection">Angular inspiration / Services Injection<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#angular-inspiration--services-injection" class="hash-link" aria-label="Direct link to Angular inspiration / Services Injection" title="Direct link to Angular inspiration / Services Injection" translate="no">â€‹</a></h3>
<p>Now I have been lucky enough to work on dependency injection mechanisms in frontend javascript applications back when XML was still favoured over JSON. And the benefits are great; you get to inject different services depending on whether you're running a test, developing locally, running in the cloud, deploying in an enterprise setting. Generally, having the option to mix and match your 'runtime' requirements is excellent. But the amount of code and decorators and magic required to get it working is sometimes just really hard to wrap your head around. I'm currently working on a project where they are moving from PHP to nestJS, and the number of files used as a scaffold was pretty intense, mainly because they don't even have more than one type of service or interface to exchange.</p>
<p>So I guess my point is, rather than having to do <a href="https://docs.nestjs.com/providers" target="_blank" rel="noopener noreferrer" class="">this</a>:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="nestjs">nestJS<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#nestjs" class="hash-link" aria-label="Direct link to nestJS" title="Direct link to nestJS" translate="no">â€‹</a></h4>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Injectable </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@nestjs/common'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Cat </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./interfaces/cat.interface'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Injectable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">CatsService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> cats</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Cat</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cat</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Cat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cats</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Cat</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cats</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Controller</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Controller</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Get</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Post</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Body </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@nestjs/common'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> CreateCatDto </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./dto/create-cat.dto'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> CatsService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./cats.service'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Cat </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./interfaces/cat.interface'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Controller</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'cats'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">CatsController</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> catsService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CatsService</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Body</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> createCatDto</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CreateCatDto</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catsService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">createCatDto</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Cat</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catsService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Application Glue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Module </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@nestjs/common'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> CatsController </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./cats/cats.controller'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> CatsService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./cats/cats.service'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Module</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  controllers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CatsController</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  providers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CatsService</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">AppModule</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>I find it a little easier to do <a href="https://pikku.io/code/" target="_blank" rel="noopener noreferrer" class="">this</a>:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="pikku">Pikku<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#pikku" class="hash-link" aria-label="Direct link to Pikku" title="Direct link to Pikku" translate="no">â€‹</a></h4>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Cat </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./interfaces/cat.interface'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">CatsService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> cats</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Cat</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cat</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Cat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cats</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Cat</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Controller</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> routes</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> APIRoutes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'post'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'v1/cats'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cats</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schema</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CreateCat'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'get'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  route</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'v1/cats'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Normally we don't inline functions but it would make it more minimal.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">func</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cats</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">findAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schema</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'GetCat'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Application Glue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> setupServices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Services</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Services Setup'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">LoggerService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cats</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CatsService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>I know that's quite a bit of code, apologies for that. However, the main point I'm trying to get across is that, at least for my coding style and ADD, having very explicit/normal functions makes more sense.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="seperating-http-from-logic">Seperating HTTP from Logic<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#seperating-http-from-logic" class="hash-link" aria-label="Direct link to Seperating HTTP from Logic" title="Direct link to Seperating HTTP from Logic" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="data">Data<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#data" class="hash-link" aria-label="Direct link to Data" title="Direct link to Data" translate="no">â€‹</a></h4>
<p>Okay, so in the examples above, we can see the recommended way in which nestJS lays out its code. You have a controller that the HTTP command gets routed to, and it then parses the required data and passes it onto a service, which tends to be HTTP agnostic.</p>
<p>And that makes a ton of sense; you want to try and keep your HTTP behaviour as far as you can from your domain logic. Because maybe you'll move to WebSockets at some point, or HTTP5 will come out and redefine the world (insert tron code editing gif here). Or, more likely, you want to introduce a breaking HTTP API change and don't want to put the backwards compatibility into your domain layer.</p>
<p>It's pretty hard to argue with the above. In many ways, you can say nestJS is more potent than Pikku because it allows you to directly interact with HTTP requests within the controller. But I guess that's where I wanted to draw my line. I tried to push all the HTTP logic entirely out of the codebase and only specify the REST type and route for each HTTP API to get the data passed on.</p>
<p>And why did I do that? Mostly because I never really had exposure to any API that required different behaviour over the last few years. Some APIs are XML, others are in text, some use a binary protocol, and most are JSON. But at the end of the day, almost any function pretty much follows the following rules:</p>
<ul>
<li class="">might expect some data</li>
<li class="">might respond with some data</li>
<li class="">might throw an error if something doesn't quite work out okay</li>
<li class="">might do something with or without data</li>
</ul>
<p>So rather than specifying things like:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Body</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> createCatDto</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CreateCatDto</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catsService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">createCatDto</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>I instead make the following assumption. If I receive any data, it will follow the next set of rules:</p>
<ol>
<li class="">Get query parameter data</li>
<li class="">Get path parameter data</li>
<li class="">Get body data</li>
<li class="">Merge them all</li>
<li class="">Provide them to the function</li>
</ol>
<p>Currently, there is a rule of precedence, which means it overwrites the values when merging. But it probably makes sense to add a validation rule to throw an error if the values don't match going forward to avoid odd API usage.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="errors">Errors<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#errors" class="hash-link" aria-label="Direct link to Errors" title="Direct link to Errors" translate="no">â€‹</a></h4>
<p>Errors following a similar thought pattern. In nestJS, it has a concept of a <a href="https://docs.nestjs.com/exception-filters" target="_blank" rel="noopener noreferrer" class="">HttpException</a>, which means if something goes wrong in your controller, you end up throwing an exception which is either HTTP based or extends an HTTP error. So if something happens in your HTTP agnostic service layer, you throw a standard JS error, which is then caught in your controller and translated to something HTTP based.</p>
<p>In Pikku, we again limit the flexibility of what an error can do. If you throw an Error, you usually want to provide a status code, a message, and a potential payload.</p>
<p>So it would look something like this:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> addErrors</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> EError </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@pikku/backend-common/src/errors'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">CatNotFoundError</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">EError</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This payload will be forwarded to the client if set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> payload</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructor</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bookId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> bookId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">addErrors</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CatNotFoundError</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> status</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">404</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'error.cat_not_found'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Is it significantly different? Not really. But it's less documentation and verbosity - no filters or decorators needed. The extends EError is a javascript issue to get around <code>instanceof</code> not working with node_modules. That was a painful discovery ðŸ˜‚.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="typescript">Typescript<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#typescript" class="hash-link" aria-label="Direct link to Typescript" title="Direct link to Typescript" translate="no">â€‹</a></h4>
<p>Pikku is tightly bound to typescript. It automatically creates JSON validation schemas from your data types. If you're using Postgres or MySQL, it can even directly link to your data schemas to enforce the data model. So there are no DTOs, which means you also lost some of the extra functionality it provides (like default values).</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="request-scoped-services">Request Scoped Services<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#request-scoped-services" class="hash-link" aria-label="Direct link to Request Scoped Services" title="Direct link to Request Scoped Services" translate="no">â€‹</a></h4>
<p>Honestly don't know if this is a thing you can do in nestJS or not. But in Pikku, you can lazy load services for each HTTP request.</p>
<p>A couple of example benefits in my projects:</p>
<ul>
<li class="">You can get any of the headers from the request via the HeaderService, which hides away HTTP requests (useful for stubbing in tests)</li>
<li class="">You can get a custom database service per request. That means if something fails, it would automatically roll back everything. Also, having session data set on a transaction makes audit logs a breeze. You can see this in <a href="https://www.npmjs.com/package/typed-postgres" target="_blank" rel="noopener noreferrer" class="">typed-postgres</a></li>
<li class="">You can prefix all logs for a request with a UUID for better traceability</li>
<li class="">Etc</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-good-stuff">The good stuff<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#the-good-stuff" class="hash-link" aria-label="Direct link to The good stuff" title="Direct link to The good stuff" translate="no">â€‹</a></h3>
<p>So I want to re-acknowledge that nestJS is a really powerful framework. If I didn't have a lot of time to kill during the first lockdown, plus wanting to understand the HTTP stack I'm working with (previously, I only ever used sockets, all the way back to long polling in IE6 ðŸ˜…).</p>
<p>Things that nestJS does that Pikku doesn't / is lacking:</p>
<ol>
<li class="">Documentation, conferences, community, almost 300 contributors</li>
<li class="">Lots of tests</li>
<li class="">Ability to tree shake depending on what services you inject</li>
<li class="">Documentation (This needs a second mention!)</li>
<li class="">The whole ecosystem of express and fastify (can be used in Pikku, but less likely on the developers' end).</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="summary">Summary<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary" translate="no">â€‹</a></h2>
<p>So yeah, I guess I convinced myself to keep using pikku and seeing how it goes ðŸ˜…ðŸ˜. If anyone reading this is interested, let me know. Happy to invest the time into writing better docs and example repos. It takes quite a bit of time, so I would instead focus on some of my projects in the meantime!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="shameless-plug">Shameless Plug<a href="https://pikku.dev/blog/2022/02/22/pikku-vs-nestjs#shameless-plug" class="hash-link" aria-label="Direct link to Shameless Plug" title="Direct link to Shameless Plug" translate="no">â€‹</a></h2>
<p>If you reached this part, thank you! I would love any form of feedback, whether I should use more kitten gifs or possibly less or more code examples.</p>
<p>I'm also currently contracting in the UK and have a strong background in nodeJS, react, terraform, AWS, real-time tech, CI and the general JS ecosystem. If you have a project you think I could help out with, feel free to contact me at <a href="mailto:yasser.fadl@vlandor.com" target="_blank" rel="noopener noreferrer" class="">yasser.fadl@vlandor.com</a>.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Service Lookup Continued]]></title>
        <id>https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud</id>
        <link href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud"/>
        <updated>2021-11-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A bit more detail as to why we use service lookups]]></summary>
        <content type="html"><![CDATA[<p>So I got some great feedback on hackernews on a couple of things and wanted to write a bit more of an opinion piece.</p>
<p>First, some commenters informed me that the term <code>service injection</code> is incorrect -  it should be <code>service lookup</code>. I will be updating the docs on the site accordingly!</p>
<p>So the first thing I need to clarify is that all functions receive a <code>service lookup</code> object that contains a list of all the different services you can use. Usually, the services include message queues, database, cache, and a selection of other things.</p>
<p>If you want to skip to my pro/cons, that's the last section!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="brief-history">Brief History<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#brief-history" class="hash-link" aria-label="Direct link to Brief History" title="Direct link to Brief History" translate="no">â€‹</a></h3>
<p>The first time I started using <code>service lookups</code> was in a frontend framework where the idea was that you could quickly develop components in the frontend vs stubbed or real services by just setting the environment. Doing so was incredibly important because it was a FinTech solution where we had to simulate lots of different states. We provided fake data to test results (connection status, prices, etc.) via workbench tools. Doing so allows us to avoid having to write stub backend services. Those would need to do the whole roundtrip through the server (which would have been a hassle, especially since our backend language selection was Java or C).</p>
<p>Then came the real-time node server <a href="https://deepstream.io/" target="_blank" rel="noopener noreferrer" class="">deepstream.io</a>. Deepstream is a super flexible real-time node server where you can swap out any of the subcomponents via a plugin architecture. You can use any cache (Redis/Memcache), database (Postgres/MongoDB), clustering mechanism (vertical scaling/Redis pub-sub), permissions layer (config based/function-based), protocol layer (WebSocket, uWS, MQTT, HTTP). Without using a form of interface, it would have been tough to connect all those systems. Having the services passed in made it much easier to allow different APIs to talk to each other.</p>
<p>Finally came deepstreamHub, the enterprise version of deepstream.io. deepstreamHub required us to allow things to run locally for enterprise machines and use AWS services for the cloud offering. We managed to get the entire thing running on Kubernetes and via local services in less than a day using service lookups.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pikku">Pikku<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#pikku" class="hash-link" aria-label="Direct link to Pikku" title="Direct link to Pikku" translate="no">â€‹</a></h3>
<p>I started working on personal projects after deepstreamHub, and I was doing so while travelling due to the failed startup misery recovery process. So my main requirement was that everything should work offline. I didn't want to deal with flaky connections, and to be honest, I was coding for fun, so constantly deploying wasn't the top of my requirements!</p>
<p>I also personally love the idea behind koa and other abstraction layers that remove the concept of HTTP from your core code.</p>
<p>I used that sort of approach for having the same API code being consumed by:</p>
<ol>
<li class="">using deepstream.io RPCs</li>
<li class="">using WebSocket connections as a mode of transport (similar to <a href="https://feathersjs.com/" target="_blank" rel="noopener noreferrer" class="">featherJS</a>)</li>
<li class="">HTTP</li>
</ol>
<p>Also, just having unit tests run without needing to load up express or mock out singletons is a nice benefit IMO</p>
<p>So developing locally, I use:</p>
<ol>
<li class="">A local secret store</li>
<li class="">A local Postgres</li>
<li class="">An empty email service</li>
<li class="">A local file service / uploader (express + reaper)</li>
</ol>
<p>And deploying on AWS, I use:</p>
<ol>
<li class="">AWS Secrets</li>
<li class="">AWS RDS Postgres</li>
<li class="">SES (although I'm moving to SendGrid)</li>
<li class="">AWS S3 + Cloudfront for private content</li>
</ol>
<p>When developing locally, the services are:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">SingletonServices</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secrets</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LocalSecretStore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> PostgresClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LocalEmailService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LocalContentService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Let's take a deeper dive into the ContentService interface:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ContentService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This signs the content key so that cloudfront can serve it (if private)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">signContentKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contentKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This returns the upload url required to upload the file, and the assetKey to usually save in the database</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">getUploadURL</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contentKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contentType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> uploadUrl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> assetKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>So what this does here is mimic the API required for uploading and sharing files in S3 and Cloudfront.</p>
<p>I use two different implementations, one for local development and one for AWS:</p>
<p>Locally I used reaper in express:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">signURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">url</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">?signed=true</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">signContentKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">assetKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">http://localhost:4002/assets/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">assetKey</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">?signed=true</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUploadURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">assetKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">going to upload with key: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">assetKey</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uploadUrl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">http://localhost:4002/v1/reaper/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">assetKey</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assetKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>And with AWS, I use AWS APIs:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">signURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getCDNSignedUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">signConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Error signing url: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">url</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUploadURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Key</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ContentType</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> command </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PutObjectCommand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bucket</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">content.</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation keyword" style="color:#00009f">this</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">config</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">domain</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ContentType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uploadUrl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getS3SignedUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">s3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> command</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expiresIn</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3600</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assetKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>And in any API, I can now do:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getSignedUrl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">SignFileUpload</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> SignFileUploadResult</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> content </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contentType </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generateKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> uploadUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> assetKey </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getUploadURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> contentType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uploadUrl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assetKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>If running locally, it would then live in a <code>.upload</code> directory on my dist. If running vs AWS, it would then live in the bucket. Same paths and everything. It can even go as far as to check if the content is <code>private access</code> or not for complete testing.</p>
<p>So now multiply this by the number of services used (as mentioned in pt1, we use notification services, salesforce, hologram, etc.).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="notes">Notes<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-not-just-use-the-cloud-its-the-actual-environment">Why not just use the cloud? It's the actual environment!<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#why-not-just-use-the-cloud-its-the-actual-environment" class="hash-link" aria-label="Direct link to Why not just use the cloud? It's the actual environment!" title="Direct link to Why not just use the cloud? It's the actual environment!" translate="no">â€‹</a></h4>
<p>So I get this point a lot when I talk to people about local vs cloud development. My <em>(personal)</em> opinion is that companies that spin-up entire AWS accounts for each developer are going at it wrong. I know that's a strong statement, and I don't mean offence. Conflicting opinions are what leads to so many exciting solutions!</p>
<p>The reason I think it's wrong is that:</p>
<ol>
<li class="">it's slow (to apply infra changes everywhere)</li>
<li class="">it's hard to decouple from those services if you ever decide to ship an enterprise edition or move to another cloud suddenly (like cloudflare if AWS costs are too insane)</li>
<li class="">it's pretty expensive</li>
<li class="">debugging is occasionally a pain compared to locally</li>
</ol>
<p>The main question I usually like to ask is: what benefit do you get out of it? In the case of <code>aws incognito</code>, I understand implementing user management is a pain. However, what's the downside of running rabbitMQ locally vs creating an SQS queue? Or not sending real-time notifications into the void? Or not uploading useless files inside of S3?</p>
<p>Is it possible we got a bit too excited about current settings and just ended up uploading our functions to serverless via hot deploy because we can? Or that docker and Kubernetes are so incredible that we run complex infrastructure locally to mimic production, regardless of the CPU/Memory overhead? Running my side projects on the side, I sure don't want to tell anyone who helps that I'll need to give them AWS access to add a few simple features.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-not-use-factory-methods-and-stick-to-it-is-more-functional">Why not use factory methods and stick to it is more functional?<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#why-not-use-factory-methods-and-stick-to-it-is-more-functional" class="hash-link" aria-label="Direct link to Why not use factory methods and stick to it is more functional?" title="Direct link to Why not use factory methods and stick to it is more functional?" translate="no">â€‹</a></h4>
<p>That works entirely. I didn't want to create factory methods because I  like the autocompletion provided by just writing <code>services</code> and seeing what shows up. So far, I have built a few complex SaaS products with a maximum of ten services. Also, factories require the same amount of work to be set up as services.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="using-singleton-services-is-not-the-same-as-using-global-state">Using singleton services is not the same as using global state<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#using-singleton-services-is-not-the-same-as-using-global-state" class="hash-link" aria-label="Direct link to Using singleton services is not the same as using global state" title="Direct link to Using singleton services is not the same as using global state" translate="no">â€‹</a></h4>
<p>I mean, it is, but it isn't. It is because you can only have one, and hence the state is just encapsulated within a scope similar to global. But it isn't because being encapsulated and part of a simple lifecycle manager provides benefits instead of just having it imported.</p>
<p>Let's take a database connection. I worked on a few projects that do this:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pg </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'pg'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> dbCredentials </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'config'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Pool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dbCredentials</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">doSomething</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> connection </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// do something with connection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'SIGINT'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// cleanup pool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> pool</span><br></span></code></pre></div></div>
<p>Now, this isn't wrong, but it will create that instance whenever someone imports that class. Also, if you want to pass in your credentials from somewhere else, like the secret service, you need to use async loading to ensure that it was loaded first, which is also a hassle.</p>
<p>If you instead go with:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pg </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'pg'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> dbCredentials </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'config'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Database</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> pool</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Pool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">constructor</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dbCredentials</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Pool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dbCredentials</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isReady</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// check connection works </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">close</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// cleanup pool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>You now benefit from not having to depend on process calls (which is helpful since the order of teardown occasionally matters). You can also ensure you create it after you retrieve the DB credentials from another async service. And you can ensure the connection details work. Yes, it adds a couple of milliseconds to startup time, but it's easier to validate fails on startup than when it's needed.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="you-can-also-quickly-mock-imported-singletons-in-node-it-is-a-bit-dirtier-but-possible">You can also quickly mock imported singletons in node. It is a bit dirtier but possible.<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#you-can-also-quickly-mock-imported-singletons-in-node-it-is-a-bit-dirtier-but-possible" class="hash-link" aria-label="Direct link to You can also quickly mock imported singletons in node. It is a bit dirtier but possible." title="Direct link to You can also quickly mock imported singletons in node. It is a bit dirtier but possible." translate="no">â€‹</a></h4>
<p>But why? I have written a lot of tests, and mocking services was always a huge pain (proxyquire in my experience). Why not just put a simple API on top and let Sinon mock it out for you in seconds?</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Given</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> services </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sinon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createStubInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Database</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="non-singleton-services">Non singleton services<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#non-singleton-services" class="hash-link" aria-label="Direct link to Non singleton services" title="Direct link to Non singleton services" translate="no">â€‹</a></h4>
<p>It's worth also mentioning again that we use both singleton services (pool database connections, realtime services) and session services (client database connections, header services, etc). The main difference is a session service is create for each request and is aware of the actual user session / user request. This is useful for things like having a transaction automatically create in the database with the correct session id set (for automatic audit logs) or anything else.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="singleton-services-are-not-local-state-holders">Singleton services are not local state holders!<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#singleton-services-are-not-local-state-holders" class="hash-link" aria-label="Direct link to Singleton services are not local state holders!" title="Direct link to Singleton services are not local state holders!" translate="no">â€‹</a></h4>
<p>This part is pretty important. Singleton services are singletons only because they sometimes need to hold a connection! They should never be used to share details across multiple invocations. This isn't something I can guarantee but it's the same as any lambda invocation. If it isn't on an external disk don't be upset if it gets lost! The only reason they are singletons and not functions is because of database pools / the way configuration works in certain third party APIs. A service could just be an object you pass in if you want (<code>isReady</code> and <code>close</code> APIs are optional).</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="not-for-everyone">Not for everyone<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#not-for-everyone" class="hash-link" aria-label="Direct link to Not for everyone" title="Direct link to Not for everyone" translate="no">â€‹</a></h4>
<p>I completely get how alot of people prefer doing things differently. There isn't always a right or wrong! I hope I provided a few insights into why I find this approach easier though.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="feedback-wanted">Feedback wanted<a href="https://pikku.dev/blog/2021/11/01/service-lookup-vs-cloud#feedback-wanted" class="hash-link" aria-label="Direct link to Feedback wanted" title="Direct link to Feedback wanted" translate="no">â€‹</a></h3>
<p>I would love some feedback on why you think this might be a terrible approach. I understand that dependency injection / service lookups in other solutions can get very complex and involve config files and hair pulling. If there's anything you think can be improved or products in common please let me know!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Service Lookup]]></title>
        <id>https://pikku.dev/blog/2021/10/30/service-injection</id>
        <link href="https://pikku.dev/blog/2021/10/30/service-injection"/>
        <updated>2021-10-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[How and why pikku uses services]]></summary>
        <content type="html"><![CDATA[<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Updated for Pikku v0.11</div><div class="admonitionContent_BuS1"><p>This is a historical post from 2021. In v0.11, function signatures changed to use the <code>wire</code> parameter pattern, and <code>pikkuSessionServices</code> was renamed to <code>pikkuWireServices</code>. See the <a class="" href="https://pikku.dev/docs">current documentation</a> for updated examples.</p></div></div>
<p>Quick intro, Pikku is a thin wrapper ontop of express / serverless / any request-response mechanism that hides away all the boiler plate. The goal is for a user to be able to be able to add an endpoint, with schemas, permissions and session management without actually having to do any boiler plate.</p>
<p>But as much as pure/immutable functional programming is amazing (give something in, gives you something back, never changing) it's hard to use in some cases (like database connections or integration with content management systems).</p>
<p>And there's also the issue around testing, cloud development and local development. Sometimes it's just easier to use interfaces with quick API access.</p>
<p>This is where pikkus service management comes into play.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="examples">Examples<a href="https://pikku.dev/blog/2021/10/30/service-injection#examples" class="hash-link" aria-label="Direct link to Examples" title="Direct link to Examples" translate="no">â€‹</a></h3>
<p>So a function in pikku has three inputs and one output:</p>
<p>For example, the simplest examples don't really need state:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> helloWorld </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuSessionlessFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">{</span><span class="token generic-function generic class-name"> name</span><span class="token generic-function generic class-name operator" style="color:#393A34">:</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name punctuation" style="color:#393A34">}</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hey there </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">data</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">!</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>But let's say you now have a user session and want to get the user:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> helloWorld </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#00009f">void</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Option one is your username is encoded in the session.. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// but that isn't really a great choice</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hey there </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">session</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">!</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Option two, you need to get it from the database</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This is using the postgres-typed library</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">database</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">crudGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'user'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'name'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> userId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">NotFoundError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hey there </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">user</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">!</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Let's break down what just happened. Our services contains a database driver and we ran a query using it, which gave us the name of the user.</p>
<p>But lets say we have now have a whole bunch of reactions:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> helloWorldNoisy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">pikkuFunc</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#00009f">void</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">database</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">crudGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'user'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'name'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'email'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> userId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">NotFoundError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// You could use an email service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> servces</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">email</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setHelloEmail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// A realtime service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">realtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hey there </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">user</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">!</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// A slack service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">slack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendHelloMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hey there </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">user</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">!</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hey there </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">user</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">!</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Makes it easier to read right?</p>
<p>But while readability is important, what happens under the hood is even more so.</p>
<p>When developing locally, you don't want to have all of those things to actually have happened. Would make things pretty cluttered!</p>
<p>And that's where dependency injection comes in handy!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="seting-up-services">Seting up services<a href="https://pikku.dev/blog/2021/10/30/service-injection#seting-up-services" class="hash-link" aria-label="Direct link to Seting up services" title="Direct link to Seting up services" translate="no">â€‹</a></h3>
<p>All service management is done in a single setup services class:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> setupServices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Services</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// The sessionService is the only service really needed for pikku to work. This is just </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// a placeholder for cleaner code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sessionService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SessionService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> slack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Slack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Wenever an error happens we send a slack notification, hence the dependency</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PinoLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slack</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> databasePool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PGDatabasePool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pgCredentials</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> email </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EmailService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> services </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secrets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> databasePool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">jwt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sessionService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> createSessionServices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> SingletonServices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Record</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> UserSession</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Services</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            database</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PGDatabaseClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">databasePool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">logger</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> session</span><span class="token operator" style="color:#393A34">?.</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> createSessionServices </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token builtin">never</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> Services </span><span class="token comment" style="color:#999988;font-style:italic">// ðŸ™ˆ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>That method does two important things:</p>
<ol>
<li class="">
<p>It creates the <code>SingletonServices</code>. These services are long lived and typically start with the process and end once it's complete. This includes things like database pools, or third-party APIs that are usually just wrappers around HTTP. If you have a websocket connection would live here as well.. but it wouldn't be very lambda friendly..</p>
</li>
<li class="">
<p>It creates the <code>SessionServices</code> (named <code>Services</code> for short). These are what are actually provided to the API functions and are scoped to the current session of the API call. It's worth making sure these are lazy loaded! If they aren't needed for the session it isn't worth doing the initial work. For example with a database, don't get the connection until your first query. This is useful for things like:</p>
<ul>
<li class="">Putting all database queries in a transaction automatically, with the userId set on the database session which allows audit logs to magically work.</li>
<li class="">Abstracting header details from the pikkuFuncs (pikku hides away all HTTP concepts so the code is deployment library agnostic)</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="there-are-two-ways-you-can-do-dependency-injection">There are two ways you can do dependency injection<a href="https://pikku.dev/blog/2021/10/30/service-injection#there-are-two-ways-you-can-do-dependency-injection" class="hash-link" aria-label="Direct link to There are two ways you can do dependency injection" title="Direct link to There are two ways you can do dependency injection" translate="no">â€‹</a></h3>
<ol>
<li class="">Create an entire stub for a service and figure it out in the setup layer</li>
</ol>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SlackStub</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sendHelloMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// do nothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">setupServices</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> slack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NODE_ENV</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'production'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Slack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SlackStub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ol start="2">
<li class="">Allow some services to decide what to do</li>
</ol>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Slack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sendHelloMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sendMessage</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NODE_ENV</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'production'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Would have sent a slack message'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Do the actual slack notification</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>I'm usually in favour of the second since it's less duplication and you don't need to create an interface that multiple classes rely on.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="testing">Testing<a href="https://pikku.dev/blog/2021/10/30/service-injection#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing" translate="no">â€‹</a></h3>
<p>The final benefit we'll mention is you can easily test your services with awesome libraries like sinon.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">describe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'hello function'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">it</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'sends a slack notification'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Given</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> services </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            slack</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sinon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createStubInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slack</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// When</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">helloWorldNoisy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> userId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'1234'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sinon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">calledOnce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">slack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendHelloMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sinon</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">calledWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">slack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendHelloMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Hey there </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">user</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">!</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>The final benefit is that you can switch out services really easily, if you want to use socketIO locally but ably.io remotely for example, pretty simple. It's just normal interfaces after all!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="some-example-services-we-wrote--use">Some example services we wrote / use:<a href="https://pikku.dev/blog/2021/10/30/service-injection#some-example-services-we-wrote--use" class="hash-link" aria-label="Direct link to Some example services we wrote / use:" title="Direct link to Some example services we wrote / use:" translate="no">â€‹</a></h3>
<ul>
<li class="">
<p>JWT</p>
<p>used to sign and decrypt jwt tokens</p>
</li>
<li class="">
<p>Secrets</p>
<p>used to get secrets from AWS secret store / local env / elsewhere</p>
</li>
<li class="">
<p>Notification</p>
<p>used to send notifications within a web application</p>
</li>
<li class="">
<p>Realtime</p>
<p>sending realtime notifications to ably.io</p>
</li>
<li class="">
<p>S3 Content <em>(included)</em></p>
<p>doing all the S3 related content work, like file signing (both uploads and cloudfront)</p>
</li>
<li class="">
<p>Local Content <em>(included)</em></p>
<p>doing file management locally / using express and reaper</p>
</li>
<li class="">
<p>Salesforce</p>
<p>integrating code with salesforce</p>
</li>
</ul>
<p>The list goes on...</p>
<p>And that's it as a crash course to why we used services!</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello!]]></title>
        <id>https://pikku.dev/blog/2021/08/01/hello</id>
        <link href="https://pikku.dev/blog/2021/08/01/hello"/>
        <updated>2021-08-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A short welcome message for user context!]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="hello">Hello!<a href="https://pikku.dev/blog/2021/08/01/hello#hello" class="hash-link" aria-label="Direct link to Hello!" title="Direct link to Hello!" translate="no">â€‹</a></h3>
<p>Welcome to the pikku blog!</p>
<p>The goal is of the blog is for me to share as much as I can about some design decisions I have taken whilst working on some of my projects/ideas. Once those are open for testing I'll be providing a lot more examples!</p>
<p>Since you are already here, let me share why pikku exists.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pikku-design-decisions-info">Pikku Design Decisions Info<a href="https://pikku.dev/blog/2021/08/01/hello#pikku-design-decisions-info" class="hash-link" aria-label="Direct link to Pikku Design Decisions Info" title="Direct link to Pikku Design Decisions Info" translate="no">â€‹</a></h3>
<p>Pikku design decisions were mostly out of the following situations:</p>
<ol>
<li class="">
<p>During the covid 2021 pandemic I started working on a project in an area with barely an internet, so it had to be easy to run entirely offline. But I wanted it to follow functionless from the start since it made it easier to throw in functionality and onboard developers.</p>
</li>
<li class="">
<p>The previous project I co-wrote / maintained (<a href="https://deepstream.io/" target="_blank" rel="noopener noreferrer" class="">deepstream.io</a>) has a concept of RPCs. This effectively allowed any client (whether frontend or backend) to register to become a provider. We deployed the same functions via both HTTP and RPC by putting a thin wrapper around the logic.</p>
</li>
<li class="">
<p>The projects I currently work on usually have a bunch of third party services we interact with (email, database, salesforce, google docs, JWT  management, etc). I found that having a simple dependency injection with the collection of services smoothens things out. This was also heavily inspired by the large refactor I have done earlier from  deepstream.io to V5.</p>
</li>
<li class="">
<p>Typescript! I have refactored my projects a zillion times (mostly due to changing requirements and partially because I can) and I have types EVERYWHERE to stop me from running into odd bugs.</p>
</li>
<li class="">
<p>A sprinkle of magic / autogenerated files because automation (sometimes!) makes life that much easier</p>
</li>
</ol>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[React and VanillaJS Services]]></title>
        <id>https://pikku.dev/blog/2021/08/01/service-hook</id>
        <link href="https://pikku.dev/blog/2021/08/01/service-hook"/>
        <updated>2021-08-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A dive into the use-service-hook to tie state management directly to ES6 classes without the need for contexts or redux]]></summary>
        <content type="html"><![CDATA[<p>Today I want to share a design that I have been using for maintaining state in react since the emergence of hooks.</p>
<p>There have been quite a few posts lately around how redux is a bit too complex for a lot of current applications. The current solution usually seems to recommend using <code>Context</code> or the <code>useReducer</code> hook provided by the reactJS library.</p>
<p>Before I begin, I'm not great at content writing, so if you find any mistakes feel free to fix them in a PR or let me know so I can improve going forward. Thanks!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="my-state-management-experiences">My state-management experiences<a href="https://pikku.dev/blog/2021/08/01/service-hook#my-state-management-experiences" class="hash-link" aria-label="Direct link to My state-management experiences" title="Direct link to My state-management experiences" translate="no">â€‹</a></h3>
<p>You can skip this part if you want to see <a href="https://pikku.dev/blog/2021/08/01/service-hook#the-now---how-it-works" class="">how it just works</a>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-earliest-era">The earliest era<a href="https://pikku.dev/blog/2021/08/01/service-hook#the-earliest-era" class="hash-link" aria-label="Direct link to The earliest era" title="Direct link to The earliest era" translate="no">â€‹</a></h4>
<p>The evolution of state management in my day to day job started in 2010. Back then we have a custom rendering framework (as almost all companies did) and we had a vanilla JS model. The logic was separated and for the most part, we just wrote JS classes (via adding methods directly to the prototype) and emitted events whenever things changed and called the methods directly from the controller. It was a simple life, except everything was custom written and the custom framework is very similar to XML.. but it was 2010.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-early-mid-era">The early mid-era<a href="https://pikku.dev/blog/2021/08/01/service-hook#the-early-mid-era" class="hash-link" aria-label="Direct link to The early mid-era" title="Direct link to The early mid-era" translate="no">â€‹</a></h4>
<p>We then moved towards <a href="https://knockoutjs.com/" target="_blank" rel="noopener noreferrer" class="">KnockoutJS</a>. It was one of the more powerful frameworks around (mostly competing VS <a href="https://jquery.com/" target="_blank" rel="noopener noreferrer" class="">jQuery</a> and <a href="https://angularjs.org/" target="_blank" rel="noopener noreferrer" class="">Angular1</a> and works by having your properties all being observables. So <code>name()</code> returns name, <code>name('bob')</code> updates it. If you tied your HTML to the observable it would be able to read and update it.</p>
<p>The library itself was great, but unfortunately, the adoption went a bit too far and the entire logic ended up moving into the view. This meant we no longer had vanillaJS domain logic, and all of our code was driven by observables. This resulted in us implementing a reactive layer on top to sort out those events and aggregate them, which again led to reinventing the wheel. Plus, that's just the first level of impact in terms of knock-on effects. We ended up writing a proprietary semi BDD testing layer and it was just.. odd. This was still back in the days of IE6 support, so just using a shim of <code>forEach</code> would occasionally result in the screen of unresponsiveness, let alone thousands of observables going off due to ping pong effects.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-mid-era">The mid era<a href="https://pikku.dev/blog/2021/08/01/service-hook#the-mid-era" class="hash-link" aria-label="Direct link to The mid era" title="Direct link to The mid era" translate="no">â€‹</a></h4>
<p>So I was eventually allowed to implement another design. The exact memory is a little fuzzy, but I'm tempted to say it was because we (myself and two colleagues) won a hackathon where we were able to implement a trade model with an infinite (memory and CPU constraints aside) amount of sub-trades. Turned out there was another team who had to implement that feature and a scrum master helped make the case. The solution wasn't perfect since it was still based on observables, but it worked for small to medium model sizes.</p>
<p>The idea was models that have decorators mixed in.</p>
<p>Something like...</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EmployeeMixin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BirthdayMixin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// And each one of those would add properties to the model which you can set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'age'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">35</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// and read via</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'get'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Most importantly though, you can listen to any field change</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// which is where the renderers subscribe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onChange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'age'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newAge</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldAge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This pretty much meant you can allow a very small JS library to deal with all computation without needing to touch any DOM concepts. And since we were a software company with multiple clients, we were able to compose different models using the same mixins which sped development and new features up nicely.</p>
<p>The biggest impact was in older browsers. We sped up rendering complex tickets from seconds to milliseconds, mostly by avoiding hundreds of observables being triggered during load time. Detaching from knockout also meant we were able to write some pure vanilla JS components using the same logic, which back then had a large performance improvement when dealing with windowing.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-startup-era">The startup era<a href="https://pikku.dev/blog/2021/08/01/service-hook#the-startup-era" class="hash-link" aria-label="Direct link to The startup era" title="Direct link to The startup era" translate="no">â€‹</a></h4>
<p>This period was mostly based on backend development, so a blog post for another day. For the frontend, we just bought an Angular 1 template for 7 bucks and tweaked it to work. Wasn't great, Angular1 was already years old but there weren't yet any quality React or Vue templates ready to use.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-late-mid-era">The late mid-era<a href="https://pikku.dev/blog/2021/08/01/service-hook#the-late-mid-era" class="hash-link" aria-label="Direct link to The late mid-era" title="Direct link to The late mid-era" translate="no">â€‹</a></h4>
<p>After the startup crashed I had the fortunate luck of getting a position with a group of team members from the early/mid ERA. In less than a year they built a feature-rich real-time financial web application that worked well on both phones and desktops. During this era, I got my crash introduction to React, Redux and Reselect.</p>
<p>The main/only downsides I encountered were:</p>
<ol>
<li class="">
<p>The fact the codebase was all in JS made the migration to typescript more painful. Redux has a few libraries (like redux-fsa) which makes it easier to use typescript, but it involved a lot of rework.</p>
</li>
<li class="">
<p>Since the way we used reselect was based on taking things, combining them and passing them on (it was a very client-heavy app) there are quite a few layers to wrap your head around. Combined with the general overhead of redux reducers/actions/dispatchers it made code navigation more complex than I hoped, where onboarding usually required a time window to grasp the context followed by decent productivity.</p>
</li>
</ol>
<p>It's worth mentioning this was all before Hooks came out, and in the last couple of months, the team already simplified/refactored a bunch of HOC to be easier to worth with.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-recent-era">The recent era<a href="https://pikku.dev/blog/2021/08/01/service-hook#the-recent-era" class="hash-link" aria-label="Direct link to The recent era" title="Direct link to The recent era" translate="no">â€‹</a></h4>
<p>I don't want to go too deep into this era since there are just too many oddities to explain. Let's just say it was a bit of a dark and weird place in state management history. I started freelancing and saw different state management systems which just baffled me in terms of complexity. Inheritance, composition, observables, reactive code all sort of forcefully existing together. Unfortunately, it was one of those "the original developer set it up" sorts of situations and the cost of changing it was extremely high.</p>
<p>I also started on my projects initially with the impression I'll use redux and typescript to build all my logic. But as I constantly refactored things whilst adding features I found the process painful. I was doing most of my logic in the model layer and switching from the backend to the frontend always gave me a bit of dread. There had to be a way for me to regain my sanity.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-now---how-it-works">The now - how it works<a href="https://pikku.dev/blog/2021/08/01/service-hook#the-now---how-it-works" class="hash-link" aria-label="Direct link to The now - how it works" title="Direct link to The now - how it works" translate="no">â€‹</a></h3>
<p>So I got up one day and wrote down the following criteria (in order of importance):</p>
<ol>
<li class="">It has to be super typescript friendly</li>
<li class="">It has to be React agnostic</li>
<li class="">It has to support real-time updates</li>
<li class="">It has to be unit testable without any none core libraries like assert/chai</li>
<li class="">It has to support both <code>sync</code> and <code>async</code> methods</li>
<li class="">It has to have no dependencies</li>
<li class="">When used by React, has to be performant and only update what and when I want it to</li>
<li class="">When used by React, has to be super easy to use</li>
<li class="">Passing references to it should be simple</li>
<li class="">It has to be easy to create sub-states. A state per component for example.</li>
</ol>
<p>Armed with those concepts, and the random mix of experience over the last decade, I decided to go back to my roots with the addition of React hooks.</p>
<p>Let us look at an example:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// First thing we need is a bunch of events to emit when things change</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> EmployeeServiceEvents </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">EMPLOYEE_CHANGED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'EMPLOYEE_CHANGED'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">EVENTS_CHANGED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'EVENTS_CHANGED'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Then the actual service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">EmployeeService</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">EventEmitter3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> employees</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">Record</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name builtin">string</span><span class="token generic-function generic class-name punctuation" style="color:#393A34">,</span><span class="token generic-function generic class-name"> Human</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This method isn't async because we use it to initialise state and react state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// initialization is sync. So the goal is to return undefined if not locally loaded</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// and trigger the event once it is.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getEmployee</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> employee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">employees</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> employee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">employeeUpdated</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// This sets the employee for future reference</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">employees</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> employee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// And emits an event scored to the employeeId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">EmployeeServiceEvents</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation constant" style="color:#36acaa">EMPLOYEE_CHANGED</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">_</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">employeeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> employee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Using basic pub-sub we can subscribe to any changes. This assumes the entire </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// employee is sent out with each update which usually isn't the case.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        real</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">time service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">employee:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">employeeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> employeeUpdated</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This is the rest wrapper around fetch used in pikku to minimize boilerplate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">api/employee/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">employeeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeUpdated</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// So this here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateEmployeeName</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> employee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">employees</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This api should not be called if the employee isn't loaded.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">employee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Employee not loaded'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// We use spreading to create a new object for immutability</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> updatedEmployee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">employee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">employees</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updatedEmployee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This will inform all the hooks that care about the entire employee</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">EmployeeServiceEvents</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation constant" style="color:#36acaa">EMPLOYEE_CHANGED</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">_</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">employeeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updatedEmployee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This will inform any hooks that care about a specific field</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">EmployeeServiceEvents</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation constant" style="color:#36acaa">NAME_CHANGED</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">_name_</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">employeeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If using a realtime service, make sure to unsubscribe everything when completed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">destroy</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> employeeId </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">employees</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            realtimeService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unsubscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The general gist is that everything is written in vanilla JS, and updated things have to be immutable. You can also decide on your favourite approach to update things. In projects where I send deltas to the backend, I apply the changes locally. For other services where knowing the updated state of the server is important I wait for the updated version and set that.</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addEmployeeCalendarEvent</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CalendarEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> employee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">employees</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This is the rest wrapper around fetch used in pikku to minimize boilerplate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> events </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">patch</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">CalendarEvents</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">api/employee/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">employeeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">/addEvent</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">employees</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">employee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// We don't emit the employee changed event here to prevent having all the render </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// events triggered.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">EmployeeServiceEvents</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation constant" style="color:#36acaa">EVENTS_CHANGED</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">_</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">employeeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Alright, so the hook itself:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> EventEmitter </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'eventemitter3'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> useEffect </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'react'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// The service, the event and a callback</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">useServiceHook</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">service</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EventEmitter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">callback</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token plain">args</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">useEffect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">off</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>And you can use it by saying:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> useServiceHook </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@pikku/hooks/dist/use-service-hook'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> useState </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'react'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> useEmployee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Employee </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">employee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setEmployee</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">useState</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">Employee </span><span class="token generic-function generic class-name operator" style="color:#393A34">|</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#00009f">undefined</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// This is why getEmployee has to be sync</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> employeeId </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> employeeService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEmployee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">useServiceHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        employeeService</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">EmployeeServiceEvents</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation constant" style="color:#36acaa">EMPLOYEE_CHANGE</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">_</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">employeeId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setEmployee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> employee</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>or if you want to update something:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">addCalendarEvent</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> CalendarEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> employeeService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addCalendarEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">employeeId</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>And that's all folks!</p>
<p>Let us revisit the requirements:</p>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-it-has-to-be-super-typescript-friendly">1: It has to be super typescript friendly<a href="https://pikku.dev/blog/2021/08/01/service-hook#1-it-has-to-be-super-typescript-friendly" class="hash-link" aria-label="Direct link to 1: It has to be super typescript friendly" title="Direct link to 1: It has to be super typescript friendly" translate="no">â€‹</a></h5>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-it-has-to-be-react-agnostic">2: It has to be React agnostic<a href="https://pikku.dev/blog/2021/08/01/service-hook#2-it-has-to-be-react-agnostic" class="hash-link" aria-label="Direct link to 2: It has to be React agnostic" title="Direct link to 2: It has to be React agnostic" translate="no">â€‹</a></h5>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-it-has-to-be-unit-testable">3: It has to be unit testable<a href="https://pikku.dev/blog/2021/08/01/service-hook#3-it-has-to-be-unit-testable" class="hash-link" aria-label="Direct link to 3: It has to be unit testable" title="Direct link to 3: It has to be unit testable" translate="no">â€‹</a></h5>
<blockquote>
<p>All of the above is achieved by just using normal ES6 classes.</p>
</blockquote>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-it-has-to-support-both-sync-and-async-methods">4: It has to support both <code>sync</code> and <code>async</code> methods<a href="https://pikku.dev/blog/2021/08/01/service-hook#4-it-has-to-support-both-sync-and-async-methods" class="hash-link" aria-label="Direct link to 4-it-has-to-support-both-sync-and-async-methods" title="Direct link to 4-it-has-to-support-both-sync-and-async-methods" translate="no">â€‹</a></h5>
<blockquote>
<p>Using ES6 classes this works. The main obstacle is just that anything that needs to be initialised in a <code>getState</code> method can't be async because otherwise, the state would contain a promise. So you call the method if it's undefined expect the event to be called with the initial value shortly after</p>
</blockquote>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-it-has-to-have-no-dependencies">5: It has to have no dependencies<a href="https://pikku.dev/blog/2021/08/01/service-hook#5-it-has-to-have-no-dependencies" class="hash-link" aria-label="Direct link to 5: It has to have no dependencies" title="Direct link to 5: It has to have no dependencies" translate="no">â€‹</a></h5>
<blockquote>
<p>I had to use another EventEmitter library because the one included in the shim isn't browser
friendly. So the only dependency is EventEmitter3</p>
</blockquote>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-react-has-to-be-performant-and-only-update-what-and-when-i-want-it-to">6: React: has to be performant and only update what and when I want it to<a href="https://pikku.dev/blog/2021/08/01/service-hook#6-react-has-to-be-performant-and-only-update-what-and-when-i-want-it-to" class="hash-link" aria-label="Direct link to 6: React: has to be performant and only update what and when I want it to" title="Direct link to 6: React: has to be performant and only update what and when I want it to" translate="no">â€‹</a></h5>
<blockquote>
<p>So I have used this pattern for three applications so far. I can say it has made debugging CPU consumption much easier because the stack trace is minimal. I'm currently developing a large audiobook editor in-browser and it has so far held up to all my expectations without any debugging</p>
</blockquote>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-react-has-to-be-super-easy-to-use">7: React: has to be super easy to use<a href="https://pikku.dev/blog/2021/08/01/service-hook#7-react-has-to-be-super-easy-to-use" class="hash-link" aria-label="Direct link to 7: React: has to be super easy to use" title="Direct link to 7: React: has to be super easy to use" translate="no">â€‹</a></h5>
<blockquote>
<p>Not that much to learn thankfully, everything is pretty much contained in those lines of code above.</p>
</blockquote>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-passing-reference-to-it-should-be-simple">8: Passing reference to it should be simple<a href="https://pikku.dev/blog/2021/08/01/service-hook#8-passing-reference-to-it-should-be-simple" class="hash-link" aria-label="Direct link to 8: Passing reference to it should be simple" title="Direct link to 8: Passing reference to it should be simple" translate="no">â€‹</a></h5>
<blockquote>
<p>So the classes themselves are created once using <code>useMemo</code> and can then be passed through via a context or using props. Either way, it should never trigger a rerender unless the service itself changes, which is a whole different story.</p>
</blockquote>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> employeeService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">useMemo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EmployeeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">EmployeeContent.Provider</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">employeeService</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">EmployeeContent.Provider</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>I am a bit lazy and just use singletons when possible. Saves me from having to use contexts across the board.</p>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id="9-should-be-easy-to-create-sub-states-a-state-per-component-for-example">9: Should be easy to create sub-states. A state per component for example.<a href="https://pikku.dev/blog/2021/08/01/service-hook#9-should-be-easy-to-create-sub-states-a-state-per-component-for-example" class="hash-link" aria-label="Direct link to 9: Should be easy to create sub-states. A state per component for example." title="Direct link to 9: Should be easy to create sub-states. A state per component for example." translate="no">â€‹</a></h5>
<blockquote>
<p>This was important for me because I have classes that back certain complex components in react. Because of the approach above, there's no complex state creation. Create the class and it deletes when the component is removed. If the class needs cleanup code you can just <code>useEffect</code>.</p>
</blockquote>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-end">The end<a href="https://pikku.dev/blog/2021/08/01/service-hook#the-end" class="hash-link" aria-label="Direct link to The end" title="Direct link to The end" translate="no">â€‹</a></h4>
<p>I hope this was an enjoyable read! This website is a work in the process alongside the projects that depend
on pikku. I'm looking forward to sharing some of the libraries and thoughts there along the way.</p>]]></content>
    </entry>
</feed>