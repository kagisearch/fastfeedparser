<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
    <title>Matt Massicotte&#x27;s Blog</title>
    <subtitle>I write stuff here.</subtitle>
    <link rel="self" type="application/atom+xml" href="https://massicotte.org/atom.xml"/>
    <link rel="alternate" type="text/html" href="https://massicotte.org"/>
    <generator uri="https://www.getzola.org/">Zola</generator>
    <updated>2026-02-13T00:00:00+00:00</updated>
    <id>https://massicotte.org/atom.xml</id>
    <entry xml:lang="en">
        <title>The Journey</title>
        <published>2026-02-13T00:00:00+00:00</published>
        <updated>2026-02-13T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/blog/the-journey/"/>
        <id>https://massicotte.org/blog/the-journey/</id>
        
        <content type="html" xml:base="https://massicotte.org/blog/the-journey/">&lt;p&gt;I&#x27;m a pacer. I find it helps me think. And let me tell you, I have been doing just an enormous amount of pacing recently. I believe that many other people are in a similar situation, at least as far as the thinking part goes.&lt;&#x2F;p&gt;
&lt;p&gt;I have been struggling to understand AI. And I don&#x27;t mean how to choose a model or set up an agentic workflow. I mean, like, the &lt;strong&gt;broader implications&lt;&#x2F;strong&gt;. On the one hand, it&#x27;s completely normal for me to encounter things I do not understand. And many people, especially in my circles, seem to believe that this is a normal cycle of change. But I&#x27;m finding it extremely difficult to share that opinion.&lt;&#x2F;p&gt;
&lt;p&gt;To help process, I&#x27;ve been on a bit of a reading frenzy. And, slowly, I&#x27;ve been organizing my thoughts. Which has been incredibly hard! But, I stumbled across a post that I feel has finally given me an &lt;strong&gt;in&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;That post is called &lt;a href=&quot;https:&#x2F;&#x2F;surfingcomplexity.blog&#x2F;2026&#x2F;02&#x2F;08&#x2F;nobody-knows-how-the-whole-system-works&#x2F;&quot;&gt;&quot;Nobody knows how the whole system works&quot;&lt;&#x2F;a&gt;. It discusses how complex the technology we use today is, and how, almost necessarily, no one person understands the whole thing.&lt;&#x2F;p&gt;
&lt;p&gt;I liked it! But, it got me thinking about a deeper concept. And while I&#x27;m framing it around software work, because that&#x27;s what I know, I don&#x27;t think it is limited to that domain.&lt;&#x2F;p&gt;
&lt;p&gt;Also, real quick. I believe people are having true success producing software with AI. However, I have not ever used AI myself. It&#x27;s a pretty weird place to be.&lt;&#x2F;p&gt;
&lt;p&gt;Anyway, with that bizarre disclosure out of the way, we can proceed.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;technical-debt&quot;&gt;Technical Debt&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;m a sucker for analogies and I think &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Technical_debt&quot;&gt;&quot;technical debt&quot;&lt;&#x2F;a&gt; has to go down as one of the all-time greats. You cut some corners and in exchange, you get to build The Thing faster. A fascinating aspect is sometimes you don&#x27;t even &lt;strong&gt;realize&lt;&#x2F;strong&gt; you are taking on the debt at the time. Or, maybe you really tried to &lt;strong&gt;avoid&lt;&#x2F;strong&gt; cutting corners, but stuff outside the system changed and now what you have is insufficient.&lt;&#x2F;p&gt;
&lt;p&gt;Like all good analogies, this one is imperfect. Yet, it has really stuck. You&#x27;ve got some software that isn&#x27;t well-suited to your current problems, and while it might have helped you go faster initially, now it&#x27;s slowing you down. Buy now, pay later. Debt!&lt;&#x2F;p&gt;
&lt;p&gt;Something that often goes hand in hand with technical debt is leaving intentional &lt;strong&gt;gaps&lt;&#x2F;strong&gt; in knowledge. You certainly &lt;strong&gt;could&lt;&#x2F;strong&gt; learn how all five of the supported encodings work. But instead, you just focus on the most common one. Someone else definitely does know how they all work. Just not you, at least right now.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;bus-factor&quot;&gt;Bus Factor&lt;&#x2F;h2&gt;
&lt;p&gt;While pondering this, I also thought of the &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Bus_factor&quot;&gt;&quot;bus factor&quot;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;You&#x27;ve got some important person who knows how The Thing works. Except, instead of an orderly and planned exit, where they can take time to teach and document, they just disappear. In the blink of an eye, there are now zero people that know how the The Thing works!&lt;&#x2F;p&gt;
&lt;p&gt;The sudden disappearance is concerning not just because it has left a knowledge &lt;strong&gt;gap&lt;&#x2F;strong&gt;. We experience gaps in our knowledge all the time. But if some key person disappears, we don&#x27;t just have a gap, we also have time pressure.&lt;&#x2F;p&gt;
&lt;p&gt;And that&#x27;s a problem, because filling in gaps can be &lt;strong&gt;difficult&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;(I also feel super-weird trivializing the idea of someone being hit by a bus. But I keep telling myself it is just an analogy...)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;filling-in-gaps&quot;&gt;Filling in Gaps&lt;&#x2F;h2&gt;
&lt;p&gt;People leave positions in a more controlled way all the time. They let everyone know their intentions and begin some kind of &quot;knowledge transfer&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;(A term that is logical, clear, and yet has always felt funny to me. Always makes me think: &quot;I know Kung fu&quot;)&lt;&#x2F;p&gt;
&lt;p&gt;This person put in the effort to deeply understand a problem and construct a system to solve it. This can require a substantial amount of sustained and intense effort. A process that will be not just technical, but &lt;strong&gt;emotional&lt;&#x2F;strong&gt; too. This is true even if the system itself was inherited from someone else. And now, armed with all this hard-fought context, they are choosing what to focus on, what to de-emphasize. Which questions to answer in-depth, and which to dismiss as distractions or take as signs of confusion.&lt;&#x2F;p&gt;
&lt;p&gt;This is not &lt;strong&gt;at all&lt;&#x2F;strong&gt; to say this will make them any good at teaching. The point here is they don&#x27;t just have knowledge, like some kind of possession. They have experience. Wisdom. They don&#x27;t just know how it works, they can tell you stories about what &lt;strong&gt;didn&#x27;t&lt;&#x2F;strong&gt; work and why. And they can draw on this to help shape how they share the knowledge.&lt;&#x2F;p&gt;
&lt;p&gt;They have gone on The Journey.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;gaps-are-good&quot;&gt;Gaps are Good&lt;&#x2F;h2&gt;
&lt;p&gt;The hook from the post I linked above is &quot;does anyone know how their phone works&quot;? And in it, I paused at one point where a question was posed:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Could you explain the difference between quadrature amplitude modulation (QAM) and quadrature phase shift keying (QPSK)...&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;I do know the difference between &quot;QAM&quot; and &quot;QPSK&quot;! Or at least I did at one point. I studied this, admittedly superficially, in school. But you know what, I now cannot remember. It hasn&#x27;t mattered to me for so long, and I&#x27;ve forgotten. I had a gap, I filled in it. And then, over time, it unfilled itself!&lt;&#x2F;p&gt;
&lt;p&gt;This core question, if any one person knows, top-to-bottom, how their phone works is about gaps. And I don&#x27;t think I buy that gaps are bad!&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s a &lt;strong&gt;good&lt;&#x2F;strong&gt; thing you do not know how your CPU cache system works. Or your compiler. Or that open source library you are using. These are gaps that have been successfully and intentionally hidden from you. Critically, by some person that &lt;strong&gt;does&lt;&#x2F;strong&gt; understand them. And that enables you to focus on other stuff.&lt;&#x2F;p&gt;
&lt;p&gt;But the day might come that you discover that how your compiler works actually starts to matter. And when that day comes, we know exactly what we have to do.&lt;&#x2F;p&gt;
&lt;p&gt;We now have to begin The Journey.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;knowledge-debt&quot;&gt;Knowledge Debt&lt;&#x2F;h2&gt;
&lt;p&gt;Now, because we have all gone on these, we know that some Journeys are tiny. You might be able to complete one in 30 minutes. But others. Others might take years. It is not a certainty you will ever even complete it. Worse, it can be incredibly difficult to estimate how long it might take.&lt;&#x2F;p&gt;
&lt;p&gt;And now, &lt;strong&gt;finally&lt;&#x2F;strong&gt;, I get to my point.&lt;&#x2F;p&gt;
&lt;p&gt;Suppose we have The Thing. And literally no humans have ever had the knowledge of how or why it works. It could be the human coordinators, necessarily, went on The Journey along the way. But I think it&#x27;s a lot more interesting to imagine they did not. And in that case, I think this is a manifestation not of a knowledge gap, but of knowledge &lt;strong&gt;debt&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;does-the-journey-matter&quot;&gt;Does The Journey Matter?&lt;&#x2F;h2&gt;
&lt;p&gt;It could be the case that you can just get the AI to explain to you what it did. I mean, I know you &lt;strong&gt;can&lt;&#x2F;strong&gt; do that. But, what I don&#x27;t know is if it will be &lt;strong&gt;sufficient&lt;&#x2F;strong&gt; for the human to build correct and robust mental models. How can you possibly accurately judge documentation unless you deeply understand the topic?&lt;&#x2F;p&gt;
&lt;p&gt;Because The Journey can be so expensive, in time, in physical and mental resources, I believe that knowledge debt will have immense, and probably irresistible, value.&lt;&#x2F;p&gt;
&lt;p&gt;What I don&#x27;t think we yet know for sure is if it is actually &lt;strong&gt;possible&lt;&#x2F;strong&gt; to accrue knowledge debt. And, if it is, what it will cost to pay down. I have no idea! But I think the implications for not just software, but all forms of knowledge work, could be profound.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Act different.</title>
        <published>2026-01-26T00:00:00+00:00</published>
        <updated>2026-01-26T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/blog/act-different/"/>
        <id>https://massicotte.org/blog/act-different/</id>
        
        <content type="html" xml:base="https://massicotte.org/blog/act-different/">&lt;p&gt;I&#x27;ve been having a lot of trouble sleeping lately. The world is in terrible danger.&lt;&#x2F;p&gt;
&lt;p&gt;About a year ago, I wrote a &lt;a href=&quot;&#x2F;leverage&quot;&gt;thing&lt;&#x2F;a&gt; condemning Apple for advertising on X. At the time, I did not fully grasp how deliberately Apple was acting. Horrific things are happening and Apple is helping.&lt;&#x2F;p&gt;
&lt;p&gt;And so, we &lt;strong&gt;cannot&lt;&#x2F;strong&gt; allow business to continue as usual.&lt;&#x2F;p&gt;
&lt;p&gt;What that means, however, is not so easy to figure out. In my &lt;a href=&quot;&#x2F;resolve&quot;&gt;last&lt;&#x2F;a&gt; post on the topic, I wrote this:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Striking a balance here is incredibly difficult. Action that comes with too big a personal cost compromises your ability to act. But too little? Well that&#x27;s exactly what the forces we are struggling against are depending on.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Well let me tell you, I &lt;strong&gt;struggled&lt;&#x2F;strong&gt; here. I continue to. What can we actually do? I still think withholding feedback is good, and we should do that. But it&#x27;s not nearly enough.&lt;&#x2F;p&gt;
&lt;p&gt;Soon after my first post on this problem, someone came up with a twist on the famous &quot;Think different.&quot; campaign. We put together a very simple site: &lt;a href=&quot;https:&#x2F;&#x2F;actdifferent.org&quot;&gt;actdifferent.org&lt;&#x2F;a&gt;. It&#x27;s a concept, nothing more. And then I kind of dropped it, because I wasn&#x27;t sure what to do next.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;&quot;Act different.&quot;&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s nothing else. But perhaps that&#x27;s actually an advantage. The message puts the question to you. The only thing I am certain of is that we must do something. Apple, the company, cannot have values or morality. But we do have values. We have morality.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m scared. And it feels bad seeing this powerful entity actively work to make things worse. So I headed over to my local Apple store. I navigated over to &quot;actdifferent.org&quot; on a few machines.&lt;&#x2F;p&gt;
&lt;p&gt;You know what? It felt really lame. But what did not feel lame was the &quot;trying&quot; part. That part felt right.&lt;&#x2F;p&gt;
&lt;p&gt;So here&#x27;s what I&#x27;m after. If you feel like heading over to your store too, great! Protest! But that&#x27;s not what this is about. What I&#x27;m asking is that you, a developer, employee, or just someone that cares, figure out what your &quot;business as usual&quot; is. Think about where you might have a little leverage.&lt;&#x2F;p&gt;
&lt;p&gt;And find a way to act different.&lt;&#x2F;p&gt;
&lt;p&gt;❤️&lt;&#x2F;p&gt;
&lt;p&gt;(Just please do not put yourself at too much risk. Apple is largely above the law, but you are not.)&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Swift Compiler Changes the Easy Way</title>
        <published>2026-01-13T00:00:00+00:00</published>
        <updated>2026-01-13T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/blog/compiler-changes-the-easy-way/"/>
        <id>https://massicotte.org/blog/compiler-changes-the-easy-way/</id>
        
        <content type="html" xml:base="https://massicotte.org/blog/compiler-changes-the-easy-way/">&lt;p&gt;I thought it would be fun to share my experience with a recent Swift compiler change. First, because this is something you don&#x27;t get to see every day. But, on top of that, there were a number of twists along the way. The whole thing was really not what I expected.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;I cannot quite remember the specifics, but the backstory is I spent a bunch of time debugging a really annoying problem and I got frustrated. Here&#x27;s the general idea:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this threw an error...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; await somethingThatWillThrow() 
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... so this really important&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; thing didn&amp;#39;t happen&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await someOtherCriticalWork()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Errors thrown within a Task body aren&#x27;t visible unless you await the &lt;code&gt;value&lt;&#x2F;code&gt; property. But, because the result of the Task creation APIs are all marked &lt;code&gt;@discardableResult&lt;&#x2F;code&gt;, it&#x27;s very easy to silently miss this mistake.&lt;&#x2F;p&gt;
&lt;p&gt;While the code above doesn&#x27;t produce any warnings, a fairly analogous thing with &lt;code&gt;Result&lt;&#x2F;code&gt; does at least gives you something:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; warning: Result of &amp;#39;Result&amp;lt;Success, Failure&amp;gt;&amp;#39; initializer is unused&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Result {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; somethingThatWillThrow()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There are a lot of ways to &lt;strong&gt;intentionally&lt;&#x2F;strong&gt; ignore errors, which is fine. But I don&#x27;t think it should be possible to do it &lt;strong&gt;accidentally&lt;&#x2F;strong&gt;. So, I did what any reasonable person would do.&lt;&#x2F;p&gt;
&lt;p&gt;I &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;pitch-non-discardable-throwing-tasks&#x2F;74138&quot;&gt;suggested&lt;&#x2F;a&gt; we fix it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;dumb-luck&quot;&gt;Dumb Luck&lt;&#x2F;h2&gt;
&lt;p&gt;As it turns out, a few replies later in that forum thread, &lt;a href=&quot;https:&#x2F;&#x2F;kto.so&quot;&gt;Konrad&lt;&#x2F;a&gt; on the compiler team had the idea that we collaborate. He was working on a change in the same area, to add support for typed throws to the &lt;code&gt;Task&lt;&#x2F;code&gt; APIs. It seemed like a good match to include this change too.&lt;&#x2F;p&gt;
&lt;p&gt;Believe it or not, this is not the first time something like this has happened! My super power is I&#x27;m totally fine with making half-baked suggestions about ways to change the compiler. These ideas are often not very good. But occasionally I&#x27;ll stumble onto something reasonable! And those are the most likely to get the attention of the compiler team. In fact, it seems to be fairly common that they are already working on (or at least thinking about) similar things.&lt;&#x2F;p&gt;
&lt;p&gt;These are very useful people to get on your team, because making changes to Swift is &lt;strong&gt;difficult&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;proposals&quot;&gt;Proposals&lt;&#x2F;h2&gt;
&lt;p&gt;There is a big difference between &quot;let&#x27;s do a thing!&quot; and writing out a formal description of the specifics. I have now had the chance to collaborate on a few evolution proposals and they can get incredibly complex.&lt;&#x2F;p&gt;
&lt;p&gt;I find writing to be a challenging activity in general. But, this is an entirely different kind of writing. The audience of an evolution proposal is the people that build the compiler. You have to clearly articulate what you want to do, explaining both the problem and justifying a solution &lt;strong&gt;as comprehensively as possible&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;In this specific case, I got off incredibly easy. The problem was very straightforward. The code was already written. We just had to take these things and fill in a proposal template. Which we did. A few iterations later, it felt &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;pitch-unstructured-task-and-typed-errors&#x2F;82613&quot;&gt;ready&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;twist-1-proposal&quot;&gt;Twist #1: Proposal?&lt;&#x2F;h2&gt;
&lt;p&gt;Now, here&#x27;s something I did not expect. Lots of things require the full evolution proposal process. Changing APIs or language behavior are very clear examples. But, you can fix bugs without proposals.&lt;&#x2F;p&gt;
&lt;p&gt;Our particular changes were right on the line. They were &lt;strong&gt;technically&lt;&#x2F;strong&gt; API changes, but they were changes that were basically 100% source compatible. After looking at it more closely, it turned out that a proposal, which was now already written, wasn&#x27;t actually necessary.&lt;&#x2F;p&gt;
&lt;p&gt;This might seem like a waste, but the evolution process itself is not free. It takes time and effort from people to make it happen, not to mention the additional public review process.&lt;&#x2F;p&gt;
&lt;p&gt;Plus, then you don&#x27;t have to publicly defend the idea. No one gets the opportunity to stop you!&lt;&#x2F;p&gt;
&lt;p&gt;(This is a joke. Mostly.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;twist-2-source-compatible&quot;&gt;Twist #2: Source Compatible?&lt;&#x2F;h2&gt;
&lt;p&gt;Ahh, ok so. Remember I said that the code changes were done? That was true. I also said this was source compatible. That was &lt;strong&gt;supposed&lt;&#x2F;strong&gt; to be true. But, this change failed the basic CI test.&lt;&#x2F;p&gt;
&lt;p&gt;What happens in this &quot;smoke test&quot; is a CI system builds the full Swift compiler project and associated components. There are a lot! It takes on the order of &lt;strong&gt;hours&lt;&#x2F;strong&gt; to schedule and complete. Because it takes so long, you only get about one try at it &lt;strong&gt;per day&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This test was failing, for all platforms, with a compiler crash. Which was interesting, because these changes were in the standard library exclusively. They didn&#x27;t introduce a crash, they had &lt;strong&gt;exposed&lt;&#x2F;strong&gt; one.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;debugging-the-crash&quot;&gt;Debugging the Crash&lt;&#x2F;h2&gt;
&lt;p&gt;The diagnostic information from the CI run was enough for me to get an idea of which subproject was affected. But, it had a lot of source files in it. And I know that to fix a compiler crash, an important first step is to find the smallest source example you can.&lt;&#x2F;p&gt;
&lt;p&gt;The challenge here turned out to be setting up a test environment so I could start searching. It takes &lt;strong&gt;a lot&lt;&#x2F;strong&gt; of time &lt;strong&gt;and&lt;&#x2F;strong&gt; knowledge to build the compiler infrastructure. Just the build system is incredibly complex. This problem was less about narrowing down the crash, and more about controlling how much time and effort it would take me to do it.&lt;&#x2F;p&gt;
&lt;p&gt;I experimented with a number of different options, but I ended up going for the dumbest solution possible. I transplanted a bunch of the code that used the changed APIs into a compiler test suite source file that I knew I could compile and run quickly.&lt;&#x2F;p&gt;
&lt;p&gt;It didn&#x27;t take me too long to find the offending source file, and by the time I got there my change-test loop was down to about 20 seconds. It was really just a process of slowly removing bits of code until I had the problem sufficiently narrowed down.&lt;&#x2F;p&gt;
&lt;p&gt;I filed a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift&#x2F;issues&#x2F;86391&quot;&gt;bug&lt;&#x2F;a&gt;. And then I asked for &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;help-addressing-a-crash-related-to-task-creation-api&#x2F;84028&quot;&gt;help&lt;&#x2F;a&gt;. Because while I now had a nice small example that reproduced the crash, actually fixing it was beyond my ability.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m not sure exactly how long I was expecting this to take. But it was certainly more than the 24 hours it actually took for &lt;a href=&quot;https:&#x2F;&#x2F;factorcode.org&#x2F;slava&#x2F;&quot;&gt;Slava&lt;&#x2F;a&gt; to commit a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift&#x2F;pull&#x2F;86400&quot;&gt;fix&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-finish-line&quot;&gt;The Finish Line&lt;&#x2F;h2&gt;
&lt;p&gt;A rebase to pick up the change and a few reruns of CI later, we had green tests! The PR was accepted and merged a few days later, nearly 18 months after I made that forum post. Hooray!&lt;&#x2F;p&gt;
&lt;p&gt;This whole experience was tons of fun. But, it was also kind of eye-opening. The Swift compiler is an absolutely gigantic project. And it takes an enormous amount of time to build and test. These two things make it an interesting optimization problem. You first have to narrow down the areas to work on, because you cannot possibly understand it all. And then you have to figure out how to build and test as quickly as possible. Using the naive approach, on my machine, lead to between a 10 to 90 minute process &lt;strong&gt;per iteration&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;And then, most importantly, it helps a lot when other people to do all the hard stuff.&lt;&#x2F;p&gt;
&lt;p&gt;In the end, I&#x27;m very pleased to have played a tiny part in a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift&#x2F;pull&#x2F;84802&quot;&gt;PR&lt;&#x2F;a&gt; with code I did not write, depending on a fix I did not implement, described by an evolution proposal that was never reviewed.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Versioned Package.swift Files</title>
        <published>2025-12-29T00:00:00+00:00</published>
        <updated>2025-12-29T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/blog/package-swift/"/>
        <id>https://massicotte.org/blog/package-swift/</id>
        
        <content type="html" xml:base="https://massicotte.org/blog/package-swift/">&lt;p&gt;The first thing I do when I come across a package is check out its &lt;code&gt;Package.swift&lt;&#x2F;code&gt; file. You can learn a tremendous amount about a project from these things!&lt;&#x2F;p&gt;
&lt;p&gt;I know, first and foremost, it is &lt;strong&gt;your&lt;&#x2F;strong&gt; project, so you can just do want you like. But, a &lt;code&gt;Package.swift&lt;&#x2F;code&gt; is kind of the foundation. It really matters! And lately, I&#x27;ve been seeing a trend that I cannot understand: versioned &lt;code&gt;Package.swift&lt;&#x2F;code&gt; files.&lt;&#x2F;p&gt;
&lt;p&gt;TL;DR:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;using package manifest versioning &lt;strong&gt;exclusively&lt;&#x2F;strong&gt; for tool versions has, at best, zero benefit&lt;&#x2F;li&gt;
&lt;li&gt;a package that uses tools &quot;6.x&quot; is compatible with the Swift 5 &lt;strong&gt;language mode&lt;&#x2F;strong&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;versioning&quot;&gt;Versioning&lt;&#x2F;h2&gt;
&lt;p&gt;The package manifest APIs change over time. For example, Swift 6.1 introduced this super-cool feature call &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0450-swiftpm-package-traits.md&quot;&gt;package traits&lt;&#x2F;a&gt;. These give package clients the ability to control capabilities of a dependency.&lt;&#x2F;p&gt;
&lt;p&gt;But, suppose your package supports down to Swift 5.10. You now cannot use traits, because they require new APIs. That magic line at the beginning of a &lt;code&gt;Package.swift&lt;&#x2F;code&gt; file needs to have at least &quot;6.1&quot;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&#x2F;&#x2F; swift-tools-version: 6.1
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The solution SwiftPM offers for this is a &lt;em&gt;versioned&lt;&#x2F;em&gt; &lt;code&gt;Package.swift&lt;&#x2F;code&gt; file.&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Package.swift
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Package@swift-6.0.swift
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Package@swift-5.10.swift
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Actually doing this is tricky! I had to read the &lt;a href=&quot;https:&#x2F;&#x2F;docs.swift.org&#x2F;swiftpm&#x2F;documentation&#x2F;packagemanagerdocs&#x2F;swiftversionspecificpackaging&#x2F;#Version-specific-Manifest-Selection&quot;&gt;documentation&lt;&#x2F;a&gt; quite closely just to make sure I was understanding it right.&lt;&#x2F;p&gt;
&lt;p&gt;I &lt;strong&gt;think&lt;&#x2F;strong&gt; the idea is to make your main, unversioned &lt;code&gt;Package.swift&lt;&#x2F;code&gt; the highest number you need. And then, you create versioned files for all the older ones. But, the behavior of SwiftPM resolution matters here. And testing that requires having different compiler versions installed. &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swiftly&quot;&gt;Swiftly&lt;&#x2F;a&gt; has made that much easier, but it&#x27;s still a pain. And it&#x27;s quite error-prone, because you also have to be 100% sure the system is doing what you &lt;strong&gt;actually&lt;&#x2F;strong&gt; want when you test.&lt;&#x2F;p&gt;
&lt;p&gt;All this to say you should only do this when you need it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;versioning-only-tools&quot;&gt;Versioning Only Tools&lt;&#x2F;h2&gt;
&lt;p&gt;Needing new manifest API is a &lt;strong&gt;valid&lt;&#x2F;strong&gt; use of versioned package files. But, that should be fairly rare right? So whenever I see a versioned &lt;code&gt;Package.swift&lt;&#x2F;code&gt;, I&#x27;m like &quot;oh, I wonder what&#x27;s going on here!&quot;. And, surprisingly often, I find the file contents are effectively identical aside from the tools version.&lt;&#x2F;p&gt;
&lt;p&gt;This is a &lt;strong&gt;mistake&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I would imagine the most common reason for doing this is because, absent any other configuration, a tool version does apply defaults. If you use a &quot;6.x&quot; tool version and don&#x27;t do anything else to control your settings, the compiler will assume the 6 language mode.&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s fine, and often really convenient when you have just one &lt;code&gt;Package.swift&lt;&#x2F;code&gt;. But when you have versioned package manifests, what you are doing is creating variants of your package &lt;strong&gt;that behave differently&lt;&#x2F;strong&gt; depending on compiler version. You do not want to do this.&lt;&#x2F;p&gt;
&lt;p&gt;It is actually possible to build testing infrastructure to make sure this all builds and runs correctly. But it is a lot of work for negative benefit, because your source &lt;strong&gt;still&lt;&#x2F;strong&gt; needs to be compatible with your lowest-supported version. You already have to do it! There&#x27;s extra complexity for both you and your clients here to support configurations that are unnecessary.&lt;&#x2F;p&gt;
&lt;p&gt;If you are serious about supporting older compilers and you don&#x27;t need newer manifest APIs, the right way is to get your &lt;a href=&quot;&#x2F;blog&#x2F;what-settings&quot;&gt;settings&lt;&#x2F;a&gt; sorted out in one single, unversioned &lt;code&gt;Package.swift&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;(Oh and, of course, if your README mentions concurrency support, I&#x27;m going to check to make sure you have the checks enabled. Fair warning.)&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Non-Sendable First Design</title>
        <published>2025-12-17T00:00:00+00:00</published>
        <updated>2025-12-17T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/blog/non-sendable-first-design/"/>
        <id>https://massicotte.org/blog/non-sendable-first-design/</id>
        
        <content type="html" xml:base="https://massicotte.org/blog/non-sendable-first-design/">&lt;p&gt;A while ago, I wrote a post about &lt;a href=&quot;&#x2F;non-sendable&quot;&gt;non-sendable types&lt;&#x2F;a&gt;. Then, much later, I talked about them again in a &lt;a href=&quot;&#x2F;step-by-step-conforming-to-protocols&quot;&gt;post about protocols&lt;&#x2F;a&gt;. In fact, I didn&#x27;t just talk about them, I teased a whole design approach based on non-sendable types. It&#x27;s hard to name things like this without sounding like you take yourself too seriously. I did try, but I couldn&#x27;t come up with anything better. It&#x27;s &quot;Non-Sendable First Design&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;But, I really am genuinely excited about it! Almost to the point of embarrassment.&lt;&#x2F;p&gt;
&lt;p&gt;In fact, I&#x27;ve been excited about non-sendable types for &lt;strong&gt;years&lt;&#x2F;strong&gt; at this point. Unfortunately, because of some language behavior, I thought they would be unappealing to most users. They were really useful, but they were also confusing and had pretty terrible ergonomics.&lt;&#x2F;p&gt;
&lt;p&gt;And then, to my surprise and delight, we got &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt; (AKA &quot;Approchable Concurrency&quot;). This changed everything! Suddenly, non-sendables started feeling downright natural to use.&lt;&#x2F;p&gt;
&lt;p&gt;I think that the non-sendable type&#x27;s time has finally come. To me, they really feel like &quot;the way&quot;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;quick-refresher&quot;&gt;Quick Refresher&lt;&#x2F;h2&gt;
&lt;p&gt;Before we get into all this, I want to just take a moment to review some important concepts.&lt;&#x2F;p&gt;
&lt;p&gt;Swift&#x27;s solution to data races is to guarantee, at compile time, protection of thread-unsafe data. Swift has an abstraction to model all possible ways to you could implement this protection. It is called &quot;isolation&quot;. The actual implementation might be a lock, a queue, or even a single dedicated thread. It&#x27;s the role of an &lt;strong&gt;actor&lt;&#x2F;strong&gt; to implement the protection mechanism at runtime.&lt;&#x2F;p&gt;
&lt;p&gt;The compiler does not know how specific actors work. It does not know that the &lt;code&gt;MainActor&lt;&#x2F;code&gt; actually implements its protection by funnelling all work over to the main thread. It just knows &quot;actors protect stuff&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;What stuff exactly? Well, Swift divides up all data into two gigantic groups. One is inherently safe to use anywhere, at any time, from any context. That&#x27;s the group of &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;sendable&quot;&gt;&lt;code&gt;Sendable&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; types. These things are completely thread-safe and don&#x27;t need any protection. This makes them very straight-forward to use with concurrency.&lt;&#x2F;p&gt;
&lt;p&gt;The other group is the non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types. Shared, mutable data. The stuff that makes up, often, the most interesting aspects of our programs. These things are &lt;strong&gt;not&lt;&#x2F;strong&gt; thread-safe.&lt;&#x2F;p&gt;
&lt;p&gt;Many people think of &lt;a href=&quot;&#x2F;actors&quot;&gt;actors&lt;&#x2F;a&gt; as a tool you use to run stuff &quot;in the background&quot;. But that&#x27;s actually just a (convenient, perhaps) side-effect of &lt;strong&gt;certain&lt;&#x2F;strong&gt; actors. This concept is fundmental to how the concurrency system is designed. The purpose of an actor is to protect data from races.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;getting-stuck&quot;&gt;Getting Stuck&lt;&#x2F;h2&gt;
&lt;p&gt;All the protection in the world doesn&#x27;t do much good if you can easily circumvent it. And this is a very interesting property of Swift Concurrency. If an actor owns a non-sendable type, often by creating it, it is &lt;strong&gt;stuck&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;In fact, it could be an entire &lt;strong&gt;system&lt;&#x2F;strong&gt;. A whole network of interconnected classes and protocols, all working together. Just regular old types. You can do pretty much anything with these types. But the one thing the compiler will not let you do is share them in an &lt;strong&gt;unsafe&lt;&#x2F;strong&gt; way.&lt;&#x2F;p&gt;
&lt;p&gt;This makes non-sendable types surprisingly powerful and flexible.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-pros-and-cons&quot;&gt;The Pros and Cons&lt;&#x2F;h2&gt;
&lt;p&gt;I had an &lt;strong&gt;incredibly&lt;&#x2F;strong&gt; difficult time deciding how to present all this. I experimented with a few radically-different options, and I just hated all of them. In the end, I&#x27;m going with the simplest thing I can think of. I&#x27;m just going to start by showing you all of the strengths of non-sendable types. And then, I&#x27;m going to show you the weaknesses.&lt;&#x2F;p&gt;
&lt;p&gt;I do want to note that I&#x27;m using a default of &lt;code&gt;nonisolated&lt;&#x2F;code&gt; here.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;strength-1-simplicity&quot;&gt;Strength #1: simplicity&lt;&#x2F;h3&gt;
&lt;p&gt;Here&#x27;s a class. To keep things interesting, we&#x27;ll let it have some state. As a treat.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Counter {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;reset&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Look at this! It&#x27;s just a regular old class with a single synchronous function. How could we get simpler than that?&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s just keep going!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Counter {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggle&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;+=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; Counter: Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: Counter, rhs: Counter&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There are two additions here. First, I added an asynchronous method. That might &lt;strong&gt;look&lt;&#x2F;strong&gt; normal to you too, but without &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt;, nonisolated + async meant background. But this is non-sendable type! It cannot leave the protection of an actor to even get to the background. This catch 22 made async methods on non-sendable types extremely hard to actually use.&lt;&#x2F;p&gt;
&lt;p&gt;Luckily, we now have &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt;. It makes this a non-issue. And that&#x27;s great news, because async methods open up huge amount of functionality here.&lt;&#x2F;p&gt;
&lt;p&gt;The second thing I did was add a protocol conformance. Thankfully, this actually is normal! Nothing tricky is going on. But to understand why this is interesting, you have to realize that this is &lt;strong&gt;not the case&lt;&#x2F;strong&gt; for isolated types. If this type was &lt;code&gt;MainActor&lt;&#x2F;code&gt;, it would become impossible to conform to &lt;code&gt;Equatable&lt;&#x2F;code&gt; without something like an isolated conformance.&lt;&#x2F;p&gt;
&lt;p&gt;Now, it is true that the isolated conformance feature can become implicit, via &lt;code&gt;InferIsolatedConformances&lt;&#x2F;code&gt;. And while that is very useful, the essential complexity hasn&#x27;t gone away. The compiler has just gotten smart enough to hide it from you &lt;strong&gt;provided&lt;&#x2F;strong&gt; your usage is compatible.&lt;&#x2F;p&gt;
&lt;p&gt;Here is the key take away: this kind of type has a simplicity that an isolated type does not.&lt;&#x2F;p&gt;
&lt;p&gt;(You can read more about this behavior in that &lt;a href=&quot;&#x2F;step-by-step-conforming-to-protocols&quot;&gt;post on protocols&lt;&#x2F;a&gt; I mentioned if you want to understand more deeply.)&lt;&#x2F;p&gt;
&lt;h3 id=&quot;strength-2-generality&quot;&gt;Strength #2: generality&lt;&#x2F;h3&gt;
&lt;p&gt;This is something that takes a moment to realize. It all has to do with synchronous access.&lt;&#x2F;p&gt;
&lt;p&gt;If a type is isolated you can only have synchronous access when the isolation matches. A &lt;code&gt;@MainActor&lt;&#x2F;code&gt; type can be synchronously accessed, only, by other &lt;code&gt;@MainActor&lt;&#x2F;code&gt; things. Let&#x27;s take a look at how this affects clients.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor ActorClient {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; counter &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Counter()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;accessSynchronously&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		counter&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;reset() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; &amp;lt;- this is possible!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This actor can access &lt;code&gt;counter&lt;&#x2F;code&gt; synchronously! But, if &lt;code&gt;counter&lt;&#x2F;code&gt; were isolated, perhaps with &lt;code&gt;@MainActor&lt;&#x2F;code&gt; or as an actor itself, this would not be possible.&lt;&#x2F;p&gt;
&lt;p&gt;A non-sendable type is very general. Its interface remains the same, regardless of the actor that owns it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;weakness-1-starting-tasks&quot;&gt;Weakness #1: Starting Tasks&lt;&#x2F;h2&gt;
&lt;p&gt;This next topic was actually the thing that led me to thinking about non-sendable types in the first place. Take a look at this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Counter {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;printStateEventually&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; error: Passing closure as a &amp;#39;sending&amp;#39; parameter...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;mark&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			print(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;mark&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This code actually does not compile. To understand why, let&#x27;s look at a fairly literal translation to GCD. I do this frequently, because the two systems have very similar concepts.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Counter {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;printStateEventually&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;global()&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; warning: Capture of &amp;#39;self&amp;#39; with non-Sendable type &amp;#39;Counter&amp;#39; in a &amp;#39;@Sendable&amp;#39; closure&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;mark&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			print(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;mark&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We are accessing &lt;code&gt;self&lt;&#x2F;code&gt; here on some background queue. Why is it a background queue? Because with Swift&#x27;s concurrency system, &quot;what queue&quot; is defined by the type system. And here, we have a nonisolated function, which is means &quot;the queue is not defined&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;It is &lt;strong&gt;not possible&lt;&#x2F;strong&gt; to guarantee thread safety without more work here.&lt;&#x2F;p&gt;
&lt;p&gt;Queue management is very important when working with thread-unsafe types. It is also interesting that this code does compile, but produces a warning. That&#x27;s because all of the Dispatch APIs have been annotated with &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;&lt;code&gt;@preconcurrency&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, which downgrades concurrency errors into warnings.&lt;&#x2F;p&gt;
&lt;p&gt;(It is vital to remember, however, that GCD has the ability to synchronously capture and preserve ordering. Swift has no language primitives to do something exactly equivalent.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-solution-to-starting-tasks&quot;&gt;A Solution to Starting Tasks&lt;&#x2F;h2&gt;
&lt;p&gt;This problem kicked off a lot of research on my part. At the time, I was thinking about it purely from a &quot;how the heck do I make the compiler happy&quot; perspective. But, actually, there&#x27;s more to it that this.&lt;&#x2F;p&gt;
&lt;p&gt;You know when someone says &quot;well &lt;em&gt;actually&lt;&#x2F;em&gt; you shouldn&#x27;t be doing that in the first place&quot;. Often, this isn&#x27;t helpful. Because making use of this information, even if correct, means you need to re-design things. Things that might be out of your control. Or, that you just don&#x27;t feel like doing.&lt;&#x2F;p&gt;
&lt;p&gt;Yeah. Well.&lt;&#x2F;p&gt;
&lt;p&gt;With GCD, to handle this problem, we need to return to the same queue that we started on. This typically forces us to either use a statically-defined queue, like &lt;code&gt;main&lt;&#x2F;code&gt;, or grab a queue and store it as an instance variable. Both of these patterns are super-common in GCD-based code.&lt;&#x2F;p&gt;
&lt;p&gt;A global actor is, in many ways, just a statically-defined queue that the compiler makes sure you cannot forget to use. And using &lt;code&gt;MainActor&lt;&#x2F;code&gt; here does work. But, it&#x27;s annoying! Because there might be nothing &quot;main thread&quot; about this thing. We have to sacrifice generality.&lt;&#x2F;p&gt;
&lt;p&gt;A queue instance variable, on the other hand, is pretty interesting. Except Swift&#x27;s concurrency system doesn&#x27;t have anything exactly like that.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Counter {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;printStateEventually&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;isolation: isolated any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			_ &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; isolation &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ???&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			print(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Swift does have a way to capture &quot;where you were&quot; so that you can get back. It is an isolated parameter. You can use them to solve this problem, but they come with &lt;strong&gt;three&lt;&#x2F;strong&gt; downsides.&lt;&#x2F;p&gt;
&lt;p&gt;First, it burdens the caller with supplying the owning actor. What if the caller doesn&#x27;t have that information? Then it would, itself, need an isolated parameter. These are viral!&lt;&#x2F;p&gt;
&lt;p&gt;Second, due to a very long-standing quirk with how isolation inheritance works, you &lt;strong&gt;must&lt;&#x2F;strong&gt; capture the parameter inside the &lt;code&gt;Task&lt;&#x2F;code&gt; body to make it all work. Thankfully, this is a well-known pain point and I have confidence this will eventually just be fixed. There has already been some &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;closure-isolation-control&#x2F;70378&quot;&gt;work&lt;&#x2F;a&gt; done here.&lt;&#x2F;p&gt;
&lt;p&gt;But if all that doesn&#x27;t turn you off, there&#x27;s another, deeper problem.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;starting-tasks-is-fraught&quot;&gt;Starting Tasks is Fraught&lt;&#x2F;h2&gt;
&lt;p&gt;Remember when I said that people told me I should not be creating new unstructured tasks within a type like this? Well, it annoys me to say it, but I think they are right.&lt;&#x2F;p&gt;
&lt;p&gt;At first, I found it very frustrating that the language was making this so difficult. But, I&#x27;ve now come around. I actually think this is an example of &lt;strong&gt;syntactic salt&lt;&#x2F;strong&gt;. Yes, it is possible, but actively discouraging people from doing it makes sense.&lt;&#x2F;p&gt;
&lt;p&gt;Starting work that callers cannot actively wait for can be very problematic. It is very hard to observe, which at the bare minimum, makes it hard to test. What you should actually consider is an async method. Stay in the structured concurrency world. And, if for some reason that&#x27;s a problem for the caller, &lt;strong&gt;they&lt;&#x2F;strong&gt; can make the &lt;code&gt;Task&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;So, after all that, is this really a weakness? I think, ultimately, it is appropriately difficult.&lt;&#x2F;p&gt;
&lt;p&gt;(June also noticed and wrote about a &lt;a href=&quot;https:&#x2F;&#x2F;www.junebash.com&#x2F;posts&#x2F;task-management-in-swift-part-1-the-problem&#x2F;&quot;&gt;similar phenomenon&lt;&#x2F;a&gt; you might be interested in. Wrapping &lt;code&gt;Task&lt;&#x2F;code&gt; creation is tricky business.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;weakness-2-weird-properties&quot;&gt;Weakness #2: &quot;weird properties&quot;&lt;&#x2F;h2&gt;
&lt;p&gt;Swift has a number of ways to define, for lack of a better term, weird properties. Things like property wrappers, macros, and even lazy vars. These make it possible to create situations that are extremely difficult to support &lt;strong&gt;if&lt;&#x2F;strong&gt; the properties themselves have complex concurrency requirements.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Counter {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;lazy&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;internal&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		SpecialCounter(isolatedParam: ???)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That&#x27;s a big &quot;if&quot;, but it&#x27;s at least something to be aware of. I discovered this while building a real system. These situations are quite rare, and it could be this is another of those &quot;just don&#x27;t do that&quot; kinds of things. But, if you go deep with this stuff, it could come up. Fair warning.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;first-for-a-reason&quot;&gt;&quot;First&quot; for a Reason&lt;&#x2F;h2&gt;
&lt;p&gt;This idea all is about a place to &lt;strong&gt;start&lt;&#x2F;strong&gt;. And I think it&#x27;s very fitting to start with the simplest and more &quot;regular&quot; kind of thing: &lt;code&gt;nonisolated&lt;&#x2F;code&gt;, thread-unsafe types.&lt;&#x2F;p&gt;
&lt;p&gt;Now, I know, for a fact, someone read &lt;code&gt;nonisolated&lt;&#x2F;code&gt; there and immediately started thinking &quot;lol, simple&quot;. But I want to stop you right there.&lt;&#x2F;p&gt;
&lt;p&gt;Before Swift 5.5 came along, there was no such thing as isolation. Literally every type, global variable, and all other declarations you can think of were nonisolated. Including from Objective-C and C.&lt;&#x2F;p&gt;
&lt;p&gt;&quot;Nonisolated&quot; is normal. It&#x27;s just an unfamiliar concept.&lt;&#x2F;p&gt;
&lt;p&gt;But, as soon as you run into even a tiny bit of concurrency, things can change. And when that happens, maybe a non-sendable type is no longer the right choice. Sometimes, this is obvious. Having trouble accessing &lt;code&gt;MainActor&lt;&#x2F;code&gt; stuff? Maybe your type needs to be &lt;code&gt;MainActor&lt;&#x2F;code&gt; too. Trying to kick asynchronous work without context? This is hard for good reason, so think carefully about it.&lt;&#x2F;p&gt;
&lt;p&gt;But there are so many situations where a plain old non-sendable type is a perfect fit. In fact, now that we have &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt;, the number of types that truly need to be &lt;code&gt;MainActor&lt;&#x2F;code&gt; is lower than ever. Even traditionally-&lt;code&gt;MainActor&lt;&#x2F;code&gt; things like &lt;code&gt;ObservableObject&lt;&#x2F;code&gt; and &lt;code&gt;@Observable&lt;&#x2F;code&gt; can sometimes avoid it.&lt;&#x2F;p&gt;
&lt;p&gt;Isolation, don&#x27;t forget, is a &lt;strong&gt;constraint&lt;&#x2F;strong&gt;. Adding it, either explicitly or implicitly as a default changes the nature of the type in a profound way. The constraint can have considerable implications, particularly when protocols and subclassing are involved.&lt;&#x2F;p&gt;
&lt;p&gt;Side-stepping the problem entirely, with a simpler type no less, almost feels like cheating.&lt;&#x2F;p&gt;
&lt;p&gt;And that&#x27;s why I&#x27;d recommend starting here. If it gets hard or confusing or you don&#x27;t like it for some reason, just move on. It won&#x27;t work for every situation. But when it does, it&#x27;s really nice.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>What Setting Should I Use?</title>
        <published>2025-12-05T00:00:00+00:00</published>
        <updated>2025-12-05T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/blog/what-settings/"/>
        <id>https://massicotte.org/blog/what-settings/</id>
        
        <content type="html" xml:base="https://massicotte.org/blog/what-settings/">&lt;p&gt;There was a time when compiler settings were something I totally ignored. I didn&#x27;t follow along with upcoming features at all. I just used the defaults and didn&#x27;t think about it. But that&#x27;s a lot harder to get away with right now. We&#x27;re in a protracted period where not only are settings very important, they are also deeply and persistently misunderstood.&lt;&#x2F;p&gt;
&lt;p&gt;The settings you use can have a &lt;strong&gt;profound&lt;&#x2F;strong&gt; effect on your code.&lt;&#x2F;p&gt;
&lt;p&gt;But there are a lot of them! And I think it&#x27;s pretty reasonable that you might not want to dig into every single one. So, here&#x27;s an attempt at some guidance.&lt;&#x2F;p&gt;
&lt;p&gt;TL;DR:&lt;&#x2F;p&gt;
&lt;p&gt;There are 21 settings, but only 5 are of any real concern.&lt;&#x2F;p&gt;
&lt;p&gt;You can just ignore these for now: &lt;code&gt;ExistentialAny&lt;&#x2F;code&gt;, &lt;code&gt;InternalImportsByDefault&lt;&#x2F;code&gt;, &lt;code&gt;MemberImportVisibility&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;These are definitely worth consideration, but may require understanding: &lt;code&gt;InferIsolatedConformances&lt;&#x2F;code&gt;, &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;These are the big ones from the 6 language mode and have serious implications: &lt;code&gt;DynamicActorIsolation&lt;&#x2F;code&gt;, &lt;code&gt;GlobalConcurrency&lt;&#x2F;code&gt; &lt;code&gt;StrictConcurrency&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Technically a mode, and one many people have trouble with: &lt;code&gt;DefaultActorIsolation&lt;&#x2F;code&gt; of &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;You can, and probably should, just turn everything else on.&lt;&#x2F;p&gt;
&lt;p&gt;More details? Ok let&#x27;s go.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;compiler-version&quot;&gt;Compiler version&lt;&#x2F;h2&gt;
&lt;p&gt;On a surprisingly regular basis, someone will tell me they using Swift 5.10. And I get to ask, as politely as I am able, &quot;are you sure about that?&quot;. Because the Swift compiler is bundled with Xcode. To have Swift 5.10, you&#x27;d need to be using Xcode 15, which you are almost certainly not doing.&lt;&#x2F;p&gt;
&lt;p&gt;The source of this confusion is very understandable though. The Swift compiler, for a very long time now, has a concept of &quot;language mode&quot;. Swift 6.2, the version included with Xcode 26, supports &lt;strong&gt;four&lt;&#x2F;strong&gt; language modes: 4, 4.2, 5, and 6. That&#x27;s right, it still supports a language mode from 2017. But a language mode is, typically, just an alias for a big group of settings. Instead of having to flip on all the settings that went into the 4.2 and 5.0 releases individually, you can just set &quot;5 mode&quot; and be done.&lt;&#x2F;p&gt;
&lt;p&gt;(There actually are people that, for various reasons, do in fact use old build environments. But, I&#x27;m not sure how relevant this is to general discussion since it represents a pretty special case.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;language-mode&quot;&gt;Language Mode&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;m just going to guess that you want either the 5 or 6 language modes. For Xcode targets, you must use the Xcode setting &lt;code&gt;SWIFT_VERSION&lt;&#x2F;code&gt;. Now that the term &quot;Language Mode&quot; has been &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0441-formalize-language-mode-terminology.md&quot;&gt;formalized&lt;&#x2F;a&gt;, I think it&#x27;s about time that Xcode adopt this terminology. Please.&lt;&#x2F;p&gt;
&lt;p&gt;Controlling language mode for your Swift packages is completely independent of your Xcode settings. There are a &lt;a href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;migration&#x2F;documentation&#x2F;swift-6-concurrency-migration-guide&#x2F;enabledataracesafety&#x2F;&quot;&gt;variety of ways&lt;&#x2F;a&gt; to do this in SPM. But my personal favorite is to use the simplicity of the defaults provided by &lt;code&gt;swift-tools-version&lt;&#x2F;code&gt; when I can, and an explicit &lt;code&gt;.swiftLanguageMode&lt;&#x2F;code&gt; otherwise.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;aside-versioned-package-swift-files&quot;&gt;Aside: Versioned Package.swift files&lt;&#x2F;h2&gt;
&lt;p&gt;A phenomenon I have starting running into more and more are versioned Package.swift files. It looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Package.swift
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Package@6.2.0.swift
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I believe this purpose of this is to give you a way to a) use SPM Package description APIs that aren&#x27;t available with b) earlier Swift toolchains that you need to support. However, that&#x27;s an unusual thing to need! So I often peek inside to see what&#x27;s going on. And frequently, I discover that no new package description APIs are actually being used. This is bad because, aside from the extra complexity, it has the potential to introduce build configurations that you &quot;support&quot; but never actually test.&lt;&#x2F;p&gt;
&lt;p&gt;If you are using versioned package files, it&#x27;s worth checking in to make sure it is doing what you want.&lt;&#x2F;p&gt;
&lt;p&gt;(A very powerful new feature in Swift 6.1, &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0450-swiftpm-package-traits.md&quot;&gt;package traits&lt;&#x2F;a&gt;, is now becoming more common in the server community in particular. This is a very valid reason to use versioned Package.swift files. But today, traits are not supported by Xcode.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;settings&quot;&gt;Settings&lt;&#x2F;h2&gt;
&lt;p&gt;At the time of writing, the current public release of Swift supports a total of 21 &lt;strong&gt;upcoming features&lt;&#x2F;strong&gt;. This means these things will all, eventually, become &quot;the way&quot;. Of these 16 are part of the 6 language mode. We can assume that one day, some even newer language mode will be added, say 7, which will enable the remaining 5.&lt;&#x2F;p&gt;
&lt;p&gt;Language modes are &lt;strong&gt;pretty much&lt;&#x2F;strong&gt; just groups of settings. But, there is exactly one difference (I know of) between the 5 and 6 modes that isn&#x27;t a setting. In 6 mode, concurrency warnings become errors. Aside from that, it&#x27;s possible to get all of the changes of 6 while still technically being in 5 mode.&lt;&#x2F;p&gt;
&lt;p&gt;Xcode 16 gained the ability to control Swift compiler features via build settings, which is a lot nicer than having to pass around compiler flags. Again, the story for SPM is more complex. I often use &lt;a href=&quot;https:&#x2F;&#x2F;useyourloaf.com&#x2F;blog&#x2F;strict-concurrency-checking-in-swift-packages&#x2F;&quot;&gt;this technique&lt;&#x2F;a&gt; from &lt;a href=&quot;https:&#x2F;&#x2F;useyourloaf.com&#x2F;about&#x2F;&quot;&gt;Keith Harrison&lt;&#x2F;a&gt;. It&#x27;s particularly useful for packages with a lot of targets.&lt;&#x2F;p&gt;
&lt;p&gt;It is, however, very important to understand that your Xcode and SPM build settings are &lt;strong&gt;independent&lt;&#x2F;strong&gt;. Changes to one will not impact the other. And, further, changes to your projects&#x2F;modules will not impact your dependencies. Those are under the control of their authors.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;far-off-things-you-can-ignore&quot;&gt;Far Off Things You can Ignore&lt;&#x2F;h2&gt;
&lt;p&gt;Now, finally, we can actually have a look at some of these settings. Let&#x27;s start with the features that are the furthest out.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;docs.swift.org&#x2F;compiler&#x2F;documentation&#x2F;diagnostics&#x2F;existential-any&quot;&gt;&lt;code&gt;ExistentialAny&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;docs.swift.org&#x2F;compiler&#x2F;documentation&#x2F;diagnostics&#x2F;member-import-visibility&quot;&gt;&lt;code&gt;MemberImportVisibility&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0409-access-level-on-imports.md&quot;&gt;&lt;code&gt;InternalImportsByDefault&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;You can read about these if you want. They solve real problems and could be helpful for you. Or maybe you&#x27;d like to get a jump on future-proofing your code. But, there&#x27;s no pressure here to do anything.&lt;&#x2F;p&gt;
&lt;p&gt;I would classify all three of these as &lt;strong&gt;totally safe to ignore&lt;&#x2F;strong&gt;. Easy.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;far-off-things-you-should-think-about&quot;&gt;Far Off Things You Should Think About&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;inferisolatedconformances&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0470-isolated-conformances.md&quot;&gt;&lt;code&gt;InferIsolatedConformances&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;Basically, &lt;code&gt;MainActor&lt;&#x2F;code&gt;&#x27;ing stuff might cause problems with protocol conformances and this feature can make those problems go away. It&#x27;s cool.&lt;&#x2F;p&gt;
&lt;p&gt;However, I still have limited experience with this one. I&#x27;d say I&#x27;m only about &lt;strong&gt;75%&lt;&#x2F;strong&gt; sure that this is a good idea for people that don&#x27;t understand it. The feature does have the &lt;strong&gt;potential&lt;&#x2F;strong&gt; to result in some hard-to-understand-and-fix issues. But, I&#x27;m not sure yet if that&#x27;s actually a real problem or just theoretical.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;nonisolatednonsendingbydefault&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0461-async-function-isolation.md&quot;&gt;&lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;This changes the semantics of nonisolated async functions. This is my favorite feature of Swift 6.2, and often the only setting of consequence when people talk about &quot;Approachable Concurrency&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s a quick test:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; SomeClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;asyncMethod&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If you know when&#x2F;why a type like this can be a problem, then you can adopt this setting at your leisure. However, if you are looking at this code and thinking &quot;ummm this is just a normal class?&quot; then I think you almost certainly &lt;strong&gt;need&lt;&#x2F;strong&gt; to enable this feature so the language works like you think it does.&lt;&#x2F;p&gt;
&lt;p&gt;You can &lt;a href=&quot;https:&#x2F;&#x2F;docs.swift.org&#x2F;compiler&#x2F;documentation&#x2F;diagnostics&#x2F;nonisolated-nonsending-by-default&quot;&gt;read more&lt;&#x2F;a&gt; about this. And that&#x27;s important to do, because opting into this one may require a migration and that documentation explains how to do it.&lt;&#x2F;p&gt;
&lt;p&gt;Also, don&#x27;t forget that &quot;Approachable Concurrency&quot; is an Xcode thing, so you&#x27;ll still have to use this setting directly within SPM.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;6-mode-stuff-you-should-just-turn-on&quot;&gt;6 Mode Stuff You Should Just Turn On&lt;&#x2F;h2&gt;
&lt;p&gt;These are all settings that are enabled by 6 language mode. They are also, in my opinion, &lt;strong&gt;very unlikely&lt;&#x2F;strong&gt; to introduce any source incompatibilities in your project. If you turn them on and everything continues to build, you should be just fine. Some of these will also be very useful when using concurrency, but should not matter if you aren&#x27;t interested in that stuff.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;BareSlashRegexLiterals&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;ConciseMagicFile&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;DeprecateApplicationMain&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;ForwardTrailingClosures&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;ImplicitOpenExistentials&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;ImportObjcForwardDeclarations&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;NonfrozenEnumExhaustivity&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;DisableOutwardActorInference&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;GlobalActorIsolatedTypesUsability&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;InferSendableFromCaptures&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;RegionBasedIsolation&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;IsolatedDefaultValues&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;There&#x27;s &lt;a href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;migration&#x2F;documentation&#x2F;swift-6-concurrency-migration-guide&#x2F;sourcecompatibility&quot;&gt;documentation&lt;&#x2F;a&gt; about all the settings that apply to 6 mode specifically if you want to learn about any of these. But for these I don&#x27;t even think that is necessary.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;6-mode-stuff-you-cannot-just-turn-on&quot;&gt;6 Mode Stuff You Cannot Just Turn On&lt;&#x2F;h2&gt;
&lt;p&gt;These last three are also enabled by the 6 language mode. None of these are easy decisions and you should not enable them without understanding what they do.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;globalconcurrency&quot;&gt;&lt;code&gt;GlobalConcurrency&lt;&#x2F;code&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;Applies concurrency-safety rules to global values. This will almost certainly introduce some concurrency warnings. But nothing like what can happen with complete checking.&lt;&#x2F;p&gt;
&lt;p&gt;This is not a bad way to ease into a Swift 6 migration. Often the problems this finds are easy to fix. But, this setting only covers a small fraction of what &lt;code&gt;StrictConcurrency&lt;&#x2F;code&gt; does. Also, because you aren&#x27;t seeing the full picture, it can sometimes be hard to understand the implications of any changes you make.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;dynamicactorisolation&quot;&gt;&lt;code&gt;DynamicActorIsolation&lt;&#x2F;code&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;This is a hugely-consequential settings. It will transform potential data races into runtime crashes. You &lt;strong&gt;must&lt;&#x2F;strong&gt; understand the implications of this before enabling it directly, or indirectly via 6 mode. I cover the general idea as it &lt;a href=&quot;&#x2F;combine-annotations&quot;&gt;applies to Combine&lt;&#x2F;a&gt;, but all APIs can be subject to this problem.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;strictconcurrency&quot;&gt;&lt;code&gt;StrictConcurrency&lt;&#x2F;code&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;This is the big dial for how much concurrency checking you want to see. 6 mode sets this to &quot;complete&quot;, but I think &quot;targeted&quot; has a lot of value as well.&lt;&#x2F;p&gt;
&lt;p&gt;Leaving this setting at &quot;minimal&quot; &lt;strong&gt;while also&lt;&#x2F;strong&gt; using the &lt;code&gt;async&lt;&#x2F;code&gt; or &lt;code&gt;await&lt;&#x2F;code&gt; keywords is &lt;a href=&quot;&#x2F;complete-checking&quot;&gt;risky&lt;&#x2F;a&gt;. It is very hard to use a compiler-based concurrency system correctly when the compiler&#x27;s checks are disabled. But as I wrote above, turning on &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt; can transform some correctness issues into performance problems. I think that&#x27;s probably the right trade-off if you are using minimal.&lt;&#x2F;p&gt;
&lt;p&gt;It is worth noting that setting this to &quot;complete&quot; will implicitly enable &lt;code&gt;IsolatedDefaultValues&lt;&#x2F;code&gt;, &lt;code&gt;GlobalConcurrency&lt;&#x2F;code&gt;, and &lt;code&gt;RegionBasedIsolation&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;defaultactorisolation&quot;&gt;&lt;code&gt;DefaultActorIsolation&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;This is &lt;strong&gt;not&lt;&#x2F;strong&gt; an upcoming feature. It is not a part of Xcode&#x27;s &quot;Approchable Concurrency&quot; setting. It is a permanent mode that will always be optional. In Xcode you use &lt;code&gt;SWIFT_DEFAULT_ACTOR_ISOLATION&lt;&#x2F;code&gt; and in SPM you do it with the special &lt;code&gt;.defaultIsolation&lt;&#x2F;code&gt; setting.&lt;&#x2F;p&gt;
&lt;p&gt;I think you should &lt;a href=&quot;&#x2F;blog&#x2F;mainactor-by-default&quot;&gt;tread very carefully&lt;&#x2F;a&gt; here. You should also be aware that setting the default isolation to &lt;code&gt;MainActor&lt;&#x2F;code&gt; has the side-effect of implicitly enabling &lt;code&gt;InferIsolatedConformances&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;recommendations&quot;&gt;&quot;Recommendations&quot;&lt;&#x2F;h2&gt;
&lt;p&gt;Turn on the easy stuff. Ignore the far off stuff. You have to understand the implications of the others before you flip the switch. And you should feel good about taking your time. If dealing with all this isn&#x27;t something you want to do, you can definitely wait.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>MainActor by Default</title>
        <published>2025-11-20T00:00:00+00:00</published>
        <updated>2025-11-20T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/blog/mainactor-by-default/"/>
        <id>https://massicotte.org/blog/mainactor-by-default/</id>
        
        <content type="html" xml:base="https://massicotte.org/blog/mainactor-by-default/">&lt;p&gt;Swift 6.2 gives you the ability make &lt;code&gt;MainActor&lt;&#x2F;code&gt; the default isolation. Unlike the rest of the features introduced as part of &quot;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;visions&#x2F;approachable-concurrency.md&quot;&gt;Approachable Concurrency&lt;&#x2F;a&gt;&quot;, this is a long-term mode. It is optional and will remain so. However, this mode is enabled for new app targets in Xcode 26. And many people take this as a very strong signal from Apple, myself included.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve written about this feature &lt;a href=&quot;&#x2F;default-isolation-swift-6_2&quot;&gt;before&lt;&#x2F;a&gt;. And I ended that post with a question:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;And this brings us to a tough choice. Swift 6.2 gives us the ability to set the default to &lt;code&gt;@MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But should we?&lt;&#x2F;p&gt;
&lt;p&gt;... I need more experience trying this out with real systems before I make up my mind.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Well I have made up my mind, at least for now. We should not. I&#x27;m not sure we should even have the ability to do so.&lt;&#x2F;p&gt;
&lt;p&gt;First, I want to acknowledge that there are situations, especially around global state and single-file programs, where this mode can help tremendously. In some circumstances, it really can push off your exposure to concurrency, perhaps even hide it entirely. I have not seen any other suggestions that would solve some of same kinds of problems. But when you finally encounter concurrency, &lt;strong&gt;and you almost certainly will&lt;&#x2F;strong&gt;, a default of &lt;code&gt;MainActor&lt;&#x2F;code&gt; can make those encounters much more difficult to understand and address.&lt;&#x2F;p&gt;
&lt;p&gt;Changing the default isolation fundamentally alters the nature of a program&#x27;s relationship with the concurrency system. It demands you now be able to &lt;strong&gt;recognize&lt;&#x2F;strong&gt; and &lt;strong&gt;understand&lt;&#x2F;strong&gt; when &lt;code&gt;MainActor&lt;&#x2F;code&gt; is inappropriate. This can be very difficult.&lt;&#x2F;p&gt;
&lt;p&gt;Of course, then you also need to actually know how to &lt;strong&gt;remove&lt;&#x2F;strong&gt; it. Doing this often requires a very deep understanding, particularly when type hierarchies with protocols are involved.&lt;&#x2F;p&gt;
&lt;p&gt;And then there&#x27;s the fact that this is a language mode. You will &lt;strong&gt;never&lt;&#x2F;strong&gt; be able to work with one mode exclusively, because at the minimum, Apple will not adopt this for their own libraries. I think it is unlikely you will ultimately adopt it for all of your own modules either.&lt;&#x2F;p&gt;
&lt;p&gt;In short, understanding why &lt;code&gt;MainActor&lt;&#x2F;code&gt; is needed is &lt;strong&gt;far simpler&lt;&#x2F;strong&gt; than understanding why or how to remove it. It&#x27;s possible I change my mind in the future. And I&#x27;m not saying you cannot use this mode with success. I&#x27;m saying right now I don&#x27;t think it&#x27;s a good choice, especially for people just getting started.&lt;&#x2F;p&gt;
&lt;p&gt;(I also did a &lt;a href=&quot;https:&#x2F;&#x2F;youtu.be&#x2F;eqeDPIK2Msc&quot;&gt;talk&lt;&#x2F;a&gt; that touches on this if that&#x27;s interesting.)&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>A Prank Ten Years in the Making</title>
        <published>2025-11-19T00:00:00+00:00</published>
        <updated>2025-11-19T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/blog/ten-year-prank/"/>
        <id>https://massicotte.org/blog/ten-year-prank/</id>
        
        <content type="html" xml:base="https://massicotte.org/blog/ten-year-prank/">&lt;p&gt;Not too long ago, I ran into a surprise. But it was not just a run-of-the-mill &quot;oh, look at that!&quot; kind of surprise. This was a surprise so bizarre and so delightful I still find myself reeling every time I think about it.&lt;&#x2F;p&gt;
&lt;p&gt;I just have to share.&lt;&#x2F;p&gt;
&lt;p&gt;It all starts with me, at my computer. As it happens, that day I found myself writing a shell script. I don&#x27;t really enjoy shell scripting, but I was trying to tackle some little one-off automation task. The details of the script aren&#x27;t particularly important. What&#x27;s important was an error message that I encountered while running it.&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;task.sh: line 4: Kittens1: command not found
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&quot;Kittens1: command not found&quot;. This output was, to put it mildly, unexpected.&lt;&#x2F;p&gt;
&lt;p&gt;I immediately looked back and the source, and to my &lt;strong&gt;absolute astonishment&lt;&#x2F;strong&gt;, I found this on line 4:&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;BASEDIR=`Kittens1`
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The contents of this script file was written entirely by me, within the last 10 minutes. Not a single character came from anywhere other that my keyboard. I wrote it myself. And I assure you, dear reader, I did not type the characters &quot;Kittens1&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;But, I certainly &lt;strong&gt;recognized&lt;&#x2F;strong&gt; them.&lt;&#x2F;p&gt;
&lt;p&gt;See, I have to confess there was a dumb gag I would pull, very occasionally. What I would do is type &quot;Kittens1&quot; into a group chat. And then immediately follow up with &quot;oh shoot sorry wrong window&quot;. The joke being that this is a password I use, and I accidentally targeted the wrong text box. It&#x27;s a thing that happens! But I know, it&#x27;s stupid and honestly kind of embarrassing. I think I did it maybe 3 times total, not that this redeems me much.&lt;&#x2F;p&gt;
&lt;p&gt;You know what else? I haven&#x27;t done this in a long time. It has been approximately &lt;strong&gt;10 years&lt;&#x2F;strong&gt; since I have subjected a coworker to this inane routine. And yet, somehow, this very secure &quot;password&quot; of mine has ended up in my shell script &lt;strong&gt;without me even typing it&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The wave of confusion rapidly transitioned into a combination of shear delight, awe, and intense curiosity.&lt;&#x2F;p&gt;
&lt;p&gt;&quot;How ON EARTH did this happen?&quot;&lt;&#x2F;p&gt;
&lt;p&gt;What I had &lt;strong&gt;intended&lt;&#x2F;strong&gt; this line of code to look like turns out to be a very important part of this story. Here&#x27;s what I actually typed:&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;BASEDIR=`pwd`
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I was trying to capture the current working directory with &quot;pwd&quot;. And somehow, somehow, that had been transformed. But at this point I was ready to believe just about anything. So I replaced &quot;Kittens1&quot; with &quot;pwd&quot;, saved the file, closed it. I honestly don&#x27;t know if I expected &quot;Kittens1&quot; to return or not. But upon reopening I found that my file was unmodified. &quot;pwd&quot; remained.&lt;&#x2F;p&gt;
&lt;p&gt;I tried re-typing. Different combinations of syntax. Re-running it. Nothing. Nothing I did would make &quot;Kittens1&quot; re-appear. And so of course I drop everything. I&#x27;m sure you will understand that getting to the bottom of this was now the singular purpose of my life.&lt;&#x2F;p&gt;
&lt;p&gt;I began to get a little nervous too. Have I been hacked somehow? What does that even mean? I have to admit there&#x27;s a delicious irony in being pwned with a lame password joke. But the idea was also kind of terrifying.&lt;&#x2F;p&gt;
&lt;p&gt;WHAT. IN THE HOLY HELL. IS HAPPENING?&lt;&#x2F;p&gt;
&lt;p&gt;I re-traced my steps. I reviewed why I was writing the script, and what, very specifically I&#x27;d done to create the text within this file. And I remembered I did in fact do something a little strange. I put some of the code, very temporarily, into a note-taking app I use. This app, &lt;a href=&quot;https:&#x2F;&#x2F;simplenote.com&quot;&gt;Simplenote&lt;&#x2F;a&gt;, turns out to be another important player here. See I&#x27;d tried copy-pasting code within the text editor I was using already. But lo and behold, when I pasted the text into Simplenote, the characters &quot;pwd&quot;, and only those characters, were &lt;strong&gt;automatically&lt;&#x2F;strong&gt; transformed into &quot;Kittens1&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;Ok. But. Ummm, &lt;strong&gt;WHY??&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;So, in Simplenote, I typed &quot;p&quot;, &quot;w&quot;, and when I hit &quot;d&quot; a little text replacement pop-up showed up suggested &quot;Kittens1&quot;. Text replacement! So I head over to the keyboard settings in macOS. Sure enough within the text replacement list is a mapping from &quot;pwd&quot; to &quot;Kittens1&quot;. My guess is this is a quirk of how Simplenote handles paste operations, because it is the only app I can find that applies these transformations automatically like this.&lt;&#x2F;p&gt;
&lt;p&gt;What I did was paste in the code, &lt;strong&gt;not notice the transformation was applied&lt;&#x2F;strong&gt; and then recopied the code back to my shell script. So one mystery is now understood. But a new one now has presented itself.&lt;&#x2F;p&gt;
&lt;p&gt;Where, &lt;strong&gt;exactly&lt;&#x2F;strong&gt;, did this text replacement entry come from?&lt;&#x2F;p&gt;
&lt;p&gt;At this point, I can only theorize. But here&#x27;s my best guess. A decade ago, when I last did this password joke nonsense, I must have left my computer unlocked at some point. A (just wonderful) coworker then added this entry as (deserved) payback. But then, how did it get onto my personal, current machine?&lt;&#x2F;p&gt;
&lt;p&gt;Well I looked it up, and yes, text replacements can sync over iCloud.&lt;&#x2F;p&gt;
&lt;p&gt;So there we go. This little booby-trap has been sitting there for &lt;strong&gt;10 YEARS&lt;&#x2F;strong&gt;, hoping from machine to machine, just waiting for the perfect sequence of events to trip. Thank goodness I didn&#x27;t notice the replacement earlier or change note-taking applications and ruin everything. I don&#x27;t know who exactly did this, or if in their wildest dreams they could have imagined it would be so slow-played and so successful a prank. But hats off because this was just legendary. What a gift.&lt;&#x2F;p&gt;
&lt;p&gt;In celebration and recognition, I have left the text replacement in place. Including, of course, the capital K and 1. For security.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>The Problem With Combine Annotations</title>
        <published>2025-10-31T00:00:00+00:00</published>
        <updated>2025-10-31T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/combine-annotations/"/>
        <id>https://massicotte.org/combine-annotations/</id>
        
        <content type="html" xml:base="https://massicotte.org/combine-annotations/">&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;combine&quot;&gt;Combine&lt;&#x2F;a&gt; is used extensively by a huge number of projects. Despite being largely untouched by Apple for a number of years now, it feels nearly ubiquitous to me. It even shows up in brand new projects starting from scratch. I&#x27;m not sure I &lt;strong&gt;realized&lt;&#x2F;strong&gt; how popular Combine was before getting so involved with Swift Concurrency. And yet it has to be the most common topic around adopting and using Swift Concurrency. It comes up &lt;strong&gt;constantly&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m going to take a shot at covering some of problems that come up when using Combine with Swift. Probably should have done this sooner. This is a pretty big topic, so today I&#x27;m just going to focus on one specific issue: &lt;code&gt;@Sendable&lt;&#x2F;code&gt; annotations.&lt;&#x2F;p&gt;
&lt;p&gt;(If you aren&#x27;t feeling good about what &lt;code&gt;@Sendable&lt;&#x2F;code&gt; means, here&#x27;s a &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;series&lt;&#x2F;a&gt; that covers it and a whole lot more.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;missing-annotations&quot;&gt;Missing annotations&lt;&#x2F;h2&gt;
&lt;p&gt;One of the core issues that affects Combine actually isn&#x27;t unique. In fact, it&#x27;s so common that Swift 6.2 changed how &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0463-sendable-completion-handlers.md&quot;&gt;Objective-C completion handlers&lt;&#x2F;a&gt; are imported in an effort to reduce the problems.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s what&#x27;s going on - it has to do with function parameters.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&#x2F; Does the work.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&#x2F;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&#x2F; Will invoke block on a background queue when complete. &lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... work happens here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Just a plain old function with a completion handler. Those comments are important though. The function claims that the &lt;code&gt;block&lt;&#x2F;code&gt; argument will be executed on a background queue.&lt;&#x2F;p&gt;
&lt;p&gt;The problem is this function, as written, is &lt;strong&gt;not allowed&lt;&#x2F;strong&gt; to do that.&lt;&#x2F;p&gt;
&lt;p&gt;(If this looks familiar, it&#x27;s because I lifted this example from a post I did on &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;&lt;code&gt;@preconcurrency&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;See, Swift has this rule. Values that are created on a particular thread&#x2F;queue&#x2F;actor (aka isolation) are not allowed to leave unless the compiler can prove it is safe. To do that here, this function would need to be marked either &lt;code&gt;@Sendable&lt;&#x2F;code&gt; or &lt;code&gt;sending&lt;&#x2F;code&gt;. And because &lt;code&gt;block&lt;&#x2F;code&gt; uses neither, the compiler reasons that this function &lt;strong&gt;cannot possibly&lt;&#x2F;strong&gt; leave the context that created it.&lt;&#x2F;p&gt;
&lt;p&gt;Formally, a non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; closure &lt;strong&gt;inherits&lt;&#x2F;strong&gt; the isolation of where it was created.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;scheduleWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; We&amp;#39;re on the MainActor here...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	doWork {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; .. and since the function signature has&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; told us this closure couldn&amp;#39;t&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; possibly leave the current isolation,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; the compiler assumes this must also be...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... MainActor!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The compiler, unsurprisingly, trusts the type system. This function isn&#x27;t marked &lt;code&gt;@Sendable&lt;&#x2F;code&gt; and the compiler assumes that&#x27;s true. If &lt;code&gt;block&lt;&#x2F;code&gt; cannot leave the current isolation, then it must be executing on &lt;code&gt;MainActor&lt;&#x2F;code&gt; too.&lt;&#x2F;p&gt;
&lt;p&gt;Except, this function signature is &lt;strong&gt;wrong&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;manual-annotations&quot;&gt;Manual annotations&lt;&#x2F;h2&gt;
&lt;p&gt;It&#x27;s actually not possible to implement this &lt;code&gt;doWork&lt;&#x2F;code&gt; function, as written, in the Swift 6 language mode (without cheating). This has serious implications when using it. If you actually do try to execute this block in a &lt;code&gt;MainActor&lt;&#x2F;code&gt;-context with 6 mode enabled, it will crash.&lt;&#x2F;p&gt;
&lt;p&gt;Depending on your point of view around accessing main thread-only data in the background, you might find this horrifying or reassuring.&lt;&#x2F;p&gt;
&lt;p&gt;(This crash is typically quite easy to recognize, because the crashing function is &lt;code&gt;_dispatch_assert_queue_fail&lt;&#x2F;code&gt;. And usually a few frames deeper you can find the underlying function that is missing an annotation.)&lt;&#x2F;p&gt;
&lt;p&gt;What do we do about this?&lt;&#x2F;p&gt;
&lt;p&gt;Well, if you are in the horrified category, you can just turn this off. The &lt;code&gt;-disable-dynamic-actor-isolation&lt;&#x2F;code&gt; compiler flag will disable these assertions and permit the data races. You can also move back to 5 mode where this flag is off by default.&lt;&#x2F;p&gt;
&lt;p&gt;But, we can also just add the missing annotation manually.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;scheduleWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; We&amp;#39;re on the MainActor here...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	doWork { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; &amp;lt;- THIS&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ah ok well this is a @Sendable closure, so we cannot know what&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; isolation it will be run on.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Not safe to access MainActor stuff in here.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It&#x27;s nice that we can work around this ourselves. Of course, it would be &lt;strong&gt;way&lt;&#x2F;strong&gt; better if someone just updated to &lt;code&gt;doWork&lt;&#x2F;code&gt; so it had the right signature. But, that isn&#x27;t always something under our control.&lt;&#x2F;p&gt;
&lt;p&gt;The tricky part is &lt;strong&gt;noticing&lt;&#x2F;strong&gt; these situations in the first place.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sendable-literally-everywhere&quot;&gt;&lt;code&gt;@Sendable&lt;&#x2F;code&gt;, literally everywhere&lt;&#x2F;h2&gt;
&lt;p&gt;With the problem and solutions understood, let&#x27;s now finally look at Combine. This code will build, but crash at runtime.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; UsesCombine {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; cancellables &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Set&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;AnyCancellable&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; inferred MainActor, don&amp;#39;t forget&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;backgroundChain&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		Just(&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;receive(on: DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;global())
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;sink { value &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; the compiler has inserted a check right here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				print(value)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;store(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;: &lt;span class=&quot;z-keyword z-operator z-bitwise z-swift&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;cancellables)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I tried my best here to produce the simplest example that illustrates the problem. What&#x27;s happening is really rooted in that &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;combine&#x2F;publisher&#x2F;receive(on:options:)&quot;&gt;&lt;code&gt;receive(on:)&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. From that point forward in this chain, all closures actually run on the global queue. And that function accepted by &lt;code&gt;sink&lt;&#x2F;code&gt; is not &lt;code&gt;@Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Most, if not all of Combine&#x27;s operators can be expressed in the form of function parameters. And every single one of them could end up needing to be &lt;code&gt;@Sendable&lt;&#x2F;code&gt;, depending on how they are used. The concurrent behavior of Combine depends on values and runtime state. This is true of GCD as well. The solution for GCD was to mark function parameters &lt;code&gt;@Sendable&lt;&#x2F;code&gt;*.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;None&lt;&#x2F;strong&gt; of Combine&#x27;s are &lt;code&gt;@Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;(* Well, &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;dispatch&#x2F;dispatchworkitem&#x2F;init(qos:flags:block:)&quot;&gt;most&lt;&#x2F;a&gt; of them anyways...)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-tough-decision&quot;&gt;A tough decision&lt;&#x2F;h2&gt;
&lt;p&gt;Combine is in an incredibly tough spot here. It is as close to a pathologic case as you could have. I actually cannot even decide if Combine&#x27;s functions &lt;strong&gt;should&lt;&#x2F;strong&gt; be &lt;code&gt;@Sendable&lt;&#x2F;code&gt; or not. From a language-compatibility perspective, there is really no choice. The language works the way it works. But, from an ergonomic perspective, it&#x27;s miserable. Because lots of Combine chains don&#x27;t actually do background work. In that situation, putting an &lt;code&gt;@Sendable&lt;&#x2F;code&gt; makes things really hard to use.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s another version. Note it does not use &lt;code&gt;receive(on:)&lt;&#x2F;code&gt;. But, I&#x27;ve added a little wrapper to emulate what it would be like if &lt;code&gt;sink&lt;&#x2F;code&gt; actually accepted a &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closure unconditionally.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; Publisher &lt;span class=&quot;z-keyword z-control z-switch z-swift&quot;&gt;where&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;Failure &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; Never {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;sendableSink&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;receiveValue: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;Output&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) -&amp;gt; AnyCancellable &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		sink(receiveValue: receiveValue)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; UsesCombine {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; cancellables &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Set&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;AnyCancellable&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;foregroundChain&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		Just(&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;sendableSink { value &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Error: Call to main actor-isolated instance method &amp;#39;processValue&amp;#39; in a synchronous nonisolated context&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;processValue(value)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;store(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;: &lt;span class=&quot;z-keyword z-operator z-bitwise z-swift&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;cancellables)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;processValue&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ value: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We now have compile-time guaranteed data race safety. But, we&#x27;re paying an extreme cost in usability. When using &lt;code&gt;sendableSink&lt;&#x2F;code&gt;, we can never touch any isolated state, &lt;code&gt;MainActor&lt;&#x2F;code&gt; or otherwise.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s a false-positive on top of all that. Working around this new problem now requires &lt;a href=&quot;&#x2F;dynamic-isolation&quot;&gt;dynamic isolation&lt;&#x2F;a&gt; (like &lt;code&gt;MainActor.assumeIsolated&lt;&#x2F;code&gt;), or another form of unsafe opt-out. Awful.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;no-good-solutions&quot;&gt;No good solutions&lt;&#x2F;h2&gt;
&lt;p&gt;I have gone back and forth on this one. There really isn&#x27;t a good solution here, but I think leaving Combine as-is probably makes the most sense. It&#x27;s true that its types are technically incorrect. But, fixing that gives you only modest gains and is detrimental to the common case.&lt;&#x2F;p&gt;
&lt;p&gt;Realistically, you just need to be very conscious of publishers that do background work. Even a quick pass over your code base for uses of &lt;code&gt;receive(on:)&lt;&#x2F;code&gt; will help. Because any occurrence means you are either moving to or from a &lt;code&gt;Scheduler&lt;&#x2F;code&gt; and that&#x27;s where the problems might lie. Unfortunately you still will have to think carefully about what each closure does, in context. But at least this can help narrow down the problem.&lt;&#x2F;p&gt;
&lt;p&gt;And any help is welcome, because I&#x27;m sorry to say this is just one of a number of issues related to Combine and Swift interoperability. However, we&#x27;ll have to leave that for a future post.&lt;&#x2F;p&gt;
&lt;p&gt;However I do have a parting thought.&lt;&#x2F;p&gt;
&lt;p&gt;A lot of people feel like a transition away from Combine is basically required. All the effort has been shifted over to &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt;. But Combine is &lt;strong&gt;not&lt;&#x2F;strong&gt; deprecated. It isn&#x27;t going anywhere, at least in the near-term. And in my experience, transitioning from Combine to &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt; is incredibly difficult on its own. The last thing you want to do is attempt this without first having a very solid understanding of the language. It will be a lot easier to start there.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Concurrency Step-by-Step: Conforming to Protocols</title>
        <published>2025-10-25T00:00:00+00:00</published>
        <updated>2025-10-25T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/step-by-step-conforming-to-protocols/"/>
        <id>https://massicotte.org/step-by-step-conforming-to-protocols/</id>
        
        <content type="html" xml:base="https://massicotte.org/step-by-step-conforming-to-protocols/">&lt;p&gt;If there&#x27;s one topic that I find intimidating, it&#x27;s protocols. They are very powerful and in extremely wide use. But I&#x27;m sitting here, trying to figure out how to lead into this discussion and I&#x27;m already getting overwhelmed. That&#x27;s because protocols can be incredibly complicated.&lt;&#x2F;p&gt;
&lt;p&gt;There are just so many different kinds of problems that can come up with them. I won&#x27;t be able to cover them all in one post. So, I&#x27;m going to focus on one small (heh) part: adding a conformance.&lt;&#x2F;p&gt;
&lt;p&gt;This is the fourth in a series all about trying to explore and understand concurrency from a more practical and foundational perspective. The last one was about &lt;a href=&quot;&#x2F;step-by-step-stateful-systems&quot;&gt;stateful systems&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;getting-set-up&quot;&gt;Getting set up&lt;&#x2F;h2&gt;
&lt;p&gt;I wish it weren&#x27;t the case, but we haven&#x27;t even gotten started and already we have a problem. As of Swift 6.2, the meaning of code can potentially be ambiguous without also knowing compiler settings. This will be &lt;strong&gt;particularly&lt;&#x2F;strong&gt; relevant for this topic. So, I&#x27;m going to do my best to be very clear about what settings, if any, I&#x27;m relying on.&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;re also going to follow a similar pattern to all the previous posts in the series by making a small SwiftUI app.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-view-and-a-model&quot;&gt;A View and a Model&lt;&#x2F;h2&gt;
&lt;p&gt;Here&#x27;s the entirety of our application. One SwiftUI view and an &lt;code&gt;Observable&lt;&#x2F;code&gt; that holds some state.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; default-isolation: MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; InferIsolatedConformances: enabled&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;SwiftUI&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Observable&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; ImageModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;true&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; imageName: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		state &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;?&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggle&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; ContentView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; ImageModel()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Image(systemName: model&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;imageName)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;imageScale(&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;large)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;foregroundStyle(&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;tint)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;onTapGesture {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				model&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;padding()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is a super boring application. But it will work for what we&#x27;re trying to do. Probably the most interesting part of this entire thing are the two comments at the top.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;approachable-concurrency&quot;&gt;&quot;Approachable Concurrency&quot;&lt;&#x2F;h2&gt;
&lt;p&gt;These are the default settings you get with Xcode 26. Note that I am not using the term &quot;Approachable Concurrency&quot; here. That is actually an Xcode-specific build setting that controls a group of compiler flags. I think it&#x27;s important you are at least aware that, from the Swift compiler&#x27;s perspective, there is no such thing as &quot;Approachable Concurrency&quot;. I&#x27;m indicating the actual compiler flags that matter to us here explicitly.&lt;&#x2F;p&gt;
&lt;p&gt;In the Swift 6 language mode, there are only &lt;strong&gt;two&lt;&#x2F;strong&gt; flags &quot;Approachable Concurrency&quot; changes: &lt;code&gt;InferIsolatedConformances&lt;&#x2F;code&gt; and &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt;. It switches on more stuff in 5 mode, but those will not affect this material.&lt;&#x2F;p&gt;
&lt;p&gt;I also want to be extremely clear that a default isolation of &lt;code&gt;MainActor&lt;&#x2F;code&gt; and the settings in &quot;Approachable Concurrency&quot; are &lt;strong&gt;completely&lt;&#x2F;strong&gt; independent. I fear we are getting close as a community to internalizing the idea that these things are the same, or maybe at least interchangeable.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;They are neither&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Ok. Back to the problem at hand.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;equality&quot;&gt;Equality&lt;&#x2F;h2&gt;
&lt;p&gt;I frequently try to make model-like types I work with conform to &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;equatable&quot;&gt;&lt;code&gt;Equatable&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. It can make them easier to test.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Test&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggleTwiceResets&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; modelA &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; ImageModel()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; modelB &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; ImageModel()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	modelA&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	modelA&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	#expect(modelA &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; modelB)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;May I remind you that it is &lt;strong&gt;incredibly&lt;&#x2F;strong&gt; difficult to come up with example code that is simultaneously illustrative, simple, and interesting. This test is pretty dumb, but I hope you can at least see where I&#x27;m going with it.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s zoom in on the &lt;code&gt;ImageModel&lt;&#x2F;code&gt; type here and add an &lt;code&gt;Equatable&lt;&#x2F;code&gt; conformance so we can make this test code work.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; default-isolation: MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; InferIsolatedConformances: enabled&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Observable&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; ImageModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;true&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; imageName: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		state &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;?&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggle&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There&#x27;s the &lt;code&gt;Equatable&lt;&#x2F;code&gt; conformance, added via an extension. All is well!&lt;&#x2F;p&gt;
&lt;p&gt;(&lt;strong&gt;Update!&lt;&#x2F;strong&gt; &lt;a href=&quot;https:&#x2F;&#x2F;portfolio-mathis-three.vercel.app&quot;&gt;Mathias&lt;&#x2F;a&gt; helped to remind me of something very confusing I forgot to mention! If you switch the default isolation to &lt;code&gt;MainActor&lt;&#x2F;code&gt;, the compiler will unconditionally enable &lt;code&gt;InferIsolatedConformances&lt;&#x2F;code&gt; implicitly.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;is-all-well&quot;&gt;Is all well?&lt;&#x2F;h2&gt;
&lt;p&gt;This code works. But, the &lt;strong&gt;only&lt;&#x2F;strong&gt; reason it works is because we&#x27;re (perhaps unknowingly) making use of a very powerful new feature of Swift 6.2: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0470-isolated-conformances.md&quot;&gt;isolated conformances&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;To better understand the issue it is solving, we&#x27;re going to change our settings so our code has the same semantics as 6.1 and earlier.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; default-isolation: nonisolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; InferIsolatedConformances: disabled&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Observable&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; ImageModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;true&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; imageName: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		state &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;?&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggle&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;ve made exactly three changes. First, I switched off the &lt;code&gt;MainActor&lt;&#x2F;code&gt; default isolation. Second, I have disabled the &lt;code&gt;InferIsolatedConformances&lt;&#x2F;code&gt; setting. And third, I have made the static isolation explicit so the type remains &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s important to note that &lt;code&gt;ImageModel&lt;&#x2F;code&gt; was &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated before too, we were just using the default.&lt;&#x2F;p&gt;
&lt;p&gt;With this configuration, the code now fails to compile.&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Conformance of &amp;#39;ImageModel&amp;#39; to protocol &amp;#39;Equatable&amp;#39; crosses into main actor-isolated code and can cause data races
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;nonisolated-protocols&quot;&gt;Nonisolated protocols&lt;&#x2F;h2&gt;
&lt;p&gt;Before we look at the possible solutions to this problem, we have to understand what&#x27;s going on. What we are seeing here is &lt;strong&gt;extremely&lt;&#x2F;strong&gt; common. So common, it has an &lt;a href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;migration&#x2F;documentation&#x2F;swift-6-concurrency-migration-guide&#x2F;commonproblems#Protocol-Conformance-Isolation-Mismatch&quot;&gt;entire section&lt;&#x2F;a&gt; within the &quot;Common Compiler Errors&quot; page of the Swift 6 migration guide. There have been &lt;strong&gt;two&lt;&#x2F;strong&gt; evolution proposals (&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0423-dynamic-actor-isolation.md&quot;&gt;SE-0423&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0470-isolated-conformances.md&quot;&gt;SE-0470&lt;&#x2F;a&gt;) specifically targeting the issue.&lt;&#x2F;p&gt;
&lt;p&gt;What I&#x27;m trying to say is it comes up a lot.&lt;&#x2F;p&gt;
&lt;p&gt;But we are going to figure this out. Let&#x27;s start by looking at the &lt;code&gt;Equatable&lt;&#x2F;code&gt; protocol.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;, rhs: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;Equatable&lt;&#x2F;code&gt; actually has a fair bit going on. It&#x27;s all about defining the meaning of the &lt;code&gt;==&lt;&#x2F;code&gt; operator, so that you can compare two instances of the conforming type. However, this protocol is relying on something subtle and implicit.&lt;&#x2F;p&gt;
&lt;p&gt;This protocol wants to be able to invoke &lt;code&gt;==&lt;&#x2F;code&gt; on a type, synchronously, from any thread at any time. It has no notion of &quot;thread-safety&quot;. Why would it? &lt;code&gt;Equatable&lt;&#x2F;code&gt; is about checking for equality and that&#x27;s all. Thread-safety is entirely out of the scope of what it is trying to do.&lt;&#x2F;p&gt;
&lt;p&gt;Swift&#x27;s concurrency system has a way to express this idea. Something that does not require the protection of an actor is &lt;code&gt;nonisolated&lt;&#x2F;code&gt;. This is what the &lt;code&gt;Equatable&lt;&#x2F;code&gt; protocol looks like with that made explicit.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;, rhs: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The idea that &lt;code&gt;nonisolated&lt;&#x2F;code&gt; should be the default for all declarations is actually very reasonable. Prior to Swift 5.5, the language had no way to express thread-safety. There was no such thing as isolation. No declarations had the protection of an actor, and that&#x27;s exactly what &lt;code&gt;nonisolated&lt;&#x2F;code&gt; means. Thread-safety, if even required at all, has to come from somewhere else.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conformance-mismatch&quot;&gt;Conformance Mismatch&lt;&#x2F;h2&gt;
&lt;p&gt;Now, let&#x27;s review our code. I&#x27;m going to trim out a little bit just to keep things manageable.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; default-isolation: nonisolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; InferIsolatedConformances: disabled&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Observable&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; ImageModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Our type is &lt;code&gt;MainActor&lt;&#x2F;code&gt;. We have declared that this type is only safe to access on the main thread. And the compiler has inferred that if the type is &lt;code&gt;MainActor&lt;&#x2F;code&gt;, by default all its methods should be &lt;code&gt;MainActor&lt;&#x2F;code&gt; too. I&#x27;ve just annotated it explicitly to make that really clear.&lt;&#x2F;p&gt;
&lt;p&gt;But, &lt;code&gt;Equatable&lt;&#x2F;code&gt; has no such restriction. It describes types that can be compared from &lt;strong&gt;anywhere&lt;&#x2F;strong&gt;. It wants a nonisolated &lt;code&gt;==&lt;&#x2F;code&gt;, but we have one that is only usable from the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. We cannot have a method that is both usable from anywhere and also only usable from the &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This is known as a &quot;protocol conformance isolation mismatch&quot;. We are very &lt;strong&gt;close&lt;&#x2F;strong&gt; to conforming to &lt;code&gt;Equatable&lt;&#x2F;code&gt;, but these differing requirements are in conflict.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;dynamic-isolation&quot;&gt;Dynamic isolation&lt;&#x2F;h2&gt;
&lt;p&gt;The issue is &lt;code&gt;Equatable&lt;&#x2F;code&gt; needs this method to be &lt;code&gt;nonisolated&lt;&#x2F;code&gt;. So let&#x27;s at least get that part sorted out.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We&#x27;re going to cut off the &lt;code&gt;MainActor&lt;&#x2F;code&gt; inference by declaring our function &lt;code&gt;nonisolated&lt;&#x2F;code&gt;. This now perfectly matches what &lt;code&gt;Equatable&lt;&#x2F;code&gt; wants. Except now we have a &lt;strong&gt;different&lt;&#x2F;strong&gt; problem, inside the implementation.&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Main actor-isolated property &amp;#39;state&amp;#39; can not be referenced from a nonisolated context
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is happening because &lt;code&gt;ImageModel&lt;&#x2F;code&gt; is marked &lt;code&gt;@MainActor&lt;&#x2F;code&gt;. We asked the compiler &quot;make sure I only access this type on the MainActor&quot; and it&#x27;s doing exactly that right here.&lt;&#x2F;p&gt;
&lt;p&gt;The thing to remember here is that keywords and annotations are all part of our source. They are &lt;strong&gt;statically&lt;&#x2F;strong&gt; defined. These are things the compiler understands and can reason about. However, the compiler does not know how these types will actually be &lt;strong&gt;used&lt;&#x2F;strong&gt;, it is just considering their declarations. Maybe we know better!&lt;&#x2F;p&gt;
&lt;p&gt;And we do. We can see the entirety of this program, and there are no unsafe uses of this type anywhere. This is a false positive.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s tell the compiler: &quot;can you please just chill out I know what I&#x27;m doing&quot;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assumeIsolated {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We start by matching the isolation requirement of &lt;code&gt;Equatable&lt;&#x2F;code&gt;. And then, we go and promise the compiler that, despite this function being &lt;strong&gt;possible&lt;&#x2F;strong&gt; to call from any thread, that won&#x27;t actually happen at runtime. The compiler will trust us, but it will also verify. The &lt;code&gt;assumeIsolated&lt;&#x2F;code&gt; function will check that it is actually invoked on the main thread and will crash if not.&lt;&#x2F;p&gt;
&lt;p&gt;Static isolation is all about the stuff outside of function bodies. We are using a tool here called &lt;a href=&quot;&#x2F;dynamic-isolation&quot;&gt;dynamic isolation&lt;&#x2F;a&gt;. It&#x27;s more about what&#x27;s happening inside them.&lt;&#x2F;p&gt;
&lt;p&gt;This is necessary when we, the programmer, know something that the compiler is unable to determine from the type system alone. This comes up frequently when working with APIs that haven&#x27;t been (or cannot ever be) correctly annotated for concurrency. And it&#x27;s handy here too. Where we&#x27;re working with an isolated type that needs to interact with systems not specifically designed to match.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-downsides&quot;&gt;The downsides&lt;&#x2F;h2&gt;
&lt;p&gt;This &lt;code&gt;nonisolated&lt;&#x2F;code&gt;-&lt;code&gt;assumeIsolated&lt;&#x2F;code&gt; dance was really the only option before Swift 6.0. However, it has some very serious drawbacks. The most obvious one is it&#x27;s verbose. Our protocol here has only one requirement, but you can imagine how annoying this could get with something more complex.&lt;&#x2F;p&gt;
&lt;p&gt;However that&#x27;s not the worst of it.&lt;&#x2F;p&gt;
&lt;p&gt;The big problem here is we are intentionally trying to side-step the type system. And you just cannot do that easily. Being a &lt;code&gt;nonisolated&lt;&#x2F;code&gt; function, the compiler will be perfectly happy with you calling &lt;code&gt;==&lt;&#x2F;code&gt; off the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. That will crash.&lt;&#x2F;p&gt;
&lt;p&gt;Further, as far as the compiler is concerned, there is an actor boundary both going into and returning from &lt;code&gt;assumeIsolated&lt;&#x2F;code&gt;. This means you cannot work with non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; data here and that can be an enormous pain.&lt;&#x2F;p&gt;
&lt;p&gt;This is just not a great way to solve the problem. Thankfully, we have other options.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;preconcurrency-conformance&quot;&gt;Preconcurrency conformance&lt;&#x2F;h2&gt;
&lt;p&gt;This problem with protocol conformance isolation mismatches was so wide-spread and so frustrating that Swift 6.0 introduced a new tool: the preconcurrency conformance.&lt;&#x2F;p&gt;
&lt;p&gt;(I&#x27;ve written both about it &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;specifically&lt;&#x2F;a&gt; as well as &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;preconcurrency&lt;&#x2F;a&gt; more generally.)&lt;&#x2F;p&gt;
&lt;p&gt;Using this feature, we can transform this into a much nicer form.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;preconcurrency&lt;&#x2F;span&gt; Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A preconcurrency conformance addresses &lt;strong&gt;many&lt;&#x2F;strong&gt; of the limitations of the &lt;code&gt;nonisolated&lt;&#x2F;code&gt;-&lt;code&gt;assumeIsolation&lt;&#x2F;code&gt; approach. The compiler will no longer allow you to call &lt;code&gt;==&lt;&#x2F;code&gt; off the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. There are no longer &lt;code&gt;Sendable&lt;&#x2F;code&gt; checks getting in the way. And, no more boilerplate!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;but-it-s-kinda-weird&quot;&gt;But it&#x27;s ... kinda weird?&lt;&#x2F;h2&gt;
&lt;p&gt;Unfortunately, this technique is imperfect. Because, as the name perhaps implies, this was invented to express the idea that a protocol actually &lt;strong&gt;should&lt;&#x2F;strong&gt; be isolated, but just hasn&#x27;t been updated yet. And while there are no doubt many protocols out there that are in this situation, &lt;code&gt;Equatable&lt;&#x2F;code&gt; isn&#x27;t one.&lt;&#x2F;p&gt;
&lt;p&gt;When we write &lt;code&gt;@preconcurrency Equatable&lt;&#x2F;code&gt;, we are telling the compiler that the problem is with &lt;code&gt;Equatable&lt;&#x2F;code&gt;. It thinks the definition should really look like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;, rhs: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So while this technique does work and is very useful, it &lt;strong&gt;feels&lt;&#x2F;strong&gt; kinda wrong. There&#x27;s nothing &quot;preconcurrency&quot; about &lt;code&gt;Equatable&lt;&#x2F;code&gt;, and it definitely should not actually only work for &lt;code&gt;MainActor&lt;&#x2F;code&gt; types.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolated-conformances&quot;&gt;Isolated Conformances&lt;&#x2F;h2&gt;
&lt;p&gt;Before Swift 6.0, dynamic isolation was the only option. And before Swift 6.2, I think that preconcurrency conformances were the best tool for handling protocol isolation mismatches. They address pretty much all of the weakness of the &lt;code&gt;nonisolated&lt;&#x2F;code&gt;-&lt;code&gt;assumeIsolated&lt;&#x2F;code&gt; thing. But they just feel funny.&lt;&#x2F;p&gt;
&lt;p&gt;And they feel that way because they are &lt;strong&gt;semantically backwards&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;What we really want is to express something different. We have a &lt;code&gt;MainActor&lt;&#x2F;code&gt; type. And we want it to be &lt;code&gt;Equatable&lt;&#x2F;code&gt;, but &lt;strong&gt;only&lt;&#x2F;strong&gt; from that isolation. We could imagine such a protocol, like we defined above, with a name like &quot;MainActorEquatable&quot;. Except no one wants do that for every possible protocol and global actor.&lt;&#x2F;p&gt;
&lt;p&gt;And that&#x27;s where &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0470-isolated-conformances.md&quot;&gt;isolated conformances&lt;&#x2F;a&gt; come in.&lt;&#x2F;p&gt;
&lt;p&gt;Swift 6.2 allows us to express this idea directly, by constraining a conformance to be valid only for a particular global actor.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; default-isolation: nonisolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; InferIsolatedConformances: disabled&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Observable&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; ImageModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What we now have is exactly what we want. A &lt;code&gt;MainActor&lt;&#x2F;code&gt; type that is &lt;code&gt;Equatable&lt;&#x2F;code&gt; in that context &lt;strong&gt;only&lt;&#x2F;strong&gt;. This is not the same as a true, unconstrainted &lt;code&gt;Equatable&lt;&#x2F;code&gt;, because those work everywhere. It&#x27;s a little like defining a new, special variant of that protocol right in line at the conformance declaration site.&lt;&#x2F;p&gt;
&lt;p&gt;The awareness of both the compiler and runtime about what&#x27;s going on here goes quite deep. This can be particularly relevant for generic code, including from libraries you are using. I&#x27;m not going to get into it all here, but there is &lt;a href=&quot;https:&#x2F;&#x2F;docs.swift.org&#x2F;compiler&#x2F;documentation&#x2F;diagnostics&#x2F;sendable-metatypes&#x2F;&quot;&gt;documentation&lt;&#x2F;a&gt; on the underlying type system concept,  &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;Swift&#x2F;SendableMetatype&quot;&gt;&lt;code&gt;SendableMetatype&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, if you want to go further.&lt;&#x2F;p&gt;
&lt;p&gt;One important thing to keep in mind about isolated conformances is, despite them being super-cool, they do have a downside. Not all protocols are compatible with them. Some protocols have concurrent behaviors in their nature and cannot handle being constrained to a single global actor like this.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;implicit-too&quot;&gt;Implicit too&lt;&#x2F;h2&gt;
&lt;p&gt;Isolated conformances are a powerful and useful feature. And, we can even make it the default for global actor isolated types! Note the &lt;code&gt;InferIsolatedConformances&lt;&#x2F;code&gt; change required, which is part of that &quot;Approchable Concurrency&quot; group.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; default-isolation: nonisolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; InferIsolatedConformances: enabled&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Observable&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; ImageModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That&#x27;s it. We just declare a type, add the extension, and we are done. This is something I find feels extremely natural. You might not even &lt;strong&gt;realize&lt;&#x2F;strong&gt; this is happening (which has pros and cons). I think that&#x27;s particularly likely to be true when using a default isolation of &lt;code&gt;MainActor&lt;&#x2F;code&gt;, like we were at the very beginning.&lt;&#x2F;p&gt;
&lt;p&gt;But remember, not all protocols are compatible. And making this entire thing implicit makes the problems even more surprising. Don&#x27;t get me wrong, I &lt;strong&gt;really&lt;&#x2F;strong&gt; like isolated conformances and am very happy to see them come to the language. But they are not a magic bullet (and neither is &lt;code&gt;MainActor&lt;&#x2F;code&gt;-by-default).&lt;&#x2F;p&gt;
&lt;h2 id=&quot;no-isolation-at-all&quot;&gt;No isolation at all!&lt;&#x2F;h2&gt;
&lt;p&gt;We&#x27;ve now looked at a bunch of ways of handling a protocol conformance isolation mismatch. We let everything happen automagically by combining the default &lt;code&gt;MainActor&lt;&#x2F;code&gt; isolation with implicit isolated conformances. We looked at how to do that all explicitly. And we learned about &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; and even dynamic isolation along the way.&lt;&#x2F;p&gt;
&lt;p&gt;That was &lt;strong&gt;a lot&lt;&#x2F;strong&gt;! And it is all pretty complicated stuff.&lt;&#x2F;p&gt;
&lt;p&gt;But now, oh boy, I&#x27;ve got something really special to show you. I can hardly wait!&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;re going to get rid of &lt;strong&gt;absolutely everything&lt;&#x2F;strong&gt; and just make this a plain old, normal, totally thread-unsafe class.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; default-isolation: doesn&amp;#39;t matter!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; InferIsolatedConformances: doesn&amp;#39;t matter!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Observable&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;nonisolated &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; ImageModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;true&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; imageName: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		state &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;?&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggle&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ImageModel: Equatable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;==&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;lhs: ImageModel, rhs: ImageModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		lhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;==&lt;&#x2F;span&gt; rhs&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I want you to take a moment to think about this. I&#x27;ve added an explicit &lt;code&gt;nonisolated&lt;&#x2F;code&gt; to this type to make sure that the code is settings-independent.&lt;&#x2F;p&gt;
&lt;p&gt;The conformance works because &lt;code&gt;==&lt;&#x2F;code&gt; wants &lt;code&gt;nonisolated&lt;&#x2F;code&gt; and that&#x27;s what we have. In fact, that &lt;code&gt;MainActor&lt;&#x2F;code&gt; we originally had wasn&#x27;t just unnecessary, it was actively &lt;strong&gt;problematic&lt;&#x2F;strong&gt;. Isolation is a constraint. If that constraint isn&#x27;t getting us anything, why have it?&lt;&#x2F;p&gt;
&lt;p&gt;But but but! Isn&#x27;t this type now unsafe??&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sneak-peek-non-sendable-first-design&quot;&gt;Sneak peek: Non-Sendable First Design&lt;&#x2F;h2&gt;
&lt;p&gt;You probably thought I was just making a dumb joke with this whole &quot;I can hardly wait&quot; stuff. But I was actually being serious!&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve been slowly creeping my way towards this concept for a long time now. I cannot decide if it is a mind-set, strategy, or design pattern. But I often refer to it as &quot;Non-Sendable First Design&quot;. And while I do not have a dedicated post on the topic yet, the idea is so powerful and so useful I want to give you a little glimpse of it now.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s look back now at where we actually make one of these &lt;code&gt;ImageModel&lt;&#x2F;code&gt; things.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; ContentView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is actually MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; ImageModel()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Because this is all within a &lt;code&gt;View&lt;&#x2F;code&gt; type, that &lt;code&gt;model&lt;&#x2F;code&gt; property of ours is &lt;code&gt;MainActor&lt;&#x2F;code&gt; too. We&#x27;ve made an instance of &lt;code&gt;ImageModel&lt;&#x2F;code&gt; here on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;And it&#x27;s now &lt;strong&gt;stuck&lt;&#x2F;strong&gt; there.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s stuck because &lt;code&gt;ImageModel&lt;&#x2F;code&gt; is &lt;a href=&quot;&#x2F;non-sendable&quot;&gt;non-&lt;code&gt;Sendable&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. Remember how these kinds of types work. The compiler will not permit a non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; type to leave an isolated context.&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s no need for any special protocol conformance tricks or features or whatever because this nonisolated type doesn&#x27;t need them! And if that wasn&#x27;t enough, it&#x27;s more flexible too! This type can be used from &lt;strong&gt;any&lt;&#x2F;strong&gt; actor, because we have not hard-coded the isolation into the type itself.&lt;&#x2F;p&gt;
&lt;p&gt;This is not just limited to a single instance either. Entire &lt;strong&gt;networks&lt;&#x2F;strong&gt; of objects can all work together with a non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; first approach.&lt;&#x2F;p&gt;
&lt;p&gt;However, there is a big catch. Non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types can be &lt;strong&gt;extraordinarily&lt;&#x2F;strong&gt; difficult to use if they themselves need to make use of concurrency features internally. &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt; helps &lt;strong&gt;a lot&lt;&#x2F;strong&gt; here, but there can still some very challenging aspects.&lt;&#x2F;p&gt;
&lt;p&gt;I have a &lt;a href=&quot;&#x2F;blog&#x2F;non-sendable-first-design&quot;&gt;dedicated post&lt;&#x2F;a&gt; for this one. This concept has been hugely influential on my own work. I think it&#x27;s good.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;i-told-you-so&quot;&gt;I told you so&lt;&#x2F;h2&gt;
&lt;p&gt;I opened by talking about how complex protocols are. And this was only adding a simple conformance! However because of the complexity, there&#x27;s really no possible &quot;best practice&quot;. You need to understand the situation and options to pick something appropriate, as they all come with trade-offs.&lt;&#x2F;p&gt;
&lt;p&gt;So let&#x27;s recap.&lt;&#x2F;p&gt;
&lt;p&gt;If you have a global actor isolated type, you &lt;strong&gt;probably&lt;&#x2F;strong&gt; want an isolated conformance. But, it&#x27;s not a certainty! There are systems that are incompatible with isolated conformances. And unfortunately, even &lt;strong&gt;recognizing&lt;&#x2F;strong&gt; this incompatibility can be challenging, forget dealing with it.&lt;&#x2F;p&gt;
&lt;p&gt;Don&#x27;t discount the power of the &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;preconcurrency&lt;&#x2F;a&gt; conformance! It is immune to most (possibly all?) of the compatibility issues with isolated conformances, at the cost of some compile-time safety. Yes, it does feel weird, but it is functionally very similar to what an isolated conformance does anyways. Keep it in your toolbox.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m honestly not sure I want to recommend attempting a nonisolated type - this &quot;non-Sendable first&quot; nonsense. It &lt;strong&gt;can&lt;&#x2F;strong&gt; be the simplest option or the most complex, depending on what&#x27;s going on inside. But I think at least being aware of the idea is important, because it is, in my opinion, a big deal.&lt;&#x2F;p&gt;
&lt;p&gt;I do think, however, at that this point there aren&#x27;t many reasons to use &lt;code&gt;nonisolated&lt;&#x2F;code&gt;-&lt;code&gt;assumeIsolated&lt;&#x2F;code&gt;. They do work with non-global actor types, so that&#x27;s something.&lt;&#x2F;p&gt;
&lt;p&gt;My preferred ordering:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;nonisolated type&lt;&#x2F;li&gt;
&lt;li&gt;isolated conformance&lt;&#x2F;li&gt;
&lt;li&gt;preconcurrency conformance&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;nonisolated&lt;&#x2F;code&gt;-&lt;code&gt;assumeIsolated&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;So, uhhh, wow. This got long. But I hope this gives you some insight into how to better handle protocol conformances. If you have questions, or find typos&#x2F;mistakes please let me know. I&#x27;d love to hear from you!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Singletons with Swift Concurrency</title>
        <published>2025-10-19T00:00:00+00:00</published>
        <updated>2025-10-19T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/singletons/"/>
        <id>https://massicotte.org/singletons/</id>
        
        <content type="html" xml:base="https://massicotte.org/singletons/">&lt;p&gt;I see singletons used a lot in Swift projects. These things are, by definition, global state. That means they can be accessed from any context - any thread or actor - at any time. And this property makes them a common source of problems when used with Concurrency.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;quick-recap&quot;&gt;Quick Recap&lt;&#x2F;h2&gt;
&lt;p&gt;Just quickly, this is what a singleton looks like. I&#x27;m just copying from an Apple &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;managing-a-shared-resource-using-a-singleton&quot;&gt;documentation page&lt;&#x2F;a&gt; on the topic (which I was kinda stunned to discover, by the way).&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Singleton {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; shared &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Singleton()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;() {}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;(Tiny modification: I added a private init to enforce the singleton-ness. Thank you so much &lt;a href=&quot;https:&#x2F;&#x2F;marcelvoss.com&quot;&gt;Marcel&lt;&#x2F;a&gt; for calling that out!)&lt;&#x2F;p&gt;
&lt;p&gt;Couple of important things to note. First, &lt;code&gt;Singleton&lt;&#x2F;code&gt; is a class. This makes it non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; by default. Global, mutable, thread-unsafe state. That&#x27;s the core problem.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;shared&lt;&#x2F;code&gt; property is also a read-only &lt;code&gt;let&lt;&#x2F;code&gt;. This makes the &lt;code&gt;shared&lt;&#x2F;code&gt; reference immutable, but it still is a pointer to thread-unsafe data. If it were a &lt;code&gt;var&lt;&#x2F;code&gt;, we&#x27;d actually have another issue, as that would be itself be yet more global mutable state.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;getting-rid-of-the-singleton&quot;&gt;Getting Rid of the Singleton&lt;&#x2F;h2&gt;
&lt;p&gt;When problems with singletons comes up, someone will always suggest that you simply not use them. Ahh, so easy.&lt;&#x2F;p&gt;
&lt;p&gt;Look, I&#x27;m not a fan of singletons and I think you should avoid them. I really like the composition root pattern, or the more technical term of &quot;passing arguments to functions&quot;. There are a million similar, more sophisticated options. People seem to really like &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;pointfreeco&#x2F;swift-dependencies&quot;&gt;Dependencies&lt;&#x2F;a&gt; by &lt;a href=&quot;https:&#x2F;&#x2F;www.pointfree.co&quot;&gt;Point-Free&lt;&#x2F;a&gt; these days. You might even &lt;strong&gt;want&lt;&#x2F;strong&gt; to redesign your system. But, that&#x27;s probably just not realistic right now, and may not be for the foreseeable future.&lt;&#x2F;p&gt;
&lt;p&gt;I always assume that when someone is running into trouble with singletons, they have already considered this option and rejected it. That could be because it isn&#x27;t practical, desirable, or they just want to learn.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;expressing-truth&quot;&gt;Expressing Truth&lt;&#x2F;h2&gt;
&lt;p&gt;A useful strategy for migrating to Swift 6 mode is to &quot;express truth&quot; to the compiler about your current system. When you have concurrency checking disabled, thread safety is entirely up to you. So, if you&#x27;ve got a singleton you access from multiple threads today, you can just tell the compiler that&#x27;s what&#x27;s happening.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Singleton: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;unchecked&lt;&#x2F;span&gt; Sendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; shared &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Singleton()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I have found that most people feel better about staying in Swift 5 mode with checks off than use an  unsafe opt-out like this. In fact, there are people that see all &lt;code&gt;@unchecked&lt;&#x2F;code&gt; usage as a form of cheating. This is fascinating, because before the compiler was able to check this stuff, literally all types were &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Ultimately, I think this is rooted in an understanding of the difference between &quot;I hope this is not a problem&quot; and &quot;I am asserting this is not a problem&quot;. I guess that&#x27;s good!&lt;&#x2F;p&gt;
&lt;p&gt;Now, if you are using locks or queues or some other synchronization mechanism to protect the internal state of &lt;code&gt;Singleton&lt;&#x2F;code&gt; here, I still think &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt; is a good choice. Adding it to a type you control makes tons of sense. This is why the annotation exists!&lt;&#x2F;p&gt;
&lt;p&gt;There are plenty of other options though, so let&#x27;s have a look at those too.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;slapping-on-an-mainactor&quot;&gt;Slapping on an &lt;code&gt;@MainActor&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;This is, in my opinion, the correct solution for the majority of singletons out there. This option is great for a number of reasons.&lt;&#x2F;p&gt;
&lt;p&gt;First, it works because things that are isolated to a global actor become &lt;code&gt;Sendable&lt;&#x2F;code&gt;. The compiler now has enough information to guarantee thread-safe access. This is nice because it preserves the ability to access the type synchronously in &lt;code&gt;MainActor&lt;&#x2F;code&gt; contexts. That&#x27;s often extremely important.&lt;&#x2F;p&gt;
&lt;p&gt;Second, it gives you a quick way to audit those existing accesses. The compiler will now be able to tell you right away about any spots where it is being touched off main. That might never even happen. However, this audit is just telling you about places where the compiler cannot &lt;strong&gt;prove&lt;&#x2F;strong&gt; the accesses are on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. For a typical migration, there will be many false-positives here. Adding global actor annotations can cause an explosion of new issues as they touch unmigrated code.&lt;&#x2F;p&gt;
&lt;p&gt;There are a variety of ways to go about dealing with this.&lt;&#x2F;p&gt;
&lt;p&gt;If this is a public property used across modules, you should probably be using a &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;&lt;code&gt;@preconcurrency&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; annotation to help limit the blast radius. Reaching for &lt;a href=&quot;&#x2F;dynamic-isolation&quot;&gt;dynamic isolation&lt;&#x2F;a&gt;, like &lt;code&gt;MainActor.assumeIsolated&lt;&#x2F;code&gt;, is a very useful tool too. This also could be a good time to just take the opportunity to add more obviously-missing &lt;code&gt;@MainActor&lt;&#x2F;code&gt; annotations.&lt;&#x2F;p&gt;
&lt;p&gt;This is often really often another form of &quot;expressing truth&quot; to the compiler. You aren&#x27;t changing how the reference is being used, you are now just being explicit about it.&lt;&#x2F;p&gt;
&lt;p&gt;I know I know. Before you bring up performance issues, I want you to first consider how this code is being executed today. And then, make sure you really, deeply understand long-running, &lt;a href=&quot;&#x2F;synchronous-work&quot;&gt;synchronous work&lt;&#x2F;a&gt;. Way too many people are hesitant about using &lt;code&gt;MainActor&lt;&#x2F;code&gt;. And, when it does introduce performance problems, they are usually straightforward to both find and fix.&lt;&#x2F;p&gt;
&lt;p&gt;&quot;MainActor bad&quot; doesn&#x27;t just lack nuance, it can lead to tremendously complex systems that also perform &lt;strong&gt;worse&lt;&#x2F;strong&gt;. And I&#x27;m going to change the conversation here even if it kills me.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;custom-actors&quot;&gt;Custom Actors&lt;&#x2F;h2&gt;
&lt;p&gt;Frequently, when faced with singleton problems, people start turning classes into &lt;a href=&quot;&#x2F;actors&quot;&gt;actors&lt;&#x2F;a&gt;. Actors are &lt;code&gt;Sendable&lt;&#x2F;code&gt;, so you&#x27;ve fixed the problem at hand. But, you&#x27;ve now introduced potential problems at every single access site. That&#x27;s because actor accesses must be asynchronous, and their input and outputs now need to be &lt;code&gt;Sendable&lt;&#x2F;code&gt; too. This &lt;strong&gt;can&lt;&#x2F;strong&gt; work. But it can also be a complete nightmare. You may end up trading one problem for many more. There is a correlation between people having a bad time with Swift Concurrency and using actors.&lt;&#x2F;p&gt;
&lt;p&gt;Actors might work, but I would &lt;strong&gt;never&lt;&#x2F;strong&gt; reach for them first.&lt;&#x2F;p&gt;
&lt;p&gt;Another, related option is using a custom global actor. This is fairly similar to the &lt;code&gt;@MainActor&lt;&#x2F;code&gt; approach. It&#x27;s logical too, because you are protecting a global resource. Usually people go for this in an attempt to avoid shifting work to the main thread. Global actors can do this. However, they come with all the same downsides as regular actor types, plus one more! Global actors need to be encoded into the type system, with all these &lt;code&gt;@MyCustomActor&lt;&#x2F;code&gt; annotations. This can be a real pain to remove if you later on change your mind.&lt;&#x2F;p&gt;
&lt;p&gt;Also, I just do not like using actors as a means of getting access to background execution. That&#x27;s not the purpose of &lt;a href=&quot;&#x2F;actors&quot;&gt;actors&lt;&#x2F;a&gt;. There are often better, more &lt;a href=&quot;&#x2F;synchronous-work&quot;&gt;appropriate tools&lt;&#x2F;a&gt; for this.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;adding-locks&quot;&gt;Adding Locks&lt;&#x2F;h2&gt;
&lt;p&gt;This is an interesting one. You probably got here because you need your accesses to remain synchronous, you&#x27;ve determined that you do need to use this type from multiple threads, but your type also isn&#x27;t thread-safe. Finding this issue is good!&lt;&#x2F;p&gt;
&lt;p&gt;However, I want you to think &lt;strong&gt;extremely&lt;&#x2F;strong&gt; hard about the state of your system today. Are you adding locks to a type that is accessed 90% of the time on the main thread? Do you understand the possibilities of deadlocks and implications of fine vs coarse-grain locking? Are you actually, 100% sure the complexity of locks is the right trade-off? Do you understand the performance problems with using dispatch queues for synchronization?&lt;&#x2F;p&gt;
&lt;p&gt;If you are cool with all that, the &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;synchronization&#x2F;mutex&quot;&gt;Mutex&lt;&#x2F;a&gt; type can help make this easier. Traditional synchronization primitives require making a type &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt;. This turns off checking for the entirety of the type. But, &lt;code&gt;Mutex&lt;&#x2F;code&gt; is special and can do better! It &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0433-mutex.md&quot;&gt;makes use&lt;&#x2F;a&gt; of two new language features, non-Copyable and non-Escapable types, to make it possible for a class that uses it to be &lt;strong&gt;checked&lt;&#x2F;strong&gt; &lt;code&gt;Sendable&lt;&#x2F;code&gt;. And if its OS availability is a problem, you can get the source from the Swift standard library and just paste it into your project for now. This really does work!&lt;&#x2F;p&gt;
&lt;p&gt;Update: I also think I&#x27;ve been underestimating the utility of &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;os&#x2F;osallocatedunfairlock&quot;&gt;OSAllocatedUnfairLock&lt;&#x2F;a&gt; here. I used to think of it as just another manual lock. It isn&#x27;t able to offer the same degree of compile-time safety as &lt;code&gt;Mutex&lt;&#x2F;code&gt; can, but it does go further than some other locking mechanisms. Thanks so much to Patrick for prompting me to look at it more closely.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;singleton-initialization&quot;&gt;Singleton Initialization&lt;&#x2F;h2&gt;
&lt;p&gt;One pattern that I&#x27;ve run into a number of times is a singleton that requires some external initialization or set up. Usually this happens during launch, and after it&#x27;s done, the type is fully thread-safe. To my knowledge, Swift currently lacks a means of modeling a system that starts off mutable but later becomes immutable.&lt;&#x2F;p&gt;
&lt;p&gt;I &lt;strong&gt;think&lt;&#x2F;strong&gt; you have very few options here aside from &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt;. But if you have other ideas let me know!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-best-option&quot;&gt;&quot;The Best&quot; Option?&lt;&#x2F;h2&gt;
&lt;p&gt;Actors are likely to be highly-invasive and are a common regret during a Swift 6 migration. Global actors are even more invasive. I&#x27;d avoid them, but I typically opt for an actor over a manual lock &lt;strong&gt;if&lt;&#x2F;strong&gt; I can tolerate the trade-offs.&lt;&#x2F;p&gt;
&lt;p&gt;But I think it typically comes down to this. Have an already thread-safe type? &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt;. Otherwise, &lt;code&gt;@MainActor&lt;&#x2F;code&gt; is likely the best option for both simplicity &lt;strong&gt;and&lt;&#x2F;strong&gt; performance. Yeah I said it.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>When should you use an actor?</title>
        <published>2025-09-06T00:00:00+00:00</published>
        <updated>2025-09-06T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/actors/"/>
        <id>https://massicotte.org/actors/</id>
        
        <content type="html" xml:base="https://massicotte.org/actors/">&lt;p&gt;I enjoy technical conversations that happen across different blogs. One in particular that I revisited recently was a very thought-provoking exchange on &lt;a href=&quot;https:&#x2F;&#x2F;davedelong.com&#x2F;blog&#x2F;2017&#x2F;12&#x2F;07&#x2F;misusing-enums&#x2F;&quot;&gt;enum vs struct&lt;&#x2F;a&gt;. The whole thing is worth your time!&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m going to attempt to tackle a similar kind of question that I get a lot: when should you reach for an actor?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;value-vs-reference&quot;&gt;Value vs Reference&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s start by grouping up structs and enums together. We&#x27;ll just call those value types. The essential quality of a value type is every instance is a unique copy. If you have one, by definition, no one else can access it but you. Local reasoning, as they say.&lt;&#x2F;p&gt;
&lt;p&gt;Value types are great!&lt;&#x2F;p&gt;
&lt;p&gt;However, there are situations where you need a way to share a single source of truth. You can certainly store &quot;truth&quot; (ie some set of variables) in a value type, but what you cannot do is share it. Every consumer gets its own copy and will not see changes made to any other copy. This is something only reference types can do.&lt;&#x2F;p&gt;
&lt;p&gt;Reference types allow you to share an instance. I think you can get quite philosophical on when&#x2F;why you might decide to share state like this. Even if you are very value type-oriented, sometimes a system out of your control, like SwiftUI, might just require a reference type.
The point is, reference types are often necessary and sometimes might even be preferred.&lt;&#x2F;p&gt;
&lt;p&gt;But Swift gives us two kinds of reference types: classes and actors.&lt;&#x2F;p&gt;
&lt;p&gt;(Wait! I&#x27;ve forgotten some important things. Tuples are value types, and closures are reference types. This omission doesn&#x27;t change the concepts here, but this is still worth being aware of.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;quick-refresher&quot;&gt;Quick refresher&lt;&#x2F;h2&gt;
&lt;p&gt;Before Swift&#x27;s concurrency system, you might protect data using a lock, a queue, or maybe a dedicated thread. Deciding what data to protect and how was entirely up to you. This was all about the stuff &quot;inside function bodies&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;Swift guarantees thread safety (preventing data races) by modelling the concurrent behavior of a program using the type system. Think about this as the &quot;stuff outside of function bodies&quot;. It does this by doing two things.&lt;&#x2F;p&gt;
&lt;p&gt;First, it divides up data into two groups. Data that needs protection (non-Sendable) and data that does not (Sendable). And then, it models the mechanisms that actually implement the protecting. These mechanisms are represented by an actor.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actors&quot;&gt;Actors&lt;&#x2F;h2&gt;
&lt;p&gt;Classes and structs are surprisingly interchangeable. It&#x27;s often very easy to go from one to the other without making many changes. It turns out that classes and actors are quite interchangeable too. As I am fond of saying, they even have the same number of characters, how different could they be?&lt;&#x2F;p&gt;
&lt;p&gt;Well, they are different in &lt;strong&gt;one&lt;&#x2F;strong&gt; very important way and it can change everything.&lt;&#x2F;p&gt;
&lt;p&gt;An actor instance defines its own so-called isolation domain. This is the whole purpose of an actor - to create a single unit of protection. This gives every actor instance a little private spot where it can run synchronous code independent of any other actor, including the MainActor.&lt;&#x2F;p&gt;
&lt;p&gt;An actor exists to protect non-Sendable data - stuff that is thread-unsafe. Except there is a problem. Their ability to protect thread unsafe data comes with a cost: you must now use &lt;code&gt;await&lt;&#x2F;code&gt;. Actors do not support synchronous accesses from the outside world.&lt;&#x2F;p&gt;
&lt;p&gt;This means &lt;strong&gt;all&lt;&#x2F;strong&gt; external accesses to an actor must be asynchronous. And that can have huge, and often negative, implications on a design.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;synchronous-accesses&quot;&gt;Synchronous accesses&lt;&#x2F;h2&gt;
&lt;p&gt;Whenever you are thinking about introducing concurrency into a system it is critical you consider synchronous accesses. Because actors just don&#x27;t support that.&lt;&#x2F;p&gt;
&lt;p&gt;In fact, I think it can be quite useful to think of an actor as a remote network service. Its data is physically inaccessible to your process, off on some server somewhere. You must make a network request to interact with the system. Inputs to your request must be packaged up and sent (💡... Sendable?). The same goes for the system&#x27;s responses. Other requests to the system could be happening at the same time.&lt;&#x2F;p&gt;
&lt;p&gt;Actors, in many ways, really &lt;strong&gt;are&lt;&#x2F;strong&gt; remote systems.&lt;&#x2F;p&gt;
&lt;p&gt;They do have some important differences though. Actors are, in general, extremely lightweight. They are very cheap both to create and to interact with. Communicating with actors also does not require any data serialization. Like all good metaphors, this one breaks down when you look closely.&lt;&#x2F;p&gt;
&lt;p&gt;(Related, I have something else written about &lt;a href=&quot;&#x2F;synchronous-work&quot;&gt;synchronous work&lt;&#x2F;a&gt; you might find interesting.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;questions&quot;&gt;Questions&lt;&#x2F;h2&gt;
&lt;p&gt;The interface to an actor, being a different isolation domain, must be asynchronous. Do you want to make that trade-off? Can the other parts of your system even tolerate it?&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s what I was able to come up with.&lt;&#x2F;p&gt;
&lt;p&gt;You choose a class because you have more than one thing that requires a reference to its state. Simple.&lt;&#x2F;p&gt;
&lt;p&gt;Deciding to use an actor is less simple. In fact, I think there are four conditions that must be satisfied to truly require an actor. First, you have some non-Sendable state. Second, like a class, that state needs to be referenced from more than one place. Third, operations that involve that state must be atomic. And forth, those operations cannot be run on an existing actor.&lt;&#x2F;p&gt;
&lt;p&gt;(And earlier version of this post omitted this second point. But, I don&#x27;t think it is obvious so I&#x27;ve added it.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;why-not-mainactor&quot;&gt;Why not MainActor?&lt;&#x2F;h2&gt;
&lt;p&gt;Remember, every Swift program comes with a built-in actor: MainActor. This actor already manages an absolutely gigantic amount of state. And the compiler team gave us the option to make this the default for a reason.&lt;&#x2F;p&gt;
&lt;p&gt;Managing state on the MainActor is a good idea in so many situations, because that state is fundamentally tied to the UI. And, you probably will need to access it synchronously at some point from the main thread.&lt;&#x2F;p&gt;
&lt;p&gt;A surprisingly common pattern I see is a &quot;network client&quot; actor that contains zero non-Sendable state. In a lot of ways, this arrangement does not make sense. The whole purpose of an actor is to protect thread-unsafe data and this type doesn&#x27;t have any. However, I think this construct is often used because a side effect of an actor is stuff will never run on the main thread.&lt;&#x2F;p&gt;
&lt;p&gt;And you know what? That&#x27;s an ok place to start. But it also means that this network client has an artificial limitation. It can execute more than one request simultaneously, but it cannot do any other synchronous work concurrently, such as decoding responses. This is a situation where a MainActor type with a few well-placed &lt;code&gt;async let&lt;&#x2F;code&gt; or &lt;code&gt;@concurrent&lt;&#x2F;code&gt; functions would be simpler, more flexible, and it would perform better too!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actor-justification&quot;&gt;Actor justification&lt;&#x2F;h2&gt;
&lt;p&gt;I made a joke the other day. But as soon as I made it, I started questioning how much of a joke it actually was:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Every custom Swift actor needs justification in a comment doc that says &quot;this is an actor because...&quot; and the answer isn&#x27;t allowed to be &quot;it helps deal with concurrency errors&quot;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;I&#x27;m going to draw a line in the sand here. It is &lt;strong&gt;always&lt;&#x2F;strong&gt; a mistake to introduce an actor as a means of addressing a concurrency diagnostic you do not understand. It might work. You might never even need to revisit it. But doing this is reinforcing the wrong mental model of when, why, and how you should introduce actors into your designs. And worse, it could make it easier to continue down the path of building what ends up being fundamentally the wrong system. I have done this &lt;strong&gt;multiple times&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I actually do think there is method you can use to determine if an actor is appropriate.&lt;&#x2F;p&gt;
&lt;p&gt;You need a) non-Sendable state that requires b) atomic mutations which c) cannot be done on the main thread. If you are missing any one of these qualities you &lt;strong&gt;should&lt;&#x2F;strong&gt; be looking at other options. And if you cannot tolerate asynchronous accesses, then you &lt;strong&gt;must&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Actors are very useful tools. But an actor means more concurrency. More need for Sendable types. They are inherently more complex, and you should be thinking twice before introducing more complexity unless it is truly necessary.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;footnote-sendable-protocols&quot;&gt;Footnote: Sendable Protocols&lt;&#x2F;h2&gt;
&lt;p&gt;One situation I have encountered that can push you towards actors is protocols that require a &lt;code&gt;Sendable&lt;&#x2F;code&gt; conformance. This is a big topic, but just quickly.&lt;&#x2F;p&gt;
&lt;p&gt;Protocols that require a &lt;code&gt;Sendable&lt;&#x2F;code&gt; type usually make the API producer&#x27;s life easier in exchange for making the API consumer&#x27;s life more complex. Sometimes it really is necessary, but it&#x27;s a pretty big constraint on a design. It should be used with great care.&lt;&#x2F;p&gt;
&lt;p&gt;If you find yourself needing to conform to such a protocol, that alone could be a good reason to consider an actor. Just don&#x27;t forget, what you need is the &lt;code&gt;Sendable&lt;&#x2F;code&gt; conformance. A global actor-isolated type, with &lt;code&gt;@MainActor&lt;&#x2F;code&gt;, gives you that as well.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>I am not a calculator</title>
        <published>2025-08-06T00:00:00+00:00</published>
        <updated>2025-08-06T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/not-a-calculator/"/>
        <id>https://massicotte.org/not-a-calculator/</id>
        
        <content type="html" xml:base="https://massicotte.org/not-a-calculator/">&lt;p&gt;I have never asked ChatGPT anything. I haven&#x27;t tried any coding agents. So far, I have not ever intentionally used an LLM. This kind of fits with my personality in general. I&#x27;m quite slow to adopt new things. However, that doesn&#x27;t mean I&#x27;m not paying attention.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve been trying my best to follow along with developments in AI. So far, it&#x27;s been kinda hard &lt;em&gt;not&lt;&#x2F;em&gt; to do that. It sometimes feels like AI is the only thing being discussed, especially in my circles. And while the applications in programming are definitely interesting to me, I&#x27;m trying to stay quite broad.&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s just this one thing I cannot stop thinking about. I keep seeing it thrown around all the time. Is AI actually &quot;just a tool&quot;?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-definition-of-a-tool&quot;&gt;The definition of a tool&lt;&#x2F;h2&gt;
&lt;p&gt;The form of AI we have available today is large language models. I don&#x27;t have a real understanding of how an LLM works. Despite that, calling them &quot;tools&quot; has always felt intuitively incorrect to me. I have only done cursory research, but it seems like this is incredibly difficult to define. What even is a tool?&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s the very first sentence from &lt;a href=&quot;https:&#x2F;&#x2F;en.m.wikipedia.org&#x2F;wiki&#x2F;Tool&quot;&gt;Wikipedia&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;A tool is an &lt;strong&gt;object&lt;&#x2F;strong&gt; that can extend an individual&#x27;s ability to modify features of the surrounding environment or help them accomplish a particular task.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;I think this is a helpful definition. But I emphasized &quot;object&quot; there, because restricting the concept to physical things feels totally inadequate. In my mind, software can definitely also count as a &quot;tool&quot;. Unimportant semantics maybe?&lt;&#x2F;p&gt;
&lt;p&gt;I thought on this for a while and was unable to come up with a satisfactory alternative. However, I immediately zeroed in on something which I believe to be a central concept. An individual can &lt;strong&gt;use&lt;&#x2F;strong&gt; a tool, but an individual cannot themselves &lt;strong&gt;be&lt;&#x2F;strong&gt; a tool.&lt;&#x2F;p&gt;
&lt;p&gt;(Originally, I used &quot;person&quot; above, but I was rather annoyed to remember that crows can also use tools.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;non-physical-tools&quot;&gt;Non-physical tools&lt;&#x2F;h2&gt;
&lt;p&gt;Lots of tools do work faster, more precisely, or with greater strength than a human. There are many tasks that are totally impossible without the use of a tool. The human body has both physical and mental limits.&lt;&#x2F;p&gt;
&lt;p&gt;Humans can do arithmetic. However, we&#x27;re slow and can make mistakes. And, perhaps equally important, it often isn&#x27;t that engaging a task. I just want to know what 16 and 1&#x2F;3 inches is in centimeters so I can move on with my life.&lt;&#x2F;p&gt;
&lt;p&gt;Thank goodness, there&#x27;s a tool for this: a calculator!&lt;&#x2F;p&gt;
&lt;p&gt;Calculators have some interesting properties. The work they perform isn&#x27;t outside of my physical abilities - this is exclusively about my mental capacity. I cannot do this calculation in my head with sufficient speed or precision. I&#x27;m sure there are also people out there than enjoy doing mental calculations, I just happen to not be one of them.&lt;&#x2F;p&gt;
&lt;p&gt;I think it is quite interesting to note that it&#x27;s possible to move calculation into the physical world. I can count coins and even use them as aids more complex mathematical operations. Think of an &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Abacus&quot;&gt;abacus&lt;&#x2F;a&gt;. Think of the &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Analytical_engine&quot;&gt;analytical engine&lt;&#x2F;a&gt;! Phenomenally complex ones perhaps, but computer systems are physical things too.&lt;&#x2F;p&gt;
&lt;p&gt;The &quot;calculator&quot; here also doesn&#x27;t have to be a stand-alone device. It can be an app on my phone. It can be a voice assistant.&lt;&#x2F;p&gt;
&lt;p&gt;(I briefly got distracting thinking about the distinction between &quot;physical&quot; capability and &quot;mental&quot; capability here. My brain is a physical thing, after all. I think that is very interesting intellectually, but I&#x27;m not sure that adds to this particular discussion much.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;humans-are-not-tools&quot;&gt;Humans are not tools&lt;&#x2F;h2&gt;
&lt;p&gt;That voice assistant case is actually fascinating. I can use natural language to ask a glass-and-metal rectangle what 16 and 1&#x2F;3 inches is in centimeters and it will answer me (more or less).&lt;&#x2F;p&gt;
&lt;p&gt;This &quot;voice assistant&quot; concept is quite similar to a human. In fact, you could very easily imagine me trying to install a hook on the wall. I&#x27;ve got a level in one hand and a tape measure in the other. I need to do this stupid conversion but I didn&#x27;t realize it until I&#x27;d already positioned everything.&lt;&#x2F;p&gt;
&lt;p&gt;Except I happen to have a friend on speaker-phone! So I just ask them &quot;hey, can you tell me what 16 and 1&#x2F;3 inches is in centimeters?&quot;. Same rectangle, same voice, same question.&lt;&#x2F;p&gt;
&lt;p&gt;I probably just expect this person to use &lt;strong&gt;their&lt;&#x2F;strong&gt; phone and do this calculation on my behalf. I&#x27;d be surprised if they said: &quot;Hang on, I just have to go grab some paper and sharpen a pencil!&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;But, this person might respond with &quot;about 40&quot;. And honestly that&#x27;s pretty good! They know an inch is about 2.5 centimeters and they are just a little quicker with mental calculations than I am.&lt;&#x2F;p&gt;
&lt;p&gt;Or, perhaps they say &quot;how many potatoes is that?&quot;. This sounds like a totally ridiculous response! Unless you knew that we&#x27;d just been joking around in the kitchen yesterday about the size of potatoes we found at the grocery store.&lt;&#x2F;p&gt;
&lt;p&gt;They might decide to use a tool themselves, or do a quick approximation, or even make a joke. The context of the situation matters tremendously. But this other human does not suddenly become a tool if they help me accomplish a task.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;this-is-a-hammer&quot;&gt;This is a hammer&lt;&#x2F;h2&gt;
&lt;p&gt;I can hold up a frying pan and say &quot;this is a hammer&quot;. It might be a &lt;strong&gt;bad&lt;&#x2F;strong&gt; hammer, but it could work in a pinch. A frying pan could also be a weapon. How I use the thing doesn&#x27;t change the fact that a frying pan was built to cook stuff.&lt;&#x2F;p&gt;
&lt;p&gt;The purpose of AI is to replicate the mental capabilities of humans. It is called artificial &lt;strong&gt;intelligence&lt;&#x2F;strong&gt;. We can definitely argue about &lt;strong&gt;how&lt;&#x2F;strong&gt; or even &lt;strong&gt;if&lt;&#x2F;strong&gt; current implementations succeed. But that is what they are trying to do. If I understand right, the goal isn&#x27;t just to match human levels of intelligence but to exceed them.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m tempted to say that even a super-intelligent system &lt;strong&gt;without&lt;&#x2F;strong&gt; consciousness could be a tool. It would just sit there, patiently waiting for requests from humans. Augmenting their ability to achieve whatever task they have set out to do. However, as I imagine this, I cannot help but feel like it is somehow... disconcerting. What&#x27;s the difference between a human that has super-intelligence and a human that just happens to have a super-intelligent machine?&lt;&#x2F;p&gt;
&lt;p&gt;What if every single human being had one of these machines except &lt;strong&gt;you&lt;&#x2F;strong&gt;?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conscious-less-human-ish-things&quot;&gt;Conscious-less human-ish things&lt;&#x2F;h2&gt;
&lt;p&gt;Here&#x27;s where I get stuck. Can &quot;intelligence&quot; be a tool? My own intelligence is not some tool I wield. I&#x27;m not sure &quot;me&quot; and &quot;my intelligence&quot; can truly be seperated. I think it is possible this is actually reversed. It requires intelligence to pick up the frying pan and use it as a hammer. Without intelligence, can there even be tools?&lt;&#x2F;p&gt;
&lt;p&gt;Yet more philosophical nonsense.&lt;&#x2F;p&gt;
&lt;p&gt;There was a time when non-trivial amounts of human effort were spent doing calculations by hand. When calculators were invented, it freed us up to focus on more interesting stuff. And it makes less mistakes too!&lt;&#x2F;p&gt;
&lt;p&gt;&quot;This is just automation and that always results in &lt;strong&gt;more&lt;&#x2F;strong&gt; work!&quot; Yeah I have heard of the &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Lump_of_labour_fallacy&quot;&gt;lump of work fallacy&lt;&#x2F;a&gt;. Now that can we stop messing around with manual calculations, there&#x27;s more time to take on bigger problems.&lt;&#x2F;p&gt;
&lt;p&gt;Except you cannot ask a calculator to explain molecular biology in 1 sentence. Or rewrite this blog post in iambic pentameter. In my opinion, we are &lt;strong&gt;clearly&lt;&#x2F;strong&gt; in uncharted territory. We have never automated thinking (or some approximation of it) before. Nevermind equal-or-greater human-level intelligence.&lt;&#x2F;p&gt;
&lt;p&gt;The purpose of a calculator is to calculate. What is the purpose of an LLM? Of general AI?&lt;&#x2F;p&gt;
&lt;p&gt;So, yes. You absolutely can use LLMs, the AI we have available today, as tools. People are doing it all the time. But people are also using them as teachers and lawyers. As therapists. Even as friends (of varying types, no doubt).&lt;&#x2F;p&gt;
&lt;p&gt;I know of more that one person that has used an LLM to replicate me (or at least the content of my technical writing and guidance) personally.&lt;&#x2F;p&gt;
&lt;p&gt;Your use of the thing does not define the thing, fine. But, this sure doesn&#x27;t sound like a calculator to me.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>A (Re-)Introduction to ExtensionKit</title>
        <published>2025-06-11T00:00:00+00:00</published>
        <updated>2025-06-11T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/extensionkit-intro/"/>
        <id>https://massicotte.org/extensionkit-intro/</id>
        
        <content type="html" xml:base="https://massicotte.org/extensionkit-intro/">&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;extensionkit&quot;&gt;ExtensionKit&lt;&#x2F;a&gt; was a pretty significant new feature, introduced three years ago with macOS Ventura. But, I wouldn&#x27;t be surprised if you&#x27;ve never even heard of it, as it had a strangely quiet introduction. There were no sessions or labs about it during WWDC 2022. I only discovered it because a friend stumbled across the beta documentation and sent it to me.&lt;&#x2F;p&gt;
&lt;p&gt;It ended up being one of those things that arrived at just the right time. I was working quite a lot on an open source text editor, &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;Chime&quot;&gt;Chime&lt;&#x2F;a&gt;. I had been interested in adding an extension system and I ended up using ExtensionKit as the basis for what turned into &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;ChimeKit&quot;&gt;ChimeKit&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But, all this happened a while ago. And ever since then, I&#x27;ve been paying close attention to ExtensionKit&#x27;s status on iOS. Well, it has finally happened. ExtensionKit looks like it is now supported on iOS 26. And from what I can tell so far, thanks to some &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;KhaosT&#x2F;UIExtensionExample&quot;&gt;great work&lt;&#x2F;a&gt; from &lt;a href=&quot;https:&#x2F;&#x2F;mastodon.tz.is&#x2F;@khaost&quot;&gt;Khaos&lt;&#x2F;a&gt;, it appears to support all the same functionality as it does on macOS.&lt;&#x2F;p&gt;
&lt;p&gt;After completing the initial work on Chime&#x27;s extensions system, I wrote about my experiences with ExtensionKit. It turned out to be a big topic so I broke it up into a series. And now that this system is available for iOS, I have a weird feeling there&#x27;s going to be some renewed interest. However, after re-reading them, I don&#x27;t think the original posts aged that well. So, I decided to revise them and repost.&lt;&#x2F;p&gt;
&lt;p&gt;This first one is really just focusing on getting familiar with what ExtensionKit is all about. I&#x27;ll be updating the rest soon!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;capabilities&quot;&gt;Capabilities&lt;&#x2F;h2&gt;
&lt;p&gt;At a high-level, ExtensionKit allows for inter-application operation. This means that an app from developer A can build an extension which can then be loaded into an app build by developer B. Seems like a big deal.&lt;&#x2F;p&gt;
&lt;p&gt;It appears that ExtensionKit, and the lower-level &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;extensionfoundation&quot;&gt;ExtensionFoundation&lt;&#x2F;a&gt; have been around for quite a while. All of the existing iOS and macOS extension features are based on it. But, it also looks like Apple has been using this system internally as well. This bodes well for any framework, and ExtensionKit has indeed proven to be pretty solid.&lt;&#x2F;p&gt;
&lt;p&gt;You can define extension points in your app, either with or without a UI component. All communication between extension and host goes over XPC, and there&#x27;s a bit of infrastructure provided by Apple for discovering available extensions and establishing a connection.&lt;&#x2F;p&gt;
&lt;p&gt;One of the most exciting things ExtensionKit can do is remote views. This is a view that is constructed with SwiftUI and managed within the extension, but displayed within the hosting application. As far as I can tell, this arrangement is totally transparent and supports virtually everything that SwiftUI can do, even animation. Perhaps the only real downside is window&#x2F;view resizing can sometimes have a little lag. However, keep in mind that view actually lives within the extension&#x27;s process. While visible in the hosting application, it is inaccessible programmatically.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;communication&quot;&gt;Communication&lt;&#x2F;h2&gt;
&lt;p&gt;Communication between extension and host is all done using &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;xpc&quot;&gt;XPC&lt;&#x2F;a&gt;. There&#x27;s one global XPC connection per extension, but there&#x27;s also an optional connection per UI scene. At first, this was surprising to me. But, once I started actually experimenting with UIs, I realized this arrangement makes a lot of sense. While there will be only one extension instance, an extension can be asked to render multiple instances of its views. Of course, your design may not support this. But, if you do, this is a good means of coordination.&lt;&#x2F;p&gt;
&lt;p&gt;Extension hosts (apps that support loading extensions) will almost certainly want to provide some kind of framework that defines a higher-level API for extension-host interaction. This is an area that can demand some careful work. First, you want to provide a reasonable API for extension developers. But, you also need to consider forwards- and backwards-compatibility. There&#x27;s nothing provided by ExtensionKit to keep these APIs in sync across the versions of extensions and app that your users have installed. There is also no way, as far as I can tell, to get any metadata about an extension other than its host app bundle and extension point id.&lt;&#x2F;p&gt;
&lt;p&gt;New in the 26 releases is support for &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;xpc&#x2F;xpcsession&quot;&gt;XPCSession&lt;&#x2F;a&gt;. I haven&#x27;t yet had a chance to play around with this. But, when XCPSession was first introduced I did attempt to make a backwards-compatible wrapper around it called &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;XPCConnectionSession&quot;&gt;XPCConnectionSession&lt;&#x2F;a&gt;. Perhaps I should revisit this now!&lt;&#x2F;p&gt;
&lt;p&gt;In the meantime, however, you might like &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;AsyncXPCConnection&quot;&gt;this package&lt;&#x2F;a&gt;, which provides concurrency support for &lt;code&gt;NSXPCConnection&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sandboxing&quot;&gt;Sandboxing&lt;&#x2F;h2&gt;
&lt;p&gt;While not really a new thing for iOS, on macOS ExtensionKit will refuse to load any extensions that do not have the sandbox entitlement set. How much of a problem this is really depends on what your extension developers need to do. Fortunately, if it is a problem, you have some options.&lt;&#x2F;p&gt;
&lt;p&gt;It is possible to pass URL bookmark data across the XPC connection to share access. I&#x27;ve found it pretty confusing to understand how to use the security features of bookmarks, but in this case, it&#x27;s proven to be easy.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; create the data on the side that has access&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; data &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; url&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;bookmarkData()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; a side-effect of resolving it on the other end will grant the process access&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; stale: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; _ &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; URL(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	resolvingBookmarkData: data,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	options: [&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;withoutUI],
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	relativeTo: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	bookmarkDataIsStale: &lt;span class=&quot;z-keyword z-operator z-bitwise z-swift&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;stale
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If sharing file access isn&#x27;t sufficient, and it definitely was not for Chime, you&#x27;ll need to turn to other methods. Having a direct IPC mechanism via XPC is pretty darn powerful and that could be a useful tool for stuff like this.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;distribution&quot;&gt;Distribution&lt;&#x2F;h2&gt;
&lt;p&gt;An interesting quirk of ExtensionKit is that extensions &lt;strong&gt;must&lt;&#x2F;strong&gt; be bundled and delivered within a &lt;code&gt;.app&lt;&#x2F;code&gt;. They cannot be distributed as standalone artifacts. I think this makes a lot of sense when you are attempting to expose functionality of an existing application in the form of an extension. But, there could be reasons why you might want to make only the extension itself. This even makes sense for Apple&#x27;s own supported use-cases, like Safari and Xcode editor extensions.&lt;&#x2F;p&gt;
&lt;p&gt;Now, you totally can just make a little wrapper app that does nothing but contain your extension. You can even get these minimal, placeholder apps onto the App Store. While I think this is a pain, I don&#x27;t imagine it will be changing any time soon.&lt;&#x2F;p&gt;
&lt;p&gt;Interestingly, it is also possible to bundle extensions directly within the hosting application. At first, this might seem like a strange thing to do. But it can make sense, for example to improve security. This seems like it is one of the primary intended &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;xcode&#x2F;creating-extensions-with-enhanced-security&quot;&gt;uses&lt;&#x2F;a&gt; for ExtensionKit on iOS.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;approval&quot;&gt;Approval&lt;&#x2F;h2&gt;
&lt;p&gt;Regardless of how you get an extension onto a user&#x27;s device, there&#x27;s one more required step before they can be used. Extensions have to be user-approved via &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;extensionkit&#x2F;exappextensionbrowserviewcontroller&quot;&gt;&lt;code&gt;EXAppExtensionBrowserViewController&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. This controller presents a UI that displays all available extensions, organized by containing application. You&#x27;ll have to find a place to put this view within your hosting app. And, adding to the integration complexity, users can both approve and revoke that approval at any time.&lt;&#x2F;p&gt;
&lt;p&gt;Requiring user approval is reasonable. But, I&#x27;m really happy to say that extensions bundled within the hosting app itself are auto-approved.&lt;&#x2F;p&gt;
&lt;p&gt;On macOS, extensions approval status is visible within System Settings, under &quot;Login Items &amp;amp; Extensions&quot;. The UI for this isn&#x27;t as detailed as I&#x27;d like and I have found it to be particularly painful during the debugging cycle in the past. Maybe there are improvements in 26 though...&lt;&#x2F;p&gt;
&lt;h2 id=&quot;ios-support&quot;&gt;iOS Support?&lt;&#x2F;h2&gt;
&lt;p&gt;(I&#x27;m leaving this section untouched from my original 3 year old post because VINDICATION)&lt;&#x2F;p&gt;
&lt;p&gt;Right now, &lt;strong&gt;hosting&lt;&#x2F;strong&gt; ExtensionKit extensions can only be done from macOS. But, as far as I can tell, all of the extension-side APIs are available to iOS, tvOS and watchOS as well. I think this, combined with the extremely conspicuous lack of WWDC sessions means ExtensionKit was supposed to ship with iOS 16, but was pulled at the last minute.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ll also submit as evidence &lt;code&gt;EXAppExtensionBrowserViewController.h&lt;&#x2F;code&gt; as found in Xcode 14.0 beta 6:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;m&quot; class=&quot;language-m z-code&quot;&gt;&lt;code class=&quot;language-m&quot; data-lang=&quot;m&quot;&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-objc&quot;&gt;#if&lt;&#x2F;span&gt; !TARGET_OS_WATCH
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-objc&quot;&gt;#if&lt;&#x2F;span&gt; TARGET_OS_OSX
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-import z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-import z-objc&quot;&gt;#import&lt;&#x2F;span&gt; &lt;span class=&quot;z-string z-quoted z-other z-lt-gt z-include z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-objc&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;AppKit&#x2F;AppKit.h&lt;span class=&quot;z-punctuation z-definition z-string z-end z-objc&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-objc&quot;&gt;#else&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-import z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-import z-objc&quot;&gt;#import&lt;&#x2F;span&gt; &lt;span class=&quot;z-string z-quoted z-other z-lt-gt z-include z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-objc&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;UIKit&#x2F;UIKit.h&lt;span class=&quot;z-punctuation z-definition z-string z-end z-objc&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-objc&quot;&gt;#endif&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; TARGET_OS_OSX
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-assumed-macro z-c&quot;&gt;NS_ASSUME_NONNULL_BEGIN
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-objc&quot;&gt;&lt;span class=&quot;z-variable z-function z-objc&quot;&gt;API_AVAILABLE&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-group z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-objc&quot;&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function-call z-objc&quot;&gt;&lt;span class=&quot;z-meta z-group z-objc&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-objc&quot;&gt;&lt;span class=&quot;z-variable z-function z-objc&quot;&gt;macos&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-group z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-objc&quot;&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function-call z-objc&quot;&gt;&lt;span class=&quot;z-meta z-group z-objc&quot;&gt;&lt;span class=&quot;z-constant z-numeric z-float z-decimal z-c&quot;&gt;13&lt;span class=&quot;z-punctuation z-separator z-decimal z-c&quot;&gt;.&lt;&#x2F;span&gt;0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function-call z-objc&quot;&gt;&lt;span class=&quot;z-meta z-group z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-objc&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-group z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-objc&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-function z-objc&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-objc&quot;&gt;API_UNAVAILABLE&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-objc&quot;&gt;&lt;span class=&quot;z-meta z-group z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-objc&quot;&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-objc&quot;&gt;&lt;span class=&quot;z-meta z-group z-objc&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-objc&quot;&gt;ios&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-objc&quot;&gt;,&lt;&#x2F;span&gt; &lt;span class=&quot;z-variable z-parameter z-objc&quot;&gt;watchos&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-objc&quot;&gt;,&lt;&#x2F;span&gt; &lt;span class=&quot;z-variable z-parameter z-objc&quot;&gt;tvos&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-objc&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function z-objc&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-function z-objc&quot;&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-assumed-macro z-c&quot;&gt;EXTENSIONKIT_EXPORT
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-objc&quot;&gt;#if&lt;&#x2F;span&gt; TARGET_OS_OSX
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-interface-or-protocol z-objc&quot;&gt;&lt;span class=&quot;z-storage z-type z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-storage z-type z-objc&quot;&gt;@&lt;&#x2F;span&gt;interface&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-name z-type z-objc&quot;&gt;EXAppExtensionBrowserViewController&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-entity z-other z-inherited-class z-objc&quot;&gt;:&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-other z-inherited-class z-objc&quot;&gt;NSViewController&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-divider z-objc&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-interface-or-protocol z-objc&quot;&gt;&lt;span class=&quot;z-meta z-scope z-interface z-objc&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-interface-or-protocol z-objc&quot;&gt;&lt;span class=&quot;z-meta z-scope z-interface z-objc&quot;&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-storage z-type z-objc&quot;&gt;@&lt;&#x2F;span&gt;end&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-objc&quot;&gt;#else&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-interface-or-protocol z-objc&quot;&gt;&lt;span class=&quot;z-storage z-type z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-storage z-type z-objc&quot;&gt;@&lt;&#x2F;span&gt;interface&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-name z-type z-objc&quot;&gt;EXAppExtensionBrowserViewController&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-entity z-other z-inherited-class z-objc&quot;&gt;:&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-other z-inherited-class z-objc&quot;&gt;UIViewController&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-divider z-objc&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-interface-or-protocol z-objc&quot;&gt;&lt;span class=&quot;z-meta z-scope z-interface z-objc&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-interface-or-protocol z-objc&quot;&gt;&lt;span class=&quot;z-meta z-scope z-interface z-objc&quot;&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-objc&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-storage z-type z-objc&quot;&gt;@&lt;&#x2F;span&gt;end&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-objc&quot;&gt;#endif&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; TARGET_OS_OSX
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-assumed-macro z-c&quot;&gt;NS_ASSUME_NONNULL_END
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-objc&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-objc&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-objc&quot;&gt;#endif&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; !TARGET_OS_WATCH
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Today, I&#x27;m not sure you can do too much with ExtensionKit on non-macOS platforms. But, when you consider just how many entirely new types of apps could be built with it, just the &lt;strong&gt;idea&lt;&#x2F;strong&gt; is exciting.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;alternatives&quot;&gt;Alternatives&lt;&#x2F;h2&gt;
&lt;p&gt;Lots of apps offer some kind of plugin system. I would guess that nearly all use JavaScript to do it. There are many reasons why this makes sense. First, JavaScript is a very well-known and well-used language, with an enormous number of available libraries. Second, there are many (&lt;a href=&quot;https:&#x2F;&#x2F;nodejs.org&#x2F;&quot;&gt;node&lt;&#x2F;a&gt;, &lt;a href=&quot;https:&#x2F;&#x2F;deno.land&quot;&gt;deno&lt;&#x2F;a&gt;, &lt;a href=&quot;https:&#x2F;&#x2F;bun.sh&quot;&gt;bun&lt;&#x2F;a&gt;) JavaScript runtimes available, including Apple&#x27;s own &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;javascriptcore&quot;&gt;JavaScriptCore&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But, another big advantage is control over installation and execution. Any language that requires static compilation will have to deal with code-signing. ExtensionKit makes things even more complex with sandboxing, app-bundled delivery, and approval. Things are just much simpler, and potentially much more end-user-friendly with something like JavaScript.&lt;&#x2F;p&gt;
&lt;p&gt;Now, of course ExtensionKit does have some pretty compelling features. It&#x27;s all Swift, providing easy access to all of Apple&#x27;s first-party APIs. Its remote view capabilities are really amazing. And, it offers a straightforward and well-supported way for 3rd-party apps to integrate with each other. I&#x27;m sure all of these things are &lt;em&gt;possible&lt;&#x2F;em&gt; with another approach (on macOS anyways), but ExtensionKit makes them all easy.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;uses&quot;&gt;Uses&lt;&#x2F;h2&gt;
&lt;p&gt;My use for this was kind of niche and I bet it will prove to be atypical. But, I can see this becoming quite a thing. Many applications are very focused on solving a specific problem. Take a photo-editing app. No doubt it would come with a built-in camera control. But, there are dedicated camera applications out there that are far more capable.&lt;&#x2F;p&gt;
&lt;p&gt;With ExtensionKit, both apps could get more valuable. The editing app suddenly now gets access to super-high-quality camera apps that are familiar to their users. And those camera apps now have a whole new means of appealing to users. Direct integration like this would be awesome for both.&lt;&#x2F;p&gt;
&lt;p&gt;I think this could open the door to a lot of collaboration and commercial opportunities. My gut says independent developers will be particularly excited about this, since they are already in a good position to collaborate and put in the necessary technical work.&lt;&#x2F;p&gt;
&lt;p&gt;But make no mistake, that technical work is non-trivial. You really do have to design, build, and maintain an API to make this all possible. And only once that&#x27;s done can extensions actually be built. This stuff is not easy.&lt;&#x2F;p&gt;
&lt;p&gt;Because of the high bar here, I&#x27;m excited by the possibility of standardized interfaces across extensions&#x2F;host. Think a community-supported and open source &quot;external camera SDK&quot;. This could reduce the barrier to get started and enable more compatible extensions, more quickly. Such a thing could be quite hard to actually pull off, but I&#x27;m optimistic. If you have ideas let me know!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;next-up&quot;&gt;Next Up&lt;&#x2F;h2&gt;
&lt;p&gt;I certainly wasn&#x27;t expecting ExtensionKit when it was first introduced, but I&#x27;m really happy it showed up. And I&#x27;m delighted to see it has finally arrived for iOS. It made working on &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;ChimeKit&quot;&gt;ChimeKit&lt;&#x2F;a&gt; really fun, and I&#x27;m excited about what it makes possible.&lt;&#x2F;p&gt;
&lt;p&gt;ExtensionKit, and Chime&#x27;s use of it, turned out to be a pretty big topic. This is just an introduction, but hopefully it&#x27;s gotten you interested in learning more. Next up, I&#x27;ll be getting into details on the communication infrastructure used to build an ExtensionKit-based framework.&lt;&#x2F;p&gt;
&lt;p&gt;But, if you cannot wait to dig in more, check out &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;Extendable&quot;&gt;Extendable&lt;&#x2F;a&gt;, an open source package for working with ExtensionKit. It needs some attention, but I wanted to at least let people know it existed.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Resolve</title>
        <published>2025-05-23T00:00:00+00:00</published>
        <updated>2025-05-23T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/resolve/"/>
        <id>https://massicotte.org/resolve/</id>
        
        <content type="html" xml:base="https://massicotte.org/resolve/">&lt;p&gt;A little while ago I got worked up and I wrote a &lt;a href=&quot;&#x2F;leverage&quot;&gt;thing&lt;&#x2F;a&gt;. It received more attention than I expected and I want to thank everyone out there for the words of encouragement and support. You all give me tremendous hope.&lt;&#x2F;p&gt;
&lt;p&gt;And we need all the hope we can get because things have since gotten &lt;strong&gt;much worse&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Just to quickly recap: I have a problem with Apple funding X via advertising. In protest I decided to withhold sharing feedback with them and I encouraged the rest of the community to do the same.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-social-problem&quot;&gt;A social problem&lt;&#x2F;h2&gt;
&lt;p&gt;Because of that post, a friend unexpectedly reached out. During our conversation, she brought up something that I have had a tendency to forget. Lots of people still use X. And, critically, it remains an important online space for non-white men. I have definitely noticed this myself. But it was still a very welcome reminder.&lt;&#x2F;p&gt;
&lt;p&gt;There is, unfortunately, a problem. X is now controlled by people who organize and encourage attacks on marginalized groups. Attacks that are not just tolerated, but &lt;strong&gt;celebrated&lt;&#x2F;strong&gt;. No social platform can be perfect, but this is something I cannot accept.&lt;&#x2F;p&gt;
&lt;p&gt;No doubt, X remains an important place for many communities. But, its &lt;strong&gt;primary&lt;&#x2F;strong&gt; purpose is now to further the global rise of fascism.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;progress&quot;&gt;Progress&lt;&#x2F;h2&gt;
&lt;p&gt;Here&#x27;s the thing with X. It could be your people are still there (I certainly miss many friends who have not yet left). It could be you are having trouble building a new community somewhere else (this is damn hard). Maybe you understand what X has become, but fear for your own&#x2F;organization&#x27;s success without it. Unfortunately it&#x27;s also possible that you understand what X has become and just don&#x27;t care.&lt;&#x2F;p&gt;
&lt;p&gt;Or, it could be that you understand its goals and &lt;strong&gt;support&lt;&#x2F;strong&gt; them.&lt;&#x2F;p&gt;
&lt;p&gt;From an outsider&#x27;s perspective it&#x27;s just not possible to tell where you fall here. This issue of perception doesn&#x27;t go away even if you disagree with my assessment of X. But one easy way to help make this more clear is to also use the alternatives. Recently the &lt;a href=&quot;https:&#x2F;&#x2F;swift.org&quot;&gt;Swift&lt;&#x2F;a&gt; organization did just that.&lt;&#x2F;p&gt;
&lt;p&gt;X is in a permanent state of decline, in every possible sense. But you have to at least give people another place to try first. I&#x27;m incredibly grateful to see influential people and organizations in our community do things like this.&lt;&#x2F;p&gt;
&lt;p&gt;It &lt;strong&gt;matters&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;reactions&quot;&gt;Reactions&lt;&#x2F;h2&gt;
&lt;p&gt;There were two common responses to my initial post that I think are worth talking about.&lt;&#x2F;p&gt;
&lt;p&gt;The first was, basically, &quot;just stop using Apple stuff&quot;. This is definitely morally-consistent. But, it&#x27;s also a huge problem for me personally because that is what I do for a living. I&#x27;m sure I could adjust. But, I cannot help thinking that walking away would give up any leverage I have here, small as it might be.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s dangerously close to a rationalization, but I hope there&#x27;s at least a shred of logic to this.&lt;&#x2F;p&gt;
&lt;p&gt;The second common response was &quot;lol who even files feedback anyways?&quot; Many people believe that because their bugs go unanswered Apple doesn&#x27;t look at them. This is totally understandable. However, don&#x27;t forget that I worked there. Apple&#x27;s software releases are extremely dependent on feedback. Developer feedback is particularly important, but all bugs provide tremendous value. Just not necessarily to the person that submits them.&lt;&#x2F;p&gt;
&lt;p&gt;Feedback is a foundational component of Apple&#x27;s development processes and the success of their releases depends on it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;battles&quot;&gt;Battles&lt;&#x2F;h2&gt;
&lt;p&gt;You might have a problem with the App Store rules. Or relaxing privacy protections, removing encryption, or general cooperation with authoritarian regimes. I don&#x27;t like any of these things. I do not like them at all. But, I think there&#x27;s something to being selective about the battles you choose to fight.&lt;&#x2F;p&gt;
&lt;p&gt;What matters to me is they chose to support X at a horrible turning point. They chose to do so despite it being a weapon used to threaten some of their own employees. It has been suggested that coercion played a role here. And while that&#x27;s probably true, I do not care. They chose poorly.&lt;&#x2F;p&gt;
&lt;p&gt;I believe we all have a responsibility to ensure there are consequences. The core message is clear: &quot;current policies are putting future product releases at risk.&quot;&lt;&#x2F;p&gt;
&lt;p&gt;But I&#x27;m not going to list out demands or anything. This is a protest. It&#x27;s reasonable to ask when it will end and I don&#x27;t have a good answer. I want to see some progress. I want to see Apple make better choices.&lt;&#x2F;p&gt;
&lt;p&gt;But in the meantime, let&#x27;s do what we can to make sure the OS releases in September are a trainwreck. We can re-evaluate after they ship.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;opportunity&quot;&gt;Opportunity&lt;&#x2F;h2&gt;
&lt;p&gt;People have noted that my technical posts help Apple, if indirectly, by making it easier to develop for their platforms. But, the problem is that&#x27;s basically what I do for work. I &lt;strong&gt;want&lt;&#x2F;strong&gt; to help you, the human reading this. Striking a balance here is incredibly difficult. Action that comes with too big a personal cost compromises your ability to act. But too little? Well that&#x27;s exactly what the forces we are struggling against are depending on. The worst people in the world &lt;strong&gt;need&lt;&#x2F;strong&gt; you to just keep your head down.&lt;&#x2F;p&gt;
&lt;p&gt;So how should we proceed? Well, WWDC is right around the corner. There are rumors of a major UI design change. But even if that doesn&#x27;t materialize, new OS versions along with new features will come. Some of this will require developer participation to be truly useful. And all of this is happening at a time when the company is contending with serious legal struggles, conflicts with mulitple governments, and a (much-deserved) declining reputation.&lt;&#x2F;p&gt;
&lt;p&gt;These things make for an opportunity that might not present itself again.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actions&quot;&gt;Actions&lt;&#x2F;h2&gt;
&lt;p&gt;I was an Apple employee. Years later, through a twist I definitely did not see coming, I became a Twitter employee. And then, just last year, another total surprise resulted in me returning to Apple as a contractor. So yes, this is quite personal. But it goes far deeper than just work.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve seen many people share the sentiment that Apple is &quot;just a company&quot;, and we have to get used to it. You shouldn&#x27;t &lt;a href=&quot;https:&#x2F;&#x2F;inessential.com&#x2F;2024&#x2F;01&#x2F;17&#x2F;corporations_are_not_to_be_loved.html&quot;&gt;love a corporation&lt;&#x2F;a&gt;. Ok, yes. This is good advice. But you &lt;strong&gt;can&lt;&#x2F;strong&gt; love the idea that Apple used to represent. You can love the humans that believed in it. Worked hard to turn those ideals into real things. I will not abandon that ideal and throw some of those people to the wolves.&lt;&#x2F;p&gt;
&lt;p&gt;Right now I believe that what is best for &quot;Apple the idea&quot; is bad for &quot;Apple the company&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;If you are a developer, help me reduce the amount of feedback Apple receives during this beta cycle. But, no purity tests! I don&#x27;t use the word &quot;boycott&quot; for a reason. A critical bug that results in your app getting 1-star reviews is too high a cost. Find a careful balance. I&#x27;ve been, optimistically, keeping a private list of bugs (and let me tell you I have found some bangers).&lt;&#x2F;p&gt;
&lt;p&gt;If you are an Apple employee, think hard about whether Apple still deserves your best work. By all means, file those bugs for your direct team. But, outside of that? No one will know about the bugs you do not file. Even the idea that employees may be doing this is very powerful.&lt;&#x2F;p&gt;
&lt;p&gt;And don&#x27;t worry - I still see you Apple fans! Just don&#x27;t install betas and don&#x27;t share feedback too!&lt;&#x2F;p&gt;
&lt;p&gt;Remember, if you find an iOS 19 bug, no you didn&#x27;t.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Default isolation with Swift 6.2</title>
        <published>2025-05-12T00:00:00+00:00</published>
        <updated>2025-05-12T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/default-isolation-swift-6_2/"/>
        <id>https://massicotte.org/default-isolation-swift-6_2/</id>
        
        <content type="html" xml:base="https://massicotte.org/default-isolation-swift-6_2/">&lt;p&gt;As we started getting closer to the release of Swift 6.0, I had this bright idea. I decided to write about every evolution proposal related to concurrency that would ship with that release. This resulted in &lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;12 posts&lt;&#x2F;a&gt; and let me tell you, it was a lot of work. I even cheated! I skipped &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0433-mutex.md&quot;&gt;one&lt;&#x2F;a&gt;, the introduction of the &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;synchronization&#x2F;mutex&quot;&gt;Mutex&lt;&#x2F;a&gt; type. I guess it just didn&#x27;t feel like enough of a &quot;language change&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;I did a mini version of this again for &lt;a href=&quot;&#x2F;concurrency-6_1&quot;&gt;6.1&lt;&#x2F;a&gt;, but as a single post. That wasn&#x27;t too bad, because there were only &lt;del&gt;three&lt;&#x2F;del&gt; two changes and they were quite manageable. But now, Swift 6.2 is right around the corner and it is bringing with it 11 concurrency-related proposals.&lt;&#x2F;p&gt;
&lt;p&gt;I don&#x27;t think I can pull off a post for each proposal this year. But, I&#x27;m not sure that&#x27;s even necessary anyways. Many of them are minor things. But not all.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s talk about one of the most interesting of the changes coming: control over default isolation.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;visibility&quot;&gt;Visibility&lt;&#x2F;h2&gt;
&lt;p&gt;Here&#x27;s a mistake that I make all the time. I&#x27;m working on some bit of code and things are going well. I&#x27;ve gotten far enough now that I want to start writing some tests. But, I immediately realize that I&#x27;ve forgotten to include &lt;code&gt;public&lt;&#x2F;code&gt; on a whole bunch of stuff. Catching this kind of mistake can be even harder if you leave the default &lt;code&gt;@testable&lt;&#x2F;code&gt; attribute on your imports. I usually remove it, but sometimes I forget that too.&lt;&#x2F;p&gt;
&lt;p&gt;I know, I know. You&#x27;re thinking: &quot;What does visibility have to do with anything?&quot;&lt;&#x2F;p&gt;
&lt;p&gt;Well, visibility is interesting because it has a default. If you don&#x27;t specify anything, visibility will implicitly be &lt;code&gt;internal&lt;&#x2F;code&gt;. And that default is quite reasonable. You may want more fine-grained control. You might need to make stuff public, like I do here. But the &lt;code&gt;internal&lt;&#x2F;code&gt; default can get you quite far.&lt;&#x2F;p&gt;
&lt;p&gt;The second reason I&#x27;m bringing this up is because visibility is defined entirely by the source. It&#x27;s all about communicating some information to the compiler. It doesn&#x27;t change anything at runtime. It has no dynamic component. Visibility is a &lt;strong&gt;static&lt;&#x2F;strong&gt; construct.&lt;&#x2F;p&gt;
&lt;p&gt;Further, and perhaps most importantly, you can write real programs without even thinking about visibility. That&#x27;s &lt;strong&gt;progressive disclosure&lt;&#x2F;strong&gt;! In fact, with a single-module application, quite a common form of Swift project, you might never even encounter it.&lt;&#x2F;p&gt;
&lt;p&gt;All this visibility stuff is an analogy for &lt;strong&gt;isolation&lt;&#x2F;strong&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;static-isolation&quot;&gt;Static Isolation&lt;&#x2F;h2&gt;
&lt;p&gt;I wanted to go on this little side-quest because people don&#x27;t find understanding &lt;a href=&quot;&#x2F;isolation-intuition&quot;&gt;isolation&lt;&#x2F;a&gt; easy. Adding the distinction between static vs dynamic just makes it that much harder. And I really wanted to find a way to help explain this, because this is the Big Idea you need to get to understand what&#x27;s changing.&lt;&#x2F;p&gt;
&lt;p&gt;Very similar to visibility, every declaration has a well-defined static isolation. What we&#x27;re most interested in here the default. What is the static isolation when you don&#x27;t specify anything?&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;howIsThisIsolated&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Without annotations or anything else involved, the default static isolation is &lt;code&gt;nonisolated&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-does-nonisolated-mean&quot;&gt;What does &lt;code&gt;nonisolated&lt;&#x2F;code&gt; mean?&lt;&#x2F;h2&gt;
&lt;p&gt;I frequently talk about how Swift concurrency makes heavy use of the type system. One way I really like to emphasize that is by showing that &quot;isolation&quot; the concept can be modelled entirely using a type.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;typelias Isolation &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; (any Actor)?
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Actors, types that conform to the &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;actor&quot;&gt;&lt;code&gt;Actor&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; protocol, are what implement the isolation mechanism at runtime. But, note that this type is optional. There could be no actor at all. A &lt;code&gt;nil&lt;&#x2F;code&gt; here corresponds to &lt;code&gt;nonisolated&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This does not mean unsafe! There&#x27;s lots of stuff that doesn&#x27;t require any form of thread-safety. Many things are just inherently thread-safe.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; global &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;42&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is just an immutable integer. There&#x27;s no way to introduce any data races with this value. So, the default of &lt;code&gt;nonisolated&lt;&#x2F;code&gt; works fine. No protection needed.&lt;&#x2F;p&gt;
&lt;p&gt;The core problem is it&#x27;s very easy to write code that is &lt;strong&gt;not&lt;&#x2F;strong&gt; fine.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; global &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;42&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A &lt;strong&gt;mutable&lt;&#x2F;strong&gt; global value could be read and written anywhere. This is not safe and the compiler will tell you so. In this case (and many others), a default of &lt;code&gt;nonisolated&lt;&#x2F;code&gt; doesn&#x27;t work so well.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;When we looked at visibility, we noted three properties. It&#x27;s defined statically, it has a default, and that default suits many situations well.&lt;&#x2F;p&gt;
&lt;p&gt;Isolation is also statically defined. But, it&#x27;s default is &lt;strong&gt;not well suited&lt;&#x2F;strong&gt; to many kinds of problems. In fact, you can think about a default of &lt;code&gt;nonisolated&lt;&#x2F;code&gt; as a kind of presumption of concurrency. The compiler is assuming that all code has no isolation. Because Swift 6 will not permit data races all non-isolated code therefore &lt;strong&gt;must&lt;&#x2F;strong&gt; be thread-safe via other means.&lt;&#x2F;p&gt;
&lt;p&gt;That has big implications for progressive disclosure. The compiler will force you think about concurrency, even for toy programs that have no concurrency in them. It could force you think about concurrency before you&#x27;ve even learned what concurrency is.&lt;&#x2F;p&gt;
&lt;p&gt;Another major issue is many Swift projects are primarily, sometimes exclusively composed of main thread state. I spend a surprising amount of time trying to convince people that types that contain main thread-only state should be marked &lt;code&gt;@MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;For many Swift projects, &lt;code&gt;nonisolated&lt;&#x2F;code&gt; just isn&#x27;t a great default.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;controlling-the-default&quot;&gt;Controlling the default&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0466-control-default-actor-isolation.md&quot;&gt;SE-0466&lt;&#x2F;a&gt; introduces a way to control the default isolation. I&#x27;m not yet sure how it will be surfaced in Xcode, but here&#x27;s how it will work for packages:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; package &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Package(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	name: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;T&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	products: [
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;library(name: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;T&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, targets: [&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;T&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;]),
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	],
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	targets: [
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;target(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			name: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;T&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			swiftSettings: [
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIsolation(MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; &amp;lt;- !!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			]
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		),
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	]
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The mechanism uses a new &lt;code&gt;SwiftSetting&lt;&#x2F;code&gt; called &lt;code&gt;defaultIsolation&lt;&#x2F;code&gt;. By supplying the argument &lt;code&gt;MainActor.self&lt;&#x2F;code&gt;, the compiler will assume a default of &lt;code&gt;@MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This is a &lt;strong&gt;big&lt;&#x2F;strong&gt; change!&lt;&#x2F;p&gt;
&lt;p&gt;Note that you can also use an argument of &lt;code&gt;nil&lt;&#x2F;code&gt;. Or you can just omit the setting altogether. Both of these will preserve the current behavior of a &lt;code&gt;nonisolated&lt;&#x2F;code&gt; default. That&#x27;s very important: this is &lt;strong&gt;opt-in&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;whoa-whoa-whoa&quot;&gt;Whoa whoa whoa&lt;&#x2F;h2&gt;
&lt;p&gt;Many people have been worried about this. &quot;Everything on the main thread? Performance is going to be terrible!&quot;&lt;&#x2F;p&gt;
&lt;p&gt;The concern makes sense. This has the potential to shift a lot of work onto the main thread.&lt;&#x2F;p&gt;
&lt;p&gt;However!&lt;&#x2F;p&gt;
&lt;p&gt;I am firmly of the opinion that moving work off the main thread should be done with both care and intention. It is &lt;strong&gt;far&lt;&#x2F;strong&gt; easier to introduce some targeted concurrency into a &lt;code&gt;MainActor&lt;&#x2F;code&gt; type than it is to work with a non-isolated type. There&#x27;s a tremendous amount of code out there that &lt;strong&gt;should&lt;&#x2F;strong&gt; be marked &lt;code&gt;@MainActor&lt;&#x2F;code&gt; but isn&#x27;t.&lt;&#x2F;p&gt;
&lt;p&gt;Understanding and managing &lt;a href=&quot;&#x2F;synchronous-work&quot;&gt;slow synchronous work&lt;&#x2F;a&gt; remains very important. But I find myself much more preoccupied with code that has a fundamentally-problematic concurrency design. Give me UI hangs over that any day.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-new-dialect&quot;&gt;A new dialect&lt;&#x2F;h2&gt;
&lt;p&gt;Ok, so let&#x27;s now return to an example we looked at earlier:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; global &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;42&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Pop quiz, hotshot! Does this compile with Swift 6.2 in the 6 language mode?&lt;&#x2F;p&gt;
&lt;p&gt;This question is &lt;strong&gt;unanswerable&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;It is not possible to fully understand how or even if Swift code works without knowing this setting. If this code has omitted this new setting, or explicitly opted to use a &lt;code&gt;nonisolated&lt;&#x2F;code&gt; default, it does not compile. But if the code has opted into the &lt;code&gt;@MainActor&lt;&#x2F;code&gt; default, it does.&lt;&#x2F;p&gt;
&lt;p&gt;This is known as a &quot;language dialect&quot;. The meaning of the code depends on an external setting not present in the source.&lt;&#x2F;p&gt;
&lt;p&gt;It is absolutely true that a huge amount of Swift code could make sense to be &lt;code&gt;MainActor&lt;&#x2F;code&gt; by default. But, does all? As soon as you go below the UI, the answer starts to become less clear. And that&#x27;s just in the context of apps. What about server side work? Or embedded projects?&lt;&#x2F;p&gt;
&lt;p&gt;Choosing a universal default isn&#x27;t easy or even obvious. That&#x27;s why the trade-off was made here to allow for per-module control.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;another-option&quot;&gt;Another option&lt;&#x2F;h2&gt;
&lt;p&gt;While not yet actually accepted, &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0478-default-isolation-typealias.md&quot;&gt;SE-0478&lt;&#x2F;a&gt; introduces another option to control this behavior that is visible in the source.&lt;&#x2F;p&gt;
&lt;p&gt;It is done via a top-level &lt;code&gt;typealias&lt;&#x2F;code&gt; declaration.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;typealias&lt;&#x2F;span&gt; DefaultIsolation &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; MainActor
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; or&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;typealias&lt;&#x2F;span&gt; DefaultIsolation &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; nonisolated
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This would apply just to the current file, overriding any module-level settings.&lt;&#x2F;p&gt;
&lt;p&gt;And, speaking of related proposals, it&#x27;s also worth noting that &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0449-nonisolated-for-global-actor-cutoff.md&quot;&gt;SE-0449&lt;&#x2F;a&gt;, included with Swift 6.1, makes it possible to use the &lt;code&gt;nonisolated&lt;&#x2F;code&gt; keyword in many more contexts. This is an important capability for a world where the default is not longer guaranteed.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;choosing-a-default&quot;&gt;Choosing a default&lt;&#x2F;h2&gt;
&lt;p&gt;Today, there are a lot of APIs marked &lt;code&gt;@MainActor&lt;&#x2F;code&gt;. I&#x27;m not sure exactly how many occurrences there are of this attribute within UIKit but I&#x27;m going to estimate it at roughly 1 bazillion. Yet there are also a lot of uses of &lt;code&gt;nonisolated&lt;&#x2F;code&gt;, either explicitly or implicitly. Even for a huge UI-heavy system, I&#x27;m not sure it&#x27;s 100% clear exactly what a reasonable default could be.&lt;&#x2F;p&gt;
&lt;p&gt;And this brings us to a tough choice. Swift 6.2 gives us the ability to set the default to &lt;code&gt;@MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But should we?&lt;&#x2F;p&gt;
&lt;p&gt;Setting the default has the potential to completely remove the need to think about concurrency. This could be an &lt;strong&gt;enormous&lt;&#x2F;strong&gt; win in many situations. For example, it would make the Swift 6 language mode a more friendly choice for true beginner programmers.&lt;&#x2F;p&gt;
&lt;p&gt;But I find myself hesitating for all other situations. It certainly &lt;strong&gt;could&lt;&#x2F;strong&gt; work. And by no means am I implying it would only be for beginners. Is it better to save yourself from typing &lt;code&gt;@MainActor&lt;&#x2F;code&gt; or &lt;code&gt;nonisolated&lt;&#x2F;code&gt;? You might even decide to preemptively mark things as explicitly &lt;code&gt;nonisolated&lt;&#x2F;code&gt;, in case you want to experiment.&lt;&#x2F;p&gt;
&lt;p&gt;For now, I just don&#x27;t know how to make this call. I don&#x27;t love the idea of a language dialect. But just because that could be a problem doesn&#x27;t mean it actually will. And, there another significant &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0461-async-function-isolation.md&quot;&gt;change&lt;&#x2F;a&gt; coming in 6.2 that I think complicates this even further. Right now, though, I see myself sticking with a &lt;code&gt;nonisolated&lt;&#x2F;code&gt; default. I need more experience trying this out with real systems before I make up my mind. But as always, if you have thoughts on this, I&#x27;d be very interested to hear them.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>ModelActor is Just Weird</title>
        <published>2025-03-22T00:00:00+00:00</published>
        <updated>2025-03-22T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/model-actor/"/>
        <id>https://massicotte.org/model-actor/</id>
        
        <content type="html" xml:base="https://massicotte.org/model-actor/">&lt;p&gt;I actually don&#x27;t get too many questions about SwiftData or Core Data. And thank goodness, because I&#x27;m not particularly familiar with either. That is, until just recently! I had the chance to work with two different projects, both of which were using SwiftData. While Core Data was introduced in 2005, this SwiftData stuff is brand new. In fact, it includes a whole bunch of Concurrency-specific features. It should be smooth sailing right?&lt;&#x2F;p&gt;
&lt;p&gt;Well, spoiler, it&#x27;s not. It&#x27;s close! But it&#x27;s also very strange. This post is all about understanding why it is strange, dealing with it, and learning a bunch about concurrency along the way.&lt;&#x2F;p&gt;
&lt;p&gt;But first! I want to take a moment to say thank you. Both of these clients I worked with agreed to let me share the experiences and code. One even specifically asked me to blog about it! This was incredibly cool.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;&#x2F;strong&gt;: multiple people have since reached out to tell me about yet more &lt;code&gt;ModelActor&lt;&#x2F;code&gt; behavior related to its interaction with the main thread. This post does not fully explain what&#x27;s going on or how to deal with it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;modelactor&quot;&gt;ModelActor&lt;&#x2F;h2&gt;
&lt;p&gt;My understanding is that SwiftData is a fairly thin wrapper around Core Data. Now, when someone takes the time to outline &lt;a href=&quot;https:&#x2F;&#x2F;davedelong.com&#x2F;blog&#x2F;2018&#x2F;05&#x2F;09&#x2F;the-laws-of-core-data&#x2F;&quot;&gt;laws&lt;&#x2F;a&gt; around a framework, you should probably tread carefully. So, no doubt there&#x27;s lots of historical stuff going on here.&lt;&#x2F;p&gt;
&lt;p&gt;But, that still doesn&#x27;t explain how much &lt;a href=&quot;https:&#x2F;&#x2F;brightdigit.com&#x2F;tutorials&#x2F;swiftdata-modelactor&#x2F;&quot;&gt;trouble&lt;&#x2F;a&gt; people have with &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swiftdata&#x2F;modelactor&quot;&gt;ModelActor&lt;&#x2F;a&gt;. I&#x27;m not sure &lt;strong&gt;anyone&lt;&#x2F;strong&gt; has ever used &lt;code&gt;ModelActor&lt;&#x2F;code&gt; without at least some surprises.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s look more closely at it.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;ModelActor&lt;&#x2F;code&gt; is a protocol, but you are supposed to interact with it using the &lt;code&gt;@ModelActor&lt;&#x2F;code&gt; macro. The purpose of this combo is to provide &quot;mutually-exclusive access to the attributes of a conforming model&quot;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;ModelActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Expanding the macro, we can see that this resolves to the following:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;ModelActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; modelExecutor: any SwiftData&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;ModelExecutor
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; modelContainer: SwiftData&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;ModelContainer
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(modelContainer: SwiftData&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;ModelContainer) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; modelContext &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; ModelContext(modelContainer)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;modelExecutor &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; DefaultSerialModelExecutor(modelContext: modelContext)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;modelContainer &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; modelContainer
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; MyModelActor: SwiftData&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This gives us the full picture of a minimal &quot;ModelActor&quot; type.  Hanging onto the &lt;code&gt;modelContainer&lt;&#x2F;code&gt; seems reasonable. And making a new &lt;code&gt;ModelContext&lt;&#x2F;code&gt; makes sense. But, there&#x27;s definitely some funny business happening with this &lt;code&gt;modelExecutor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;It appears that the SwiftData machinery here needs to use a custom actor executor. This is typically so you can have more control over how an actor executes code. This is &lt;strong&gt;probably&lt;&#x2F;strong&gt; required for compatibility with Core Data&#x27;s &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;coredata&#x2F;using-core-data-in-the-background&quot;&gt;concurrency model&lt;&#x2F;a&gt;. But it&#x27;s hard to be sure because as far as I can tell, this is not documented.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;Putting the internals aside, the truly important thing about &lt;code&gt;ModelActor&lt;&#x2F;code&gt; is protecting that &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swiftdata&#x2F;modelcontext&quot;&gt;&lt;code&gt;ModelContext&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; property. This type is non-Sendable. Which means it is not thread-safe and requires some form of synchronization.&lt;&#x2F;p&gt;
&lt;p&gt;Actors exist to protect mutable state. The purpose of a &lt;code&gt;ModelActor&lt;&#x2F;code&gt; is to own and isolate the &lt;code&gt;ModelContext&lt;&#x2F;code&gt;. It does that! But if we start to dig into &lt;strong&gt;how&lt;&#x2F;strong&gt; exactly it does it, we will discover something very bizarre.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s an example that illustrates the issue with a minimal SwiftUI program.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; let&amp;#39;s define a model&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Model&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;final&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Item {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; name
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; put together a quick-and-dirty global container&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelContainer {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; shared: ModelContainer {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt; ModelContainer(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: Schema([Item&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;]),
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			configurations: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(isStoredInMemoryOnly: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;true&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Here&amp;#39;s our star, the ModelActor type&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;ModelActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;hello&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;!&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; and now create a view that uses the actor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; ContentView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; database &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; MyModelActor(modelContainer: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;H&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;M&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;A&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;!&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				await database&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;hello()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If you run this code, you&#x27;ll see &quot;hi!&quot; in the console. So far so good. But now, let&#x27;s make a teeny-tiny little modification.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;ModelActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;hello&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;preconditionIsolated() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; WAT&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;!&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This precondition will &lt;strong&gt;hold&lt;&#x2F;strong&gt;. Somehow, we are on our custom, minimal, SwiftData-defined actor &lt;strong&gt;and&lt;&#x2F;strong&gt; also the &lt;code&gt;MainActor&lt;&#x2F;code&gt; at the same time.&lt;&#x2F;p&gt;
&lt;p&gt;This is.. well... I don&#x27;t know what this is, but it is not normal.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;is-this-thing-an-actor-or-what&quot;&gt;Is this thing an actor or what?&lt;&#x2F;h2&gt;
&lt;p&gt;Just to prove to you that this is strange, if we substitute in a source-compatible actor that doesn&#x27;t use this macro, we&#x27;ll crash.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(modelContainer: ModelContainer) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;hello&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;preconditionIsolated() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; NOPE&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;!&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Stock actors do not run code on the main thread. You totally &lt;em&gt;could&lt;&#x2F;em&gt; make an actor that does. But &lt;strong&gt;why&lt;&#x2F;strong&gt; would you? Doing it is the &lt;strong&gt;worst&lt;&#x2F;strong&gt; of all possible options.&lt;&#x2F;p&gt;
&lt;p&gt;It is bad because consumers of this API have a very reasonable expectation that this will execute off the main thread. This type doesn&#x27;t do that. But worse, its relationship with the main thread isn&#x27;t visible in the type system. These things are &lt;strong&gt;not&lt;&#x2F;strong&gt; marked &lt;code&gt;MainActor&lt;&#x2F;code&gt;, so the compiler doesn&#x27;t know what&#x27;s going on. This means even though you are on the main thread here, you cannot access &lt;code&gt;MainActor&lt;&#x2F;code&gt; stuff.&lt;&#x2F;p&gt;
&lt;p&gt;But, don&#x27;t get mixed up. It is still &quot;an actor&quot;. It still is able to protect mutable state. It is perfectly legitimate to protect your state by using the main thread. That&#x27;s how &lt;code&gt;MainActor&lt;&#x2F;code&gt; does it, after all.&lt;&#x2F;p&gt;
&lt;p&gt;This is just, in my opinion, a really bad way to do it. &lt;code&gt;@ModelActor&lt;&#x2F;code&gt; makes a type that ties up the main thread but doesn&#x27;t give you the ability to access main thread state. It&#x27;s a lose-lose.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;context-matters&quot;&gt;Context matters&lt;&#x2F;h2&gt;
&lt;p&gt;As many others have discovered, a &lt;code&gt;ModelActor&lt;&#x2F;code&gt; type is sensitive to where it is created. If you make one on the main thread, you&#x27;ll get an actor that uses the main thread for isolation. But if you init the exact same type in the background, you get (as far as I can tell) regular old actor execution behavior.&lt;&#x2F;p&gt;
&lt;p&gt;But just how exactly are we supposed to do that?&lt;&#x2F;p&gt;
&lt;p&gt;All we need is a non-main execution context. I think! Honestly, this isn&#x27;t documented so I actually don&#x27;t know what is going on internally. But I suspect that this mirrors Core Data&#x27;s concurrency model, which makes a distinction between main and private queues. So, this all seems like a good guess and appears to work in practice.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;makeMainModelActor&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; MyModelActor &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	MyModelActor(modelContainer: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;makeBackgroundModelActor&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; MyModelActor &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	MyModelActor(modelContainer: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What I&#x27;m doing here is using a non-isolated async function to guarantee I&#x27;m not on the main thread. That seems to be all it takes.&lt;&#x2F;p&gt;
&lt;p&gt;(If you are surprised that non-isolated + async = background, check &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;this&lt;&#x2F;a&gt; out.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;background-access&quot;&gt;Background access&lt;&#x2F;h2&gt;
&lt;p&gt;Once you understand that &lt;code&gt;ModelActor&lt;&#x2F;code&gt; types are sensitive to where they are created, there are many ways to deal with it. But many projects actually need two interfaces to their database. One that provides synchronous access from the &lt;code&gt;MainActor&lt;&#x2F;code&gt;, and another that allows background operations and doesn&#x27;t block the main thread.&lt;&#x2F;p&gt;
&lt;p&gt;While the MainActor version isn&#x27;t usually problematic, the background one is. All of our work needs to involve the &lt;code&gt;ModelContext&lt;&#x2F;code&gt;. But that type isn&#x27;t &lt;code&gt;Sendable&lt;&#x2F;code&gt;. Which means it is &quot;trapped&quot; inside of our &lt;code&gt;ModelActor&lt;&#x2F;code&gt;. How do we get at it?&lt;&#x2F;p&gt;
&lt;p&gt;Instead of trying to get the non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; stuff &lt;strong&gt;out&lt;&#x2F;strong&gt;, we are going to push the work we need to do &lt;strong&gt;in&lt;&#x2F;strong&gt;. We&#x27;re going to build this up slowly, because we need quite a complex system to be fully general.&lt;&#x2F;p&gt;
&lt;p&gt;First, we&#x27;ll start with an extension on &lt;code&gt;ModelActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) -&amp;gt; T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This signature gives us a way to submit work to our &lt;code&gt;ModelActor&lt;&#x2F;code&gt; that needs to touch its &lt;code&gt;modelContext&lt;&#x2F;code&gt; property. It&#x27;s safe to access &lt;code&gt;modelContext&lt;&#x2F;code&gt; here because this block is being executed in a function that is isolated to the &lt;code&gt;ModelActor&lt;&#x2F;code&gt; instance. We&#x27;ve moved the work into the actor. We even added a generic so this work can produce an arbitrary result.&lt;&#x2F;p&gt;
&lt;p&gt;However, this isn&#x27;t going to work very well yet. We&#x27;re missing a core ingredient. See the whole idea is to move the closure from over here (gestures left) into this actor (gestures right). We want to &quot;send&quot; it into the actor. Would anyone like to guess what that means?&lt;&#x2F;p&gt;
&lt;p&gt;This closure has to be &lt;code&gt;Sendable&lt;&#x2F;code&gt;!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) -&amp;gt; T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closure is free to move from one isolation domain to another. It can cross the boundaries between them. In fact, it&#x27;s even more powerful than that. A &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closure is fully thread-safe. It could be executed from multiple threads &lt;strong&gt;simultaneously&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;In this case, we don&#x27;t actually need something with so many guarantees.&lt;&#x2F;p&gt;
&lt;p&gt;We just want to tell the compiler that we need to move this closure into the actor, right at the callsite. And there is a way to express this - with the &lt;code&gt;sending&lt;&#x2F;code&gt; keyword. This is much lower bar, and it&#x27;s exactly we need. Doing this makes our API much easier to use, because there are more constraints on a &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closure.&lt;&#x2F;p&gt;
&lt;p&gt;With this, we now have a minimally-usable version.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) -&amp;gt; T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;(I was a little surprised that this code fails at &lt;code&gt;MainActor&lt;&#x2F;code&gt; callsites without an explicit &lt;code&gt;sending&lt;&#x2F;code&gt; or &lt;code&gt;@Sendable&lt;&#x2F;code&gt;. I thought that &lt;a href=&quot;https:&#x2F;&#x2F;massicotte.org&#x2F;model-actor&#x2F;concurrency-swift-6-se-0414&quot;&gt;Region-based isolation&lt;&#x2F;a&gt; would make this &quot;just work&quot; in many cases. Anyways, this code is clear and I like it, but if you know what&#x27;s up please tell me.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sending-sending-sending&quot;&gt;sending sending sending&lt;&#x2F;h2&gt;
&lt;p&gt;Progress, but there are still some serious limitations. The first is that you&#x27;ll find actually returning values are only possible when T is &lt;code&gt;Sendable&lt;&#x2F;code&gt;. This makes sense though! The work is happening in the actor and to get values out, we need to &quot;send&quot; them from the actor back to the caller. Inputs have to be sent in, outputs have to be sent back out.&lt;&#x2F;p&gt;
&lt;p&gt;We can express this as a generic constraint.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T: Sendable&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) -&amp;gt; T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The thing is, it&#x27;s kind of redundant because the compiler is going to enforce this regardless. And we don&#x27;t need fully &lt;code&gt;Sendable&lt;&#x2F;code&gt; types anyways. We just need to promise that we will only return stuff that is safe to send. That&#x27;s what &lt;code&gt;sending&lt;&#x2F;code&gt; does, so let&#x27;s use it again.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T: Sendable&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) -&amp;gt; sending T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Ok, great! Now we can get rid of the generic constraint and allow more flexible return value types! This will make our API much easier for callers to use.&lt;&#x2F;p&gt;
&lt;p&gt;Except that does not compile...&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) -&amp;gt; sending T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Returning &amp;#39;self&amp;#39;-isolated &amp;#39;self.modelContext&amp;#39; as a &amp;#39;sending&amp;#39; result risks causing data races&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What the compiler is trying to tell us here is basically &quot;I don&#x27;t know what this &lt;code&gt;block&lt;&#x2F;code&gt; is going to return, what if it grabs a reference to &lt;code&gt;modelContext&lt;&#x2F;code&gt; and returns that!&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;This is an interesting little peek into the kind of reasoning the compiler has to do to prove that something can be &quot;sent&quot;. And it&#x27;s right. Consider this in code form:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; unsafeContext &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await modelActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;withContext { $&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt; }
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Without this check, we&#x27;d be allowed to smuggle the thread-unsafe &lt;code&gt;ModelContext&lt;&#x2F;code&gt; instance out of actor and access it from other threads! But, how do we address this? What we need is a block that only returns things that are safe for us to then return as &lt;code&gt;sending&lt;&#x2F;code&gt;. Did you guess a third &lt;code&gt;sending&lt;&#x2F;code&gt;?&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) -&amp;gt; sending T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It&#x27;s just a sending value returned from a sending closure that is then sent. Easy!&lt;&#x2F;p&gt;
&lt;p&gt;Jokes aside, I think it actually is very educational to sit and think about this. The inputs to this actor method have to move from &quot;the outside&quot; into this actor (sending closure), and then the outputs have to be moved back to &quot;the outside&quot; (sending return). The closure needing to have a sending return might feel funny though. We&#x27;re promising to return a sending value, but we&#x27;re just returning whatever that block is returning. This means the block needs to keep the same promise.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;errors&quot;&gt;Errors&lt;&#x2F;h3&gt;
&lt;p&gt;Ok, we are actually getting somewhere now. This is now quite usable. However, it would be a lot more convenient if our block could throw. That&#x27;s not too hard to wire up, actually.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; throws &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) rethrows -&amp;gt; sending T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We can allow the block to throw, and then mark the method &lt;code&gt;rethrows&lt;&#x2F;code&gt;. This definitely works, but we could also try using that fancy new typed throws stuff.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T, Failure: Error&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; throws&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;Failure&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) throws(Failure) -&amp;gt; sending T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We need another generic, and the signature is starting to get pretty dense. But this is a more generalized system so I&#x27;m going to leave it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;making-it-async&quot;&gt;Making it async&lt;&#x2F;h2&gt;
&lt;p&gt;What we have at this point isn&#x27;t too bad. We don&#x27;t require &lt;code&gt;Sendable&lt;&#x2F;code&gt; types and we have typed errors. But there&#x27;s one more limitation. That block of ours currently only permits synchronous code. We can address this, but it&#x27;s going to be the biggest challenge yet.&lt;&#x2F;p&gt;
&lt;p&gt;First the straightforward stuff:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;make the block &lt;code&gt;async&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;make the method &lt;code&gt;async&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;call the block using &lt;code&gt;await&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T, Failure: Error&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async throws&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;Failure&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) async throws(Failure) -&amp;gt; sending T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; await block(modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;These three changes aren&#x27;t too bad. But, they result in a compiler error at the block callsite:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;Sending &#x27;self.modelContext&#x27; risks causing data races&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;p&gt;I wouldn&#x27;t be surprised if at this point you got stuck. We &lt;strong&gt;can&lt;&#x2F;strong&gt; resolve this, but it&#x27;s very tricky. First, let&#x27;s understand the problem.&lt;&#x2F;p&gt;
&lt;p&gt;The compiler is telling us that we are somehow using &lt;code&gt;modelContext&lt;&#x2F;code&gt; in an unsafe way. Remember the whole reason for doing all of this garbage is to run this block within the isolation of the actor.&lt;&#x2F;p&gt;
&lt;p&gt;Check out the type of the block:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;(ModelContext) async &lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;throws&lt;&#x2F;span&gt;(Failure) &lt;span class=&quot;z-keyword z-operator z-custom z-binary z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending T
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is an async function. But, critically, it also doesn&#x27;t have any isolation defined. What do we know about non-isolated + async? Background thread.&lt;&#x2F;p&gt;
&lt;p&gt;This call would move &lt;code&gt;modelContext&lt;&#x2F;code&gt; from the protection of this actor out to an arbitrary background thread. That is crossing an isolation boundary. Because &lt;code&gt;ModelContext&lt;&#x2F;code&gt; is not Sendable, that is not allowed.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s much simpler example with the same issue:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;(NonSendable) async &lt;span class=&quot;z-keyword z-operator z-custom z-binary z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Functions that have this form will almost always be problematic.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolated-parameters&quot;&gt;Isolated parameters&lt;&#x2F;h2&gt;
&lt;p&gt;To make this contraption of ours work, we somehow need this call to &lt;code&gt;block&lt;&#x2F;code&gt; without changing isolation. We need it to execute on the actor instance.&lt;&#x2F;p&gt;
&lt;p&gt;There are four ways to define static isolation.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;None, which is &lt;code&gt;nonisolated&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Actor methods, which are isolated to the actor instance&lt;&#x2F;li&gt;
&lt;li&gt;Global actor annotations, like &lt;code&gt;@MainActor&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;isolated parameters&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This block is actually using the default. With nothing else present, you get &lt;code&gt;nonisolated&lt;&#x2F;code&gt;. We cannot use an actor method, because the whole point is to have this work defined &lt;strong&gt;outside&lt;&#x2F;strong&gt; of the actor.&lt;&#x2F;p&gt;
&lt;p&gt;A global actor annotation also won&#x27;t help us. Because all we&#x27;d be doing is moving &lt;code&gt;modelContext&lt;&#x2F;code&gt; from the current actor out to that global actor. That&#x27;s just crossing a different isolation boundary. We need no boundary at all.&lt;&#x2F;p&gt;
&lt;p&gt;An isolated parameter is exactly the right tool. It gives us a way to say &quot;run this async method isolated to &lt;strong&gt;whatever I pass in&lt;&#x2F;strong&gt;&quot;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T, Failure: Error&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: sending (isolated &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;, ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async throws&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;Failure&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) async throws(Failure) -&amp;gt; sending T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; await block(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;, modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here we&#x27;ve made two changes. First, we have changed the block to accept an isolated parameter. And second, we have passed in &lt;code&gt;self&lt;&#x2F;code&gt;, the instance of this actor, to the block. Remember we are extending a protocol here, so to refer to a conforming type, we use &lt;code&gt;Self&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The translates to:  &quot;Run this async function isolated to me&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;(Also, just in case this whole isolated parameter dance is getting you down, the compiler team is working on &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;se-0461-run-nonisolated-async-functions-on-the-callers-actor-by-default&#x2F;77987&quot;&gt;improving&lt;&#x2F;a&gt; this situation and I&#x27;m very excited for it.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-bug&quot;&gt;A bug?&lt;&#x2F;h2&gt;
&lt;p&gt;Honestly, at this point, I thought we were done. But it turns out that with Swift 6.1 (Xcode 16.3b3), this implementation is problematic. I&#x27;m unable to get the compiler to accept a version of this code that uses a &lt;code&gt;sending&lt;&#x2F;code&gt; block and an isolated parameter. Whenever I try, I get errors at the points of use. We&#x27;re getting into pretty complex territory here, but I &lt;strong&gt;think&lt;&#x2F;strong&gt; this code should compile.&lt;&#x2F;p&gt;
&lt;p&gt;Anyways, the only solution I could come up with was to make the closure &lt;code&gt;@Sendable&lt;&#x2F;code&gt;, so that&#x27;s the final version here:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; ModelActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withContext&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;T, Failure: Error&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (isolated &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;, ModelContext&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async throws&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;Failure&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending T
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) async throws(Failure) -&amp;gt; sending T &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; await block(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;, modelContext)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This isn&#x27;t &lt;strong&gt;that&lt;&#x2F;strong&gt; bad, so I&#x27;m ok with it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-more-complete-system&quot;&gt;A more complete system&lt;&#x2F;h2&gt;
&lt;p&gt;What we have now is a general purpose extension on all &lt;code&gt;ModelActor&lt;&#x2F;code&gt; types that can accept and execute work within that actor. But if you can remember that far back, we were just trying to get a handle on &lt;code&gt;ModelActor&lt;&#x2F;code&gt;&#x27;s weird context-sensitive initialization.&lt;&#x2F;p&gt;
&lt;p&gt;We want a system that makes it easier to access our SwiftData system on the MainActor or background, as needed.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve punished you enough with these step-by-step code transformations. So, I&#x27;ll just present the final solution here and then we can discuss a bit.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; Database {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;ModelActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	actor Background {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;create&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;container: ModelContainer&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Background &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			Background(modelContainer: container)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; mainContext: ModelContext
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; task: Task&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;Background, Never&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(container: ModelContainer) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;mainContext &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; container&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;mainContext
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;task &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Task { await Background&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;create(container: container) }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; background: Background {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-swift&quot;&gt;get&lt;&#x2F;span&gt; async { await task&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;value }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There are three important things to note about this &lt;code&gt;Database&lt;&#x2F;code&gt; type.&lt;&#x2F;p&gt;
&lt;p&gt;The first is that it is &lt;code&gt;MainActor&lt;&#x2F;code&gt;. This makes it easy to incorporate into a SwiftUI application. This is also important for convenient access to the main-thread-only &lt;code&gt;mainContext&lt;&#x2F;code&gt; property.&lt;&#x2F;p&gt;
&lt;p&gt;The second thing is the nested &lt;code&gt;Background&lt;&#x2F;code&gt; actor. This is a &lt;code&gt;ModelActor&lt;&#x2F;code&gt; type with exactly one factory method. But, because that method is non-isolated and async, it will always run on the background. This let&#x27;s us create the &lt;code&gt;Background&lt;&#x2F;code&gt; actor in a non-main context so it actually runs in the background.&lt;&#x2F;p&gt;
&lt;p&gt;The last thing is because this &lt;code&gt;create&lt;&#x2F;code&gt; method is async, we need a &lt;code&gt;Task&lt;&#x2F;code&gt; somewhere. I&#x27;ve opted to internalize this and hang onto the &lt;code&gt;Task&lt;&#x2F;code&gt;. This let&#x27;s us asynchronously access the &lt;code&gt;Background&lt;&#x2F;code&gt; actor when needed. I admit this is awkward, but I think it is highly desirable to keep the &lt;code&gt;init&lt;&#x2F;code&gt; method of &lt;code&gt;Database&lt;&#x2F;code&gt; synchronous.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;usage&quot;&gt;Usage&lt;&#x2F;h2&gt;
&lt;p&gt;I actually haven&#x27;t spent much time actually using these ideas. But we can at least take a peek at what that could look like.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; database &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Database(container: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;someContainer)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; result &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; database&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;mainContext&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;fetch(someDescriptor)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; asyncResult &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; await database&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;background&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;withContext { _, context &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; context&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;fetch(someDescriptor)&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;property
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I kind of don&#x27;t even know what I&#x27;m doing here. But I think you get the idea of the programming model. I believe this stuff can be used as a building block for a much more full-featured system around SwiftData. Or you can just use it directly if your needs are simple.&lt;&#x2F;p&gt;
&lt;p&gt;It is worth noting, though, that I&#x27;ve just ignored that isolated parameter field. This is fairly common with isolated parameters actually! You often can just ignore it during regular use of the API.&lt;&#x2F;p&gt;
&lt;p&gt;Another point is we have only one single &lt;code&gt;Background&lt;&#x2F;code&gt; actor here. It will serialize access to its &lt;code&gt;modelContext&lt;&#x2F;code&gt;, which means it can only do one operation at time. This can be a major drawback if you need to execute multiple long-running queries. But, I believe we could push this general idea further if multiple concurrent operations were necessary.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;but-ugh&quot;&gt;But ugh&lt;&#x2F;h2&gt;
&lt;p&gt;It was fun and quite educational to figure this all out. But, it&#x27;s also pretty annoying. This was a lot of work to solve problems that, in my opinion, shouldn&#x27;t even exist. That extension on &lt;code&gt;ModelActor&lt;&#x2F;code&gt; should probably be built into the framework. And this contextually-sensitive &lt;code&gt;ModelActor&lt;&#x2F;code&gt; stuff makes no sense to me. At the absolute least, this needs to be carefully documented so developers understand how to use the type correctly.&lt;&#x2F;p&gt;
&lt;p&gt;Something fascinating is that I &lt;strong&gt;think&lt;&#x2F;strong&gt; SwiftData could change &lt;code&gt;ModelActor&lt;&#x2F;code&gt; and most things would still work. All accesses already need &lt;code&gt;await&lt;&#x2F;code&gt;. &lt;code&gt;MainActor&lt;&#x2F;code&gt; stuff would remain off-limits. In fact, the only problem I can think of is if someone is inadvertently depending on the main thread nature of &lt;code&gt;ModelActor&lt;&#x2F;code&gt; and &lt;strong&gt;also&lt;&#x2F;strong&gt; has concurrency warnings off. Aside from that unfortunate situation, the fact that such a major change could be made while preserving source compatibility is kind of amazing.&lt;&#x2F;p&gt;
&lt;p&gt;In the meantime, I hope this is all useful. Remember, I have very little SwiftData experience! So, there could be a better option lurking out there that&#x27;s nicer. If you know of one, please share.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Synchronous Work</title>
        <published>2025-03-03T00:00:00+00:00</published>
        <updated>2025-10-19T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/synchronous-work/"/>
        <id>https://massicotte.org/synchronous-work/</id>
        
        <content type="html" xml:base="https://massicotte.org/synchronous-work/">&lt;p&gt;Occasionally, you&#x27;ll come across something that will really influence your thinking on a topic. This happened to me after reading a &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;pitch-inherit-isolation-by-default-for-async-functions&#x2F;74862&#x2F;99&quot;&gt;post&lt;&#x2F;a&gt; on the Swift forums. That was nearly 6 months ago as I write, but I&#x27;m still thinking about it today.&lt;&#x2F;p&gt;
&lt;p&gt;How should we approach synchronous work?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;maybe-it-s-fast&quot;&gt;Maybe it&#x27;s fast?&lt;&#x2F;h2&gt;
&lt;p&gt;Everyone is really worried about blocking the main thread. And for very good reason! You want to keep your app responsive. To do that you must make sure you aren&#x27;t tying it up the main thread for too long.&lt;&#x2F;p&gt;
&lt;p&gt;This might sound obvious, but for this to happen the work has to be &lt;strong&gt;both&lt;&#x2F;strong&gt; long-running &lt;strong&gt;and&lt;&#x2F;strong&gt; synchronous.&lt;&#x2F;p&gt;
&lt;p&gt;If the work is not long-running, it just doesn&#x27;t matter. In fact, shifting very small amounts of work off the main thread can actually be &lt;strong&gt;bad&lt;&#x2F;strong&gt; for performance. This is because, while the cost is tiny, it is not free to switch to&#x2F;from a thread.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;global()&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; uh-oh better do this off the main thread!!!!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; result &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; x &lt;span class=&quot;z-keyword z-operator z-arithmetic z-swift&quot;&gt;*&lt;&#x2F;span&gt; y
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;main&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... and now publish the result&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; result
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is inefficient. The cost of switching away and then back to the main thread is significantly higher than a single multiplication. Practically speaking, this kind of stuff doesn&#x27;t really matter unless you do it a lot. But, efficiency aside, you &lt;strong&gt;definitely&lt;&#x2F;strong&gt; do now have a lot more complexity.&lt;&#x2F;p&gt;
&lt;p&gt;Here, you may have to handle this weird in-between situation where work is in-progress but not yet complete. And even if that doesn&#x27;t matter in this specific case, every reader of this code now needs to at least &lt;strong&gt;think&lt;&#x2F;strong&gt; about it.&lt;&#x2F;p&gt;
&lt;p&gt;The point is, adding concurrency (lowercase-c) to your code comes with increased complexity in multiple dimensions. And that increase can be &lt;strong&gt;substantial&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;maybe-it-s-slow&quot;&gt;Maybe it&#x27;s slow?&lt;&#x2F;h2&gt;
&lt;p&gt;You should start with a reasonable expectation that the work you are dealing with will be slow. Even if only sometimes! Because otherwise paying the efficiency and complexity cost is totally not worth it.&lt;&#x2F;p&gt;
&lt;p&gt;There are lots of familiar examples that do fit this pattern. Like everyone&#x27;s favorite, decoding JSON.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; JSONDecoder()&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;decode(MyModel&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;, from: data)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The input, that &lt;code&gt;data&lt;&#x2F;code&gt; here, can be arbitrarily large. That might not be typical, but it is absolutely possible. The cost of this decoding could be a real problem and it is totally justified to want this off the main thread.&lt;&#x2F;p&gt;
&lt;p&gt;So, how should we do that?&lt;&#x2F;p&gt;
&lt;p&gt;The classic pattern you&#x27;ll see when using dispatch looks just like what we did with that silly multiplication above.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;global()&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; JSONDecoder()&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;decode(MyModel&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;, from: data)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;main&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; do something with model&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You first get yourself off the current queue so you can do the expensive work without blocking. And then, you return to some known queue to make the completed results available. Pretty straightforward.&lt;&#x2F;p&gt;
&lt;p&gt;(As it turns out, this exact pattern is often not the &lt;a href=&quot;https:&#x2F;&#x2F;forums.developer.apple.com&#x2F;forums&#x2F;thread&#x2F;711736&quot;&gt;best approach&lt;&#x2F;a&gt;, but it&#x27;s fine for our discussion.)&lt;&#x2F;p&gt;
&lt;p&gt;If we want to use &lt;code&gt;async&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;await&lt;&#x2F;code&gt; for this, we have a number of options.&lt;&#x2F;p&gt;
&lt;p&gt;(Performance side-note: I think that Swift Concurrency is &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;pitch-inherit-isolation-by-default-for-async-functions&#x2F;74862&#x2F;52&quot;&gt;ideally-suited&lt;&#x2F;a&gt; for CPU-bound work. It&#x27;s easy to keep the system maximally busy without needing to worry about thread explosion.)&lt;&#x2F;p&gt;
&lt;h3 id=&quot;task-detached&quot;&gt;&lt;code&gt;Task.detached&lt;&#x2F;code&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;It&#x27;s really common to see people reach for &lt;code&gt;Task.detached&lt;&#x2F;code&gt; when trying to handle stuff like this.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;detached {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; JSONDecoder()&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;decode(MyModel&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;, from: data)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	Task { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; do something with model&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;While it &lt;strong&gt;does&lt;&#x2F;strong&gt; give you a place to run code without blocking the enclosing actor, it has a whole bunch of other &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;task&#x2F;detached(priority:operation:)-1g00u&quot;&gt;side-effects&lt;&#x2F;a&gt; you probably don&#x27;t want. It&#x27;s very understandable that &lt;code&gt;Task.detached&lt;&#x2F;code&gt; is used like this, but I think you should pretty much never do it.&lt;&#x2F;p&gt;
&lt;p&gt;There are just better tools for this job.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;concurrent&quot;&gt;&lt;code&gt;@concurrent&lt;&#x2F;code&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;An option I &lt;strong&gt;do&lt;&#x2F;strong&gt; like is to use a concurrent async function. Concurrent async functions will &lt;strong&gt;always&lt;&#x2F;strong&gt; execute on the &quot;global executor&quot;, which is guaranteed to not be on any actor. This gives you an easy way to prevent code from blocking the &lt;code&gt;MainActor&lt;&#x2F;code&gt; (or any other).&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;concurrent&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;decodeModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;from data: Data&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async throws &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; MyModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; JSONDecoder()&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;decode(MyModel&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;, from: data)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A function like this will never block the caller. In fact, callers don&#x27;t even have to think about, or even know, it could be slow. All they need to know is it is asynchronous.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;why-do-this-at-all&quot;&gt;Why do this at all?&lt;&#x2F;h2&gt;
&lt;p&gt;This brings up an interesting question.&lt;&#x2F;p&gt;
&lt;p&gt;If JSON decoding can be slow and the language provides a way to guarantee background execution via a function signature, why doesn&#x27;t &lt;code&gt;JSONDecoder.decode&lt;&#x2F;code&gt; just work that way? If the standard library were changed such that &lt;code&gt;JSONDecoder.decode&lt;&#x2F;code&gt; became async and concurrent, all this would just magically work. It&#x27;s tempting!&lt;&#x2F;p&gt;
&lt;p&gt;But, I think it is &lt;strong&gt;never&lt;&#x2F;strong&gt; the right choice for potentially-slow operations.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;synchronous-is-strictly-more-useful&quot;&gt;Synchronous is strictly more useful&lt;&#x2F;h2&gt;
&lt;p&gt;If &lt;code&gt;JSONDecoder.decode&lt;&#x2F;code&gt; became &lt;code&gt;@concurrent&lt;&#x2F;code&gt;, it&#x27;s true that it would completely eliminate the possibly of blocking an actor. That&#x27;s good! But, it comes with an enormous trade-off.&lt;&#x2F;p&gt;
&lt;p&gt;What if you actually &lt;strong&gt;want&lt;&#x2F;strong&gt; to block?&lt;&#x2F;p&gt;
&lt;p&gt;This is not pretend. It can useful for testing. It can be useful for doing work atomically. It can be called from both synchronous and asynchronous contexts. A synchronous function is just &lt;strong&gt;more&lt;&#x2F;strong&gt; flexible. Yes, it&#x27;s true that sometimes, maybe even most of the time, callers don&#x27;t want to block.&lt;&#x2F;p&gt;
&lt;p&gt;Synchronous functions just give callers more options.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;async-let&quot;&gt;&lt;code&gt;async let&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;Ok, so I hope that I have convinced you that synchronous functions are useful. But they are also more work when you want them to not block. And that&#x27;s most of the time.&lt;&#x2F;p&gt;
&lt;p&gt;Luckily, there&#x27;s another option that I haven&#x27;t used much &lt;strong&gt;yet&lt;&#x2F;strong&gt;, but which is rapidly becoming my favorite. It&#x27;s &lt;code&gt;async let&lt;&#x2F;code&gt;!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;async &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; JSONDecoder()&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;decode(MyModel&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;, from: data)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this will suspend the caller until the work is complete&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await model
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I think it&#x27;s super cool that &lt;code&gt;async let&lt;&#x2F;code&gt; gives you this really lightweight way to spin up a task and run some code. It can even be used for functions that have no return value.&lt;&#x2F;p&gt;
&lt;p&gt;But, there is a little subtly here.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;async &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; _ &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; what&amp;#39;s actually happening here?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The whole purpose of an &lt;code&gt;async let&lt;&#x2F;code&gt; is to allow some work to begin &lt;strong&gt;without&lt;&#x2F;strong&gt; stopping execution. The right hand side of this expression is synchronous.&lt;&#x2F;p&gt;
&lt;p&gt;Because &lt;code&gt;JSONDecoder.decode&lt;&#x2F;code&gt; is non-isolated, this async let will shift that work off the current actor. It will then run in the same context that concurrent async work runs - on the global executor.&lt;&#x2F;p&gt;
&lt;p&gt;But you cannot get around the isolation rules with this.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		async &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; value &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; expensive()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(await value)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;expensive&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; let&amp;#39;s just pretend this is slow&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In this example, &lt;code&gt;expensive&lt;&#x2F;code&gt; is a member of a &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated type. So, even though &lt;code&gt;expensive&lt;&#x2F;code&gt; is being called via &lt;code&gt;async let&lt;&#x2F;code&gt;, it will still end up running on the main thread. To get this work off the actor, you need the function to be non-isolated, like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;expensive&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;asynchronous-work&quot;&gt;Asynchronous work&lt;&#x2F;h2&gt;
&lt;p&gt;Remember, we are worried about work that is &lt;strong&gt;both&lt;&#x2F;strong&gt; long-running and synchronous. So far, we&#x27;ve talked a lot about how to manage synchronous work. But, what about asynchronous stuff?&lt;&#x2F;p&gt;
&lt;p&gt;By definition, awaiting an async function call will free up the current actor until that call completes. So the short answer is once you see an &quot;await&quot;, you have nothing to worry about.&lt;&#x2F;p&gt;
&lt;p&gt;But there is a long answer. To understand it all, we have to look more closely at how async functions actually work.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;callee&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;B&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;C&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;caller&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;A&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await callee()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;D&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;These two functions might look too simplistic to be useful but we can learn a lot from them! If you run &lt;code&gt;caller&lt;&#x2F;code&gt;, the output will look like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;A
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;B
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;C
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;D
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This output, however, doesn&#x27;t give us the whole story. There&#x27;s an important question: can there ever be a suspension between A&#x2F;B or C&#x2F;D?&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;await&lt;&#x2F;code&gt; keyword marks suspension points. These are spots where the current task can suspend and&#x2F;or isolation can change. But, those things might not happen! These are really &lt;strong&gt;potential&lt;&#x2F;strong&gt; suspension points.&lt;&#x2F;p&gt;
&lt;p&gt;It is semantic &lt;strong&gt;guarantee&lt;&#x2F;strong&gt; that when entering or exiting an async function &lt;strong&gt;with the same isolation&lt;&#x2F;strong&gt;, no suspension will occur. That last bit is really important. This only holds when isolation does not change.&lt;&#x2F;p&gt;
&lt;p&gt;But what this means is, despite &lt;code&gt;callee&lt;&#x2F;code&gt; being an async function, there will not be any suspensions at all. We&#x27;ll go from &quot;A&quot; all the way to &quot;D&quot; completely synchronously.&lt;&#x2F;p&gt;
&lt;p&gt;(There are situations where this fact is critical for correct operation. But, here we just want to use it to explore potential blocking.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wait-wait-wait&quot;&gt;Wait wait wait&lt;&#x2F;h2&gt;
&lt;p&gt;This is kind of bad news right? I just told you that once you see an &lt;code&gt;await&lt;&#x2F;code&gt; you don&#x27;t have to worry. Then I followed that up by explaining that even a call with &lt;code&gt;await&lt;&#x2F;code&gt; could actually be synchronous. We know that synchronous calls can be a problem.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s expand our example just slightly so we can investigate.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;callee&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;B&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is a problem!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	slowSynchronousWork()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;C&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;caller&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;A&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await callee()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;D&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;ve introduced a slow, synchronous call into &lt;code&gt;callee&lt;&#x2F;code&gt;. So now, the output will look like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;A
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;B
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;*long delay*
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;C
&lt;&#x2F;span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;D
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Synchronous and slow! This exactly what we want to avoid!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-do-we-do&quot;&gt;What do we do?&lt;&#x2F;h2&gt;
&lt;p&gt;Now, it could be that &lt;code&gt;callee&lt;&#x2F;code&gt; is just implemented inefficiently. It is the thing making that call to &lt;code&gt;slowSynchronousWork&lt;&#x2F;code&gt; after all. Maybe it should be using an &lt;code&gt;async let&lt;&#x2F;code&gt; or some other mechanism to avoid blocking.&lt;&#x2F;p&gt;
&lt;p&gt;The only reason that even matters at all is because of &lt;code&gt;callee&lt;&#x2F;code&gt;&#x27;s &lt;strong&gt;isolation&lt;&#x2F;strong&gt;. If it were non-isolated, things would be fine. It many cases, it might not even need to be non-isolated, just as long as it is &lt;strong&gt;not&lt;&#x2F;strong&gt; &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;And here&#x27;s the critical thing.&lt;&#x2F;p&gt;
&lt;p&gt;In &lt;strong&gt;both&lt;&#x2F;strong&gt; of these situations, the problem can only be solved by &lt;code&gt;callee&lt;&#x2F;code&gt;. Addressing any problematic blocking here really comes down to thinking about and changing the isolation involved. The &lt;code&gt;caller&lt;&#x2F;code&gt; function really has no control over that.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;asynchronous-thinking&quot;&gt;Asynchronous Thinking&lt;&#x2F;h2&gt;
&lt;p&gt;I think the way to approach this is purely in terms of synchronous vs asynchronous execution. If you are writing a synchronous function that could be slow, think about making it non-isolated. You will, of course, need to pass arguments in and get results back out. That may require &lt;code&gt;Sendable&lt;&#x2F;code&gt; types or &lt;code&gt;sending&lt;&#x2F;code&gt;. But this is always the case when moving data around across isolation.&lt;&#x2F;p&gt;
&lt;p&gt;If you are writing an asynchronous function, just focus on getting your problem solved. You might find a &lt;strong&gt;synchronous&lt;&#x2F;strong&gt; bottleneck, but you can address that without breaking your API contract. Don&#x27;t stress out about the performance of calls you make with &lt;code&gt;await&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But if you happen to encounter the situation where you are a) calling an async function b) with the same isolation and c) that is then hitting a synchronous bottleneck, you have yourself a deeper issue. You almost certainly need to make some isolation changes. And if you aren&#x27;t in control of that function I&#x27;d like you to tell about what you did, because I&#x27;m very interested!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>New Concurrency Stuff with 6.1</title>
        <published>2025-02-23T00:00:00+00:00</published>
        <updated>2025-02-23T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-6_1/"/>
        <id>https://massicotte.org/concurrency-6_1/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-6_1/">&lt;p&gt;At long last, there is now a beta release of Swift 6.1! There are a few interesting things in here for those concurrency enthusiasts out there, and I wanted to go over them quickly.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolated-synchronous-deinit&quot;&gt;Isolated synchronous deinit&lt;&#x2F;h2&gt;
&lt;p&gt;(Update: While trying to test this feature, I was unable to get it to work. I, incorrectly, assumed that was just a beta thing. Turns out this has been pulled from 6.1 and will be delayed to a future release. Very sorry to get your hopes up like that.)&lt;&#x2F;p&gt;
&lt;p&gt;This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0371-isolated-synchronous-deinit.md&quot;&gt;proposal&lt;&#x2F;a&gt; has been a long-time coming. Just look at that review process! There were &lt;strong&gt;eight&lt;&#x2F;strong&gt; steps! This, I&#x27;m sure, also gives you an idea of the complexity of the problem.&lt;&#x2F;p&gt;
&lt;p&gt;Many people have been surprised that &lt;code&gt;deinit&lt;&#x2F;code&gt; &lt;strong&gt;wasn&#x27;t&lt;&#x2F;strong&gt; isolated. It doesn&#x27;t always cause issues, but it definitely does come up. There are some workarounds suggested in the concurrency &lt;a href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;migration&#x2F;documentation&#x2F;swift-6-concurrency-migration-guide&#x2F;commonproblems#Non-Isolated-Deinitialization&quot;&gt;migration guide&lt;&#x2F;a&gt;, but it can occasionally be a real problem.&lt;&#x2F;p&gt;
&lt;p&gt;Well &lt;del&gt;as of 6.1&lt;&#x2F;del&gt; in a future release, you&#x27;ll be able to do this!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; SomeMainClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	isolated &lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;deinit&lt;&#x2F;span&gt;() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is now MainActor!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You do have to explicitly opt into this functionality with that &lt;code&gt;isolated&lt;&#x2F;code&gt; keyword. First, because applying it automatically would be source-breaking. But second, this behavior has a performance cost. I don&#x27;t think you have to be &lt;strong&gt;afraid&lt;&#x2F;strong&gt; of that cost, but you should definitely be aware of it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;allow-nonisolated-to-prevent-global-actor-inference&quot;&gt;Allow nonisolated to prevent global actor inference&lt;&#x2F;h2&gt;
&lt;p&gt;I really like &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0449-nonisolated-for-global-actor-cutoff.md&quot;&gt;proposals&lt;&#x2F;a&gt; that make things work more intuitively. What this one does is expand the use of &lt;code&gt;nonisolated&lt;&#x2F;code&gt; so you can better control global isolation inference.&lt;&#x2F;p&gt;
&lt;p&gt;Suppose you&#x27;ve got some non-isolated protocol with a bunch of requirements. But, you want to apply it to a &lt;code&gt;MainActor&lt;&#x2F;code&gt; type.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; NotIsolated {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	func doThings&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MainActorType {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Before, you had to do something like this.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; MainActorType &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; NotIsolated {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doThings&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;But with this 6.1, you can shift that &lt;code&gt;nonisolated&lt;&#x2F;code&gt; to the extension!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;nonisolated &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; MainActorType &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; NotIsolated {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doThings&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I like this. And that&#x27;s just one example. You can now use &lt;code&gt;nonisolated&lt;&#x2F;code&gt; in inheritance clauses and other spots too. This is very convenient, and could play a more important role, given &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;pitch-control-default-actor-isolation-inference&#x2F;77482&quot;&gt;other changes&lt;&#x2F;a&gt; that may be coming.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;allow-taskgroup-s-childtaskresult-type-to-be-inferred&quot;&gt;Allow TaskGroup&#x27;s ChildTaskResult Type To Be Inferred&lt;&#x2F;h2&gt;
&lt;p&gt;I completely missed &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0442-allow-taskgroup-childtaskresult-type-to-be-inferred.md&quot;&gt;this one&lt;&#x2F;a&gt; when it was pitched! It&#x27;s just a great little quality-of-life improvement for the &lt;code&gt;with*TaskGroup&lt;&#x2F;code&gt; family of APIs.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m going to steal and simplify the examples from the proposal, because they make the change really clear. When you are working with &lt;code&gt;TaskGroup&lt;&#x2F;code&gt;, you always need to provide some kind of clue on the types involved. Like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; messages &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await withTaskGroup(of: Message&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;) { group &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That &lt;code&gt;(of: Message.self)&lt;&#x2F;code&gt; argument part is required. Or at least, it was! With Swift 6.1 it is no longer necessary.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; messages &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await withTaskGroup { group &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; the result type can now be inferred!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The type inference happening here is not magic, and there are some patterns that will defeat it. But they are rare, and I think this is super cool. Well done &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;rlziii&quot;&gt;Richard&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;other-improvements&quot;&gt;Other improvements&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;ve been looking very forward to Swift 6.1 for a while now. This release contains a bunch of great diagnostic improvements. There&#x27;s nothing life-changing, but efforts here are very welcome.&lt;&#x2F;p&gt;
&lt;p&gt;Another area that has seen attention is around the &lt;code&gt;sending&lt;&#x2F;code&gt; keyword. There were a number of situations where the compiler was too conservative with &lt;code&gt;sending&lt;&#x2F;code&gt; and 6.1 has gotten a lot better! If you have run into issues here, take a look. Quite a few problems I have encountered have been addressed.&lt;&#x2F;p&gt;
&lt;p&gt;(Upon further reflection, these fixes I&#x27;ve noticed are probably technically all improvements to the &lt;a href=&quot;https:&#x2F;&#x2F;massicotte.org&#x2F;concurrency-6_1&#x2F;concurrency-swift-6-se-0414&quot;&gt;region-based isolation&lt;&#x2F;a&gt; system and not really &lt;code&gt;sending&lt;&#x2F;code&gt; specifically.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-s-next&quot;&gt;What&#x27;s Next?&lt;&#x2F;h2&gt;
&lt;p&gt;There was an incredible amount of activity recently in the Swift world, all centered around the now-approved &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;visions&#x2F;approachable-concurrency.md&quot;&gt;vision document&lt;&#x2F;a&gt; to improve the approachability of data-race safety. I&#x27;m excited, because there is good stuff coming!&lt;&#x2F;p&gt;
&lt;p&gt;And speaking of good stuff, have you noticed that Swift is now on both &lt;a href=&quot;https:&#x2F;&#x2F;bsky.app&#x2F;profile&#x2F;swift.org&quot;&gt;Bluesky&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;mastodon.social&#x2F;@swiftlang&quot;&gt;Mastodon&lt;&#x2F;a&gt;?&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Leverage</title>
        <published>2025-02-17T00:00:00+00:00</published>
        <updated>2025-02-17T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/leverage/"/>
        <id>https://massicotte.org/leverage/</id>
        
        <content type="html" xml:base="https://massicotte.org/leverage/">&lt;p&gt;I&#x27;m really not sure how to start this one. Normally, I write about technical topics. But, that&#x27;s not what this is. This is different. So I&#x27;m just going to say it.&lt;&#x2F;p&gt;
&lt;p&gt;Apple is supporting a regime that is not just destroying democracy in the United States, but is actively working to do so globally. Not to mention attacking my own country of Canada. And, now, Apple have also resumed using X, a platform whose sole purpose is to further these goals.&lt;&#x2F;p&gt;
&lt;p&gt;To put it mildly, I have been struggling with this. I have been trying to find ways to respond. Something that could give me some kind of &lt;strong&gt;leverage&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Apple relies heavily on feedback from third-party developers to find bugs in new APIs and OSes. Because of their development cycle, this is &lt;strong&gt;especially&lt;&#x2F;strong&gt; critical during a beta period.&lt;&#x2F;p&gt;
&lt;p&gt;So I&#x27;m just no longer going to use Feedback Assistant. I will not use beta OSes. I will not share crash reports for Apple software. Because of Swift&#x27;s exclusive use of X, I will no longer participate in the Swift forums or evolution process. I will also actively discourage others from doing these things.&lt;&#x2F;p&gt;
&lt;p&gt;And, yes I &lt;strong&gt;hate&lt;&#x2F;strong&gt; this. I also deeply respect Apple engineers and I have no doubt this is a very hard time. I&#x27;m truly sorry that your leadership has dragged us into this, but they did.&lt;&#x2F;p&gt;
&lt;p&gt;I hope there are others out there that will join me. ❤️&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>A Swift Concurrency Glossary</title>
        <published>2025-01-25T00:00:00+00:00</published>
        <updated>2025-09-17T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-glossary/"/>
        <id>https://massicotte.org/concurrency-glossary/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-glossary/">&lt;p&gt;It would be nice if there was a single place to go to look up all the terms, keywords, and annotations related to Swift concurrency. So here it is. If you notice something I&#x27;ve missed, pleased o let me know. Oh and of course, I included some commentary.&lt;&#x2F;p&gt;
&lt;p&gt;Also, by &lt;strong&gt;no means&lt;&#x2F;strong&gt; do you need to understand everything here to use Swift Concurrency successfully.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actor&quot;&gt;&lt;code&gt;actor&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Keyword&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Defines a new reference type that protects mutable state&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0306-actors.md&quot;&gt;SE-0306&lt;&#x2F;a&gt; Actors&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Actors are the thing that define a unit of isolation. They are easy to &lt;strong&gt;make&lt;&#x2F;strong&gt;, but require a fair bit of understanding and practice to use successfully.&lt;&#x2F;p&gt;
&lt;p&gt;(I have now written a &lt;a href=&quot;&#x2F;actors&quot;&gt;whole post&lt;&#x2F;a&gt; about how and when to use an actor.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actor-1&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;actor&quot;&gt;&lt;code&gt;Actor&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Protocol&lt;&#x2F;li&gt;
&lt;li&gt;Usage: A protocol which all actor types conform to&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0306-actors.md&quot;&gt;SE-0306&lt;&#x2F;a&gt; Actors&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is kinda like &lt;code&gt;AnyObject&lt;&#x2F;code&gt;, but only for actor types. You&#x27;ll rarely need this, aside from making isolated parameters.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;async&quot;&gt;&lt;code&gt;async&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: keyword&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Applied to a function signature so it can be used with &lt;code&gt;await&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0296-async-await.md&quot;&gt;SE-0296&lt;&#x2F;a&gt; Async&#x2F;await&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This keyword marks an &quot;&lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Effect_system&quot;&gt;effect&lt;&#x2F;a&gt;&quot; on a function, allowing it to use &lt;code&gt;await&lt;&#x2F;code&gt; internally and also be itself awaited.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;asyncsequence&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;asyncsequence&quot;&gt;&lt;code&gt;AsyncSequence&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Protocol&lt;&#x2F;li&gt;
&lt;li&gt;Usage: A series of value that are produced over time&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0298-asyncsequence.md&quot;&gt;SE-0298&lt;&#x2F;a&gt; Async&#x2F;Await: Sequences&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is a protocol that describes a sequence who&#x27;s values may only be available at some point in the future.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;async-let&quot;&gt;&lt;code&gt;async let&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Flow Control&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Convenient shortcut to wrap work in a new Task&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0317-async-let.md&quot;&gt;SE-03017&lt;&#x2F;a&gt; &lt;code&gt;async let&lt;&#x2F;code&gt; bindings&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This one gives you a way to begin some work asynchronously without needing to await immediately. Does come with some subtly, but is particularly useful for managing slow, &lt;a href=&quot;&#x2F;synchronous-work&quot;&gt;synchronous work&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;await&quot;&gt;&lt;code&gt;await&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: keyword&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Marks a suspension point that allows an async function to execute&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0296-async-await.md&quot;&gt;SE-0296&lt;&#x2F;a&gt; Async&#x2F;await&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The other half of &lt;code&gt;async&lt;&#x2F;code&gt;. You use this to introduce a potential suspension point in the currently executing task. At these points, the actor executing code can change.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;concurrent&quot;&gt;&lt;code&gt;@concurrent&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: annotation&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Causes an async function to run on the global executor&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0461-async-function-isolation.md&quot;&gt;SE-0461&lt;&#x2F;a&gt; Run nonisolated async functions on the caller&#x27;s actor by default&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;As of Swift 6.2, you can opt into nonisolated async functions inheriting the calling isolation. This is incredibly useful, but you now cannot use that to run functions in the background. This attribute gives you a settings-independent way to ensure a function never runs on an actor.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;continuations&quot;&gt;Continuations&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Type&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Makes it possible to wrap up callback-based code so it can be used with &lt;code&gt;await&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0300-continuation.md&quot;&gt;SE-0300&lt;&#x2F;a&gt; Continuations for interfacing async tasks with synchronous code&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Asynchronous execution is not new. But, it was very commonly done using callbacks and closures. This is a whole suite of APIs that allows you to express these concepts in terms of async functions.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;default-isolation&quot;&gt;Default Isolation&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Concept&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Control the implicit default isolation&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0466-control-default-actor-isolation.md&quot;&gt;SE-0466&lt;&#x2F;a&gt; Control default actor isolation inference&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;All declarations have a well-defined static isolation, which means a default is required. This was always &lt;code&gt;nonisolated&lt;&#x2F;code&gt;, up to Swift 6.2, where we gained the ability to change this to &lt;code&gt;MainActor&lt;&#x2F;code&gt;. This capability has introduced a formal language dialect: you cannot understand the semantics of Swift code without knowing the value of this setting.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;executor&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;executor&quot;&gt;&lt;code&gt;Executor&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Protocol&lt;&#x2F;li&gt;
&lt;li&gt;Usage: An API for expressing how actors execute code&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0304-structured-concurrency.md&quot;&gt;SE-0304&lt;&#x2F;a&gt; Structured concurrency&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;There is a pretty large set of APIs for controlling and interacting with the underlying mechanisms an actor uses to run code. This is rarely required for day-to-day Swift development, but is there for advanced uses and performance considerations.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;for-await&quot;&gt;&lt;code&gt;for-await&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Flow Control&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Get the values from an &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0298-asyncsequence.md&quot;&gt;SE-0298&lt;&#x2F;a&gt; Async&#x2F;Await: Sequences&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This gives you a way to retrieve the values in an &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt; via a control structure that very closely resembles a traditional for loop.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;globalactor&quot;&gt;&lt;code&gt;@globalActor&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: annotation&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Marks an actor type as global, allowing it to be used as a global actor annotation&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0316-global-actors.md&quot;&gt;SE-0316&lt;&#x2F;a&gt; Global actors&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is how you make an actor type &quot;global&quot;. A global actor&#x27;s type name can be referenced in annotation form, and can be used to apply static isolation.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;global-executor&quot;&gt;Global Executor&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: concept&lt;&#x2F;li&gt;
&lt;li&gt;Usage: The executor that runs concurrent code&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0338-clarify-execution-non-actor-async.md&quot;&gt;SE-0338&lt;&#x2F;a&gt; Clarify the Execution of Non-Actor-Isolated Async Functions&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Actors run code they isolate on their executor. But, there&#x27;s also an executor available that can run code not isolated to any actor. Unlike actor executors, this one is &lt;strong&gt;not&lt;&#x2F;strong&gt; serial and can run more than one thing simultaneously. You get code on this with &lt;code&gt;async let&lt;&#x2F;code&gt;, &lt;code&gt;TaskGroup&lt;&#x2F;code&gt;, and &lt;code&gt;@concurrent&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolated&quot;&gt;&lt;code&gt;isolated&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: keyword&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Defines static isolation via a parameter of a function&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0313-actor-isolation-control.md&quot;&gt;SE-0313&lt;&#x2F;a&gt; Improved control over actor isolation&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;There are four ways to define isolation statically, with this being the most powerful and complex. This is an essential tool &lt;strong&gt;if&lt;&#x2F;strong&gt; you need to integrate concurrency into non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types.&lt;&#x2F;p&gt;
&lt;p&gt;(There&#x27;s &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;pitch-inherit-isolation-by-default-for-async-functions&#x2F;74862&quot;&gt;work&lt;&#x2F;a&gt; going on to simplify this area! I&#x27;ve also written something about how to &lt;a href=&quot;&#x2F;non-sendable&quot;&gt;use it&lt;&#x2F;a&gt; with non-Sendable types.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolated-any&quot;&gt;&lt;code&gt;@isolated(any)&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: annotation&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Makes it possible to inspect a function&#x27;s static isolation at runtime&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0431-isolated-any-functions.md&quot;&gt;SE-0431&lt;&#x2F;a&gt; &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;There are rare cases where you may want to inspect the static isolation was of a function that has been passed around as a variable. This annotations makes that possible. If you are thinking about this, you probably want to combine it with &lt;code&gt;@_inheritActorContext&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;(I&#x27;ve written the introduction of &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;this attribute&lt;&#x2F;a&gt; specifically, along with a &lt;a href=&quot;https:&#x2F;&#x2F;nshipster.com&#x2F;isolated-any&#x2F;&quot;&gt;biggest post&lt;&#x2F;a&gt; that looks at it more closely.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolation&quot;&gt;isolation&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: concept&lt;&#x2F;li&gt;
&lt;li&gt;Usage: The form of thread-safety that an actor type provides&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0306-actors.md&quot;&gt;SE-0306&lt;&#x2F;a&gt; Actors&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Isolation is this abstraction over ways to make things thread-safe. Actors are the things that implement that safety, perhaps via a serial queue.&lt;&#x2F;p&gt;
&lt;p&gt;(I&#x27;ve got two things on this. One about how you &lt;a href=&quot;&#x2F;intro-to-isolation&quot;&gt;use isolation&lt;&#x2F;a&gt; and another to help &lt;a href=&quot;&#x2F;isolation-intuition&quot;&gt;think&lt;&#x2F;a&gt; about it.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolation-1&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;isolation()&quot;&gt;&lt;code&gt;#isolation&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: expression macro&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Returns the static isolation as &lt;code&gt;(any Actor)?&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0420-inheritance-of-actor-isolation.md&quot;&gt;SE-0420&lt;&#x2F;a&gt; Inheritance of actor isolation&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;If you are using an isolated parameter, you &lt;strong&gt;may&lt;&#x2F;strong&gt; want to use this as well. I also have found it handy for printing out what the compiler thinks the isolation is at a specific point.&lt;&#x2F;p&gt;
&lt;p&gt;(I&#x27;ve written about &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;this one&lt;&#x2F;a&gt; as well.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;inheritactorcontext&quot;&gt;&lt;code&gt;@_inheritActorContext&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: parameter annotation&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Applies isolation inheritance to a closure parameter&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: ?&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;You can use this one to match the sematics of &lt;code&gt;Task&lt;&#x2F;code&gt;, so a closure can maintain the same isolation as where it was formed. Usually goes together with &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;(There is a &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;closure-isolation-control&#x2F;70378&quot;&gt;proposal&lt;&#x2F;a&gt; floating around that will formalize this one, though I do have &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;distinction-between-isolated-any-and-inheritactorcontext&#x2F;75730&quot;&gt;complex feelings&lt;&#x2F;a&gt; about it.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;mainactor&quot;&gt;&lt;code&gt;@MainActor&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: annotation&lt;&#x2F;li&gt;
&lt;li&gt;Usage: The global actor annotation for the &lt;code&gt;MainActor&lt;&#x2F;code&gt; type&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0316-global-actors.md&quot;&gt;SE-0316&lt;&#x2F;a&gt; Global actors&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I bet you&#x27;ve come across this one before. It is just how you reference the shared &lt;code&gt;MainActor&lt;&#x2F;code&gt; instance.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;nonisolated&quot;&gt;&lt;code&gt;nonisolated&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: keyword&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Explicitly turn off actor isolation for a declaration&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0313-actor-isolation-control.md&quot;&gt;SE-0313&lt;&#x2F;a&gt; Improved control over actor isolation&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Actors provide isolation, but sometimes you want to disable that. This is a handy way to hop off an actor to run some code in the background.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;nonisolated-nonsending&quot;&gt;&lt;code&gt;nonisolated(nonsending)&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: annotation&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Causes an async function to inherit the caller&#x27;s isolation&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0461-async-function-isolation.md&quot;&gt;SE-0461&lt;&#x2F;a&gt; Run nonisolated async functions on the caller&#x27;s actor by default&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is a very powerful technique for avoiding the need for Sendable types. The attribute gives you a settings-independent way to make a function that inherits the caller&#x27;s isolation. Similar to the problem addressed with &lt;code&gt;@concurrent&lt;&#x2F;code&gt;, but from the other direction.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;nonisolated-unsafe&quot;&gt;&lt;code&gt;nonisolated(unsafe)&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: annotation&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Opts a declaration out of Sendable checking&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0306-actors.md&quot;&gt;SE-0306&lt;&#x2F;a&gt; Actors&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This gives you a very targeted way to opt a declaration out of the compiler&#x27;s isolation checks. It is a much less-error-prone tool than &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt; or a preconcurrency import.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;preconcurrency&quot;&gt;&lt;code&gt;@preconcurrency&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: attribute&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Multiple, all around how code built for Swift 6 interacts with code that has not&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0337-support-incremental-migration-to-concurrency-checking.md&quot;&gt;SE-0337&lt;&#x2F;a&gt; Incremental migration to concurrency checking, &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0423-dynamic-actor-isolation.md&quot;&gt;SE-0423&lt;&#x2F;a&gt;: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;If you are consuming APIs written before Swift 6, or making APIs that need to remain compatible with Swift 5 mode, you pretty much need this one.&lt;&#x2F;p&gt;
&lt;p&gt;(I&#x27;ve gone into some depth about &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;how this works&lt;&#x2F;a&gt;.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;region-based-isolation&quot;&gt;Region-Based Isolation&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: concept&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Allows the compiler to relax &lt;code&gt;Sendable&lt;&#x2F;code&gt; checking in specific circumstances&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0414-region-based-isolation.md&quot;&gt;SE-0414&lt;&#x2F;a&gt; Region-based Isolation&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is a code-flow analysis system that allows the compiler to prove that even if a type is not &lt;code&gt;Sendable&lt;&#x2F;code&gt;, a specific usage pattern may still always be safe. It can really only work within the scope of a single function body, but the &lt;code&gt;sending&lt;&#x2F;code&gt; keyword does allow it to be even more powerful.&lt;&#x2F;p&gt;
&lt;p&gt;(My summary of this is &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;here&lt;&#x2F;a&gt;.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sendable&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;sendable&quot;&gt;&lt;code&gt;Sendable&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Protocol&lt;&#x2F;li&gt;
&lt;li&gt;Usage: A marker protocol that indicates a type can be safely used from any isolation, including none at all&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0302-concurrent-value-and-concurrent-closures.md&quot;&gt;SE-0302&lt;&#x2F;a&gt; Sendable and &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closures&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This provides a way to encode the thread-safety of a type into the type system. And it has no members so how complex could it possibly be?&lt;&#x2F;p&gt;
&lt;p&gt;(I haven&#x27;t even written about this directly, but I did cover the general idea &lt;a href=&quot;&#x2F;non-sendable&quot;&gt;here&lt;&#x2F;a&gt;.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sendablemetatype&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;sendablemetatype&quot;&gt;&lt;code&gt;SendableMetatype&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Protocol&lt;&#x2F;li&gt;
&lt;li&gt;Usage: A marker protocol that indicates a metatype can be safely used from any isolation&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0470-isolated-conformances.md&quot;&gt;SE-0470&lt;&#x2F;a&gt; Global-actor isolated conformances&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Prior to Swift 6.2, all types were &lt;code&gt;Sendable&lt;&#x2F;code&gt; and this concept wasn&#x27;t required. But, isolated conformances brought with it some extra complexity here that required the new protocol.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sendable-1&quot;&gt;&lt;code&gt;@Sendable&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Attribute&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Functions cannot conform to protocols, so an attribute is required to express the same concept&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0302-concurrent-value-and-concurrent-closures.md&quot;&gt;SE-0302&lt;&#x2F;a&gt; Sendable and &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closures&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is exactly the same thing as &lt;code&gt;Sendable&lt;&#x2F;code&gt;, but for function types.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sending&quot;&gt;&lt;code&gt;sending&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Keyword&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Express the concurrent usage of parameters and return values into the type system&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0430-transferring-parameters-and-results.md&quot;&gt;SE-0430&lt;&#x2F;a&gt; &lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Sometimes &lt;code&gt;Sendable&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;@Sendable&lt;&#x2F;code&gt; is too difficult or just unnecessarily restrictive. The &lt;code&gt;sending&lt;&#x2F;code&gt; keyword is a way relax some constraints by encoding a strict promise about the behavior of values into your function signatures.&lt;&#x2F;p&gt;
&lt;p&gt;(And, yes, I did in fact &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;write&lt;&#x2F;a&gt; about it!)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;task&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;task&quot;&gt;&lt;code&gt;Task&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Type&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Creates a new top-level context to run async code&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0304-structured-concurrency.md&quot;&gt;SE-0304&lt;&#x2F;a&gt; Structured concurrency&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;You gotta start somewhere, and for async functions it&#x27;s usually via a &lt;code&gt;Task&lt;&#x2F;code&gt;. But this type somes with a lot of features, to support things like cancellation and accessing results.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;taskgroup&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;taskgroup&quot;&gt;&lt;code&gt;TaskGroup&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Type&lt;&#x2F;li&gt;
&lt;li&gt;Usage: An API to work with an arbitrary number of child tasks&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0304-structured-concurrency.md&quot;&gt;SE-0304&lt;&#x2F;a&gt; Structured concurrency&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;A &lt;code&gt;TaskGroup&lt;&#x2F;code&gt; gives you a way to manage and control multiple child &lt;code&gt;Task&lt;&#x2F;code&gt; instances. Useful for tackling a variety of problems, including just doing a bunch of stuff simultaneously.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;tasklocal&quot;&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;tasklocal&quot;&gt;&lt;code&gt;TaskLocal&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Type&lt;&#x2F;li&gt;
&lt;li&gt;Usage: A mechanism for making values available across the current task&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0311-task-locals.md&quot;&gt;SE-0311&lt;&#x2F;a&gt; Task Local Values&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is kind of like the analog of thread-local values, but for tasks. They are quite an advanced tool, but there are lots of clever&#x2F;tricky things you can pull off with them.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;unchecked&quot;&gt;&lt;code&gt;@unchecked&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Type: Annotation&lt;&#x2F;li&gt;
&lt;li&gt;Usage: Disables compiler checks for a &lt;code&gt;Sendable&lt;&#x2F;code&gt; conformance&lt;&#x2F;li&gt;
&lt;li&gt;Introduced: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0302-concurrent-value-and-concurrent-closures.md&quot;&gt;SE-0302&lt;&#x2F;a&gt; Sendable and &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closures&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Sometimes, you&#x27;ve already got thread-safety implemented, but it is done via a mechanism don&#x27;t support Swift&#x27;s compiler-based checking. Declaring a type &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt; let&#x27;s you express that situation.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Migrating from the Outside in</title>
        <published>2025-01-10T00:00:00+00:00</published>
        <updated>2025-01-10T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/outside-in-migration/"/>
        <id>https://massicotte.org/outside-in-migration/</id>
        
        <content type="html" xml:base="https://massicotte.org/outside-in-migration/">&lt;p&gt;There is a section in the Swift 6 migration guide on Swift.org called &lt;a href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;migration&#x2F;documentation&#x2F;swift-6-concurrency-migration-guide&#x2F;migrationstrategy&quot;&gt;&quot;Migration Strategy&quot;&lt;&#x2F;a&gt;. Let me quote it here:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;This document outlines a general strategy that could be a good starting point. There is no one single approach that will work for all projects.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;These two sentences are quite a hedge!&lt;&#x2F;p&gt;
&lt;p&gt;But, if you continue, you&#x27;ll see that the advice is to start at the &quot;outside&quot; of your application and work your way in. Why would you do this? The reasons are simple.&lt;&#x2F;p&gt;
&lt;p&gt;First, the closer you are to your UI, the more main actor stuff you&#x27;ll have. That means very clear, unambiguous places where you can establish isolation. Just sprinkle those &lt;code&gt;@MainActor&lt;&#x2F;code&gt; annotations around. And, as I have &lt;a href=&quot;https:&#x2F;&#x2F;www.massicotte.org&#x2F;step-by-step-reading-from-storage&quot;&gt;discussed&lt;&#x2F;a&gt; many times before, using concurrency &lt;em&gt;without&lt;&#x2F;em&gt; any isolation is &lt;a href=&quot;https:&#x2F;&#x2F;www.massicotte.org&#x2F;non-sendable&quot;&gt;way harder&lt;&#x2F;a&gt;. Especially when you are getting started, which you probably are when just beginning a migration.&lt;&#x2F;p&gt;
&lt;p&gt;(Update: it is getting &lt;a href=&quot;https:&#x2F;&#x2F;massicotte.org&#x2F;outside-in-migration&#x2F;non-sending-first-design&quot;&gt;easier&lt;&#x2F;a&gt;!)&lt;&#x2F;p&gt;
&lt;p&gt;Second, it can help you find the places where your UI design need synchronous accesses. This can turn out to be really &lt;strong&gt;annoying&lt;&#x2F;strong&gt;, but your synchronous accesses define these core constraints on your system. You might really &lt;strong&gt;want&lt;&#x2F;strong&gt; to make something an actor, but if you need synchronous access to it from the UI, you just &lt;strong&gt;can&#x27;t&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Speaking of which - you do &lt;strong&gt;not&lt;&#x2F;strong&gt; need to be afraid of &lt;code&gt;@MainActor&lt;&#x2F;code&gt;! You need only be worried about long-running, synchronous work. You need &lt;strong&gt;both&lt;&#x2F;strong&gt; to have a problem. And even then, look into moving just that work into a &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;non-isolated method&lt;&#x2F;a&gt;. That is so much easier than making a mess of your system just to avoid making your type &lt;code&gt;@MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;(Dealing with synchronous work really deserves a whole post on its own, but that&#x27;s for another day. Update: that &lt;a href=&quot;&#x2F;synchronous-work&quot;&gt;day has come&lt;&#x2F;a&gt;!)&lt;&#x2F;p&gt;
&lt;p&gt;Now, of course the real world is more complex. You&#x27;ll often bounce around into modules to make structs &lt;code&gt;Sendable&lt;&#x2F;code&gt; or to deal with static vars. But, I do think this is a great way &lt;strong&gt;to start&lt;&#x2F;strong&gt; for many projects.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Concurrency Step-by-Step: Stateful Systems</title>
        <published>2024-12-30T00:00:00+00:00</published>
        <updated>2024-12-30T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/step-by-step-stateful-systems/"/>
        <id>https://massicotte.org/step-by-step-stateful-systems/</id>
        
        <content type="html" xml:base="https://massicotte.org/step-by-step-stateful-systems/">&lt;p&gt;You know what? Coming up with example material is hard. This might sound silly or like it doesn&#x27;t matter that much, but it really does! Of course, a great example helps keep things understandable. It makes writing a lot more enjoyable too. But, writing is still a lot of work.&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s why I was so annoyed when &lt;a href=&quot;https:&#x2F;&#x2F;mastodon.social&#x2F;@jamesdempsey&quot;&gt;James Dempsey&lt;&#x2F;a&gt; messaged me with a fantastic idea.&lt;&#x2F;p&gt;
&lt;p&gt;He noted that both the &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;first&lt;&#x2F;a&gt; and &lt;a href=&quot;&#x2F;step-by-step-reading-from-storage&quot;&gt;second&lt;&#x2F;a&gt; of these posts used an exclusively read-only system. That&#x27;s completely unrealistic! Real applications write to local storage, remote services, and generally are up to their eyeballs in mutable state.&lt;&#x2F;p&gt;
&lt;p&gt;In this post, we&#x27;re going to build a SwiftUI app that works with state hosted on a (pretend) remote network service.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;quick-notes&quot;&gt;Quick notes&lt;&#x2F;h2&gt;
&lt;p&gt;Following all previous posts in this series, I&#x27;m going to ignore errors and require Xcode 16. I also remain a SwiftUI beginner, and there&#x27;s more SwiftUI here than in other posts.&lt;&#x2F;p&gt;
&lt;p&gt;Another important note is that I tried, and failed, to find a suitable free remote service to use. At first I thought this was a deal-breaker. But, then I realized that this might be a happy accident. Read on to find out why!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-remote-system&quot;&gt;A &quot;remote&quot; system&lt;&#x2F;h2&gt;
&lt;p&gt;To start, we need some kind of remote service to interact with. The whole point of this exercise is to deal with state, so it is important that this system be &lt;strong&gt;stateful&lt;&#x2F;strong&gt;. But I couldn&#x27;t find one, so we&#x27;re just going to pretend.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;final&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; RemoteSystem: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;unchecked&lt;&#x2F;span&gt; Sendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; queue &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; DispatchQueue(label: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;R&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;S&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;Q&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggleState&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;completionHandler: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			completionHandler()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;readState&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;completionHandler: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (&lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			completionHandler(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is a simulation of a remote system that manages exactly one boolean. The outside world can toggle or read the current state, but it must do so asynchronously.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m sure you&#x27;ve also noticed that I also chose to implement this with dispatch. To make this work with Swift 6, we have to inform the compiler that we assumed responsibility for thread-safety by marking the type &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt;. We also need a few &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closures.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-view&quot;&gt;A view&lt;&#x2F;h2&gt;
&lt;p&gt;Now, we need a view that actually does something with this system.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; ContentView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; system &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; RemoteSystem()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; imageName: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		state &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;?&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;press&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggleState {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;readState { value &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;main&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;					&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; value
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Image(systemName: imageName)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;imageScale(&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;large)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;foregroundStyle(&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;tint)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;onTapGesture {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				press()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;padding()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;body&lt;&#x2F;code&gt; of this view isn&#x27;t particularly interesting, but that &lt;code&gt;press&lt;&#x2F;code&gt; function is where all the action is. When you touch the star image, we toggle the remote state, then read it, and finally update our UI to reflect the result. Again, all with dispatch in Swift 6 mode.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;reentrancy&quot;&gt;Reentrancy&lt;&#x2F;h2&gt;
&lt;p&gt;This code compiles, but it has serious problems. That &lt;code&gt;press&lt;&#x2F;code&gt; function runs a series of asynchronous operations, each with a dependency on what came before. The problem is there&#x27;s nothing stopping the user from tapping again &lt;strong&gt;while&lt;&#x2F;strong&gt; the first tap is being processed. And the timing of a remote system is both unpredictable and variable. It is possible for that second tap to actually finish &lt;strong&gt;before&lt;&#x2F;strong&gt; the first, resulting in the two flows interleaving in unfortunate ways.&lt;&#x2F;p&gt;
&lt;p&gt;The following sequence of events can actually happen:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;User taps&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;toggleState&lt;&#x2F;code&gt; begins, but is slow for some reason&lt;&#x2F;li&gt;
&lt;li&gt;User taps again&lt;&#x2F;li&gt;
&lt;li&gt;another &lt;code&gt;toggleState&lt;&#x2F;code&gt; begins, but this time is fast!&lt;&#x2F;li&gt;
&lt;li&gt;then its read completes and the UI is updated&lt;&#x2F;li&gt;
&lt;li&gt;now first &lt;code&gt;toggleState&lt;&#x2F;code&gt; finally completes&lt;&#x2F;li&gt;
&lt;li&gt;UI is updated again, reversing what user intended&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;There are many possible variations of this. But, we have this problem because this code isn&#x27;t &lt;strong&gt;atomic&lt;&#x2F;strong&gt;. It&#x27;s possible for &lt;code&gt;press&lt;&#x2F;code&gt; to start executing again before a previous invocation completed. The function can be &quot;entered&quot;, and then it can be &quot;re-rentered&quot; again, potentially many times.&lt;&#x2F;p&gt;
&lt;p&gt;This is &lt;strong&gt;reentrancy&lt;&#x2F;strong&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-term-reentrancy&quot;&gt;The term &quot;reentrancy&quot;&lt;&#x2F;h2&gt;
&lt;p&gt;I don&#x27;t really like the term &quot;reentrant&quot;. First, I just find it awkward to say&#x2F;read. Second, historically, saying that &quot;a function is reentrant&quot; has often meant that it is &lt;strong&gt;safe&lt;&#x2F;strong&gt; to use simultaneously from multiple threads. And, third, I don&#x27;t feel like it expresses the problem particularly well.&lt;&#x2F;p&gt;
&lt;p&gt;This is just a plain old race condition. But, it isn&#x27;t a &lt;strong&gt;data&lt;&#x2F;strong&gt; race. We do not have multiple threads reading&#x2F;writing the same spots in memory. I prefer to call these kinds of things &quot;logical&quot; races. (If there is a more correct term, however, please do let me know!)&lt;&#x2F;p&gt;
&lt;p&gt;Interestingly, you do not even need to have multiple threads to have logical races. You just need some way for multiple things to happen at the same time. A single threaded-program with a runloop is enough. As soon as you can have non-synchronous execution, you can have logical races.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actors&quot;&gt;Actors&lt;&#x2F;h2&gt;
&lt;p&gt;I chose to use dispatch exclusively to illustrate that you don&#x27;t need actors or Swift concurrency anywhere to run into these kinds of problems. Yet, people talk a lot about &quot;actor reentrancy&quot; specifically when working with concurrency - and for good reason! We just have to do some work before we can look at that more closely.&lt;&#x2F;p&gt;
&lt;p&gt;The first thing we&#x27;ll do is make an actor to model our remote system.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor RemoteSystem {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private(set)&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggleState&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If you go back and compare the two implementations, it&#x27;s kind of dramatic how much less code this is. Actors provide an extremely convenient way to protect state via an async interface.&lt;&#x2F;p&gt;
&lt;p&gt;However, I think what&#x27;s even more interesting is what we are using an actor to model.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actor-vs-service&quot;&gt;Actor vs service&lt;&#x2F;h2&gt;
&lt;p&gt;Remember, I wanted to find a simple &lt;strong&gt;remote&lt;&#x2F;strong&gt; service. Being remote, the only way to interact with it would be via network requests. Actors are a lot like a remote service, in that the only way you can possibly interact with their internal state is asynchronously.&lt;&#x2F;p&gt;
&lt;p&gt;But there&#x27;s more! To use a network service, you also must package up and send any parameters over the wire. And, in turn, that service has to do the same to return any results back. This is a great way to think about actors from a design perspective. All the inputs and outputs need to be sent back and forth too.&lt;&#x2F;p&gt;
&lt;p&gt;Of course a remote service needs the data to actually be serialized for transport. With an actor, we don&#x27;t need the serialization. We just need to ensure that it&#x27;s safe for these types to leave whatever thread&#x2F;queue they are currently in to &quot;send&quot; them over to the actor. We need these inputs and outputs to be &lt;code&gt;Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Actors and remote network services are not interchangeable. But they can be really close! And I think it can be useful to think about them in a similar way.&lt;&#x2F;p&gt;
&lt;p&gt;(This similarity to remote services is exactly where &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;distributed&quot;&gt;distributed actors&lt;&#x2F;a&gt; comes from!)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;using-the-actor&quot;&gt;Using the actor&lt;&#x2F;h2&gt;
&lt;p&gt;Ok, now back to the problem at hand. We also have to modify the view to actually make use of this actor-ified system. But, we can keep the changes localized to just that &lt;code&gt;press&lt;&#x2F;code&gt; method.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;press&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggleState()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The reduction of code, again, is quite substantial. But, this small amount of code packs in a lot! There&#x27;s all kinds of stuff going on here, and we&#x27;re going to step through it all.&lt;&#x2F;p&gt;
&lt;p&gt;To start, we have to actually run async methods, and that means we need a &lt;code&gt;Task&lt;&#x2F;code&gt;. Recall that isolation inference has made this &lt;code&gt;press&lt;&#x2F;code&gt; method &lt;code&gt;@MainActor&lt;&#x2F;code&gt;. This, in turn, means that the &lt;code&gt;Task&lt;&#x2F;code&gt; body will inherit &lt;code&gt;@MainActor&lt;&#x2F;code&gt; too. This is why it is ok to assign to &lt;code&gt;self.state&lt;&#x2F;code&gt; here.&lt;&#x2F;p&gt;
&lt;p&gt;(If you don&#x27;t understand this yet, there are details in the &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;first post&lt;&#x2F;a&gt;. You can also go &lt;a href=&quot;&#x2F;isolation-intuition&quot;&gt;deeper&lt;&#x2F;a&gt; on both isolation inference and inheritance if you want.)&lt;&#x2F;p&gt;
&lt;p&gt;I like to call this out because it isn&#x27;t up the the programmer to remember, or even &lt;strong&gt;understand&lt;&#x2F;strong&gt; how or why &lt;code&gt;self.state&lt;&#x2F;code&gt; must be accessed on the main thread. This requirement is encoded into the type system, allowing the compiler to ensure it is happening. All this is in &lt;strong&gt;stark&lt;&#x2F;strong&gt; contrast to the dispatch version, which requires the developer to know they need the &lt;code&gt;DispatchQueue.main.async&lt;&#x2F;code&gt; for thread safety.&lt;&#x2F;p&gt;
&lt;p&gt;But there&#x27;s yet more subtly here. If you go back and check out the dispatch-based version, you can see that &lt;code&gt;press&lt;&#x2F;code&gt; makes a call into &lt;code&gt;system.toggleState&lt;&#x2F;code&gt; &lt;strong&gt;synchronously&lt;&#x2F;strong&gt;. The execution goes all the way from the UI directly into the &lt;code&gt;RemoteSystem&lt;&#x2F;code&gt; method all without leaving the main thread.&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s no longer the case here! We have now introduced a &lt;strong&gt;new&lt;&#x2F;strong&gt; asynchronous step. That &lt;code&gt;Task&lt;&#x2F;code&gt;, which establishes the async context we need, will not run immediately. It has to be scheduled on the main queue.&lt;&#x2F;p&gt;
&lt;p&gt;(There is a lot of subtly around &lt;code&gt;Task&lt;&#x2F;code&gt; creation and exeuction ordering. In the general case, though, you should not think about Task having FIFO sematics. Ths is a major difference between concurrency and dispatch.)&lt;&#x2F;p&gt;
&lt;p&gt;Those don&#x27;t really matter in this &lt;strong&gt;specific&lt;&#x2F;strong&gt; example, but can be a major change to the ordering of events. It is something you should keep in mind every time you introduce a &lt;code&gt;Task&lt;&#x2F;code&gt;. And doubly so if you do it as part of a migration from completion handlers to async&#x2F;await. This was one of the first &lt;a href=&quot;&#x2F;ordering-and-concurrency&quot;&gt;major problems&lt;&#x2F;a&gt; I encountered when starting to use Swift concurrency.&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;ll return to this idea, but migrating a system from completions handlers to async functions is not purely a change in syntax.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;adding-delays&quot;&gt;Adding delays&lt;&#x2F;h2&gt;
&lt;p&gt;Because we&#x27;re now starting this work asynchronously, we&#x27;ve actually &lt;strong&gt;increased&lt;&#x2F;strong&gt; the window of opportunity for our logical race. In that sense, it has definitely been made worse! But, I don&#x27;t think that&#x27;s really so bad. In fact, when faced with logical races (known or suspected), I sometimes do this kind of thing intentionally. Slowing down code can often expose latent bugs like this. Many races are just unlikely, possibly virtually impossible, given normal code execution.&lt;&#x2F;p&gt;
&lt;p&gt;Doing that here can also really help us develop some better intuition around how this stuff all works. Because async code, by design, looks really similar to synchronous code. And, in my opinion, &lt;strong&gt;that&#x27;s&lt;&#x2F;strong&gt; why it is more susceptible to logical races. They don&#x27;t (yet) stand out to us because it all looks so similar to synchronous code.&lt;&#x2F;p&gt;
&lt;p&gt;To add delays, first I&#x27;m just going to define a little helper function which will produce a random delay up to 1s.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;randomDelay&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; delayRange: Range&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-type z-swift&quot;&gt;UInt32&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;..&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1_000_000&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	usleep(delayRange&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;randomElement()&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You don&#x27;t have to be so fancy. Most of the time a simple &lt;code&gt;sleep(1)&lt;&#x2F;code&gt; can work. But, delaying for a second every time can really add up if you do it a lot. And, using completely uniform delays can sometimes fail to expose races, even when you know they are there.&lt;&#x2F;p&gt;
&lt;p&gt;(Details on &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;library&#x2F;archive&#x2F;documentation&#x2F;System&#x2F;Conceptual&#x2F;ManPages_iPhoneOS&#x2F;man3&#x2F;sleep.3.html&quot;&gt;sleep&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;library&#x2F;archive&#x2F;documentation&#x2F;System&#x2F;Conceptual&#x2F;ManPages_iPhoneOS&#x2F;man3&#x2F;usleep.3.html&quot;&gt;usleep&lt;&#x2F;a&gt; via manpages.)&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s the code with the delays inserted:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;press&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		randomDelay() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; start&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		randomDelay() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; enter&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggleState()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		randomDelay() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; complete&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		randomDelay() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; enter&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; value &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		randomDelay() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; complete&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; value
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There are a lot!&lt;&#x2F;p&gt;
&lt;p&gt;The first is the latency that a &lt;code&gt;Task&lt;&#x2F;code&gt; can experience before even beginning. This is inherit to pretty much all APIs like this, and something like a queue&#x27;s &lt;code&gt;async&lt;&#x2F;code&gt; method would experience as well. It&#x27;s really good to always keep this in mind.&lt;&#x2F;p&gt;
&lt;p&gt;Next, we have two pairs of delays, around our async calls. An async call &lt;strong&gt;may&lt;&#x2F;strong&gt; need some time to begin. It then will run, and require some time before completing.&lt;&#x2F;p&gt;
&lt;p&gt;Remember, these delays are not artificial. What we are doing here is really just &lt;strong&gt;magnifying&lt;&#x2F;strong&gt; all of the real delays in the execution to help us think about them and observe their effects.&lt;&#x2F;p&gt;
&lt;p&gt;(Understanding the details about when&#x2F;why&#x2F;how an &lt;code&gt;await&lt;&#x2F;code&gt; can actually suspend is complex. Thankfully, you rarely need to care. But I&#x27;d love to write more on this one day anyways.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;focusing-on-the-race&quot;&gt;Focusing on the race&lt;&#x2F;h2&gt;
&lt;p&gt;I hope I have now convinced you that there&#x27;s a lot of opportunity for this code to interleave. This is a very common problem for UIs in particular. Let&#x27;s look at some ways to fix it.&lt;&#x2F;p&gt;
&lt;p&gt;The core problem is it is possible for the user to invoke &lt;code&gt;press&lt;&#x2F;code&gt; more than once. If we add a little state to our UI, we can prevent that.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; ContentView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; inProgress &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;press&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; inProgress { &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;inProgress &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;true&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggleState()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;inProgress &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;All we&#x27;ve done here is add a simple guard. If the work has already started, do nothing. If not, mark it started, actually do the work, and then mark it complete.&lt;&#x2F;p&gt;
&lt;p&gt;Simple!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;critical-sections&quot;&gt;Critical sections&lt;&#x2F;h2&gt;
&lt;p&gt;I bet you have run into problems just like this before. Maybe you&#x27;ve disabled buttons or added spinners, but solutions usually look about the same. However I really want to highlight an important element here.&lt;&#x2F;p&gt;
&lt;p&gt;The check must be &lt;strong&gt;synchronous&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s an alternative, with the checks all inside the &lt;code&gt;Task&lt;&#x2F;code&gt;. I want you to really think for a second, though. Is there still a race here?&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;press&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; inProgress { &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;inProgress &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;true&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggleState()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;inProgress &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This &lt;code&gt;Task&lt;&#x2F;code&gt; body will always run on the main thread. This means that while more than one of these could potentially be &lt;strong&gt;started&lt;&#x2F;strong&gt;, only one can ever be executing the synchronous code within this closure.&lt;&#x2F;p&gt;
&lt;p&gt;We can argue over which approach is better, but this version is also race-free.&lt;&#x2F;p&gt;
&lt;p&gt;Now, let&#x27;s change our code slightly to illustrate what can go wrong when we &lt;strong&gt;don&#x27;t&lt;&#x2F;strong&gt; do this check synchronously.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;press&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; inProgress { &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;prepare()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;inProgress &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;true&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggleState()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;inProgress &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;ve just inserted a new async call here. But, you can now more clearly see the problem. We consult our state. We then &lt;strong&gt;incorrectly&lt;&#x2F;strong&gt; assume that state cannot change when we call &lt;code&gt;prepare()&lt;&#x2F;code&gt;, but it totally could!&lt;&#x2F;p&gt;
&lt;p&gt;One way to think about &lt;code&gt;await&lt;&#x2F;code&gt; is like a marker ending a &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Critical_section&quot;&gt;critical section&lt;&#x2F;a&gt;. We have to do any state accesses &lt;strong&gt;synchronously&lt;&#x2F;strong&gt;, before the task has any opportunity to suspend. This is &lt;strong&gt;vital&lt;&#x2F;strong&gt; for the correctness of many kinds of operations.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-about-actors&quot;&gt;What about actors?&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s look again at a part of our original, dispatch-based &lt;code&gt;RemoteSystem&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggleState&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;completionHandler: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		completionHandler()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We discussed this above. This method takes a completion handler, but it actually is &lt;strong&gt;synchronous&lt;&#x2F;strong&gt;. When called, this work will be added to the internal queue in a way that preserves calling order. That&#x27;s not the case with our actor! Despite being synchronous function, from the outside world, it can only ever be called asynchronously.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggleState&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await system&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggleState()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;As written, this implementation is &lt;strong&gt;incapable&lt;&#x2F;strong&gt; of capturing and retaining order in the same way. Whether this matters or not is hard to say, but I want to call it out. Async functions are &lt;strong&gt;not&lt;&#x2F;strong&gt; just syntactic sugar for completion handlers. They are close, but they have critical semantic differences - this is just &lt;a href=&quot;&#x2F;ordering-and-concurrency&quot;&gt;one of them&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Further, just like our UI issue above, actors can totally have similar problems internally. Let&#x27;s imagine a slightly more complex version of &lt;code&gt;toggleState&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;toggleState&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await initializeStateIfNeeded()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;toggle()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We&#x27;ve now got another logical race, because it could be possible for more than one caller to invoke &lt;code&gt;toggleState&lt;&#x2F;code&gt; simultaneously. Actors are not atomic, which could lead to &lt;code&gt;initializeStateIfNeeded&lt;&#x2F;code&gt; being called more than once.&lt;&#x2F;p&gt;
&lt;p&gt;Now, the &quot;ifNeeded&quot; naming here kind of suggests a solution. We totally can introduce a state variable, just like we did in our UI above, to help. But that only really works for very simple situations. This problem can easily get much more complex. Solutions can be quite involved without something like an async &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;Lock&quot;&gt;lock&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;&#x2F;h2&gt;
&lt;p&gt;At this point, I now find it easier to spot logical races with async&#x2F;await than I did with completion handlers. The nesting and non-linear code flow of callbacks has begun to feel quite confusing to me. That doesn&#x27;t mean callbacks don&#x27;t have uses! They can be quite powerful. But now that I have practice doing this with async code, it&#x27;s definitely my preference.&lt;&#x2F;p&gt;
&lt;p&gt;Of course, that practice took real time. It takes a while to really develop the sense of watching for and thinking carefully when you encounter an &lt;code&gt;await&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Oh, and if you find yourself struggling to manage logical races within an actor, you aren&#x27;t alone. Many people, myself included, have had problems here. There are async versions of a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;Lock&quot;&gt;lock&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;groue&#x2F;Semaphore&quot;&gt;semaphore&lt;&#x2F;a&gt; that I&#x27;ve all found useful. But, if you can keep things even simpler, that might be best. Step one when having problems with actors is to make sure you actually &lt;a href=&quot;&#x2F;actors&quot;&gt;need an actor&lt;&#x2F;a&gt; in the first place. Just remember though, that even single-threaded (&lt;code&gt;MainActor&lt;&#x2F;code&gt;-only) code can still run into logical races.&lt;&#x2F;p&gt;
&lt;p&gt;And you cannot un-async real network services, so a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;Queue&quot;&gt;queue&lt;&#x2F;a&gt; isn&#x27;t something we&#x27;ll ever be able to avoid. Thankfully, often an &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;asyncstream&quot;&gt;AsyncStream&lt;&#x2F;a&gt; can get the job done.&lt;&#x2F;p&gt;
&lt;p&gt;I suspect that many people want more depth on working with asynchronous state mutation. This really just scratched the surface. I get so many questions about SwiftData in particular, and I&#x27;ve never used it! But, I think we still covered a lot of important stuff! Being able to recognize logical races and think about managing state synchronously are both incredibly important, even if you aren&#x27;t using Swift concurrency.&lt;&#x2F;p&gt;
&lt;p&gt;And now I&#x27;ve done a &lt;a href=&quot;&#x2F;step-by-step-conforming-to-protocols&quot;&gt;forth entry&lt;&#x2F;a&gt; in the series!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Concurrency Step-by-Step: Reading from Storage</title>
        <published>2024-11-30T00:00:00+00:00</published>
        <updated>2024-11-30T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/step-by-step-reading-from-storage/"/>
        <id>https://massicotte.org/step-by-step-reading-from-storage/</id>
        
        <content type="html" xml:base="https://massicotte.org/step-by-step-reading-from-storage/">&lt;p&gt;Not too long ago, I was re-reading an &quot;introductory&quot; &lt;a href=&quot;&#x2F;intro-to-isolation&quot;&gt;post&lt;&#x2F;a&gt; I wrote. Honestly, I could barely make it though. I guess a big part was my own defintion of &quot;introduction&quot; when it comes to concurrency has been evolving. As I was reading, I kept imagining a true beginner doing the same thing. It&#x27;s embarrassing! I&#x27;m not going to remove it, but I don&#x27;t feel great about it.&lt;&#x2F;p&gt;
&lt;p&gt;I still do think it is absolutely vital that more effort be directed towards people getting started. More now than ever. All this inspired me to finally finish up this post, which has been in the works for a while now.&lt;&#x2F;p&gt;
&lt;p&gt;A theme that comes up over and over with Swift concurrency is trying to &quot;keep the compiler happy&quot;. You just want the stupid errors to go away. While trying to make that happen, you stumble across a number of things, like &lt;code&gt;Sendable&lt;&#x2F;code&gt; or &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;&lt;code&gt;@preconcurrency&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. You might even start changing &lt;code&gt;class&lt;&#x2F;code&gt; to &lt;code&gt;actor&lt;&#x2F;code&gt; and how different could that possibly be, it&#x27;s even the same number of characters. So you just start throwing syntax at the problem. This is understandable!&lt;&#x2F;p&gt;
&lt;p&gt;It can &lt;em&gt;sometimes&lt;&#x2F;em&gt; even work in the short term. But this path usually leads to frustration and anger. It will often produce extremely complex designs that just lead to yet more problems.&lt;&#x2F;p&gt;
&lt;p&gt;Welcome to the second installment of &quot;Swift Concurrency Step-by-Step&quot;. The purpose of these posts is to work through a common task to help build up a real understanding of what is going on. Last time, we looked at a &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;network request&lt;&#x2F;a&gt;. This time, we&#x27;re going to load a model from a data store.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;quick-notes&quot;&gt;Quick notes&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;I&#x27;m going to ignore error handling to keep things focused&lt;&#x2F;li&gt;
&lt;li&gt;I&#x27;m not very good at SwiftUI&lt;&#x2F;li&gt;
&lt;li&gt;This stuff &lt;strong&gt;requires&lt;&#x2F;strong&gt; Xcode 16 or later&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I had a really hard time dreaming up an example that would both be simple and also illustrate the problem. I think local storage will work well, but we&#x27;re going to have to keep it quite contrived. I don&#x27;t &lt;em&gt;think&lt;&#x2F;em&gt; this is going to really take away from any of the ideas. But I still want to highlight it because the idea of &quot;data store&quot; here isn&#x27;t going to look anything like SwiftData, CoreData, or other stuff a real app might use.&lt;&#x2F;p&gt;
&lt;p&gt;Also, this post builds on the topics discussed in the &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;last one&lt;&#x2F;a&gt;. Some of this stuff will be harder to follow if you don&#x27;t feel good about the content from there.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;putting-the-pieces-in-place&quot;&gt;Putting the pieces in place&lt;&#x2F;h2&gt;
&lt;p&gt;Ok, so let&#x27;s start by defining the interface to our storage system.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; DataModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; name
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I told you this was going to be contrived! There&#x27;s just a &lt;code&gt;DataModel&lt;&#x2F;code&gt; type to hold a simple value, along with a &lt;code&gt;Store&lt;&#x2F;code&gt; that &quot;fetches&quot; models for us. Neither do anything actually useful. But, it&#x27;s really just the types and their interfaces that we are concerned with.&lt;&#x2F;p&gt;
&lt;p&gt;Now we need a SwiftUI view to tie it all together.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; ContentView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; store &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Store()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;name&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;!&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await store&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;loadModel(named: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;These two bits of code should fit very comfortably on one single screen. Not bad!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;aside-type-system&quot;&gt;Aside: Type system&lt;&#x2F;h2&gt;
&lt;p&gt;I snuck in a little comment above that deserves more attention.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;But, it&#x27;s really just the types and their interfaces that we are concerned with.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;This is important, and kind of subtle! Swift concurrency is an extension of the type system. I say this over and over because it&#x27;s important to understand. It means we can just play around with our types, their APIs and structure, and the compiler will give us feedback about their concurrent behaviors. You can often get considerable amounts of work done without even needing to run the code! That gives you a really fast feedback loop.&lt;&#x2F;p&gt;
&lt;p&gt;The ability to iterate on a design&#x27;s runtime behavior this way is cool.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;great-except-it-doesn-t-work&quot;&gt;Great, except it doesn&#x27;t work&lt;&#x2F;h2&gt;
&lt;p&gt;This example code is nice and small, but it actually does not compile in Swift 6 mode. The problem is that single line in the &lt;code&gt;task&lt;&#x2F;code&gt; modifier.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; error: Non-sendable type &amp;#39;DataModel&amp;#39; returned by implicitly asynchronous call to nonisolated function cannot cross actor boundary&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await store&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;loadModel(named: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The error produced is ... well let&#x27;s just say that it&#x27;s &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift&#x2F;issues&#x2F;77048&quot;&gt;non-ideal&lt;&#x2F;a&gt;. But that&#x27;s ok because we&#x27;re going to learn so much figuring it out!&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s break it down into three parts.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Non-sendable type &#x27;DataModel&#x27; ...&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Ok, so this is referring to our &lt;code&gt;DataModel&lt;&#x2F;code&gt; type from above. It looks like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; DataModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It&#x27;s a class. Unlike structs, classes don&#x27;t conform to &lt;code&gt;Sendable&lt;&#x2F;code&gt; by default. And we haven&#x27;t added an explicit conformance. So, it makes sense the compiler is telling us that it is non-&lt;code&gt;Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Next!&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;... returned by implicitly asynchronous call to nonisolated function ...&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Oof. This is hard to decode. The clues we have here are &quot;&lt;strong&gt;returned by&lt;&#x2F;strong&gt; blah blah &lt;strong&gt;call to&lt;&#x2F;strong&gt; blah blah &lt;strong&gt;function&lt;&#x2F;strong&gt;&quot;. And we know what function is being invoked here. This is talking about our call to &lt;code&gt;Store.loadModel&lt;&#x2F;code&gt;. Let&#x27;s look at it more closely.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Right. This function is returning a &lt;code&gt;DataModel&lt;&#x2F;code&gt;, which we know does not conform to &lt;code&gt;Sendable&lt;&#x2F;code&gt;. But the compiler is telling us this call is &quot;implicitly asynchronous&quot; and that the function is &quot;nonisolated&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;First, I&#x27;m terribly sorry to say that the word &quot;implicitly&quot; here is a compiler bug. It was &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift&#x2F;issues&#x2F;74472&quot;&gt;fixed&lt;&#x2F;a&gt; quite a while ago, but that fix has not made it into a release yet. This is, ahem, an explicitly asynchronous call.&lt;&#x2F;p&gt;
&lt;p&gt;The critical bit is the compiler is telling us that the function is &quot;nonisolated&quot;. As we explored in the &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;previous post&lt;&#x2F;a&gt;, isolation comes from definitions. The &lt;code&gt;loadModel&lt;&#x2F;code&gt; function does not specify any isolation. And the &lt;code&gt;Store&lt;&#x2F;code&gt; type doesn&#x27;t either. No isolation is the default, and because we don&#x27;t see &lt;code&gt;@MainActor&lt;&#x2F;code&gt; or any other means of establishing isolation in these definition, that default applies.&lt;&#x2F;p&gt;
&lt;p&gt;Two down.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;... cannot cross actor boundary&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Hmmmm. Actor boundary? We did&#x27;t use &lt;code&gt;actor&lt;&#x2F;code&gt; anywhere here, and we don&#x27;t (yet!) know what a boundary even means.&lt;&#x2F;p&gt;
&lt;p&gt;What we do know is &lt;code&gt;Store.loadModel&lt;&#x2F;code&gt; is both async and non-isolated. Non-isolated + async means runs in the background. So what this function is actually doing is creating a &lt;code&gt;DataModel&lt;&#x2F;code&gt; instance &lt;strong&gt;in the background&lt;&#x2F;strong&gt; and then passing it back to the caller.&lt;&#x2F;p&gt;
&lt;p&gt;But our caller is the SwiftUI view. That view is not in the background, it is on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. There is a &quot;boundary&quot; between these two things to prevent unsafe accesses. Here&#x27;s that line again:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await store&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;loadModel(named: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Let&#x27;s re-write this compiler error:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Hey! You are trying to leave the MainActor, go get a DataModel in the background, and then pass it back to the MainActor. But the only types I&#x27;m allowed to pass into or out of actors (like the MainActor here) are Sendable types. If the returned instance continues to be accessed in the background it would be a data race!&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Oh.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;just-make-it-sendable&quot;&gt;Just make it Sendable&lt;&#x2F;h2&gt;
&lt;p&gt;Hopefully, this makes it clear &lt;em&gt;why&lt;&#x2F;em&gt; the compiler isn&#x27;t happy. And now it seems like there&#x27;s a really easy and obvious fix. Just make &lt;code&gt;DataModel&lt;&#x2F;code&gt; conform to &lt;code&gt;Sendable&lt;&#x2F;code&gt;!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;final&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; DataModel: Sendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Notice that to do this you also have to make the class &lt;code&gt;final&lt;&#x2F;code&gt;. &lt;code&gt;Sendable&lt;&#x2F;code&gt; classes cannot have subclasses. In this specific, contrived example, that was all it took. But, they also cannot have superclasses. They cannot contain mutable state. And any properties they do have must also be &lt;code&gt;Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;It turns out that when you want to make a class &lt;code&gt;Sendable&lt;&#x2F;code&gt;, it&#x27;s really only possible when that &quot;class&quot; is actually a struct. Structs, having value semantics, are much easier for the compiler (and humans...) to reason about. We &lt;em&gt;could&lt;&#x2F;em&gt; do that here, but only because our particular example is just incredibly simple. I&#x27;m going to leave it.&lt;&#x2F;p&gt;
&lt;p&gt;(There are some valid reasons for making &lt;code&gt;Sendable&lt;&#x2F;code&gt; classes, like sharing a single copy of a large immutable structure.)&lt;&#x2F;p&gt;
&lt;p&gt;Ok so we made this thing &lt;code&gt;Sendable&lt;&#x2F;code&gt; and we&#x27;re done right? Nope not done. Now there&#x27;s a &lt;strong&gt;different&lt;&#x2F;strong&gt; error.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; error: Sending &amp;#39;self.store&amp;#39; risks causing data races&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await store&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;loadModel(named: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Oh FFS, what &lt;strong&gt;now&lt;&#x2F;strong&gt;?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sending-self&quot;&gt;Sending self?&lt;&#x2F;h2&gt;
&lt;p&gt;This is a subtle issue. The clues we have to go on are word &quot;Sending&quot; and the reference to &lt;code&gt;self.store&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;We can see that &lt;code&gt;self.store&lt;&#x2F;code&gt; is an instance variable of our view. And because it is a member of a &lt;code&gt;MainActor&lt;&#x2F;code&gt; type (via that SwiftUI &lt;code&gt;View&lt;&#x2F;code&gt; conformance), it is also &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; This is @MainActor ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; ContentView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... so this is too&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; store &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Store()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now here&#x27;s where the subtly comes in. I&#x27;m going to add just a little bit of code and put these two things side by side to show what&#x27;s going on.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; the &amp;quot;store&amp;quot; here...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await store&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;loadModel(named: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... needs to end up as &amp;quot;self&amp;quot; here!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Ok, so think about what&#x27;s happening. We have the &lt;code&gt;store&lt;&#x2F;code&gt; instance, which is isolated to the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. To make this call to &lt;code&gt;loadModel&lt;&#x2F;code&gt;, we have to get to the background. And, because this is an instance method, that &lt;code&gt;store&lt;&#x2F;code&gt; variable needs to become &lt;code&gt;self&lt;&#x2F;code&gt; inside the method body.&lt;&#x2F;p&gt;
&lt;p&gt;The receiver of a method call is an implicit parameter!&lt;&#x2F;p&gt;
&lt;p&gt;So, the instance needs be &quot;sent&quot; from the &lt;code&gt;MainActor&lt;&#x2F;code&gt; into the background, which is an actor boundary. Does this sound familiar?&lt;&#x2F;p&gt;
&lt;p&gt;Only &lt;code&gt;Sendable&lt;&#x2F;code&gt; types can do that!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;aside-mainactor-means-sendable&quot;&gt;Aside: MainActor means Sendable&lt;&#x2F;h2&gt;
&lt;p&gt;Here&#x27;s something interesting that&#x27;s really important to know. You get an implicit &lt;code&gt;Sendable&lt;&#x2F;code&gt; conformance when you mark a type with &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;When I first learned this, it &lt;strong&gt;really&lt;&#x2F;strong&gt; surprised me!&lt;&#x2F;p&gt;
&lt;p&gt;Types that are isolated to a global actor give the compiler enough information to guarantee safe access no matter where it occurs. And that&#x27;s enough to satisfy the requirements of &lt;code&gt;Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s something I sometimes run into.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; This makes the type Sendable&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; SomeClass: Sendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The redundant &lt;code&gt;Sendable&lt;&#x2F;code&gt; isn&#x27;t &lt;strong&gt;wrong&lt;&#x2F;strong&gt;, but it should cause you to raise an eyebrow. Probably just left-over from experiments along the way, but something I usually call out.&lt;&#x2F;p&gt;
&lt;p&gt;You can go &lt;a href=&quot;&#x2F;non-sendable&quot;&gt;deeper&lt;&#x2F;a&gt; here if you want. Or you can just remember that &lt;code&gt;@MainActor&lt;&#x2F;code&gt; means &lt;code&gt;Sendable&lt;&#x2F;code&gt;. Ok.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;non-sendable-async-you-say&quot;&gt;Non-Sendable + async you say?&lt;&#x2F;h2&gt;
&lt;p&gt;(Here&#x27;s the code again, just for reference.)&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;When we talk about &quot;boundaries&quot; in this case we&#x27;re talking about the transitions between the &lt;code&gt;MainActor&lt;&#x2F;code&gt; and the background. There&#x27;s one making the call, and then there&#x27;s a second when we return. The compiler requires that all the stuff that crosses boundaries be &lt;code&gt;Sendable&lt;&#x2F;code&gt;. This is why non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types that have async methods, or participate in concurrency at all, should always raise alarm bells. They are very hard to use!&lt;&#x2F;p&gt;
&lt;p&gt;Hard does not mean &lt;a href=&quot;&#x2F;non-sendable&quot;&gt;impossible&lt;&#x2F;a&gt;, though. And in fact they can be quite powerful. But they are very advanced, and it is &lt;strong&gt;extremely&lt;&#x2F;strong&gt; common for people to introduce them into their code without realizing the implications.&lt;&#x2F;p&gt;
&lt;p&gt;There is a very strong correlation between people having trouble with Swift concurrency and falling into this trap.&lt;&#x2F;p&gt;
&lt;p&gt;(Not that I blame them. The language should not have traps like this! It won&#x27;t come for free, but thankfully the Swift team is &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;pitch-inherit-isolation-by-default-for-async-functions&#x2F;74862&quot;&gt;working&lt;&#x2F;a&gt; on changing the semantics of the language to address this.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;thinking-is-now-unfortunately-required&quot;&gt;Thinking is now, unfortunately, required&lt;&#x2F;h2&gt;
&lt;p&gt;As soon as you have to cross one of these boundaries, by moving values into or out of an actor, it requires some thought. &lt;strong&gt;All&lt;&#x2F;strong&gt; the types that are involved now have to become &lt;code&gt;Sendable&lt;&#x2F;code&gt;. That constraint can range from no big deal to complete showstopper.&lt;&#x2F;p&gt;
&lt;p&gt;Astute readers of the first post will note that I exploited this to keep the content simpler. There were boundary crossings all over the place, but all the types were &lt;code&gt;Sendable&lt;&#x2F;code&gt; and everything just worked. This wasn&#x27;t (entirely) contrived either - it actually does happen in practice. The app we made did a real, if ridiculous, thing! How often that actually happens is largely a function of how much immutable data you are working with.&lt;&#x2F;p&gt;
&lt;p&gt;Now speaking of thinking, let&#x27;s now figure out what to do here.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;just-remove-the-boundaries&quot;&gt;Just remove the boundaries&lt;&#x2F;h2&gt;
&lt;p&gt;If you cannot make the values &lt;code&gt;Sendable&lt;&#x2F;code&gt;, the simplest solution here is to just stop crossing boundaries in the first place. But how?&lt;&#x2F;p&gt;
&lt;p&gt;Well, we know that we&#x27;re going from &lt;code&gt;MainActor&lt;&#x2F;code&gt; -&amp;gt; background on call, and then we&#x27;re going background -&amp;gt; &lt;code&gt;MainActor&lt;&#x2F;code&gt; on return. Let&#x27;s just stop going to the background.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; &amp;lt;- apply isolation!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;By isolating &lt;code&gt;Store&lt;&#x2F;code&gt;, all our problems go away. It no longer &lt;strong&gt;matters&lt;&#x2F;strong&gt; that &lt;code&gt;DataModel&lt;&#x2F;code&gt; isn&#x27;t &lt;code&gt;Sendable&lt;&#x2F;code&gt;, because it doesn&#x27;t have any boundaries to cross. Our &lt;code&gt;Store&lt;&#x2F;code&gt; type also now becomes &lt;code&gt;Sendable&lt;&#x2F;code&gt;, so it makes it much easier to use with other concurrency constructs.&lt;&#x2F;p&gt;
&lt;p&gt;Of course, this comes with a pretty big trade-off. We&#x27;re now forced to do any work involving the creation of this &lt;code&gt;DataModel&lt;&#x2F;code&gt; instance on the main thread. And that could be a problem.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;split-isolation&quot;&gt;&quot;Split isolation&quot;&lt;&#x2F;h2&gt;
&lt;p&gt;Before we get into all that, there&#x27;s an alternative, similar solution I want to highlight.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; &amp;lt;- apply isolation to just the method&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Instead of isolating the entire type, we just apply it only to the async function. This works! However, this pattern is incredibly problematic. I encounter this so often, and it causes so many problems that I gave it a name: &quot;split isolation&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;To understand why this is a problem, think about just this method. We know that &lt;code&gt;self&lt;&#x2F;code&gt; needs to move from the call site into &lt;code&gt;loadModel&lt;&#x2F;code&gt;. But, note that &lt;code&gt;Store&lt;&#x2F;code&gt; is &lt;strong&gt;not&lt;&#x2F;strong&gt; &lt;code&gt;Sendable&lt;&#x2F;code&gt;. This means that in order to call this method on an instance, the instance has to &lt;strong&gt;already be&lt;&#x2F;strong&gt; on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;! And because it isn&#x27;t &lt;code&gt;Sendable&lt;&#x2F;code&gt;, participating in concurrency in any methods with different isolation are going to be really hard&#x2F;impossible.&lt;&#x2F;p&gt;
&lt;p&gt;You&#x27;ve got this one single instance, but only some parts can be used when off the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. It has been &quot;split&quot; between &lt;code&gt;MainActor&lt;&#x2F;code&gt; and non-isolated. I dunno, if you come up with a better name let me know.&lt;&#x2F;p&gt;
&lt;p&gt;Again, there &lt;strong&gt;are&lt;&#x2F;strong&gt; valid uses for this pattern. But, if you cannot articulate exactly &lt;strong&gt;why&lt;&#x2F;strong&gt; you are doing it and how you&#x27;ll deal with the implications, you shouldn&#x27;t be doing it. If you are going to use &lt;code&gt;@MainActor&lt;&#x2F;code&gt;, apply it to the whole type.&lt;&#x2F;p&gt;
&lt;p&gt;Just had to get that out of the way. Onward.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;value-types&quot;&gt;Value types&lt;&#x2F;h2&gt;
&lt;p&gt;Ok ok, but what if you just want to do some work in the background? Forget possible, shouldn&#x27;t that be &lt;strong&gt;easy&lt;&#x2F;strong&gt;?&lt;&#x2F;p&gt;
&lt;p&gt;We saw above that making a class &lt;code&gt;Sendable&lt;&#x2F;code&gt; is nearly equivalent to making it a struct. Working with value types gives us a lot of options. Let&#x27;s do that now.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; DataModel {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; name
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; data &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;readModelDataFromDisk(named: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;decodeModel(data)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; model
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;readModelDataFromDisk&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Data &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; hit the disk in the background&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;decodeModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ data: Data&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; process the raw data in the background&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;When it comes to offloading work to other threads, the details will always matter. But here, I&#x27;ve just made up two plausible processing steps.&lt;&#x2F;p&gt;
&lt;p&gt;Both are non-isolated async functions, and that means they run in the background. Because they are non-isolated, they cannot access the&lt;code&gt; MainActor&lt;&#x2F;code&gt; members of &lt;code&gt;Store&lt;&#x2F;code&gt; synchronously, but that could be fine! These could be just plain old, stateless functions. They take immutable input and produce immutable output.&lt;&#x2F;p&gt;
&lt;p&gt;This often works out really well. It can be an excellent solution to a classic load-and-decode like this. It&#x27;s an extremely common pattern - it came up in the previous post too. I think this should &lt;strong&gt;always&lt;&#x2F;strong&gt; be what you reach for first.&lt;&#x2F;p&gt;
&lt;p&gt;Unfortunately, real systems may not be so easy to get into this pure &lt;code&gt;Sendable&lt;&#x2F;code&gt;-in, &lt;code&gt;Sendable&lt;&#x2F;code&gt;-out shape. And that&#x27;s when you have to start looking at alternatives.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;swift-5-module&quot;&gt;Swift 5 module&lt;&#x2F;h2&gt;
&lt;p&gt;A setup that you might like is a companion Swift 5 module &lt;strong&gt;without&lt;&#x2F;strong&gt; warnings enabled. It&#x27;s just a nice place to stash stuff that you can&#x27;t or don&#x27;t want to get working in 6 mode. It&#x27;s also a great option when interfacing with existing systems. Modularity is one of the keys to a successful Swift 6 migration.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;, completionHandler: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; (DataModel&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		someQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; expensive work goes here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;main&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				completionHandler(model)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The whole reason for doing this is to get a non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; type from the background to the main thread. I&#x27;ve annotated the API with &lt;code&gt;@MainActor&lt;&#x2F;code&gt; so it will look to callers like there&#x27;s no boundary at all. Done.&lt;&#x2F;p&gt;
&lt;p&gt;Perhaps surprisingly, this code actually compiles &lt;strong&gt;without error&lt;&#x2F;strong&gt; in Swift 6 mode. There is a lot going on internally to make this possible. But, what you really need to know is the compiler understands that &lt;code&gt;model&lt;&#x2F;code&gt; can safely move from the background to main &lt;strong&gt;in this specific case&lt;&#x2F;strong&gt;. It can only determine this because a) this is all happening within one function and b) this example is simple. But it&#x27;s still pretty interesting to know that stuff like this is possible.&lt;&#x2F;p&gt;
&lt;p&gt;(The system that does this analysis is called &quot;region-based isolation&quot;, and I&#x27;ve &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;written&lt;&#x2F;a&gt; about it.)&lt;&#x2F;p&gt;
&lt;p&gt;My own preference is to make a clear distinction between APIs that are &lt;strong&gt;using&lt;&#x2F;strong&gt; concurrency and those built to work around a problem. I don&#x27;t think you should write &lt;code&gt;async&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;await&lt;&#x2F;code&gt; in modules that have concurrency warnings disabled. If you want to make an async wrapper around this function, you should do that in an extension within a module that has the warnings on.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-sending-keyword&quot;&gt;The &lt;code&gt;sending&lt;&#x2F;code&gt; keyword&lt;&#x2F;h2&gt;
&lt;p&gt;Way back, I re-wrote the compiler error message, and ended with this:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;If the returned instance continues to be accessed in the background it would be a data race!&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Note the &lt;strong&gt;if&lt;&#x2F;strong&gt;. This is true, but we &lt;strong&gt;don&#x27;t&lt;&#x2F;strong&gt; actually continue to access it. This warning we are trying to work around is actually a false-positive.&lt;&#x2F;p&gt;
&lt;p&gt;The thing is, it is a false-positive &lt;strong&gt;right now&lt;&#x2F;strong&gt;. But that&#x27;s really a function of our implementation. We could make tiny changes that could render this unsafe very easily.&lt;&#x2F;p&gt;
&lt;p&gt;Swift 6 recognizes how much of a pain this can be though, and introduced a new feature to help. The &lt;code&gt;sending&lt;&#x2F;code&gt; keyword allows us to encode this promise of safety into our API. We can use it to express this idea that we are producing a new, independent value and just passing over to the caller. Here&#x27;s the idea.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;final&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We&#x27;ve done two things. First, we&#x27;ve removed the &lt;code&gt;MainActor&lt;&#x2F;code&gt;-ness with the &lt;code&gt;nonisolated&lt;&#x2F;code&gt; keyword, which gets us onto the background. The type is still &lt;code&gt;Sendable&lt;&#x2F;code&gt;, because it remains &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated.&lt;&#x2F;p&gt;
&lt;p&gt;But the interesting bit is that &lt;code&gt;sending&lt;&#x2F;code&gt; keyword applied to the return value. What &lt;code&gt;sending&lt;&#x2F;code&gt; does is make a trade. It accepts a constraint with the function body, but in exchange, it relaxes constraints at call sites.&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;re guaranteeing that our API will always provide an instance of &lt;code&gt;DataModel&lt;&#x2F;code&gt; that can safely be returned. It&#x27;s kinda like &lt;code&gt;Sendable&lt;&#x2F;code&gt;, but instead of applying to the whole type, its just this one spot. To make that work, the compiler needs to prove &lt;code&gt;loadModel&lt;&#x2F;code&gt; actually provides that guarantee.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;sending&lt;&#x2F;code&gt; isn&#x27;t magic. There are situations where it just won&#x27;t work, even when it seems like it should. And I have found those difficult to debug. But regardless, it is a very powerful tool!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actors&quot;&gt;Actors&lt;&#x2F;h2&gt;
&lt;p&gt;So far, we&#x27;ve only ever talked about &lt;code&gt;MainActor&lt;&#x2F;code&gt;, or &quot;the background&quot;. But you can make your own actors too! This gives you a way to define a new little corner of isolation.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor Store {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadModel&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;named name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending DataModel &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		DataModel(name: name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We do still need the &lt;code&gt;sending&lt;&#x2F;code&gt; here, because &lt;code&gt;DataModel&lt;&#x2F;code&gt; still has to move from this actor&#x27;s isolation to the outside world. But this does look simpler. We also no longer need a non-isolated method to get off the main thread. And, because the method is isolated, all this actor&#x27;s properties are synchronously accesible within its body. So far, this seems great!&lt;&#x2F;p&gt;
&lt;p&gt;Well, the thing is actors come with 2.5 problems.&lt;&#x2F;p&gt;
&lt;p&gt;The first is their interface is &lt;strong&gt;strictly&lt;&#x2F;strong&gt; asynchronous. A &lt;code&gt;MainActor&lt;&#x2F;code&gt; version of &lt;code&gt;Store&lt;&#x2F;code&gt; could be accessed synchronously if needed, but this actor version cannot. This can be a killer, especially for an existing system. You should always be paying &lt;strong&gt;extremely&lt;&#x2F;strong&gt; close attention to where you need synchronous access to data when working with Swift concurrency.&lt;&#x2F;p&gt;
&lt;p&gt;The second is the isolation that an actor provides is a double-edged sword. Every single input and output to an actor now needs to cross a boundary. This can be a huge problem. In general, when you add an actor to a system, you are &lt;strong&gt;increasing&lt;&#x2F;strong&gt; the need for yet more &lt;code&gt;Sendable&lt;&#x2F;code&gt; types. More actors means more boundaries.&lt;&#x2F;p&gt;
&lt;p&gt;The last half-a-problem is that actors are more likely to encounter reentrancy issues. The reason I count this as a half  is reentrancy can be an problem even with a purely &lt;code&gt;MainActor&lt;&#x2F;code&gt; system. In fact, it isn&#x27;t even unique to Swift concurrency - this problem can and does happen with GCD too.&lt;&#x2F;p&gt;
&lt;p&gt;Reentrancy is too big a topic to cover here as well, but I want to at least put it into your head. Actors are not the first thing you should look to. In fact, I think they are extremely over-used!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-end&quot;&gt;The end...&lt;&#x2F;h2&gt;
&lt;p&gt;Would you believe that I actually removed a bunch of content from this before posting? I originally had some stuff in here about using the various unsafe opt out tools the language provides. But, re-reading, I decided that&#x27;s just something for another day. Things like &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt; and &lt;code&gt;nonisolated(unsafe)&lt;&#x2F;code&gt; exist for a reason, and let you do basically anything you want. But they have more &lt;a href=&quot;https:&#x2F;&#x2F;jaredsinclair.com&#x2F;2024&#x2F;11&#x2F;12&#x2F;beware-unchecked.html&quot;&gt;downsides&lt;&#x2F;a&gt; than you might think!&lt;&#x2F;p&gt;
&lt;p&gt;I also &lt;strong&gt;really&lt;&#x2F;strong&gt; hesitated to introduce &lt;code&gt;sending&lt;&#x2F;code&gt; and actors in this post. But, ultimately I decided it made sense, because they are real, useful tools. But they should &lt;strong&gt;both&lt;&#x2F;strong&gt; should give you pause. They encourage yet more concurrency. More concurrency means more complexity. And I am, firmly, of the opinion that you should introduce complexity like this only when the trade-off can be &lt;strong&gt;justified&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;If you can pull off what you need using some value types and a few non-isolated functions here and there, you should. It&#x27;s just so much simpler. Unfortunately, you will encounter situations where these won&#x27;t cut it. That&#x27;s what the other options are for.&lt;&#x2F;p&gt;
&lt;p&gt;And now there&#x27;s a &lt;a href=&quot;&#x2F;step-by-step-stateful-systems&quot;&gt;third installment&lt;&#x2F;a&gt; if you&#x27;ve been enjoying these!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Problematic Swift Concurrency Patterns</title>
        <published>2024-10-29T00:00:00+00:00</published>
        <updated>2024-10-29T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/problematic-patterns/"/>
        <id>https://massicotte.org/problematic-patterns/</id>
        
        <content type="html" xml:base="https://massicotte.org/problematic-patterns/">&lt;p&gt;Recently, someone asked me about best practices when using Swift concurrency. I have mixed feelings about the concept of a &quot;best practice&quot;. I&#x27;ll get to that in a bit. But, in this case, I said that the technology is still very young and we&#x27;re all still figuring it out.&lt;&#x2F;p&gt;
&lt;p&gt;But, I then went on to say that I have now come across a number of techniques that often &lt;strong&gt;don&#x27;t&lt;&#x2F;strong&gt; work out. This does not mean bad! It just means that I see them a fair bit, and they often end up being a problem. I thought it could be useful to collect and share what I&#x27;ve seen.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;split-isolation&quot;&gt;&quot;Split Isolation&quot;&lt;&#x2F;h2&gt;
&lt;p&gt;This is a term I&#x27;ve come up with for a type that uses more than one isolation domain internally.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; SomeClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; non-isolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; value: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A type like this is problematic, because half of it is non-isolated, and half is &lt;code&gt;MainActor&lt;&#x2F;code&gt;-only. But, that&#x27;s really weird! Because this type isn&#x27;t &lt;code&gt;Sendable&lt;&#x2F;code&gt;, if you were to ever create one off of the &lt;code&gt;MainActor&lt;&#x2F;code&gt;, it could never be later moved back to the &lt;code&gt;MainActor&lt;&#x2F;code&gt;, making &lt;code&gt;value&lt;&#x2F;code&gt; inaccessible.&lt;&#x2F;p&gt;
&lt;p&gt;There &lt;strong&gt;might&lt;&#x2F;strong&gt; be advanced&#x2F;clever usages of such a type. But I think the vast majority of the time, a global actor should be applied to the type as a whole, not to individual properties.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;task-detached&quot;&gt;&lt;code&gt;Task.detached&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;I see &lt;code&gt;Task.detached&lt;&#x2F;code&gt; all over the place. And this makes sense, because it is a very convenient way to get stuff off the &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;doSomeStuff() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	Task&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;detached {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		expensiveWork()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This &lt;strong&gt;does&lt;&#x2F;strong&gt; work! It also looks really similar to &lt;code&gt;DispatchQueue.global().async&lt;&#x2F;code&gt;, so it feels familiar. But, while &lt;code&gt;detached&lt;&#x2F;code&gt; does prevent isolation inheritance, it &lt;strong&gt;also&lt;&#x2F;strong&gt; does other stuff too. Detached tasks do not inherit priority or task-local values.&lt;&#x2F;p&gt;
&lt;p&gt;Instead, think about a &lt;code&gt;nonisolated&lt;&#x2F;code&gt; function. This is very explicit, not subject to side-effects, and makes it impossible to accidentally forget to remove the actor isolation at all call sites.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;doSomeStuff() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		await expensiveWork()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;expensiveWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I wrote up a &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;whole thing&lt;&#x2F;a&gt; that goes into more detail about this kind of stuff, in case you want to check that out too.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;explicit-priorities&quot;&gt;Explicit Priorities&lt;&#x2F;h2&gt;
&lt;p&gt;I see people using explicit priorities all the time. It&#x27;s not inherently wrong to do this, but it&#x27;s really complicated! Priorities can have effects on timing and performance. The system is quite good about preventing it, but it&#x27;s also easy to accidentally introduce priority inversions.&lt;&#x2F;p&gt;
&lt;p&gt;I think you should &lt;strong&gt;always&lt;&#x2F;strong&gt; include a comment explaining why the default won&#x27;t work.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Explain yourself here clearly! Are you sure?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task(priority: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;background) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await someNonCriticalWork()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;mainactor-run&quot;&gt;&lt;code&gt;MainActor.run&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;ve gone into quite a bit of &lt;a href=&quot;&#x2F;dynamic-isolation&quot;&gt;detail&lt;&#x2F;a&gt; about this one in the past. I think &lt;code&gt;MainActor.run&lt;&#x2F;code&gt; is rarely the right solution. Swift concurrency gives you tools to make sure that APIs cannot be used wrong. You should use them! They can keep your code simpler and prevent mistakes.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; why do this...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;run {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	doMainActorStuff()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... when this will usually work?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await doMainActorStuff()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;stateless-actors&quot;&gt;Stateless Actors&lt;&#x2F;h2&gt;
&lt;p&gt;The purpose of an actor is to protect mutable state. That&#x27;s what actors do. Yet, I regularly run into actors that have no instance properties. This means they have no state to protect! Usually, this is because you just want to get work off the main thread. And if that is the case, look into a non-isolated async function.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;preconcurrency-import-with-async-extensions&quot;&gt;&lt;code&gt;@preconcurrency import&lt;&#x2F;code&gt; with Async Extensions&lt;&#x2F;h2&gt;
&lt;p&gt;You&#x27;ve got some type you do not control, and it uses completion handler-based APIs. You want to wrap that up with async methods, but that introduces warnings. So, you add a &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;&lt;code&gt;@preconcurrency import&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; to silence the warnings.&lt;&#x2F;p&gt;
&lt;p&gt;Moving from completion handlers to async methods can change semantics and cause code to run on background threads. Be &lt;strong&gt;really&lt;&#x2F;strong&gt; careful here!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;redundant-sendable-conformances&quot;&gt;Redundant &lt;code&gt;Sendable&lt;&#x2F;code&gt; Conformances&lt;&#x2F;h2&gt;
&lt;p&gt;I frequently see types that look like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; SomeClass: Sendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is strange, because global actor isolated types &lt;strong&gt;are&lt;&#x2F;strong&gt; &lt;code&gt;Sendable&lt;&#x2F;code&gt;. Now, it isn&#x27;t wrong to have the redundant &lt;code&gt;Sendable&lt;&#x2F;code&gt; conformance. But, I think it can be a sign of confusion&#x2F;misunderstanding.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;mainactor-sendable-closures&quot;&gt;&lt;code&gt;@MainActor @Sendable&lt;&#x2F;code&gt; closures&lt;&#x2F;h2&gt;
&lt;p&gt;Here&#x27;s a type you can run into a lot. It&#x27;s a function that will run on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;, but also needs to be itself &lt;code&gt;Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; () &lt;span class=&quot;z-keyword z-operator z-custom z-binary z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Except, there was a &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;change&lt;&#x2F;a&gt; in Swift 6. &lt;code&gt;@MainActor&lt;&#x2F;code&gt; closures are now &lt;code&gt;Sendable&lt;&#x2F;code&gt;, just like all other global actor isolated types. The combination of &lt;code&gt;@MainActor&lt;&#x2F;code&gt; and &lt;code&gt;@Sendable&lt;&#x2F;code&gt; is still required for Swift 5&#x2F;Xcode 15 compatibility. But, a plain &lt;code&gt;@MainActor () -&amp;gt; Void&lt;&#x2F;code&gt; might be all you need and is much less restrictive.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;runloop-apis&quot;&gt;RunLoop APIs&lt;&#x2F;h2&gt;
&lt;p&gt;There are still quite a few systems out there that must be used with &lt;code&gt;NS&#x2F;CFRunLoops&lt;&#x2F;code&gt;, like &lt;code&gt;NSTimer&lt;&#x2F;code&gt; and JavaScriptCore. These will not work correctly with non-&lt;code&gt;MainActor&lt;&#x2F;code&gt; concurrency contexts. Typically, you can find a way to make these things work using the main thread.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actors-protocol-with-synchronous-methods&quot;&gt;Actors + Protocol With Synchronous Methods&lt;&#x2F;h2&gt;
&lt;p&gt;Actors are, by their nature, asynchronous. You cannot run synchronous methods on an actor outside of the actor itself. Because of this, making an actor conform to a protocol that has synchronous methods is usually going to be a problem. There are times when you can pull it off, but you&#x27;ll want to think hard about whether it makes sense. In many scenarios like this, an actor is just the wrong choice.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;using-obj-c-async-translations&quot;&gt;Using Obj-C-&amp;gt;Async Translations&lt;&#x2F;h2&gt;
&lt;p&gt;The compiler will automatically generate async versions of Objective-C completion handler-based methods. The bad news is, unless the type itself is &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated or &lt;code&gt;Sendable&lt;&#x2F;code&gt;, these translations will be problematic. They won&#x27;t be possible to use diagnostic-free without a &lt;code&gt;@preconcurrency import&lt;&#x2F;code&gt; and will have different semantics that could make them unsafe.&lt;&#x2F;p&gt;
&lt;p&gt;I would stay away unless you are 100% sure the translation makes sense. And if you cannot see the implementation, that could be impossible to determine.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;blocking-for-async-work&quot;&gt;Blocking for Async Work&lt;&#x2F;h2&gt;
&lt;p&gt;Don&#x27;t use &lt;code&gt;DispatchSemaphore&lt;&#x2F;code&gt; or &lt;code&gt;DispatchGroup&lt;&#x2F;code&gt; to wait on async work. It could be very rare, but you are eventually going to deadlock.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;too-much-code-in-closures&quot;&gt;Too Much Code in Closures&lt;&#x2F;h2&gt;
&lt;p&gt;It can be extremely hard to understand the compiler&#x27;s concurrency diagnostics. And, because there&#x27;s now &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;code flow analysis&lt;&#x2F;a&gt; happening, reasoning about how or why a diagnostic is being presented can be even more difficult. Keeping the amount of code inside of closures under control can really help narrow down problems.&lt;&#x2F;p&gt;
&lt;p&gt;I also find this really helpful for readability. Win win.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;unstructured-when-structured-would-work&quot;&gt;Unstructured When Structured Would Work&lt;&#x2F;h2&gt;
&lt;p&gt;Sometimes, you just need to create a new &lt;code&gt;Task&lt;&#x2F;code&gt;, and that&#x27;s fine. But, if you can avoid it, you should. Sticking with structured concurrency is usually simpler, allows some automatic cancellation support, and encourages you to define your isolation requirements statically.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;avoiding-non-sendable-types&quot;&gt;Avoiding non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; Types&lt;&#x2F;h2&gt;
&lt;p&gt;You can build some pretty useful things with &lt;a href=&quot;&#x2F;non-sendable&quot;&gt;non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types&lt;&#x2F;a&gt;. If they need to participate in concurrency, you may need to make use of isolated parameters, but with a little practice you can get those down.&lt;&#x2F;p&gt;
&lt;p&gt;I want to stress that again, but in a different way. If you are adding async methods to non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types and you are &lt;strong&gt;not&lt;&#x2F;strong&gt; using isolated parameters, things probably aren&#x27;t working as you intend. And, you also probably have warnings off because this arrangement almost never works and the compiler will catch it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;other-areas&quot;&gt;Other Areas&lt;&#x2F;h2&gt;
&lt;p&gt;I didn&#x27;t come up with this list all by myself. I asked for ideas, and a few things were suggested by others. There were two things that came up a lot, neither of which I feel I can help with that much.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;testing&quot;&gt;Testing&lt;&#x2F;h3&gt;
&lt;p&gt;Testing code that uses concurrency can be very tricky in some situations. Particularly if you need to start operations that have asynchronous side effects that you cannot directly wait for.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;hasAsyncSideEffects&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; these effects are hard to test&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;m sure this isn&#x27;t the only difficult case either. I don&#x27;t have any great suggestions here. But, there is a post over at &lt;a href=&quot;https:&#x2F;&#x2F;www.pointfree.co&#x2F;blog&#x2F;posts&#x2F;110-reliably-testing-async-code-in-swift&quot;&gt;pointfree&lt;&#x2F;a&gt; with some interesting options.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;d be very interested in hearing from you if you have ideas&#x2F;experience here!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;adopting-asyncsequence&quot;&gt;Adopting AsyncSequence&lt;&#x2F;h3&gt;
&lt;p&gt;By a wide margin, the most common thing I hear from people is around adopting &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt;. This deserves a dedicated post (or three), but I&#x27;m kind of a beginner when it comes to reactive programming so this stuff is hard for me.&lt;&#x2F;p&gt;
&lt;p&gt;By no means is using &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt; inherently problematic. I have used it successfully, and I have seen many others do so as well. But what I can say for sure is if you are having trouble, you aren&#x27;t alone.&lt;&#x2F;p&gt;
&lt;p&gt;Please point me to resources that have helped you! Or to specific stuff that has not worked!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;best-practice&quot;&gt;&quot;Best&quot; practice&lt;&#x2F;h2&gt;
&lt;p&gt;It&#x27;s useful to know about things that work well. All those pitfalls, edge cases, and details can take a lot of time and pain to discover. But, I also think there can be real danger in blindly following instructions, especially if they come from a trusted source. This can prevent you from trying new things. And new things are how we find then next, more best pratice. Or why that best is actually only ok.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve seen the stuff here work out badly. But, that does not mean you should not use your own judgement. Please keep trying things! And when you do, tell me about how it worked out.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>So how does this whole @preconcurrency thing work?</title>
        <published>2024-10-14T00:00:00+00:00</published>
        <updated>2024-10-14T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/preconcurrency/"/>
        <id>https://massicotte.org/preconcurrency/</id>
        
        <content type="html" xml:base="https://massicotte.org/preconcurrency/">&lt;p&gt;I consistently find the &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; attribute to be confusing. But, I&#x27;m tired of that. Let&#x27;s just, once and for all, get a better handle how to use this thing.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;one-attribute-many-purposes&quot;&gt;One Attribute, Many Purposes&lt;&#x2F;h2&gt;
&lt;p&gt;Remember, Swift concurrency is all about the type system. This means that &lt;strong&gt;definitions&lt;&#x2F;strong&gt; are hugely important to how things function. The &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; attribute alters how definitions are interpreted by the compiler. In general, it relaxes some rules that might otherwise make a definition difficult or even impossible to use.&lt;&#x2F;p&gt;
&lt;p&gt;It has &lt;strong&gt;three&lt;&#x2F;strong&gt; distinct uses. And while they all apply to definitions, the details are quite different. We&#x27;ll cover them all, in increasing order of complexity.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;preconcurrency-conformance&quot;&gt;Preconcurrency Conformance&lt;&#x2F;h2&gt;
&lt;p&gt;This is actually a new feature of Swift 6, introduced with &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423&lt;&#x2F;a&gt;. The whole idea with this one is to provide a simple and safe way to deal with protocol-isolation mismatches. It tells the compiler yes, actually, my isolated type can conform to this non-isolated protocol. It was introduced to help out with protocols that are not &lt;strong&gt;yet&lt;&#x2F;strong&gt; marked with a global actor, but should be.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;isolation-mis-matches&quot;&gt;Isolation Mis-Matches&lt;&#x2F;h3&gt;
&lt;p&gt;Here&#x27;s the traditional approach:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Defined in some other module&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; ViewDelegateProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;respondToUIEvent&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyViewController: ViewDelegateProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; step 1, remove the isolation that mis-matches&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;respondToUIEvent&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; step 2, put it back&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assumeIsolated {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This technique still works. And there are times when it remains useful. But, there&#x27;s just so much boilerplate. And the non-isolated methods end up exposing an API for your type that&#x27;s very easy to use incorrectly. Contrast all that with one single attribute that gives you a very concise and safer option.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyViewController: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;preconcurrency&lt;&#x2F;span&gt; ViewDelegateProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;respondToUIEvent&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; no need for any of that&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; nonisolated&#x2F;assumeIsolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Much nicer!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;intentionally-non-isolated-protocols&quot;&gt;Intentionally Non-isolated Protocols&lt;&#x2F;h3&gt;
&lt;p&gt;Interestingly, the preconcurrency conformance has another use! It is also handy to conform to a protocol that doesn&#x27;t need to be isolated. That is, they are intentionally non-isolated. An example is &lt;code&gt;NSTextStorageDelegate&lt;&#x2F;code&gt;. This protocol can be used on any thread&#x2F;isolation&#x2F;queue&#x2F;whatever, as long as you keep it there. This is more or less the same situation as a mis-match, and is just as tricky when used with isolated types.&lt;&#x2F;p&gt;
&lt;p&gt;But, you can use a preconcurrency conformance to make it work.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyViewController: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;preconcurrency&lt;&#x2F;span&gt; NSTextStorageDelegate {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;textStorage&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ textStorage: NSTextStorage,
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		didProcessEditing editedMask: NSTextStorage&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;EditActions,
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		range editedRange: NSRange,
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		changeInLength delta: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;m the first to admit: this is weird. There&#x27;s nothing &quot;pre-concurrency&quot; about this, so it&#x27;s a bit of a hack. But, it works well here because as far as the compiler is concerned these two situations are functionally equivalent.&lt;&#x2F;p&gt;
&lt;p&gt;Moving on!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;working-with-swift-5&quot;&gt;Working with Swift 5&lt;&#x2F;h2&gt;
&lt;p&gt;The next way to use &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; is when you are &lt;strong&gt;making&lt;&#x2F;strong&gt; an API. Here&#x27;s the situation. You have a &lt;strong&gt;public&lt;&#x2F;strong&gt; API, originally implemented before Swift 6. Say it looks something like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&#x2F; Does the work.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&#x2F;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&#x2F; Will invoke block on a background queue when complete. &lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... work happens here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Note that documentation! The &lt;code&gt;block&lt;&#x2F;code&gt; closure will be invoked on a background queue. But, the closure is &lt;strong&gt;formed&lt;&#x2F;strong&gt; at the callsite, which probably won&#x27;t be in the background. For this API to work, &lt;code&gt;block&lt;&#x2F;code&gt; will need to move from wherever it was created to that background queue. And the only types that support this kind of operation must conform to &lt;code&gt;Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This API is very problematic. It cannot be implemented error-free in Swift 6. But worse, it can cause serious runtime issues for a Swift 6 client. This is because it is doing something internally that its definition doesn&#x27;t actually allow.&lt;&#x2F;p&gt;
&lt;p&gt;You do not have to move the module to Swift 6 to fix this though. You can just address the signature. Let&#x27;s fix that by making this closure &lt;code&gt;@Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... work happens here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;With this change, we can address the externally-visible problems now, and set ourselves up for moving to Swift 6 internally. But we&#x27;ve also introduced a surprising effect! Take a look at what will happen to Swift 5 mode clients:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;doWork {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; warning: capture of &amp;#39;nonSendableType&amp;#39; with non-sendable type &amp;#39;NonSendable&amp;#39; in a `@Sendable` closure&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	print(nonSendableType)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This occurs even if that Swift 5 client has concurrency warnings &lt;strong&gt;disabled&lt;&#x2F;strong&gt;! This surprises a lot of people, understandably so. What&#x27;s going on?&lt;&#x2F;p&gt;
&lt;p&gt;Well, the compiler doesn&#x27;t allow you to suppress warnings for concurrency features you are &lt;strong&gt;actively&lt;&#x2F;strong&gt; using. This client is actively using the API, and it requires a &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closure. So, the compiler enforces that, even if they don&#x27;t want to see these diagnostics.&lt;&#x2F;p&gt;
&lt;p&gt;Would you like to guess what the solution is?&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;preconcurrency&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... does the work&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Applying &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; like this effectively conditionalizes the concurrency features you&#x27;ve used in your definition. If the client is in a &quot;pre-concurrency&quot; mode, the warnings will be suppressed. If not, they&#x27;ll be shown.&lt;&#x2F;p&gt;
&lt;p&gt;This works for more than just &lt;code&gt;@Sendable&lt;&#x2F;code&gt; too. It can also be used to conditionalize global actor isolation. Check out how SwiftUI uses it.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;preconcurrency&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Preconcurrency APIs are also ABI-compatible. Adding annotations can change the binary interface for APIs, but built clients will still work correctly without needing to be re-built against the updated library. This is very important for Apple, but I doubt it will be too useful for most 3rd-party developers.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;working-with-swift-6&quot;&gt;Working with Swift 6&lt;&#x2F;h2&gt;
&lt;p&gt;The last use of this attribute is the thing everyone tries when they run into a concurrency error they do not understand: &lt;code&gt;@preconcurrency import&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I believe this construct is confusing for three reasons. First, it&#x27;s hard to form a good mental model of what kinds of problems a preconcurrency import can address. Second, it isn&#x27;t always clear &lt;strong&gt;why&lt;&#x2F;strong&gt; a diagnostic is being presented. So even with a solid understanding, it can sometimes be tough to reason about how preconcurrency could change things. And third, I&#x27;m sorry to report that there have been a number of bugs around the &lt;code&gt;@preconcurrency import&lt;&#x2F;code&gt; implementation that make the whole thing significantly harder to learn.&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;re going to overcome all of these things! Mostly!&lt;&#x2F;p&gt;
&lt;p&gt;A good way to think about an &lt;code&gt;@preconcurrency import&lt;&#x2F;code&gt; is you are telling the compiler &quot;I&#x27;m using this API correctly, it&#x27;s just missing annotations&quot;. Now remember that we&#x27;re working with imports, so there always has to be at least two modules involved. That makes examples a little more complex.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;non-sendable-types&quot;&gt;Non-Sendable Types&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; module A&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; NonSendable {}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;returnNonSendable&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; NonSendable &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	NonSendable()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; client&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;ModuleA&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; error: Non-sendable type &amp;#39;NonSendable&amp;#39; returned by implicitly asynchronous&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; call to nonisolated function cannot cross actor boundary&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; value &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await returnNonSendable()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A non-isolated async function means it will run in the background. But, this function is attempting to create a non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; type in the background and pass it to the caller. This will almost never work. Yet, it is an &lt;strong&gt;extremely&lt;&#x2F;strong&gt; common pattern, particularly with Objective-C-to-async translations.&lt;&#x2F;p&gt;
&lt;p&gt;But maybe this &lt;code&gt;NonSendable&lt;&#x2F;code&gt; type just hasn&#x27;t been marked &lt;code&gt;Sendable&lt;&#x2F;code&gt; &lt;strong&gt;yet&lt;&#x2F;strong&gt;. Or maybe this &lt;strong&gt;specific&lt;&#x2F;strong&gt; usage pattern is safe.&lt;&#x2F;p&gt;
&lt;p&gt;An &lt;code&gt;@preconcurrency import&lt;&#x2F;code&gt; will address this kind of problem. And, making it easier, the compiler realizes this and will prompt you to add the &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; attribute.&lt;&#x2F;p&gt;
&lt;p&gt;(See the &lt;code&gt;sending&lt;&#x2F;code&gt; keyword and &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430&lt;&#x2F;a&gt; for ways to better express this particular example.)&lt;&#x2F;p&gt;
&lt;h3 id=&quot;non-sendable-closures&quot;&gt;Non-Sendable Closures&lt;&#x2F;h3&gt;
&lt;p&gt;Here&#x27;s another example I think is super-interesting. Suppose you are using a protocol from an external module, like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; module A&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; Working {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&#x2F;&#x2F; client
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;import ModuleA
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;class MyClass: Working &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Only, here&#x27;s the thing. You know, from reading documentation, that this callback can be invoked on any thread. That means it has to be &lt;code&gt;@Sendable&lt;&#x2F;code&gt;, kinda like what we saw earlier. Except that&#x27;s not how the protocol is defined. And if you add a &lt;code&gt;@Sendable&lt;&#x2F;code&gt; annotation, you no longer match the protocol. This can make it very hard to implement the conformance how you&#x27;d like.&lt;&#x2F;p&gt;
&lt;p&gt;You can fix this with &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt;!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;preconcurrency&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;ModuleA&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass: Working {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; compiler will accept this slight mis-match&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;block: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is also a situation where the compiler will realize the problem and suggest you use a &lt;code&gt;@preconcurrency import&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;hazards&quot;&gt;Hazards&lt;&#x2F;h3&gt;
&lt;p&gt;There&#x27;s something I think you need to keep in mind when using a preconcurrency import. You are telling the compiler that it should ignore these missing &lt;code&gt;Sendable&lt;&#x2F;code&gt; conformances. You are saying that everything is fine. But, you could be wrong! It&#x27;s possible that what you are currently doing actually isn&#x27;t safe. &quot;Swift 6 mode with no errors&quot; is not the same thing as correct.&lt;&#x2F;p&gt;
&lt;p&gt;And, in my experience, documentation is pretty hit-or-miss in these areas. Sometimes it is clear how to use an API correctly, but not always. And when things are ambiguous it can be very hard to be sure what to do. Worse, a preconcurrency import applies to the entire file. This makes it fairly easy to accidentally hide a real problem in one spot while intentionally addressing something else.&lt;&#x2F;p&gt;
&lt;p&gt;Pay attention closely here, because it&#x27;s easy to build a system that is dependent on a particular type being &lt;code&gt;Sendable&lt;&#x2F;code&gt;. Finding out after you built the thing that some type you do not control is actually not &lt;code&gt;Sendable&lt;&#x2F;code&gt; isn&#x27;t great.&lt;&#x2F;p&gt;
&lt;p&gt;I also wanted to specifically highlight this bit of code. You might think you can get clever here like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;preconcurrency&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-swift&quot;&gt;var&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;SomeLibrary.ActuallySafeGlobal&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;m afraid to report that while this looks cool, it (currently, anyways) &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift&#x2F;issues&#x2F;74518&quot;&gt;does not work&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping Up&lt;&#x2F;h2&gt;
&lt;p&gt;One attribute, three distinct uses. Sure, they are all closely-related, but it&#x27;s a lot.&lt;&#x2F;p&gt;
&lt;p&gt;Personally, I find the preconcurrency conformance to be pretty clear. It&#x27;s very easy to identify the situation. I don&#x27;t love using it as a workaround for protocols that are supposed to be non-isolated. But, I&#x27;m optimistic that we&#x27;ll see some improvements in this area over time.&lt;&#x2F;p&gt;
&lt;p&gt;I have noticed something funny about annotating APIs with &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt;. It makes me kinda nervous! It really highlights how easily a pre-Swift 6 mode client can use things wrong. But, that&#x27;s just the nature of pre-Swift 6 code. Plus, it&#x27;s a good reminder to keep your docs up to date, even if we can now encode this information directly into the type system as well.&lt;&#x2F;p&gt;
&lt;p&gt;And, I think the situation with preconcurrency imports has gotten better. The compiler seems to be quite good about suggesting it when it could help. But, it definitely comes with very sharp edges. It allows you to paper over problems that could have a profound impact on your design. You can definitely use preconcurrency import, but you should do so with care.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>What on earth is going on with awakeFromNib?</title>
        <published>2024-09-06T00:00:00+00:00</published>
        <updated>2024-09-06T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/awakefromnib/"/>
        <id>https://massicotte.org/awakefromnib/</id>
        
        <content type="html" xml:base="https://massicotte.org/awakefromnib/">&lt;p&gt;When I first got into Cocoa development, Interface Builder was a &lt;strong&gt;big deal&lt;&#x2F;strong&gt;. I used it pretty extensively until sometime around the macOS 10.7 era, when I began experimenting with programmatically-defined UIs. I was an instant convert, and never looked back. This was roughly 14 years ago!&lt;&#x2F;p&gt;
&lt;p&gt;I got most of my Swift concurrency experience working on a very AppKit-heavy application. So, my ears always perk up when someone has an AppKit-related concurrency issue. Yet, here was an interesting &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;swift-concurrency-in-real-apps&#x2F;73790&#x2F;34&quot;&gt;problem&lt;&#x2F;a&gt; that I wasn&#x27;t at all familiar with!&lt;&#x2F;p&gt;
&lt;p&gt;I really like this one because it is both technical and also, in my opinion, quite philosophical.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;awakefromnib&quot;&gt;&lt;code&gt;awakeFromNib&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;Interface builder works with the file extension &quot;NIB&quot;. I&#x27;m pretty sure the &quot;n&quot; stands for &quot;Next&quot;, to give you an idea of the age of this stuff.&lt;&#x2F;p&gt;
&lt;p&gt;The Nib system, if you aren&#x27;t familiar with it, allows you to serialize arbitrary objects into user interface description files. But, these objects often need to reference each other. That&#x27;s tricky, because as they are being deserialized, the full graph might not yet be ready. The &lt;code&gt;awakeFromNib&lt;&#x2F;code&gt; method is there to allow you to finish setting up your Nib-based objects at a point where they are guaranteed to all be created.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;awakeFromNib&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; work with other components that might live in the nib too&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;NS&#x2F;UINib&lt;&#x2F;code&gt; class itself lives in AppKit&#x2F;UIKit. So, you would be forgiven for thinking that this whole &lt;code&gt;awakeFromNib&lt;&#x2F;code&gt; stuff is a method on &lt;code&gt;NS&#x2F;UIResponder&lt;&#x2F;code&gt; or something like that. But that&#x27;s not the case!&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;objectivec&#x2F;nsobject&#x2F;1402907-awakefromnib&quot;&gt;&lt;code&gt;awakeFromNib&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; is defined in the Objective-C runtime on &lt;code&gt;NSObject&lt;&#x2F;code&gt;. 🫨&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;I have a feeling this is uncommon, but it turns out that you totally &lt;strong&gt;can&lt;&#x2F;strong&gt; load Nibs in the background. I don&#x27;t know if this is a &lt;strong&gt;good&lt;&#x2F;strong&gt; idea,  but the APIs support it. This means &lt;code&gt;awakeFromNib&lt;&#x2F;code&gt; is not &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated.&lt;&#x2F;p&gt;
&lt;p&gt;(As it turns out, &lt;code&gt;UINib&lt;&#x2F;code&gt; actually &lt;strong&gt;is&lt;&#x2F;strong&gt; &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated, while &lt;code&gt;NSNib&lt;&#x2F;code&gt; is not. There&#x27;s one person out there somewhere maintaining a cross-platform app that uses nibs and this is going to make their life hell.)&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;em&gt;whole point&lt;&#x2F;em&gt; of Nibs is to serialize &lt;strong&gt;UI&lt;&#x2F;strong&gt; components. That&#x27;s literally the only reason it exists. And that doesn&#x27;t work in Swift 6:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyViewController &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; NSViewController {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;IBOutlet&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; nibView: NSView&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;override&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;awakeFromNib&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ahh finally I&amp;#39;m certain nibView has been deserialized&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; and I can finish with my set up&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ERROR: Main actor-isolated property `nibView` can not be&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; referenced from a nonisolated context &lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;nibView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;color &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;blue
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This just feels &lt;em&gt;wrong&lt;&#x2F;em&gt; doesn&#x27;t it?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution?&lt;&#x2F;h2&gt;
&lt;p&gt;The compiler must honor the API contract of &lt;code&gt;awakeFromNib&lt;&#x2F;code&gt;. The framework maintainers have decided to not apply any isolation. The types and APIs aren&#x27;t able to fully describe the concurrent behavior, but the developer knows what&#x27;s actually going to happen at runtime.&lt;&#x2F;p&gt;
&lt;p&gt;This is a special-case of a very common issue and is &lt;strong&gt;exactly&lt;&#x2F;strong&gt; why dynamic isolation exists.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyViewController &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; NSViewController {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;IBOutlet&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; nibView: NSView&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;override&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;awakeFromNib&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; *I* know this will happen on the main thread&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assumeIsolated {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;nibView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;color &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;blue
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What you are doing here is expressing the isolation, which is invisible to the compiler, as a runtime invariant. The compiler will trust you, but it will also verify. This code will crash if it is ever run off the MainActor.&lt;&#x2F;p&gt;
&lt;p&gt;This is &quot;the right solution&quot;. But, if you look through that forum thread, people immediately started getting worried. Is this safe? What if &lt;em&gt;sometimes&lt;&#x2F;em&gt; this actually does run in the background? Do the frameworks make any guarantees here?&lt;&#x2F;p&gt;
&lt;p&gt;This is &lt;strong&gt;why&lt;&#x2F;strong&gt; the Swift 6 concurrency system was created.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;is-the-api-wrong&quot;&gt;Is the API wrong?&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;m not going to hide my opinion here. I think extending the root class to solve a UI framework initialization problem was a bad idea. But, the API is what is it. And, it is definitely not wrong, &lt;em&gt;assuming&lt;&#x2F;em&gt; AppKit actually does support background loading. The documentation isn&#x27;t super-clear on this topic, but the API contract definitely is.&lt;&#x2F;p&gt;
&lt;p&gt;You &lt;strong&gt;can&lt;&#x2F;strong&gt; load Nibs in the background, so this API &lt;strong&gt;cannot&lt;&#x2F;strong&gt; be &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated.&lt;&#x2F;p&gt;
&lt;p&gt;AppKit could have changed things such that regardless of how you load your nib, &lt;code&gt;awakeFromNib&lt;&#x2F;code&gt; is guaranteed to always be called on the main thread. This would have compatibility implications. So even if they wanted to do this, and I bet they did not, it could have been technically impossible anyways.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;is-the-language-wrong&quot;&gt;Is the language wrong?&lt;&#x2F;h2&gt;
&lt;p&gt;I think this is a much more interesting question. You might be tempted to think the compiler is being stupid here. My type is &lt;code&gt;MainActor&lt;&#x2F;code&gt;, just stop complaining!&lt;&#x2F;p&gt;
&lt;p&gt;The thing is, there are examples of &lt;code&gt;NSObject&lt;&#x2F;code&gt; subclasses that mix &lt;code&gt;MainActor&lt;&#x2F;code&gt; and non-&lt;code&gt;MainActor&lt;&#x2F;code&gt; methods. If the compiler were to treat all overrides as matching the isolation of its enclosing type, it would &lt;strong&gt;completely&lt;&#x2F;strong&gt; break &lt;code&gt;NSDocument&lt;&#x2F;code&gt;. Now, I want to be fair: &lt;code&gt;NSDocument&lt;&#x2F;code&gt; is probably as close to pathological as you can get. It uses a &lt;strong&gt;custom&lt;&#x2F;strong&gt; concurrency system that is not based on GCD or &lt;code&gt;OperationQueue&lt;&#x2F;code&gt;. And, it regularly mixes in main thread and background work, which is pretty much all configurable at runtime.&lt;&#x2F;p&gt;
&lt;p&gt;(The automatic ObjC-&amp;gt; async bridging, which is documented as being an option, is also unsafe to use with &lt;code&gt;NSDocument&lt;&#x2F;code&gt;: FB13394787)&lt;&#x2F;p&gt;
&lt;p&gt;Bottom line: I don&#x27;t think the language &lt;strong&gt;can&lt;&#x2F;strong&gt; solve this problem. It &lt;strong&gt;must&lt;&#x2F;strong&gt; respect APIs as written.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;everything-is-wrong&quot;&gt;Everything is wrong!&lt;&#x2F;h2&gt;
&lt;p&gt;Some APIs, even really important ones that you use every day, just won&#x27;t ever work well with Swift concurrency. I&#x27;m certain some language changes could make things a little easier here and there. But, largely, these problematic APIs are going to be deprecated and replaced. It&#x27;s happening with &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;pitch-concurrency-safe-notifications&#x2F;73713&quot;&gt;Notifications&lt;&#x2F;a&gt; right now.&lt;&#x2F;p&gt;
&lt;p&gt;You might find yourself wondering if this stuff is even ready yet, given how many problems there still are. And that, my dear reader, is exactly how you should feel when you are encountering a major technology transition. There&#x27;s a reason Swift 6 is opt-in for both existing &lt;strong&gt;and&lt;&#x2F;strong&gt; new projects.&lt;&#x2F;p&gt;
&lt;p&gt;Like all major transitions, this one will take &lt;strong&gt;years&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But if you want to opt-in and use Swift 6, go for it! You just have to be clear-eyed about exactly what you are opting into. There are some APIs that will &lt;strong&gt;never&lt;&#x2F;strong&gt; work well. You have to be ready to understand why &lt;strong&gt;and&lt;&#x2F;strong&gt; find solutions. This &lt;code&gt;awakeFromNib&lt;&#x2F;code&gt; thing honestly isn&#x27;t particularly bad, as far as problems I&#x27;ve encountered. Count yourself lucky runloops aren&#x27;t involved.&lt;&#x2F;p&gt;
&lt;p&gt;In another year, I expect things will be in better shape. Just don&#x27;t make the same mistake I did and opt into concurrency before you are ready to deal with the implications. I started using it very early on, and the results were painful. Sure, I learned a lot. But I also built a bunch of things that were totally wrong and had to be replaced. I&#x27;m still dealing with some of those mistakes.&lt;&#x2F;p&gt;
&lt;p&gt;Think carefully about your timing and goals. If you want everything to just work, now is definitely not the right time.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Concurrency Step-by-Step: A Network Request</title>
        <published>2024-08-14T00:00:00+00:00</published>
        <updated>2025-10-05T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/step-by-step-network-request/"/>
        <id>https://massicotte.org/step-by-step-network-request/</id>
        
        <content type="html" xml:base="https://massicotte.org/step-by-step-network-request/">&lt;p&gt;When I was first learning to program I had &lt;strong&gt;absolutely&lt;&#x2F;strong&gt; no idea what I was doing. I was using C, and I remember desperately putting in * and &amp;amp; characters until things compiled. But, this was pre-Mac OS X. Upon running my horrifically incorrect programs, half the time the screen would become corrupted and the mouse would stop moving. I&#x27;d then have to reboot the whole machine via a physical switch. This was ... frustrating.&lt;&#x2F;p&gt;
&lt;p&gt;Mercifully, the development experience has improved significantly. But even today, when you don&#x27;t understand warnings&#x2F;errors, I think it&#x27;s very understandable to do the same thing. The thing is, just throwing syntax at the problem is not how you build a solid foundation. I want your experience to be better than mine, particularly when learning Swift Concurrency. It&#x27;s important, because yeah I want your code to compile. But, I also want you to avoid the structural problems that can come along with making changes you might later regret.&lt;&#x2F;p&gt;
&lt;p&gt;It was a mistake that I haven&#x27;t paid more attention to people just getting started. I&#x27;m going to try to fix that by getting into some basics. Let&#x27;s go step-by-step though a network request with SwiftUI.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;preface&quot;&gt;Preface&lt;&#x2F;h2&gt;
&lt;p&gt;A few quick notes. First, I&#x27;ve pretty much omitted all error handling. I did this to keep focus on the topic at hand. I also am not a particularly sophisticated SwiftUI developer, so this might have some bad patterns.&lt;&#x2F;p&gt;
&lt;p&gt;Originally, I wrote this for Xcode 16 and Swift 6.0. I have now returned to this post to update it for Xcode 26 and Swift 6.2. The content here is &lt;strong&gt;independent&lt;&#x2F;strong&gt; of your settings for &quot;Approchable Concurrency&quot; (SWIFT_APPROACHABLE_CONCURRENCY), &lt;code&gt;NonisolatedNonsendingByDefault&lt;&#x2F;code&gt;, and default isolation.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;putting-the-pieces-in-place&quot;&gt;Putting the pieces in place&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s take a look at a very simple SwiftUI program that loads something from the network. I needed to find a free API to use, and settled on &lt;a href=&quot;https:&#x2F;&#x2F;robohash.org&quot;&gt;Robohash&lt;&#x2F;a&gt;. It is a delightful mix of simple, interesting, and quirky.&lt;&#x2F;p&gt;
&lt;p&gt;Since our data is going to be loaded from the network, we have to handle the case where we have nothing to display. We&#x27;ll start with a little view that can handle an optional image.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; LoadedImageView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; cgImage: CGImage?
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; cgImage {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			Image(cgImage, scale: &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, label: Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;R&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;))
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		} &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I used &lt;code&gt;CGImage&lt;&#x2F;code&gt; here so this code can work unmodified on all Apple platforms.&lt;&#x2F;p&gt;
&lt;p&gt;Now, we can get into the more interesting stuff. Let&#x27;s make a view that actually loads some data from the network.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; RobotView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; cgImage: CGImage?
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		LoadedImageView(cgImage: cgImage)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;onAppear {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				loadImageWithGCD()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageWithGCD&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; dataTask &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;dataTask(with: request) { data, _, _ &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; data &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; { &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;main&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;					pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;					decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;					shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;					intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		dataTask&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;resume()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;ve used GCD. Hopefully this keeps things looking familiar even if you haven&#x27;t gotten into Concurrency at all. But, I do still want to note that I&#x27;m using the Swift 6 language mode here and this code compiles error-free.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s what&#x27;s happening:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;when the view becomes visible, we invoke &lt;code&gt;loadImageWithGCD&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;a &lt;code&gt;URLRequest&lt;&#x2F;code&gt; is created&lt;&#x2F;li&gt;
&lt;li&gt;a &lt;code&gt;URLSessionDataTask&lt;&#x2F;code&gt; is configured to make the request&lt;&#x2F;li&gt;
&lt;li&gt;the response is eventually returned &lt;strong&gt;on a background thread&lt;&#x2F;strong&gt;&lt;&#x2F;li&gt;
&lt;li&gt;we shift back to the main thread to process the data and update our state&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;(If you&#x27;d like to go on a side quest, there&#x27;s a &lt;a href=&quot;https:&#x2F;&#x2F;oleb.net&#x2F;2024&#x2F;dispatchqueue-mainactor&#x2F;&quot;&gt;great post&lt;&#x2F;a&gt; that explains how the compiler is able to determine that this GCD-based code is safe.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;i-o-vs-cpu&quot;&gt;I&#x2F;O vs CPU&lt;&#x2F;h2&gt;
&lt;p&gt;There are two key phases to this operation. The request and the processing. The request is &lt;strong&gt;I&#x2F;O-bound&lt;&#x2F;strong&gt; and &lt;strong&gt;asynchronous&lt;&#x2F;strong&gt;. Once issued, we don&#x27;t have to be involved at all until the response is available. This means our UI is responsive and the app could do more work.&lt;&#x2F;p&gt;
&lt;p&gt;The second phase is &lt;strong&gt;CPU-bound&lt;&#x2F;strong&gt;. Converting the PNG data into a &lt;code&gt;CGImage&lt;&#x2F;code&gt; is synchronous work that ties up the thread until it is done. We&#x27;re doing this all on the main thread using that &lt;code&gt;DispatchQueue.main.async&lt;&#x2F;code&gt;. Our UI is &lt;strong&gt;not&lt;&#x2F;strong&gt; responsive during this second phase.&lt;&#x2F;p&gt;
&lt;p&gt;I like to think of asynchronous I&#x2F;O as &lt;strong&gt;waiting&lt;&#x2F;strong&gt;. We can do other stuff while we&#x27;re waiting. On the other hand, I think of being CPU-bound as &lt;strong&gt;working&lt;&#x2F;strong&gt;. We cannot do other stuff, because we&#x27;re busy.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s see if we can restructure things so the app will be more responsive during all this.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-wrong-way&quot;&gt;The wrong way&lt;&#x2F;h2&gt;
&lt;p&gt;As it turns out, converting the data into a &lt;code&gt;CGImage&lt;&#x2F;code&gt; is pretty darn fast. At least it is on machine, with its OS, and with the data I&#x27;m requesting right now. But all those variables could potentially impact the performance. Ok fine, this might be a little contrived, but we still don&#x27;t want to get in the habit of blocking the main thread when processing arbitrarily-large data.&lt;&#x2F;p&gt;
&lt;p&gt;Remember the callback from &lt;code&gt;dataTask&lt;&#x2F;code&gt; executes on a &lt;strong&gt;background thread&lt;&#x2F;strong&gt;? Let&#x27;s just do everything there!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageWithGCD&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; dataTask &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;dataTask(with: request) { data, _, _ &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; data &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; { &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; WARNING: Main actor-isolated property &amp;#39;cgImage&amp;#39; can not be mutated from a Sendable closure&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	dataTask&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;resume()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We have a problem though. The &lt;code&gt;self.cgImage&lt;&#x2F;code&gt; property is a component of our UI, and is only safe to work with on the main thread. The compiler produces a warning about this. It&#x27;s worth noting again that we are in the Swift 6 language mode, which is the most strict when it comes to data race checking. Yet this is a warning and not an error. I found this confusing at first!&lt;&#x2F;p&gt;
&lt;p&gt;However, we are interacting with &lt;code&gt;NSURLSession&lt;&#x2F;code&gt; here, an Objective-C API. All Objective-C imports are inherently &lt;a href=&quot;&#x2F;preconcurrency&quot;&gt;&quot;preconcurrency&quot;&lt;&#x2F;a&gt;, and that causes the compiler to downgrade problems from those APIs from errors to warnings.&lt;&#x2F;p&gt;
&lt;p&gt;(It was always supposed to work this way, but I think it didn&#x27;t because of bugs. They happen.)&lt;&#x2F;p&gt;
&lt;p&gt;Ok, enough of that digression. Here&#x27;s the warning text again:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Main actor-isolated property &#x27;cgImage&#x27; can not be mutated from a Sendable closure&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;What it is actually telling us, though, is a little hard to understand. The &quot;Sendable closure&quot; here is the closure we are providing to &lt;code&gt;dataTask(with:completionHandler:)&lt;&#x2F;code&gt;. Let&#x27;s look at its definition.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;dataTask&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;    with request: URLRequest,
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;    completionHandler: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (Data?, URLResponse?, (any Error&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;?) &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;) -&amp;gt; URLSessionDataTask
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In order to find out what thread &lt;code&gt;completionHandler&lt;&#x2F;code&gt; runs on, we would have to hunt through documentation. But, Swift Concurrency has moved this information into the type system. And you can see it right there: &lt;code&gt;completionHandler&lt;&#x2F;code&gt; is &lt;code&gt;@Sendable&lt;&#x2F;code&gt;. This means, more or less, &quot;I may run this closure on a background thread&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s try again.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-right-way&quot;&gt;The right way&lt;&#x2F;h2&gt;
&lt;p&gt;We have to be more careful about where we do our UI-related work. To do that, we&#x27;ll bring back the &lt;code&gt;main.async&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageWithGCD&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; dataTask &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;dataTask(with: request) { data, _, _ &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; data &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; { &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; image &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Must make sure we do this on the main thread&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		DispatchQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;main&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; image
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	dataTask&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;resume()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now we have a safe version, and it follows a very common pattern. The bulk of the work is done in the closure body, which we know is in the background. And we then produce a final result &lt;code&gt;image&lt;&#x2F;code&gt; that is passed along back to the main thread to update our UI.&lt;&#x2F;p&gt;
&lt;p&gt;Ok, now let&#x27;s try to do this with &lt;code&gt;async&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;await&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;async&quot;&gt;Async&lt;&#x2F;h2&gt;
&lt;p&gt;Before we get started we need a tiny bit of infrastructure in place. In order to run async code, we need an &lt;strong&gt;async context&lt;&#x2F;strong&gt;. You cannot make async calls from regular, synchronous functions.&lt;&#x2F;p&gt;
&lt;p&gt;SwiftUI gives us the &lt;code&gt;task&lt;&#x2F;code&gt; modifier to do exactly this.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; RobotView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; cgImage: CGImage?
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		LoadedImageView(cgImage: cgImage)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; you are allowed to use await in here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				await loadImageAsync()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is really similar to the &lt;code&gt;onAppear&lt;&#x2F;code&gt; modifier we were using before. Both are kicked off as soon as the view becomes visible. But, this version gives us the async context we need to call async functions.&lt;&#x2F;p&gt;
&lt;p&gt;Now, let&#x27;s write an &lt;code&gt;loadImageAsync&lt;&#x2F;code&gt; method in the &lt;code&gt;RobotView&lt;&#x2F;code&gt; struct.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageAsync&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; (data, _) &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt;? await URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;data(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: request) &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;URLSession&lt;&#x2F;code&gt; has an async version of &lt;code&gt;dataTask&lt;&#x2F;code&gt; we can use here which makes that pretty straightforward. In stark contrast to the GCD-based version, this executes linearly from top to bottom. And while that part is definitely nicer, there&#x27;s an important detail that&#x27;s now harder to figure out.&lt;&#x2F;p&gt;
&lt;p&gt;What thread is all this running on?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolation&quot;&gt;Isolation&lt;&#x2F;h2&gt;
&lt;p&gt;When you look at the GCD version, there&#x27;s really just two states. We are either running code on the main thread (queue) or we are not. This arrangement is quite common for application developers. I think this is wonderful, because it is simple and also often sufficient. Lots of apps will never need a more complex model.&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;re going to use the same idea in the concurrency world. Except we have to learn a tiny bit of terminology, because Swift concurrency doesn&#x27;t work with threads or queues directly. Instead, it is built up around this concept of isolation.&lt;&#x2F;p&gt;
&lt;p&gt;But I want to stress that it is &lt;strong&gt;not critical&lt;&#x2F;strong&gt; you understand how isolation works.&lt;&#x2F;p&gt;
&lt;p&gt;Before, we had &quot;main thread or not&quot;. The main thread isn&#x27;t going anywhere! We&#x27;re just going to talk about it terms of &lt;code&gt;MainActor&lt;&#x2F;code&gt; or not. That&#x27;s it.&lt;&#x2F;p&gt;
&lt;p&gt;Actors are the thing that enforce isolation. The &lt;code&gt;MainActor&lt;&#x2F;code&gt; protects its mutable state by &quot;isolating&quot; it to the main thread. When we say code is running &quot;on the MainActor&quot; it will be running on the main thread. Not on the &lt;code&gt;MainActor&lt;&#x2F;code&gt; means on some other thread. The compiler doesn&#x27;t actually even know that&#x27;s how the &lt;code&gt;MainActor&lt;&#x2F;code&gt; works. It just knows &quot;isolation protects stuff and it comes from actors&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;(There&#x27;s a lot more to isolation than just this. So if you want to go &lt;a href=&quot;&#x2F;intro-to-isolation&quot;&gt;deeper&lt;&#x2F;a&gt; or build up more &lt;a href=&quot;&#x2F;isolation-intuition&quot;&gt;intuition&lt;&#x2F;a&gt;, go for it. But, that is definitely not necessary right now.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;so-what-s-on-the-mainactor&quot;&gt;So what&#x27;s on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;?&lt;&#x2F;h2&gt;
&lt;p&gt;Armed with this new terminology, we want to understand what is and is not on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. We can get the information we need from the function definition.&lt;&#x2F;p&gt;
&lt;p&gt;Except this is it and there&#x27;s nothing special.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageAsync&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here&#x27;s the plot-twist. If you option-click on &lt;code&gt;loadImageAsync&lt;&#x2F;code&gt; in Xcode, you see something different!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Xcode popup&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageAsync&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;(Xcode actually does not include the &lt;code&gt;private&lt;&#x2F;code&gt; visibility modifier for some reason, but I did just to make the important stuff stand out.)&lt;&#x2F;p&gt;
&lt;p&gt;A &lt;code&gt;@MainActor&lt;&#x2F;code&gt; has somehow appeared! But &lt;strong&gt;why&lt;&#x2F;strong&gt;? This, again, comes down to definitions. In this case, it&#x27;s the definition of this method&#x27;s containing type &lt;code&gt;RobotView&lt;&#x2F;code&gt;. The &lt;code&gt;MainActor&lt;&#x2F;code&gt; shows up because the type conforms to SwiftUI&#x27;s &lt;code&gt;View&lt;&#x2F;code&gt;. The process of the &lt;code&gt;MainActor&lt;&#x2F;code&gt; propagating through the structure of a type is called &quot;isolation inference&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;You can trace it back the whole way by looking at definitions. Or you use this Xcode tool. Or, you can just remember that any time you make a view, all this stuff here is going to be &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; AnyViewYouMake: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; everything here will be MainActor automatically&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And if you get unsure, it is completely harmless to add a &lt;code&gt;@MainActor&lt;&#x2F;code&gt; yourself. Just maybe redundant.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;so-what-s-not-on-the-mainactor&quot;&gt;So what&#x27;s &lt;strong&gt;not&lt;&#x2F;strong&gt; on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;?&lt;&#x2F;h2&gt;
&lt;p&gt;That was a lot, so let&#x27;s take stock of where we are. We know &lt;code&gt;MainActor&lt;&#x2F;code&gt; means main thread. And we know &lt;code&gt;loadImageAsync&lt;&#x2F;code&gt; is inferred to be &lt;code&gt;MainActor&lt;&#x2F;code&gt; because it is defined within a &lt;code&gt;View&lt;&#x2F;code&gt; conformance. But, that annotation applies to the function as a whole. Does this mean the entire thing is going to run on the main thread?&lt;&#x2F;p&gt;
&lt;p&gt;As a matter of fact, &lt;strong&gt;it does&lt;&#x2F;strong&gt;!&lt;&#x2F;p&gt;
&lt;p&gt;Isolation applies to an entire function. Not some parts - the whole thing. But, I do want to zoom in on one specific bit. This does &lt;strong&gt;not&lt;&#x2F;strong&gt; mean the networking request is going to happen on the main thread.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageAsync&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; on the MainActor...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; (data, _) &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt;? await URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;data(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: request) &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... and on the MainActor here too&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;See that &lt;code&gt;await&lt;&#x2F;code&gt; keyword in there? It&#x27;s &lt;strong&gt;important&lt;&#x2F;strong&gt;. Right there, it will become &lt;code&gt;URLSession.data(for:)&lt;&#x2F;code&gt;&#x27;s definition that decides what isolation will be in effect. This call will &lt;strong&gt;unblock&lt;&#x2F;strong&gt; the &lt;code&gt;MainActor&lt;&#x2F;code&gt; and free it up to do other work. Only once a response is available will the function be restarted, again on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;What you need to know is the function &lt;strong&gt;you&lt;&#x2F;strong&gt; are writing is &lt;code&gt;MainActor&lt;&#x2F;code&gt;. You are in charge here, but you are not in charge of how &lt;code&gt;URLSession.data(for:)&lt;&#x2F;code&gt; works. There is nothing (supported) you can do to make &lt;code&gt;URLSession.data(for:)&lt;&#x2F;code&gt; block the main thread. Read that again. Lots of people are very confused by this.&lt;&#x2F;p&gt;
&lt;p&gt;This is radically different from how calling functions usually works, so it&#x27;s worth taking a moment to think about.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;back-to-the-async-function&quot;&gt;Back to the async function&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s get back to the problem at hand. Here are some comments to help you follow along.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; actually MainActor because we&amp;#39;re using View&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageAsync&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; MainActor here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this call might switch to something else,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; that&amp;#39;s up to URLSession&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; (data, _) &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt;? await URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;data(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: request) &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; back on the MainActor now&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It looks like we have a pretty similar solution to our original GCD-based implementation. All of our work is happening on the &lt;del&gt;main thread&lt;&#x2F;del&gt; &lt;code&gt;MainActor&lt;&#x2F;code&gt; except for the network request.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s improve that!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;concurrent&quot;&gt;&lt;code&gt;@concurrent&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;What we want is to do only the &lt;strong&gt;essential&lt;&#x2F;strong&gt; work on the &lt;code&gt;MainActor&lt;&#x2F;code&gt; and move everything else to the background. So far, we&#x27;ve chased down why our &lt;code&gt;loadImageAsync&lt;&#x2F;code&gt; function is &lt;code&gt;MainActor&lt;&#x2F;code&gt;. But, we want something that is definitely &lt;strong&gt;not&lt;&#x2F;strong&gt; &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;There is a tool to do this: the &lt;code&gt;@concurrent&lt;&#x2F;code&gt; attribute.&lt;&#x2F;p&gt;
&lt;p&gt;What this attribute does is &lt;strong&gt;stop&lt;&#x2F;strong&gt; any isolation inference and ensure that a function will always run on a background thread. Let&#x27;s adjust our function to use it, without changing anything else.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;concurrent&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageAsync&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; (data, _) &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt;? await URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;data(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: request) &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; WARNING: Main actor-isolated property &amp;#39;cgImage&amp;#39; can not be mutated from a nonisolated context&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Ah ha, but the compiler doesn&#x27;t like this!&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Main actor-isolated property &#x27;cgImage&#x27; can not be mutated from a nonisolated context&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Hold up - &quot;nonisolated&quot;? Remember, there&#x27;s &lt;strong&gt;no such thing&lt;&#x2F;strong&gt; as undefined isolation. A &lt;code&gt;@concurrent&lt;&#x2F;code&gt; function executes in the background, &lt;strong&gt;guaranteed&lt;&#x2F;strong&gt; to not be on any actor. So, if &quot;isolated&quot; means &quot;actor&quot;, then &quot;nonisolated&quot; means &quot;no actor&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;What we have here is a function that will definitely not run on the &lt;code&gt;MainActor&lt;&#x2F;code&gt;, but we&#x27;re trying to access our UI state. This is essentially the same problem we introduced with our incorrect GCD-based system above. It just produces a slightly different warning in this case.&lt;&#x2F;p&gt;
&lt;p&gt;We can definitely fix this. And, the fix is going to be (kinda) similar too!&lt;&#x2F;p&gt;
&lt;p&gt;First, let&#x27;s change the function signature. Instead of doing the request and mutation, let&#x27;s just produce the image.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;concurrent&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImageAsync&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; CGImage? &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; (data, _) &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt;? await URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;data(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: request) &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This works because we&#x27;ve removed the invalid access to the &lt;code&gt;MainActor&lt;&#x2F;code&gt;-only &lt;code&gt;cgImage&lt;&#x2F;code&gt;. It&#x27;s subtle, but when you think about this, this function was actually doing two very distinct things. A more explicit name could have been &lt;code&gt;loadImageAndUpdateUI&lt;&#x2F;code&gt;. Food for thought.&lt;&#x2F;p&gt;
&lt;p&gt;Anyways now we have to adjust the call site.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; RobotView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;State&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; cgImage: CGImage?
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		LoadedImageView(cgImage: cgImage)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;				&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await loadImageAsync()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, we&#x27;re taking the image that results from our background operation and assigning it. Easy?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-s-going-on-in-that-task&quot;&gt;What&#x27;s going on in that &lt;code&gt;task&lt;&#x2F;code&gt;?&lt;&#x2F;h2&gt;
&lt;p&gt;This does work. But, the reason &lt;strong&gt;why&lt;&#x2F;strong&gt; it works is actually kinda tricky. We &lt;strong&gt;know&lt;&#x2F;strong&gt; that the body of that &lt;code&gt;task&lt;&#x2F;code&gt; must be &lt;code&gt;MainActor&lt;&#x2F;code&gt; because we&#x27;re allowed to touch &lt;code&gt;MainActor&lt;&#x2F;code&gt; state. But where does that come from?&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s use that option-click trick again, first on &lt;code&gt;body&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Xcode popup&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View { &lt;span class=&quot;z-keyword z-other z-swift&quot;&gt;get&lt;&#x2F;span&gt; }
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This makes sense right? This &lt;code&gt;body&lt;&#x2F;code&gt; definition is within the &lt;code&gt;View&lt;&#x2F;code&gt; conformance of our type. It&#x27;s just following the same rule we learned above. But there&#x27;s actually more than actor inference going on here. This is another one of those isolation rules that you do not need to understand right now.&lt;&#x2F;p&gt;
&lt;p&gt;(But you &lt;a href=&quot;&#x2F;isolation-intuition&quot;&gt;can&lt;&#x2F;a&gt;, if you want!)&lt;&#x2F;p&gt;
&lt;p&gt;All you need to know is the closure of &lt;code&gt;task&lt;&#x2F;code&gt; is going to match the function that called it. &lt;code&gt;MainActor&lt;&#x2F;code&gt; on the outside means &lt;code&gt;MainActor&lt;&#x2F;code&gt; on the inside.&lt;&#x2F;p&gt;
&lt;p&gt;And I really want to highlight, again, that the &lt;code&gt;task&lt;&#x2F;code&gt; being &lt;code&gt;MainActor&lt;&#x2F;code&gt; has &lt;strong&gt;no effect&lt;&#x2F;strong&gt; whatsoever on how &lt;code&gt;loadImageAsync&lt;&#x2F;code&gt; is executed. It&#x27;s definition has &lt;code&gt;@concurrent&lt;&#x2F;code&gt; and definitions are what matter.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;alternative-1-tasks&quot;&gt;Alternative 1: Tasks&lt;&#x2F;h2&gt;
&lt;p&gt;There are (at least) two other options that could be used to implement this network request. I want to show you both so you can understand why I didn&#x27;t pick them.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s a really common pattern I see all the time.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImage&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	Task&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;detached {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; (data, _) &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt;? await URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;data(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: request) &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; image &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Task { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; image
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is kind of like a direct translation of the GCD-based version. Normally, a &lt;code&gt;Task&lt;&#x2F;code&gt; will use the same isolation as the enclosing function. Just like what was going on with the &lt;code&gt;.task&lt;&#x2F;code&gt; modifier above. But, &lt;code&gt;.detached&lt;&#x2F;code&gt; changes this behavior, which gives us the background thread we need. And then, a &lt;strong&gt;new&lt;&#x2F;strong&gt; &lt;code&gt;Task&lt;&#x2F;code&gt; is set up that gets back onto the &lt;code&gt;MainActor&lt;&#x2F;code&gt; to update the UI state.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s pretty complicated.&lt;&#x2F;p&gt;
&lt;p&gt;One problem is &lt;code&gt;Task.detached&lt;&#x2F;code&gt; actually does more than just ignore the enclosing isolation. It isn&#x27;t critical you know all the &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;task&#x2F;detached(name:priority:operation:)-795w1&quot;&gt;details&lt;&#x2F;a&gt;, but I consider it quite an advanced tool you basically never want. But, I&#x27;ll admit it does get the job done. And, it&#x27;s probably appealing because this almost perfectly matches the more-familiar patterns from GCD.&lt;&#x2F;p&gt;
&lt;p&gt;What I &lt;strong&gt;really&lt;&#x2F;strong&gt; don&#x27;t like about this version is at the end of this &lt;code&gt;loadImage&lt;&#x2F;code&gt; function, the work &lt;strong&gt;hasn&#x27;t&lt;&#x2F;strong&gt; finished yet. The &lt;code&gt;async&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;await&lt;&#x2F;code&gt; programming model allows you to write code that executes from top-to-bottom, but this is still going outer-to-inner. We &lt;strong&gt;can&lt;&#x2F;strong&gt; fix this by awaiting the tasks. But it&#x27;s really just adding a bunch of code and nesting.&lt;&#x2F;p&gt;
&lt;p&gt;All in all, I think this is just an awkward pattern you should avoid.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;alternative-2-mainactor-run&quot;&gt;Alternative 2: &lt;code&gt;MainActor.run&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;Now, here&#x27;s a variant that improves on that a fair bit.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;concurrent&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;loadImage&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; request &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; URLRequest(url: URL(string: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;guard&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; (data, _) &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt;? await URLSession&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;data(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: request) &lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; provider &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGDataProvider(data: data &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt; CFData)&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; image &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; CGImage(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		pngDataProviderSource: provider,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		decode: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		shouldInterpolate: &lt;span class=&quot;z-keyword z-constant z-boolean z-swift&quot;&gt;false&lt;&#x2F;span&gt;,
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		intent: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;defaultIntent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;run {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; image
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We&#x27;re back to expressing our need for a background thread in the function signature. That removes the need for &lt;code&gt;Task&lt;&#x2F;code&gt;. And we are using a new tool to do the assignment within the function scope. This is much nicer!&lt;&#x2F;p&gt;
&lt;p&gt;But there is a downside. That &lt;code&gt;MainActor.run&lt;&#x2F;code&gt; is cool, because it gives us a way to hop onto the right actor and do some work. Except, if you remember, that&#x27;s exactly what the &lt;code&gt;await&lt;&#x2F;code&gt; keyword is for! When you first start working with Concurrency, you may think to yourself &quot;oh I like this because it is explicit&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;In this example, we&#x27;re working with a property. Unfortunately, setting properties are a little quirky in this respect. But, imagine if instead we had a little helper function.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; or possibly through inference&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;updateImage&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ image: CGImage?&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This function needs to manipulate some UI state, so it would be &lt;code&gt;MainActor&lt;&#x2F;code&gt;. And that means:&lt;&#x2F;p&gt;
&lt;p&gt;We started here...&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;run {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;cgImage &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; image
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;... but we could use the function instead...&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;run {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	updateImage(image)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;... and that is actually completely equivalent to this!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await updateImage(image)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There&#x27;s no need for the &lt;code&gt;MainActor.run&lt;&#x2F;code&gt; because the compiler &lt;strong&gt;knows&lt;&#x2F;strong&gt; that &lt;code&gt;updateImage&lt;&#x2F;code&gt; is &lt;code&gt;MainActor&lt;&#x2F;code&gt;. And this is the thing I don&#x27;t love about &lt;code&gt;MainActor.run&lt;&#x2F;code&gt;. It isn&#x27;t always even obvious when you need it! And worse, you are forcing all call sites to do the right thing.&lt;&#x2F;p&gt;
&lt;p&gt;Don&#x27;t forget, concurrency is part of the type system. We are very used to controlling where things run using the stuff inside function bodies, but Swift Concurrency is largely concerned with the stuff outside of them. It&#x27;s a very big mental shift.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;we-made-it&quot;&gt;We made it&lt;&#x2F;h2&gt;
&lt;p&gt;Whew. This turned out to be a lot longer than I expected when starting. I really appreciate you making your way through, and I hope it was helpful. We did have to skip some details on how isolation works. But, I honestly think that&#x27;s good! Start with the basics of understanding when things are and are not going to run on the main thread. That will get you really far!&lt;&#x2F;p&gt;
&lt;p&gt;If you want to start digging into some more details, I have a bunch of other things written up that covers some of the things we skipped.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;intro-to-isolation&quot;&gt;An Introduction to Isolation in Swift&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;isolation-intuition&quot;&gt;Swift Isolation Intuition&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;dynamic-isolation&quot;&gt;Is Dynamic Isolation Bad?&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;synchronous-work&quot;&gt;Synchronous Work&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;But, I really do recommend you to focus on the &lt;strong&gt;basics&lt;&#x2F;strong&gt; first. Starting with a solid foundation is going to help keep frustration to a minimum.&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s also now &lt;a href=&quot;&#x2F;step-by-step-reading-from-storage&quot;&gt;second installment&lt;&#x2F;a&gt; of this series, if you want to keep going!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Making Mistakes with Swift Concurrency</title>
        <published>2024-08-06T00:00:00+00:00</published>
        <updated>2024-08-06T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/mistakes-with-concurrency/"/>
        <id>https://massicotte.org/mistakes-with-concurrency/</id>
        
        <content type="html" xml:base="https://massicotte.org/mistakes-with-concurrency/">&lt;p&gt;I&#x27;m really enjoying how much discussion has been going on in the Swift community lately. It feels like everyone is talking about their experiences with concurrency, both good and bad. Like with most feedback, the good stuff is nice to hear. But it&#x27;s the bad stuff that can often be most useful.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve now heard about lots of problems. There&#x27;s a great mix of technical and philosophical stuff. I love both! There are trends and I want to focus in on a few them.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;i-m-running-into-problems-but-warnings-are-disabled&quot;&gt;I&#x27;m running into problems, but warnings are disabled&lt;&#x2F;h2&gt;
&lt;p&gt;It is so hard to address the concurrency problems that come up here. I&#x27;m not sure we can even really have a meaningful discussion. Swift 5 mode + no warnings can be an &lt;strong&gt;extremely unsafe&lt;&#x2F;strong&gt; dialect of the language. There are basically no rules, and you cannot use a compiler-based concurrency system when the compiler&#x27;s checks are disabled.&lt;&#x2F;p&gt;
&lt;p&gt;When you do this, you aren&#x27;t just at risk of building systems that work incorrectly, you are also building an incorrect mental model of how the language works. This is &lt;strong&gt;very&lt;&#x2F;strong&gt; bad. It may feel like it is getting you closer to Swift 6, but it could be doing the exact opposite.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;i-have-to-migrate-to-swift-6-mode-now&quot;&gt;I have to migrate to Swift 6 mode now&lt;&#x2F;h2&gt;
&lt;p&gt;I think there is a lot emotional pressure here because it is such a hot topic. But, the timeline for this migration is going to be measured in years. Now if this is a personal project, go for it! If you work on a larger project&#x2F;team, I think making this case is a lot harder. This is even more true for large projects with low modularity, because language mode is per-module. Come to think of it, this could be a great way to justify modularization efforts! (Quick, go tell your manager!)&lt;&#x2F;p&gt;
&lt;p&gt;I really want you to have a very clear reason for why this is important to do &lt;strong&gt;right now&lt;&#x2F;strong&gt;, especially considering that the Swift 6 compiler is still in beta.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;i-want-to-ignore-this-stuff-and-i-can-t&quot;&gt;I want to ignore this stuff and I can&#x27;t&lt;&#x2F;h2&gt;
&lt;p&gt;This is kind of the inverse of the previous issue. I completely understand this feeling!&lt;&#x2F;p&gt;
&lt;p&gt;The thing is the Swift 6 compiler supports the &lt;strong&gt;Swift 4 language mode&lt;&#x2F;strong&gt;, which was released in 2017. And, this is a &lt;strong&gt;way&lt;&#x2F;strong&gt; bigger change. I wouldn&#x27;t be surprised if the Swift 5 language mode outlives many Swift 5-based projects.&lt;&#x2F;p&gt;
&lt;p&gt;The language is going in this direction, there is absolutely no doubt. But, you are not being forced to come along, at least not in the medium-term. There a handful of APIs that are exclusively available using these new language features. And that will only increase with time. But, it should be relatively painless to bridge back to GCD if you need to.&lt;&#x2F;p&gt;
&lt;p&gt;Unless you are making a library, you can largely &lt;strong&gt;ignore&lt;&#x2F;strong&gt; all this stuff if you aren&#x27;t into it. Might not be the worst idea, since we&#x27;re certain to see further refinements to both the language and APIs in the coming years.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;i-read-something-that-says-this-whole-thing-is-a-bad-idea&quot;&gt;I read something that says this whole thing is a bad idea&lt;&#x2F;h2&gt;
&lt;p&gt;Whatever you read was a real experience and it is &lt;strong&gt;valid&lt;&#x2F;strong&gt;. But, the context is absolutely &lt;strong&gt;essential&lt;&#x2F;strong&gt; here.&lt;&#x2F;p&gt;
&lt;p&gt;How far did they go before turning on warnings? Were they using a Swift 5 compiler? How modularized was their project? How much of a factor was first- and third-party code? How big was the team? How much non-Swift was involved?&lt;&#x2F;p&gt;
&lt;p&gt;Without clear answers to these kinds of questions, it&#x27;s difficult to understand how applicable this experience is going to be to yours.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;you-have-to-understand-everything&quot;&gt;You have to understand everything&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;ve encountered this sentiment in a number of places. The language has definitely expanded pretty significantly recently.&lt;&#x2F;p&gt;
&lt;p&gt;Maybe there&#x27;s some new language tool you can use to solve a problem or build a better API. How can you possibly know unless you understand everything?&lt;&#x2F;p&gt;
&lt;p&gt;I do not think you need to go and read every proposal. I did, and honestly, it was a lot of &lt;a href=&quot;https:&#x2F;&#x2F;massicotte.org&#x2F;mistakes-with-concurrency&#x2F;concurrency-swift-6-se-401&quot;&gt;work&lt;&#x2F;a&gt;. But, something I learned from doing it is many of these new language features were specifically built to help &lt;strong&gt;hide&lt;&#x2F;strong&gt; details. It&#x27;s still pretty early, but I think ultimately this is going to end up largely succeeding. What it all comes down to is how much concurrency you have in your project. (Probably too much)&lt;&#x2F;p&gt;
&lt;p&gt;You cannot progressively disclose the details of features you are &lt;strong&gt;actively&lt;&#x2F;strong&gt; using. Concurrency touches virtually all existing Swift code so tons of stuff gets shoved in your face all at once. If you are mostly a main-thread developer, working on UIs, I think you&#x27;ll be able to get lots of work done without going too deep. If you are building APIs for other developers, you may need to understand a lot more.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;swift-6-is-solving-a-problem-that-does-not-exist&quot;&gt;Swift 6 is solving a problem that does not exist&lt;&#x2F;h2&gt;
&lt;p&gt;I have worked on crash reporting systems as my full-time job for two companies. I admit that I have been out of the game for a while now. But, accidentally running stuff off the main thread is the simplest and most straight-forward concurrency problem you could possibly have it was &lt;strong&gt;absolutely pervasive&lt;&#x2F;strong&gt;. And an understandable and attributable crash is just about the best outcome you can hope for in this scenario.&lt;&#x2F;p&gt;
&lt;p&gt;Now there &lt;strong&gt;are&lt;&#x2F;strong&gt; some well-established &lt;a href=&quot;https:&#x2F;&#x2F;inessential.com&#x2F;2014&#x2F;03&#x2F;08&#x2F;api_design_the_main_thread_and_queues.html&quot;&gt;patterns&lt;&#x2F;a&gt; that can help avoid many concurrency issues, that one definitely included. But, these are often employed by advanced users that have been practicing for years. I think it is easy for these habits to make &quot;I don&#x27;t have this problem&quot; feel like &quot;this is not a problem&quot;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;legacy-apis-are-easy-to-use&quot;&gt;Legacy APIs are easy to use&lt;&#x2F;h2&gt;
&lt;p&gt;A particularly pernicious issue is how many APIs remain incorrectly-annotated. This can range from just an annoyance all the way up to a catastrophic interoperability problem. I&#x27;m hoping to see further developments to help here, because this one is going to be with us for a while.&lt;&#x2F;p&gt;
&lt;p&gt;But in the meantime I think we have to come to terms with the reality as it is today. All libraries that make use of concurrency across the &lt;strong&gt;entire ecosystem&lt;&#x2F;strong&gt; need to be &lt;strong&gt;updated&lt;&#x2F;strong&gt; or &lt;strong&gt;deprecated&lt;&#x2F;strong&gt;. Unfortunately when it comes to updating APIs, even just the minimum can require a deep understanding.&lt;&#x2F;p&gt;
&lt;p&gt;This is a great time to archive those repos you aren&#x27;t going to work on anymore!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;everything-should-be-sendable&quot;&gt;Everything should be Sendable&lt;&#x2F;h2&gt;
&lt;p&gt;If it&#x27;s a value type, possibly. Maybe even probably! But if it is a reference type, almost certainly not. Needing lots of stuff to be &lt;code&gt;Sendable&lt;&#x2F;code&gt; is a usually sign you have too many isolation boundaries. A big cause of this is introducing too many actors into your code. Too many can be one. Actors are deceptively complex, and I think they should considered an advanced tool.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actors-are-fifo&quot;&gt;Actors are FIFO&lt;&#x2F;h2&gt;
&lt;p&gt;Nope. Actors are not queues. Let me say it again, &lt;code&gt;actor&lt;&#x2F;code&gt; is an advanced tool. Be wary of any material that makes it seem otherwise. You should be sticking to the binary main&#x2F;not-main until you are very comfortable with isolation before trying them out.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;non-isolated-is-unsafe&quot;&gt;Non-isolated is unsafe&lt;&#x2F;h2&gt;
&lt;p&gt;This one is very understandable. It is tricky to get the idea of isolation, and the word &lt;code&gt;nonisolated&lt;&#x2F;code&gt; really does sound like you are turning off some kind of protection. But, the compiler will still prevent you from making mistakes. The two keywords that really could introduce problems are &lt;code&gt;@unchecked&lt;&#x2F;code&gt; and &lt;code&gt;nonisolated(unsafe)&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;A great pattern for most projects is lots of &lt;code&gt;@MainActor&lt;&#x2F;code&gt; with some little bits of &lt;code&gt;nonisolated&lt;&#x2F;code&gt; here and there to get stuff off the main thread.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;establishing-an-async-context-is-easy&quot;&gt;Establishing an async context is easy&lt;&#x2F;h2&gt;
&lt;p&gt;This is another one that was made out to be a simple thing in the early days of concurrency. Just use &lt;code&gt;Task&lt;&#x2F;code&gt; they said!&lt;&#x2F;p&gt;
&lt;p&gt;The transition from a synchronous to asynchronous context actually is &lt;strong&gt;easy&lt;&#x2F;strong&gt;, but is often also really &lt;strong&gt;tricky&lt;&#x2F;strong&gt;! The problem is controlling order. This is something I have &lt;a href=&quot;&#x2F;ordering-and-concurrency&quot;&gt;written about&lt;&#x2F;a&gt; before, but I really want to revisit it. Here&#x27;s a good mental model courtesy of &lt;a href=&quot;https:&#x2F;&#x2F;mastodon.social&#x2F;@cocoaphony&#x2F;112893796368067518&quot;&gt;Rob Napier&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Every time you write Task, I want you to pretend it&#x27;s actually this:&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; delay: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; (&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;10&lt;&#x2F;span&gt;)&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;randomElement()&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-statement z-swift&quot;&gt;try&lt;&#x2F;span&gt; await Task&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;sleep(&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;for&lt;&#x2F;span&gt;: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;seconds(delay))
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; .. Your code&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is a &lt;strong&gt;little&lt;&#x2F;strong&gt; on the pessimistic side. Swift 6 is bringing some better behavior the to &lt;code&gt;Task&lt;&#x2F;code&gt; API. Even so, I still like this way of thinking.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;beginners-will-learn-about-queues-and-locks&quot;&gt;Beginners will learn about queues and locks&lt;&#x2F;h2&gt;
&lt;p&gt;People very commonly ask if they should start by learning UIKit or SwiftUI. Someone just getting started cannot possibly learn everything. So they look for guidance to help them focus. But, the pull towards SwiftUI is very strong, if for no other reason than it is new. People like new stuff, but beginners &lt;strong&gt;love&lt;&#x2F;strong&gt; it. Why should they put time into learning an older technology?&lt;&#x2F;p&gt;
&lt;p&gt;Today, Xcode 16&#x27;s default for a new project is Swift 5. Just that is going to go a very long way.&lt;&#x2F;p&gt;
&lt;p&gt;I believe that beginners will still make the transition to Swift 6 relatively quickly. Not with full understanding, mind you. But they didn&#x27;t have that with the global-queue-to-main-queue dance either. At least now the compiler will enforce correctness, and can do so with less code.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;unsafe-opt-outs-defeat-the-purpose&quot;&gt;Unsafe opt-outs defeat the purpose&lt;&#x2F;h2&gt;
&lt;p&gt;This is a really interesting case I think. If you just put &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt; and &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; all over your code base, did you really achieve something useful? I think the answer is very clear: &lt;strong&gt;absolutely&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Getting warnings on, or even to full Swift 6 mode, is about setting yourself up for &lt;strong&gt;future&lt;&#x2F;strong&gt; work that fits the model. There are also cases, like with a &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; protocol conformance, that introduce a lot more safety than what you had before.&lt;&#x2F;p&gt;
&lt;p&gt;I think this is a good starting point. I&#x27;m not saying it&#x27;s &lt;strong&gt;great&lt;&#x2F;strong&gt;. And, it really is a &lt;strong&gt;starting point&lt;&#x2F;strong&gt;. But, I think this approach really can help minimize disruption while also introducing some stronger safety guarantees. You have expressed truth, perhaps with a little optimism mixed in. The pieces are now in place so you can further refactor with more confidence.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;onward&quot;&gt;Onward&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;d love for this not to be the case, but for me, making mistakes is a critical part of learning. That can certainly be painful, and sometimes embarrassing. I feel like I&#x27;ve been making mistakes at a record pace recently and I choose to believe that&#x27;s a good sign!&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m sure at least some of the stuff here will end up being wrong. I&#x27;m ok with that. This is an incredibly interesting time to be working with Swift. We probably still have, at a minimum, another year to wait before we really have a good idea of how this transition is playing out. I&#x27;m really appreciative of everyone out there sharing their experiences. I&#x27;ve been learning a lot!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Non-Sendable types are cool too you know</title>
        <published>2024-07-30T00:00:00+00:00</published>
        <updated>2024-07-30T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/non-sendable/"/>
        <id>https://massicotte.org/non-sendable/</id>
        
        <content type="html" xml:base="https://massicotte.org/non-sendable/">&lt;p&gt;&lt;code&gt;Sendable&lt;&#x2F;code&gt; gets talked about a lot. And while it is a critical aspect of Swift concurrency, I think non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types are very interesting and just as important. They are often seen as a problem when facing concurrency issues.  But, non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types can actually sometimes be a perfect solution.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s take a look! But, before we do I want to make sure you know what you&#x27;re getting into here. This is not introductory material.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;thread-safe&quot;&gt;Thread-Safe?&lt;&#x2F;h2&gt;
&lt;p&gt;I want to start with something that I think confuses a lot of people. Regardless of what languages they use, programmers have some mental model of what &quot;thread-safe&quot; means.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s what the documentation for &lt;code&gt;Sendable&lt;&#x2F;code&gt; says:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;A thread-safe type whose values can be shared across arbitrary concurrent contexts without introducing a risk of data races.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Ok, that sounds pretty unambiguous. But, here&#x27;s something weird. Global actor isolated-types implicitly conform to &lt;code&gt;Sendable&lt;&#x2F;code&gt;. This means that &lt;code&gt;UIView&lt;&#x2F;code&gt;, which is &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated, is also &lt;code&gt;Sendable&lt;&#x2F;code&gt;. Would you consider that type thread-safe? Let&#x27;s check its documentation:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Manipulations to your app’s user interface must occur on the main thread.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;I was hoping to find something along the lines of &quot;this type is not thread-safe&quot; to really drive home the point. But, this still sure doesn&#x27;t sound like something that can be shared across arbitrary concurrent contexts. To me, &quot;thread-safe&quot; means safe to use from any thread at any time. So what&#x27;s going on?&lt;&#x2F;p&gt;
&lt;p&gt;Well, the thing is &lt;code&gt;UIView&lt;&#x2F;code&gt; actually &lt;strong&gt;does&lt;&#x2F;strong&gt; meet this definition of thread-safety, but &lt;strong&gt;only&lt;&#x2F;strong&gt; when used with Swift 6. And that&#x27;s because the compiler can a) understand its main thread-only requirement and b) strictly enforce it.&lt;&#x2F;p&gt;
&lt;p&gt;The reason &quot;thread-safety&quot; is mentioned so prominently for &lt;code&gt;Sendable&lt;&#x2F;code&gt; is because the language is able to achieve the same effect. But, I think this is a confusing thing for people learning about Swift concurrency. Even worse, &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt; types are intentionally stepping outside the bounds of what the compiler can verify. These types &lt;strong&gt;must&lt;&#x2F;strong&gt; be &quot;thread-safe&quot; in a way that matches the meaning of the term outside of the Swift concurrency world.&lt;&#x2F;p&gt;
&lt;p&gt;What I&#x27;m really getting at with all this is &lt;code&gt;Sendable&lt;&#x2F;code&gt; and the concept of isolation are inseparable.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-s-sendable&quot;&gt;What&#x27;s Sendable?&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;Sendable&lt;&#x2F;code&gt; is a so-called &quot;marker protocol&quot;. That is a protocol that has no requirements, but instead serves only to describe some semantic quality of the type. A type that is &lt;code&gt;Sendable&lt;&#x2F;code&gt; means it can be freely transferred across isolation domains. These types are thread-safe, keeping in mind the meaning of that term in the Swift concurrency world.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;ok-so-what-s-non-sendable&quot;&gt;Ok, so what&#x27;s non-Sendable?&lt;&#x2F;h2&gt;
&lt;p&gt;Non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; just means the lack of a &lt;code&gt;Sendable&lt;&#x2F;code&gt; conformance. These types are not possible to share across isolation domains. They are &lt;strong&gt;stuck&lt;&#x2F;strong&gt; in whatever isolation domain they get created in. Lots of things are non-&lt;code&gt;Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The Swift 6 compiler is able to, sometimes, safely perform a one-way transfer of a non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; type from one isolation domain to another. This can help tremendously with usability, but it does not change the nature of these types. They are still not safe to &lt;strong&gt;share&lt;&#x2F;strong&gt; and the compiler will not permit it.&lt;&#x2F;p&gt;
&lt;p&gt;It might surprise you to hear me say this, but non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types are &lt;strong&gt;also&lt;&#x2F;strong&gt; thread-safe. That&#x27;s because the compiler forces you to use them in a thread-safe way. In fact, all code built with the Swift 6 language mode is thread-safe.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;protocols&quot;&gt;Protocols&lt;&#x2F;h2&gt;
&lt;p&gt;One area that consistently causes people problems is when protocols and isolation meet. Because isolation is a property of all types, protocols necessarily define their isolation requirements too. And sometimes that&#x27;s just not what you want.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; NonIsolatedProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass: NonIsolatedProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ERROR here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What&#x27;s happening here is the protocol requires that &lt;code&gt;someFunction&lt;&#x2F;code&gt; be &lt;strong&gt;non-isolated&lt;&#x2F;strong&gt;, but the type is isolated to a global actor. This conflict is a common example of a very well-known type of problem called &lt;a href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;migration&#x2F;documentation&#x2F;swift-6-concurrency-migration-guide&#x2F;commonproblems#Protocol-Conformance-Isolation-Mismatch&quot;&gt;protocol conformance isolation mismatch&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;removing-isolation&quot;&gt;Removing isolation&lt;&#x2F;h2&gt;
&lt;p&gt;There are many ways of dealing with isolation mismatches. One of the most straightforward options is just to remove isolation using the &lt;code&gt;nonisolated&lt;&#x2F;code&gt; keyword. This selectively opts-out of any isolation being applied to the whole type.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass: NonIsolatedProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ERROR here now because `self` is still MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Except when you do this, you&#x27;re often just kicking the can down the road. You can now conform to the protocol, but the implementation can&#x27;t be what you want. Not particularly useful.&lt;&#x2F;p&gt;
&lt;p&gt;This is a contrived case, but I want to highlight something. We removed isolation from just the protocol&#x27;s method. If instead we remove the isolation &lt;strong&gt;entirely&lt;&#x2F;strong&gt;, everything works. There&#x27;s absolutely nothing about the internals of this object that requires isolation. But, if there was, the compiler would immediately complain about it. Remember, the language does not allow you to make mistakes!&lt;&#x2F;p&gt;
&lt;p&gt;Now here&#x27;s where I make a bold assertion: if you &lt;strong&gt;can&lt;&#x2F;strong&gt; remove isolation from a type, you &lt;strong&gt;should&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Isolation is a &lt;strong&gt;constraint&lt;&#x2F;strong&gt; so removing it makes things more flexible. Here&#x27;s the solution to the above problem with all isolation removed. It just looks normal.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; NonIsolatedProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass: NonIsolatedProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The reason this is such a great solution is because it addresses the &lt;strong&gt;root problem&lt;&#x2F;strong&gt;. The definition of &lt;code&gt;NonIsolatedProtocol&lt;&#x2F;code&gt; has made promises that &lt;code&gt;MyClass&lt;&#x2F;code&gt; cannot keep. Inappropriate isolation, either too much or not enough, can be &lt;strong&gt;detrimental&lt;&#x2F;strong&gt; to a design.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;where-did-the-isolation-go&quot;&gt;Where did the isolation go?&lt;&#x2F;h2&gt;
&lt;p&gt;Many people get worried when someone suggests removing isolation. Even the keyword &quot;nonisolated&quot; makes people nervous. And I think that&#x27;s understandable, because it kinda sounds like it could be unsafe.&lt;&#x2F;p&gt;
&lt;p&gt;But, that&#x27;s really not the case. A non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; type still must be isolated somehow. Everything always has some well-defined isolation. That problem has just been pushed up a level to the clients of the type. This object is going to get created in some isolation domain and it&#x27;s going to &lt;strong&gt;stay there&lt;&#x2F;strong&gt;. It cannot move, because that&#x27;s something only &lt;code&gt;Sendable&lt;&#x2F;code&gt; types can do.&lt;&#x2F;p&gt;
&lt;p&gt;(I do want to acknowledge that over-isolation can actually help to catch an important class of problem: interoperability with incorrectly-annotated code. This is an inherently difficult thing to handle. But, I do want to call this out because I&#x27;m not sure I fully understood this problem until recently.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;non-sendable-async&quot;&gt;non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; + &lt;code&gt;async&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;If there is one &lt;strong&gt;gigantic red flag&lt;&#x2F;strong&gt; that I see all the time, it is non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types with &lt;code&gt;async&lt;&#x2F;code&gt; methods.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someAsyncFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;To understand why this is problematic, you have to understand how non-isolated async functions work. They always run on the global executor. Or, to put it another way, non-isolated async functions always run in the background.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s look at a call site.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Client {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; isolated to the MainActor...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; instance &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; MyClass()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... this is MainActor too...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;useInstance&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; error: requires instance be non-isolated!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await instance&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;someAsyncFunction()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We know that &lt;code&gt;someAsyncFunction&lt;&#x2F;code&gt; must run in an non-isolated context. We also know that &lt;code&gt;instance&lt;&#x2F;code&gt; is non-&lt;code&gt;Sendable&lt;&#x2F;code&gt;. And this means to call this method, &lt;code&gt;instance&lt;&#x2F;code&gt; must &lt;strong&gt;already&lt;&#x2F;strong&gt; be non-isolated. We&#x27;ve made a type that is, by definition, only usable from non-isolated contexts. This is valid, but probably not what you want.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-solution&quot;&gt;A solution?&lt;&#x2F;h2&gt;
&lt;p&gt;When I first encountered this problem, here&#x27;s what I did to solve it.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someAsyncFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I knew wanted a non-isolated type so I could conform to non-isolated protocols. But, I also wanted async methods. And the only way I could figure out how to do that safely was to apply some isolation. But, this is actually just another side of the same coin. Now, this method is only callable if the instance was &lt;strong&gt;already&lt;&#x2F;strong&gt; on the MainActor.&lt;&#x2F;p&gt;
&lt;p&gt;Can we do better?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-solution-1&quot;&gt;A solution!&lt;&#x2F;h2&gt;
&lt;p&gt;Yes, in fact we can. But don&#x27;t let the signature intimidate you.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someAsyncFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;isolation: isolated (any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;? = #isolation) async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What we&#x27;re doing here is using an &lt;a href=&quot;&#x2F;isolated-parameters&quot;&gt;isolated parameter&lt;&#x2F;a&gt; combined with some &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;fancy new Swift 6 features&lt;&#x2F;a&gt; to inherit isolation at the callsite. It&#x27;s a lot. But this allows our function to be fully general over all possible isolation. This can be used from the &lt;code&gt;MainActor&lt;&#x2F;code&gt;, regular actor types, and also a non-isolated context. You don&#x27;t even have to interact with the &lt;code&gt;isolation&lt;&#x2F;code&gt; parameter. Its mere &lt;strong&gt;presence&lt;&#x2F;strong&gt; establishes the isolation behavior we want.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Client {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; isolated to the MainActor...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; instance &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; MyClass()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... this is MainActor too...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;useInstance&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... and now this function will be as well!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await instance&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;someAsyncFunction()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Note the lack of the &lt;code&gt;isolation&lt;&#x2F;code&gt; argument. That&#x27;s handled by the default &lt;code&gt;#isolation&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The isolated parameter makes it possible for non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types to participate in concurrency much more easily. And as a bonus, this is &lt;strong&gt;guaranteed&lt;&#x2F;strong&gt; not suspend on function entry. Later calls within &lt;code&gt;someAsyncFunction&lt;&#x2F;code&gt; can still suspend. But, this opens up a little synchronous window and that can be critical for solving certain kinds of concurrency problems.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Making an isolated parameter optional turns out to come with some more complexity. But I did not realize this because of a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift&#x2F;issues&#x2F;77301&quot;&gt;compiler bug&lt;&#x2F;a&gt;. None of this is &quot;wrong&quot;, and making it non-optional means the &lt;code&gt;#isolation&lt;&#x2F;code&gt; default no longer works. So, there are big trade-offs here. But, the safest, most-annoying option actually looks like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someAsyncFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;isolation: isolated any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I want to call this out, but I still think that for the most part, using the optional here makes sense. It&#x27;s easier, it&#x27;s convenient, and once that bug is fixed it will no longer allow any unsafety.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolated-any&quot;&gt;&lt;code&gt;@isolated(any)&lt;&#x2F;code&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;I think &lt;strong&gt;virtually all&lt;&#x2F;strong&gt; non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types should use this isolated parameter technique for their async functions. But, it&#x27;s incredibly verbose. And that got me thinking about the relationship between this and &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;&lt;code&gt;@isolated(any)&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I think it would be really cool if we could instead write this instead:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-begin z-swift&quot;&gt;isolated&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;(&lt;span class=&quot;z-meta z-attribute z-arguments z-swift&quot;&gt;any&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someAsyncFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, state)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Today, &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; can only be used with closures. Which, interestingly can also themselves have isolated parameters. But, the more I think about it, the more it seems like isolated parameters and &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; are solving the same problem. Am I wrong?&lt;&#x2F;p&gt;
&lt;p&gt;(Future me: yes, I am wrong! This attribute is a frequent source of confusion. There &lt;em&gt;could&lt;&#x2F;em&gt; still be some kind of idea here, but this mostly doesn&#x27;t make sense.)&lt;&#x2F;p&gt;
&lt;p&gt;Anyways.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;you-should-be-using-non-sendable-types&quot;&gt;You should be using non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types&lt;&#x2F;h2&gt;
&lt;p&gt;I think non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; types are tremendously useful. They are much easier to use with protocols. They are just as &quot;thread-safe&quot; as an isolated type. And now we have a way for them to have usable async methods. There is a &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;closure-isolation-control&#x2F;70378&quot;&gt;small hole&lt;&#x2F;a&gt; in their concurrency story. But, overall I think they can be a really powerful tool for modelling mutable state that can work with arbitrarily-isolated clients.&lt;&#x2F;p&gt;
&lt;p&gt;Non-Sendable types are great and you should use them!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0434: Usability of global-actor-isolated types</title>
        <published>2024-07-11T00:00:00+00:00</published>
        <updated>2024-07-11T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0434/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0434/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0434/">&lt;p&gt;Global actors are central to the vast majority of Swift programs. In fact, often you only really need two kinds of isolation - &lt;code&gt;MainActor&lt;&#x2F;code&gt; and not-&lt;code&gt;MainActor&lt;&#x2F;code&gt;. But, global actors have some quirks that makes for some strange&#x2F;frustrating behavior.&lt;&#x2F;p&gt;
&lt;p&gt;This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0434-global-actor-isolated-types-usability.md&quot;&gt;proposal&lt;&#x2F;a&gt; is kind of a grab bag that improves them in three ways.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430: &lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;There are three pretty distinct things being covered here.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;implicitly-non-isolated-properties&quot;&gt;Implicitly Non-Isolated Properties&lt;&#x2F;h3&gt;
&lt;p&gt;The compiler gets pretty clever with the properties of globally-isolated types. If they are &lt;code&gt;Sendable&lt;&#x2F;code&gt;, the compiler treats them as non-isolated within its defining module. It knows that because they are &lt;code&gt;Sendable&lt;&#x2F;code&gt;, they are actually safe to use from any domain. Enforcing the isolation on these properties serves no safety purpose. This is pretty smart, and helps to loosen restrictions. Thing is, it currently only works for &lt;code&gt;let&lt;&#x2F;code&gt; in value types.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; SomeMainActorType {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; x: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; y: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;readValues&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(x) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is allowed!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(y) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is not?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;closures&quot;&gt;Closures&lt;&#x2F;h3&gt;
&lt;p&gt;It took me a long time to fully understand that a globally-isolated type &lt;strong&gt;becomes&lt;&#x2F;strong&gt; &lt;code&gt;Sendable&lt;&#x2F;code&gt;. Once you apply isolation, the compiler has enough information to keep things safe in all circumstances. In fact, this rule is stated explicitly in &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0316-global-actors.md&quot;&gt;SE-0316&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;A non-protocol type that is annotated with a global actor implicitly conforms to &lt;code&gt;Sendable&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;However, this isn&#x27;t actually true for closures.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; closure &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; capture a bunch of non-Sendable stuff&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Error: capturing non-Sendable `closure`&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await closure()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The only workaround is also make them &lt;code&gt;@Sendable&lt;&#x2F;code&gt;, and this &lt;strong&gt;severely&lt;&#x2F;strong&gt; impacts their usability.&lt;&#x2F;p&gt;
&lt;p&gt;(Or at least it did when also in a pre-&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;Region-Based Isolation&lt;&#x2F;a&gt; world. The problems this use to cause are now much more difficult to encounter with 6.0 and later compilers.)&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; closure &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; now can capture only Sendable stuff 😖&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;subclassing&quot;&gt;Subclassing&lt;&#x2F;h3&gt;
&lt;p&gt;Finally, a restriction was added to Swift 5.10 to catch a potential unsafe pattern around subclassing.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; NotSendable {}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; error: main actor-isolated class &amp;#39;Subclass&amp;#39; has different&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; actor isolation from nonisolated superclass &amp;#39;NotSendable&amp;#39;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Subclass: NotSendable {}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Remember that a global actor annotation makes a type Sendable. However, &lt;code&gt;Subclass&lt;&#x2F;code&gt; here cannot ever truly be &lt;code&gt;Sendable&lt;&#x2F;code&gt;, because it inherits all the non-&lt;code&gt;Sendable&lt;&#x2F;code&gt; internals of its base type. Adding the global actor to a subtype allowed you to cheat! But, disallowing this pattern altogether is overly-restrictive. The isolation itself that is the problem, it is just the implicit &lt;code&gt;Sendable&lt;&#x2F;code&gt; that comes along with it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;The fixes for the first two of these problems are straightforward.&lt;&#x2F;p&gt;
&lt;p&gt;The compiler is going to get even smarter about how it enforces isolation on &lt;code&gt;Sendable&lt;&#x2F;code&gt; properties of value types.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; SomeMainActorType {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; x: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; y: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;readValues&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(x) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is allowed!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(y) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is now also ok!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Second, globally-isolated closures are now &lt;code&gt;Sendable&lt;&#x2F;code&gt;!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; closure &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; capture a bunch of non-Sendable stuff&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await closure() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; now ok! 🙌🏻&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The fix for the subclassing problem is a little strange. A globally-isolated subclass will now be allowed, but will it will no longer get an implicit &lt;code&gt;Sendable&lt;&#x2F;code&gt; conformance.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;In all three of these situations, you may have workarounds in place that are just no longer necessary. I don&#x27;t think I&#x27;ve hit the other two issues myself, but the closure change here is a big deal. I have encountered this in numerous situations and it was always painful.&lt;&#x2F;p&gt;
&lt;p&gt;I think it&#x27;s &lt;strong&gt;a little&lt;&#x2F;strong&gt; weird that we now have this exception to global-actor-means-sendable rule. It feels like quite a corner-case to me. I imagine this situation doesn&#x27;t come up a lot, but could probably help with migrating pre-Swift 6 code? I&#x27;m not sure.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;d classify this as mostly a bug fix-style proposal. It&#x27;s cool to see the compiler getting smarter about value types. I also don&#x27;t use subclasses myself, and I have kinda mixed feelings about the new exception. I guess it must be useful to someone?&lt;&#x2F;p&gt;
&lt;p&gt;For me, the most exciting change is around closures. I would be surprised if you have done significant work with Swift concurrency and have &lt;strong&gt;not&lt;&#x2F;strong&gt; been affected by this. It&#x27;s wonderful to see this restriction lifted. Yet more situations where &lt;code&gt;Sendable&lt;&#x2F;code&gt; is not required!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wrap-up&quot;&gt;Wrap Up&lt;&#x2F;h2&gt;
&lt;p&gt;My original goal was to finish all of these &lt;em&gt;before&lt;&#x2F;em&gt; WWDC. I missed, but hey I wasn&#x27;t too far off! On top of that, there actually is another proposal, &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0428-resolve-distributed-actor-protocols.md&quot;&gt;SE-0428&lt;&#x2F;a&gt;, related to distributed actors. Do check that out if this interests you, but I&#x27;m calling it here. This was a lot of work.&lt;&#x2F;p&gt;
&lt;p&gt;Going through these proposals was incredibly educational for me. I learned way more about each than I probably ever would have otherwise. But, one central theme really stood out. Yes, the language has made enormous strides in improving data race safety. Yes, lots of new syntax and complexity has been introduced. But, for the most part, things have just gotten transparently better. The majority of all this developers will never need to understand. If you are going deep with concurrency in your project, there&#x27;s so many more tools. And if you aren&#x27;t, Swift 6 makes it way easier to side-step the whole thing.&lt;&#x2F;p&gt;
&lt;p&gt;I still don&#x27;t feel like I have a good read on how Swift 6 language mode adoption is going. It &lt;strong&gt;seems&lt;&#x2F;strong&gt; like lots of smaller projects are having success. I&#x27;m quite curious how the process is going for larger projects&#x2F;teams. I&#x27;m particularly interested in seeing the impact on Apple&#x27;s own APIs. I expected a lot more deprecations than we got.&lt;&#x2F;p&gt;
&lt;p&gt;For now, I cannot wait for Swift 6&#x2F;Xcode 16 to be out of beta. I&#x27;m already finding the Swift 5.10 compiler incredibly limiting. There are a lot of new features and capabilities I&#x27;m having a hard time living without. It&#x27;s just a lot better.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0431: `@isolated(any)` Function Types</title>
        <published>2024-07-05T00:00:00+00:00</published>
        <updated>2024-07-05T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0431/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0431/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0431/">&lt;p&gt;Swift uses its type system to model concurrency. An integral part of that system is &lt;strong&gt;functions&lt;&#x2F;strong&gt;. Swift&#x27;s ability to model how functions can behave has expanded pretty dramatically lately. Except, there&#x27;s a substantial gap. We&#x27;ve seen many new facilities for expressing concurrency in function &lt;em&gt;declarations&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0431-isolated-any-functions.md&quot;&gt;proposal&lt;&#x2F;a&gt; adds a new capability to function &lt;em&gt;values&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430: &lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;Every declaration in Swift has some well-defined static isolation. You can &lt;strong&gt;always&lt;&#x2F;strong&gt; determine what the isolation is through code inspection. Closures, however, are special. Their isolation is influenced not just by &lt;em&gt;where&lt;&#x2F;em&gt; they are defined, but also by &lt;em&gt;what&lt;&#x2F;em&gt; they capture.&lt;&#x2F;p&gt;
&lt;p&gt;This sounds complicated. But, in practice you rarely need to understand or even think about these details. All you need to know is this:&lt;&#x2F;p&gt;
&lt;p&gt;The context of a closure definition matters, but that context is also &lt;strong&gt;lost&lt;&#x2F;strong&gt; when you pass it around.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;scheduleSomeWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ f: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; We&amp;#39;ve lost all the static isolation information&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; available where f was defined.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await f()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;defineClosure&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	scheduleSomeWork { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;I&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here, we&#x27;re defining a closure which will run on the &lt;code&gt;@MainActor&lt;&#x2F;code&gt;. But, that isolation is only statically visible in &lt;code&gt;defineClosure&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;At this point, you may be thinking &quot;okaay, but I don&#x27;t get why this is a problem&quot;. And, I&#x27;m not surprised, because there aren&#x27;t too many situations where this will matter. There is, however, one really important place where it makes a big difference: the &lt;code&gt;Task&lt;&#x2F;code&gt; creation APIs.&lt;&#x2F;p&gt;
&lt;p&gt;These create a new top-level asynchronous task. But, which actor should that task run on? This information is encoded in the closure body. When looking at the function&#x27;s &lt;em&gt;type&lt;&#x2F;em&gt;, it&#x27;s completely invisible.&lt;&#x2F;p&gt;
&lt;p&gt;But &lt;code&gt;Task&lt;&#x2F;code&gt; has to start somewhere, so it first begins with a global executor context. And then the very next thing that happens is the closure hops over to the correct actor. This double hop, aside from being inefficient, has a very significant programmer-visible effect: &lt;code&gt;Task&lt;&#x2F;code&gt; does not preserve order.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task { print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task { print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task { print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) }
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The ordering here is not well-defined. I have, personally, found this to be extremely difficult to deal with. It makes it incredibly hard to introduce async contexts incrementally. And honestly it&#x27;s just really confusing.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;This proposal makes it possible to inspect a function value&#x27;s isolation. A closure annotated with &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; can expose its captured isolation &lt;em&gt;at runtime&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;scheduleSomeWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ f: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-begin z-swift&quot;&gt;isolated&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;(&lt;span class=&quot;z-meta z-attribute z-arguments z-swift&quot;&gt;any&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt; (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; closures have properties now!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; isolation &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; f&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;isolation
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; do something with &amp;quot;isolation&amp;quot; I guess?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;When I first saw this, my initial reaction was confusion. Closures have properties? That looks weird. And then I was like, yeah it&#x27;s just a type of course it can have properties. It&#x27;s actually kind of weird they &lt;strong&gt;didn&#x27;t&lt;&#x2F;strong&gt; have properties before. The type of the &lt;code&gt;isolation&lt;&#x2F;code&gt; property matches isolated parameters: &lt;code&gt;(any Actor)?&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Aside from making this property available, this annotation has a small effect on semantics. Adding &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; to a closure means it &lt;strong&gt;must&lt;&#x2F;strong&gt; be called with an &lt;code&gt;await&lt;&#x2F;code&gt;. This is true even it does not cross an isolation boundary.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;I think it was one of those problems that had a bunch of superficial solutions. But, to me, this looks like the exact opposite. This is a deep, fundamental extension to function types.  &lt;strong&gt;A lot&lt;&#x2F;strong&gt; of thought went into this proposal. This could have easily been just &lt;code&gt;@isolated&lt;&#x2F;code&gt;. But, it is leaving the door open for a future revision that can capture not just the isolation value but also its &lt;strong&gt;type&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Undefined &lt;code&gt;Task&lt;&#x2F;code&gt; ordering has caused me &lt;strong&gt;a lot&lt;&#x2F;strong&gt; of issues. It took me a while to even realize it was happening. Thanks to this proposal, &lt;code&gt;Task&lt;&#x2F;code&gt; can now &lt;strong&gt;synchronously&lt;&#x2F;strong&gt; enqueue work onto executors.&lt;&#x2F;p&gt;
&lt;p&gt;However, I really do want to stress that &quot;well-defined&quot; ordering for &lt;code&gt;Task&lt;&#x2F;code&gt; creation is not the same as &quot;FIFO&quot;. A high priority task can still execute before more-recently-created lower-priority tasks.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;You definitely want to adopt this if you are passing a closure parameter directly into one of the standard library&#x27;s task creation APIs. Aside from that use-case, I still don&#x27;t have a great feel for when or why you would choose to annotate a parameter with &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt;. I don&#x27;t think there are any &lt;em&gt;downsides&lt;&#x2F;em&gt; if the closure is already &lt;code&gt;async&lt;&#x2F;code&gt;. And, it does buy you some future flexibility. But, I wouldn&#x27;t recommend it unless you have a clear idea of why it would be necessary.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task { print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task { print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task { print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) }
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;But, while we&#x27;re all thinking on that, let&#x27;s also take a moment to celebrate that when compiled with Swift 6, this now always prints:&lt;&#x2F;p&gt;
&lt;p&gt;&quot;a&quot;
&quot;b&quot;
&quot;c&quot;&lt;&#x2F;p&gt;
&lt;p&gt;🎉&lt;&#x2F;p&gt;
&lt;p&gt;(Update: I always forget that this ordering applies &lt;strong&gt;exclusively&lt;&#x2F;strong&gt; to isolated contexts. Without an actor, &lt;code&gt;Task&lt;&#x2F;code&gt; execution order remains undefined.)&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0430: `sending` parameter and result values</title>
        <published>2024-06-21T00:00:00+00:00</published>
        <updated>2024-06-21T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0430/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0430/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0430/">&lt;p&gt;Everyone seems excited about &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;region-based isolation&lt;&#x2F;a&gt;. And they should be! It is a pretty amazing technology that will reduce the need for &lt;code&gt;Sendable&lt;&#x2F;code&gt; types. However, it does has limitations. It&#x27;s still fairly easy to come up with safe patterns the compiler cannot understand.&lt;&#x2F;p&gt;
&lt;p&gt;This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0430-transferring-parameters-and-results.md&quot;&gt;proposal&lt;&#x2F;a&gt; introduces some new syntax that can really help.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0430: &lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;Region-based isolation is a static code analysis tool. To do the analysis, tools like this need to see all possible code paths. This means they work really well at understanding function &lt;strong&gt;bodies&lt;&#x2F;strong&gt;, but have a hard time with function &lt;strong&gt;calls&lt;&#x2F;strong&gt;. There may be no source code available for a function, so how could it possibly understand what a call does?&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s a trivial example:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; NonSendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someMainFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ ns: NonSendable&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;trySend&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;ns: NonSendable&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; error: sending &amp;#39;ns&amp;#39; can result in data races.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await someMainFunction(ns)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This feels silly. But it totally &lt;em&gt;does&lt;&#x2F;em&gt; make sense, because the compiler cannot know how the &lt;code&gt;ns&lt;&#x2F;code&gt; variable is being used at all possible call sites of &lt;code&gt;trySend&lt;&#x2F;code&gt;. In fact, it&#x27;s completely possible that some are safe while others are not. This is a shame, because we can clearly see that this pattern could at least &lt;em&gt;potentially&lt;&#x2F;em&gt; be safe.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;Lots of code analysis tools have to face these kinds of problems. It is typically tackled by adding metadata somehow so the tools can &quot;see&quot; how the functions can be used. The proposal goes that route too, by introducing the new contextual keyword &lt;code&gt;sending&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;trySend&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;ns: sending NonSendable&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is now ok&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await someMainFunction(ns)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;When you mark parameters &lt;code&gt;sending&lt;&#x2F;code&gt;, you are adding a constraint. At all call sites, you are &lt;em&gt;requiring&lt;&#x2F;em&gt; that the compiler be able to prove the argument can safely cross an isolation domain. This constraint on the outside of the function has the effect of &lt;em&gt;relaxing&lt;&#x2F;em&gt; constraints on the inside. The compiler can now reason about the safety of the parameter because it has more information.&lt;&#x2F;p&gt;
&lt;p&gt;This works in reverse for &lt;code&gt;sending&lt;&#x2F;code&gt; return values.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;getNonSendable&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; sending NonSendable &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;When a return value is marked &lt;code&gt;sending&lt;&#x2F;code&gt; it is &lt;em&gt;adding&lt;&#x2F;em&gt; constraints to the function implementation, but removing them from callers. Values that get returned from such of a function can better participate in region-based isolation without clients having to do anything.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;Before this proposal, there were many patterns that required the use of &lt;code&gt;Sendable&lt;&#x2F;code&gt; types. And that can be really hard to pull off. The &lt;code&gt;sending&lt;&#x2F;code&gt; keyword is a great way to relax these requirements. In fact, many of Swift&#x27;s own concurrency APIs are adopting &lt;code&gt;sending&lt;&#x2F;code&gt;. Of particular note is the closure argument to &lt;code&gt;Task.init&lt;&#x2F;code&gt;. This means its captures no longer need to be &lt;code&gt;Sendable&lt;&#x2F;code&gt;, as long as they can still be proven safe at the point of capture. This is quite something.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;You don&#x27;t have to use, or even understand this keyword to benefit from it. It is giving the language a tool to relax sendability requirements even further. The standard library is adopting it right away. But, if you make an API, especially if it uses &lt;code&gt;@Sendable&lt;&#x2F;code&gt; closures, this is absolutely worth looking at. &lt;code&gt;Sendable&lt;&#x2F;code&gt; is a very high bar, and &lt;code&gt;sending&lt;&#x2F;code&gt; makes it less necessary.&lt;&#x2F;p&gt;
&lt;p&gt;Region-based isolation is really cool, and this makes it much more powerful.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0424: Custom isolation checking for SerialExecutor</title>
        <published>2024-06-16T00:00:00+00:00</published>
        <updated>2024-06-16T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0424/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0424/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0424/">&lt;p&gt;This isn&#x27;t the first time in this series that custom actor executors has come up. If you recall, we got custom actor executors with &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0392-custom-actor-executors.md&quot;&gt;SE-0392&lt;&#x2F;a&gt;. And, just to re-iterate what I said the first time, you do not need to understand what they are to get the idea here.&lt;&#x2F;p&gt;
&lt;p&gt;What do you need to know is that custom actor executors had a limitation related to dynamic isolation. This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0424-custom-isolation-checking-for-serialexecutor.md&quot;&gt;proposal&lt;&#x2F;a&gt; fixes that.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;Custom actor executors help to bridge systems into Swift concurrency that don&#x27;t match its default execution model. And, dynamic isolation is all about exposing runtime isolation state to the compiler. They &lt;em&gt;mostly&lt;&#x2F;em&gt; work together, but there are problems.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s an example of where things are logically correct, but fail at runtime:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;Dispatch&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor Caplin {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; queue &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; DispatchSerialQueue(label: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;C&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;Q&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; num &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; actor isolated state&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; use the queue as this actor&amp;#39;s `SerialExecutor`&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; unownedExecutor: UnownedSerialExecutor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;asUnownedSerialExecutor()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;connect&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; guaranteed to execute on `queue`&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; which is the same as self&amp;#39;s serial executor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assertIsolated() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; CRASH: Incorrect actor executor assumption&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assumeIsolated { actor &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;  &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; CRASH: Incorrect actor executor assumption&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				actor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;num &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;+=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Look at what is going on inside of the &lt;code&gt;connect&lt;&#x2F;code&gt; method. This actor is using a queue as its executor. But, despite clearly being on the queue, both dynamic isolation checks will fail.&lt;&#x2F;p&gt;
&lt;p&gt;(Also, did &lt;em&gt;you&lt;&#x2F;em&gt; know you could just use a queue to back an actor?? And can you believe how easy it is?)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;The proposal extends the &lt;code&gt;SerialExecutor&lt;&#x2F;code&gt; protocol like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; SerialExecutor: Executor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;checkIsolation&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Custom executors can use this facility to implement whatever logic they need to validate isolation. Here&#x27;s what the implementation looks like for &lt;code&gt;DispatchSerialQueue&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; DispatchSerialQueue { 
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;checkIsolated&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; make use of an existing Dispatch API to perform the validation&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		dispatchPrecondition(condition: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;onQueue(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;))
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;I think this will help to make for an even tighter integration between Swift concurrency and whatever custom execution system you&#x27;re using.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;If you are &lt;em&gt;implementing&lt;&#x2F;em&gt; a custom executor, maybe. This could help to improve the integration, internally. But, I don&#x27;t think it will have visible effects for systems that are &lt;em&gt;using&lt;&#x2F;em&gt; the custom executor. I think this is really cool, but ultimately, I think this is a niche within a niche. Most developers will never encounter this.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts</title>
        <published>2024-06-09T00:00:00+00:00</published>
        <updated>2024-06-09T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0423/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0423/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0423/">&lt;p&gt;Lots of people have been turning on strict concurrency and fixing up warnings. But, the reality is, Swift developers will be mixing Swift 6 and non-Swift 6 code for years to come. This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0423-dynamic-actor-isolation.md&quot;&gt;proposal&lt;&#x2F;a&gt; is all about making this simultaneously easier and safer at the same time.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;Have you ever used a protocol before? Apparently they are quite popular. The thing is, despite being very widely used, protocols are actually be quite tricky when it comes to concurrency. And this is especially true when the protocol in question was designed without complete checking in mind.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Defined in some module&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; ViewDelegateProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;respondToUIEvent&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; your code&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyViewController: ViewDelegateProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Warning: @MainActor function cannot satisfy a nonisolated requirement&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;respondToUIEvent&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; 
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There&#x27;s a now pretty-widely known workaround, but it&#x27;s gross. First, you make your method non-isolated to match the protocol, and then you immediately re-establish isolation dynamically.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyViewController: ViewDelegateProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;respondToUIEvent&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assumeIsolated {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;While this works, it has more problems than just the boilerplate.  The &lt;code&gt;respondToUIEvent&lt;&#x2F;code&gt; method now doesn&#x27;t have correct static isolation. That means it can be called from other non-isolated contexts within the class.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;This proposal adds the ability to annotate a conformance with &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt;. When you do this, it has the same runtime effect as the previous workaround, but &lt;em&gt;without&lt;&#x2F;em&gt; sacrificing static isolation.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyViewController: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;preconcurrency&lt;&#x2F;span&gt; ViewDelegateProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;respondToUIEvent&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; no need for nonisolated!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;The need for this nonisolated-assumeIsolated dance is very common, and it&#x27;s just a pain. This proposal makes it so much nicer, and also safer. It actually introduces a number of other safety checks too, that will ensure that the code you think is running on the main thread actually is.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;Concise, convenient, and safer way to use protocols. Helps improve interoperability with non-Swift 6 code. No new syntax. 💯&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0417: Task Executor Preference</title>
        <published>2024-06-08T00:00:00+00:00</published>
        <updated>2024-06-08T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0417/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0417/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0417/">&lt;p&gt;Swift 5.9 introduced a feature, via &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0392-custom-actor-executors.md&quot;&gt;SE-0392&lt;&#x2F;a&gt;, called custom actor executors. This was a low-level concurrency feature that made it possible to control the context an actor uses for execution. You don&#x27;t need to understand the how or even the why here. All that&#x27;s important is to know that without that change, some pre-existing systems could not easily integrate into Swift&#x27;s concurrency model.&lt;&#x2F;p&gt;
&lt;p&gt;And while custom actor executors was important for correctness and interoperability, there were still lingering performance issues it did not address. This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0417-task-executor-preference.md&quot;&gt;proposal&lt;&#x2F;a&gt; completes the story.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0417: Task Executor Preference&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h1 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h1&gt;
&lt;p&gt;Again, we find ourselves coming back to &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0338-clarify-execution-non-actor-async.md&quot;&gt;SE-0338&lt;&#x2F;a&gt;. That proposal, if you recall, changed the behavior of non-isolated async functions such that they always &quot;hop&quot; to a global executor. That is to say, they never tie up an existing actor. But, that guarantee is not free. In fact, ensuring that the current actor executor is never involved can end up being a performance bottleneck. And, if you find yourself in that situation, you have no recourse.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h1&gt;
&lt;p&gt;This proposal expands the concurrency APIs to allow for explicit control over the executor that tasks use. It does this with a new &lt;code&gt;TaskExecutor&lt;&#x2F;code&gt; type. This type is really similar to the &lt;code&gt;SerialExecutor&lt;&#x2F;code&gt; we got with &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0392-custom-actor-executors.md&quot;&gt;SE-0392&lt;&#x2F;a&gt;, but with different semantics. Quoting the proposal:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;The &lt;code&gt;SerialExecutor&lt;&#x2F;code&gt; guarantees mutual exclusion, and the &lt;code&gt;TaskExecutor&lt;&#x2F;code&gt; provides a source of threads.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Here&#x27;s a snippet that shows some of the new API usage:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doSomething&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; 
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task(executorPreference: preferredExecutor) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; doSomething body would execute on &amp;#39;preferredExecutor&amp;#39;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await doSomething()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; doSomething body would execute on &amp;#39;default global concurrent executor&amp;#39;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await doSomething()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Not only can you now control which executor runs this code, but that preference is &quot;sticky&quot;. That means it does not change as additional async function calls are made. In fact, it may not change even if different actors are involved! I was surprised by this one, but it turns out that correct isolation can still be guaranteed as long as actors do not use a custom executor.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h1&gt;
&lt;p&gt;The primary motivation for this was performance. There is a small amount of overhead involved in making calls to async functions, and sometimes that overhead can be significant. This proposal gives Swift developers a first-class tool for better controlling the runtime performance of code without impacting the language&#x27;s safety guarantees.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h1&gt;
&lt;p&gt;This isn&#x27;t a tool you need every day. In fact, the majority of developers will never have a use for this. And that&#x27;s as it should be. This is a low-level feature for performance tuning. My understanding is there are people using Swift on the server that are really looking forward to this one. But, there are also uses for this kind of facility for better handling blocking operations. That&#x27;s something that may come in handy for more mainstream Swift development. Perhaps this will be the basis for improved blocking I&#x2F;O?&lt;&#x2F;p&gt;
&lt;p&gt;Infrastructural investments to keep things fast and flexible, without getting in the way when you don&#x27;t need them. Sounds good to me.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0414: Region based Isolation</title>
        <published>2024-06-07T00:00:00+00:00</published>
        <updated>2024-06-07T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0414/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0414/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0414/">&lt;p&gt;Earlier in this series, I said that there are three proposals that will have a profound effect on how Swift concurrency is used. &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0414-region-based-isolation.md&quot;&gt;This one&lt;&#x2F;a&gt; definitely falls into that category. But, I don&#x27;t think the word &quot;profound&quot; even goes far enough. I&#x27;m not sure how the Swift 6 language mode would be &lt;strong&gt;possible&lt;&#x2F;strong&gt; without region-based isolation.&lt;&#x2F;p&gt;
&lt;p&gt;It rocks.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0414: Region based Isolation&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;The isolation model in Swift 5.10 makes data races impossible. However, it is actually quite conservative. There are many cases where the code is actually race-free, but the compiler lacks the ability to understand it. Consider this trivial example:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; NonSendable {}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doSomething&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;with: NonSendable&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;okButThisIsActuallyFine&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; value &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NonSendable()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; WARNING: Passing argument of non-sendable type &amp;#39;NonSendable&amp;#39; outside&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; of main actor-isolated context may introduce data races&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await doSomething(with: value)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Look closely at that diagnostic message. &quot;&lt;strong&gt;may&lt;&#x2F;strong&gt; introduce data races&quot;, but doesn&#x27;t. The local &lt;code&gt;value&lt;&#x2F;code&gt; is created and then just passed to the non-isolated function, never to be touched again.&lt;&#x2F;p&gt;
&lt;p&gt;To say this situation is common would be a gross understatement. There are &lt;strong&gt;thousands and thousands&lt;&#x2F;strong&gt; of Apple APIs that can be used this way. It could be just as common in your own code too. Making types &lt;code&gt;Sendable&lt;&#x2F;code&gt; can be extremely hard. And, doing all that work here would only serve to satisfy the compiler. There are no races, &lt;strong&gt;provided&lt;&#x2F;strong&gt; you no longer interact with &lt;code&gt;value&lt;&#x2F;code&gt; in an unsafe way.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;This proposal allows the compiler to model how values are accessed such that it can be much less conservative about sendability. This modeling takes into account control statements like &lt;code&gt;if&lt;&#x2F;code&gt; and &lt;code&gt;switch&lt;&#x2F;code&gt; as it tracks values. The implementation is deep and, unsurprisingly, very sophisticated. I&#x27;m not going to get into too much of the details, instead I&#x27;m going to quote the proposal directly:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;The compiler will allow transfers of non-Sendable values between isolation domains where it can prove they are safe and will emit diagnostics when it cannot at potential concurrent access points so that programmers don&#x27;t have to reason through the data flow themselves.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;I&#x27;m going to cherry-pick just one example that I think will give you a good idea of how this will work.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; NonSendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; letSendable: SendableType
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; varSendable: SendableType
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; ns: AnotherNonSendable
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;modifyOnMainActor&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ x: NonSendable&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;    x&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;varSendable &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; SendableType()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;example&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; create value in a non-isolated context&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; x &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NonSendable()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; transfer it to the MainActor despite it being non-Sendable!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await modifyOnMainActor(x)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Subsequent non-isolated accesses to Sendable state are ok!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	_ &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; x&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;letSendable
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ERROR: Use after transfer of mutable field that could&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; race with a write to x.varSendable in modifyOnMainActor.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	_ &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; x&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;varSendable
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is not trivial. But, what is amazing here is how deeply the compiler understands the nature of what&#x27;s actually going on. It lets you get away with a lot! And, when it detects something that it cannot prove safe, the error it produces explains &lt;strong&gt;why&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;The number of correctness, performance, and edge-cases that had to be considered here is staggering. And, this proposal is just the beginning too! There are even more ideas, as well as concrete plans, to further relax the compiler&#x27;s constraints.&lt;&#x2F;p&gt;
&lt;p&gt;(Quick aside: if you decide to read this &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0414-region-based-isolation.md&quot;&gt;proposal&lt;&#x2F;a&gt; yourself, I recommend doing it in stages and when you have mental energy to devote to it. It is no joke.)&lt;&#x2F;p&gt;
&lt;p&gt;I have developed a few axioms when it comes to working with Swift concurrency. One is &quot;Making a class Sendable is rarely the solution&quot; And this is why I love this proposal so much. It is going to magically fix so many struggles people have had with sendability. And it will do it by avoiding the need to make things Sendable.&lt;&#x2F;p&gt;
&lt;p&gt;When I first began thinking about this, I was worried that it would have a negative impact on our ability to reason about isolation. But, now that I&#x27;ve read through the proposal and tried it a bit myself, I think I had it completely backwards. The compiler now feels like it truly &lt;strong&gt;understands&lt;&#x2F;strong&gt; how the code works. And that allows it to produce even better feedback, which in turn, helps you form a good mental model about what&#x27;s going on.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;You bet your ass it will. I have a feeling many people have poured a lot of effort into making types Sendable that have zero need to be thread-safe. This proposal will just make much of that disappear. But, you learned a lot doing it! Now, allow yourself some joy in deleting that code.&lt;&#x2F;p&gt;
&lt;p&gt;I think the compiler team should be damn proud of this one.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol</title>
        <published>2024-05-13T00:00:00+00:00</published>
        <updated>2024-05-13T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0421/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0421/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0421/">&lt;p&gt;Have you ever wanted to use &lt;code&gt;some AsyncSequence&lt;&#x2F;code&gt;? I certainly have. The inability to hide the implementation type of an &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt; is an enormous pain. It is particularly problematic when trying to replace Combine with &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-async-algorithms&quot;&gt;AsyncAlgorithms&lt;&#x2F;a&gt;. There are some libraries out there that help, but I&#x27;d really like this problem to just disappear.&lt;&#x2F;p&gt;
&lt;p&gt;This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0421-generalize-async-sequence.md&quot;&gt;proposal&lt;&#x2F;a&gt; &lt;strong&gt;finally&lt;&#x2F;strong&gt; addresses this! And, on top of that, it fixes a correctness issue, makes &lt;code&gt;AsyncIteratorProtocol&lt;&#x2F;code&gt; more efficient, and makes it easier to use non-Sendable types. Let&#x27;s go!&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;effect-polywhatism&quot;&gt;Effect Polywhatism?&lt;&#x2F;h2&gt;
&lt;p&gt;The title of this proposal doesn&#x27;t pull any punches. I had to think for quite a bit to really understand what it was trying to say. I wanted to take a little detour to help navigate this.&lt;&#x2F;p&gt;
&lt;p&gt;To get this, you have understand what &quot;effect&quot; means in the context of a programming language. We talk a lot about &quot;types&quot; when working with Swift. But most types, like &quot;Int&quot; or &quot;UIViewController&quot; aren&#x27;t sufficient to capture all things a program can do. I always think about types as describing values and instances - things. Effects describe the stuff that could happen while working with those things. That&#x27;s not a small set. But, many languages, Swift included, formalize a teeny tiny set of the stuff that could happen. They are often specifically attached to functions.&lt;&#x2F;p&gt;
&lt;p&gt;Here, the two relevant effects that Swift models are errors and concurrency. You can tell these concepts are formalized, because they have built-in support in the language, via the &lt;code&gt;throws&lt;&#x2F;code&gt; and &lt;code&gt;async&lt;&#x2F;code&gt; keywords. And you can also see how they are integrated into the type system, because both are part of a function&#x27;s signature.&lt;&#x2F;p&gt;
&lt;p&gt;If you learned about object-oriented programming, you may have run into the term &quot;polymorphism&quot; before. It just means that one instance could potentially have multiple forms. A &lt;code&gt;UIViewController&lt;&#x2F;code&gt; is also an &lt;code&gt;NSObject&lt;&#x2F;code&gt;. But here, the multiple forms is not related to the instance type, but the kinds of errors it can produce and how it can be isolated.&lt;&#x2F;p&gt;
&lt;p&gt;Both errors and isolation have been generalized because they now can work with all possible values of these things. That generalization has made those elements polymorphic.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m not terribly good at programming language theory. And I&#x27;m also not 100% sure isolation is technically considered an effect. But I tried.&lt;&#x2F;p&gt;
&lt;p&gt;Ok, enough of this nonsense.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;The &lt;code&gt;some&lt;&#x2F;code&gt; keyword is used to hide the implementation type from API clients. It is used all over the place, but is particularly useful for systems that rely on lots of type transformations. Two familiar examples are SwiftUI and Combine. For this to work, the involved protocols need to declare primary associated types. &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt; doesn&#x27;t do that.&lt;&#x2F;p&gt;
&lt;p&gt;This can result in fragile function signatures that spill your internal abstractions all over the place. They also just look terrifying. I stole this from an issue related to the problem:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;notifications&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ name1: Notification&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;Name, _ name2: Notification&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;Name&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; AsyncMerge2Sequence&amp;lt;AsyncMapSequence&amp;lt;NotificationCenter.Notifications, Notification.Name&amp;gt;, AsyncMapSequence&amp;lt;NotificationCenter.Notifications, Notification.Name&amp;gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;😵 This is a non-starter if you are making an API.&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s also an issue with &lt;code&gt;AsyncIteratorProtocol&lt;&#x2F;code&gt; related to correctness. The most natural use of the type doesn&#x27;t work in actor-isolated contexts unless it is also &lt;code&gt;Sendable&lt;&#x2F;code&gt;. This is rarely the case in practice. An earlier build of Swift 5.10 even detected and warned about this situation. But, it was annoying to address. And because the team knew they were going to fix it anyways, they suppressed the warning. This makes a lot of sense, but the whole thing is definitely not ideal.&lt;&#x2F;p&gt;
&lt;p&gt;A third problem is that an &lt;code&gt;AsyncSeqeuence&lt;&#x2F;code&gt; of non-Sendable elements cannot be used when globally-isolated. I kind of glossed over on first read, but then I saw a &lt;a href=&quot;https:&#x2F;&#x2F;mastodon.world&#x2F;@jonduenas&#x2F;112424678933077199&quot;&gt;question&lt;&#x2F;a&gt; about it. This is one of those confusing things that feels like it should just work.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;The proposal addresses all of these problems simultaneously by modifying the API like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; AsyncIteratorProtocol&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;Element, Failure&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt; {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-begin z-swift&quot;&gt;available&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;(&lt;span class=&quot;z-meta z-attribute z-arguments z-swift&quot;&gt;SwiftStdlib &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;6&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, &lt;span class=&quot;z-keyword z-operator z-arithmetic z-swift&quot;&gt;*&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;mutating&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;next&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;isolation actor: isolated (any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;?) async throws&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;Failure&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Element?
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This new function makes use of &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0413-typed-throws.md&quot;&gt;typed throws&lt;&#x2F;a&gt; to support the primary associated types. And, it fixes the isolation correctness issue by adding an isolated parameter. Note that parameter type, which was made possible by &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420&lt;&#x2F;a&gt;! And, if that wasn&#x27;t enough on its own, this &lt;strong&gt;also&lt;&#x2F;strong&gt; makes the problem with non-Sendable elements and global actors just go away.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;This is the proposal that really makes &lt;code&gt;AsyncSequence&lt;&#x2F;code&gt; feel complete. The inability to use &lt;code&gt;some AsyncSequence&lt;&#x2F;code&gt; was a major problem for building APIs. I expect we&#x27;re going to see much more wide-spread adoption of both it and &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-async-algorithms&quot;&gt;AsyncAlgorithms&lt;&#x2F;a&gt; because of this.&lt;&#x2F;p&gt;
&lt;p&gt;(Update! I have discovered that &lt;code&gt;some AsyncSequence&lt;&#x2F;code&gt; requires the latest OSes. Womp womp.)&lt;&#x2F;p&gt;
&lt;p&gt;The fact that they were able to use isolated parameters to both fix a correctness issue and also make iteration more efficient is just awesome.&lt;&#x2F;p&gt;
&lt;p&gt;Unfortunately, to maintain source compatibility, getting this fix is opt-in for all &lt;code&gt;AsyncIteratorProtocol&lt;&#x2F;code&gt; implementations. And, that won&#x27;t be pretty if you want to maintain compatibility with Swift 5. I think it&#x27;s going to have to look something like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; MyIterator: AsyncIteratorProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; swift(&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;6&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;mutating&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;next&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;isolation actor: isolated (any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;? = #isolation) async throws&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;Failure&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Element? &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; get next value&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;else&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;mutating&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;next&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async throws &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Element? &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; do the exact same thing here too&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#endif
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;If you have any &lt;code&gt;AsyncIteratorProtocol&lt;&#x2F;code&gt; implementations or want to use &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-async-algorithms&quot;&gt;AsyncAlgorithms&lt;&#x2F;a&gt;, for sure. This is going to be a big one for everyone trying to find a way to migrate away from Combine. Though, there are still plenty of ergonomic and functional issues around moving away from Combine completely.&lt;&#x2F;p&gt;
&lt;p&gt;But, I think this is going to help a lot. I&#x27;ve been looking forward to it for a long time.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0420: Inheritance of actor isolation</title>
        <published>2024-05-09T00:00:00+00:00</published>
        <updated>2024-05-09T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0420/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0420/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0420/">&lt;p&gt;Swift&#x27;s concurrency system seems incredibly simple &lt;em&gt;at first&lt;&#x2F;em&gt;. But, eventually, we all discover that there&#x27;s actually a tremendous amount of learning required to use concurrency successfully. And, one of the most challenging things is there&#x27;s also quite a bit to unlearn too. Swift concurrency has many features that &lt;em&gt;feel&lt;&#x2F;em&gt; familiar, but actually &lt;em&gt;work&lt;&#x2F;em&gt; very differently.&lt;&#x2F;p&gt;
&lt;p&gt;This &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0420-inheritance-of-actor-isolation.md&quot;&gt;proposal&lt;&#x2F;a&gt; is going to help.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-backstory&quot;&gt;The Backstory&lt;&#x2F;h2&gt;
&lt;p&gt;There was a proposal, &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0338-clarify-execution-non-actor-async.md&quot;&gt;SE-0338&lt;&#x2F;a&gt;, that became a little infamous. It included a major change to how async function calls work. Before this, a non-isolated async function would not change isolation. Any existing isolation would just stick.&lt;&#x2F;p&gt;
&lt;p&gt;Consider this code:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;nonIsolatedFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;updateUI&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await nonIsolatedFunction()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Prior to Swift 5.7, despite &lt;code&gt;nonIsolatedFunction&lt;&#x2F;code&gt; being async and requiring the &lt;code&gt;await&lt;&#x2F;code&gt; keyword to call, there would be &lt;strong&gt;no change to isolation&lt;&#x2F;strong&gt;. This allowed the caller of an non-isolated async function to control isolation is a very dynamic way. In the case above, &lt;code&gt;nonIsolatedFunction&lt;&#x2F;code&gt; would actually be on the &lt;code&gt;MainActor&lt;&#x2F;code&gt; when called from &lt;code&gt;updateUI&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;It was changed with SE-0338, and for good reason. It did have performance implications. But, the real issue was the dynamic behavior it allowed was unintended. The compiler just cannot reason about isolation in such situations. And, all the safety Swift concurrency brings depends on that reasoning.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;However!&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;SE-0338 was &lt;em&gt;also&lt;&#x2F;em&gt; infamous for good reason. We are used to callers being in control. That&#x27;s how it works with threads, Dispatch, and pretty much every other concurrency system that exists aside from Swift. There was Swift code out there that felt right, worked right, but was now suddenly very wrong because it relied on this dynamic isolation inheritance that was never really supposed to be happening in the first place. Addressing these problems was not always trivial. It typically involves &lt;a href=&quot;&#x2F;isolated-parameters&quot;&gt;isolated parameters&lt;&#x2F;a&gt; or even resorting to &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift&#x2F;blob&#x2F;main&#x2F;docs&#x2F;ReferenceGuides&#x2F;UnderscoredAttributes.md#_unsafeinheritexecutor&quot;&gt;unsafe attributes&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;With all that set up, we can now finally get to the actual problems this proposal addresses. There are two, and the first is tiny. Isolated parameters weren&#x27;t able to capture the concept of non-isolation. You must pass in an actor here, but there isn&#x27;t an &lt;code&gt;actor&lt;&#x2F;code&gt; instance that represents &quot;non-isolated&quot;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;isolatedTo actor: isolated any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; how do I make this non-isolated?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await doStuff(isolatedTo: ???)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The second problem is the language had no convenient way to capture the current isolation. You can do this manually, but it involves boilerplate that every call site would have to deal with.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doLotsOfStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await doStuff(isolatedTo: MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await doStuff(isolatedTo: MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await doStuff(isolatedTo: MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;shared)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;Fixing the inability to express &quot;non-isolated&quot; was easy. Isolated parameters can now accept optional arguments.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;isolatedTo actor: isolated (any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;?) async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is non-isolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await doStuff(isolatedTo: &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And for capturing the current isolation, default arguments can now use &lt;code&gt;#isolation&lt;&#x2F;code&gt;, a new &quot;special expression form&quot;. This will capture the static isolation of the call site. It&#x27;s a lot like &lt;code&gt;#line&lt;&#x2F;code&gt; or &lt;code&gt;#file&lt;&#x2F;code&gt;, and the usage pattern is very similar. This &lt;code&gt;#isolation&lt;&#x2F;code&gt; expression has the type &lt;code&gt;(any Actor)?&lt;&#x2F;code&gt;. And that is necessary, because it is always possible for a call site to be non-isolated.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;isolatedTo actor: isolated (any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;? = #isolation) async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doLotsOfStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await doStuff()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await doStuff()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await doStuff()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That definition is quite something. But, the transition from caller to callee is guaranteed to not suspend, and that is entirely controllable by the &lt;code&gt;doStuff&lt;&#x2F;code&gt; definition. And with this generalization, they can be used in all contexts with zero boilerplate.&lt;&#x2F;p&gt;
&lt;p&gt;You might think, as I did, that you can only use &lt;code&gt;#isolation&lt;&#x2F;code&gt; as a default argument for isolated parameters. But that&#x27;s not the case! It can be used for regular parameters too. I haven&#x27;t yet thought up a great use-case for doing that, but it&#x27;s worthwhile at least knowing about.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;There are three proposals that will, in my opinion, have a profound effect on how Swift concurrency is used. The two changes here seem small. But, they take an already powerful feature and make it much nicer and more general.&lt;&#x2F;p&gt;
&lt;p&gt;Something not everyone realizes is isolated parameters prevent suspension at the call site. In fact, I was so surprised when I first learned about this I have to quote the proposal:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Avoiding extra suspensions from actor-isolated code can also be semantically important because code from other tasks can interleave on the actor during suspensions, potentially changing the values stored in isolated storage; &lt;strong&gt;this is guaranteed not to happen at the moments of call and return between functions with the same isolation&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;This is what makes isolated parameters so powerful. They make it possible to do work synchronously on function call. Now you can do that without having to clutter up the call site.&lt;&#x2F;p&gt;
&lt;p&gt;I do have some complaints, though. Sometimes, like in the case of &lt;code&gt;withCheckedContinuation&lt;&#x2F;code&gt;, the caller &lt;strong&gt;must&lt;&#x2F;strong&gt; be aware of this no-suspension guarantee for it to be useful. This proposal makes the lack of suspension here just as non-obvious. I kind of want there to be some kind of special keyword to make this crystal clear.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; imaginary syntax&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await? withCheckedContinuation { continuation &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; perform some work that must be done synchronously&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Anyways, I&#x27;ll definitely take it.&lt;&#x2F;p&gt;
&lt;p&gt;Update: I have discovered that &lt;code&gt;with(Checked)Continuation&lt;&#x2F;code&gt; has been reimplemented to use this instead of &lt;code&gt;@_unsafeInheritExecutor&lt;&#x2F;code&gt; in the standard library!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;Directly? It&#x27;s possible. If you have run into cases where SE-0338 caused you problems, this could help. I certainly have hit &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;AsyncXPCConnection&quot;&gt;situations&lt;&#x2F;a&gt; where I was unable to achieve correct functionality without resorting to &lt;code&gt;@_unsafeInheritExecutor&lt;&#x2F;code&gt;. I think I could have succeeded with just an isolated parameter in that case. But, with this proposal, I&#x27;m now certain I can.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve said before that, despite being powerful, isolated parameters just aren&#x27;t a thing you need very often. I have found uses, and I know others have too. I just don&#x27;t think it&#x27;s going to come up too often in day-to-day app development. But, if you happen to have a need for them, this makes them a lot better.&lt;&#x2F;p&gt;
&lt;p&gt;Overall, this one is going to be more infrastructural. But, it &lt;em&gt;will&lt;&#x2F;em&gt; play a central role in the very next change, which is another big one.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0418: Inferring Sendable for methods and key path literals</title>
        <published>2024-05-03T00:00:00+00:00</published>
        <updated>2024-05-03T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-0418/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-0418/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-0418/">&lt;p&gt;This is a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0418-inferring-sendable-for-methods.md&quot;&gt;dense proposal&lt;&#x2F;a&gt;, covering a lot of tricky stuff around the relationships between functions, key paths, and sendability. I&#x27;m going to go out on a limb here and say that the changes here won&#x27;t affect the majority of Swift users. However, the changes are still welcome!&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;The first part of this proposal addresses an annoying loss of sendability around so-called unapplied functions. Here&#x27;s the idea:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; SendableType: Sendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;someMethod&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;test&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; value &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; SendableType()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; WARNING: Converting non-sendable function value to&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; &amp;#39;@Sendable () async -&amp;gt; Void&amp;#39; may introduce data races&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	Task&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;, Never&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;(operation: value&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;someMethod)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This warning doesn&#x27;t make sense - everything here is Sendable and should be allowed.&lt;&#x2F;p&gt;
&lt;p&gt;The second problem is related to key path literals. I&#x27;m just going to steal the example right from the proposal, because it&#x27;s complex.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Info: Hashable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; some information about the user&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; Entry {}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; User {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;subscript&lt;&#x2F;span&gt;(info: Info) &lt;span class=&quot;z-keyword z-operator z-custom z-binary z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Entry {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; find entry based on the given info&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; WARNING: Cannot form key path that captures non-sendable type &amp;#39;Info&amp;#39;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; entry: KeyPath&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;User, Entry&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; \&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;[Info()]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The issue here is that key path literals, the &lt;code&gt;\.[Info()]&lt;&#x2F;code&gt; in this case, must always capture only &lt;code&gt;Sendable&lt;&#x2F;code&gt; types. Since &lt;code&gt;Info&lt;&#x2F;code&gt; is not &lt;code&gt;Sendable&lt;&#x2F;code&gt;, this cannot be done warning-free.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;In the case of unapplied functions, the compiler is now just going to chill out. It will assume that functions of Sendable types are also themselves Sendable. Very reasonable fix.&lt;&#x2F;p&gt;
&lt;p&gt;The key path changes are more involved and have some subtlety to them. But, the upshot is that the sendability of the key paths will match the types involved. Sendable types =&amp;gt; Sendable key path. Non-Sendable types =&amp;gt; non-Sendable key path. A very natural solution.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;I think this is just an example of cleaning up some loose ends. Once you see this proposal, it kinda becomes surprising things weren&#x27;t &lt;strong&gt;already&lt;&#x2F;strong&gt; working this way.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;If you were applying &lt;code&gt;@Sendable&lt;&#x2F;code&gt; to functions, which I have seen, you might run into problems here. But you were probably only doing that to workaround the issues this proposal fixes. So, yes, it could potentially impact your code, but the fix is straightforward and just makes it simpler.&lt;&#x2F;p&gt;
&lt;p&gt;I &lt;strong&gt;think&lt;&#x2F;strong&gt; the key path changes will only affect you if you have some fairly advanced concurrency&#x2F;key path usage. And, I have no doubt those people exist. This will make stuff just work!&lt;&#x2F;p&gt;
&lt;p&gt;Overall, two thumbs up! This proposal just makes concurrency better.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Is Dynamic Isolation Bad?</title>
        <published>2024-04-18T00:00:00+00:00</published>
        <updated>2024-04-18T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/dynamic-isolation/"/>
        <id>https://massicotte.org/dynamic-isolation/</id>
        
        <content type="html" xml:base="https://massicotte.org/dynamic-isolation/">&lt;p&gt;I got a little worked up the other day about, shocking I know, Swift concurrency. So I &lt;a href=&quot;https:&#x2F;&#x2F;mastodon.social&#x2F;@mattiem&#x2F;112285978801305971&quot;&gt;posted&lt;&#x2F;a&gt; this:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;MainActor.run is almost &lt;em&gt;never&lt;&#x2F;em&gt; the right solution. You want to define your isolation statically on the type, via a global actor annotation.&lt;&#x2F;p&gt;
&lt;p&gt;Dynamic isolation is an escape hatch, and it should set off alarm bells every time.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;But, this take is lacking a lot of nuance. Luckily, &lt;a href=&quot;https:&#x2F;&#x2F;mastodon.social&#x2F;@cocoaphony&#x2F;112286687250476162&quot;&gt;Rob Napier&lt;&#x2F;a&gt; didn&#x27;t let me get away with it. Thanks largely to his feedback, I&#x27;ve thought about it more and I feel like this topic is worth a deeper discussion.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;static-isolation&quot;&gt;Static isolation&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a href=&quot;&#x2F;into-to-isolation&quot;&gt;Isolation&lt;&#x2F;a&gt; in Swift can take two forms. Keywords like &lt;code&gt;nonisolated&lt;&#x2F;code&gt;, &lt;code&gt;isolated&lt;&#x2F;code&gt;, &lt;code&gt;actor&lt;&#x2F;code&gt; and global actor annotations are all static. They are ways of expressing your isolation requirements to the compiler via the type system.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; SomeMainActorOnlyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; allowed only if the compiler can prove this will be on the MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; b &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; SomeMainActorOnlyClass()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Modelling your code&#x27;s isolation requirements statically has a lot of benefits. You aren&#x27;t one unexpected code path away from a crash. You no longer need to check the documentation to find out if some type is ok to use on a background thread. Or if some callback needs to happen on the main thread. These kinds of issues, which have been a major source of bugs for Apple platform developers for &lt;strong&gt;decades&lt;&#x2F;strong&gt;, are suddenly impossible. That&#x27;s quite something.&lt;&#x2F;p&gt;
&lt;p&gt;But.&lt;&#x2F;p&gt;
&lt;p&gt;Going from nothing to compiler-guaranteed thread-safety cannot happen overnight. There&#x27;s an &lt;strong&gt;enormous&lt;&#x2F;strong&gt; amount of pre-concurrency code out there. To help deal with this reality gracefully, Swift offers a variety of tools. One is a way to express isolation dynamically.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;dynamic-isolation&quot;&gt;Dynamic isolation&lt;&#x2F;h2&gt;
&lt;p&gt;Locks, queues - these are all things that require correct coordination at runtime to keep things working right.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this depends on the runtime instance of queue&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Dynamic isolation will feel familiar. It requires the use of runtime constructs, in the form of methods on an actor. Here are some examples:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assumeIsolated {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; promise the compiler this bit of code is&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; actually already on the MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; add a runtime check to guarantee that the actor-ness is&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; what you expect&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;preconditionIsolated()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;run {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; run a chunk of synchronous code, hopping over&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; to the actor if needed&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;mainactor-run&quot;&gt;MainActor.run&lt;&#x2F;h2&gt;
&lt;p&gt;I think both &lt;code&gt;assumeIsolated&lt;&#x2F;code&gt; and &lt;code&gt;preconditionIsolated&lt;&#x2F;code&gt; are great! They are very useful for interfacing with code that either does not or cannot express the isolation you want.&lt;&#x2F;p&gt;
&lt;p&gt;But, my post from above was really aimed at &lt;code&gt;MainActor.run&lt;&#x2F;code&gt;. And I singled it out precisely because of its similarity to other synchronization mechanisms. I&#x27;ve run across a lot of code that looks like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; SomeClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; newValue &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await doAsyncWork()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;run {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; newValue
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This pattern probably &lt;strong&gt;feels&lt;&#x2F;strong&gt; really familiar, because it is so close to what you might do with a &lt;code&gt;DispatchQueue&lt;&#x2F;code&gt;. I want to be really clear - that alone is a valid reason for doing this!&lt;&#x2F;p&gt;
&lt;p&gt;The problem is, just like all forms of runtime synchronization, the compiler cannot help you. Contrast it with this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; SomeClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;state &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; await doAsyncWork()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Not only this this code a lot simpler, it is also almost certainly a better reflection of reality. It is &lt;em&gt;possible&lt;&#x2F;em&gt; that the &lt;code&gt;state&lt;&#x2F;code&gt; variable is the only thing that needs to be mutated on the main thread. But I think that situation is quite rare. Most likely, you just have a type that only makes sense to interact with on the main thread. You tell the compiler this, and boom, it will enforce that.&lt;&#x2F;p&gt;
&lt;p&gt;That enforcement is a double-edged sword.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;incremental-adoption&quot;&gt;Incremental adoption&lt;&#x2F;h2&gt;
&lt;p&gt;Making just one type &lt;code&gt;@MainActor&lt;&#x2F;code&gt; can result in cascade of errors at all usage sites where the compiler now cannot provide that &lt;code&gt;MainActor&lt;&#x2F;code&gt; guarantee. This virality can make it really hard to incrementally adopt concurrency with targeted changes. Perhaps that&#x27;s not too big a deal for smaller code bases&#x2F;teams, but I bet this is a killer for big projects. So what do you do?&lt;&#x2F;p&gt;
&lt;p&gt;You make use of dynamic isolation to contain the spread!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; NewlyMainActored() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; ProbablyShouldJustBeMainActorEventually() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this one stops the MainActor spread&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withoutIsolation&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assumeIsolated {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; obj &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NewlyMainActored()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; so does this&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;asyncWithoutIsolation&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		await MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;run {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; obj &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NewlyMainActored()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; not as bad as the whole type, but still possibly disruptive&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;withIsolation&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; obj &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NewlyMainActored()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This right here is probably the single best reason to use dynamic isolation. It is a very good tool for incremental adoption.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;atomicity&quot;&gt;Atomicity&lt;&#x2F;h2&gt;
&lt;p&gt;The &lt;code&gt;run&lt;&#x2F;code&gt; method has another really useful trick up its sleeve, which Rob &lt;a href=&quot;https:&#x2F;&#x2F;gist.github.com&#x2F;rnapier&#x2F;f513a58ec982ff4738b25afa465f6dda&quot;&gt;zeroed in&lt;&#x2F;a&gt; on immediately. It&#x27;s a handy way to execute multiple synchronous calls without the risk of suspension. I&#x27;m just going to steal his example:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; atomic&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;run {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	obj&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;methodA()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	obj&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;methodB()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; definitely not atomic&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await obj&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;methodA()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await obj&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;methodB()   &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; There is a suspension point between A and B&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; equivalent to .run&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await Task { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	m&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;methodA()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	m&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;methodB()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;value
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And yeah, sure, it might make more sense to combine these two methods into one call. But, this is a contrived example, and that could be easier said than done. This kind of usage is also totally valid. Further, I think it is preferable over the equivalent &lt;code&gt;Task&lt;&#x2F;code&gt; version. I find it much clearer, especially when you have to rely on &lt;code&gt;.value&lt;&#x2F;code&gt; for a &lt;code&gt;Task&lt;&#x2F;code&gt; that doesn&#x27;t return anything.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;all-part-of-the-journey&quot;&gt;All part of the journey&lt;&#x2F;h2&gt;
&lt;p&gt;I heard a funny quip that says any time you see a headline ending in question, the answer is always no. I&#x27;m quite pleased to follow that pattern. No, dynamic isolation is &lt;strong&gt;not bad&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But, I think we can also agree that static isolation is &lt;em&gt;preferable&lt;&#x2F;em&gt;. If you find yourself using dynamic isolation solely because it is a familiar pattern, that&#x27;s something to think about more deeply. Static isolation is a safer, clearer way to express what you need. That doesn&#x27;t mean you can always or even should start with it. Adopting concurrency will be a long process. Dynamic isolation is a very handy tool for getting there, I just don&#x27;t think it should typically be an end-state.&lt;&#x2F;p&gt;
&lt;p&gt;Everyone say it with me now: &quot;It Depends!&quot;.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0411: Isolated default value expressions</title>
        <published>2024-04-16T00:00:00+00:00</published>
        <updated>2024-04-16T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-411/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-411/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-411/">&lt;p&gt;In my &lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;first post&lt;&#x2F;a&gt; in this series, I said that Swift 5.10 can correctly find all possible sources of data races. But, I kind of lied! It turns out there is actually a pretty significant isolation hole in that version. But it gets a little more complicated, which I&#x27;ll get to.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-401&quot;&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;SE-0411: Isolated default value expressions&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;There are two issues with default value expressions in Swift 5.10. The first is that default arguments are overly-restrictive. This code, from the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0411-isolated-default-values.md&quot;&gt;proposal&lt;&#x2F;a&gt;, makes sense and is in fact safe. But the compiler will not allow it.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; C {}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;c: C &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; C(&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; error: Call to main actor-isolated initializer &amp;#39;init()&amp;#39; in a synchronous nonisolated context&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;useFromMainActor&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	f()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;All this stuff is MainActor, so there&#x27;s no actual issue here. I have run into this problem myself.&lt;&#x2F;p&gt;
&lt;p&gt;The second problem is related to stored properties of types. This one actually can result in incorrect isolation. Again, adapted from the proposal:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;requiresMainActor&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; C {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; x1 &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; requiresMainActor()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; but we aren&amp;#39;t on the MainActor here???&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I think it is &lt;em&gt;probably&lt;&#x2F;em&gt; not common usage pattern. I imagine it is rare to have a type with properties that use different global actors. Regardless of how wide-spread this is, I&#x27;m really happy to see the problem is being addressed.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;This is another case where the proposal&#x27;s solution is very straightforward. The compiler is now just going to do the right thing. For function arguments, this is going to make code that should work warning&#x2F;error-free.&lt;&#x2F;p&gt;
&lt;p&gt;What the right thing actually is, in the case of mixed-global actor initializers, is slightly weird. The compiler will only allow default initializers to run in init methods that match their actor isolation. This makes sense, but makes the following situation possible:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;requiresMainActor&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; C {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; x1 &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; requiresMainActor()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ERROR: &amp;#39;self.x1&amp;#39; is not initialized&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The compiler warning doesn&#x27;t include information on &lt;strong&gt;why&lt;&#x2F;strong&gt; the value isn&#x27;t initialized, and that could be confusing. But, I still think this is a reasonable solution to what I hope is an unusual arrangement.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;This proposal really just makes stuff work like it should. This could break currently-unsafe code, but that is exactly what Swift concurrency is supposed to do.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;While writing this, I was experimenting with some code to show off a few different example of issues. But, no matter how hard I tried, I was unable to reproduce these warnings&#x2F;errors. I was mystified, because I was using the example code from the proposal. I also remembered a spot in my own code where this was a problem.&lt;&#x2F;p&gt;
&lt;p&gt;Well! It turns out that with Swift 5.10, turning on complete concurrency checking has the side-effect of also enabling this feature. This was &lt;strong&gt;not&lt;&#x2F;strong&gt; the case for Swift 5.9. So, it&#x27;s possible you already have this feature enabled and don&#x27;t even know it.&lt;&#x2F;p&gt;
&lt;p&gt;I think you could make the case that turning this on &lt;em&gt;without&lt;&#x2F;em&gt; using complete checking makes sense. It could catch a bug, and can get you past some compiler errors when introducing actor annotations. Maaaaybe.&lt;&#x2F;p&gt;
&lt;p&gt;Most likely you can just ignore this one and enjoy the additional safety.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SE-0401: Remove Actor Isolation Inference caused by Property Wrappers</title>
        <published>2024-04-09T00:00:00+00:00</published>
        <updated>2024-04-09T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/concurrency-swift-6-se-401/"/>
        <id>https://massicotte.org/concurrency-swift-6-se-401/</id>
        
        <content type="html" xml:base="https://massicotte.org/concurrency-swift-6-se-401/">&lt;p&gt;With Swift 5.10, the compiler can correctly find all possible sources of data races. But, there are still quite a few sharp edges and usability issues with concurrency. Swift 6 is going to come with &lt;strong&gt;many&lt;&#x2F;strong&gt; language changes that will help. In fact, there are currently 13 evolution proposals and 4 pitches that are either directly or indirectly related to concurrency. That&#x27;s a lot!&lt;&#x2F;p&gt;
&lt;p&gt;The thing is, I often find it quite challenging to read these proposals. It can be really difficult for me to go from the abstract language changes to how them will impact concrete problems I&#x27;ve faced. Honestly, sometimes I don&#x27;t even fully get the language changes! But, I&#x27;m not going to let that stop me 😬&lt;&#x2F;p&gt;
&lt;p&gt;So, I&#x27;m going to make an attempt to cover all of the &lt;em&gt;accepted&lt;&#x2F;em&gt; evolution proposals. I&#x27;m not going to go too deep. Just a little introduction to the problem and a few examples to highlights the syntax changes. Of course, I&#x27;ll also throw in a little commentary. Each of these proposals probably deserves its own in-depth post. But, I&#x27;m getting tired just thinking about that.&lt;&#x2F;p&gt;
&lt;p&gt;Index:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;SE-0401: Remove Actor Isolation Inference caused by Property Wrappers&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-411&quot;&gt;SE-0411: Isolated default value expressions&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0414&quot;&gt;SE-0414: Region based Isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0417&quot;&gt;SE-0417: Task Executor Preference&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0418&quot;&gt;SE-0418: Inferring Sendable for methods and key path literals&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0420&quot;&gt;SE-0420: Inheritance of actor isolation&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0421&quot;&gt;SE-0421: Generalize effect polymorphism for AsyncSequence and AsyncIteratorProtocol&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0423&quot;&gt;SE-0423: Dynamic actor isolation enforcement from non-strict-concurrency contexts&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0424&quot;&gt;SE-0424: Custom isolation checking for SerialExecutor&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0430&quot;&gt;SE-0430:&lt;code&gt;sending&lt;&#x2F;code&gt; parameter and result values&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;SE-0431: &lt;code&gt;@isolated(any)&lt;&#x2F;code&gt; Function Types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;&#x2F;concurrency-swift-6-se-0434&quot;&gt;SE-0434: Usability of global-actor-isolated types&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;Here&#x27;s an example from the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;swiftlang&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0401-remove-property-wrapper-isolation.md&quot;&gt;proposal&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; MyView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; Note that `StateObject` has a MainActor-isolated `wrappedValue`&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;StateObject&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; model &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; Model()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;H&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;model&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;onAppear { viewAppeared() }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; This function is inferred to be `@MainActor`&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;viewAppeared&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		updateUI()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;updateUI&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-block z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-block z-begin z-swift&quot;&gt;&#x2F;*&lt;&#x2F;span&gt; do stuff here &lt;span class=&quot;z-punctuation z-definition z-comment z-block z-end z-swift&quot;&gt;*&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The really important thing to note is this &lt;code&gt;View&lt;&#x2F;code&gt; is non-isolated. This should be setting off &lt;a href=&quot;https:&#x2F;&#x2F;massicotte.org&#x2F;concurrency-swift-6-se-401&#x2F;swiftui-isolation&quot;&gt;alarm bells&lt;&#x2F;a&gt;! And yet, somehow &lt;code&gt;viewAppeared&lt;&#x2F;code&gt; really is becoming &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated?&lt;&#x2F;p&gt;
&lt;p&gt;Before this proposal, property wrappers could change the isolation of their enclosing type. This is &lt;strong&gt;really&lt;&#x2F;strong&gt; weird! It&#x27;s also very hard to predict how it will affect your code. Changing that &lt;code&gt;StateObject&lt;&#x2F;code&gt; to a &lt;code&gt;State&lt;&#x2F;code&gt; will introduce an isolation &lt;strong&gt;error&lt;&#x2F;strong&gt; in &lt;code&gt;viewAppeared&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This is incredibly confusing.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-solution&quot;&gt;The Solution&lt;&#x2F;h2&gt;
&lt;p&gt;Property wrappers will just stop doing this! Pretty simple.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-implications&quot;&gt;The Implications&lt;&#x2F;h2&gt;
&lt;p&gt;As it turns out, this behavior also happens to make a lot of otherwise-incorrect SwiftUI code work right. This non-obvious, implicit behavior is masking a real isolation issue. I&#x27;m sure there is some SwiftUI code out there using concurrency that is &lt;strong&gt;accidentally correct&lt;&#x2F;strong&gt; today because of this.&lt;&#x2F;p&gt;
&lt;p&gt;The proposal authors did a pretty amazing job of trying to determine how problematic this would be. It didn&#x27;t seem like a disaster, but they were at least worried enough that this change, which actually shipped with Swift 5.9, is opt-in. You have to turn it on with the upcoming feature flag: &lt;code&gt;DisableOutwardActorInference&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I would absolutely recommend &lt;a href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;blog&#x2F;using-upcoming-feature-flags&#x2F;&quot;&gt;enabling&lt;&#x2F;a&gt; this one if you are already using complete checking. I think it&#x27;s probably a good idea even if you aren&#x27;t.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;will-it-affect-me&quot;&gt;Will it Affect Me?&lt;&#x2F;h2&gt;
&lt;p&gt;Code that is already complete-checking clean will probably be ok. But, this could be a major source of confusion for SwiftUI users that aren&#x27;t familiar with isolation. Even if you are, the behavior is so surprising it could catch you off-guard.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Swift Isolation Intuition</title>
        <published>2024-03-22T00:00:00+00:00</published>
        <updated>2024-03-22T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/isolation-intuition/"/>
        <id>https://massicotte.org/isolation-intuition/</id>
        
        <content type="html" xml:base="https://massicotte.org/isolation-intuition/">&lt;p&gt;To use Swift concurrency successfully, you have learn to think in terms of &lt;a href=&quot;https:&#x2F;&#x2F;massicotte.org&#x2F;isolation-intuition&#x2F;intro-to-isolation&quot;&gt;isolation&lt;&#x2F;a&gt;. It is the foundational mechanism the compiler uses to reason about and prevent data races. All variables and functions have it. The thing is, isolation is really different from every other synchronization mechanism I&#x27;ve used before. Now that I have more practice, I find it often feels really natural. But getting to that point took real time! And, boy, did I make some spectacular mistakes along the way.&lt;&#x2F;p&gt;
&lt;p&gt;Developing intuition around how isolation works is essential, but it will be less work than you might think!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;self&quot;&gt;Self&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s start by looking at the variable &lt;code&gt;self&lt;&#x2F;code&gt;. It&#x27;s familiar! You may feel very comfortable with &lt;code&gt;self&lt;&#x2F;code&gt;, but there is actually a lot going on.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;topLevelFunction&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ERROR: Cannot find &amp;#39;self&amp;#39; in scope&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;self&lt;&#x2F;code&gt; variable is only available in the bodies of methods of a type.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; Person {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; name: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;whoAmI&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		print(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Did you ever stop to think where &lt;code&gt;self&lt;&#x2F;code&gt; actually comes from? The function &lt;code&gt;whoAmI&lt;&#x2F;code&gt; takes &lt;em&gt;zero&lt;&#x2F;em&gt; arguments. I don&#x27;t know how Swift has implemented this internally. But, we can model it with a top-level function like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;person_whoAmI&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ instance: Person&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(instance&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;name)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It&#x27;s not nearly as nice, but this version is roughly equivalent. In fact, many C APIs do exactly this to emulate the concept of objects. Like many other languages, Swift has added syntax &lt;strong&gt;and&lt;&#x2F;strong&gt; a little magic to make it easier for you to work with structures. And you are probably very comfortable with both of these things!&lt;&#x2F;p&gt;
&lt;p&gt;You can start by thinking about isolation the same way you think about &lt;code&gt;self&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolated-parameters&quot;&gt;Isolated Parameters&lt;&#x2F;h2&gt;
&lt;p&gt;It&#x27;s possible for you to make pretty extensive use of Swift concurrency without ever even running into &lt;a href=&quot;https:&#x2F;&#x2F;massicotte.org&#x2F;isolation-intuition&#x2F;isolated-parameters&quot;&gt;isolated parameters&lt;&#x2F;a&gt;. Here&#x27;s a simple example of what the syntax looks like:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;usesIsolatedParams&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ actor: isolated any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;I&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;actor&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Yes, the type of &lt;code&gt;actor&lt;&#x2F;code&gt; is quite complex. But, I really want you to try to focus instead on the shape of the function. It is really similar to &lt;code&gt;person_whoAmI&lt;&#x2F;code&gt; from above. It is just a function that takes a parameter! While it might not be common to do isolation this way, I think it&#x27;s really interesting to see it laid out so explicitly.&lt;&#x2F;p&gt;
&lt;p&gt;I also want you to note the &lt;code&gt;actor&lt;&#x2F;code&gt; parameter, which defines the isolation of the function, &lt;strong&gt;cannot change&lt;&#x2F;strong&gt; within the body. This is an important thing to realize about isolation in general. It will never change for synchronous code.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;async&quot;&gt;Async&lt;&#x2F;h2&gt;
&lt;p&gt;I tried to pick my words really carefully there. Isolation never changes for &lt;strong&gt;synchronous&lt;&#x2F;strong&gt; code, but it can &lt;strong&gt;temporarily&lt;&#x2F;strong&gt; change when you make asynchronous calls via &lt;code&gt;await&lt;&#x2F;code&gt; or &lt;code&gt;async let&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;usesIsolatedParams&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ actor: isolated any Actor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;I&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;actor&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; all synchronous, so no isolation changes will occur&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	stuff()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	things()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	work()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; but this may require a change in isolation!!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await someAsyncFunction()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;k&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;actor&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; may also require a change!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	async &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; value &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; anotherAsyncFunction()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;b&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;k&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;actor&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Isolation cannot change at all for a &lt;strong&gt;synchronous&lt;&#x2F;strong&gt; function. And it cannot change for the &lt;strong&gt;synchronous parts&lt;&#x2F;strong&gt; of an async function. But, as soon as you need to make an async call, it could.&lt;&#x2F;p&gt;
&lt;p&gt;This is really a consequence of the fact that isolation is controlled entirely by a function&#x27;s definition. It does not matter how the caller is being isolated. This is completely different from how queues or locks work, and its worth taking a moment to think about it.&lt;&#x2F;p&gt;
&lt;p&gt;Once you&#x27;ve digested this, we can distill everything down into two rules:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Rule 1&lt;&#x2F;strong&gt;: isolation is controlled by definitions&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Rule 2&lt;&#x2F;strong&gt;: isolation can only change via async calls&lt;&#x2F;p&gt;
&lt;h2 id=&quot;tracing-isolation&quot;&gt;Tracing isolation&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;&#x2F;strong&gt;: SwiftUI has been changed as of the SDKs within Xcode 16! This section was written when View only applied &lt;code&gt;@MainActor&lt;&#x2F;code&gt; to &lt;code&gt;body&lt;&#x2F;code&gt;. Please keep that in mind!&lt;&#x2F;p&gt;
&lt;p&gt;Rule 2 governs how isolation can and cannot &lt;strong&gt;change&lt;&#x2F;strong&gt;. Rule 1 controls where isolation is &lt;strong&gt;specified&lt;&#x2F;strong&gt;. And, yes, that rule &lt;em&gt;sounds&lt;&#x2F;em&gt; simple. But the most common form of isolation, global actors like &lt;code&gt;@MainActor&lt;&#x2F;code&gt;, can influence a definition when protocols and&#x2F;or inheritance are involved. And since those are often in other files&#x2F;modules, it isn&#x27;t always obvious.&lt;&#x2F;p&gt;
&lt;p&gt;To illustrate this, I&#x27;m going to use SwiftUI. I am &lt;a href=&quot;https:&#x2F;&#x2F;massicotte.org&#x2F;isolation-intuition&#x2F;swiftui-isolation&quot;&gt;not a fan&lt;&#x2F;a&gt; of how SwiftUI&#x27;s &lt;code&gt;View&lt;&#x2F;code&gt; type handles isolation. But, &lt;code&gt;View&lt;&#x2F;code&gt; is something many Swift developers are familiar with, and it is precisely because it is so tricky that it makes for great example material.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; MyView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; what is the isolation here?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Hey look, a &lt;code&gt;self&lt;&#x2F;code&gt; reference! It might not take you much effort to understand what &lt;code&gt;self&lt;&#x2F;code&gt; is &lt;strong&gt;now&lt;&#x2F;strong&gt;. But, there was a point in &lt;strong&gt;everyone&#x27;s&lt;&#x2F;strong&gt; programming journey when they had to do quite a bit of thinking to get it.&lt;&#x2F;p&gt;
&lt;p&gt;Isolation is the same thing!&lt;&#x2F;p&gt;
&lt;p&gt;If you feel good about how &lt;code&gt;self&lt;&#x2F;code&gt; works, it&#x27;s because you&#x27;ve internalized the algorithm the compiler uses. So much so, that you might not even need to think about it. But I&#x27;m going to really spell out what&#x27;s happening with isolation here, despite it being so similar.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s bring the definition of &lt;code&gt;View&lt;&#x2F;code&gt; in too, so we can look at it all together. Remember, our objective is to determine the isolation of the &lt;code&gt;body&lt;&#x2F;code&gt; property.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	associatedtype Body &lt;span class=&quot;z-keyword z-operator z-ternary z-swift&quot;&gt;:&lt;&#x2F;span&gt; View
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; 4 - protocol member ... AH HA!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;ViewBuilder&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;Body { &lt;span class=&quot;z-keyword z-other z-swift&quot;&gt;get&lt;&#x2F;span&gt; }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; 3 - protocol conformance&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; 2 - type&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; MyView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; 1 - definition&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; what is the isolation here?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) 
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There&#x27;s a lot going on here, so let&#x27;s break it down one step at a time.&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;First, we check the &lt;code&gt;var&lt;&#x2F;code&gt; definition. Nothing.&lt;&#x2F;li&gt;
&lt;li&gt;Next, we check the type definition. Still no isolation.&lt;&#x2F;li&gt;
&lt;li&gt;Ok, does this &lt;code&gt;var&lt;&#x2F;code&gt; satisfy a protocol? We have to check that.&lt;&#x2F;li&gt;
&lt;li&gt;Here it is! This protocol defines &lt;code&gt;body&lt;&#x2F;code&gt; as &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;h2 id=&quot;global-actor-inference&quot;&gt;Global actor inference&lt;&#x2F;h2&gt;
&lt;p&gt;This whole process is quite involved because of something called global actor inference. This &lt;a href=&quot;https:&#x2F;&#x2F;www.hackingwithswift.com&#x2F;quick-start&#x2F;concurrency&#x2F;understanding-how-global-actor-inference-works&quot;&gt;article&lt;&#x2F;a&gt; does a great job of explaining the rules in more depth. But I&#x27;m going to try to boil it all down into one really simple rule:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Rule 3&lt;&#x2F;strong&gt;: protocols can specify isolation&lt;&#x2F;p&gt;
&lt;p&gt;In the case of &lt;code&gt;View&lt;&#x2F;code&gt;, the protocol is specifying the isolation of a specific member. But it is possible to apply isolation to the protocol as a whole. I want to highlight this because, at first, I was confused about how it worked.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MyCustomNonMainGlobalActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; CustomActorStuff {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; This does not affect the isolation of the UIViewController&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; type. It&amp;#39;s still MainActor...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; UIViewController: CustomActorStuff {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... but everything in here will be inferred&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; to use MyCustomNonMainGlobalActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is really just another consequence of rule 1: the definition &lt;strong&gt;wins&lt;&#x2F;strong&gt;. While a protocol can specify isolation, you cannot use one to change it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-algorithm&quot;&gt;The algorithm&lt;&#x2F;h2&gt;
&lt;p&gt;The whole point here is to help you develop some intuition about how things get isolated. To do that, we&#x27;re just learning the algorithm the compiler uses. And yes, it can get complex with inheritance or protocols. But, the actual algorithm your brain can use can be very simple.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Check the definition&lt;&#x2F;li&gt;
&lt;li&gt;Check the enclosing type&lt;&#x2F;li&gt;
&lt;li&gt;Protocol involved?
&lt;ul&gt;
&lt;li&gt;Check its definition&lt;&#x2F;li&gt;
&lt;li&gt;Check its enclosing type&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;That&#x27;s it.&lt;&#x2F;p&gt;
&lt;p&gt;All in all, I find global actor inference to be something that only sounds scary and complex. In my experience, it is usually something you can learn once and then just apply.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;View.body&lt;&#x2F;code&gt; is &lt;code&gt;MainActor&lt;&#x2F;code&gt;, done.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;again-without-the-inference&quot;&gt;Again, without the inference&lt;&#x2F;h2&gt;
&lt;p&gt;I want to help solidify how this process works by looking again a SwiftUI &lt;code&gt;View&lt;&#x2F;code&gt;. But, this time, we&#x27;re going to consider two trickier cases.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; 3 - protocol conformance&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; 2 - type&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; MyView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; we know this is MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;formalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;) 
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; 1 - definition&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;formalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; but what about this?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;lessFormalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; or this???&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Because SwiftUI&#x27;s &lt;code&gt;View&lt;&#x2F;code&gt; only isolates &lt;code&gt;body&lt;&#x2F;code&gt;, tracing the isolation of these two functions is more straight-forward.&lt;&#x2F;p&gt;
&lt;p&gt;For &lt;code&gt;formalGreeting&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;The definition has no isolation.&lt;&#x2F;li&gt;
&lt;li&gt;The enclosing type has no isolation.&lt;&#x2F;li&gt;
&lt;li&gt;The View protocol doesn&#x27;t impact the function.&lt;&#x2F;li&gt;
&lt;li&gt;???&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;So, nothing? Yes! Non-isolation is totally a thing, and in fact is quite common. But, rule 2 still applies! Synchronous code cannot change isolation. So, this function just has no isolation at all. Fortunately, the compiler has our back here and will prevent us from doing anything unsafe accidentally.&lt;&#x2F;p&gt;
&lt;p&gt;Now, what about &lt;code&gt;lessFormalGreeting&lt;&#x2F;code&gt;? The only thing we&#x27;ve changed is we made the function &lt;code&gt;async&lt;&#x2F;code&gt;. But the algorithm still works! This function is also non-isolated. Making a function async does not change how you determine isolation.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;closures&quot;&gt;Closures&lt;&#x2F;h2&gt;
&lt;p&gt;There&#x27;s one more thing we need to cover. When it comes to isolation, closures are extremely close in behavior to regular functions. Rules 1 and 2 still apply. Rule 3 isn&#x27;t even relevant because closures cannot conform to protocols. But we do have a problem. When working with concurrency you may make use of the &lt;code&gt;Task&lt;&#x2F;code&gt; API. And it, being part of the currency system, treats closures specially too.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s modify our view from above. We want to determine what isolation will be in effect for the &lt;code&gt;Task&lt;&#x2F;code&gt; body.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; MyView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; we know this is MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;formalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;formalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...ummmm...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Figuring out how &lt;code&gt;Task&lt;&#x2F;code&gt; does isolation starts with first knowing the isolation of the enclosing callsite. We know how to do this now, we just use The Algorithm.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;formalGreeting&lt;&#x2F;code&gt; has no isolation&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;MyView&lt;&#x2F;code&gt; has no isolation&lt;&#x2F;li&gt;
&lt;li&gt;Does &lt;code&gt;View&lt;&#x2F;code&gt;&#x27;s isolation of &lt;code&gt;body&lt;&#x2F;code&gt; apply?&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;We can see that &lt;code&gt;formalGreeting&lt;&#x2F;code&gt; is called from &lt;code&gt;body&lt;&#x2F;code&gt;, and we know that is &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated. But, it&#x27;s really important to keep in mind that isolation is a &lt;strong&gt;compile-time&lt;&#x2F;strong&gt; construct. The &lt;strong&gt;runtime&lt;&#x2F;strong&gt; state does not matter. This means &lt;code&gt;formalGreeting&lt;&#x2F;code&gt; is &lt;strong&gt;non-isolated&lt;&#x2F;strong&gt;, even if it will actually only ever run on the &lt;code&gt;MainActor&lt;&#x2F;code&gt; in practice. But we need to know more to figure this all out.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;Task&lt;&#x2F;code&gt;&#x27;s parameter definition is a little magic. The closure that &lt;code&gt;Task&lt;&#x2F;code&gt; takes uses a special attribute called &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift&#x2F;blob&#x2F;main&#x2F;docs&#x2F;ReferenceGuides&#x2F;UnderscoredAttributes.md#_inheritactorcontext&quot;&gt;&lt;code&gt;@_inheritActorContext&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. This changes the definition of the &lt;code&gt;Task&lt;&#x2F;code&gt; body to inherit whatever isolation is in effect on the outside. This means the isolation outside a &lt;code&gt;Task&lt;&#x2F;code&gt; &lt;strong&gt;does not change&lt;&#x2F;strong&gt; on the inside. And that&#x27;s great, because it does not alter our algorithm at all!&lt;&#x2F;p&gt;
&lt;p&gt;All this long, dense explanation means is &lt;code&gt;Task&lt;&#x2F;code&gt; will match the isolation of its enclosing function. In this case, that makes its body non-isolated.&lt;&#x2F;p&gt;
&lt;p&gt;The same thing, however, is &lt;strong&gt;not&lt;&#x2F;strong&gt; true of &lt;code&gt;Task.detached&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; MyView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; we know this is MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;formalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;formalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		Task&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;detached {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...soooo...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;ve made two changes to the code. I&#x27;ve added explicit isolation to &lt;code&gt;formalGreeting&lt;&#x2F;code&gt;, but I&#x27;ve also switched to using &lt;code&gt;Task.detached&lt;&#x2F;code&gt;. This API will prevent isolation inheritance.&lt;&#x2F;p&gt;
&lt;p&gt;Despite that &lt;code&gt;@MainActor&lt;&#x2F;code&gt; on the containing function, this &lt;code&gt;Task&lt;&#x2F;code&gt; will be non-isolated.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;explicit-closure-isolation&quot;&gt;Explicit Closure Isolation&lt;&#x2F;h2&gt;
&lt;p&gt;I want to mention just one more detail about closures. Because they are basically a function + a definition all in one, closures have another capability. You can also define isolation inline.&lt;&#x2F;p&gt;
&lt;p&gt;Check this out:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; MyView: View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: some View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; we know this is MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Text(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;formalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-begin z-swift&quot;&gt;\(&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-expression z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-punctuation z-expression z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;formalGreeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		Task { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ...okaaay...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In this example, &lt;code&gt;formalGreeting&lt;&#x2F;code&gt; is back to being non-isolated. And we know that &lt;code&gt;Task&lt;&#x2F;code&gt; will also be non-isolated via inheritance. But then we go ahead and add explicit isolation on top of that! Does this    work?&lt;&#x2F;p&gt;
&lt;p&gt;Recall rule 2: isolation can only change via async calls.&lt;&#x2F;p&gt;
&lt;p&gt;This change in isolation is &lt;strong&gt;not&lt;&#x2F;strong&gt; a violation of this rule, because &lt;code&gt;Task&lt;&#x2F;code&gt; allows us to introduce a new async context! But, to really highlight that, look at an example that does not use &lt;code&gt;Task&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; a non-isolated function&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;takesAClosure&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ block: (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; definitely not running on the MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	block()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;usesClosure&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; WANRING: Converting function .... loses global actor &amp;#39;MainActor&amp;#39;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	takesAClosure { &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; wait, why not?&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Our &lt;strong&gt;closure definition&lt;&#x2F;strong&gt; says it is &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated, but the &lt;strong&gt;parameter definition&lt;&#x2F;strong&gt; does not. The compiler correctly catches this mis-match. There&#x27;s nothing async about this, so a change in isolation is not possible.&lt;&#x2F;p&gt;
&lt;p&gt;The take-away here is the &lt;code&gt;Task&lt;&#x2F;code&gt; API is special. But it is special in a way that I think ends up making it feel surprisingly natural.&lt;&#x2F;p&gt;
&lt;p&gt;(I also want to point out that closures may be getting &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;sophiapoirier&#x2F;swift-evolution&#x2F;blob&#x2F;closure-isolation&#x2F;proposals&#x2F;nnnn-closure-isolation-control.md&quot;&gt;more powerful and less-weird&lt;&#x2F;a&gt; in Swift 6.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;practice-makes-better&quot;&gt;Practice makes better&lt;&#x2F;h2&gt;
&lt;p&gt;I went though several variations of this post. And it got way longer than I was originally expecting. After stumbling onto the &lt;code&gt;self&lt;&#x2F;code&gt; analogy, I really thought it could be a good way to help develop intuition around isolation. But, like all good analogies, this one breaks down when you look closely. There are lots of places where &lt;code&gt;self&lt;&#x2F;code&gt; and isolation do not behave even remotely the same.&lt;&#x2F;p&gt;
&lt;p&gt;Despite the weaknesses, I think the concepts here still have merit. Learning how &lt;code&gt;self&lt;&#x2F;code&gt; works seems to be something people can make second nature. And I think the same thing can be done for isolation. It&#x27;s just going to take some practice. I really hope this approach is helpful. But, if it isn&#x27;t or is confusing at all, please let me know.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>An Introduction to Isolation in Swift</title>
        <published>2024-02-29T00:00:00+00:00</published>
        <updated>2024-02-29T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/intro-to-isolation/"/>
        <id>https://massicotte.org/intro-to-isolation/</id>
        
        <content type="html" xml:base="https://massicotte.org/intro-to-isolation/">&lt;p&gt;(Heads up! I&#x27;m not 100% sure this is actually the best &lt;strong&gt;introduction&lt;&#x2F;strong&gt;, despite the title. You might want to start &lt;a href=&quot;&#x2F;step-by-step-network-request&quot;&gt;here&lt;&#x2F;a&gt; first instead.)&lt;&#x2F;p&gt;
&lt;p&gt;Recently, someone asked me a question about actor isolation. The specifics aren&#x27;t important, but I really got to thinking about it because &lt;strong&gt;of course&lt;&#x2F;strong&gt; they were struggling. Isolation is central to how Swift concurrency works, but it&#x27;s a totally new concept.&lt;&#x2F;p&gt;
&lt;p&gt;Despite being new, it actually uses mostly familiar mechanisms. You probably &lt;strong&gt;do&lt;&#x2F;strong&gt; understand a lot about how isolation works, you just don&#x27;t &lt;strong&gt;realize&lt;&#x2F;strong&gt; it yet.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s breakdown of the concepts, in the simplest terms I could come up with.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;what-even-is-isolation&quot;&gt;What even is isolation?&lt;&#x2F;h3&gt;
&lt;p&gt;Isolation is the mechanism that Swift uses to make data races impossible. With it, the compiler can reason about how data is accessed and when it can and cannot be done in a guaranteed-safe way. It is also worth noting that this is about accessing mutable state in unsafe ways specifically, not about all kinds of races in general.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;definitions-control-isolation&quot;&gt;Definitions control isolation&lt;&#x2F;h3&gt;
&lt;p&gt;You can &lt;strong&gt;always&lt;&#x2F;strong&gt; look at a definition to understand its isolation.&lt;&#x2F;p&gt;
&lt;p&gt;This is a radical departure from other types of thread-safety mechanisms like locks and queues. I think this is probably the number one thing people using concurrency do not understand.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; no isolation for the type...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... and none for the function either&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;method&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; so this is a non-isolated context&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;asyncMethod&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; async does not affect this, so &lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is non-isolated too!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, looking at a definition isn&#x27;t always as straightforward as it sounds. It can involve inheritance if a type has a super-class or conforms to protocols. These are not usually in the same file, or even module, and you may need to consult them to get the full picture. In practice though, outside of UI code, inheritance rarely affects isolation.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass: SomeSupertype, SomeProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; isolation here might depend on inheritance&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;method&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Just remember: isolation is specified at compile time. I&#x27;m repeating myself here because it is both &lt;strong&gt;critical&lt;&#x2F;strong&gt; and often a source of confusion.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;isolation-comes-in-three-flavors&quot;&gt;Isolation comes in three flavors&lt;&#x2F;h3&gt;
&lt;ul&gt;
&lt;li&gt;None&lt;&#x2F;li&gt;
&lt;li&gt;Static&lt;&#x2F;li&gt;
&lt;li&gt;Dynamic&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Everything is &lt;strong&gt;non-isolated&lt;&#x2F;strong&gt; by default. You must take explicit action to change this.&lt;&#x2F;p&gt;
&lt;p&gt;Actor types, global actors, and &lt;a href=&quot;https:&#x2F;&#x2F;www.massicotte.org&#x2F;isolated-parameters&quot;&gt;isolated parameters&lt;&#x2F;a&gt; are all forms of static isolation. Global actors in particular are very common. Many projects, even non-trivial ones, will need nothing more than &lt;code&gt;@MainActor&lt;&#x2F;code&gt; isolation for all of its concurrency requirements. Concurrency-heavy library authors may find uses for isolated parameters, but I don&#x27;t &lt;em&gt;think&lt;&#x2F;em&gt; they will play a major role in day-to-day app development.&lt;&#x2F;p&gt;
&lt;p&gt;(Isolated parameters are also getting &lt;a href=&quot;https:&#x2F;&#x2F;forums.swift.org&#x2F;t&#x2F;isolation-assumptions&#x2F;69514&#x2F;49&quot;&gt;less weird&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0420-inheritance-of-actor-isolation.md&quot;&gt;more powerful&lt;&#x2F;a&gt; soon!)&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;ll get to dynamic isolation in a minute.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;isolation-can-change-when-you-await&quot;&gt;Isolation can change when you await&lt;&#x2F;h3&gt;
&lt;p&gt;Whenever you see an &lt;code&gt;await&lt;&#x2F;code&gt; keyword, isolation &lt;strong&gt;could&lt;&#x2F;strong&gt; change.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; I&amp;#39;m on the MainActor here!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	await anotherFunction() &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; have to look at the definition of anotherFunction&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; back on the main actor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is another very common source of confusion! But, that&#x27;s because with other concurrency systems runtime context is important. Definitions are all that matter in Swift!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;closures-can-inherit-isolation&quot;&gt;Closures can inherit isolation&lt;&#x2F;h3&gt;
&lt;p&gt;This is completely distinct from type inheritance. It &lt;strong&gt;only&lt;&#x2F;strong&gt; applies to closure arguments, and it is usually only found in APIs that directly control concurrency features, like &lt;code&gt;Task&lt;&#x2F;code&gt;. Note that we are still following the rules: the isolation behavior is still controlled by the definition. It is done using the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift&#x2F;blob&#x2F;main&#x2F;docs&#x2F;ReferenceGuides&#x2F;UnderscoredAttributes.md#_inheritactorcontext&quot;&gt;&lt;code&gt;@_inheritActorContext&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; attribute.&lt;&#x2F;p&gt;
&lt;p&gt;Yes, this is confusing. At first!&lt;&#x2F;p&gt;
&lt;p&gt;All this means is isolation will not suddenly change unless &lt;strong&gt;you&lt;&#x2F;strong&gt; decide you want to change it. Whatever isolation was in effect when you create a &lt;code&gt;Task&lt;&#x2F;code&gt; will still be used inside the &lt;code&gt;Task&lt;&#x2F;code&gt; body by default. This is very convenient and often exactly what you want. You can also opt out of this, if you want.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyIsolatedClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;myMethod&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		    &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; still isolated to the MainActor here!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		Task&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;detached {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; explicitly non-isolated, regardless&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; the enclosing scope&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;isolation-applies-to-variables&quot;&gt;Isolation applies to variables&lt;&#x2F;h3&gt;
&lt;p&gt;Functions are not the only thing that can be isolated. Non-local variables can require isolation too.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyIsolatedClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; value &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt; &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is also MainActor-isolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The compiler only started checking this in Swift 5.10, and it surprises a lot of people. But it does make sense. These values can be accessed anywhere in the module, so that needs to be done in a thread-safe way. Explicit isolation is one way to get this safety, but it is definitely not the only way.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;you-can-opt-out-of-isolation&quot;&gt;You can opt-out of isolation&lt;&#x2F;h3&gt;
&lt;p&gt;If something has isolation that you don&#x27;t want, you can opt-out with the &lt;code&gt;nonisolated&lt;&#x2F;code&gt; keyword. This also can make a lot of sense for static constants that are immutable and safe to access from other threads.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyIsolatedClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;nonIsolatedMethod&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; no MainActor isolation here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated &lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;static&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; someConstantSTring &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;I&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;f&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;!&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;(As we saw above, opting out of isolation for &lt;code&gt;Task&lt;&#x2F;code&gt; works a little differently &lt;strong&gt;today&lt;&#x2F;strong&gt;. But, this is an area that is being actively worked on.)&lt;&#x2F;p&gt;
&lt;h3 id=&quot;isolation-makes-protocols-tricky&quot;&gt;Isolation makes protocols tricky&lt;&#x2F;h3&gt;
&lt;p&gt;Protocols, being definitions, can control isolation just like other kinds of definitions.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; NoIsolation {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;method&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; GloballyIsolatedProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;method&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; PerMemberIsolatedProtocol {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;method&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The isolation used by protocols, including none at all, can have &lt;strong&gt;major&lt;&#x2F;strong&gt; implications. This is something to pay particularly close attention to when using concurrency. If you use a lot of protocols in your code, investigating how &lt;a href=&quot;https:&#x2F;&#x2F;www.massicotte.org&#x2F;complete-checking&quot;&gt;complete concurrency checking&lt;&#x2F;a&gt; affects your design is a very good idea.&lt;&#x2F;p&gt;
&lt;p&gt;(I have a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;ConcurrencyRecipes&#x2F;blob&#x2F;main&#x2F;Recipes&#x2F;Protocols.md&quot;&gt;collection of techniques&lt;&#x2F;a&gt; for working with protocols and concurrency. But I keep finding new problems! Please let me know if you run into issues I have not covered there.)&lt;&#x2F;p&gt;
&lt;h3 id=&quot;dynamic-isolation&quot;&gt;Dynamic Isolation&lt;&#x2F;h3&gt;
&lt;p&gt;It can happen that the type system alone does not or cannot describe the isolation actually used. This comes up regularly with systems built before concurrency was a thing. One tool we have to deal with this is &lt;strong&gt;dynamic isolation&lt;&#x2F;strong&gt;. These are APIs that allow us to express isolation in a way that is invisible by just looking at definitions.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this delegate will actually always make calls on the MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; but its definition does not express this.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyMainActorClass: SomeDelegate {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	nonisolated funcSomeDelegateCallback() {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; promise the compiler we will be on the&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; MainActor at runtime.&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		MainActor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;assumeIsolated {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; access MainActor stuff, including self&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;swiftui-is-very-confusing&quot;&gt;SwiftUI is very confusing&lt;&#x2F;h3&gt;
&lt;p&gt;This isn&#x27;t &lt;strong&gt;directly&lt;&#x2F;strong&gt; related to the language isolation system, but it is a practical problem that affects a large number of people. SwiftUI&#x27;s isolation model is extremely error-prone, and I&#x27;d go so far as to say that it &lt;a href=&quot;https:&#x2F;&#x2F;www.massicotte.org&#x2F;swiftui-isolation&quot;&gt;should be changed&lt;&#x2F;a&gt;. Right now, if you see a SwiftUI view that is &lt;strong&gt;not&lt;&#x2F;strong&gt; MainActor-isolated, it&#x27;s probably a bug.&lt;&#x2F;p&gt;
&lt;p&gt;Both UIKit and AppKit enforce whole-type &lt;code&gt;MainActor&lt;&#x2F;code&gt; isolation, so they are much easier to use in this respect.&lt;&#x2F;p&gt;
&lt;p&gt;(I&#x27;ve also got a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;ConcurrencyRecipes&#x2F;blob&#x2F;main&#x2F;Recipes&#x2F;SwiftUI.md&quot;&gt;few ideas&lt;&#x2F;a&gt; on how to handle this, but I&#x27;d love feedback on this stuff from more experienced SwiftUI users.)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;this-is-new-not-impossible&quot;&gt;This is new, not impossible&lt;&#x2F;h2&gt;
&lt;p&gt;I think with just a little practice, you can get your head around isolation. And while I think the &lt;strong&gt;concept&lt;&#x2F;strong&gt; is straightforward, actually doing isolation correctly can be incredibly difficult. I hope I have covered enough to help get you started. But, please let me know if there&#x27;s something I missed or got wrong. This stuff isn&#x27;t easy!&lt;&#x2F;p&gt;
&lt;p&gt;Oh yeah, and since you are here, don&#x27;t forget to &lt;a href=&quot;https:&#x2F;&#x2F;www.massicotte.org&#x2F;complete-checking&quot;&gt;turn on the warnings&lt;&#x2F;a&gt; 😉&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>SwiftUI Got Isolation Wrong</title>
        <published>2024-02-22T00:00:00+00:00</published>
        <updated>2024-02-22T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/swiftui-isolation/"/>
        <id>https://massicotte.org/swiftui-isolation/</id>
        
        <content type="html" xml:base="https://massicotte.org/swiftui-isolation/">&lt;p&gt;I was thinking about a &lt;a href=&quot;https:&#x2F;&#x2F;www.donnywals.com&#x2F;how-to-determine-where-tasks-and-async-functions-run-in-swift&#x2F;&quot;&gt;post&lt;&#x2F;a&gt; by &lt;a href=&quot;https:&#x2F;&#x2F;chaos.social&#x2F;@donnywals&quot;&gt;Donny Wals&lt;&#x2F;a&gt;. The discussion is really centered around isolation and how the isolation inheritance rules can be challenging to reason about. But, what I couldn&#x27;t get over was that SwiftUI was used as the main source of examples.&lt;&#x2F;p&gt;
&lt;p&gt;I think SwiftUI is doing isolation wrong.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;&#x2F;strong&gt;: SwiftUI has been changed as of the SDKs within Xcode 16!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;protocol-isolation&quot;&gt;Protocol Isolation&lt;&#x2F;h2&gt;
&lt;p&gt;Very broadly speaking, there are three isolation patterns you&#x27;ll see used with protocols.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;no isolation&lt;&#x2F;li&gt;
&lt;li&gt;whole-conformance isolation&lt;&#x2F;li&gt;
&lt;li&gt;per-member isolation&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Protocols are used extensively by UIKit and AppKit for delegates. You can find all three patterns. I&#x27;m going to use the text system, because I think it has some great examples of the implications of these different patterns.&lt;&#x2F;p&gt;
&lt;p&gt;First up is &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;uikit&#x2F;uitableviewdelegate&quot;&gt;&lt;code&gt;UITableViewDelegate&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. This protocol uses whole-conformance isolation, which roughly looks like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; UITableViewDelegate {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; functions&#x2F;properties&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What this is saying is any functions that satisfy the conformance to &lt;code&gt;UITableViewDelegate&lt;&#x2F;code&gt; &lt;strong&gt;must&lt;&#x2F;strong&gt; be isolated to the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. This shouldn&#x27;t really be too surprising because you cannot interact with a &lt;code&gt;UITableView&lt;&#x2F;code&gt; off the main thread. While totally resonable, it is still a constraint. It is &lt;strong&gt;impossible&lt;&#x2F;strong&gt; to make an actor type conform to this protocol.&lt;&#x2F;p&gt;
&lt;p&gt;(Global actor-isolated protocols are a little complex. An earlier version of this post used the term &quot;whole-type isolation&quot;, but that&#x27;s technically inaccurate. Protocols marked with a global actor do not &lt;em&gt;necessarily&lt;&#x2F;em&gt; enforce isolation on the entire conforming type.)&lt;&#x2F;p&gt;
&lt;p&gt;Bizarrely, &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;appkit&#x2F;nstableviewdelegate&quot;&gt;&lt;code&gt;NSTableViewDelegate&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; has taken a different approach. It uses per-member isolation, which looks more like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; NSTableViewDelegate {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;optional&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;tableView&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ tableView: NSTableView, didClick tableColumn: NSTableColumn&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&#x2F;&#x2F; lots of other functions all annotated with @MainActor
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;}&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The difference is per-member isolation is less restrictive. Compared to whole-conformance isolation, nothing really changes from the perspective of the code using the protocol. But types &lt;strong&gt;conforming&lt;&#x2F;strong&gt; to the protocol have more flexibility with their own isolation. They can, for example, be &lt;code&gt;actor&lt;&#x2F;code&gt; types.&lt;&#x2F;p&gt;
&lt;p&gt;The no isolation pattern is used by &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;uikit&#x2F;nstextstoragedelegate&quot;&gt;&lt;code&gt;NSTextStorageDelegate&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. &lt;code&gt;NSTextStorage&lt;&#x2F;code&gt; isn&#x27;t actually a part of the text systems&#x27;s views, and because of that, there&#x27;s no need to constrain it to the &lt;code&gt;MainActor&lt;&#x2F;code&gt; at all. It&#x27;s actually totally possible to use it on another thread.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;implications&quot;&gt;Implications&lt;&#x2F;h2&gt;
&lt;p&gt;When I started writing this, I was not actually expecting to find a difference between &lt;code&gt;UITableViewDelegate&lt;&#x2F;code&gt; and &lt;code&gt;NSTableViewDelegate&lt;&#x2F;code&gt;. But, it is kind of a happy accident, because it&#x27;s going to help me make my point (which is coming I promise).&lt;&#x2F;p&gt;
&lt;p&gt;Which of these is &quot;better&quot;?&lt;&#x2F;p&gt;
&lt;p&gt;I like the simplicity and explicitness of &lt;code&gt;UITableViewDelegate&lt;&#x2F;code&gt;&#x27;s whole-conformance isolation. There&#x27;s no ambiguity - if a type wants to be the delegate, probably will just be &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated. But, on the other hand, &lt;code&gt;NSTableViewDelegate&lt;&#x2F;code&gt;&#x27;s per-member isolation offers flexibility. And, critically, that flexibility comes with &lt;strong&gt;no downsides&lt;&#x2F;strong&gt;. From &lt;code&gt;NSTableView&lt;&#x2F;code&gt;&#x27;s perspective, it is totally irrelevant if you really wanted to make the delegate an actor. You would have to deal with the isolation headaches that come along with this decision, but that&#x27;s up to you.&lt;&#x2F;p&gt;
&lt;p&gt;So, in this case, I think &lt;code&gt;NSTableViewDelegate&lt;&#x2F;code&gt;&#x27;s approach makes more sense. And, anecdotally, I have found that the per-member isolation pattern is far more commonly-used in Apple&#x27;s protocols. Probably for exactly this reason. Why add unnecessary constraints?&lt;&#x2F;p&gt;
&lt;p&gt;And finally, this brings us to SwiftUI.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;view&quot;&gt;View&lt;&#x2F;h2&gt;
&lt;p&gt;SwiftUI&#x27;s central element is the &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swiftui&#x2F;view&quot;&gt;&lt;code&gt;View&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; protocol. I&#x27;m simplifying things a little, but let&#x27;s have a look at it here:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;ViewBuilder&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;Body { &lt;span class=&quot;z-keyword z-other z-swift&quot;&gt;get&lt;&#x2F;span&gt; }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;View&lt;&#x2F;code&gt; is very explicitly stating that you can make a type &lt;strong&gt;with any form of isolation&lt;&#x2F;strong&gt; conform to &lt;code&gt;View&lt;&#x2F;code&gt;. All you have to make sure is that &lt;code&gt;body&lt;&#x2F;code&gt; is &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated.&lt;&#x2F;p&gt;
&lt;p&gt;This makes absolutely &lt;strong&gt;no sense&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;For any non-trivial view, actually constructing that body will require at least some of Swift&#x27;s many property wrappers. And, if you want to factor your code in any way that involves adding functions to your view, you&#x27;ll immediately have to think about isolation. And just look at Donny&#x27;s article for examples of why that is so difficult. It&#x27;s incredibly confusing because body inherits different isolation than the rest of the type.&lt;&#x2F;p&gt;
&lt;p&gt;This particular issue was such a common problem that it even motivated a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0401-remove-property-wrapper-isolation.md&quot;&gt;language change&lt;&#x2F;a&gt;! I think the change was very good, but was only such a wide-spread issue because SwiftUI&#x27;s view isolation pattern &lt;strong&gt;doesn&#x27;t match&lt;&#x2F;strong&gt; how it is actually used in the common case.&lt;&#x2F;p&gt;
&lt;p&gt;The only reason a SwiftUI View exists is to generate that &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated &lt;code&gt;body&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-fix&quot;&gt;The Fix&lt;&#x2F;h2&gt;
&lt;p&gt;Now, I will concede that I am not an experienced SwiftUI developer. There may be something I&#x27;m missing. And, if you know what that something is, please tell me! But, with the information I have, I&#x27;m willing to take a stand here.&lt;&#x2F;p&gt;
&lt;p&gt;I believe the situation where it would make sense for a &lt;code&gt;View&lt;&#x2F;code&gt; to &lt;strong&gt;not&lt;&#x2F;strong&gt; be &lt;code&gt;MainActor&lt;&#x2F;code&gt;-isolated is so bizarre it should just not be possible. The flexibility you get from per-member isolation is unnecessary. But, the implications of not forcing &lt;code&gt;MainActor&lt;&#x2F;code&gt; isolation is enormous, wide-spread &lt;strong&gt;confusion&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;SwiftUI&#x27;s &lt;code&gt;View&lt;&#x2F;code&gt; should actually be defined like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; View {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;ViewBuilder&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; body: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;Body { &lt;span class=&quot;z-keyword z-other z-swift&quot;&gt;get&lt;&#x2F;span&gt; }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So, I&#x27;ll wrap up by saying two things:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;All your SwiftUI views should be always be &lt;code&gt;@MainActor&lt;&#x2F;code&gt; isolated&lt;&#x2F;li&gt;
&lt;li&gt;SwiftUI should just fix &lt;code&gt;View&lt;&#x2F;code&gt; to make these problems go away&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Should You Enable Swift&#x27;s Complete Concurrency Checking?</title>
        <published>2024-02-14T00:00:00+00:00</published>
        <updated>2024-02-14T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/complete-checking/"/>
        <id>https://massicotte.org/complete-checking/</id>
        
        <content type="html" xml:base="https://massicotte.org/complete-checking/">&lt;p&gt;Recently, I&#x27;ve seen a lot of talk around enabling Swift&#x27;s complete concurrency checking. I think this is a really good discussion to have. I have opinions! But, I&#x27;d prefer to try to give you enough information to understand the trade-offs, because they are significant.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;how&quot;&gt;How&lt;&#x2F;h2&gt;
&lt;p&gt;By default, all checking is set to &lt;code&gt;minimal&lt;&#x2F;code&gt;. If you want the compiler to do more checking, you have to opt-in. There are &lt;a href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;documentation&#x2F;concurrency&#x2F;&quot;&gt;in-depth instructions&lt;&#x2F;a&gt; over on swift.org, but I&#x27;ll summarize.&lt;&#x2F;p&gt;
&lt;p&gt;For Xcode, the &lt;code&gt;SWIFT_STRICT_CONCURRENCY&lt;&#x2F;code&gt; setting must be &lt;code&gt;complete&lt;&#x2F;code&gt;. For Swift packages, you&#x27;ve got to set a &lt;code&gt;swiftSettings&lt;&#x2F;code&gt; value.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;target(
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	swiftSettings: [
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;enableExperimentalFeature(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;S&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;C&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	]
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This isn&#x27;t hard to do, but I&#x27;d recommend checking out &lt;a href=&quot;https:&#x2F;&#x2F;useyourloaf.com&#x2F;blog&#x2F;strict-concurrency-checking-in-swift-packages&#x2F;&quot;&gt;this article&lt;&#x2F;a&gt;, as there are a few ways and you can get quite clever with it.&lt;&#x2F;p&gt;
&lt;p&gt;I do want to note that there is also an intermediate form of concurrency checking called &lt;code&gt;targeted&lt;&#x2F;code&gt;. I have not used this much, so I don&#x27;t fully understand what it will and will not catch. I&#x27;m only going to talk about &lt;code&gt;complete&lt;&#x2F;code&gt; because it&#x27;s all I know.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;why&quot;&gt;Why&lt;&#x2F;h2&gt;
&lt;p&gt;I think many people believe you turn on complete checking to get prepared for Swift 6. And, yes, that is true! But, I do not think this is the most compelling reason today.&lt;&#x2F;p&gt;
&lt;p&gt;You turn on complete checking to &lt;strong&gt;learn&lt;&#x2F;strong&gt; how Swift concurrency &lt;strong&gt;actually&lt;&#x2F;strong&gt; works.&lt;&#x2F;p&gt;
&lt;p&gt;When you write code the compiler complains if your syntax is wrong. So you look at the errors and they help you fix things. That&#x27;s &lt;strong&gt;feedback&lt;&#x2F;strong&gt;! Finally you get things sorted and can run the program. But of course it doesn&#x27;t work right yet, so you debug. That process is &lt;strong&gt;also&lt;&#x2F;strong&gt; driven by feedback.&lt;&#x2F;p&gt;
&lt;p&gt;The problem is today you can use Swift&#x27;s concurrency system with &lt;strong&gt;almost&lt;&#x2F;strong&gt; no feedback. And it is amazingly forgiving! Because you are most likely following patterns you already know that work well. Threading issues are also notoriously tricky. You might only hit a problem 1 in 10,000 times. Or never!&lt;&#x2F;p&gt;
&lt;p&gt;The point is you need &lt;strong&gt;feedback&lt;&#x2F;strong&gt; to help you form a mental model of how things work. No feedback, incorrect mental model. I am speaking from experience.&lt;&#x2F;p&gt;
&lt;p&gt;With that, let&#x27;s look at some considerations.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;apple-frameworks&quot;&gt;Apple Frameworks&lt;&#x2F;h2&gt;
&lt;p&gt;Probably the single biggest issue right now is Apple&#x27;s own frameworks aren&#x27;t all fully updated for concurrency. This means there are cases where you can hit warnings that are &lt;strong&gt;impossible&lt;&#x2F;strong&gt; to resolve without resorting to tricks. Lots of cases can be fixed with the now-familiar &lt;code&gt;nonisolated&#x2F;MainActor.assumeIsolated&lt;&#x2F;code&gt; &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;ConcurrencyRecipes&#x2F;blob&#x2F;main&#x2F;Recipes&#x2F;Protocols.md#solution-1-non-isolated-conformance&quot;&gt;dance&lt;&#x2F;a&gt;. But, in general there&#x27;s no forumla you can follow.&lt;&#x2F;p&gt;
&lt;p&gt;Thankfully there is a major new feature coming called &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-evolution&#x2F;blob&#x2F;main&#x2F;proposals&#x2F;0414-region-based-isolation.md&quot;&gt;Region-Based Isolation&lt;&#x2F;a&gt; that I think will help tremendously here. But, it has not shipped yet.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Con: lots of tricky-to-resolve warnings that will probably just go away one day&lt;&#x2F;li&gt;
&lt;li&gt;Pro: learn how to deal with libraires not built for concurrency&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;non-swift-code&quot;&gt;Non-Swift Code&lt;&#x2F;h2&gt;
&lt;p&gt;Thankfully, Apple themselves has &lt;strong&gt;lots&lt;&#x2F;strong&gt; of C, C++, and Objective-C code. There are many ways to help express concurrency concepts here, both within the non-Swift code using clang annotations, and from Swift using &lt;code&gt;nonisolated(unsafe)&lt;&#x2F;code&gt; or &lt;code&gt;@unchecked Sendable&lt;&#x2F;code&gt;. Also, all non-Swift libraries are automatically imported with &lt;code&gt;@preconcurrency&lt;&#x2F;code&gt; to try to help mitigate the problems.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Con: complex and frustrating new interoperability problems&lt;&#x2F;li&gt;
&lt;li&gt;Pro: learn how to express safety to the compiler that is otherwise invisible&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;swift-packages&quot;&gt;Swift Packages&lt;&#x2F;h2&gt;
&lt;p&gt;Whether you are using packages to define local modules, or via 3rd party libraries, the situation is roughly the same as with Apple&#x27;s libraries. The public interfaces will have an impact on concurrency usage. If they are under your control, you have maximum flexibility to do what&#x27;s required. I suspect that 3rd party libraries will begin to see a lot of bug reports as more apps run into issues.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Con: lots of warnings that could require a 3rd-party to resolve&lt;&#x2F;li&gt;
&lt;li&gt;Pro: open source opportunities, finding problematic APIs now&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;so-what-do-you-do&quot;&gt;So What Do You Do?&lt;&#x2F;h2&gt;
&lt;p&gt;I tried to keep the above reasonably opinion-free. But, here&#x27;s where I tell you what &lt;em&gt;I&lt;&#x2F;em&gt; think.&lt;&#x2F;p&gt;
&lt;p&gt;If you are using concurrency without complete checking, you do not understand it. And, if you are building APIs with concurrency features, it is possible those APIs will &lt;strong&gt;have to change&lt;&#x2F;strong&gt;. It will be possible to use Swift 6 without these specific warnings&#x2F;errors enabled. So, you can potentially kick this can down the road for quite a while. But that is not what I would recommend.&lt;&#x2F;p&gt;
&lt;p&gt;I also want to take a moment to empathize with you if this process brings up negative emotions. You didn&#x27;t ask for these features and your code works fine. I have no doubt there are many people, both outside and inside Apple that feel similarly. But, I do not think it is productive to dwell. Feel your feelings. And, then tackle this like all the other technical challenges you have overcome before. Refusing to learn or adopt Swift concurrency will not serve you well.&lt;&#x2F;p&gt;
&lt;p&gt;Here is what I recommend:&lt;&#x2F;p&gt;
&lt;p&gt;If you are &lt;strong&gt;using&lt;&#x2F;strong&gt; concurrency features today, I think it is &lt;strong&gt;important&lt;&#x2F;strong&gt; you turn complete checking on.&lt;&#x2F;p&gt;
&lt;p&gt;If you are using concurrency features in any of your module&#x27;s &lt;strong&gt;API&lt;&#x2F;strong&gt;, I think it is &lt;strong&gt;essential&lt;&#x2F;strong&gt; you turn complete checking on.&lt;&#x2F;p&gt;
&lt;p&gt;If you are building a library, regardless of whether it uses concurrency features or not, you &lt;strong&gt;should&lt;&#x2F;strong&gt; update your public API so it is warning-free.&lt;&#x2F;p&gt;
&lt;p&gt;This is a massive shift in how Swift code is written. I think some code bases will just not be able to make this transition. Some libraries will be deprecated, or even abandoned. We&#x27;ll see half-finished branches with names like &quot;concurrency&quot; in open source projects years to come. I don&#x27;t want to sound pessimistic, but I do want to prepare you in case you haven&#x27;t been thinking about this. The Swift team is doing a truly fantastic job here. But I don&#x27;t think sugar-coating the situation is helpful to anyone.&lt;&#x2F;p&gt;
&lt;p&gt;Ok, so now that you are sufficiently scared, take a breath. You have actual features you need to work on and bugs you have to address. You do not need to drop everything. But, I think you have to make &lt;strong&gt;some&lt;&#x2F;strong&gt; room in your schedule for this.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;resources&quot;&gt;Resources&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;Now-dated talk I did about concurrency: &lt;a href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=HqjqwW12wpw&quot;&gt;The Bleeding Edge of Swift Concurrency&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Repo with some common problems&#x2F;solutions: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;ConcurrencyRecipes&quot;&gt;ConcurrencyRecipes&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let me know if you have other resources you think are helpful! I&#x27;d like to include them.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Isolated Parameters</title>
        <published>2024-01-19T00:00:00+00:00</published>
        <updated>2024-01-19T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/isolated-parameters/"/>
        <id>https://massicotte.org/isolated-parameters/</id>
        
        <content type="html" xml:base="https://massicotte.org/isolated-parameters/">&lt;p&gt;I&#x27;ve been using Swift concurrency a lot over the past year or so. And I&#x27;m a bit embarrassed to say that I haven&#x27;t used isolated parameters at all. I knew they existed, and I read about them a little. But I never understood why you might use them or what problems they solve. That is, until I read this &lt;a href=&quot;https:&#x2F;&#x2F;jackmorris.xyz&#x2F;posts&#x2F;2024&#x2F;01&#x2F;12&#x2F;swift-sqlite-part-3&#x2F;&quot;&gt;post&lt;&#x2F;a&gt; by &lt;a href=&quot;https:&#x2F;&#x2F;mastodon.social&#x2F;@jackmorris&quot;&gt;Jack Morris&lt;&#x2F;a&gt;. It&#x27;s part of a series he&#x27;s been doing on a SQLite interface. There&#x27;s lots of interesting stuff in there.&lt;&#x2F;p&gt;
&lt;p&gt;But what stopped me in my tracks was his use of &lt;strong&gt;isolated parameters&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolation&quot;&gt;Isolation?&lt;&#x2F;h2&gt;
&lt;p&gt;In order for the compiler to make concurrency work, it needs to understand how it should isolate values. Often, it will have access to enough static metadata for this purpose. Things with global actor annotations like &lt;code&gt;@MainActor&lt;&#x2F;code&gt;. I would imagine that static annotations alone account for the vast majority of concurrency usage. You&#x27;re either on the &lt;code&gt;MainActor&lt;&#x2F;code&gt; or you waiting for something external that will ultimately affect the &lt;code&gt;MainActor&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;MainActor&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;mainOnly&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Next you have custom actor types. In this case, static metadata is not enough. The compiler knows that you&#x27;ve got an actor, but the specific actor reference matters at runtime. When you are interacting with an actor, this is all taken care of for you. If needed, the compile will enforce an &lt;code&gt;await&lt;&#x2F;code&gt; to ensure that it can hop (this is the term of art it seems) to the right isolation domain to ensure safety.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;otherStuff&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;doThing&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; no awaits needed in here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		otherStuff()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; actor &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; MyActor()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; await is required to isolate to `actor`&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;await actor&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;doThing()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Another kind of isolation you might not think about too much is none at all. It may seem weird, but it&#x27;s common! Any async function that isn&#x27;t tied to an actor has no isolation.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;noIsolation&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;isolated-parameters&quot;&gt;Isolated Parameters&lt;&#x2F;h2&gt;
&lt;p&gt;So far, I would imagine there&#x27;s not much new here. But there&#x27;s one more way to tell the compiler what actor a function should use.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;run&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;on actor: isolated MyActor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What does this even mean?&lt;&#x2F;p&gt;
&lt;p&gt;It took me a while to wrap my head around this. &lt;code&gt;@MainActor&lt;&#x2F;code&gt; means a function always runs on that one actor. An isolated parameter means the function runs on whatever actor is passed in. Because of this, there must be only one isolated parameter, and it must be an actor type. This is useful because it gives you a way to dynamically pass around the isolation that an actor provides.&lt;&#x2F;p&gt;
&lt;p&gt;While not equivalent, it may be helpful, at first, to think of it like an extension on the actor:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; MyActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;run&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt; &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Note that functions that use isolated parameters do not have to be async. The need for an &lt;code&gt;await&lt;&#x2F;code&gt; will determined at the call site, just like all other forms of isolation.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isolated-closure-parameters&quot;&gt;Isolated Closure Parameters&lt;&#x2F;h2&gt;
&lt;p&gt;Ok, so now we can finally get to the thing that Jack did which blew my mind. He didn&#x27;t just use isolated parameters, which would have been cool enough. He used them &lt;strong&gt;in a closure&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; actor MyActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;run&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-generic-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-begin z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;Value&lt;span class=&quot;z-punctuation z-definition z-generic-parameter-clause z-end z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;		_ action: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; (_ actor: isolated MyActor&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;	) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; we are isolated to the actor here&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		action(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; no await!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; still isolated&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;	&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is amazing. It gives you the ability to inject bits of code into an actor that uses that actor&#x27;s isolation &lt;strong&gt;without&lt;&#x2F;strong&gt; any suspension. I think Jack&#x27;s example of a transaction is fantastic. But I can imagine there are many other uses. I don&#x27;t think this is the kind of thing you&#x27;ll need to use every day. But I have encountered situations where this would have helped.&lt;&#x2F;p&gt;
&lt;p&gt;Definitely going to keep this one in mind.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Crossing the Boundary</title>
        <published>2023-09-26T00:00:00+00:00</published>
        <updated>2023-09-26T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/crossing-the-boundary/"/>
        <id>https://massicotte.org/crossing-the-boundary/</id>
        
        <content type="html" xml:base="https://massicotte.org/crossing-the-boundary/">&lt;p&gt;One of the trickier aspects of working with Swift concurrency is dealing with non-sendable types. They are everywhere! And yeah sure, sometimes it&#x27;s easy to make a type sendable. But, let&#x27;s take a look at what you can do when it &lt;strong&gt;isn&#x27;t&lt;&#x2F;strong&gt; easy.&lt;&#x2F;p&gt;
&lt;p&gt;Note: Most of the problems I&#x27;m going to discuss come up only when the Swift concurrency-specific warnings are enabled. It is not really possible to use concurrency correctly without them, so you should probably have these on too.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actor-boundaries&quot;&gt;Actor Boundaries&lt;&#x2F;h2&gt;
&lt;p&gt;Because we&#x27;re assuming that you cannot make these types sendable, you&#x27;ve only got one option. You have to somehow only use the values within a single actor context. We need to avoid crossing those actor isolation boundaries.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m going to cover four options, but no doubt there are more! These are just some that I&#x27;ve stumbled onto and found useful.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;stay-on-the-mainactor&quot;&gt;Stay on the MainActor&lt;&#x2F;h2&gt;
&lt;p&gt;Often, non-sendable types originate on the MainActor. So, just never leave it! There are so many advantages to this. You can easily interface with your UI. You can absolutely still use &lt;code&gt;async&lt;&#x2F;code&gt; to keep your UI responsive. And, wise people have often &lt;a href=&quot;https:&#x2F;&#x2F;inessential.com&#x2F;2021&#x2F;03&#x2F;20&#x2F;how_netnewswire_handles_threading&quot;&gt;advocated&lt;&#x2F;a&gt; for just sticking with the main thread as much as you can.&lt;&#x2F;p&gt;
&lt;p&gt;I think it is valuable, when you run into a sendable problem, to think hard about &lt;strong&gt;why&lt;&#x2F;strong&gt; this must be done on another actor. For me, sometimes it has just been this dogmatic goal of getting stuff off the main thread. The thing is, async&#x2F;await now makes it easy to introduce highly asynchronous behavior into your code without ever leaving the main thread. I sometimes cannot decide if this is the smartest solution or the dumbest. But it definitely is &lt;strong&gt;a&lt;&#x2F;strong&gt; solution worth consideration.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;actor-expansion&quot;&gt;Actor Expansion&lt;&#x2F;h2&gt;
&lt;p&gt;It&#x27;s pretty instructive to think about the design of the &lt;code&gt;MainActor&lt;&#x2F;code&gt;. There are &lt;strong&gt;thousands&lt;&#x2F;strong&gt; of types that are only safe to use from that one actor. It is just gigantic! Sure, it&#x27;s a special-case. But, we can still make use of the principles behind it.&lt;&#x2F;p&gt;
&lt;p&gt;Just keep making the scope of the actor bigger until there is no longer a need to pass non-sendable data around. It has expanded to contain all of it. I&#x27;m going to call this solution: &lt;strong&gt;actor expansion&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Yes, the &lt;code&gt;MainActor&lt;&#x2F;code&gt; has taken this to an extreme. But, you do not have to go nearly this far. Maybe you can increase the responsibility of your actor just &lt;strong&gt;enough&lt;&#x2F;strong&gt; to address a non-sendable problem. There is one thing to watch out for. This increased responsibility can compromise your design. I&#x27;ve found this particularly common when I have switched a type from a class to an actor.&lt;&#x2F;p&gt;
&lt;p&gt;I think actor expansion works best when you can group your concurrency problem into a well-defined chunk of functionality, just like &lt;code&gt;MainActor&lt;&#x2F;code&gt; does. But it totally can work well in other situations too. And, also like &lt;code&gt;MainActor&lt;&#x2F;code&gt;, this technique pairs really well with custom global actors. Not something you&#x27;d reach for every day, but very handy when used appropriately.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;creation-capture&quot;&gt;Creation Capture&lt;&#x2F;h2&gt;
&lt;p&gt;(The swift 6 compiler has made this technique completely unnecessary.)&lt;&#x2F;p&gt;
&lt;p&gt;Often, I run into this actor initialization problem. I want an actor to own some non-sendable value, but for some reason or other, it is not possible&#x2F;convenient for the actor to create that value itself. Here&#x27;s what this looks like:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(_ nonSendable: NonSendable) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ....&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; nonSendable &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NonSendable()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this isn&amp;#39;t allowed!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; myActor &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; MyActor(nonSendable)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;However, there&#x27;s a super-easy trick you can use to get around this! Check this out:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(_ nonSendable: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; () &lt;span class=&quot;z-keyword z-operator z-custom z-binary z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; NonSendable) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ....&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; this is fine!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; myActor &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; MyActor({ NonSendable() })
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This works because the closure is &lt;strong&gt;sendable&lt;&#x2F;strong&gt;. Remember: sendable closures can &lt;strong&gt;create&lt;&#x2F;strong&gt; non-sendable stuff, they just cannot &lt;strong&gt;capture&lt;&#x2F;strong&gt; any.&lt;&#x2F;p&gt;
&lt;p&gt;This let&#x27;s us give the caller control over the non-sendable creation process. I have found this technique really useful!&lt;&#x2F;p&gt;
&lt;p&gt;We can even get a little fancy with an &lt;code&gt;@autoclosure&lt;&#x2F;code&gt; if we really want to simplify the API:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;actor MyActor {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(_ nonSendable: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;autoclosure&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;Sendable&lt;&#x2F;span&gt; () &lt;span class=&quot;z-keyword z-operator z-custom z-binary z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; NonSendable) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ....&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; hot-damn!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; myActor &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; MyActor(NonSendable())
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;cheat&quot;&gt;Cheat&lt;&#x2F;h2&gt;
&lt;p&gt;Ok, so you&#x27;ve tried all the other options above, but you cannot find a way to get rid of these stupid sendable warnings. This happens to me most often when working with Apple APIs that have not yet been updated for concurrency. You can now do one of two things. You can live with the warnings or you can lie to the compiler. Here&#x27;s how you do the latter:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; SendableBox&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;NonSendable&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;unchecked&lt;&#x2F;span&gt; Sendable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; value: NonSendable
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(_ value: NonSendable) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;value &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; value
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; scareQuoteSendable &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; SendableBox(NonSendable())
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You have to use these kinds of tricks with extreme caution. You should be &lt;strong&gt;very&lt;&#x2F;strong&gt; confident that you are merely transferring ownership in a way that cannot introduce data races. Obviously, this is a absolute last resort.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h2&gt;
&lt;p&gt;My journey using Swift concurrency has been pretty rocky. I have run into a lot of problems along the way. Many were self-inflicted, brought about by having warnings disabled. And then, once I finally turned them on, I was on a mission to address every one. This turned out to be extremely hard. Wrestling with non-sendable types was a big part of the challenge.&lt;&#x2F;p&gt;
&lt;p&gt;I hope these tricks are handy. And, get in touch with me and let me know yours, I&#x27;d love to hear about them!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Dependencies as a Package Author</title>
        <published>2023-06-29T00:00:00+00:00</published>
        <updated>2023-06-29T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/package-author-dependencies/"/>
        <id>https://massicotte.org/package-author-dependencies/</id>
        
        <content type="html" xml:base="https://massicotte.org/package-author-dependencies/">&lt;p&gt;I remember being quite apprehensive about open sourcing my first component from work on &lt;a href=&quot;https:&#x2F;&#x2F;&#x2F;www.chimehq.com&quot;&gt;Chime&lt;&#x2F;a&gt;. I guess I was a little worried about how it would be received. Of course, it turned out just fine. In fact, it went well enough that I have continued open sourcing more and more components. Across my &lt;a href=&quot;https:&#x2F;&#x2F;swiftpackageindex.com&#x2F;mattmassicotte&quot;&gt;personal&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;swiftpackageindex.com&#x2F;ChimeHQ&quot;&gt;Chime&lt;&#x2F;a&gt; projects, I now maintain 42 packages.&lt;&#x2F;p&gt;
&lt;p&gt;One reason there are so many is I&#x27;ve come to be a huge believer in small, focused libraries. And while I do love this approach, it does come with a drawback: &lt;strong&gt;transitive dependencies&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;At first, I was pretty liberal with my own packages&#x27; dependencies. Yet consistently, the number one bit of feedback I get about people hesitating to use things I make is not bugs, lack of features&#x2F;documentation. It&#x27;s wanting to avoid dependencies. People just don&#x27;t like dependencies.&lt;&#x2F;p&gt;
&lt;p&gt;And you know what they like even less? Dependencies that have dependencies. This situation is called transitive dependencies, and I now think about it a fair bit when working on my own projects.&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s because it is a particularly tricky problem for small libraries. They often need to be used in combination with other libraries to solve concrete problems.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;case-study-editorconfig&quot;&gt;Case Study: EditorConfig&lt;&#x2F;h2&gt;
&lt;p&gt;To set the stage, we&#x27;re going to look at a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;EditorConfig&quot;&gt;package&lt;&#x2F;a&gt; I published relatively recently for working with &lt;a href=&quot;https:&#x2F;&#x2F;editorconfig.org&#x2F;&quot;&gt;editorconfig&lt;&#x2F;a&gt; files. Editorconfig is a way to help text editors maintain a standard coding style across users.&lt;&#x2F;p&gt;
&lt;p&gt;(Some readers may wonder why I did not just wrap the editorconfig C library up in a Swift package. The build process for that C library is non-trivial, and SPM cannot handle it without considerable modification.)&lt;&#x2F;p&gt;
&lt;p&gt;Editorconfig makes use of patterns called &quot;globs&quot;. Interpreting these patterns is well supported by the &lt;code&gt;fnmatch&lt;&#x2F;code&gt; standard C API. &lt;strong&gt;However&lt;&#x2F;strong&gt;, the editorconfig standard also supports something called &quot;grouping&quot;, which actually &lt;strong&gt;is not&lt;&#x2F;strong&gt; part of the standard glob syntax. But, it is really handy. In fact, it is so handy that the &lt;a href=&quot;https:&#x2F;&#x2F;microsoft.github.io&#x2F;language-server-protocol&#x2F;specifications&#x2F;lsp&#x2F;3.17&#x2F;specification&#x2F;&quot;&gt;Language Server Protocol&lt;&#x2F;a&gt; also uses globs with grouping in a number of places. And as it turns out, I also maintain &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;LanguageClient&quot;&gt;another library&lt;&#x2F;a&gt; for interacting with language servers.&lt;&#x2F;p&gt;
&lt;p&gt;Group expansion is something typically done by a shell, and it is difficult to do without one. So, I now have two, unrelated places where I need to handle the same complex operation.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-protocol&quot;&gt;A Protocol?&lt;&#x2F;h2&gt;
&lt;p&gt;One great technique for breaking transitive dependencies is to introduce a protocol. We could make an API like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;protocol&lt;&#x2F;span&gt; GlobPatternMatcher {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;match&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;string: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;class Resolver &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;    &lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(globPatternMatcher: GlobPatternMatcher) {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;    &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;Resolver&lt;&#x2F;code&gt; class has a dependency on some type that can match glob patterns. So we pull that out into a protocol, and let our clients define how it should work.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-function&quot;&gt;A Function?&lt;&#x2F;h2&gt;
&lt;p&gt;In this case, we don&#x27;t really need any of the extra powers that a protocol provides. We can get by with just a single function!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Resolver {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;typealias&lt;&#x2F;span&gt; GlobPatternMatcher &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; (&lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;) &lt;span class=&quot;z-keyword z-operator z-custom z-binary z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Bool&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(globPatternMatcher: &lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;escaping&lt;&#x2F;span&gt; GlobPatternMatcher) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;        &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This does everything we need and is also wonderfully simple.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-plain-dependency&quot;&gt;A Plain Dependency?&lt;&#x2F;h2&gt;
&lt;p&gt;Whether we choose to use a function or protocol, we still have an issue. Users of this package need to find a way to evaluate the glob patterns. This could possibly be done via another package. Or, they might opt to just use &lt;code&gt;fnmatch&lt;&#x2F;code&gt; and handle grouping incorrectly.&lt;&#x2F;p&gt;
&lt;p&gt;The point is, we&#x27;ve shifted the responsibility onto every client that would ever use this package. In the case of editorconfig, it would be easy to do, but hard to justify. This behavior is at the core of what this library is supposed to do.&lt;&#x2F;p&gt;
&lt;p&gt;So, I oped to just make another &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;GlobPattern&quot;&gt;package&lt;&#x2F;a&gt; that handles the glob logic and add it as a dependency.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;recommendations&quot;&gt;Recommendations&lt;&#x2F;h2&gt;
&lt;p&gt;I now try hard to think about any transitive dependency I bring in to my own packages. If I can pull out some &lt;strong&gt;non-critical&lt;&#x2F;strong&gt; functionality, I will. And that&#x27;s important. The package must be useful without whatever dependency you are trying to remove. If clients will always need it, you&#x27;ve saved nothing and also made your package harder to use.&lt;&#x2F;p&gt;
&lt;p&gt;When I do this, I typically reach for functions first. If I cannot get by with just one, I&#x27;d try a struct that contains a bunch of functions. Only if those two don&#x27;t work will I turn to protocols. This is plain old dependency injection. But, I haven&#x27;t run into it too often to minimize cross-package dependencies, and I think its a great way to do it.&lt;&#x2F;p&gt;
&lt;p&gt;If you are a package author, I&#x27;d recommend thinking about your own transitive dependencies more deeply. Maybe a single function could help.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Ordering and Concurrency</title>
        <published>2023-02-24T00:00:00+00:00</published>
        <updated>2023-02-24T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/ordering-and-concurrency/"/>
        <id>https://massicotte.org/ordering-and-concurrency/</id>
        
        <content type="html" xml:base="https://massicotte.org/ordering-and-concurrency/">&lt;p&gt;It was more than a full year after its introduction before I began trying out Swift&#x27;s concurrency system. I&#x27;d never used the async&#x2F;await paradigm in another language, nor did I have any experience with an &lt;code&gt;actor&lt;&#x2F;code&gt; concept. Everything was totally new to me. I watched a bunch of WWDC videos, read some blog posts, and began diving in.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;&#x2F;strong&gt;: Swift 6 has strengthened the ordering guarantees of &lt;code&gt;Task&lt;&#x2F;code&gt; via the &lt;a href=&quot;&#x2F;concurrency-swift-6-se-0431&quot;&gt;&lt;code&gt;@isolated(any)&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; attribute. This makes a big difference, but the general problems here are still applicable.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;ordering&quot;&gt;Ordering&lt;&#x2F;h2&gt;
&lt;p&gt;Migrating from a queue-based system (Dispatch&#x2F;Operation) with completion handlers, at first, was amazing! I felt like I was removing so much noise from my code. However, I quickly began experiencing something that really surprised me: races. Lots of them. At the core of the issue was a fundamental misunderstanding on my part.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;asyncWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ block: (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;func work() async
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;These two functions have a &lt;strong&gt;critical&lt;&#x2F;strong&gt; difference. The &lt;code&gt;asyncWork&lt;&#x2F;code&gt; form has an opportunity to run &lt;strong&gt;synchronously&lt;&#x2F;strong&gt; before beginning any internal asynchronous work. In fact, it doesn&#x27;t even need to be asynchronous at all.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;async&lt;&#x2F;code&gt; version &lt;strong&gt;cannot&lt;&#x2F;strong&gt; run code synchronously before starting if isolation changes. The &lt;code&gt;await&lt;&#x2F;code&gt; keyword makes that impossible to guarantee.&lt;&#x2F;p&gt;
&lt;p&gt;This difference is subtle - it certainly wasn&#x27;t obvious to me. And, there are many cases where it also doesn&#x27;t matter. But, if you have a system where the ordering of operations is important, it is &lt;strong&gt;absolutely essential&lt;&#x2F;strong&gt; you understand this:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;em&gt;You cannot hide ordering requirements from the callers&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;when-does-it-start&quot;&gt;When does it start?&lt;&#x2F;h2&gt;
&lt;p&gt;The key to understanding the ordering problem really comes down to thinking about when work starts vs when it completes. First, take a peek at the non-async version:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;asyncWork {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In this version, the function begins execution synchronously, &lt;strong&gt;right now&lt;&#x2F;strong&gt;, and finishes later. Things are different with the async version:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await work()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;With a &lt;code&gt;Task&lt;&#x2F;code&gt;, the function of course finishes later. But, it also &lt;strong&gt;begins&lt;&#x2F;strong&gt; execution later too. The only way to control for the start of a &lt;code&gt;Task&lt;&#x2F;code&gt; is to &lt;code&gt;await&lt;&#x2F;code&gt; it.&lt;&#x2F;p&gt;
&lt;p&gt;The million dollar question is - does this matter? I think that being unable to synchronously run code in this way makes some kinds of synchronization techniques trickier.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;no-queue&quot;&gt;No Queue&lt;&#x2F;h2&gt;
&lt;p&gt;Here&#x27;s a pattern that I have found comes up quite a bit. It&#x27;s just a class with an internal queue to protect some state.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;private&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; internalQueue &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; DispatchQueue(label: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;y&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;q&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;beginWork&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;with value: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;, _ block: (&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Void&lt;&#x2F;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		internalQueue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;async {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; access some mutable state&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			print(value)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			doSomeOtherAsyncThings {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				block()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;work&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;with value: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; async &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		withCheckedContinuation {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			beginWork(with: value) {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;				$&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;resume()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;		}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The problem arises when you look at how this class is used. It&#x27;s been accessed synchronously, but those accesses are spread out over a bunch of disconnected systems.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;myclass&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;beginWork(with: &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;w&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; across functions, nested within functions, but all done synchronously,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; on the main thread&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;myclass&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;beginWork(with: &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;2&lt;&#x2F;span&gt;) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	print(&lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;w&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;i&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;t&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;h&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;2&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The callers invoke the function with &lt;code&gt;1&lt;&#x2F;code&gt; first, and then later on, invoke it with &lt;code&gt;2&lt;&#x2F;code&gt;. Translating this to an async call is problematic. Despite the internal synchronization, the correct ordering of events is now up to the callers.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await myclass&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;work(with: &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; across functions, nested within functions...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;Task {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await myclass&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;work(with: &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;2&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Even though it looks like 1 happens before 2 &lt;strong&gt;and&lt;&#x2F;strong&gt; the class has an internal queue, it can and will happen that 2 completes before 1. Now that the API offers an &lt;code&gt;async&lt;&#x2F;code&gt; version, it&#x27;s easier to introduce races. The solution is to &lt;code&gt;await&lt;&#x2F;code&gt; on the first task. But, the structure of your existing legacy code can make that really difficult.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;yes-queue&quot;&gt;Yes Queue&lt;&#x2F;h2&gt;
&lt;p&gt;You might be thinking this is a lot of words to tell me &quot;If you want A to happen before B, you must make sure A happens before B&quot;. And, yeah, you&#x27;re right. But, this wasn&#x27;t immediately obvious to me while moving towards using async functions. And I imagine it might not be obvious to others. It really took me quite a while to fully appreciate this problem.&lt;&#x2F;p&gt;
&lt;p&gt;If you have no implicit ordering requirements, hooray! If you can make the dependent tasks explicit - great! But if you are unlucky enough to have a system where ordering does matter, and a code base that makes explicit task dependencies difficult to express - you have yourself a problem.&lt;&#x2F;p&gt;
&lt;p&gt;In hindsight, it&#x27;s obvious: there&#x27;s no such thing as an implicit task dependency. But, when migrating complex systems, I bet this is something others have run into. As a stop-gap solution, I put together a &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;Queue&quot;&gt;FIFO task queue&lt;&#x2F;a&gt;. It works almost like an &lt;code&gt;OperationQueue&lt;&#x2F;code&gt;, but accepts async closures.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; queue &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; AsyncQueue()
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;addOperation {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await myclass&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;work(with: &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;1&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; ... lots of annoying legacy stuff ...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;queue&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;addOperation {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	await myclass&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;work(with: &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;2&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I&#x27;ve really just hoisted the internal queue out and made it the callers responsibility. I really don&#x27;t like that. Explicit task dependencies are the solution, but can be pretty tricky to weave though in some cases.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;returning-tasks&quot;&gt;Returning Tasks&lt;&#x2F;h2&gt;
&lt;p&gt;An promising alternative is to flip the problem on its head. Instead of creating an async function that you call in a task, you make a synchronous API that returns a &lt;code&gt;Task&lt;&#x2F;code&gt;. Something like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; MyClass {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;workTask&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;with value: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Task&amp;lt;(), Never&amp;gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; chance to do synchronous work here...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; Task {
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;			&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; async work can occur in this block&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;		&lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;	}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This option restores your ability to protect internal state at time of call. It also makes for easy cancellation support. I have not gone deep with this technique yet, so it&#x27;s difficult for me to say with confidence that it works well. But right now, I&#x27;m really liking it.&lt;&#x2F;p&gt;
&lt;p&gt;If you&#x27;ve faced similar problems, I&#x27;d love to hear from you.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Using Cassandra with Swift</title>
        <published>2022-12-22T00:00:00+00:00</published>
        <updated>2022-12-22T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/cassandra-with-swift/"/>
        <id>https://massicotte.org/cassandra-with-swift/</id>
        
        <content type="html" xml:base="https://massicotte.org/cassandra-with-swift/">&lt;p&gt;When I first found out that Apple &lt;a href=&quot;https:&#x2F;&#x2F;www.techrepublic.com&#x2F;article&#x2F;apples-secret-nosql-sauce-includes-a-hefty-dose-of-cassandra&quot;&gt;uses Cassandra&lt;&#x2F;a&gt;, I mused that perhaps they would open source a Swift Cassandra client. That was in 2016. But, here we are in 2022 and it actually happened! Apple&#x27;s client is now on &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;apple&#x2F;swift-cassandra-client&quot;&gt;GitHub&lt;&#x2F;a&gt; and I&#x27;m pumped.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-is-cassandra&quot;&gt;What is Cassandra?&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;cassandra.apache.org&quot;&gt;Cassandra&lt;&#x2F;a&gt; is a &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;NoSQL&quot;&gt;NoSQL&lt;&#x2F;a&gt; database. It does not support the traditional SQL statements or constructs like you&#x27;d find with Postgres or MySQL. Though, its CQL query language is very close. Cassandra (and NoSQL in general) makes big trade-offs between functionality and performance&#x2F;availability. I think Cassandra is a tool worth at least knowing about, if you do server-side work.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve &lt;a href=&quot;https:&#x2F;&#x2F;www.chimehq.com&#x2F;blog&#x2F;aws-keyspaces&quot;&gt;written&lt;&#x2F;a&gt; about Keyspaces before, which goes into more depth about why you might pick Cassandra over another database. Many people building low-volume, cost-sensitive systems default to &lt;a href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;dynamodb&#x2F;&quot;&gt;DynamoDB&lt;&#x2F;a&gt; because it has a free tier. I was looking for a way to run a very-low-cost system, and at the time, it was the only option from AWS. But, I&#x27;ve since transitioned over to Keyspaces. It also has a free tier and I think for &lt;strong&gt;most&lt;&#x2F;strong&gt; similar uses, it is the better choice. I&#x27;ve found it far easier to use and is at least potentially portable across cloud providers.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;running-a-cluster&quot;&gt;Running a Cluster&lt;&#x2F;h2&gt;
&lt;p&gt;For better or worse, I became a Cassandra database admin during my time at Crashlytics. I learned more than I&#x27;d like to know about Cassandra operations. And, while I came to really like many things about it, I wouldn&#x27;t want to run a cluster again. I didn&#x27;t know it at the time, but Cassandra is notoriously difficult to manage successfully. This reputation was, at least when I was doing it, well-deserved.&lt;&#x2F;p&gt;
&lt;p&gt;This has motivated the development of hosted Cassandra services. These are fully managed Cassandra systems that you can just use without dealing with operations. The ones I know of are &lt;a href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;keyspaces&#x2F;&quot;&gt;AWS Keyspaces&lt;&#x2F;a&gt;, &lt;a href=&quot;https:&#x2F;&#x2F;www.datastax.com&#x2F;products&#x2F;datastax-astra&quot;&gt;Astra&lt;&#x2F;a&gt;, and on &lt;a href=&quot;https:&#x2F;&#x2F;azure.microsoft.com&#x2F;en-us&#x2F;products&#x2F;managed-instance-apache-cassandra&#x2F;&quot;&gt;Azure&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve been using Keyspaces since it was in beta, and I think it is &lt;strong&gt;excellent&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;using-swift&quot;&gt;Using Swift&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.datastax.com&quot;&gt;Datastax&lt;&#x2F;a&gt;, the company that oversees the Cassandra project, maintains a number of client libraries. I spent a little time wrapping their C++ driver in Swift, and got as far as a basic proof-of-concept. But, I never took it further than that. I find it really interesting that Apple&#x27;s client is structured the same way. Though they actually did a good job and also finished.&lt;&#x2F;p&gt;
&lt;p&gt;I don&#x27;t have much experience using Swift on a server. I experimented with using a Swift-based Lambda function to read from an &lt;a href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;sqs&#x2F;&quot;&gt;AWS SQS&lt;&#x2F;a&gt; queue, and that&#x27;s it. It was maybe 20 lines of code. But I never really went further with it, mainly because of the lack of Cassandra support.&lt;&#x2F;p&gt;
&lt;p&gt;But, now this isn&#x27;t an obstacle anymore! So, let&#x27;s build a simple system that does HTTP API -&amp;gt; Lambda -&amp;gt; Keyspaces all using only Swift. And, it will all comfortably fit within the AWS free-tier limits.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;managing-aws-resources&quot;&gt;Managing AWS Resources&lt;&#x2F;h2&gt;
&lt;p&gt;Nearly all of the tutorials I&#x27;ve found for using AWS and Swift involve the AWS web console. But, AWS also supports programmatic configuration, via a system called &lt;a href=&quot;https:&#x2F;&#x2F;aws.amazon.com&#x2F;cloudformation&#x2F;&quot;&gt;CloudFormation&lt;&#x2F;a&gt;. I learned CloudFormation pretty late, but I think it&#x27;s the way to go for even small-sized deployments. It has a pretty steep learning curve, but it is worth it. Managing stuff with the AWS console is &lt;strong&gt;possible&lt;&#x2F;strong&gt;, but gets untenable quite quickly.&lt;&#x2F;p&gt;
&lt;p&gt;Just don&#x27;t forget the rule: never manually delete resources created by CloudFormation.&lt;&#x2F;p&gt;
&lt;p&gt;Using the CloudFormation template I&#x27;ve produced here will allow you to both create and remove nearly all the resources needed for this example with a few clicks. There are a few things, however, that I wasn&#x27;t able to automate. So, there will still be some console usage. I&#x27;ve kind of glossed over all that, so if this is your first time using AWS, it could be tricky. Don&#x27;t be shy to reach out to me with questions!&lt;&#x2F;p&gt;
&lt;p&gt;I also want to point out that CloudFormation can be used to create IAM resources. IAM controls the security of your AWS account. The template I&#x27;ve made needs to create an IAM role. It is tightly scoped to allow just what is required, but you may still want to have a look.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;preparation&quot;&gt;Preparation&lt;&#x2F;h2&gt;
&lt;p&gt;Using CloudFormation to manage the &lt;strong&gt;creation&lt;&#x2F;strong&gt; of an S3 buckets is tricky. So, I&#x27;m not even going to attempt that here. To get this example going, though, you&#x27;ll need one. I like to make a &lt;code&gt;deploy.MY_DOMAIN&lt;&#x2F;code&gt; bucket for CloudFormation-related resources.&lt;&#x2F;p&gt;
&lt;p&gt;Also, I haven&#x27;t yet worked out how to correctly &lt;a href=&quot;https:&#x2F;&#x2F;docs.aws.amazon.com&#x2F;general&#x2F;latest&#x2F;gr&#x2F;signing-aws-api-requests.html&quot;&gt;sign requests&lt;&#x2F;a&gt; with Apple&#x27;s Cassandra client. This means that you need to create a special IAM user with Keyspaces-specific credentials. I &lt;strong&gt;think&lt;&#x2F;strong&gt; this is possible with CloudFormation, but I decided not to even try, because I hope to work this out and make this all unnecessary. And that would be nice, because IAM is incredibly complicated.&lt;&#x2F;p&gt;
&lt;p&gt;So, you need to create a new IAM user manually. These are the policies that it requires, and can be added inline. Note that you need to fill in your account id (no hypens). You can also use the visual editor to create these policies, which is what I did.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;json&quot; class=&quot;language-json z-code&quot;&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-mapping z-begin z-json&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;	&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Version&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;2012-10-17&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-pair z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;	&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Statement&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-json&quot;&gt;[&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;		&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-mapping z-begin z-json&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;			&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Sid&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;VisualEditor0&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-pair z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;			&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Effect&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Allow&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-pair z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;			&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Action&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-json&quot;&gt;[&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;				&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;cassandra:Create&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;				&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;cassandra:Select&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;				&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;cassandra:Modify&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;			&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-json&quot;&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-pair z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;			&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Resource&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-json&quot;&gt;[&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;			    &lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;arn:aws:cassandra:*:YOUR_ACCOUNT_ID_GOES_HERE:&#x2F;keyspace&#x2F;swift_keyspaces_test&#x2F;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;			    &lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;arn:aws:cassandra:*:YOUR_ACCOUNT_ID_GOES_HERE:&#x2F;keyspace&#x2F;swift_keyspaces_test&#x2F;table&#x2F;*&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;			&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-json&quot;&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;		&lt;span class=&quot;z-punctuation z-section z-mapping z-end z-json&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;		&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-mapping z-begin z-json&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;			&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Sid&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;VisualEditor1&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-pair z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;			&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Effect&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Allow&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-pair z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;			&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Action&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;cassandra:Select&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-pair z-json&quot;&gt;,&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;			&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-key z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;Resource&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-mapping z-key-value z-json&quot;&gt;:&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;arn:aws:cassandra:*:YOUR_ACCOUNT_ID_GOES_HERE:&#x2F;keyspace&#x2F;system&#x2F;table&#x2F;*&lt;span class=&quot;z-punctuation z-definition z-string z-end z-json&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;		&lt;span class=&quot;z-punctuation z-section z-mapping z-end z-json&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-json&quot;&gt;	&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-json&quot;&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-json&quot;&gt;&lt;span class=&quot;z-meta z-mapping z-value z-json&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-mapping z-end z-json&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once that&#x27;s done, generate and record the Keyspaces credentials on the &quot;Security credentials&quot; page. We&#x27;ll need these later.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;building&quot;&gt;Building&lt;&#x2F;h2&gt;
&lt;p&gt;(Update: This is all way easier now with Swiftly and the Linux SDK, available from swift.org!)&lt;&#x2F;p&gt;
&lt;p&gt;I had a surprising amount of difficulty getting a simple Lambda function working with Swift. These problems basically came down to a slightly-out-of-date tutorial, and the fact that I&#x27;m using an arm mac. I&#x27;ve tried my best to automate this all away. All the code you&#x27;ll need is &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mattmassicotte&#x2F;swift-keyspaces&quot;&gt;open source&lt;&#x2F;a&gt;. Swift currently cannot cross-compile, so you will also need Docker installed.&lt;&#x2F;p&gt;
&lt;p&gt;With all that, you can use some shell scripts I made to create the two artifacts we need. The first produces a Lambda layer that just packages up some needed certificates for authentication. The second actually builds the executable.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; class=&quot;language-sh z-code&quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-support z-function z-cd z-shell&quot;&gt;cd&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; path&#x2F;to&#x2F;swift-keyspaces-repo&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;sh&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; scripts&#x2F;layer.sh&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;sh&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; scripts&#x2F;build.sh&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;deploying&quot;&gt;Deploying&lt;&#x2F;h2&gt;
&lt;p&gt;The artifacts that these scripts produce need to copied to that S3 bucket we mentioned earlier. You also need to copy the CloudFormation template &lt;code&gt;SwiftKeyspaces.yml&lt;&#x2F;code&gt; located in the root of the repo to that bucket as well.&lt;&#x2F;p&gt;
&lt;p&gt;With all of this in place, we can use CloudFormation to create all of the resources needed to test this out. The CloudFormation console has a wizard that guides you though the process. Here are the highlights:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;head on over to the CloudFormation console&lt;&#x2F;li&gt;
&lt;li&gt;create a new stack (with new resources)&lt;&#x2F;li&gt;
&lt;li&gt;Use the default &quot;Template is ready&quot; option&lt;&#x2F;li&gt;
&lt;li&gt;Point it to https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;YOUR_BUCKET_NAME&#x2F;SwiftKeyspaces.yml&lt;&#x2F;li&gt;
&lt;li&gt;Name it &quot;SwiftKeyspaces&quot;&lt;&#x2F;li&gt;
&lt;li&gt;Select the architecture of your local machine&lt;&#x2F;li&gt;
&lt;li&gt;Provide your bucket name&lt;&#x2F;li&gt;
&lt;li&gt;Tick the box allowing IAM access&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let it rip. I kind of enjoy watching the events go by. It&#x27;s fascinating to see everything being created. When finished, it will produce an &quot;Output&quot; with the URL of the HTTP API we can use. However, we have just two more manual steps to complete first. I promise, we&#x27;re almost there.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;data-and-credentials&quot;&gt;Data and Credentials&lt;&#x2F;h2&gt;
&lt;p&gt;Hopefully this went smoothly. If it did not, please open up an issue in the project repo and I&#x27;ll help!&lt;&#x2F;p&gt;
&lt;p&gt;We now have two manual steps left. First, we need to put some test data into the database. Navigate over to the Keyspaces console, and select the &quot;CQL editor&quot;. Run the following statement:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sql&quot; class=&quot;language-sql z-code&quot;&gt;&lt;code class=&quot;language-sql&quot; data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;z-source z-sql&quot;&gt;&lt;span class=&quot;z-keyword z-other z-DML z-sql&quot;&gt;INSERT INTO&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-other z-database-name z-sql&quot;&gt;swift_keyspaces_test&lt;&#x2F;span&gt;.&lt;span class=&quot;z-constant z-other z-table-name z-sql&quot;&gt;test_table&lt;&#x2F;span&gt; (key, value) &lt;span class=&quot;z-keyword z-other z-DML z-II z-sql&quot;&gt;VALUES&lt;&#x2F;span&gt; (&lt;span class=&quot;z-string z-quoted z-single z-sql&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-sql&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;hello&lt;span class=&quot;z-punctuation z-definition z-string z-end z-sql&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;, &lt;span class=&quot;z-string z-quoted z-single z-sql&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-sql&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;world&lt;span class=&quot;z-punctuation z-definition z-string z-end z-sql&quot;&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Ok, now remember that special Keyspaces user we created? We have to get those credentials into our Lambda function. Head on over to the Lambda console, and select the &lt;code&gt;SwiftKeyspaces&lt;&#x2F;code&gt; function. From there, select &quot;Configuration&quot; &amp;gt; &quot;Environment Variables&quot;. Edit them, replacing the placeholders with the real values. Assuming you used my policies from above, these credentials cannot do &lt;strong&gt;anything&lt;&#x2F;strong&gt; but interact with our test database.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;finally&quot;&gt;Finally&lt;&#x2F;h2&gt;
&lt;p&gt;Whew. We can now finally actually use our HTTP API.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; class=&quot;language-sh z-code&quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;curl&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; https:&#x2F;&#x2F;0b8k4zfibe.execute-api.us-east-1.amazonaws.com&#x2F;Test&#x2F;keyspaces&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;[{&lt;span class=&quot;z-string z-quoted z-double z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-shell&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;key&lt;span class=&quot;z-punctuation z-definition z-string z-end z-shell&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;:&lt;span class=&quot;z-string z-quoted z-double z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-shell&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;hello&lt;span class=&quot;z-punctuation z-definition z-string z-end z-shell&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;,&lt;span class=&quot;z-string z-quoted z-double z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-shell&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;value&lt;span class=&quot;z-punctuation z-definition z-string z-end z-shell&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;:&lt;span class=&quot;z-string z-quoted z-double z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-shell&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;world&lt;span class=&quot;z-punctuation z-definition z-string z-end z-shell&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;&#x2F;span&gt;}&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I know that was quite a lot of set up for something so trivial. But, this proof-of-concept is pretty incredible and something I&#x27;ve been wanting to try for years. I currently have a similar system using Go. It has performed very well, and has cost me basically zero. But, if I had to do it all over again, I&#x27;d definitely give Swift a shot.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;d also genuinely love to hear about your use of Cassandra. Designing schemas is tricky, but I really enjoy it! If you have questions about anything here, please reach out!&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Supporting older SDK versions with Swift</title>
        <published>2022-02-28T00:00:00+00:00</published>
        <updated>2022-02-28T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/swift-and-old-sdks/"/>
        <id>https://massicotte.org/swift-and-old-sdks/</id>
        
        <content type="html" xml:base="https://massicotte.org/swift-and-old-sdks/">&lt;p&gt;The Swift Package Manager has made it easier than ever to make a library with wide compatibility. By default, SPM packages even support Linux! However, it can be quite tricky to support different major iOS and macOS SDK versions. Swift provides a number of conditional compilation conditions that can be used to help. But, there is currently no way to determine what SDK you are building against.&lt;&#x2F;p&gt;
&lt;p&gt;Or is there?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-initial-problem&quot;&gt;The Initial Problem&lt;&#x2F;h2&gt;
&lt;p&gt;The type &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;uikit&#x2F;nstextlocation&quot;&gt;&lt;code&gt;NSTextLocation&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; was introduced in iOS 15&#x2F;macOS 12. Let&#x27;s say you want to add an extension on this type. Your first pass might look something like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; os(macOS)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;AppKit&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#elseif os(iOS) &lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;||&lt;&#x2F;span&gt; os(tvOS)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;UIKit&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#endif
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-begin z-swift&quot;&gt;available&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;(&lt;span class=&quot;z-meta z-attribute z-arguments z-swift&quot;&gt;iOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;15&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, macOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;12&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, tvOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;15&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, &lt;span class=&quot;z-keyword z-operator z-arithmetic z-swift&quot;&gt;*&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; NSTextLocation {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is a pretty good start. You&#x27;ve got the conditional &lt;code&gt;import&lt;&#x2F;code&gt; statements and you&#x27;ve used the &lt;code&gt;@available&lt;&#x2F;code&gt; directive to indicate the runtime availability. However, this code still has some compatibility issues.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;using-available&quot;&gt;Using @available&lt;&#x2F;h2&gt;
&lt;p&gt;As written, this code will fail to build for watchOS. And, perhaps less obviously, will also fail to build on Linux. I think maintaining broad compatibility is a good general goal, so let&#x27;s try to do better.&lt;&#x2F;p&gt;
&lt;p&gt;You might be tempted, as I was at first, to try something like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-begin z-swift&quot;&gt;available&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;(&lt;span class=&quot;z-meta z-attribute z-arguments z-swift&quot;&gt;iOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;15&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, macOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;12&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, tvOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;15&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, &lt;span class=&quot;z-keyword z-operator z-arithmetic z-swift&quot;&gt;*&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-begin z-swift&quot;&gt;available&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;(&lt;span class=&quot;z-meta z-attribute z-arguments z-swift&quot;&gt;watchOS, unavailable&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-begin z-swift&quot;&gt;available&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;(&lt;span class=&quot;z-meta z-attribute z-arguments z-swift&quot;&gt;Linux, unavailable&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; NSTextLocation {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is true that this extension is unavailable for these platforms. However, the thing to keep in mind is &lt;code&gt;@available&lt;&#x2F;code&gt; controls &lt;strong&gt;runtime&lt;&#x2F;strong&gt; availability. So, while these directives seem appropriate, the type &lt;code&gt;NSTextLocation&lt;&#x2F;code&gt; won&#x27;t even exist at &lt;strong&gt;compile&lt;&#x2F;strong&gt; time on watchOS or Linux.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;more-conditional-compilation&quot;&gt;More Conditional Compilation&lt;&#x2F;h2&gt;
&lt;p&gt;Just like with the &lt;code&gt;import&lt;&#x2F;code&gt;, we need to control what code the compiler sees, and we have to do that with conditional compilation statements. Luckily, this is a pretty straightforward thing to do.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; os(macOS)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;AppKit&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#elseif os(iOS) &lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;||&lt;&#x2F;span&gt; os(tvOS)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-import z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-import z-swift&quot;&gt;import&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-module z-import z-swift&quot;&gt;UIKit&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#endif
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; os(macOS) &lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;||&lt;&#x2F;span&gt; os(iOS) &lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;||&lt;&#x2F;span&gt; os(tvOS)
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-attribute z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute z-swift&quot;&gt;@&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-begin z-swift&quot;&gt;available&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;(&lt;span class=&quot;z-meta z-attribute z-arguments z-swift&quot;&gt;iOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;15&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, macOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;12&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, tvOS &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;15&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;, &lt;span class=&quot;z-keyword z-operator z-arithmetic z-swift&quot;&gt;*&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-attribute-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-other z-access-level-modifier z-swift&quot;&gt;public&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; NSTextLocation {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-keyword z-operator z-range z-swift&quot;&gt;...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#endif
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The fix is a little unsightly, perhaps, but it works. We&#x27;re now using conditional compilation to control the visibility of the extension itself. This is critical to prevent the compiler from running into the &lt;code&gt;NSTextLocation&lt;&#x2F;code&gt; type when it hasn&#x27;t been defined. You can pretty much always assume that conditional compilation around &lt;code&gt;import&lt;&#x2F;code&gt; statements means you need it other places too.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;older-xcode-sdk&quot;&gt;Older Xcode&#x2F;SDK&lt;&#x2F;h2&gt;
&lt;p&gt;At this point, I wouldn&#x27;t blame you for calling it a day. This code will compile on all platforms that Swift supports, even Windows! But, there&#x27;s a very subtle issue still lurking here - older SDKs.&lt;&#x2F;p&gt;
&lt;p&gt;This code will &lt;strong&gt;only&lt;&#x2F;strong&gt; compile with a version of Xcode that ships with the iOS 15&#x2F;mac 12.0 SDK. As written, this will fail to build for Xcode 12. Typically, this isn&#x27;t a huge problem. Developers adopt new Xcode versions quickly...&lt;&#x2F;p&gt;
&lt;p&gt;...except when new SDKs are released in beta!&lt;&#x2F;p&gt;
&lt;p&gt;This phenomenon strikes around WWDC, and while rare, has also come up a few other times. If you maintain a library and want to start working with new types in the SDK, it will affect you. As far as I know, there is no nice way of handling this situation. Some might opt for a special branch of the code, and that may be the most sensible option. But, there is another tool we can use.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sdk-conditionals&quot;&gt;SDK conditionals&lt;&#x2F;h2&gt;
&lt;p&gt;What we really want is to conditionalize our code not just on platform, but &lt;strong&gt;SDK version&lt;&#x2F;strong&gt; as well. The problem is, as of writing, Swift does not support that. Swift offers exactly six conditional compilation conditions: &lt;code&gt;os()&lt;&#x2F;code&gt;, &lt;code&gt;arch()&lt;&#x2F;code&gt;, &lt;code&gt;swift()&lt;&#x2F;code&gt;, &lt;code&gt;compiler()&lt;&#x2F;code&gt;, &lt;code&gt;canImport()&lt;&#x2F;code&gt;, &lt;code&gt;hasfeature()&lt;&#x2F;code&gt;, and &lt;code&gt;targetEnvironment()&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;We can use &lt;code&gt;compiler()&lt;&#x2F;code&gt; as a proxy for SDK version. It&#x27;s not pretty, but gets the job done. Here&#x27;s how:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;#&lt;span class=&quot;z-keyword z-control z-if z-swift&quot;&gt;if&lt;&#x2F;span&gt; (os(macOS) &lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;||&lt;&#x2F;span&gt; os(iOS) &lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;||&lt;&#x2F;span&gt; os(tvOS)) &lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;&amp;amp;&amp;amp;&lt;&#x2F;span&gt; compiler(&lt;span class=&quot;z-keyword z-operator z-comparative z-swift&quot;&gt;&amp;gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;5&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;5&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We&#x27;re making use of the fact that we know Xcode 13, the one with the SDK we need, shipped with Swift 5.5. The last version of Xcode 12 shipped with Swift 5.4.2. For reference, Xcode 14 uses Swift 5.7.&lt;&#x2F;p&gt;
&lt;p&gt;Note that we don&#x27;t want to use &lt;code&gt;swift()&lt;&#x2F;code&gt;, as that value represents the &lt;strong&gt;language&lt;&#x2F;strong&gt; version. We need the &lt;strong&gt;compiler&lt;&#x2F;strong&gt; version here.&lt;&#x2F;p&gt;
&lt;p&gt;Also, don&#x27;t forget about that &lt;code&gt;canImport()&lt;&#x2F;code&gt; condition. It wasn&#x27;t helpful for us in this particular example, but it&#x27;s very handy when a new framework is introduced.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping Up&lt;&#x2F;h2&gt;
&lt;p&gt;It&#x27;s surprisingly tricky to keep Swift packages compatible with all the platforms that the language actually supports. And, while I think it&#x27;s a nice thing to do, I&#x27;m not advocating for huge efforts. Just a little understanding of conditional compilation and some care can go a long way. Plus, it just feels good to see all those green checkboxes over at the &lt;a href=&quot;https:&#x2F;&#x2F;swiftpackageindex.com&quot;&gt;Swift Package Index&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I won&#x27;t lie, I don&#x27;t love this &lt;code&gt;compiler()&lt;&#x2F;code&gt; trick. It won&#x27;t even always work. It is not a guarantee that the compiler version changes across Xcode versions. But, for major releases, it&#x27;s quite likely. Regardless, I think it&#x27;s a handy thing to keep in your toolbox, especially around WWDC season.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>Preparing for Technical Interviews</title>
        <published>2021-11-05T00:00:00+00:00</published>
        <updated>2021-11-05T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/interview-prep/"/>
        <id>https://massicotte.org/interview-prep/</id>
        
        <content type="html" xml:base="https://massicotte.org/interview-prep/">&lt;p&gt;You want a job writing computer programs. To get this job, you&#x27;ll almost certainly need to do at least one technical interview. The point of this is to evaluate your knowledge and ability at solving technical problems. A very common style is called the &quot;whiteboard&quot; interview. They are &lt;strong&gt;notoriously&lt;&#x2F;strong&gt; difficult. Interviewing is already stressful enough as it is, but having to hand-write tricky code in front of an audience who&#x27;s job is to judge you is just brutal.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;d like to offer some tips and tricks to use before and during a technical interview.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;whiteboarding&quot;&gt;&quot;whiteboarding&quot;&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s start with a quick definition. To me, whiteboarding is an in-person interview where the candidate has to solve a problem by hand-writing a solution. There definitely has to be hand-writing involved, but a whiteboard isn&#x27;t strictly required. Because computer science puzzles are so frequently asked in these kinds of interviews, it&#x27;s common for people to use &quot;whiteboarding&quot; to refer to this kind of question. That&#x27;s what I&#x27;m doing here.&lt;&#x2F;p&gt;
&lt;p&gt;Technical interviewing, and the puzzle-on-a-whiteboard-style in particular, is a very contentious topic. I&#x27;ve conducted ~ hundreds of interviews, and for years I asked whiteboard-style questions. It took me an embarrassingly long time start wondering about the effectiveness of this technique, and even longer to try other methods. But, now that I have, I am &lt;strong&gt;firmly&lt;&#x2F;strong&gt; against this approach. I believe it is a poor evaluation technique. But, what I think is not relevant. It might be &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;poteto&#x2F;hiring-without-whiteboards&quot;&gt;losing favor&lt;&#x2F;a&gt;, but it is still very common.&lt;&#x2F;p&gt;
&lt;p&gt;If you want to land a job at a tech company, it&#x27;s very likely you&#x27;ll have to do some whiteboarding.&lt;&#x2F;p&gt;
&lt;p&gt;Traditionally, a whiteboarding interview was done in person. More and more, interviewing is being done remotely. The whiteboarding interview could be replaced with a pair-programming tool or screen sharing. I have never been the interviewee or interviewer for a remote technical interview. While some of what I cover here might be helpful in a remote context, a lot of it is geared to an in-person setting.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;preparation&quot;&gt;preparation&lt;&#x2F;h2&gt;
&lt;h4 id=&quot;topics&quot;&gt;- topics&lt;&#x2F;h4&gt;
&lt;p&gt;Focus is often algorithm and&#x2F;or data structures. Things like linked-lists, trees, and searching within strings. Perhaps the most (in)famous whiteboarding is &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Fizz_buzz&quot;&gt;FizzBuzz&lt;&#x2F;a&gt;. Recursion can come up. &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Time_complexity&quot;&gt;Big O&lt;&#x2F;a&gt; and performance is often discussed, can even be a primary aspect of the problem.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;research&quot;&gt;- research&lt;&#x2F;h4&gt;
&lt;p&gt;This one is a no-brainer. There are numerous places online where you can learn about the kinds of questions asked at larger companies. By no means does this guarantee you&#x27;ll find questions ahead of time. But, I think it can be a great starting point for your preparation. Also very helpful if you have target companies and&#x2F;or interviews already lined up.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;study&quot;&gt;- study&lt;&#x2F;h4&gt;
&lt;p&gt;Because everyone knows whiteboarding is common, especially at larger tech companies, people study. And I mean I have heard of people doing hundreds of practice problems. I think at least some study is a very good idea, especially for data structures.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;services&quot;&gt;- services&lt;&#x2F;h4&gt;
&lt;p&gt;I&#x27;ve noticed others enjoying both &lt;a href=&quot;https:&#x2F;&#x2F;leetcode.com&quot;&gt;leetcode&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;codesignal.com&quot;&gt;codesignal&lt;&#x2F;a&gt;. I haven&#x27;t used them much, but they do look like they add some fun elements to the work.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;reading&quot;&gt;- reading&lt;&#x2F;h4&gt;
&lt;p&gt;I know of two books written on the subject, if that&#x27;s your style. Check out &lt;a href=&quot;https:&#x2F;&#x2F;technicalinterviews.dev&quot;&gt;De-Coding the Technical Inteview Process&lt;&#x2F;a&gt; and &lt;a href=&quot;https:&#x2F;&#x2F;www.crackingthecodinginterview.com&quot;&gt;Cracking the Coding Interview&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;flash-cards&quot;&gt;- flash cards&lt;&#x2F;h4&gt;
&lt;p&gt;I stumbled across a pretty noval way of studying programming problems: &lt;a href=&quot;https:&#x2F;&#x2F;technical-flashcards.myshopify.com&#x2F;products&#x2F;data-structure-flashcards&quot;&gt;flash cards&lt;&#x2F;a&gt;! Might be just the ticket for certain people.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;hand-writing-code&quot;&gt;- hand-writing code&lt;&#x2F;h4&gt;
&lt;p&gt;I think there is enormous value in just standing at a whiteboard and writing code. The first time I ever did this was while being interviewed. Not ideal. Have you ever tried to write an actual curly brace? This all sound silly, but the hand-writing element can really throw you off. Do not underestimate how different it is from using a computer.&lt;&#x2F;p&gt;
&lt;p&gt;I think it also could be quite useful to practice writing code with a pairing tool. Even though a lot of the challenges of the physical whiteboard are removed, it&#x27;s still something you don&#x27;t want to be doing for the first time ever in the interview.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;tactics&quot;&gt;tactics&lt;&#x2F;h2&gt;
&lt;h4 id=&quot;make-sure-the-task-is-clear&quot;&gt;- make sure the task is clear&lt;&#x2F;h4&gt;
&lt;p&gt;This is your first priority. You must make sure that you understand exactly what problem you are being asked to solve.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;come-up-with-test-cases&quot;&gt;- come up with test cases&lt;&#x2F;h4&gt;
&lt;p&gt;For questions that involve accepting input, write down some test cases. This also helps to confirm you understand the problem. Start trivial, and build up. Move on to edge-cases. Think about zero-length arrays, null pointers, negative integers. Don&#x27;t let them surprise you.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;talk-about-performance&quot;&gt;- talk about performance&lt;&#x2F;h4&gt;
&lt;p&gt;Performance can be a critical part of the evaluation. Be ready to talk about &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Time_complexity&quot;&gt;Big O&lt;&#x2F;a&gt; (Big O).&lt;&#x2F;p&gt;
&lt;h4 id=&quot;be-extremely-careful-with-names&quot;&gt;- be extremely careful with names&lt;&#x2F;h4&gt;
&lt;p&gt;Go very slow and deliberate when naming functions and variables. A poorly-chosen variable name can really add difficulty. As you work, make sure you update names as logic changes.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;manage-space&quot;&gt;- manage space&lt;&#x2F;h4&gt;
&lt;p&gt;Be careful with the physical writing space you have. Things can go from a big, intimidating empty board to a cramped mess fast.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;d recommend thinking about three separate areas. One is for discussing the problem and writing out test input&#x2F;outputs. The other two are coding areas. You cannot copy&#x2F;paste, so two spots give you space to rewrite, if needed, without having to erase.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;erasing-code&quot;&gt;erasing code&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;ve noticed one almost universal problem people have when writing code on a whiteboard - they are hesitant to erase. This results in so many problems. Someone&#x27;s first thought is a for loop, and now they are struggling because it would be much easier to do recursively. A variable is named &quot;currentNode&quot; when &quot;nextNode&quot; is what they need. It might sound surprising, but people get locked into what they write. Particularly for names and flow control.&lt;&#x2F;p&gt;
&lt;p&gt;You have to be really consious of this problem. This is one of the reasons I recommend keeping two separate spaces for writing down code. This way, if you being to have issues, you can try another approach &lt;strong&gt;without&lt;&#x2F;strong&gt; losing any work.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;if-you-get-stuck&quot;&gt;if you get stuck&lt;&#x2F;h2&gt;
&lt;h4 id=&quot;explain-the-problem&quot;&gt;- explain the problem&lt;&#x2F;h4&gt;
&lt;p&gt;Talk about what isn&#x27;t working. Don&#x27;t just stare, think out loud.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;fall-back-to-your-tests&quot;&gt;- fall back to your tests&lt;&#x2F;h4&gt;
&lt;p&gt;Stop, take a breath. Run though a simple case again.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;reset&quot;&gt;- reset&lt;&#x2F;h4&gt;
&lt;p&gt;Are you using the right kind of loop? Is there a tricky case you can handle before&#x2F;after your main logic? Is your function signature ok? When in doubt, start again.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;finished-vs-perfect&quot;&gt;- finished vs perfect&lt;&#x2F;h4&gt;
&lt;p&gt;You should assume that it is better to finish and acknowledge weaknesses in your solution. If you are struggling to handle an edge case, state that and continue. If you have time for another attempt, you can refer to your previous work (two coding spaces!).&lt;&#x2F;p&gt;
&lt;h2 id=&quot;you-got-this&quot;&gt;you got this&lt;&#x2F;h2&gt;
&lt;p&gt;Whiteboarding can be brutally difficult. Standing up in front of people to hand-write code is such an unusual and uniquely stressful experience. Many people, myself definitely included, have stories about whiteboarding interviews they completely bombed.&lt;&#x2F;p&gt;
&lt;p&gt;But, hopefully these tips on preparation and hand-writing code help to improve your chances.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>The Curious Case of SwiftUI&#x27;s Coordinator Parent</title>
        <published>2021-04-12T00:00:00+00:00</published>
        <updated>2021-04-12T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/swiftui-coordinator-parent/"/>
        <id>https://massicotte.org/swiftui-coordinator-parent/</id>
        
        <content type="html" xml:base="https://massicotte.org/swiftui-coordinator-parent/">&lt;p&gt;I&#x27;m a real beginner when it comes to SwiftUI. I&#x27;ve dabbled here and there, but for the most part, I really don&#x27;t know what I&#x27;m doing. Recently, an opportunity came up to give it another try. For this particular experiment, I wanted to wrap up a pre-existing view so I could access it from SwiftUI. That part is pretty standard stuff. However, I ran into an interesting issue, and I bet I&#x27;m not alone.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The Problem&lt;&#x2F;h2&gt;
&lt;p&gt;When I&#x27;m learning a new API, I like to start with a new project. This helps me focus on the task and avoid the complexities of integration with a larger project. My goal was to wrap up an &lt;code&gt;NSTableView&lt;&#x2F;code&gt; and get that into a SwiftUI view hierarchy. So, I created my new project and  proceeded to follow along with Apple&#x27;s SwiftUI tutorial on &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;tutorials&#x2F;swiftui&#x2F;interfacing-with-uikit&quot;&gt;Interfacing with UIKit&lt;&#x2F;a&gt;, adapting it to AppKit and my problem as needed.&lt;&#x2F;p&gt;
&lt;p&gt;I was feeling pretty good because I got something working quite quickly. This implementation follows the &lt;code&gt;View&lt;&#x2F;code&gt;-&lt;code&gt;NSView&lt;&#x2F;code&gt;-&lt;code&gt;Coordinator&lt;&#x2F;code&gt; pattern, and the structure makes sense once you stare at it for a bit.&lt;&#x2F;p&gt;
&lt;p&gt;Here&#x27;s the code I came up with:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; EventsTableView: NSViewRepresentable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; events: [&lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;]
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;makeCoordinator&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Coordinator &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        Coordinator(&lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;    &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;makeNSView&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;context: Context&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; NSScrollView &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; column &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NSTableColumn(identifier: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;exampleColumn)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        column&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;width &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;100&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-swift&quot;&gt;0&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; tableView &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NSTableView()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        tableView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;headerView &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; &lt;span class=&quot;z-constant z-nil z-swift&quot;&gt;nil&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        tableView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;addTableColumn(column)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        tableView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;delegate &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; context&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;coordinator
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        tableView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;dataSource &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; context&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;coordinator
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; view &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; NSScrollView()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        view&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;documentView &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; tableView
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; view
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;    &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;updateNSView&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ nsView: NSScrollView, context: Context&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; tableView &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; nsView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;documentView &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt; NSTableView
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        tableView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;reloadData()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;    &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;extension&lt;&#x2F;span&gt; EventsTableView {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-keyword z-other z-declaration-modifier z-swift&quot;&gt;final&lt;&#x2F;span&gt; &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;class&lt;&#x2F;span&gt; Coordinator: NSObject, NSTableViewDataSource, NSTableViewDelegate {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;        &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; parent: EventsTableView
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;        &lt;span class=&quot;z-keyword z-declaration z-swift&quot;&gt;init&lt;&#x2F;span&gt;(_ parent: EventsTableView) {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;            &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;parent &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; parent
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;        }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;        &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;numberOfRows&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-control z-loop z-swift&quot;&gt;in&lt;&#x2F;span&gt; tableView: NSTableView&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt; &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;            &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; parent&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;events&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;count
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;        &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;tableView&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ tableView: NSTableView, viewFor tableColumn: NSTableColumn?, row: &lt;span class=&quot;z-support z-type z-swift&quot;&gt;Int&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; NSView? &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;            &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; reusedView &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; tableView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;makeView(withIdentifier: &lt;span class=&quot;z-keyword z-operator z-custom z-prefix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;exampleColumn, owner: &lt;span class=&quot;z-keyword z-other z-statement z-swift&quot;&gt;self&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;            &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; view &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; reusedView &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as?&lt;&#x2F;span&gt; NSTextField ?? NSTextField(labelWithString: &lt;span class=&quot;z-meta z-literal z-string z-swift&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-quoted z-double z-swift&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;            view&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;stringValue &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; parent&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;events[row]
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;            &lt;span class=&quot;z-keyword z-control z-transfer z-swift&quot;&gt;return&lt;&#x2F;span&gt; view
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    }
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I said that things were working. But, once I tried a little more experimenting, I quickly discovered that the contents of my table view would never change, even though I was reloading the table on updates.&lt;&#x2F;p&gt;
&lt;p&gt;Of course, in hindsight the problem now seems obvious. And, you might very well have already noticed it. But, if you haven&#x27;t, don&#x27;t feel bad as it took me quite a bit of debugging and thinking to fully understand what was wrong.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;parent&quot;&gt;Parent?&lt;&#x2F;h2&gt;
&lt;p&gt;SwiftUI interoperability is all based around a wrapper view, &lt;code&gt;EventsTableView&lt;&#x2F;code&gt; and its &lt;code&gt;Coordinator&lt;&#x2F;code&gt;. That &lt;code&gt;Coodinator&lt;&#x2F;code&gt; instance will then get passed back as context when the view needs to change. This relationship between wrapping view and coordinator is critical, &lt;strong&gt;as is&lt;&#x2F;strong&gt; understanding their lifecycle relationship.&lt;&#x2F;p&gt;
&lt;p&gt;See, a SwiftUI view can (and definitely does) get re-created very liberally during normal execution. But, your coordinator instance is created only once, and then is re-used as much as possible. This is pretty standard value type&#x2F;reference type stuff. When a &lt;code&gt;Coordinator&lt;&#x2F;code&gt; takes in the wrapping view as an initialization parameter, it makes a &lt;strong&gt;copy&lt;&#x2F;strong&gt; of that first view. That copy is not updated when the SwiftUI wrapper view is re-created.&lt;&#x2F;p&gt;
&lt;p&gt;My issue was the parent property (and its associated &lt;code&gt;events&lt;&#x2F;code&gt;) were copied once when the &lt;code&gt;Coordinator&lt;&#x2F;code&gt; was created, and then never updated. Once I realized this, I felt dumb. Views are value types, &lt;em&gt;of course&lt;&#x2F;em&gt; it wasn&#x27;t updating! But, I don&#x27;t want to be too hard on myself, because this pattern of a &lt;code&gt;Coordinator&lt;&#x2F;code&gt; capturing its parent view is ubiquitous. It is present in &lt;a href=&quot;https:&#x2F;&#x2F;www.swiftbysundell.com&#x2F;articles&#x2F;swiftui-and-uikit-interoperability-part-1&#x2F;&quot;&gt;many&lt;&#x2F;a&gt;, &lt;a href=&quot;https:&#x2F;&#x2F;www.hackingwithswift.com&#x2F;books&#x2F;ios-swiftui&#x2F;using-coordinators-to-manage-swiftui-view-controllers&quot;&gt;many&lt;&#x2F;a&gt;, &lt;a href=&quot;https:&#x2F;&#x2F;swiftwithmajid.com&#x2F;2020&#x2F;01&#x2F;29&#x2F;using-uikit-views-in-swiftui&#x2F;&quot;&gt;many&lt;&#x2F;a&gt; blog posts on the subject. And, all of them, including Apple&#x27;s (ostensibly authoritative) &lt;a href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;tutorials&#x2F;swiftui&#x2F;interfacing-with-uikit&quot;&gt;tutorial&lt;&#x2F;a&gt;, use this parent pattern. I  assume that&#x27;s where this all started.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;capture-properties&quot;&gt;Capture Properties&lt;&#x2F;h2&gt;
&lt;p&gt;In my case, the solution was straight-forward. The key was to capture and update the &lt;strong&gt;data&lt;&#x2F;strong&gt; in the coordinator instance.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;swift&quot; class=&quot;language-swift z-code&quot;&gt;&lt;code class=&quot;language-swift&quot; data-lang=&quot;swift&quot;&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-swift&quot;&gt;struct&lt;&#x2F;span&gt; EventsTableView: NSViewRepresentable {
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;var&lt;&#x2F;span&gt; events: [&lt;span class=&quot;z-support z-type z-swift&quot;&gt;String&lt;&#x2F;span&gt;]
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;makeCoordinator&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-meta z-function-result z-swift&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-function-result z-swift&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt; Coordinator &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        Coordinator(events: events) &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; &amp;lt;- Here!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;    &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; snip...&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;    &lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-swift&quot;&gt;func&lt;&#x2F;span&gt; &lt;span class=&quot;z-entity z-type z-function z-swift&quot;&gt;updateNSView&lt;&#x2F;span&gt;&lt;span class=&quot;z-meta z-parameter-clause z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-begin z-swift&quot;&gt;(&lt;&#x2F;span&gt;_ nsView: NSScrollView, context: Context&lt;span class=&quot;z-punctuation z-definition z-function-arguments z-end z-swift&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt; &lt;span class=&quot;z-punctuation z-definition z-code-block z-begin z-swift&quot;&gt;{&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        context&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;coordinator&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;events &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; events &lt;span class=&quot;z-comment z-line z-double-slash z-swift&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-line z-double-slash z-swift&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt; &amp;lt;- And here!&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        &lt;span class=&quot;z-storage z-type z-swift&quot;&gt;let&lt;&#x2F;span&gt; tableView &lt;span class=&quot;z-keyword z-operator z-assignment z-swift&quot;&gt;=&lt;&#x2F;span&gt; nsView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;documentView &lt;span class=&quot;z-keyword z-operator z-type-casting z-swift&quot;&gt;as&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-swift&quot;&gt;!&lt;&#x2F;span&gt; NSTableView
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;        tableView&lt;span class=&quot;z-keyword z-operator z-custom z-postfix z-unary z-swift&quot;&gt;.&lt;&#x2F;span&gt;reloadData()
&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;&lt;span class=&quot;z-meta z-function-declaration z-swift&quot;&gt;    &lt;span class=&quot;z-punctuation z-definition z-code-block z-end z-swift&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;&#x2F;span&gt;&lt;span class=&quot;z-source z-swift&quot;&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once I fully realized that the coordinator instance is long-lived, capturing the parent made no sense. But, it did trick me into thinking I had a reference-type relationship, which &lt;em&gt;would&lt;&#x2F;em&gt; have worked. If only this property was called &lt;code&gt;firstParent&lt;&#x2F;code&gt; or &lt;code&gt;creatingView&lt;&#x2F;code&gt;, perhaps I wouldn&#x27;t have made this mistake.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;never-capture-parent&quot;&gt;Never Capture Parent&lt;&#x2F;h2&gt;
&lt;p&gt;After going through all of this, I&#x27;m not sure I can think of a reason why you&#x27;d ever need to capture a copy of a &lt;code&gt;Coordinator&lt;&#x2F;code&gt;&#x27;s creating view. If you know of a reason why this parent-Coordinator pattern might be useful, please let me know. But, even if there are some appropriate situations, I still think that it&#x27;s so easy to get confused, just like I did, it should probably be avoided.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>The Complex and Sad State of Exceptions</title>
        <published>2020-02-01T00:00:00+00:00</published>
        <updated>2020-02-01T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/sad-state-of-exceptions/"/>
        <id>https://massicotte.org/sad-state-of-exceptions/</id>
        
        <content type="html" xml:base="https://massicotte.org/sad-state-of-exceptions/">&lt;p&gt;Checking my notes, I was a little surprised to discover that I&#x27;ve been working on this post, in various forms, for nearly ten years. Ten years! Everyone has a pet topic and for me, apparently, it&#x27;s exceptions. While I did start writing about it a long time ago, the history of exceptions for Apple development goes much further back. When I first started this post, the situation wasn&#x27;t good. I&#x27;m quite disappointed to report that the situation has only improved a small amount in that time.&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;ll get to that. First, background.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;what-is-an-exception&quot;&gt;What is an Exception&lt;&#x2F;h3&gt;
&lt;p&gt;Error handling is a big part of programming. In my experience, there are many situations where error handling even represents the majority of the work. Exception handling was conceived as a way to help manage the complexity of error handling.&lt;&#x2F;p&gt;
&lt;p&gt;It was a noble effort. But, in my opinion, it &lt;strong&gt;completely backfired&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Central to the concept of exceptions is the ability to transfer control from the site of the error to a handler. That handler can be within any calling function and can cross library boundaries. This establishes an invisible control flow path and does so in a way that &lt;strong&gt;cannot&lt;&#x2F;strong&gt; be reasoned about ahead of time. These unexpected control-flow paths can very easily cause memory leaks, resource management issues, and state corruption. In fact, the problem is so bad that exceptions have actually introduced an entirely new class of programming problem, known collectively as &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Exception_safety&quot;&gt;exception safety&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The problems exception handling introduces are profound. They are similar to, but much worse than the issues with goto. And, we&#x27;ve known this for a &lt;a href=&quot;http:&#x2F;&#x2F;www.lighterra.com&#x2F;papers&#x2F;exceptionsharmful&#x2F;&quot;&gt;long time&lt;&#x2F;a&gt;. Catching exceptions is bad.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;history&quot;&gt;History&lt;&#x2F;h3&gt;
&lt;p&gt;Apple has a fascinating relationship with exceptions and it is surprisingly complex. There have actually been three distinct exception handling mechanisms used with Objective-C since Mac OS X 10.0 shipped. And, iOS used a hybrid system until arm64 was introduced, so that kinda makes four.&lt;&#x2F;p&gt;
&lt;p&gt;There is some pretty interesting history in NSException.h. Things started with the &lt;code&gt;NS_DURING&lt;&#x2F;code&gt; and &lt;code&gt;NS_HANDLER&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;NS_ENDHANDLER&lt;&#x2F;code&gt; macros. These three macros could be used much like the more familiar try and catch statements of other languages. Internally, the exception was propagated via the magic of the POSIX APIs setjmp and longjmp. SjLj, as this is often called, allows you to perform the necessary non-local (i.e. out of the current function) jumps.&lt;&#x2F;p&gt;
&lt;p&gt;Things changed in a small, but important way with 10.3. That release brought with it a language extension that supported the &lt;code&gt;@try&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;@catch&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;@finally&lt;&#x2F;code&gt; syntax. The runtime still used SjLj under the covers, but exceptions felt a lot more integrated with the environment. They got their own syntax, after all. This was the state of the art until exceptions were turned completely on their head in 10.5.&lt;&#x2F;p&gt;
&lt;p&gt;Mac OS X 10.5 introduced Objective-C 2.0, and with the runtime&#x27;s 64-bit variant, zero-cost exceptions. &quot;Wow!&quot; I remember thinking. &quot;Zero-Cost! 64-Bit!&quot;. It felt like a big change and even made it into the &lt;a href=&quot;http:&#x2F;&#x2F;arstechnica.com&#x2F;apple&#x2F;2007&#x2F;10&#x2F;mac-os-x-10-5&#x2F;6&#x2F;&quot;&gt;definitive review&lt;&#x2F;a&gt;. This 64-bit Objective-C runtime also enabled binary compatibility with C++ exceptions. The syntax was the same, but boy oh boy, were things different internally.&lt;&#x2F;p&gt;
&lt;p&gt;Exceptions were now implemented using something called DWARF CFI. This is a low-level mechanism for describing arbitrary register mutations as a function of the current state of a thread. It is extremely complex and also resource-intensive when throwing. But, it has the big advantage of having zero runtime overhead when entering a try block.&lt;&#x2F;p&gt;
&lt;p&gt;DWARF CFI is part of a &lt;a href=&quot;http:&#x2F;&#x2F;dwarfstd.org&quot;&gt;standard&lt;&#x2F;a&gt;, but Apple decided to add their own flavor to the exception propagation system. They added something called compact_unwind, which is dramatically simpler, but can only describe a limited number of situations. Those situations were the common case, however, so I have to assume this was a significant win for runtime performance.&lt;&#x2F;p&gt;
&lt;p&gt;When iOS shipped, it used an identical system to Objective-C 2.0 on macOS, but went with a SjLj implementation. It was an interesting hybrid and it remained in place until arm64. At that transition, Apple took the time to bring compact_unwind and DWARF CFI to iOS as well.&lt;&#x2F;p&gt;
&lt;p&gt;Interestingly, due to some significant ABI differences, compact_unwind on arm64 can describe many more situations. So many, that it is extremely unusual for DWARF CFI to be required for an iOS binary. I went looking for instances at one point, while working on DWARF CFI support for Crashlytics. I searched through many examples of debug info, and was able to find exactly &lt;strong&gt;one function&lt;&#x2F;strong&gt; with DWARF CFI. It was some kind of C++ destructor, naturally.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;the-woes&quot;&gt;The Woes&lt;&#x2F;h3&gt;
&lt;p&gt;Just as the exception implementation system has evolved, so has Apple&#x27;s use of exceptions within their own frameworks. In fact, macOS has a surprisingly large amount of framework-level integration with exceptions. As far as I know, none have survived the transition to iOS, and thank goodness. Because the situation on macOS is not good.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;problem-1-appleevents&quot;&gt;Problem #1: AppleEvents&lt;&#x2F;h4&gt;
&lt;p&gt;Under the hood, many kinds of events for macOS apps are driven by the AppleEvent system. For the most part, this is an implementation detail that does not actually impact you at all. Except for one big one: the AppleEvents system catches exceptions. And, as it turns out, it is the AppleEvent system that ultimately invokes &lt;code&gt;applicationDidFinishLaunching&lt;&#x2F;code&gt;. Here&#x27;s a &lt;a href=&quot;https:&#x2F;&#x2F;lapcatsoftware.com&#x2F;articles&#x2F;NSAssert.html&quot;&gt;good post&lt;&#x2F;a&gt; that summarizes the problem.&lt;&#x2F;p&gt;
&lt;p&gt;This means that if your app throws an exception during initialization, you do not crash. Your app just starts running with incomplete initialization. This has been a source of significantly weird bugs for myself, and I would imagine that it is a very common failure-mode for macOS apps in general. Of course, we&#x27;ll never know because this silent failure is extremely difficult to capture and report without resorting to pretty terrible hacks.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;problem-2-appkit&quot;&gt;Problem #2: AppKit&lt;&#x2F;h4&gt;
&lt;p&gt;Another common event path is routed through AppKit and &lt;code&gt;NSApplication&lt;&#x2F;code&gt; internals. These paths also catch exceptions. Of course, AppKit itself is horrendously exception-unsafe. So, once this happens, AppKit typically corrupts both your app&#x27;s state and its own. Your app will likely cease to function correctly from that point on. Maybe it crashes later on, maybe not.&lt;&#x2F;p&gt;
&lt;p&gt;Mercifully, AppKit includes a reasonably well-known default that controls this behavior. &lt;code&gt;NSApplicationCrashOnExceptions&lt;&#x2F;code&gt; causes &lt;code&gt;NSApplication&lt;&#x2F;code&gt; to terminate the app if it catches an exception.&lt;&#x2F;p&gt;
&lt;p&gt;If you are an AppKit developer, stop what you are doing &lt;strong&gt;right now&lt;&#x2F;strong&gt; and make sure you have this set.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;problem-3-xpc&quot;&gt;Problem #3: XPC&lt;&#x2F;h4&gt;
&lt;p&gt;While I do not have personal experience here, I stumbled across a &lt;a href=&quot;https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;54967355&#x2F;xpc-and-exception-handling&quot;&gt;Stack Overflow post&lt;&#x2F;a&gt; that seems to indicate that the XPC system also catches exceptions. I don&#x27;t have much to add to this one, because I haven&#x27;t run into it in person. But, I&#x27;m certain it is responsible for many bugs.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m disappointed that this kind of behavior would be introduced into such a relatively new framework. By now, I would have assumed everyone would know better.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;problem-4-exceptionhandling-framework&quot;&gt;Problem #4: ExceptionHandling.framework&lt;&#x2F;h4&gt;
&lt;p&gt;There&#x27;s a macOS-only framework called &quot;ExceptionHandling.framework&quot;. It provides a bunch of facilities for intercepting runtime exceptions, signals, and mach exceptions. I haven&#x27;t experimented with it in a long time. But, based on my recollection, it had some really terrible behavior in each of these cases.&lt;&#x2F;p&gt;
&lt;p&gt;It had some fundamental implementation issues, and so I opened a few radars. In one, I received a response that said, more or less, &quot;this framework is basically deprecated, do not use it&quot;. It should really be officially deprecated.&lt;&#x2F;p&gt;
&lt;p&gt;If you are making use of this framework, you should really stop right now. It doesn&#x27;t work correctly. You might find &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ChimeHQ&#x2F;Meter&quot;&gt;Meter&lt;&#x2F;a&gt; helpful if you need custom crash reporting facilities.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;swift&quot;&gt;Swift&lt;&#x2F;h3&gt;
&lt;p&gt;I was incredibly relieved to find that Swift left exceptions out in the initial implementation. It was actually one of the first things I tested when experimenting with it. However, don&#x27;t think you are safe. Exceptions can still &quot;pass over&quot; Swift frames, so Swift definitely isn&#x27;t immune to exception safety issues.&lt;&#x2F;p&gt;
&lt;p&gt;I have to say I was a little dismayed to see the introduction of Swift&#x27;s error-throwing system. Thankfully, the implementation isn&#x27;t subject to the non-local jump phenomenon. But, it is still possible to get tripped up by the implicit code path a throw can cause. Overall, I don&#x27;t care for it, but I&#x27;m not sure I could have come up with a better system. Error handling is a hard problem.&lt;&#x2F;p&gt;
&lt;p&gt;(Update: I have since come to quite like Swift&#x27;s error system, haha.)&lt;&#x2F;p&gt;
&lt;h3 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h3&gt;
&lt;p&gt;iOS developers have, for the most part, been spared all the pain of this exception handling nonsense. There are a few places, however, where even they can run into problems. A handful of Apple APIs throw exceptions for non-exceptional circumstances. An example is &lt;code&gt;NSFileHandle&lt;&#x2F;code&gt;. Luckily, recently Apple has been putting efforts in to fix these. More of this please!&lt;&#x2F;p&gt;
&lt;p&gt;But, fixing these APIs is just not enough. I&#x27;ve actually made it a point to complain to AppKit engineers every time I make it to WWDC about this topic. A common concern I&#x27;ve heard is around binary compatibility. If the behavior is changed, apps that were previously &quot;working&quot; will now start crashing. I&#x27;m going to bet that for every crash this prevents, there are 1000&#x27;s of bugs it introduces. Plus, that crash is at least detectable and fixable. Silent, undetectable state corruption is just about the worst possible option you could choose. There is someone, somewhere filing a bug with Apple &lt;strong&gt;right now&lt;&#x2F;strong&gt; that will be completely unreproducible. Why? Because it was caused by this exception-catching behavior.&lt;&#x2F;p&gt;
&lt;p&gt;Catching exceptions is almost never the right option and Apple needs to stop doing it.&lt;&#x2F;p&gt;
</content>
        
    </entry>
    <entry xml:lang="en">
        <title>How to Read Bug Reports</title>
        <published>2016-12-08T00:00:00+00:00</published>
        <updated>2016-12-08T00:00:00+00:00</updated>
        
        <author>
          <name>
            
              Matt Massicotte
            
          </name>
        </author>
        
        <link rel="alternate" type="text/html" href="https://massicotte.org/reading-bug-reports/"/>
        <id>https://massicotte.org/reading-bug-reports/</id>
        
        <content type="html" xml:base="https://massicotte.org/reading-bug-reports/">&lt;p&gt;Earlier this year, I read a really wonderful &lt;a href=&quot;https:&#x2F;&#x2F;pspdfkit.com&#x2F;blog&#x2F;2016&#x2F;writing-good-bug-reports&#x2F;&quot;&gt;post&lt;&#x2F;a&gt; by &lt;a href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;steipete&quot;&gt;Peter Steinberger&lt;&#x2F;a&gt; on writing good bug reports. This post reached me at a really personal level, for a bunch of reasons. First and foremost, it is discussing a topic that’s near and dear to my heart. It may seem like bug reports are a funny topic to care so much about, but I do. I’ve been writing software for a long time, and it really matters to me when someone using that software has a problem. The post also focuses on reporting bugs to Apple. I’ve been fortunate enough to see radar from the inside, so I feel a connection to this kind of report in particular. And, finally, as if all that wasn’t enough, it lead with a quote from a friend and former coworker (Hi Tanya!).&lt;&#x2F;p&gt;
&lt;p&gt;I want to say that I think Peter’s recommendations are excellent. He has a great take here on how to increase the probability of getting the desired outcome from a report — a fix. However, I cannot help but feel sad that Peter had to do this. I sincerely wish that his post wasn’t necessary. The outside world should not have to rely (partially) on social engineering to get attention to their issues. So, I though it could be helpful, especially since I was once on the other side of these reports, to offer a complimentary take.&lt;&#x2F;p&gt;
&lt;p&gt;I’d like to start with a story — back to my time at Apple.&lt;&#x2F;p&gt;
&lt;p&gt;For a number of years, a regular part of my day was to triage and investigate iOS battery life radars. These came from all the sources you could imagine — external developers to internal Apple folks. That included Apple Store employees. One day, I received a novel of a bug report from a Store Genius. This person was attempting to help a customer, who was experiencing poor battery life after updating to a newer version of iOS. First, they followed all procedures to the letter, including hardware and software configurations, the customer’s own account of the issue, and well as observations they’d made. But, boy oh boy, they went further than that.&lt;&#x2F;p&gt;
&lt;p&gt;They also grabbed a number of difference devices, installed the new and old OSes on them, and ran experiments. They attempted to measure the battery level changes over a period of time, while emulating the setup the customer had. They included a spreadsheet of their results, along with some requests for additional instrumentation that would help them produce better test results. The tests were run over a number of days, possibly even a week if I remember correctly.&lt;&#x2F;p&gt;
&lt;p&gt;I was just blown away by the effort this person had put in, ostensibly just to help one customer. I was proud to see that kind of dedication, and also felt for them. I’m sure this customer was frustrated, and I can only imagine that at least some of this testing was done on personal time. But, I also couldn’t help but feel sorry for this poor Genius, bending over backwards here.&lt;&#x2F;p&gt;
&lt;p&gt;Now, this was a while ago, so I cannot remember all the details. But, I do recall that had I narrowed down the issue to maybe 2–3 bugs almost right away. And, I was able to do that just via the customer account + configuration. The whole time I’m reading this report, I’m getting more and more amazed at how much unnecessary info is there. All that work, testing, and writing. All I really needed to know was something like “customer has both Exchange 2007 and 2010 accounts, and is running iOS 5”.&lt;&#x2F;p&gt;
&lt;p&gt;Of course, this Genius couldn’t have known that. But, had he just submitted the bug with the minimum info, I could have saved him a bunch of effort and addressed that customer’s issue way faster.&lt;&#x2F;p&gt;
&lt;p&gt;This account was just one of the countless interactions I had via Radar. Of course, there were less positive experiences that shaped my thoughts as well. But, I think this story speaks to many of the approaches I now use when dealing with bug reports. I’ve used many different systems. I currently use no tracking system at all, and I highly recommend it. It took me a while, but I now look at bug tracking systems kinda like I look at UML diagrams (ha!).&lt;&#x2F;p&gt;
&lt;p&gt;Here are the things I now do&#x2F;think about when dealing with a bug report. Some of these are contentious. Some conflict with each other. This are just my guidelines, but they have served me very well. If you have a different approach that works for you, I’d love to hear about it!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;my-guidelines&quot;&gt;My Guidelines&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;consider-every-report-a-gift&quot;&gt;Consider every report a gift&lt;&#x2F;h3&gt;
&lt;p&gt;Feedback is incredibly valuable, in all cases. Here, it is an opportunity to make your product better AND impress a customer. Tell me there is something your time is better spent doing than that.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;try-to-respond-to-every-report&quot;&gt;Try to respond to every report&lt;&#x2F;h3&gt;
&lt;p&gt;I happen to like it, but I know that not everyone enjoys interacting with customers. Find a way to respond in some fashion, if you can. I have a theory that it’s bad for business to ignore customers.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;do-everything-you-can-to-encourage-reports&quot;&gt;Do everything you can to encourage reports&lt;&#x2F;h3&gt;
&lt;p&gt;Your software is riddled with bugs. You don’t need a fully-reduced, reproducible example to know that the stupid table re-ordering bug is happening again. It’s your job to debug, not your customers. Raising the bar too high will just prevent you from getting reports.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;ask-for-clarification-even-if-you-re-sure-you-know-what-s-up&quot;&gt;Ask for clarification, even if you’re sure you know what’s up&lt;&#x2F;h3&gt;
&lt;p&gt;You’ll rarely get all the info you need in a report. Instead, just ask for more info. You have all the domain knowledge anyways, so you know best how to narrow things down. Worst-case, you get no answer. This can also be a good technique for helping customer’s realize that it really is a feature and not a bug :)&lt;&#x2F;p&gt;
&lt;p&gt;Of course, your customers may not always be willing to help. Consider taking some time to brainstorm on better tooling and&#x2F;or diagnostics. A bug report template is the lowest-common denominator — you can do better.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;save-your-responses&quot;&gt;Save your responses&lt;&#x2F;h3&gt;
&lt;p&gt;Over time, you’ll find you have to respond in similar ways over and over. Save your responses, so you can refer to them and reuse them if needed. Also makes for great knowledge-base fodder.&lt;&#x2F;p&gt;
&lt;p&gt;I’ve never been great at this, and I always regret it.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;don-t-laugh-off-low-priority-bugs&quot;&gt;Don’t laugh off low-priority bugs&lt;&#x2F;h3&gt;
&lt;p&gt;Sometimes, I find it hard to even take reports seriously. Obscure use-cases, esoteric configurations — these are the kinds of things that tempt you to just hit delete. But, you have to keep in mind that to this customer, this problem was important enough to take the time to write this all up. Give it the respect it deserves, even if that is just a “I’m afraid that’s not in the plans right now”.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;never-ignore-a-rude-report&quot;&gt;Never ignore a rude report&lt;&#x2F;h3&gt;
&lt;p&gt;Believe me, I know. This is the hardest thing to deal with. I’ve lost sleep, many times, over rude feedback around my work.&lt;&#x2F;p&gt;
&lt;p&gt;My general approach is to get especially technical and thorough when someone is being belligerent. I find it can be quite disarming, while also helping to make sure I spend the time to really know what I’m taking about. It tends to be times like this when I’m most likely to make mistakes and say something wrong&#x2F;dumb. Go slow, and get it right.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;value-the-feedback&quot;&gt;Value The Feedback&lt;&#x2F;h2&gt;
&lt;p&gt;Dealing with bug reports can be really draining. Especially when people are rude or mean. But, it’s also an opportunity to learn about your work. Your software has all kinds of bugs, everywhere, and customers are seeing them. Only a tiny fraction are going to go through the trouble of reporting them. Find a way to make sure they feel great when they do that. Do something, because your product is your responsibility and no one else’s.&lt;&#x2F;p&gt;
&lt;p&gt;There are people out there willing to work for &lt;strong&gt;free&lt;&#x2F;strong&gt; to make your stuff better. All you have to do is &lt;strong&gt;listen&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
</content>
        
    </entry>
</feed>
