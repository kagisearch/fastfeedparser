<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Gatsby Starter Blog RSS Feed]]></title><description><![CDATA[An engineering blog about parallel computing]]></description><link>https://gessfred.xyz</link><generator>GatsbyJS</generator><lastBuildDate>Sun, 04 Jan 2026 14:09:13 GMT</lastBuildDate><item><title><![CDATA[About]]></title><description><![CDATA[Hi, my name is Fred, a computer scientist particularily interested in compilers, deep learning, hardware accelerators, parallel computing‚Ä¶]]></description><link>https://gessfred.xyz/</link><guid isPermaLink="false">https://gessfred.xyz/</guid><content:encoded>&lt;p&gt;Hi, my name is Fred, a computer scientist particularily interested in compilers, deep learning, hardware accelerators, parallel computing, and data analysis. Published researcher as an undergrad. EPFL and Amazon alumni. Currently a consultant at the biggest firm in Switzerland.&lt;/p&gt;
&lt;h1&gt;Contact&lt;/h1&gt;
&lt;p&gt;Email: &lt;a href=&quot;mailto:gessfred@protonmail.com&quot;&gt;gessfred@protonmail.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Twitter: @gessfred&lt;/p&gt;</content:encoded></item><item><title><![CDATA[AmiScan]]></title><description><![CDATA[AmiScan is an innovative startup project focused on automating the analysis of asbestos samples using electron microscopes. It is able to‚Ä¶]]></description><link>https://gessfred.xyz/amiscan/</link><guid isPermaLink="false">https://gessfred.xyz/amiscan/</guid><content:encoded>&lt;p&gt;AmiScan is an innovative startup project focused on automating the analysis of asbestos samples using electron microscopes. It is able to detect fibers with a convolutional neural network trained on semantic segmentation. The platform is a client-server architecture, granting the flexibility to run everything on a laptop, or to host the server on a central maching so that everyone in the laborary can manage analyses. It is able to control both Zeiss and Tescan microscopes.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Amy Compiler]]></title><description><![CDATA[Full Compiler with hand-written tokenizer, parser, analyser, and code generation to WebAssembly written in Scala, for a toy language subset‚Ä¶]]></description><link>https://gessfred.xyz/amycompiler/</link><guid isPermaLink="false">https://gessfred.xyz/amycompiler/</guid><content:encoded>&lt;p&gt;Full Compiler with hand-written tokenizer, parser, analyser, and code generation to WebAssembly written in Scala, for a toy language subset of Scala (Amy). Extension to support custom operators.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Quantum circuits for generating Bell diagonal states]]></title><description><![CDATA[Improvement on previous implementations of quantum circuits to generate the full spectrum of Bell Diagonal states on the IBM quantum‚Ä¶]]></description><link>https://gessfred.xyz/bell-diagonal/</link><guid isPermaLink="false">https://gessfred.xyz/bell-diagonal/</guid><content:encoded>&lt;p&gt;Improvement on previous implementations of quantum circuits to generate the full spectrum of Bell Diagonal states on the IBM quantum computer (Qiskit). Previous work did not generate the full spectrum of Bell Diagonal states. Bell Diagonal states are crucial to some theoretical experiments about entanglement and locality.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Keylogg]]></title><description><![CDATA[Chrome extension to track typing speed, enabling users to analyse their actual productivity, and get alerted when they are becoming tired or‚Ä¶]]></description><link>https://gessfred.xyz/keylogg/</link><guid isPermaLink="false">https://gessfred.xyz/keylogg/</guid><content:encoded>&lt;p&gt;Chrome extension to track typing speed, enabling users to analyse their actual productivity, and get alerted when they are becoming tired or losing focus. I love time trackers, but they can sometimes provide noisy signal, and are limited in analysing productivity.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Parallel-RePlAce]]></title><description><![CDATA[Improvement of performance on the state of the art (at the time) VLSI placer. Analysis and reduction of memory footprint leading to 2x‚Ä¶]]></description><link>https://gessfred.xyz/preplace/</link><guid isPermaLink="false">https://gessfred.xyz/preplace/</guid><content:encoded>&lt;p&gt;Improvement of performance on the state of the art (at the time) VLSI placer. Analysis and reduction of memory footprint leading to 2x improvement, and then acceleration of 3 main bottlenecks with shared memory parallelism. VTune analysis of optimized code. Study of other techniques like SIMD parallelism and columnar-style data structures (and algorithms).&lt;/p&gt;</content:encoded></item><item><title><![CDATA[StudyBuddy]]></title><description><![CDATA[Android app to help form and manage study groups on university campuses, allowing students to easily connect with peers sharing similar‚Ä¶]]></description><link>https://gessfred.xyz/studybuddy/</link><guid isPermaLink="false">https://gessfred.xyz/studybuddy/</guid><content:encoded>&lt;p&gt;Android app to help form and manage study groups on university campuses, allowing students to easily connect with peers sharing similar majors, courses, and languages spoken. Users can create or discover study groups through a centralized feed, sorted by major, courses, and languages spoken. Once a group is joined or created, the app provides features such as scheduling, location setup, file sharing, and messaging.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Running BI on MongoDB through Trino]]></title><description><![CDATA[Some BI tools don‚Äôt natively support querying MongoDB databases. While you shouldn‚Äôt run data warehousing on MongoDB, it may still be‚Ä¶]]></description><link>https://gessfred.xyz/mongodb-dashboarding/</link><guid isPermaLink="false">https://gessfred.xyz/mongodb-dashboarding/</guid><pubDate>Fri, 17 May 2024 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Some BI tools don‚Äôt natively support querying MongoDB databases. While you shouldn‚Äôt run data warehousing on MongoDB, it may still be desirable to build dashboards on top of MongoDB, even though it‚Äôs a NoSQL database. On one of my latest side projects, I am saving a web crawler output into a MongoDB collection and I would like to get a view of the number of ingested pages by source per day for example.&lt;/p&gt;
&lt;p&gt;To do this, there are 3 ways that come to mind, and you only need the approach detailed in this article if you‚Äôre using an arbitrary BI service. If you you just want to make charts, there are tools that support MongoDB out of the box:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;If you use MongoDB Atlas, the Charts service in Atlas is actually pretty good and has a similar UX to Tableau.&lt;/li&gt;
&lt;li&gt;Two very popular services that support MongoDB out of the box are &lt;a href=&quot;https://grafana.com/docs/plugins/grafana-mongodb-datasource/latest/mongodb-query-editor/&quot;&gt;Grafana&lt;/a&gt;, and &lt;a href=&quot;https://help.tableau.com/current/pro/desktop/en-us/examples_mongodb.htm&quot;&gt;Tableau&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;If you still want to use an arbitrary BI tool, like Superset for example, some services do not support MongoDB out of the box.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In this article I will show you how to use Trino (Starburst Galaxy) to make a Superset dashboard on top of a MongoDB database.&lt;/p&gt;
&lt;p&gt;You can either set up Trino locally (in which case you will need to write), or in my case I am using Starburst Galaxy, which is a managed platform built on top of Trino that provides a similar user experience as commercial data warehouses.&lt;/p&gt;
&lt;p&gt;Step 1. Create a Starburst Galaxy account and cluster in a region close to your MongoDB instance.&lt;/p&gt;
&lt;p&gt;Step 2. Create a MongoDB catalog (=datasource) on Starburst is pretty straightforward. I am a little annoyed that it doesn‚Äôt support Mongo URI strings, and notably if your connection string starts with mongo+srv, make sure to tick the DNS seedlist checkbox, this can be hard to find at first and the connection will not work if this is not set properly.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/088356f96eeb06dc1e60fd7aed3756c5/c72f7/Untitled.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.46835443037975%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABEUlEQVR42qWSW0vDQBCF9///IfHVhz5ob6kt6JMUbZpUmqbZhGQvs58kMbVYqAUXhjM753A4s6wavU+YJou+0gWTJGIczxlv58ySZ6J0xTxddtj1yfLE9xjx+DHl4XXG6C1C4SDYQLY7soszTOn4z1G6qvDiMc5SG0O8Tfnc77HO4rzrSoJ0Gi8DXlarMdag6sac3EUCeV5gbZ/SNBbvfdeHEC7SDLMBW61yzg80zsIxM0jwJ8E1w9/Gzrlzwz6hPpYdQWjvcpHimmFZlih7bhiErD6g65K6qWlM86dhOx+4oii+Ew5vYBwv9ys265hcNCUVPty+sq40ytifbyJWyJ52SOWp1prt3Zogtyc8bDK+AEtQvRZGLwn5AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Untitled&quot;
        title=&quot;&quot;
        src=&quot;/static/088356f96eeb06dc1e60fd7aed3756c5/f058b/Untitled.png&quot;
        srcset=&quot;/static/088356f96eeb06dc1e60fd7aed3756c5/c26ae/Untitled.png 158w,
/static/088356f96eeb06dc1e60fd7aed3756c5/6bdcf/Untitled.png 315w,
/static/088356f96eeb06dc1e60fd7aed3756c5/f058b/Untitled.png 630w,
/static/088356f96eeb06dc1e60fd7aed3756c5/40601/Untitled.png 945w,
/static/088356f96eeb06dc1e60fd7aed3756c5/78612/Untitled.png 1260w,
/static/088356f96eeb06dc1e60fd7aed3756c5/c72f7/Untitled.png 1915w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;One feature I ADORE about Starburst is the test connection whenever you create one. I cannot believe how few data platforms implement this, as it can save precious debugging time.&lt;/p&gt;
&lt;p&gt;Step 3. Make your MongoDB collection visible. I find the process to query a collection not very intuitive. From what I gathered, you must first create a schema of the same name of the MongoDB database/namespace that contains your collections. This will create a _schema collection that basically contains the information schema. Next we can query our MongoDB database with SQL as below. Hourra! üçæ&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9c6d65a840a94a3f196069d4a21ca19a/ec09f/Untitled_1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.46835443037975%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABf0lEQVR42o2QW2/UMBCF8///EfBGu7RbQSUe6UVU7FaoNJvEtxlfknzIzoJA4gGPjsby8Tk+4+7dw44Pxxt2xz2XFYcN9Wz//Knh+g/sn2/ZHW64+HbdsDvsuXq65eLLZ94/fqQjAfMZ+dxX/nsty8rjjyN33484UbrJGIwTXkfH62gwXvCipFJY1oV5mf+JspRm+OJ63t7teHN/yX3/RGedR0vCBSGIUOaZUnITLctmWI3XWsvK71rXxv21Zug0JmJKGGMI1TQEvAmIUXwIiGjba4jUaWrPoeCcb1wNZL1nshbVSJfLQoyJYRiZjOU0DMio6IsSRMl5Jp4SwQh95SYlDYlpNIhGjHVY6ximCZVIl6og5UZ4HzDOoS6iY2yClArRJNRXsW092YyzviXKZSal3EyjpJpwpo7dnwamyWwphl8JZUvY14S6caYmzIznhCmXpj8NY/u6TmOmlNL+o74oqsQQm7CexRhRq4gXnHOI1zaB9367W3nVNp39avgJSMyyCyzlvu8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Untitled&quot;
        title=&quot;&quot;
        src=&quot;/static/9c6d65a840a94a3f196069d4a21ca19a/f058b/Untitled_1.png&quot;
        srcset=&quot;/static/9c6d65a840a94a3f196069d4a21ca19a/c26ae/Untitled_1.png 158w,
/static/9c6d65a840a94a3f196069d4a21ca19a/6bdcf/Untitled_1.png 315w,
/static/9c6d65a840a94a3f196069d4a21ca19a/f058b/Untitled_1.png 630w,
/static/9c6d65a840a94a3f196069d4a21ca19a/40601/Untitled_1.png 945w,
/static/9c6d65a840a94a3f196069d4a21ca19a/78612/Untitled_1.png 1260w,
/static/9c6d65a840a94a3f196069d4a21ca19a/ec09f/Untitled_1.png 1916w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Step 4. Connect your Starburst instance as a datasource in your favorite BI tool. I am using a local instance of Apache Superset deployed with Docker. It‚Äôs based on the official apache/superset image, with &lt;code class=&quot;language-text&quot;&gt;pip install trino&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;To get the connection string for Superset, you should get to your cluster, and go to Connection Info. Unfortunately here, Starburst will not provide you with a directly usable connection string. You will probably see something like &lt;code class=&quot;language-text&quot;&gt;jdbc:trino://&amp;lt;host&gt;:&amp;lt;port&gt;?user=&amp;lt;username/email&gt;/&amp;lt;role&gt;&lt;/code&gt;, which you should transform to &lt;code class=&quot;language-text&quot;&gt;trino://&amp;lt;username/email&gt;/&amp;lt;role&gt;@&amp;lt;password&gt;&amp;lt;host&gt;:&amp;lt;port&gt;&lt;/code&gt;. If your password contains special characters, you should URL encode them. (i.e. slash is &lt;code class=&quot;language-text&quot;&gt;%2F&lt;/code&gt;, etc.)&lt;/p&gt;
&lt;p&gt;Also, by default your Starburst account will only have an accountadmin role. It‚Äôs best to create a new role with less privileges for any BI use.&lt;/p&gt;
&lt;p&gt;Step 5. Create a dataset in Superset. As again Superset was not able to list the schema I had defined in Starburst earlier, the alternative is to create a dataset with custom SQL. Also you will find that Superset will throw errors on weird non SQL fields (arrays, documents), so it is best to do your flattenings, etc. here, so that your charts access clean SQL table.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1ceabeb69c9c5665133cee054869c003/7ebf9/Untitled_2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.46835443037975%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABiElEQVR42mWRy3IaMRBF+dn8ADAz5hEDg94amMGJYRzzK9iB38gmyyyyyApjB3xSEuAitqpOtUpS377dahhrcc5FvPdIKRkNh0wmU1YPD6xWK9brNZvNhvVmw+P3NbPZDKUUxpgPNLTW2JNoEBwLwfVwyLyu+Xt4Zb/fczi8crmWyyX5OI8CIT8QCoQYBaO6tRTO0R5JPnWuqeual5dndrsd2+2W56cnfvz+w+PPX9T39zE5GAhGlLGxsygYDs8URYFQmpFUKGv5cjvn5nbOfLHg290d1XyBufmKLwr8qSPv3Ql/bPksdIwTtBowzjuIcZ981GWc95DiM0oOsGqA10OsGeFMjr3A2RwhBu8FC2yci8LEUWis0RcuTpw/0Z33Np5LKWi4N+tHtDZxHgEhBFIq3r/5gPMUvog5jbKcUlYlZVlSVWWsFJwFdIjWMi2P9yFOq0D1P+G+qrDO0bjKulxlvTfSdoekmZE2M7JmStZK6GQp3Syll6T0A+2EftKmd6IbSBOyVot/XL7kg/tKKEkAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Untitled&quot;
        title=&quot;&quot;
        src=&quot;/static/1ceabeb69c9c5665133cee054869c003/f058b/Untitled_2.png&quot;
        srcset=&quot;/static/1ceabeb69c9c5665133cee054869c003/c26ae/Untitled_2.png 158w,
/static/1ceabeb69c9c5665133cee054869c003/6bdcf/Untitled_2.png 315w,
/static/1ceabeb69c9c5665133cee054869c003/f058b/Untitled_2.png 630w,
/static/1ceabeb69c9c5665133cee054869c003/40601/Untitled_2.png 945w,
/static/1ceabeb69c9c5665133cee054869c003/78612/Untitled_2.png 1260w,
/static/1ceabeb69c9c5665133cee054869c003/7ebf9/Untitled_2.png 1919w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;And there you have it. I‚Äôm able to use my MongoDB collections as if they were SQL tables:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f222b22845373d1525201af99ba8b6ea/ec09f/Untitled_3.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.46835443037975%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAwklEQVR42p2R6wrDIAxGff+H6sP01wZlFzqNGs03kl7WgW5jgUNabU8+1J3OZ0zTBO89UkoGMy+UglIYxfqLfZ8ZZe3Xh8fdB7gYF4GIvKFrOsT7AMqMxHmXxBhBRNbteX1XXCDCPM8mOZZIBWmCKiAuiHkZrAlVEkJo4sZxxDAMqLWuoi1lxY2SCY/FVXbhluqI04nNEsGFkqXTYfqd9knXPgm3S8g5N9kuSlNZT8l+7Ap7Z/GNntS1pvxCN+G/wh5PB1q+zAykwBIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Untitled&quot;
        title=&quot;&quot;
        src=&quot;/static/f222b22845373d1525201af99ba8b6ea/f058b/Untitled_3.png&quot;
        srcset=&quot;/static/f222b22845373d1525201af99ba8b6ea/c26ae/Untitled_3.png 158w,
/static/f222b22845373d1525201af99ba8b6ea/6bdcf/Untitled_3.png 315w,
/static/f222b22845373d1525201af99ba8b6ea/f058b/Untitled_3.png 630w,
/static/f222b22845373d1525201af99ba8b6ea/40601/Untitled_3.png 945w,
/static/f222b22845373d1525201af99ba8b6ea/78612/Untitled_3.png 1260w,
/static/f222b22845373d1525201af99ba8b6ea/ec09f/Untitled_3.png 1916w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;Further reading&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=3OBAtUYjyz8&quot;&gt;https://www.youtube.com/watch?v=3OBAtUYjyz8&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://trino.io/docs/current/connector/mongodb.html&quot;&gt;MongoDB connector ‚Äî Trino 448 Documentation&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Introduction to focus tracking]]></title><description><![CDATA[I am a big believer in using personal data to drive my own performance. I like podometers, smartwatches, fitness rings. I‚Äôve always felt‚Ä¶]]></description><link>https://gessfred.xyz/productivity-beyond-time-trackers/</link><guid isPermaLink="false">https://gessfred.xyz/productivity-beyond-time-trackers/</guid><pubDate>Sun, 12 May 2024 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;I am a big believer in using personal data to drive my own performance. I like podometers, smartwatches, fitness rings. I‚Äôve always felt that screen time applications (which is most of the productivity tracking market as far as I know) were not pushing the boundary far enough. What if you could apply the same rigor as sports science to not only get more stuff done but also free some time to do other things. My new app &lt;a href=&quot;https://chromewebstore.google.com/detail/hotkey/caboikpoimjoinpcenfhpdabngepgmif?hl=en-GB&amp;#x26;authuser=0&quot;&gt;HotKey&lt;/a&gt; is a first attempt at that.&lt;/p&gt;
&lt;p&gt;Naive screen time tracking does not work for me. Time is just a proxy for productivity, and as someone who struggles a lot with focus at time (borderline ADHD), I‚Äôve noticed that first hand. Obviously in an age where everyone has at least 2-3 devices at all time, you can end up with huge VSCode screen time numbers while having spent most of that time scrolling TikTok. Even when disciplined enough to stay off social media, on bad days I may have spent those 8 hours on VSCode daydreaming.&lt;/p&gt;
&lt;p&gt;But also I feel like time tracking apps don‚Äôt push the boundary far enough, in at least two ways. One, productivity is a spectrum, there must be ways to detect how focused one is beyond simply having an app opened. What if an app could detect the quality and efficiency of your work. Second, What if you could then correlate that data with your sleep data, nutritional intake, sport activity, location, room temp, etc.. As someone who‚Äôs dabbled in nootropics, I‚Äôve always felt like we should rely on self experimentation to assess which ones actually work on oneself, beyond the anecdotal evidence, and that a big barrier to that is lack of tooling to measure, cross reference and visualize productivity data.&lt;/p&gt;
&lt;p&gt;Today I am soft rolling out my new app, HotKey, which is a first experiment in achieving those goals by measuring typing and outputting various metrics, including active time and typing speed.&lt;/p&gt;
&lt;p&gt;When I first started to ponder the question of how to improve time tracking, the first idea was to detect where on the screen the user is looking. My intuition is that eyes would be one of the greatest indicators of focus, because when not focused, I personally tend to look blankly in the same spot (instead of moving around), or even out of the screen, whether it‚Äôs outside the window. Obviously, this is not only resource intensive (webcam always on), but it‚Äôs a very hard unsolved challenge. Another proxy for focus then is typing. It does not account for activities like reading, scrolling, etc. but is a pretty good indicator as well, including for focus, because I am pretty sure it should be possible to assess someone‚Äôs alertness levels with typing signatures (typing speed, fluidity, number of errors).&lt;/p&gt;
&lt;p&gt;With the current version of the app, you get a comprehensive view of your day so far, with typing speed, output, errors, as well as the active time (time spent writing without interruptions longer than 3 minutes). I personally like to use them for two things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;If I have a goal in mind, for example work 3 hours on this essay, I can see when I have truly achieved that goal&lt;/li&gt;
&lt;li&gt;If I feel my focus is shifting, I can look at the graphs to see when it first started happening&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;You also get (recent) historical data on the output by hour of the day, day of the week, and a heatmap √† la GitHub of your active time by day of the week during the 3 previous months.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 445px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/11383857c220fdbd48e4cd68adc3a102/e66bf/active-time-tracker-focus.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 146.2025316455696%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAEtklEQVR42p2WXWyTVRjHn7ftum5ztPtq13Vv6dp9sO5LNrdBm61ja6fYsTK+ZuIXZFHCwAGb+wAcxBBECV5olKhRNFlgwQ/ixUi80CAYLxxG2dx2YYhe4QaEkEiMhgt/5m23FdxA5OLJc3Jyzq//5zz/855KfX09fr8fv9/HitpaysrKKCkpieb/itLSUurq6qipqaHn+edo37gByS8o4JGqKhobGvD5/Pj8PtxuN9nZ2eTk5Nwz7HY7Ho8Hh8PBE+3tDAwMIKIoWMxmnKqTrCwrhUVFLHkoCRH5X1FVVcXJ4WEkPT09OpGclIzeoI8tMOchhsT7Aun1+nng2NgYYrPZohPeYi/pGRnRseKsR4ypsU06QyzuAtTpdNGsnefNmzfjQLfbg8ViiS3MXYnojbFxohkp3oSYXfcEak26fv06YsuOA81LUhDFhFRuR9xhxL8fsVUigVcQe+3sD2hHpCwAlpeXMz0zjWjd1Ca0hlhtVgymVEyBfZiaj5AYPIypcjOJtTswVXWQ6GnE5I1g9DShLAK8cmUmDkw1p1FUtAy7PQdXnos8tztqDdXlxp6Ti7vQiy03j8LiUoxJqSiKcu+SHzRuV3j12tW4wvsORReLfwErKiqYnp5GMjIzUVWVquXLKfZ68dXV41DVB1I4MzMTt01CghGDljWzLrp5trOpKpJRvCjwxo0bcaA1M42UyicR3yDy1Dkkp2a2RH2sxDlzh95AOn9ZAPR6vbGSrVYrBqMRb76KZeu3yMDfyCBIQWShQsdKZNMIsv3X+XllFpifn8/4T+OzChUdTnsGqU+PIDuvIf1/Ifbq2CZN7bINSF4I2QvS8zvS8eMChQUFBYyP33aXl9ozWdLxNdJ7C9kD4nsJqeiIqe2/hfT9ifT+ERtv/XlR4OTkZNw2CXoFZ92zZIf6cD7WS3aoF/uje1m6ug97sAfbql1krtpNVsMuHA2ddwFOaMaO+1DrcqIISXrBKLFINsTyXPejaxRZFHjx4sU4cO4qxeyhzJp3bqyPhWjd1sbKgqs3X/LtCkV58KundXliYiJ+hnNf62RzEo6iLNSiDExpOtRcJ9XV1RQWFka/zmUlD2NW08hZqqJTdPNKNeDU1FQc6HG7sTiWEOmu5MWhNTzz+hraNgdZXlHJmTMjdHfv5oWunZw/P8LR0wd479SrJOjjX/IFwMy0TELtIT756h2Of/Yaq/c2MHhsPy6ni22d29Ce22Nvv8uBgzvYt6cLf30Rik47+3jJd9jGne/Bpbo49PIRRi9coPvDjUT66+javpP169fR0dFBc3OQ4x+c5NDRTgzGuUfqLj5UHU5MyXr6+nsY+2GCU6ff5KPhA1RXr8CUZKKlpYWBgT1093Tx5TeHcbktdwCjCqcmEe2R1ibMSRZqIyUMnuhl+Iv3+fTsQYZPniAQCDA0NMTo6Cij333P2XMf89bnW7E6zdF9RmNCNGtNi3Y5JSVl/mAT0vRIlpCar8dZnkUg0EBTYxNzf1d8Ph+BulWkFWYssI8m7NKlS8iWLVtobW2lbV0bkTURIuEIjzeHCa9uobm5mWAwSDDYRCgUiubGpkZaw62sjaylra0tGuFwmM7OTi7/dpl/AAOSYLiHH5ChAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Active time/focus tracker&quot;
        title=&quot;&quot;
        src=&quot;/static/11383857c220fdbd48e4cd68adc3a102/e66bf/active-time-tracker-focus.png&quot;
        srcset=&quot;/static/11383857c220fdbd48e4cd68adc3a102/c26ae/active-time-tracker-focus.png 158w,
/static/11383857c220fdbd48e4cd68adc3a102/6bdcf/active-time-tracker-focus.png 315w,
/static/11383857c220fdbd48e4cd68adc3a102/e66bf/active-time-tracker-focus.png 445w&quot;
        sizes=&quot;(max-width: 445px) 100vw, 445px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;If you are interested, please checkout the &lt;a href=&quot;https://chromewebstore.google.com/detail/hotkey/caboikpoimjoinpcenfhpdabngepgmif?hl=en-GB&amp;#x26;authuser=0&quot;&gt;Chrome extension&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The end goal is for it to be a native app, but it‚Äôs easier to implement and ship a browser extension, and as I do a lot of my work on the browser anyway, this feels like a good first step to experiment. So if like me you do quite a lot of writing/coding on the browser (Chrome), please test the app and let me know what you think.&lt;/p&gt;
&lt;p&gt;Next on the roadmap:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Support on desktop (MacOS first)&lt;/li&gt;
&lt;li&gt;Better, faster and more transparent analytics&lt;/li&gt;
&lt;li&gt;Dashboard and email reports&lt;/li&gt;
&lt;li&gt;Assessing focus and providing active feedback to users to make productivity
&lt;ul&gt;
&lt;li&gt;For example, a notification reminding the user to take a five minute break if the focus slips&lt;/li&gt;
&lt;li&gt;Or telling the user when is the best time to work, for how long, etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Tagged timer so that you can yourself assess the effects of anything (for example set a timer 2 hours every time you drink coffee)&lt;/li&gt;
&lt;li&gt;Importing of third party personal data, for example Apple Health, and ability to cross reference many personal analytics to find relationships between actions and productivity.&lt;/li&gt;
&lt;li&gt;Long term, some other products, including eye tracking&lt;/li&gt;
&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[How to refresh an imagePullSecret token secret, the hard way]]></title><description><![CDATA[TL;DR this is a niche issue I encounter because I run a DigitalOcean k8s cluster with a private GitHub registry. If you‚Äôre using a public‚Ä¶]]></description><link>https://gessfred.xyz/kubectl-replace-token/</link><guid isPermaLink="false">https://gessfred.xyz/kubectl-replace-token/</guid><pubDate>Sat, 06 Jan 2024 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;em&gt;TL;DR this is a niche issue I encounter because I run a DigitalOcean k8s cluster with a private GitHub registry. If you‚Äôre using a public registry or ECR you may not run into those issues.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;It‚Äôs end of year and deployments to your dev Kubernetes cluster started failing a few days ago. The CI likely passes, but nothing happens. When you check your pods, you directly see that new ones can‚Äôt pull the image. Fuck ü§¨! You have flashbacks to when your docker registry bullied you into setting an expiry date, because: security, yay!&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://prod-files-secure.s3.us-west-2.amazonaws.com/958ec504-7411-483c-8b50-f019c0736961/8f322866-8a30-4b84-b91a-d8aa19ebb9d8/Screenshot_2024-01-06_at_12.29.01.png&quot; alt=&quot;Screenshot 2024-01-06 at 12.29.01.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://prod-files-secure.s3.us-west-2.amazonaws.com/958ec504-7411-483c-8b50-f019c0736961/205c99ed-ac25-4232-ba02-d42e28a8ed97/Untitled.png&quot; alt=&quot;Untitled&quot;&gt;&lt;/p&gt;
&lt;p&gt;You likely had created the secret using the bespoke kubectl command but you forgot, because you do it once a year:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;kubectl create secret docker&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;registry &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SECRET_NAME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; \
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;docker&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;server&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;PRIVATE_REGISTRY_SERVER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; \
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;docker&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;username&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;REGISTRY_USER&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; \
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;docker&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;password&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;REGISTRY_PASSWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; \
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;docker&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;email&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;REGISTRY_EMAIL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; \
&lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;namespace &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NAMESPACE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It turns out there is no ‚Äúupdate the token‚Äù command, so you‚Äôll either have to recreate it, or use the edit command, which is available in the dashboard as well, if that‚Äôs your kind of thing.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;kubectl edit secret &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;SECRET_NAME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;--&lt;/span&gt;namespace &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;NAMESPACE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When you open the secret manifest that was generate with the create secret docker-registry command, you find something like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token literal-property property&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Secret
&lt;span class=&quot;token literal-property property&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; v1
&lt;span class=&quot;token literal-property property&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token literal-property property&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; github&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;regcred
  &lt;span class=&quot;token literal-property property&quot;&gt;namespace&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;default&lt;/span&gt;
	&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;redacted&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
data:
  .dockerconfigjson: &gt;-
    &lt;/span&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;base&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token plain-text&quot;&gt;
type: kubernetes.io/dockerconfigjson&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Obviously, it‚Äôs the base64 encoded data in .dockerconfigjson that we‚Äôll have to operate on. If we decode it, we can see a JSON of the following structure:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;jsx&quot;&gt;&lt;pre class=&quot;language-jsx&quot;&gt;&lt;code class=&quot;language-jsx&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token string-property property&quot;&gt;&quot;auths&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token string-property property&quot;&gt;&quot;ghcr.io&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token string-property property&quot;&gt;&quot;username&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;alice&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token string-property property&quot;&gt;&quot;password&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;token&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token string-property property&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;alice@mail.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;token string-property property&quot;&gt;&quot;auth&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;base64 of alice:&amp;lt;token&gt;&quot;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As we can see, the decoded secret contains another auth field used by Docker to authenticate with the registry server.&lt;/p&gt;
&lt;p&gt;To update the token, you‚Äôll simply have to decode it, replace the token, and reencode it.&lt;/p&gt;
&lt;p&gt;Here is a small script to do it:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; sys
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; json
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; base64
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; subprocess &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; check_output&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Popen&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; PIPE

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    secret_name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sys&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    new_token &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sys&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# Fetching the secret&lt;/span&gt;
    secret &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;loads&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;check_output&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;kubectl&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;get&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;secret&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; secret_name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-o&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;json&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# Decoding the existing .dockerconfigjson field&lt;/span&gt;
    docker_config_json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;b64decode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;secret&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;data&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;.dockerconfigjson&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    config &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;loads&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;docker_config_json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# Assuming &apos;auths&apos; structure exists and only one registry&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; registry &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; config&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;auths&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        config&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;auths&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;registry&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;auth&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;b64encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&apos;&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;secret_name&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;new_token&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# Encoding the modified .dockerconfigjson field&lt;/span&gt;
    secret&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;data&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;.dockerconfigjson&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;b64encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dumps&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;config&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# Preparing the updated secret as json&lt;/span&gt;
    updated_secret_json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dumps&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;secret&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# Invoking kubectl edit&lt;/span&gt;
    process &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Popen&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;kubectl&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;edit&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;secret&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; secret_name&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-o&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;json&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stdin&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;communicate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;updated_secret_json&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; __name__ &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;__main__&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    main&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There you have it, see you next year üòâ&lt;/p&gt;</content:encoded></item><item><title><![CDATA[How to properly benchmark queries on Snowflake]]></title><description><![CDATA[When I see people trying to test the performance of queries, I typically see them making a few key mistakes that may affect their results‚Ä¶]]></description><link>https://gessfred.xyz/benchmark-snowflake-queries/</link><guid isPermaLink="false">https://gessfred.xyz/benchmark-snowflake-queries/</guid><pubDate>Fri, 22 Dec 2023 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;When I see people trying to test the performance of queries, I typically see them making a few key mistakes that may affect their results.&lt;/p&gt;
&lt;p&gt;To properly benchmark queries on Snowflake, we should first understand the different levels of caching on Snowflake:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Results cache, where Snowflake caches the results of queries by query text, so that if you send the same query twice, it will only be evaluated once. This in the condition that the query does not contain non deterministic functions, that the underlying objects have not changed, and that the query text hashes to the exact same value. This type of cache was less common in legacy data warehouses, because they were not built like LAMP websites.&lt;/li&gt;
&lt;li&gt;SSD cache, where each Snowflake worker caches read partitions to speed up queries, as this speeds up IO considerably. This is more common in other data warehouses, and is highly dependant on the state of system, which is typically used by many users simultaneously.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Now going back to benchmarking, we should apply some rigour such that results are reproducible, and the margin of error is quantified. As some randomness effect occur in a complex system like a data warehouse, we want to execute our query multiple times, and take the mean execution time as well as the standard deviation.&lt;/p&gt;
&lt;p&gt;So first, we should disable the query results cache.&lt;/p&gt;
&lt;p&gt;Second, we should decide what we want to measure. Across the lifetime of a warehouse, query performance will not look the same depending on the state of the system. We should either measure query execution time at cold start, or we should report a stable execution time after warm up. Warm state can simply be measured as the time when the execution time stabilises. For cold start, we can use the fact that snowflake warehouses are designed to be transient. We could create a new warehouse every time to be sure to get a clean cache, but a better way to invalidate the cache is to simply suspend the warehouse. Regardless of whether we resume it in 2 seconds, the Snowflake engine will have to invalidate the cache, thus we can trigger a cold start on demand.&lt;/p&gt;
&lt;p&gt;So in summary, to benchmark a query we should:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Disable the results cache&lt;/li&gt;
&lt;li&gt;Compute the mean execution time over a significant enough sample&lt;/li&gt;
&lt;li&gt;Separate cold start vs warm up&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[How DuckDB enables unit testing SQL queries]]></title><description><![CDATA[During my first data engineering gig at Amazon in the audience insights team, I took for granted the unit testing of Spark code. Those were‚Ä¶]]></description><link>https://gessfred.xyz/unit-test-sql/</link><guid isPermaLink="false">https://gessfred.xyz/unit-test-sql/</guid><pubDate>Sat, 05 Aug 2023 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;During my first data engineering gig at Amazon in the audience insights team, I took for granted the unit testing of Spark code. Those were Scala functions at the end of day, so it was natural to test them: craft some test inputs, invoke, get a result and assert. Now at a smaller company, and dealing with pure SQL, I see myself missing these a lot. Sure, we test for data quality with DBT notably, but this is not the same at all. It‚Äôs much harder to battle your test your code against edge cases. I find myself missing the reassurance, understanding that unit tests grant you, especially when confronted with complex SQL code.&lt;/p&gt;
&lt;p&gt;Part of it is bad practice, but to be fair the other part is that SQL tooling is lacking. With Spark, the runtime is typically right there in your environment, which is not the case for SQL. I don‚Äôt believe in having a test database for that purpose for many reasons, but depending on the engine one option could be to create a containerized instance in your test environment (i.e. CI/CD) and run the tests on it. Even with DBT, unit testing plugins are clunky at best. The other option is using DuckDB.&lt;/p&gt;
&lt;p&gt;I first heard of DuckDB as a ‚Äúlocal database that enables reading directly from local CSV files‚Äù, during the summer 2022 hype. Another very cool thing with DuckDB is the Python package, which allows you to run DuckDB in your Python programs, and run queries on local pandas Dataframes seamlessly.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; duckdb
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; pandas &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; pd

df &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pd&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DataFrame&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
duckdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;select max(a) from df&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;df&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# =&gt; [2]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Hence it clicked: you could construct test Dataframes in your test suite, ‚Äúinject‚Äù them in your query by naming them the same as the relations in your query, run the query, and get back a result Dataframe that you can run assertions on.&lt;/p&gt;
&lt;p&gt;For example in a current side project, I am dealing with the following query to compute the typing speed of a user:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sql&quot;&gt;&lt;pre class=&quot;language-sql&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; time_windows &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
      generate_series &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; window_start
  &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; 
    generate_series&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;interval&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;6 hours&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;interval&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;15 minutes&apos;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; window_start
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
type_intervals &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
    window_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    source_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    session_id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    record_time&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    lead&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;record_time&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;over&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; window_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; source_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; session_id
      &lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; record_time &lt;span class=&quot;token keyword&quot;&gt;asc&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; record_time  &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; interval_to_next_event&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    is_return &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; is_error
  &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; keyevents 
  &lt;span class=&quot;token keyword&quot;&gt;join&lt;/span&gt; time_windows &lt;span class=&quot;token keyword&quot;&gt;on&lt;/span&gt; 
    record_time &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; window_start &lt;span class=&quot;token operator&quot;&gt;and&lt;/span&gt; 
    record_time &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; window_start &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;interval&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;15 minutes&apos;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; record_time &lt;span class=&quot;token keyword&quot;&gt;asc&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
flows &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;case&lt;/span&gt; 
      &lt;span class=&quot;token keyword&quot;&gt;when&lt;/span&gt; lag&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;interval_to_next_event&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;over&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; window_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; source_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; session_id &lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; record_time &lt;span class=&quot;token keyword&quot;&gt;asc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;interval&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;5 seconds&apos;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; 
      &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; flow_indicator
  &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; type_intervals
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
grouped_flows &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
    &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;flow_indicator&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;over&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;partition&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; window_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; source_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; session_id 
      &lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; record_time &lt;span class=&quot;token keyword&quot;&gt;asc&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; flow_id
  &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; flows
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
stats_by_flow &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
    window_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    source_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    session_id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    flow_id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;avg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;extract&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;milliseconds &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; interval_to_next_event&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; avg_type_speed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; event_count&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cast&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;is_error &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; error_count
  &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; grouped_flows
  &lt;span class=&quot;token keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; window_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; source_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;session_id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;flow_id
  &lt;span class=&quot;token keyword&quot;&gt;having&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
  window_start&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;avg_type_speed &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; event_count&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event_count&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; speed&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;coalesce&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    stddev&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;avg_type_speed&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; volatility&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;event_count&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; event_count&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;error_count&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; error_count
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; stats_by_flow
&lt;span class=&quot;token keyword&quot;&gt;where&lt;/span&gt; event_count &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; window_start
&lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; window_start &lt;span class=&quot;token keyword&quot;&gt;desc&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Let‚Äôs say for example that I want to test if the weighted average of typing speed is correctly computed. I can generate a time series with 75% of records at a speed of 8 and 25% records at a speed of 3, so that I know what output to expect:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; duckdb
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; pandas &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; pd
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; datetime &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; datetime &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; dt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; timedelta

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;make_event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;t&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; source_url&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;example.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; session_id&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; is_error&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;False&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;session_id&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; session_id&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;source_url&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; source_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;record_time&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;is_return&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; is_error
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
keyevents &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pd&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DataFrame&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; make_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;now &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; timedelta&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;milliseconds&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; k &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; 
    &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; make_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;now &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; timedelta&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;milliseconds&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;55&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; source_url&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;google.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; k &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then, as I am naming my DataFrame in the same name as my real table, Duckdb will use it to compute the query, and I can run my test simply as follows, get back a dataframe and run some assertions on it. Here I know the expected number of return rows and the expected typing speed weighted average.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;typing_speed_current.sql&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; fd&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    query &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; fd&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;read&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;test_weight_is_accounted_per_flow&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    now &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; dt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;now&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    keyevents &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pd&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;DataFrame&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; make_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;now &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; timedelta&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;milliseconds&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; k &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; 
        &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; make_event&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;now &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; timedelta&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;milliseconds&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;k &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;55&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; source_url&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;google.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; k &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    res &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; duckdb&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sql&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;query&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;df&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;res&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    expected &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.25&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.75&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;assert&lt;/span&gt; res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;speed&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;values&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; expected&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There you have it. The only big caveats with this solution, is that I am not sure how to deal with fully qualified relation names (because you can‚Äôt name a variable schema.table), and also that you need a Postgre compatible SQL query.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Detecting missing data with z-scores]]></title><description><![CDATA[Introduction When loading time-series data into a data warehouse, you typically want to verify that you have successfully loaded all the‚Ä¶]]></description><link>https://gessfred.xyz/anomaly-detection-dbt/</link><guid isPermaLink="false">https://gessfred.xyz/anomaly-detection-dbt/</guid><pubDate>Mon, 01 May 2023 22:12:03 GMT</pubDate><content:encoded>&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;When loading time-series data into a data warehouse, you typically want to verify that you have successfully loaded all the data that you would expect. You typically put checks all along your ingestion pipeline, but you can never be sure that everything succeeded until you check the last model. So how do you check for missing data?&lt;/p&gt;
&lt;p&gt;If you know exactly the number of rows that you expect each day, problem solved, nothing to see here. However if you don&apos;t, statistical methods can help detect anomalies in the time series and identify missing data. This article will focus on detecting missing rows based solely on the number of rows by day, making this approach flexible to any kind of time series.&lt;/p&gt;
&lt;p&gt;Consider a Snowflake table containing portfolio valuation data, at holding level, for each business day.  The method should be robust to adding holdings or portfolios in the table, thus we are expecting the number of rows to increase occasionally, especially as I am making the assumption that duplicates can be flagged by other tests. We&apos;ll first discuss of mathematical constructs to achieve this, and then we&apos;ll think of some SQL code.&lt;/p&gt;
&lt;h2&gt;Fundamental principles&lt;/h2&gt;
&lt;p&gt;To detect missing data in a time series, we use a core principle of Time-Series Anomaly Detection to check whether data points deviate significantly from an established pattern or trend. Two crucial concepts to achieve this are Z-score and Moving Average.&lt;/p&gt;
&lt;p&gt;The moving average is the average of the data points in a time window sliding along the time axis. It is used to smooth out short-term fluctuations and highlight long-term trends and cycles. For example, if the time window is 7 days, the moving average at a certain time point would be the average of that day and the six preceding days. In SQL, this is achieved with windows functions.&lt;/p&gt;
&lt;p&gt;The z-score is a statistical measurement that describes a value&apos;s relationship to the mean of a group of values. The Z-score is measured in terms of standard deviations from the mean. If a Z-score is 0, it indicates that the data point&apos;s score is identical to the mean score. A Z-score of 1.0 would indicate a value that is one standard deviation from the mean. The z-score is signed, so that we can know if the data point is below or above the average.&lt;/p&gt;
&lt;p&gt;We will apply both of these techniques in the following way:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Calculate &quot;daily_rows&quot;: the daily number of rows in the table.&lt;/li&gt;
&lt;li&gt;Calculate the moving average of &quot;daily_rows&quot; over a suitable time window (say, the past 7 days).&lt;/li&gt;
&lt;li&gt;Compute the standard deviation of &quot;daily_rows&quot; in the same window.&lt;/li&gt;
&lt;li&gt;Calculate the Z-score for each day&apos;s &quot;daily_rows&quot;. This will be (daily_rows - moving average) / standard deviation.&lt;/li&gt;
&lt;li&gt;If the Z-score is less than a certain threshold (say, -2), flag it as a potential anomaly. This means the &quot;daily_rows&quot; is significantly lower than what we&apos;d expect based on recent trends, suggesting that data may be missing.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;First try&lt;/h2&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sql&quot;&gt;&lt;pre class=&quot;language-sql&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; portfolio_table &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;nav.csv&apos;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
daily_counts &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
        market_date &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;token function&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; daily_rows
    &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; portfolio_table 
    &lt;span class=&quot;token keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; market_date
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
moving_averages &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
        &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        daily_rows&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;avg&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;daily_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;over&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;asc&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;between&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;preceding&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;current&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;row&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; moving_avg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        stddev&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;daily_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;over&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;asc&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;between&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;preceding&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;current&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;row&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; moving_stddev&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;-- we&apos;ll add this for debugging/understanding&lt;/span&gt;
        lag&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;daily_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;over&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;asc&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; previous_count
    &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; daily_counts
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
z_scores &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
        &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;daily_rows &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; moving_avg&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;nullif&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;moving_stddev&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; z_score&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        abs&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;daily_rows &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; moving_avg&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;nullif&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;moving_avg&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; relative_deviation&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;-- those are only needed for debugging&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; 
        moving_averages
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
    &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    z_score
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; z_scores
&lt;span class=&quot;token keyword&quot;&gt;where&lt;/span&gt; 
    z_score &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;order&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To see whether this is doing a good job, we&apos;ll generate some fake data to model. We could simply generate a fake sequence of daily_counts, but to see it in full action end-to-end, let&apos;s actually model some market data. For this, we&apos;ll use R.&lt;/p&gt;
&lt;p&gt;Generating the data with R&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;r&quot;&gt;&lt;pre class=&quot;language-r&quot;&gt;&lt;code class=&quot;language-r&quot;&gt;install.packages&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;c&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;tidyverse&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;lubridate&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# set seed for reproducibility&lt;/span&gt;
set.seed&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# generate portfolio data&lt;/span&gt;
portfolios &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; paste&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Portfolio&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; LETTERS&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# generate holding data&lt;/span&gt;
holdings &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; paste&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Holding&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; seq&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;# generate 3 months of dates&lt;/span&gt;
dates &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; seq&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;as.Date&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2023-01-01&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; as.Date&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;2023-03-31&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;day&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# generate a slow increase in number of rows for each day&lt;/span&gt;
num_rows &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; round&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;runif&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dates&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; min &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; max &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;55&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; seq_along&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dates&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.02&lt;/span&gt;
num_rows &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; round&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# pick a random day in the second month for the jump&lt;/span&gt;
jump_date &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; sample&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;59&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# double the number of rows from the jump date&lt;/span&gt;
num_rows&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;jump_date&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; num_rows&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;jump_date&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;

df &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; tibble&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
  market_date &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rep&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dates&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; times &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  portfolio &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sample&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;portfolios&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sum&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; replace &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  holding &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sample&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;holdings&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sum&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; replace &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  weight &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; runif&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sum&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; min &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.01&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; max &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  shares &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pmax&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;rnorm&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sum&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; mean &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  price &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rnorm&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;sum&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num_rows&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; mean &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; sd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

write.csv&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;df&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; file &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;nav.csv&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This gets us the following daily counts:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b2ca6e044d810cedfbcb08013fb82f2a/29114/daily_rows.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAC4jAAAuIwF4pT92AAABxklEQVR42pWT3W7aQBCFB7O2QxqZmJIfW1ELxnPAhCpSuUoUdkPVn8u+Th+mfb7cVlV766kW1q7tEKkZabTelfztOTOzBICYmexq80kYaad22Tov96uNJtCuNmuQLv/9XIF02YZ00ylTAPyWyraaiLR4bv+KjLwmLTEZSchIsdtXlzhVHjOrFrBWIn0yYkjLnLSckZE1abklvTtbkilXZOSkqzAEcFTZroF7y4p0OSQtR6QldBdZlX7t4oBlq/Cp5X2qneVnG9Koq94DewBOAAQHgdoBu7DmdzNcMy4A9A82pamw+/OhsHYBRMzcb9WwZbl8AdB22UKZg2U2oHj9ozvEirSz/L9A8MzL8U7F6+9ED52BNqVH+gUK2drEtVrk5yF9Ek/dPw7U/WPgbX76vc3vqLf5M/Q2vyL6KnRx861X1bn7ZOv6F7MxgacKPFH0UU5pK1e0lYQeJKOtpPRBxlbXpPhC8zx9FlbtCZzRIk88xvKSUcSrqTea5+kox+r4/RsaLrPBCJylDCRgTgCMXZ4xcwTgFMA5gEE9ITdvLXjig6d+trgLGdf+Ik/7k+JzOJuvQwe7YiB2797ObOCeq2LmwE0L/QWPWt/598/W8wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Daily rows&quot;
        title=&quot;&quot;
        src=&quot;/static/b2ca6e044d810cedfbcb08013fb82f2a/f058b/daily_rows.png&quot;
        srcset=&quot;/static/b2ca6e044d810cedfbcb08013fb82f2a/c26ae/daily_rows.png 158w,
/static/b2ca6e044d810cedfbcb08013fb82f2a/6bdcf/daily_rows.png 315w,
/static/b2ca6e044d810cedfbcb08013fb82f2a/f058b/daily_rows.png 630w,
/static/b2ca6e044d810cedfbcb08013fb82f2a/40601/daily_rows.png 945w,
/static/b2ca6e044d810cedfbcb08013fb82f2a/78612/daily_rows.png 1260w,
/static/b2ca6e044d810cedfbcb08013fb82f2a/29114/daily_rows.png 1920w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;Analysis&lt;/h2&gt;
&lt;p&gt;Because we only care about decreases, we can see that row jumps are not marked as anomalies, because they have a large positive z-score, which is what we want in our case.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/4c94874d104c87fef11589252bc20d58/dcef9/daily_rows_vs_z_score-no_anomaly.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAEzlAABM5QF1zvCVAAADXklEQVR42lWUzWtcVRjGf/femUmcSZrvzOSjaZrJOXdukkmapA1NP000VgXxC3cGQVclVbsq4l+gSKFGUCg0Lc29bW0tomlxoZCVCzeiG1e6cCFutX635jxyJhHrC4f3nAPPj+d9ec/BWou1BmMs3QMJa6fa+Td0BfQJaB7kzyPg2F66L/8ZBI3cCA/0sLGa4fTTFXQblO4A3wWXgTu4A9AOMPg/8O5ObkCNabjLJ7EpLD8yiDa3IXoZ5PMNcu55Bt1/opICuhTS6UL6BckWdN8HtEwkoxHFyUhfEN5bp+hS0NsEOgc6T1FHeE5QdT1U1MycYF5w3EGigIkfc7ldLCxGnHoVOpOEA3G1CWYK2qTw9zr93pnb2HF0mlatMCkIdIYBbdDhoFnLtLjPKLrjoGb4fi6PvOD1chkeOxjC0UgbNG+lDDdKvcwDuk7VvcmAWyHRAug6ZaVM6xb9usGoSxnQJbruvBeWPGz1ZGfDRbhZLu3yO11hv0uZk4d64VUe1yqxTpK4CdDFBnBR69SVcsyl1JVx4u5lyh6oD4g8MP9tqdDXuMh42KUcU8ZhpRzVNY7oLMN6ht3aoE+X6FDGgjKmlLLkUuaV8ah3+seloKCMNg+Mvik0tbN0OFJGzaU86zIOKGVW7zPh3mJQS/TpJmO6QFEZ48o4pIwnXcqMN/HrxaAKJyJ9So7l/CDwQvDKE32+Z11unVlfjtYZ0TWqeoe65unVTSa0RkkZVWUsKmOfS5nacbj7l7UAfeXnZmSGmaFqCPsi3aZl62N6nW/4Dfa4r2nTeYybpkcfMurWaHUZQy5l0aWUXEq7MvrvXAhzUcd41HhlNjbM1Kp5uqcKepHCXw8GrVtnie+do/4bQdH10/ETYen3j4KurQu03luncvcy8ZdvNIe6CvqBxrjMTVXDQtc4dNcShm2cq42bnKBdMKBZrJbYLygrR9krJALdItB3REH7BEN74+25a6nTVkmoj41yaHoERqylr1YLx4ypJMZ08vlrAZXppr6RWg/H55u9phrb8uCeuNxSGQs7+5OiMbZsrWmLrQmsNT3G2G5rTcH/C9sxOcmwtfm9sc2f6S4HD9WHo/GaaXpq91Cel1aIjWmpxab359WQ2Xo1GquZJmNszj9bDzKmAQs88B+LTWtqqKS/pgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Z scores without anomaly&quot;
        title=&quot;&quot;
        src=&quot;/static/4c94874d104c87fef11589252bc20d58/f058b/daily_rows_vs_z_score-no_anomaly.png&quot;
        srcset=&quot;/static/4c94874d104c87fef11589252bc20d58/c26ae/daily_rows_vs_z_score-no_anomaly.png 158w,
/static/4c94874d104c87fef11589252bc20d58/6bdcf/daily_rows_vs_z_score-no_anomaly.png 315w,
/static/4c94874d104c87fef11589252bc20d58/f058b/daily_rows_vs_z_score-no_anomaly.png 630w,
/static/4c94874d104c87fef11589252bc20d58/40601/daily_rows_vs_z_score-no_anomaly.png 945w,
/static/4c94874d104c87fef11589252bc20d58/78612/daily_rows_vs_z_score-no_anomaly.png 1260w,
/static/4c94874d104c87fef11589252bc20d58/dcef9/daily_rows_vs_z_score-no_anomaly.png 3200w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;Missing data example&lt;/h3&gt;
&lt;p&gt;So far so good, but there is not anomaly to detect yet. Let&apos;s add a single day with missing data by directly ingesting into the daily_counts:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sql&quot;&gt;&lt;pre class=&quot;language-sql&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;daily_counts &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; 
        market_date &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;date&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;token function&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; daily_rows
    &lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; portfolio_table 
    &lt;span class=&quot;token keyword&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; market_date
    &lt;span class=&quot;token keyword&quot;&gt;union&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;all&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;2023-04-01&apos;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; market_date&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; daily_rows
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/60e72ab3cc3acccb607ae226515d7baa/dcef9/daily_rows_vs_z_score-with_anomaly.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAEzlAABM5QF1zvCVAAADcklEQVR42lXUW2hcRRzH8e85e8t1s0lz2c023SS7M3uSbRqbJjFtlDZtvYS2KqK0kKJWRGrRFxEUBQUt2IdiwQqibcUkZ9NEGn0oiPrgk0V8qfhQQfqgQn1UoUq9tJ2fnNMWdeDP/+XMZ+bM/z+DtRZrDeWKBca4cDTDraF7wM2CJkACZUH8G+5mfj+Xo3No6MakCDTGElQNe7f3oXOgOqgftAN0B2gcNPgfzP8/+GJ3D/kggOlpYswYm6pWTXrXdAl9exN8FPQA6Aka3F5KMX4DaFeSrHy6HawVbPot4TfcWiwGN9QqCRhL6DOS1xbJxuBhPL0Meo6sJpkTFDWKkce4YMbBZucRCCZ+9FLNTE0mOHQQ1gwNMV4tZ2Asra9jsOgi8DzoUzI6Sq8eoyxIuuNU9B69ghb3DkWJ5B/yUI62S+1Jfh3y4fk1PfDgWAL2+1phrQupqU5WIUWdZpuOU3P7KGk/aIkBLXGXPqagJabdCv16i/ErW72CvgF+no3/2/+8qzkLP3jRxy5ks0JmFOXT7NAxqjrAoL6gwc1TVMi9WmSjQnZqmSl3kjnN0vsVjfx9jGQEpi5m0gXsk77q3OZC7ledSYVs0xkG9Qpl7aJLZ6hpnnbVGVGd3dGibpkJnWLu8i6/793X21u0RDYCExfI5DYcqqS0RI8L2eTqbNEiVa0yoFcZ006y+oCNWiCnOmXVuVshIzF4kn1X72NdXOUTpHimqwBTW/xkay2lj2i6vkBBIUbz9OssHXqaQCUyboX1OkVCdQLVuVMLpNyHtOpNiu4R8tHh7aEEjI6wtTrgZ9pqieg2/CLfc6sU3QoDeghcE61RA7tVunUC39UpuJC8wrhIaBVPy2R1ES69nYSKtdQqJlUYDjJRgS7jp/+c9hp/P+jlruC1uAT579OpJDrCmYez6DvQT3D2hVYvBpdovLZAX7TDLw83evEdHLA2GYUgJ49S3MTEOeq5PDM72VIZZN1olebuYWhbT2+pyl/zMZi+ukhnBJ57rQkGraUQBP6wMfnAmA7eOO41jtYyw4Hp4fapxuiwrTEd1ppea00mqJqUtabbGNs2MzHAJy+1cD0EL7eep/b03nxWRkaiXaaieDaf9ybLZX/Q2vTuUinFgQMYa5uNtT3WGM9aG0XaWpPs6Qvi6eePNNDQWePx2SL/AIL+YfiUVA1QAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Z scores with a single anomaly&quot;
        title=&quot;&quot;
        src=&quot;/static/60e72ab3cc3acccb607ae226515d7baa/f058b/daily_rows_vs_z_score-with_anomaly.png&quot;
        srcset=&quot;/static/60e72ab3cc3acccb607ae226515d7baa/c26ae/daily_rows_vs_z_score-with_anomaly.png 158w,
/static/60e72ab3cc3acccb607ae226515d7baa/6bdcf/daily_rows_vs_z_score-with_anomaly.png 315w,
/static/60e72ab3cc3acccb607ae226515d7baa/f058b/daily_rows_vs_z_score-with_anomaly.png 630w,
/static/60e72ab3cc3acccb607ae226515d7baa/40601/daily_rows_vs_z_score-with_anomaly.png 945w,
/static/60e72ab3cc3acccb607ae226515d7baa/78612/daily_rows_vs_z_score-with_anomaly.png 1260w,
/static/60e72ab3cc3acccb607ae226515d7baa/dcef9/daily_rows_vs_z_score-with_anomaly.png 3200w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;We can see now that this row is rightfully flagged as an anomaly, and we are able to detect missing data for that date. Now this is a nice example, it may not always be easy to choose the right z-score threshold and window size. At the end of the day, this is a trade-off between false positives and false negatives.&lt;/p&gt;
&lt;p&gt;The choice of the Z-score threshold is determined by how sensitive you want your anomaly detection to be. A Z-score threshold of -2 indicates that any daily row count more than 2 standard deviations below the moving average will be flagged as an anomaly. The more negative the Z-score threshold, the less sensitive the anomaly detection (fewer anomalies will be flagged).&lt;/p&gt;
&lt;p&gt;The window size represents the length of the time period you consider as &quot;normal&quot; for your data. It is used to calculate the moving average and standard deviation. If your data has strong weekly seasonality (e.g. weekdays always have more rows than weekends), you might use a 7-day window size. If your data has strong monthly patterns, you might use a 30-day window size. Smaller window sizes will make the anomaly detection more sensitive to recent changes, while larger window sizes will make it less sensitive to recent changes.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f77d612613870db2efa0d12a226d3335/dcef9/z_score_by_window_size.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAEzlAABM5QF1zvCVAAADz0lEQVR42m2U609URxjGn7OH5bbAAcpd6LLnnJkze5bFZRVZTLnDrlncWsWChlsltLtC/QBIgZJqLQIGERvalJKC2jaIlwRLTPFaekkb7IXYNpQvjYnB9kMj8V84zVlZtEmfyS8z70zmSWbmfQeUUugQQoL98xqxrT1DXcN/pQXhoYFIuRCzyp9O60YhQsb/a7iBLhu0TVRoBirZOZpRCZrQhJAJRyk1Pm84qj4IETaqPhBCcVAXLwJzc8DCQhgmJ5NlVY0wO53IKCp6argBHxrrGrSvh4gctK9nhWJdt/MZfiywYsVl5We3sURGaWw5o2jOUTYNOUIILxIzPKwluOmcNIdp6RqmpOumaWmeTknXMcnmubPNMViMGsDduG9xM2mF/zB1Jl4hzFQiluOg+dDGHdLg/fEqtSMnpx9D8k84nz3PLZpO4JvYo8Id4diOH6LbcEc4bFiNSsYHhQH0iD5MZWr4IrIRCXL0s7eiVNFNjQplYRrToLcB7yzOZf6Fxa1WjL1cJ4y5OyuufgSMG5eCbzvh8mM2Q8NxphmnEv+BZtTwdfp93BQeATKROYWyZJjBP/Fq3Gn5Yepw8S1MWH+JnEld3t7lXVDb214tWoNm8o65kpZFZK5Gi1uOOf9On7SeZ5NxT4QZy73Iy9k/47PMVaCG9cBMXjSW5SuGIeWR5bWyFffJgu+do7nznpNlw2PdO+eqtnf2We9FBNK69vSVfuKq7J3e5q70239v6Cv+vKa3ZLbvVP5sznD+DIZ2XOGANASPeUQE3537cG+LZ/lI/+6r/rfzv6qt2/+pv6PoSgk6/mDycF9poKyjos3bNT5cMHComy2dfafiUv1h7+VTPZXjlUcrJtDrHjcAIiDYdxm8EviA7XGur/rXxv3NN1oO2v+sLm275G6te39fStWaYrjxlqfB1+V6pf71phNu//F+eenNfe2j3pamkca6d31iQ1c9at/by0EiFjisTQZEAwds6y/4PCuJu9+45ixzr5Tiu5Gk8oYztqK0+3G422FPutVgSr5dK3a2llYPJU5twW+Po7C4JwaatlGI2MhDYuGo1WmwO5vRAQ1tgx9HD/oWs1ztZ+BpDUCpaEETToMXLkCDAPg1xBd/CVwYQFzAgZiXVORlZqMwVgrlIeUpIWmUqglK1gHOlsJMahZJEfNyY3YV13CEqek0W0lViJ3bmkpNFqqmUcUhyDurDMTKUgilSYSQcKqX7eanQPUJanTkFUJyMN6SQyMUmfLMkg1KSCxRaAqJt0B0KLyqkAgmkzCzouhr4YTScL3a9LL9F7wnNE0XMzhRAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Z scores depending on the window size&quot;
        title=&quot;&quot;
        src=&quot;/static/f77d612613870db2efa0d12a226d3335/f058b/z_score_by_window_size.png&quot;
        srcset=&quot;/static/f77d612613870db2efa0d12a226d3335/c26ae/z_score_by_window_size.png 158w,
/static/f77d612613870db2efa0d12a226d3335/6bdcf/z_score_by_window_size.png 315w,
/static/f77d612613870db2efa0d12a226d3335/f058b/z_score_by_window_size.png 630w,
/static/f77d612613870db2efa0d12a226d3335/40601/z_score_by_window_size.png 945w,
/static/f77d612613870db2efa0d12a226d3335/78612/z_score_by_window_size.png 1260w,
/static/f77d612613870db2efa0d12a226d3335/dcef9/z_score_by_window_size.png 3200w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;On the false positive side, there is one more pathological case to be taken into account that should force us to improve our anomaly condition. If we use only the z-score we see that we can get pathological cases where the standard deviation is so small that the tiniest variation causes the z-score to explode. When the data has very low variance, like being exactly the same for a week, even a small deviation from the norm can result in a high absolute Z-score. One approach to manage this issue would be to use a modified Z-score which is based on the median absolute deviation (MAD) instead of the standard deviation. The modified Z-score is more robust against outliers.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/35e386ac8dfc572ee5809f1eb354847f/dcef9/scores-flat.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAEzlAABM5QF1zvCVAAADd0lEQVR42lWUTWhcVRTHf+9jMknz2UxNJknbJDNz75tJ06RJ2ySktTCNbY3aVItxYaGgVDei0KIoCkoXgtSCm1KEVrCd95raj2xdhC4UxE0VceGqbhURRaVdWJP71/caCl44XM7i/s45f+7/YK3FWkO5YoEJvj+TJz06CG4etDtLcSGIh+Glt1vP73oeD08KNMZSjQyL9S3oa9BroEOgfaAZ0LF1kP8/6EPgr0EACwtw+zYYY1JgLopM0/zsILoDeh30LOhl8jrGZh3PHra4HD3y6BUYBzsdbFRA95+Bn+fsuQxOxVhGa5WA3HigWwSrDdqldehJOjXJcQdb1M+04HHBnGC3oORytAi6fw7CDur7Ak6cgE0jVaarpWaYyukbwtUGfVoCd4sm9yFFPYPRBJ2uQaRxuvQBg2nBdFw3B2si0C/w0mI/K++3wqn2IkzN+XbQ5HSNXhezTTE9uspenWdKRxnINIupu5tM6iozusx2XaK29jGhYnb+fsFvh4scmBnKtPFXOlrb6ZwNdYV9LmZBMYe1xLzOsUfH2OpWaFWDuhocVMwBxRxRzJNKyLuYOSUUP3+7jfuXCVNg7k5LU1+mW8IeF/OCYvbqKvv1HhWdpKRlhtSgpoSnlXBUSQZ53sVUdIXJPy76xU9f7WrTDTpSYPBDmO9icTJQgskqNphx15jQaSbcO5R0HasGA0o4ooS9SlhQQt3FjCrh0N+XvI20jqGbhLxS6IOndviwO9Rn9K9eots1mNYyAzrFNr3LgK5nHRYVM6+EdiUMuTgbt0cJM2sxhXTC1CAwPsrh8cEApnx9S3hXnu+W2OWE76BFdfJumUdcg04lWCWZNFm4mM0upqiELq3Bd2eaoWwtUdmEpVHbnFrqHl7zP2+y6V7Z67oPfatFwotfbfTeOtDr6Ud4bv8Wlt/o8HUb1mI6frvgt/z1id8BS3xxegN012qUIhsOGRsKCvIoCcqCYUExLfLE9kEq1dTruxgYjDKbEu7gp/NhZj59SQvMBmdfLDzocGsU+TVjescrlUL652ZqpTbGx7qZnNwwYSteZE2vtaZ/bKQSGGNbrTV9xti2+tSwH0WmJ4pMd7li/QcLBmgdGaFkbW5zFOU+KhS83mo1eHR4OP/Y0FCumnrd2jZrTM+DzWQDa03eGBtsq2V7oKlcyXaBV/uv838Bl1JfiuzVJRsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Z scores with a flat timespan&quot;
        title=&quot;&quot;
        src=&quot;/static/35e386ac8dfc572ee5809f1eb354847f/f058b/scores-flat.png&quot;
        srcset=&quot;/static/35e386ac8dfc572ee5809f1eb354847f/c26ae/scores-flat.png 158w,
/static/35e386ac8dfc572ee5809f1eb354847f/6bdcf/scores-flat.png 315w,
/static/35e386ac8dfc572ee5809f1eb354847f/f058b/scores-flat.png 630w,
/static/35e386ac8dfc572ee5809f1eb354847f/40601/scores-flat.png 945w,
/static/35e386ac8dfc572ee5809f1eb354847f/78612/scores-flat.png 1260w,
/static/35e386ac8dfc572ee5809f1eb354847f/dcef9/scores-flat.png 3200w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Alternatively, we can add a relative measure of deviation, for example by also considering the percentage deviation from the moving average. If the percentage deviation is small, we might choose not to flag it as an anomaly even if the Z-score is below our threshold. This would help to prevent small absolute changes from being flagged as anomalies when the standard deviation is very low.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/cbf15788d384f461e3b5e5e468a0944e/dcef9/dev-flat.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAEzlAABM5QF1zvCVAAADWElEQVR42n2TT2gcZRjGf7M7s9l0s2vTmGw23c1u3J2ZbHbbbG3apia0SUP+lBpbg/XQk/YkSEUvFgQVoVCVngRFsP5JdiapTYtiBVuhRbx48eLZYg6KBw9aWqRa3HlkZoNFD37w8vJ+3/D7nodnPhzHwXFsHqo4wH5+eMsiXHrn3/V/q81w7g+27VAdtnlmcQBdBV0AfQrBlXbXOqgJgQ/arP/C2hz7H2CH69jJqT1D6C/Q6iZ0DVNrPBDNzfuwqDzQHdBNmNlXolxxjHLksj7K4ZGiAa+ESszAI62vQGdAL5PRadzgUdAHdIaQwNuE+fDj2ybfnOmkMOQarmtboVNODeZILYwYEugyVuCRCz4GbWDpNHnNUI/OlnHlYconJz/qRghveSRCAc8dy3Hj1RRwYInjA4XObHm4Q5fItjxqapLVOhN6kwntpqYwpBUOyWdMPvvlU5fHcKt9we5f34ul4X1mx0twx4olBD2f17torTAln8cCj0VdZF6vM6UD1PUbnVphWh5z8pmVz1F5HJFPR+AxI5/+L17q4t4KJoL41+ktA3Dd0CoTgcfTajKpdaaD56nqKLv0JQUtU5XHMfksyY8gJwKPilZ5+Nb5WP9Hp7Z26RIZZJC4RSwb2WriRDc2GdcnNPQie/Uku3SVsj5ke6TMZzJ0IZ/pwKMun/k/l41uUjvDDCKFse/TiS3R/+exPfDYpib79BkDeoG6HmdEPkOhLXkc1gppeZSCZmS3Tz7jLY+eMLjwgXCikMcYqyfMrlpC17B+f9ewAp+x4DaWIKksfcE5BoIrpHUBR4dAr4HOQ7BMIVgmpyZb9Qd890YHHCkWSTZqDCZd9AjoJNw7R/dPJ83EXYxMYNK7cdCyuHaQuxjxX5Jxc2OnZYWKWt+S+vmmmbi9FqZ8lhtnU1BwXYZtu4PajrigWwZ5QU5QEPQLUoLezb1wdqLvoE+QVh89epZueCp2cSFjUAqfnuPEHNvue6JQyK5nMp3Hy4XM3nK5f0elkkFioVTKz5ZKg/N2Kb5YLGYqjtO/OFjMXN+WSi4VB/OT5aEH4yP1mFmtQbxep9KGWjQaZpg2jdFYb3U4kXddk7k5uqvV1IDr9kZno6Mx23E6wt6eG1aXO2LtqZSNqfIQfwMllW2hOq1vuwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Relative deviation with a flat timespan&quot;
        title=&quot;&quot;
        src=&quot;/static/cbf15788d384f461e3b5e5e468a0944e/f058b/dev-flat.png&quot;
        srcset=&quot;/static/cbf15788d384f461e3b5e5e468a0944e/c26ae/dev-flat.png 158w,
/static/cbf15788d384f461e3b5e5e468a0944e/6bdcf/dev-flat.png 315w,
/static/cbf15788d384f461e3b5e5e468a0944e/f058b/dev-flat.png 630w,
/static/cbf15788d384f461e3b5e5e468a0944e/40601/dev-flat.png 945w,
/static/cbf15788d384f461e3b5e5e468a0944e/78612/dev-flat.png 1260w,
/static/cbf15788d384f461e3b5e5e468a0944e/dcef9/dev-flat.png 3200w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[JWT with CORS for FastAPI]]></title><description><![CDATA[The problem: If you implement it naively, the bearer token you send never reach the server. This is an issue of chicken and egg because if‚Ä¶]]></description><link>https://gessfred.xyz/cors-with-jwt-auth/</link><guid isPermaLink="false">https://gessfred.xyz/cors-with-jwt-auth/</guid><pubDate>Sun, 25 Sep 2022 22:12:03 GMT</pubDate><content:encoded>&lt;p&gt;The problem: If you implement it naively, the bearer token you send never reach the server. This is an issue of chicken and egg because if you check the JWT with the preflight request you won&apos;t find it, and the browser won&apos;t send it as long as the preflight request did not go through.
The solution: Write your own middleware. You simply need to check whether you received a preflight request and return the a 200 code with the proper headers.If you except multiple origins, you can even implement your own CORS rules or disable it (shush emoji‚Ää-‚Ääthis is strongly discouraged for API storing senstive data‚Ää-‚Ääthey exist for a reason).&lt;/p&gt;
&lt;p&gt;If you use FastAPI, you may be familiar with the CORS middleware. However, adding JWT-based authorization to a CORS API is not as easy as adding another middleware.&lt;/p&gt;
&lt;p&gt;CORS is the mechanism to make exceptions of the same-origin policy on the browser, and allow a webpage to send requests to APIs hosted in a different domain.&lt;/p&gt;
&lt;p&gt;I have found that the easiest way to do JWT authentication (with @auth0) is to create your FastAPI middleware that will handle both CORS and authorization.&lt;/p&gt;
&lt;p&gt;To implement the middleware, we have to understand that the browser will send a pre-flight request before every special request, to ask the server whether the subsequent request will be OK in terms of method, origin.&lt;/p&gt;
&lt;p&gt;To handle pre-flight requests, we just need to detect it and answer 200 with the correct set of headers.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token decorator annotation punctuation&quot;&gt;@app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;middleware&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;authorize_request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Request&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; call_next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    origin &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;headers&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Referer&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; origin&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;endswith&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; origin &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; origin&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    cors_headers &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;Access-Control-Allow-Methods&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;GET, POST, OPTIONS&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;token string&quot;&gt;&quot;Access-Control-Allow-Credentials&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;token string&quot;&gt;&quot;Access-Control-Allow-Origin&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; origin&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token string&quot;&gt;&quot;Access-Control-Allow-Headers&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Origin, X-Requested-With, Content-Type, Accept, Authorization&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;token string&quot;&gt;&quot;Access-Control-Max-Age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;86400&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;method &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;OPTIONS&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;example.com&quot;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; origin&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;origin&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;not in allowed origins&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; PlainTextResponse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;CORS error&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; status_code&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;401&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; PlainTextResponse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;OK&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
            status_code&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
            headers&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;cors_headers
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once this is done, we can treat other requests normally, making sure that the same headers are set&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token decorator annotation punctuation&quot;&gt;@app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;middleware&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;authorize_request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Request&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; call_next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# ...handle pre-flight request...&lt;/span&gt;
    response &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;await&lt;/span&gt; call_next&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; h &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; cors_headers&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        response&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;headers&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;h&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cors_headers&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;h&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; response&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that CORS is properly set up, we can handle JWT authorization. This is pretty straightforward with Auth0 and we can simply decode the Bearer token after having made sure that we are not treating a pre-flight request.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token decorator annotation punctuation&quot;&gt;@app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;middleware&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;authorize_request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Request&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; call_next&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    
    &lt;span class=&quot;token comment&quot;&gt;# ... handle pre-flight request ...&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Authorization&apos;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;headers&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; JSONResponse&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;status_code&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;401&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; content&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;detail&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;No credentials found (authorization bearer or cookie)&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    token &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; decode_auth_header&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;headers&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;Authorization&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    payload &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; get_token_payload&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;token&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;https://api.example.com/&apos;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; payload&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;aud&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;raise&lt;/span&gt; Exception&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;unauthorized&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;token comment&quot;&gt;# ... handle request and respond&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To decode the auth header, we simply need to remove the Bearer prefix, whereas to get the token payload we will need to use the jose library and fetch RSA keys from Auth0.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;get_token_payload&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;token&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    unverified_header &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; jwt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get_unverified_header&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;token&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    rsa_keys &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; requests&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&apos;https://&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;AUTH0_DOMAIN&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;/.well-known/jwks.json&apos;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    rsa_keys &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;k&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;kid&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; k &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; k &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; rsa_keys&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;keys&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; unverified_header&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;alg&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; ALGORITHMS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;raise&lt;/span&gt; Exception&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Unsupported JWT algorithms&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    payload &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; jwt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        token&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        rsa_keys&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;unverified_header&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;kid&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        algorithms&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;unverified_header&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;alg&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        audience&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;API_AUDIENCE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        issuer&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string-interpolation&quot;&gt;&lt;span class=&quot;token string&quot;&gt;f&quot;https://&lt;/span&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;AUTH0_DOMAIN&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;/&quot;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; payload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There you have it, with this you should be able to set up JWT-based authorization on cross-origin endpoints. &lt;a href=&quot;https://gist.github.com/gessfred/024c4c356b774d9f55a2b29328dedd94&quot;&gt;Full code&lt;/a&gt;. &lt;a href=&quot;https://twitter.com/gessfred/status/1574039252144656385&quot;&gt;Original Twitter thread&lt;/a&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Spark Shuffle, the good and the bad]]></title><description><![CDATA[Shuffling is a fundamental operator for transferring data between stages (and nodes) in Apache Spark. It was already a cornerstone of the‚Ä¶]]></description><link>https://gessfred.xyz/spark-shuffle/</link><guid isPermaLink="false">https://gessfred.xyz/spark-shuffle/</guid><pubDate>Fri, 25 Mar 2022 22:12:03 GMT</pubDate><content:encoded>&lt;p&gt;Shuffling is a fundamental operator for transferring data between stages (and nodes) in Apache Spark. It was already a cornerstone of the &lt;a href=&quot;https://research.google/pubs/pub62/&quot;&gt;MapReduce paper&lt;/a&gt; in 2004, and has since stood the test of time as a generic data exchange primitive for dataflow engines, providing the basis for inter-node transfer of intermediary results. In scale-out SQL engines in particular, shuffles are the central operator to implement many key operators such as joins, aggregates, etc. Unfortunately, the &lt;a href=&quot;https://www.usenix.org/system/files/conference/nsdi12/nsdi12-final138.pdf&quot;&gt;original Spark paper&lt;/a&gt; lacks comprehensive documentation regarding the crucial implementation details of shuffle, and I could not find blog posts that go into the details, making it challenging to access precise and technical insights. This is a short article explaining the implementation of Spark Shuffle, followed by a discussion of its strengths and weaknesses.&lt;/p&gt;
&lt;p&gt;Conceptually, the Shuffle is an all-to-all operator that consists in sending over the network all the outputs of the Map stage that are partitioned by key A to the Reducer nodes, so that the data becomes partitioned by a key B (the reduction key).&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1233c3cc9338989874b8a92dba72911b/8c557/shuffle-concept.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 45.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAACC0lEQVR42k3LW2/SAABA4f5QfcEYMUamkAkYM+fTnG5CuMhNCTq34DRhAm5QSoGOQumghTIdGaV1dONSgREZvY+amCzxezhvB5BlaTa7ml3N/9xUmAu6rquqOp1O5/O5ruuyJLXYAdHuke1+vd0n6T55ev57fAk0Trk4xiQrTBJnkzgbr7Bo85eqyIIgMgwzGo2urzWa7rhjlWcRdPVTeXULe/6x9OIzSba6wA5I3FpLGNbjhtdJw6vE7ZfJtQ+ZKo5dXPQGgwFN0xRFoWhpI1pc8kIWH2TxQ+a3GVukQrS6wB5ybPZlrf6MNQg/8Wcs/qx7FynkYRjOYRh2VK2SJIlhFceX8nIwZw/lnoYR27v8ynaNPOkCX+GG0Zk2uVImD2Rype67QGc0jx4iBQSJxWIoWmo2mzh+tBktPnSlzN70Y2/6kSdlDaPEyRkQzTbubKaNb/bvOdNGx/5dB7ixnSvkso0GRdM0SZI4jpfLmHO3uOyH7KGsPQTbApmVLbze4gD8BxuI1yIH9UiKihzUAwni+yF1ORnPZrPJZDIejzmOw7DK+k7xgQtc8oAmL2Ryg5b3pdrPM0ASRU1TeZ4fDPo8zyuyrCmKqmn6fy4nkz3k2PetGkoQwUQtlKiF0032fAjIsiKK0nDI9/6ZC4IkSdrNvFgsdF1XFEVVZI7rMh2GZdlOpyOJgixLfwGGXaRdJj70/wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Credit: https://engineering.linkedin.com/blog/2020/introducing-magnet&quot;
        title=&quot;&quot;
        src=&quot;/static/1233c3cc9338989874b8a92dba72911b/f058b/shuffle-concept.png&quot;
        srcset=&quot;/static/1233c3cc9338989874b8a92dba72911b/c26ae/shuffle-concept.png 158w,
/static/1233c3cc9338989874b8a92dba72911b/6bdcf/shuffle-concept.png 315w,
/static/1233c3cc9338989874b8a92dba72911b/f058b/shuffle-concept.png 630w,
/static/1233c3cc9338989874b8a92dba72911b/8c557/shuffle-concept.png 700w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;In Spark, mappers partition their own data, and generate a Map Output File spilled to disk (always), and partitioned per reducer. Each executor runs a Shuffle Service in the background that makes such Map Output Files available to consumers through TCP. Map tasks sort all the transformed records according to the hashed partition keys. During
this process, the map task might spill the intermediate data to disk if it cannot sort the entire data in memory. Once sorted, the shuffle block is generated, where all records belonging to the same shuffle partition are grouped together into a shuffle block, along with a shuffle index file that tracks the block boundary offset for efficient retrieval.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/088f5da72c9a5722a7ccc2c4a60b6454/8c557/shuffle-service.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 54.43037974683544%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACJElEQVR42jWQ2W6bQABF+f/f6EultKrUtKqUOIssO7FlO9gsw84wDAwDDAxgVoNDlVY5L/fpSFdHSJIkTdPmk7Zt265r2//bXYb+XFWXy2We54LzAPtVVbRN09R1VVUC5zzPsvmTy3AZhn68DNdpPNctK+qmbR3HOR5FB3rbNwXYPo5YQLMk5QLLi7LuEsYZr/KyxgERZR3YKOOlT5LFiWTlebvZrFcrUdaeD+bzwTpqyPSoFyQCIhkkxU6ygBvFvN8etYWIbxZvAFLK+KOSsOI8DD3nuQSM+xf5YaO6hBfdO0kLgbKz4iS/l+JW9cO0Bqazkryvf7YbEFqIPMlRXjZlwauqRDjcn0wRuIqJgI2hTwSIAj+IPZ/YLjZsFFMqO+T7w+FZCt40+ONR9HCEPK9rW0Wz7tanh60iAqg74cdtw7QUoJuWq6i6rGoeQhYMVTuAPoEBvbnfH46Koet930nAWGzUx50OacXbmaSlEKYlzTvFRJBkRfcuAnupRLdL2cRplOY/V4BXDUuTuq6hj19EY3uyVMt3cAoxFcKkPNn019PuVXJRlEuqvpb9b4vDwYwcTJeAMV79C8ZVw1nutfXRPmqubHofckBZQLnrU0RYGPMsy/Ya+nK7uts5ou4tAUvz6jqNQ9+LMrhbn+5fFQszdh7DuBCaup6m8XqdpnEcpzHPM4iJ7ccQx7YXrGU/Zvn1Os3z7ONwJxlvqgODJGJlQJK/XxdG2SPjos0AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Credit: https://engineering.linkedin.com/blog/2020/introducing-magnet&quot;
        title=&quot;&quot;
        src=&quot;/static/088f5da72c9a5722a7ccc2c4a60b6454/f058b/shuffle-service.png&quot;
        srcset=&quot;/static/088f5da72c9a5722a7ccc2c4a60b6454/c26ae/shuffle-service.png 158w,
/static/088f5da72c9a5722a7ccc2c4a60b6454/6bdcf/shuffle-service.png 315w,
/static/088f5da72c9a5722a7ccc2c4a60b6454/f058b/shuffle-service.png 630w,
/static/088f5da72c9a5722a7ccc2c4a60b6454/8c557/shuffle-service.png 700w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Every Reducer will then read all partitions that are assigned to them from the Shuffle Service of every Mapper, and then will perform a sort by key before consuming the input partition(s). Just as on the producer-side, the sort by key may spill to disk if available memory is not sufficient to sort all input Map Output Files. The Shuffle Service will use the index files to lookup the requested blocks. In general, shuffles on scale-out DBMS are a notoriously slow operation. In fact, shuffles are one of the main factors limiting scalability of distributed analytics engines, as adding more nodes to a slow cluster provokes more data to be shuffled, hence causing the speedup to plateau. To make matters worse, Shuffle IO grows quadratically with the data, as reducers have to read from every mapper.&lt;/p&gt;
&lt;h2&gt;The good&lt;/h2&gt;
&lt;p&gt;A major strength of Spark‚Äôs shuffling implementation is that it is handled by a service independent from the executor process. Not only does it make fault tolerance easier and more scalable, because failures don‚Äôt trigger full tasks recompute, it also loosely decouples the producers from the consumers (loosely because the reducers still need to wait for the all producers to finish spilling the shuffle files). This enables fetching blocks even when the Spark executor is down, whether for garbage collection or else, allowing to free up idle executors as well.&lt;/p&gt;
&lt;p&gt;The second, associated key strength of the strategy is that map output files are systematically spilled to disk. This is not only important to facilitate the decoupling of the shuffle service from the executors, it ultimately is a tradeoff that favors scalability, because shuffling in-memory will often result in Out of Memory errors on more challenging jobs, as seen in some MPP engines like &lt;a href=&quot;https://www.youtube.com/watch?v=obLnTw_pyDw&quot;&gt;Presto&lt;/a&gt;, for example.&lt;/p&gt;
&lt;h2&gt;The bad&lt;/h2&gt;
&lt;p&gt;The weaknesses of the implementation have been thoroughly researched, as shuffling is an obvious bottleneck in scaling Spark jobs, and we can classify them in two categories. Technical weaknesses that can be improved with better awareness of I/O notably, and conceptual weaknesses that put in the question the design of the shuffle service.&lt;/p&gt;
&lt;p&gt;On the hardware-software codesign side, one of the limitation of Spark&apos;s implementation is suboptimal disk (HDD) access patterns. The authors of &lt;a href=&quot;https://www.youtube.com/watch?v=obLnTw_pyDw&quot;&gt;Riffle&lt;/a&gt; identify 3 key hardware metrics that should be optimized for better disk performance: &lt;strong&gt;disk seek time, number of small IOs and write amplifications&lt;/strong&gt; (number of write operations). Disk seek time depends on access pattern (random vs. sequential), the number of small IOs depends on the size of requests IO blocks (it is better to read one large file than many small files), and write amplifications depends on the number of times spill-to-disk occurs. Apart from pure IO performance, because shuffle data needs to spill to disk, &lt;strong&gt;the shuffle operator may cause memory or disk resources exhaustion&lt;/strong&gt;, causing expensive task retries or even job failures. Finally, under heavy loads, the authors of &lt;a href=&quot;https://engineering.linkedin.com/blog/2020/introducing-magnet&quot;&gt;Magnet&lt;/a&gt; observe that the &lt;strong&gt;shuffle service may become temporarily unavailable, causing unnecessary retries&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;The Riffle paper mostly tackles I/O patterns, and proposes to merge Map Output Files from multiple mappers to reduce the number of file IOs and allow the Reducers to read sequentially. However, naively merging MOFs may result in increased write amplification (N-way merge creates N more writes), so they add that mappers should share a write-ahead buffer for each reduce partition. Some of the other limitations may be addressed by over-provisioning storage, but the negative implications are obvious. The Magnet paper instead proposes that mappers directly push shuffle data to the reducers in a best effort attempt.&lt;/p&gt;
&lt;p&gt;On the conceptual side however, another key limitation of Spark&apos;s Shuffle implementation is that the operator acts as a barrier between subsequent stages, because &lt;strong&gt;Reducers have to wait for all Mappers to write their Map Output File before starting to read&lt;/strong&gt;. Unlike MapReduce-style shuffles, where the first row in the repartitioned data set can be used after all rows have been sent and sorted, in BigQuery, Google‚Äôs cloud data warehouse as a service, each shuffled row can be consumed by BigQuery workers as soon as it&apos;s created by the producers. This makes it possible to execute distributed operations in a pipeline. A fully disaggregated shuffle service, implies that a separate set of nodes is tasked with storing Map Output Files. Such implementations then differ by how they reduce latency. BigQuery&apos;s Shuffle Service is an &lt;strong&gt;in-memory remote service&lt;/strong&gt;. Implementations leveraging RDMA have also been proposed.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[How is NCCL so fast?]]></title><description><![CDATA[NCCL, the state of the art library for distributed DNN training on GPU, has a reputation of not having much documentation on its design. No‚Ä¶]]></description><link>https://gessfred.xyz/nccl-behind-the-curtain/</link><guid isPermaLink="false">https://gessfred.xyz/nccl-behind-the-curtain/</guid><pubDate>Mon, 27 Dec 2021 22:12:03 GMT</pubDate><content:encoded>&lt;p&gt;NCCL, the state of the art library for distributed DNN training on GPU, has a reputation of not having much documentation on its design. No paper to be found, no extended press release, just a few talks[2, 4] and webinars, and the code, which is open source. This is unfortunate as NCCL is clearly doing something different from previous libraries.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This article presents the rise of RDMA in distributed computing, how chunking is a crucial technique to achieve link saturation, and why the ring topology is so important.&lt;/strong&gt;¬†The talks on NCCL are actually not such a bad starting point, but over time, the GitHub issues on the official repository have proven to be a rich resource for details and first principles of NCCL‚Äôs design. The following is a summary of those resources, along with some interpretations and reverse engineering of mine. The post is capped off by what I think could be next in the landscape.&lt;/p&gt;
&lt;p&gt;Behind the fancy name, NCCL is just an implementation of MPI that is specifically optimized for inter-GPU communication, notably over 100Gb/s+ RDMA enabled interconnects. MPI, being born before CUDA, does not support GPU communication natively. Some CUDA aware implementations have proliferated in recent years, but performance has been an issue, not only from a distributed algorithm standpoint, but also in leveraging the highly heterogeneous set of network technologies relevant in today‚Äôs landscape.&lt;/p&gt;
&lt;p&gt;From the infancy of distributed Deep Learning, networking, namely the ability to send a tensor from a GPU to another remote GPU for gradient averaging, has been an inescapable bottleneck. Ideally, the GPUs should be able to communicate autonomously through direct access to the NIC via PCIe,¬†&lt;strong&gt;without any involvement from the CPU and the OS&lt;/strong&gt;. The technology that allows various devices, such as RAM or GPUs, to communicate directly through the NIC, has been coined RDMA, for Remote Direct Memory Access. NVIDIA has fully invested in that paradigm, and has developed high capacity links and interconnects that exhibit RDMA like capabilities, in the likes of NVLink and others[3]. The DGX platform, an all in one cluster that hosts 10+ GPUs all connected via NVLink, is a perfect example.&lt;/p&gt;
&lt;p&gt;NCCL‚Äôs main purpose is to provide an MPI implementation over RDMA interconnects, especially Infiniband. This is the most important edge that allows NCCL to outperform other libraries. NCCL exposes a lean interface, with the regular broadcast, all reduce, all-gather, but has been or is still uneager to deploy other verbs.&lt;/p&gt;
&lt;p&gt;In practice, NCCL automatically detects the underlying network topology at boot time, and constructs optimal logical topologies. Note that a logical topology data structure may very well be heterogeneous, such as being a mix of TCP and PCIe. NCCL supports TCP, PCIe, Infiniband ‚Äî the API provided by Mellanox cards, and GPUDirect.&lt;/p&gt;
&lt;p&gt;An optimal peer to peer tensor transfer is a crucial building block to get right when implementing a collective communication library. GPUs are streaming devices, which means that you should always take advantage of any pipeline parallelism that is available. For P2P send/receive, that translates into sending the tensor in chunks. The different technology present different challenges, but this also becomes crucial when talking about collective algorithms. Aggregate network topology should be saturated, by balancing the size of tensors such that tensors are not so large that receiver nodes experience queuing, but still large enough to amortize network overheads. As it pertains to technology, if the interface is TCP or PCIe and must go through the CPU, then the advantage is even more pronounced, as the device to host memory transfers and the socket sending/receiving can be overlapped. You can experimentally match NCCL‚Äôs bandwidth by writing a few lines of code, with TCP sockets, the correct ring implementation and the optimal number of chunks.&lt;/p&gt;
&lt;p&gt;NCCL also builds on top of previous work by leveraging latency and bandwidth optimal algorithms and topologies. Ring topologies are well known in distributed systems as having an optimal bandwidth (under normal assumptions). This is due to the fact that nodes only send to a single peer and thus have the full bandwidth available. This is also manifested in the worst-case amount of data that any node has to send, which is constant. When building abstractions on top of the ring, such as all-reduce, similar properties are displayed. This is explained in a blog post[1] about Baidu all reduce, which revived an old idea in HPC, for the sake of distributed deep learning. On the flip side, if latency is of concern, then the best topology becomes the tree, which has log(n) complexity, if we take the time.&lt;/p&gt;
&lt;p&gt;NCCL aims to provide the best of both world by dynamically switching between the two to provide the best available. Notably, small tensors are not bandwidth bound, and transfer time is dominated by latency, so a tree transfer makes more sense, whereas large tensors are limited by throughput and so should be communicated through a ring.&lt;/p&gt;
&lt;p&gt;Relying on the three main ideas presented in this article, you should be able to implement MPI with a performance close to NCCL on GPU. If you look at NCCL‚Äôs source code, a lot of the remaining complexity can be attributed to the support of multiple data types, multi-threading safety, and similar endeavours.&lt;/p&gt;
&lt;h1&gt;Future work&lt;/h1&gt;
&lt;p&gt;NCCL has been the state of the art for some time, with native support in PyTorch and Tensorflow, but it has its shortcomings.&lt;/p&gt;
&lt;p&gt;The first one, for which Blink[5] has attempted to provide a solution, is the inability to optimally adapt to different topologies. Indeed, ring based primitives leave links under utilized when links are heterogeneous. This is due to the fact that the throughput of a ring primitive is limited by the slowest link. Blink instead models the optimal primitive as a graph problem, where nodes are accelerators and edges are links. A classical graph theory result then teaches us that the maximum flow ‚Äî from root to all ‚Äî can be achieved by finding the maximal packing of spanning trees. This is true assuming that GPUs can perform computation on transferred tensors at line rate, and that GPUs can accommodate multiple spanning trees.&lt;/p&gt;
&lt;p&gt;The second main shortcoming is that data parallelism on its own is likely to come to an end, because it is not optimal at scale, although it should always remain a relevant paradigm. The two most promising areas that are emerging right now are the hybrid parallelism optimization paradigm approach, with works such as FlexFlow[6], and the fully decentralized approach based on gossiping gradient updates, such as PowerGossip[7].&lt;/p&gt;
&lt;h1&gt;References&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://andrew.gibiansky.com/blog/machine-learning/baidu-allreduce/&quot;&gt;Bringing HCP Techniques to Deep Learning&lt;/a&gt;, Andrew Gibiansky, 2017&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://on-demand.gputechconf.com/gtc/2017/presentation/s7155-jeaugey-nccl.pdf&quot;&gt;NCCL 2.0&lt;/a&gt;, Sylvain Jeaugey&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://arxiv.org/pdf/1903.04611.pdf&quot;&gt;Evaluating Modern GPU Interconnect: PCIe, NVLink, NV-SLI, NVSwitch and GPUDirect&lt;/a&gt;, Li et. al, arXiv 2019&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.nvidia.com/blog/scaling-deep-learning-training-nccl/&quot;&gt;Scaling Deep Learning Training with NCCL&lt;/a&gt;, Sylvain Jeaugey, developer.nvidia.com 2018&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://proceedings.mlsys.org/paper/2020/file/43ec517d68b6edd3015b3edc9a11367b-Paper.pdf&quot;&gt;Blink: Fast and Generic Collectives for Distributed ML&lt;/a&gt;, Wang et. al, MLSys 2020&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://arxiv.org/pdf/1807.05358.pdf&quot;&gt;Beyond Data and Model Parallelism for Deep Neural Networks&lt;/a&gt;, Jia et. al, arXiv 2018&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://proceedings.neurips.cc/paper/2020/file/a376802c0811f1b9088828288eb0d3f0-Paper.pdf&quot;&gt;Practical Low-Rank Communication Compression in Decentralized Deep Learning&lt;/a&gt;, Vogels et. al, NeurIPS 2020&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[Autofocusing a microscope (SEM) in Python]]></title><description><![CDATA[Like in everyday photography, it is crucial in (electronic) microscopy to get images that are not blurred. The focus, is the process of‚Ä¶]]></description><link>https://gessfred.xyz/microscope-autofocus/</link><guid isPermaLink="false">https://gessfred.xyz/microscope-autofocus/</guid><pubDate>Wed, 24 Feb 2021 22:12:03 GMT</pubDate><content:encoded>&lt;p&gt;Like in everyday photography, it is crucial in (electronic) microscopy to get images that are not blurred. The focus, is the process of adapting the optic conditions to get clear images. On an electron microscope, the focus mainly depends on the position of the lens on the z axis, the working distance (distance from electron gun to specimen) and the magnification. Out of those 3 dimensions, we will typically adjust the working distance to focus the image.&lt;/p&gt;
&lt;p&gt;Some microscope interfaces like Zeiss‚Äô already provide an autofocus, but it is typically slow (more than 15 seconds), yields bad result with images not focused or even worse, and they have to be triggered manually. To automate specimen analysis, we cannot afford to only focus at the beginning of the analysis, because samples can be very irregular in height, so the that the distance between the lens and the specimen cannot be constant, leading to blurred samples. The analysis algorithm should detect when the image is out of focus and automatically trigger the focus process.&lt;/p&gt;
&lt;p&gt;A good autofocus should be fast, robust to noise and other factors, and produce sharp images. As most traditional methods to autofocus an image are iterative, the speed of an autofocus is mostly dictated by the number of tries it needs, rather than on complexity or other factors. New machine learning based methods are able to make much better initial guesses on the ideal working distance but here we will focus on a basic optimization based method.&lt;/p&gt;
&lt;h1&gt;Prerequisites/setup&lt;/h1&gt;
&lt;p&gt;As we are concerned with electronic microscopes, we need to have access to the microscope API to implement an autofocus. Depending on the model, this may be a TCP API or a SDK (Zeiss provides them in C/C#, Thermofischer provides it in Python). The API should provide a function to set (and get) the working distance, and a function to take images. (We will assume that the magnification and position of the stage are fixed).&lt;/p&gt;
&lt;p&gt;There are ultimately 2 techniques to autofocus. Techniques that rely on the statistical variance of pixel values or spatial frequency content of the image. We will focus on the first one.&lt;/p&gt;
&lt;h1&gt;Detection&lt;/h1&gt;
&lt;p&gt;In order to trigger our autofocus, we first need to be able to tell when an image is out of focus. Intuitively, the more an image is out focus or blurred, the less it will have sharp edges.&lt;/p&gt;
&lt;p&gt;A known tool in computer vision to detect edges is a Laplacian filter, a variant of convolutions, one of the most important operators in deep learning. To understand this, we can reason that a sharp image will have a high variance in pixel intensities, whereas blurring an image will by definition bring the pixel values to the mean.&lt;/p&gt;
&lt;p&gt;To detect edges, we should thus aggregate the Laplacian filter in such a way to reflect the number of edges in the picture. One method to achieve this is to use the variance of the Laplacian. Mathematically it is computed as:&lt;/p&gt;
&lt;p&gt;$$
\text{{Var}} = \frac{1}{{\text{{ksize}}^2}} \sum_{i=0}^{{\text{{ksize}}-1}} \sum_{j=0}^{{\text{{ksize}}-1}} ( \text{{Lap}}(\text{{src}})(i,j) - \text{{mean}} )^2
$$&lt;/p&gt;
&lt;p&gt;Where the Laplacian definition is:&lt;/p&gt;
&lt;p&gt;$$
\text{{Lap}}(f(x, y)) = \frac{{\partial^2 f(x, y)}}{{\partial x^2}} + \frac{{\partial^2 f(x, y)}}{{\partial y^2}}
$$&lt;/p&gt;
&lt;p&gt;This is the theoretical case in a continuous domain. For image processing, the Laplacian is approximated with the Laplacian filter mask, which is a convolution operator of the following shape:&lt;/p&gt;
&lt;p&gt;$$
\begin{bmatrix}
0 &amp;#x26; 1 &amp;#x26; 0 \
1 &amp;#x26; -4 &amp;#x26; 1 \
0 &amp;#x26; 1 &amp;#x26; 0
\end{bmatrix}
$$&lt;/p&gt;
&lt;p&gt;This kernel is then simply convolved with the image to obtain the second derivative. The values in the kernel reflect the weights that the neighboring pixels (surrounding the center pixel) get in this operation.&lt;/p&gt;
&lt;p&gt;The variance of the Laplacian is pretty much constant across images from the same distribution, so we can find the variance for images we know are not blurred, and use that value to detect out of focus pictures in the future. Practically, this can either be done with manual intervention, or by systematically autofocusing the first image to get a baseline value.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;detect() {
	if laplacian(var(x)) &gt; threshold:
		focus()
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1&gt;Optimization&lt;/h1&gt;
&lt;p&gt;To find the optimal working distance, we can just treat the microscope as a discrete (noisy) function. As computing the variance of the Laplacian would be pretty hard, we will simply use Brent‚Äôs method, which does not require computing derivative, but just evaluating the function at various points. We will use the minimize function from the optimize scipy module, so we will need to minimize $1 / Var$.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;autofocus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; max_iter&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;# assume self points to a class of a Microscope API&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;z&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ndarray&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;      
				&lt;span class=&quot;token comment&quot;&gt;# get image from microscope and evaluate Laplacian variance&lt;/span&gt;
        img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;scan_image&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;z&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;     
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;lap_var&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;img&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    wd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; optimize&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;minimize_scalar&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        f&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        method&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;bounded&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        bounds &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# typically it is possible to give good bounds for the working distance&lt;/span&gt;
        options&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;maxiter&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;max_iter&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# this will determine the performance vs. quality tradeoff of the autofocus&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;set_wd&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wd&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;    
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; wd&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Practically we may need to pass the image through a high pass filter as seen in the literature, but here we will assume this is not needed.&lt;/p&gt;
&lt;h1&gt;Simulation&lt;/h1&gt;
&lt;p&gt;Let‚Äôs test our ‚Äúalgorithm‚Äù now by simulating an electron microscope. Let‚Äôs assume a fixed position and image. We will need to model the amount of blur based on the working distance. This is done by mapping a working distance to the radius of disk shaped filter.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; cv2
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; numpy &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; np
&lt;span class=&quot;token keyword&quot;&gt;from&lt;/span&gt; scipy &lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; optimize

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;create_disk_kernel&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;radius&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token triple-quoted-string string&quot;&gt;&quot;&quot;&quot;Create a disk-shaped kernel of a given radius.&quot;&quot;&quot;&lt;/span&gt;
    kernel_size &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;radius &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    kernel &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;zeros&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kernel_size&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; kernel_size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

    y&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ogrid&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;radius&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;radius&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;radius&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;radius&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    mask &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; y&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; radius&lt;span class=&quot;token operator&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;
    kernel&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;mask&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;

    kernel &lt;span class=&quot;token operator&quot;&gt;/=&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;kernel&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; kernel

&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lap_var&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;image&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; cv2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Laplacian&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;image&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; cv2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;CV_64F&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;var&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SimMicroscope&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;__init__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; url&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;399471.png&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;image &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;array&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Image&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;# Optimal working distance&lt;/span&gt;
        self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wd_optimal &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;50&lt;/span&gt;
        self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wd&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wd_optimal
        &lt;span class=&quot;token comment&quot;&gt;# Proportionality constant that relates PSF radius to working distance difference&lt;/span&gt;
        self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;blur_scale &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.1&lt;/span&gt; 

    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;set_wd&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; wd&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wd&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;wd

    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;scan_image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; wd&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ndarray&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; wd &lt;span class=&quot;token keyword&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 
            wd&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wd
        &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wd&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;wd
        &lt;span class=&quot;token comment&quot;&gt;# Calculate the difference in working distance from the optimal value&lt;/span&gt;
        d_diff &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wd &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;wd_optimal&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;# Calculate the radius of the disk-shaped PSF&lt;/span&gt;
        radius &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token builtin&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;d_diff &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;blur_scale&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        psf &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; create_disk_kernel&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;radius&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        
        &lt;span class=&quot;token comment&quot;&gt;# Convolve the image with the PSF&lt;/span&gt;
        blurred &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; cv2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;filter2D&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;image&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; psf&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; blurred&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Let‚Äôs see if this is a realistic model. We would expect the variance of the Laplacian to be a bell shaped curve around wd_optimal . By plotting it with matplotlib, we get the following distribution, which is pretty good for now:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;X &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;linspace&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;cv2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Laplacian&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;microscope&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;scan_image&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wd&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; cv2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;CV_64F&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;var&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; x &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; X&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
plt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;plot&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;X&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/55776c80b983cf836995cb346a39b6ef/b06ae/lapv_vs_wd.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.68354430379746%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAABSklEQVR42nWT627CMAyFef/XRINmNE7a2GkuvkylG4MWzo/KUfT5OKfyyTl3uVxyznQQItJnpZROZoaIvXd5ErOY6RBzwGKqLHupKhGdAOB8PquqPWk7ubm4uTyOO+WcTyKCiCKyu1O1YV481rW2D3CM8Xq96qF5YwGsMTeWt+wdrrWGEI7OpUvMLeZWu3yEicg59+y8VTG30vn+/Qwvy+K9f3be+nisXWT1p/b22f/w8c0eK4t2lt/M9B2cUhqGYQdvaZlZZ92K92Mz8yMw/RuvdHkwHmvll9uXwHbOnXVM5RFyrjymIoe5V9jMiEhEmhhWSYWBWmN9/W0K1LAwVel/bX5h7z3E2cF8gwhTovuSTNOc75qmackZKfspfY/B+fkyTl/fAQBOW5LrLnAPAMzrhhARAKgqM4/juCxlHa3V8XYTYTMNAUIIP8r6bxIgVDxaAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;LAPV vs WD&quot;
        title=&quot;&quot;
        src=&quot;/static/55776c80b983cf836995cb346a39b6ef/b06ae/lapv_vs_wd.png&quot;
        srcset=&quot;/static/55776c80b983cf836995cb346a39b6ef/c26ae/lapv_vs_wd.png 158w,
/static/55776c80b983cf836995cb346a39b6ef/6bdcf/lapv_vs_wd.png 315w,
/static/55776c80b983cf836995cb346a39b6ef/b06ae/lapv_vs_wd.png 560w&quot;
        sizes=&quot;(max-width: 560px) 100vw, 560px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Then, we can simply add our autofocus function by extending this class with the method.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AutoSimMicroscope&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SimMicroscope&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;autofocus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; max_iter&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;lap_v_at_wd&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;z&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token builtin&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; np&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;ndarray&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;      
                img &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;scan_image&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;z&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;     
                &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;lap_var&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;img&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# we want to maximise lap_var so we take 1/x&lt;/span&gt;
            wd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; optimize&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;minimize_scalar&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                lap_v_at_wd&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
                method&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;bounded&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
                bounds &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                options&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;maxiter&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;max_iter&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            self&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;set_wd&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wd&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;    
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; wd

m2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; AutoSimMicroscope&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
m2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;set_wd&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# put the microscope out of focus on purpose&lt;/span&gt;
Image&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fromarray&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;scan_image&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# =&gt; the resulting image is blurred&lt;/span&gt;
m2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;autofocus&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;max_iter&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# =&gt; wd is now ~50 as expected&lt;/span&gt;
Image&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fromarray&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m2&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;scan_image&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;# =&gt; the resulting image is in focus&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 484px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/6c97731abb1d790c76534ec95c0fc4d9/ff42b/sample-blurred.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAADJElEQVR42iWTQUv6cACG10GIoLrUISLoYIVdikAL9O/UrbY2ne5n22Rrm25u87e5ZEOXSkxKD6YYnbp1CMFjEHTr1if7Uz1f4Hnh4UVkWR6NRq7rMgwznU4BAPV6HcdxiqLq9brjOEEQUBSVz+fDMAQAoCiK4zj2C8Ky7MXFRbPZ7Pf70+m0VCqlUql0Om3bdhiGlmVJktTr9QzD0HW9WCzmcjkcx89/QWzbxjAslUpBCCVJIkkSwzDHcQzDqNVqHMcBAEzT9H2f53mCIFAUzf3CcRzium4QBARBSJKkqurp6Wm1WvV9HwBQLpcFQWg0GldXVwzDoChaLpcNw6Ao6vLyslKpIIlEguM4kiTPzs5c1zVNE0J4f3+fyWQ8zwvD0LZtz/NqtZrv++PxeDKZ8DwPAMBxHMnlcoVCIZvNZjKZu7u7Xq8HIRRFUVXVTqfjuq6maeVyudVqvb6+vr29zWYzkiSz2SxBEIjv+7IsoyjKsqwoiizLkiQJAPA8TxRFy7JGo5Eoin/7x+PxYDAoFos0Tf+Yb36ZTCaPj48Mw5yfn5umKctyo9FwXRdC6DjOcDiEEHIcR1FUOp3WNK1SqaAo+pOKIAhVVafTqa7rnU5nOBwqiiIIgmmajuO4rlutVkVR1HX9+fmZZdl8Ps+y7I8ZQvjXeTAYTCaTdrutKEq32/U8r9VqqaoqCIJt2w8PD0EQNJtNAIAsyyRJMgyDGIZRr9e73a4sy47jXF9fa5pmWZau6xDCIAgghIvF4v39fT6f39zcJJNJiqIsywqCAGEYRlEUnudpmk4mkyRJjkajMAzn8/n39/fn5+fT09NisZjNZv1+PwgCkiR5nhcEoVQqIY1Go1arFYtFQRBomsYw7OXl5ePj4+vrq9lsZrNZmqYty7q9vXUcp91udzodSZIURSkUCsjfB+Lx+N7eXjweT6fTiqJomnZ8fLyxsRGNRhOJxO7u7uHhYSKRoCiK53kcx0ul0snJCbK/v39wcPDv379YLHZ0dLS9vb28vLy+vr62toYgyNLS0ubmZiQSWVlZ2draikQi0Wg0Fovt7Oysrq7+B/0dPkM0yodgAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Before&quot;
        title=&quot;&quot;
        src=&quot;/static/6c97731abb1d790c76534ec95c0fc4d9/ff42b/sample-blurred.png&quot;
        srcset=&quot;/static/6c97731abb1d790c76534ec95c0fc4d9/c26ae/sample-blurred.png 158w,
/static/6c97731abb1d790c76534ec95c0fc4d9/6bdcf/sample-blurred.png 315w,
/static/6c97731abb1d790c76534ec95c0fc4d9/ff42b/sample-blurred.png 484w&quot;
        sizes=&quot;(max-width: 484px) 100vw, 484px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 484px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ace1f749049c834bf2b7bcc649868a9e/ff42b/sample-autofocus.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAADKElEQVR42iXTPU/6bBiH4boYw6Bx0MHE6KBRjDHRWAZBKv33obctrW2B3EhbSgulb7TKuyVBVBiAiCYOjg5qoouLiaOTX+yJeHyB60x+uRBFUfr9vuu6NE3f3d1xHKfrOkEQx8fHuq47jtNsNimKSiQS3W5XEAQMwwiC+DeBcBxHkqTnee12ezQacRwXiUQODw8dx7m8vDQMQxRF3/d1Xdc0jeM4HMcJgvhvArFtG8fxcDhsWZYoigAAHMcdx9F1XVXVdDrN83yxWKzVahBCkiQxDMNxPBaLQQgR13VbrVY8HpckSVGUUCikqmqtVktOQAgty0qlUizLYhgmCEKpVKIoCgAgiiKComg6nQYAhEIh13UNwzBN8+bmJhqNViqVbrdr23a1WlVVtVKpDIfDwWAAIRQE4Tcbx3GGYXAcxzCs0+m0223btkVRVBSl1Wo5jqNpmiAInuc9PT09Pz+Px2OSJI+OjkiSRGq1mizLf0mnp6c8z5MkyXFcpVLJZrOmafb7/Ww2CyE0TXMwGFxdXbEsS9M0QRCI53lnZ2ej0Wg4HLIsSxCEYRiyLJum6XmeaZqWZfV6Pdu20+k0RVGRSKRQKGQymWg0ivydUhTl9vZW07Rms9nr9XK5HISwVCo5juN5nqIo2Wy2WCw+PDzwPM8wDMdxvztblhWPx8vl8vX19XA4rNfrsiz7vl+tVs/Pz/P5PITQtu1er9doNBzHSSaTkiQBAFiWRXRdLxaLFxcXkiQ5jiNJkqZppVKpUCiYptloNCzLent7+/j4eH19dV334OCAoijTNOv1OsIwjKIoqVSKpulwOAwA6Pf7nU7n5eXl5+fn6+vr/v7+/f19PB77vt9sNgEAcILjuN/sfD5/cnKSyWQSiQSO44+Pj5+fn9/f3+VyGcMwmqYNw/B937btxoQkSbIsMwyD/P3A/v7+2toaiqKRSCSXy6mqurOzs7CwsL6+jqLo6urqxsYGiqIAAEEQYrEYz/N7e3vI5uZmMBiMxWLBYHB3d3d5eTkQCMzPz8/NzSEIMjU1tbi4OD09HQgElpaWZmZmtra2tre3V1ZWZmdn/wcrNz6O31VciwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;After&quot;
        title=&quot;&quot;
        src=&quot;/static/ace1f749049c834bf2b7bcc649868a9e/ff42b/sample-autofocus.png&quot;
        srcset=&quot;/static/ace1f749049c834bf2b7bcc649868a9e/c26ae/sample-autofocus.png 158w,
/static/ace1f749049c834bf2b7bcc649868a9e/6bdcf/sample-autofocus.png 315w,
/static/ace1f749049c834bf2b7bcc649868a9e/ff42b/sample-autofocus.png 484w&quot;
        sizes=&quot;(max-width: 484px) 100vw, 484px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;There you have it, we have an autofocus that already works better than most algorithms that come with the microscope (such as Zeiss‚Äôs). Depending on the image settings and manufacturer, we can run this in ~5 seconds vs. 15 seconds with a much better quality assurance. If you‚Äôre interested in learning more, either about the context or about new machine learning based methods, a good paper to read is Deepfocus.&lt;/p&gt;</content:encoded></item></channel></rss>