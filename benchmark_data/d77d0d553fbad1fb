<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0"><channel><description>NoRedInk is on a mission to unlock every writerâ€™s potential.</description><title>NoRedInk</title><generator>Tumblr (3.0; @noredinktech)</generator><link>https://blog.noredink.com/</link><item><title>Adopting elm-safe-virtual-dom</title><description>&lt;p&gt;In this post we&amp;rsquo;ll share the steps we took for adopting Simon Lydell&amp;rsquo;s &lt;a href="https://github.com/lydell/elm-safe-virtual-dom/"&gt;elm-safe-virtual-dom&lt;/a&gt;, which is a partial rewrite of Elm&amp;rsquo;s Virtual DOM that makes it resilient to external DOM mutations, and friendlier to server-side rendering.&lt;/p&gt;

&lt;p&gt;The post&amp;rsquo;s target audience is Elm companies curious about adopting &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;, and Elm engineers interested in the technical details of the migration.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;Why we wanted an &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;&lt;/h2&gt;

&lt;h3&gt;Reliability and noise&lt;/h3&gt;

&lt;p&gt;Although Elm is famous for having no runtime exceptions, in practice, when browser extensions mutate the DOM behind Elm&amp;rsquo;s back, Elm&amp;rsquo;s Virtual DOM can get confused and throw errors. We were getting thousands of those a day.&lt;/p&gt;

&lt;h3&gt;Translations&lt;/h3&gt;

&lt;p&gt;Students arriving at our website don&amp;rsquo;t always speak fluent English. While we provide our own language supports, crafted with principled pedagogy in mind, we still hear users would like support for simple browser-based translations.&lt;/p&gt;

&lt;p&gt;Up until now, using browser-based translations has been a no-go, because they mutate the DOM in ways that break Elm&amp;rsquo;s Virtual DOM.&lt;/p&gt;

&lt;h2&gt;The work&lt;/h2&gt;

&lt;h3&gt;Patching Elm packages&lt;/h3&gt;

&lt;p&gt;The &lt;code&gt;elm&lt;/code&gt; executable in our development environment was already wrapped by a script that applied patches to Elm&amp;rsquo;s virtual dom package, using &lt;a href="https://github.com/jinjor/elm-break-dom/blob/0fef8cea8c57841e32c878febca34cf25af664a2/patch/VirtualDom.patch"&gt;work done by Elm community member jinjor&lt;/a&gt; and &lt;a href="https://github.com/lamdera/virtual-dom/pull/1"&gt;further work at Lamdera&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;One important difference between those patches and Simon Lydell&amp;rsquo;s &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt; is that Simon&amp;rsquo;s work requires patching not only &lt;code&gt;elm/virtual-dom&lt;/code&gt;, but also &lt;code&gt;elm/browser&lt;/code&gt; and &lt;code&gt;elm/html&lt;/code&gt;, so we had to adapt our patching technique. Simon provides &lt;a href="https://github.com/lydell/elm-safe-virtual-dom/blob/main/replace-kernel-packages.mjs"&gt;a patching script&lt;/a&gt; of his own, showcasing reliable ways to detect whether patches had been applied or not, and we are going to use it.&lt;/p&gt;

&lt;p&gt;We leveraged our use of Nix to structure patching this way:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Fetch each forked package from Github using a derivation&lt;/li&gt;
&lt;li&gt;Build a derivation with a directory structure mirroring Elm&amp;rsquo;s package cache&lt;/li&gt;
&lt;li&gt;Wrap the &lt;code&gt;elm&lt;/code&gt; executable with a script that:

&lt;ul&gt;
&lt;li&gt;Detects when patching is necessary&lt;/li&gt;
&lt;li&gt;Ensures the patching logic can&amp;rsquo;t be run concurrently&lt;/li&gt;
&lt;li&gt;Applies patches using Simon&amp;rsquo;s script, adapted to our needs&lt;/li&gt;
&lt;li&gt;Runs the real &lt;code&gt;elm&lt;/code&gt; executable&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Our changes to the patching script included:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Require an &lt;code&gt;ELM_HOME&lt;/code&gt; environment variable to be set, so we don&amp;rsquo;t accidentally patch the global Elm package cache&lt;/li&gt;
&lt;li&gt;Require an argument for the directory where to find the forks&lt;/li&gt;
&lt;li&gt;Handle read-only files from Nix&amp;rsquo;s store&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We also moved &lt;code&gt;ELM_HOME&lt;/code&gt; for our projects to a custom directory. &lt;code&gt;ELM_HOME&lt;/code&gt; is where Elm&amp;rsquo;s global package cache lives, and it&amp;rsquo;s usually found in &lt;code&gt;~/.elm&lt;/code&gt;. By moving it to a custom directory, we avoid interfering with other Elm projects on the same machine that might not need patching.&lt;/p&gt;

&lt;p&gt;A sample repository with the patching automation can be seen &lt;a href="https://github.com/omnibs/elm-safe-vdom-nix"&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h3&gt;Issues we encountered&lt;/h3&gt;

&lt;h4&gt;&lt;code&gt;elm-css&lt;/code&gt; needs a fork too&lt;/h4&gt;

&lt;p&gt;The first thing we did after patching was run &lt;code&gt;elm-test&lt;/code&gt;, and we got failures in tests, which we pinned down to &lt;code&gt;Html.Styled&lt;/code&gt; from &lt;code&gt;elm-css&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;In a program with this view:&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;import Html.Styled as Html exposing (Html)
import Html.Styled.Attributes as Attributes

view : Model -&amp;gt; Html Msg
view model =
    Html.div []
        [ Html.label [ Attributes.for "pet-select" ] [ Html.text "Choose a pet" ]
        , Html.select
            [ Attributes.id "pet-select", on "change" targetValue ]
            [ Html.option [ Attributes.value "dog" ] [ Html.text "Dog" ]
            , Html.option [ Attributes.value "hamster" ] [ Html.text "Hamster" ]
            ]
        ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And a test with &lt;code&gt;elm-program-test&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;exampleProgramTest : Test
exampleProgramTest =
    test "selectOption borked" &amp;lt;|
        \() -&amp;gt;
            ProgramTest.createElement
                { init = init
                , update = update
                , view = view &amp;gt;&amp;gt; Html.toUnstyled
                }
                |&amp;gt; start ()
                |&amp;gt; ProgramTest.selectOption "pet-select" "Choose a pet" "dog" "Dog"
                |&amp;gt; ProgramTest.done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We observed this failure:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;âœ— selectOption borked

    â–¼ Query.fromHtml

        &amp;lt;div data-elm=""&amp;gt;
            &amp;lt;span class="elm-css-style-wrapper"&amp;gt;...&amp;lt;/span&amp;gt;
            &amp;lt;label for="pet-select" data-elm=""&amp;gt;
                Choose a pet
            &amp;lt;/label&amp;gt;
            &amp;lt;select id="pet-select"&amp;gt;...&amp;lt;/select&amp;gt;
        &amp;lt;/div&amp;gt;


    â–¼ ProgramTest.selectOption "pet-select" "Choose a pet" "dog" "Dog"

    âœ— check label exists:
      âœ“ has tag "label"
      âœ— has attribute "for" "pet-select"
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;The isolated example can be seen in &lt;a href="https://gist.github.com/omnibs/1169729f2891027e261f5411adcdb20b"&gt;this gist&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;selectOption&lt;/code&gt; function from &lt;code&gt;ProgramTest&lt;/code&gt; tries to find a a &lt;code&gt;label&lt;/code&gt; element with a &lt;code&gt;for&lt;/code&gt; attribute but fails. We can see the attribute on the HTML printed out by the test, so why is it not being found?&lt;/p&gt;

&lt;p&gt;To understand it, you need to know how &lt;code&gt;elm-css&lt;/code&gt;, &lt;code&gt;elm/html&lt;/code&gt; and &lt;code&gt;elm-program-test&lt;/code&gt; interact:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;elm-css&lt;/code&gt; mirrors the &lt;code&gt;elm/html&lt;/code&gt; API

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Html.Styled&lt;/code&gt; mirrors &lt;code&gt;Html&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Html.Styled.Attributes&lt;/code&gt; mirrors &lt;code&gt;Html.Attributes&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Html.Styled.Attributes&lt;/code&gt; are translated into &lt;code&gt;Html.Attributes&lt;/code&gt; when &lt;code&gt;Html.Styled.toUnstyled&lt;/code&gt; is called&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Simon&amp;rsquo;s patch to &lt;code&gt;elm/html&lt;/code&gt; changed certain &lt;code&gt;Html.Attributes&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;for&lt;/code&gt; was changed to create an HTML attribute instead of an HTML property&lt;/li&gt;
&lt;li&gt;The attribute &amp;ldquo;for&amp;rdquo; is called &amp;ldquo;htmlFor&amp;rdquo; when set as a property&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;elm-program-test&lt;/code&gt; uses &lt;code&gt;elm/html&lt;/code&gt; internally to build its selectors

&lt;ul&gt;
&lt;li&gt;It was expecting an attribute called &amp;ldquo;for&amp;rdquo;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Our view uses &lt;code&gt;elm-css&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;It was creating a property called &amp;ldquo;htmlFor&amp;rdquo; instead&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We made &lt;a href="https://github.com/rtfeldman/elm-css/pull/598"&gt;a PR to &lt;code&gt;elm-css&lt;/code&gt;&lt;/a&gt; mirroring Simon&amp;rsquo;s changes to &lt;code&gt;elm/html&lt;/code&gt;, and that fixed all tests for us.&lt;/p&gt;

&lt;h4&gt;&lt;code&gt;stopPropagation&lt;/code&gt; on an ancestor blocks descendant&amp;rsquo;s &lt;code&gt;onCheck&lt;/code&gt;&lt;/h4&gt;

&lt;p&gt;This is an old Elm bug, reported &lt;a href="https://github.com/elm/html/issues/188"&gt;here&lt;/a&gt;. Its minimal example is a checkbox inside a &lt;code&gt;div&lt;/code&gt; that has &lt;code&gt;stopPropagation&lt;/code&gt; on its &lt;code&gt;click&lt;/code&gt; event:&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;    Html.div
        [ Html.Events.stopPropagationOn
            "click"
            (Json.Decode.succeed ( Clicked, True ))
        ]
        [ Html.input
            [ Html.Attributes.type_ "checkbox"
            , Html.Attributes.checked checked
            , Html.Events.onCheck Checked
            ]
            []
        ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Clicks on the checkbox will not trigger an event for Elm.&lt;/p&gt;

&lt;p&gt;We hit this bug on our modals, where &lt;code&gt;stopPropagation&lt;/code&gt; is used in a backdrop container by default, even when where it isn&amp;rsquo;t necessary.&lt;/p&gt;

&lt;p&gt;The curious thing about this bug is, even though the old Elm bug is easily reproducible in isolation in the old Virtual DOM, it did not happen on our modals until we adopted &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;. We tried to isolate what exactly made our modals immune to the issue. We gave up after a timeboxed investigation.&lt;/p&gt;

&lt;p&gt;We solved the issue by removing &lt;code&gt;stopPropagation&lt;/code&gt; where it wasn&amp;rsquo;t necessary, and were lucky no places used both &lt;code&gt;stopPropagation&lt;/code&gt; and checkboxes/radios inside modals.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s possible another solution would have been adopting the &lt;a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/dialog"&gt;&lt;code&gt;dialog&lt;/code&gt;&lt;/a&gt; HTML element, but we haven&amp;rsquo;t migrated our modals to use it yet, and haven&amp;rsquo;t validated it would remove our need for &lt;code&gt;stopPropagation&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;UPDATE 2025-11-13:&lt;/strong&gt; Simon Lydell did find an explanation for this issue and did a pretty detailed write-up in the original bug &lt;a href="https://github.com/elm/html/issues/188#issuecomment-3527684798"&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h4&gt;Mini issue: &lt;code&gt;--debug&lt;/code&gt; behaves differently than plain builds&lt;/h4&gt;

&lt;p&gt;While debugging the issue above, we noticed it would not reproduce when the Elm app was built with &lt;code&gt;--debug&lt;/code&gt;, only in plain or optimized builds.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;UPDATE 2025-11-13:&lt;/strong&gt; Simon Lydell has fixed this, and &lt;code&gt;--debug&lt;/code&gt; builds now behave the same as normal builds with &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;. The &lt;a href="https://github.com/lydell/virtual-dom/commit/e1fae6aabd65539db2c94a98220a45cfc624b633"&gt;the fix&lt;/a&gt; is already in the &lt;code&gt;safe&lt;/code&gt; branch of &lt;code&gt;lydell/virtual-dom&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;UPDATE 2025-11-13:&lt;/strong&gt; An earlier version of this post made a claim here that &lt;code&gt;Html.lazy&lt;/code&gt; also did not work on &lt;code&gt;--debug&lt;/code&gt; builds, in both Virtual DOM versions. That was not true. Jeroen Engels brought up that my misunderstanding was likely stemming from differences between plain and &lt;code&gt;--optimize&lt;/code&gt; builds, which makes sense. Jeroen explained that in &lt;code&gt;--optimize&lt;/code&gt; builds, additional wrapping for custom type values can be optimized away, and make otherwise failing &lt;code&gt;lazy&lt;/code&gt; calls start working. Kudos to Simon for being skeptical about that claim, and to Jeroen for explaining my misunderstanding.&lt;/p&gt;

&lt;h4&gt;Some &lt;code&gt;select&lt;/code&gt;s stopped working&lt;/h4&gt;

&lt;p&gt;Different from the &lt;code&gt;elm-css&lt;/code&gt; issue we saw earlier, which only affected tests, we noticed some &lt;code&gt;select&lt;/code&gt; elements stopped working in the real world. Picking an option in the &lt;code&gt;select&lt;/code&gt; element would immediately be reverted.&lt;/p&gt;

&lt;p&gt;We tracked it down to cases where we forgot to update the &lt;code&gt;Attribute.selected&lt;/code&gt; value for &lt;code&gt;option&lt;/code&gt;s based on the model.&lt;/p&gt;

&lt;p&gt;This worked before because the official Virtual DOM only compares its own virtualized DOM nodes&amp;rsquo; previous and current state when deciding when to change the real DOM. Since we were never changing &lt;code&gt;selected&lt;/code&gt;, there was never anything to diff against.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;elm-safe-virtual-dom&lt;/code&gt; compares properties directly against the real DOM, so it would see &lt;code&gt;selected&lt;/code&gt; had changed in the real DOM, and would act to revert it.&lt;/p&gt;

&lt;p&gt;This was a bug in our code, and the official Virtual DOM was only being forgiving about it.&lt;/p&gt;

&lt;h4&gt;&lt;code&gt;contenteditable&lt;/code&gt; nodes stopped working&lt;/h4&gt;

&lt;p&gt;Nodes with &lt;code&gt;contenteditable&lt;/code&gt; are plain looking text elements that users can type in, delete text from, etc. We use them in exercises where students are supposed to identify mistakes in text and fix them.&lt;/p&gt;

&lt;p&gt;With &lt;code&gt;safe-elm-virtual-dom&lt;/code&gt;, these nodes stopped accepting key presses for adding or removing text, even though you could still navigate with your cursor through the text.&lt;/p&gt;

&lt;h5&gt;Our implementation&lt;/h5&gt;

&lt;p&gt;We had implemented it like this:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Set &lt;code&gt;contenteditable&lt;/code&gt; to &lt;code&gt;true&lt;/code&gt; on a &lt;code&gt;span&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Set &lt;code&gt;Attribute.property "innerText"&lt;/code&gt; to a fixed initial value&lt;/li&gt;
&lt;li&gt;Read back &lt;code&gt;target.innerText&lt;/code&gt; in the &lt;code&gt;Decoder&lt;/code&gt; for events like &lt;code&gt;keyup&lt;/code&gt;, &lt;code&gt;blur&lt;/code&gt;, etc&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Simplified code below:&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;view initialValue onInput =
    Html.Styled.span
        [ Attributes.contenteditable True
        , initialValue
            |&amp;gt; Encode.string
            |&amp;gt; Attributes.property "innerText"
        , eventListeners onInput
        ]
        []

eventListeners : (String -&amp;gt; msg) -&amp;gt; List (Html.Styled.Attribute msg)
eventListeners onInput =
    List.map
        (\event -&amp;gt;
            Html.Styled.Events.on event
                (Decode.map onInput
                    (Decode.at [ "target", "innerText" ] Decode.string)
                )
        )
        [ "blur", "keyup", "paste", "copy", "cut", "mouseup" ]
&lt;/code&gt;&lt;/pre&gt;

&lt;h5&gt;The issue&lt;/h5&gt;

&lt;p&gt;This implementation only worked because the official Virtual DOM only compares its own virtualized DOM nodes previous and current state when deciding when to change the real DOM. Since we never changed &lt;code&gt;innerText&lt;/code&gt; through Elm, it never detected a diff, and never tried to change the real DOM.&lt;/p&gt;

&lt;p&gt;In &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;, the real DOM node&amp;rsquo;s &lt;code&gt;innerText&lt;/code&gt; is compared against the virtualized node on every render, so the fixed value would undo user edits.&lt;/p&gt;

&lt;p&gt;Changing it to not be a fixed value made edits possible, but the cursor would jump to the start of the text on every keystroke.&lt;/p&gt;

&lt;h5&gt;Making things a bit worse&lt;/h5&gt;

&lt;p&gt;In some Elm apps, we have a port for tracking user activity that responds to a whole host of events, including &lt;code&gt;input&lt;/code&gt;, which is the only event triggered by dictation software.&lt;/p&gt;

&lt;p&gt;The interaction between this port and the &lt;code&gt;contenteditable&lt;/code&gt; node got even more problematic:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;On &lt;code&gt;input&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;The real DOM would have been updated with user input&lt;/li&gt;
&lt;li&gt;The port would send a &amp;ldquo;user active&amp;rdquo; message to Elm&lt;/li&gt;
&lt;li&gt;Elm would not know the user changed the text, so it would re-render the &lt;code&gt;contenteditable&lt;/code&gt; node with the old text&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;On &lt;code&gt;keyup&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;Elm would fetch &lt;code&gt;target.innerText&lt;/code&gt; for the event&lt;/li&gt;
&lt;li&gt;&lt;code&gt;innerText&lt;/code&gt; would reflect the reverted text&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We tried making our &lt;code&gt;contenteditable&lt;/code&gt; element listen to &lt;code&gt;input&lt;/code&gt; events too, but the port still fired first, and relying on event ordering seemed fragile.&lt;/p&gt;

&lt;h5&gt;Our fix&lt;/h5&gt;

&lt;p&gt;The fix for &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt; required using a &lt;a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_components/Using_custom_elements"&gt;Custom Element&lt;/a&gt;, and a bit of creativity:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Give the custom element a private &lt;code&gt;content&lt;/code&gt; property to hold the text coming from Elm&lt;/li&gt;
&lt;li&gt;Provide getters and setters for the &lt;code&gt;content&lt;/code&gt; property&lt;/li&gt;
&lt;li&gt;In the Custom Element&amp;rsquo;s &lt;code&gt;connectedCallback&lt;/code&gt;, set &lt;code&gt;innerText&lt;/code&gt; to the value of the &lt;code&gt;content&lt;/code&gt; property&lt;/li&gt;
&lt;li&gt;Keep reading &lt;code&gt;target.innerText&lt;/code&gt; in Elm event decoders&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This effectively replicates the implementation we had before: Elm only affects &lt;code&gt;innerText&lt;/code&gt; at initialization, but it reads the up-to-date value from the real DOM on every edit.&lt;/p&gt;

&lt;p&gt;The custom element&amp;rsquo;s code looks like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class="js"&gt;customElements.define("content-editable",
  class extends HTMLElement {
    private elmContent: string | null = null;

    connectedCallback() {
      this.innerText = this.elmContent || "";
    }

    get content(): string { return this.elmContent || ""; }

    set content(value: string) { this.elmContent = value; }
  },
);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We then wrap this in a &lt;code&gt;ContentEditable&lt;/code&gt; Elm module to allow us to document and reproduce the pattern.&lt;/p&gt;

&lt;h5&gt;What if Elm needs to change or reset the text after initialization?&lt;/h5&gt;

&lt;p&gt;When we need to force the &lt;code&gt;content-editable&lt;/code&gt; custom element to receive a new value from Elm, we can use &lt;code&gt;Html.Keyed&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;Html.Keyed.node "content-editable-container" []
    [ ( key, ContentEditable.view content onInput) ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When an event needs to change &lt;code&gt;innerText&lt;/code&gt;, we can bump the value of &lt;code&gt;key&lt;/code&gt; in the &lt;code&gt;Html.Keyed&lt;/code&gt; child node, which in turn will cause Elm to destroy and re-create the custom element, re-running our &lt;code&gt;connectedCallback&lt;/code&gt; and setting &lt;code&gt;innerText&lt;/code&gt; to the new value.&lt;/p&gt;

&lt;h2&gt;Assessing risks&lt;/h2&gt;

&lt;h3&gt;Risk of reverting&lt;/h3&gt;

&lt;p&gt;There is a risk that &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;&amp;rsquo;s patches are never adopted into upstream Elm packages, or that Evan takes an entirely different approach to address Virtual DOM breakage caused by external DOM mutations.&lt;/p&gt;

&lt;p&gt;We had to make changes to our codebase to adopt &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;. What would be the effort if we had to move away from &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt; in the future?&lt;/p&gt;

&lt;p&gt;While assessing every change we made here, we realized all of them are backwards-compatible. Elm&amp;rsquo;s official Virtual DOM is strictly more lenient than &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;, so we expect going back to the official Virtual DOM would require no code changes aside from our patching infrastructure.&lt;/p&gt;

&lt;p&gt;Furthermore, Simon is working with Lamdera to integrate his patches into their Elm compiler, which signals the community is moving towards embracing these changes, lowering the chances of a revert.&lt;/p&gt;

&lt;h3&gt;Risk of maintaining forks&lt;/h3&gt;

&lt;p&gt;Elm&amp;rsquo;s core packages are very stable:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;elm/browser&lt;/code&gt; and &lt;code&gt;elm/html&lt;/code&gt; have not seen a release in 6 years&lt;/li&gt;
&lt;li&gt;&lt;code&gt;elm/virtual-dom&lt;/code&gt; has seen 2 patch releases in 6 years&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We don&amp;rsquo;t expect there to be effort keeping forks in sync, and we could count on Simon, and Lamdera in the future too, on helping keep things in sync.&lt;/p&gt;

&lt;p&gt;The riskiest fork is &lt;code&gt;rtfeldman/elm-css&lt;/code&gt;, which we had to patch ourselves, and which sees more frequent releases. However, our changes to &lt;code&gt;elm-css&lt;/code&gt; were in its mirror of the &lt;code&gt;elm/html&lt;/code&gt; API. Since we don&amp;rsquo;t anticipate &lt;code&gt;elm/html&lt;/code&gt; changing, we don&amp;rsquo;t expect that mirror to change either.&lt;/p&gt;

&lt;h2&gt;Results&lt;/h2&gt;

&lt;p&gt;We shipped to production with &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt; on November 3rd 2025, and have not encountered any new issues.&lt;/p&gt;

&lt;p&gt;We had 10 distinct Virtual DOM-related exceptions in production the week before shipping, triggering thousands of times per day. After shipping, only 3 were left. The new Virtual DOM made the call stack clearer for those 3, and helped us pin them down to an old polyfill we had for Custom Elements. Fixing that, we now have zero Virtual DOM exceptions in production.&lt;/p&gt;

&lt;h2&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Ultimately, adopting &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt; has been a clear and significant win for reliability. Adoption required a careful patching strategy via Nix and deep dives into surprising interactions with &lt;code&gt;elm-css&lt;/code&gt;, &lt;code&gt;contenteditable&lt;/code&gt;, and even a long-standing Elm bug.&lt;/p&gt;

&lt;p&gt;The most interesting take-away, perhaps, is all of the issues we encountered led to backwards-compatible fixes, so reverting back to the official Elm Virtual DOM, if necessary, would be trivial.&lt;/p&gt;

&lt;p&gt;The results were very satisfying: we&amp;rsquo;ve gone from thousands of daily Virtual DOM-related exceptions to zero. We now have the confidence to explore browser-based translations and are no longer at the mercy of browser extensions, just as we&amp;rsquo;d hoped.&lt;/p&gt;

&lt;p&gt;For any team facing similar challenges in Elm, we highly recommend exploring &lt;code&gt;elm-safe-virtual-dom&lt;/code&gt;. While the migration requires some effort, the payoff in stability and correctness are well worth it.&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;Juliano Solanho &lt;a href="https://github.com/omnibs"&gt;@omnibs&lt;/a&gt; Engineer at &lt;a href="https://www.noredink.com"&gt;NoRedInk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you Brian Carroll and Brian Cardiff for draft reviews and feedback, and Celso Bonutti for raising this opportunity internally! ðŸ’œ&lt;/p&gt;</description><link>https://blog.noredink.com/post/800011916366020608</link><guid>https://blog.noredink.com/post/800011916366020608</guid><pubDate>Wed, 12 Nov 2025 07:33:37 -0500</pubDate></item><item><title>Word Labels</title><description>&lt;p&gt;Working at NoRedInk, I have the opportunity to work on such a variety of challenges and puzzles! It&amp;rsquo;s a pleasure to figure out how to build ambitious and highly custom components and applications.&lt;/p&gt;

&lt;p&gt;Recently, I built a component that will primarily be used for labeling sentences with parts of speech.&lt;/p&gt;

&lt;p&gt;This component was supposed to show &amp;ldquo;labels&amp;rdquo; over words while guaranteeing that the labels wouldn&amp;rsquo;t cover meaningful content (including other labels). This required labels to be programmatically and dynamically repositioned to keep content readable:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/211934533-6bca649a-fc16-4da4-89f1-df4649d128a0.png" alt='Screenshot of the sentence "Dave broke his french fry so he glued it with ketchup." "Dave" and "he" have pink balloons labelling each as a "subject". "Broke" and "glued" have yellow balloons labelling each as a "verb". The "subject" labels are offset above the "verb" labels so that no content is obscured.'/&gt;&lt;/p&gt;

&lt;p&gt;It takes some CSS and some measuring of rendered content to avoid overlaps:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/211934537-ea063f54-a819-4bad-8f16-c55fe7e6b417.png" alt='Screenshot of the sentence "Dave broke his french fry so he glued it with ketchup." "Dave" and "he" have pink balloons labelling each as a "subject". "Broke" and "glued" have yellow balloons labelling each as a "verb". The "verb" labels partially overlap the "subject" balloons, especially the "subject" balloon over "he".'/&gt;&lt;/p&gt;

&lt;p&gt;All meaningful content needs to be accessible to users, so it&amp;rsquo;s vital that content not be obscured.&lt;/p&gt;

&lt;p&gt;In this post, I&amp;rsquo;m going to go through a simplified version of the Elm, CSS, and HTML I used to accomplish this goal. I&amp;rsquo;m going to focus primarily on the positioning styles, since they&amp;rsquo;re particularly tricky!&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;Balloon&lt;/h2&gt;

&lt;p&gt;The first piece we need is a way to render the label in a little box with an arrow. To avoid confusion over HTML labels, we&amp;rsquo;ll call this little component &amp;ldquo;Balloon.&amp;rdquo;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/209983216-930d8683-9e3c-42df-a761-024ba9e4464d.png" alt='Screenshot of a black box containing the white text "Example label". A little black triangle is attached to the bottom of the black box, giving the impression that the box is pointing to whatever is below it.'/&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;balloon : String -&amp;gt; Html msg
balloon label =
    span
        [ css
            [ Css.display Css.inlineFlex
            , Css.flexDirection Css.column
            , Css.alignItems Css.center
            ]
        ]
        [ balloonLabel label
        , balloonArrow initialArrowSize
        ]


balloonLabel : String -&amp;gt; Html msg
balloonLabel label =
    span
        [ css
            [ Css.backgroundColor black
            , Css.color white
            , Css.border3 (Css.px 1) Css.solid black
            , Css.margin Css.zero
            , Css.padding (Css.px 4)
            , Css.maxWidth (Css.px 175)
            , Css.property "width" "max-content"
            ]
        ]
        [ text label ]


initialArrowSize : Float
initialArrowSize =
    10


balloonArrow : Float -&amp;gt; Html msg
balloonArrow arrowHeight =
    span
        [ attribute "data-description" "balloon-arrow"
        , css
            [ Css.borderStyle Css.solid

            -- Make a triangle
            , Css.borderTopWidth (Css.px arrowHeight)
            , Css.borderRightWidth (Css.px initialArrowSize)
            , Css.borderBottomWidth Css.zero
            , Css.borderLeftWidth (Css.px initialArrowSize)

            -- Colors:
            , Css.borderTopColor black
            , Css.borderRightColor Css.transparent
            , Css.borderBottomColor Css.transparent
            , Css.borderLeftColor Css.transparent
            ]
        ]
        []
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqwcLhVn8ka1"&gt;Ellie balloon example&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;Positioning a Balloon over a Word&lt;/h2&gt;

&lt;p&gt;Next, we want to be able to center a balloon over a particular word, so that it appears that the balloon is labelling the word.&lt;/p&gt;

&lt;p&gt;This is where an extremely useful CSS trick can come into play: &lt;code&gt;position&lt;/code&gt; styles don&amp;rsquo;t have the same frame of reference as &lt;code&gt;transform&lt;/code&gt; styles.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;position styles apply with respect to the relative parent container&lt;/li&gt;
&lt;li&gt;transform translations apply with respect to the element itself&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This means that we can combine position styles and transform translations in order to center an arbitrary-width balloon over an arbitary-width word.&lt;/p&gt;

&lt;p&gt;Adding the following styles to the balloon container:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;, Css.position Css.absolute
, Css.left (Css.pct 50)
, Css.transforms [ Css.translateX (Css.pct -50), Css.translateY (Css.pct -100) ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and rendering the balloon in the same position-relative container as the word itself:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;word : String -&amp;gt; Maybe String -&amp;gt; Html msg
word word_ maybeLabel =
    span
        [ css
            [ Css.position Css.relative
            , Css.whiteSpace Css.preWrap
            ]
        ]
        (case maybeLabel of
            Just label -&amp;gt;
                [ balloon label, text word_ ]

            Nothing -&amp;gt;
                [ text word_ ]
        )

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;handles our centering!&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/211929444-e972aeda-c6b3-4f14-a0fe-639829d86417.png" alt='Screenshot of two examples. The first is labelled as an "Example with a short word and wide balloon" and shows the letter "w" with a balloon centered above it. The ballon says "Balloons have a maximium width of 175px" and the balloon text wraps after 175 pixels. The second example is labelled as an "Example with a wide word and narrow balloon" and shows the word "loquaciousness" with a balloon centered above it. The balloon says "noun" and is much narrower than 175 pixels and much narrower than the word "loquaciousness".'/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqwBgJg27Ja1"&gt;Ellie centering-a-balloon example&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;Conveying the balloon meaning without styles&lt;/h2&gt;

&lt;p&gt;It&amp;rsquo;s important to note that while our styles do a solid job of associating the balloon with the word, not all users of our site will see our styles. We need to make sure we&amp;rsquo;re writing semantic HTML that will be understandable by all users, including users who aren&amp;rsquo;t experiencing our CSS.&lt;/p&gt;

&lt;p&gt;For the purposes of the NoRedInk project that the component that I&amp;rsquo;m describing here will be used for, we decided to use a &lt;code&gt;mark&lt;/code&gt; element with &lt;code&gt;::before&lt;/code&gt; and &lt;code&gt;::after&lt;/code&gt; pseudo-elements to semantically communicate the meaning of the balloon to assistive technology users. Then we marked the balloon itself as hidden, so that the user wouldn&amp;rsquo;t experience annoying redundant information.&lt;/p&gt;

&lt;p&gt;Since this post is primarily focused on CSS, I&amp;rsquo;m not going to expand on this more. Please read &lt;a href="https://adrianroselli.com/2017/12/tweaking-text-level-styles.html"&gt;&amp;ldquo;Tweaking Text Level Styles&amp;rdquo;&lt;/a&gt; by Adrian Roselli to better understand the technique we&amp;rsquo;re using.&lt;/p&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqwXJb4w3fa1"&gt;Ellie improving the balloon-word relationship&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;Fixing horizontal Balloon overlaps&lt;/h2&gt;

&lt;p&gt;Balloons on the same line can potentially overlap each other on their left and right edges. Since we want users to be able to adjust font size preferences and to use magnification as much as they want, we can&amp;rsquo;t guarantee anything about the size of the labels or where line breaks occur in the text.&lt;/p&gt;

&lt;p&gt;This means we need to measure the DOM and reposition labels dynamically. For development purposes, it&amp;rsquo;s convenient to add a button to measure and reposition the labels on demand. For production uses, labels should be measured and repositioned on page load, when the window changes sizes, or when anything else might happen to change the reflow.&lt;/p&gt;

&lt;p&gt;To measure the element, we can use &lt;code&gt;Browser.Dom.getElement&lt;/code&gt;, which takes an html id and runs a task to measure the element on the page.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;type alias Model =
    Dict.Dict String Dom.Element


update : Msg -&amp;gt; Model -&amp;gt; ( Model, Cmd Msg )
update msg model =
    case msg of
        GetMeasurements -&amp;gt;
            ( model, Cmd.batch (List.map measure allIds) )

        GotMeasurements balloonId (Ok measurements) -&amp;gt;
            ( Dict.insert balloonId measurements model
            , Cmd.none
            )

        GotMeasurements balloonId (Err measurements) -&amp;gt;
            -- in a real application, handle errors gracefully with reporting
            ( model, Cmd.none )


measure : String -&amp;gt; Cmd Msg
measure balloonId =
    Task.attempt (GotMeasurements balloonId) (Dom.getElement balloonId)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then we can do some logic (optimized for clarity rather than performance, since we&amp;rsquo;re not expecting many balloons at once) to figure out how far the balloons need to be offset based on these measurements:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;arrowHeights : Dict.Dict String Dom.Element -&amp;gt; Dict.Dict String Float
arrowHeights model =
    let
        bottomY { element } =
            element.y + element.height
    in
    model
        |&amp;gt; Dict.toList
        --
        -- first, we sort &amp;amp; group by line, so that we're only looking for horizontal overlaps between
        -- balloons on the same line of text
        |&amp;gt; List.sortBy (Tuple.second &amp;gt;&amp;gt; bottomY)
        |&amp;gt; List.Extra.groupWhile (\( _, a ) ( _, b ) -&amp;gt; bottomY a == bottomY b)
        |&amp;gt; List.map (\( first, rem ) -&amp;gt; first :: rem)
        --
        -- for each line,we find horizontal overlaps
        |&amp;gt; List.concatMap
            (\line -&amp;gt;
                line
                    |&amp;gt; List.sortBy (Tuple.second &amp;gt;&amp;gt; .element &amp;gt;&amp;gt; .x)
                    |&amp;gt; List.Extra.groupWhile (\( _, a ) ( _, b ) -&amp;gt; (a.element.x + a.element.width) &amp;gt;= b.element.x)
                    |&amp;gt; List.map (\( first, rem ) -&amp;gt; first :: rem)
            )
        --
        -- now we have our overlaps and our singletons!
        |&amp;gt; List.concatMap
            (\overlappingBalloons -&amp;gt;
                overlappingBalloons
                    --
                    -- we sort each overlapping group by width: we want the widest balloon on top
                    -- (why? the wide balloons might overlap multiple other balloons. Putting the widest balloon on top is a step towards a maximally-compact solution.)
                    |&amp;gt; List.sortBy (Tuple.second &amp;gt;&amp;gt; .element &amp;gt;&amp;gt; .width)
                    -- then we iterate over the overlaps and account for the previous balloon's height
                    |&amp;gt; List.foldl
                        (\( idString, e ) ( index, height, acc ) -&amp;gt;
                            ( index + 1
                            , height + e.element.height
                            , ( idString, height )
                                :: acc
                            )
                        )
                        ( 0, initialArrowSize, [] )
                    |&amp;gt; (\( _, _, v ) -&amp;gt; v)
            )
        |&amp;gt; Dict.fromList
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then we thread the offset we get all the way through to the balloon&amp;rsquo;s arrow so that it can expand in height appropriately.&lt;/p&gt;

&lt;p&gt;This works!&lt;/p&gt;

&lt;p&gt;We can reposition from:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/209984712-b448440a-9dda-4737-b725-c00391fc8b21.png" alt="Screenshot showing 5 marked words each with a balloon. The balloon content overlaps such that the balloons are illegible."/&gt;&lt;/p&gt;

&lt;p&gt;to:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/209984970-d364eecb-6140-45a5-971e-bf55ec283a8e.png" alt="Screenshot showing 5 marked words each with a balloon. The balloons' arrows are different heights, keeping the balloon content from overlapping. The balloons take up a lot of space."/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqxpNGWqzfa1"&gt;Ellie initial repositioning example&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;Fixing Balloons overlapping content above them&lt;/h2&gt;

&lt;p&gt;Our balloons are no longer overlapping each other, but they still might overlap content above them. They haven&amp;rsquo;t been overlapping content above them in the examples so far because I sneakily added a lot of margin on top of their containing paragraph tag. If we remove this margin:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/209986486-31b374a0-332d-4145-8b1b-6f45707dd3e7.png" alt="Screenshot showing balloons overlapping and obscuring text. The screenshot is hard to parse visually because the balloons have a black background and the partially covered text is also black."/&gt;&lt;/p&gt;

&lt;p&gt;This seems like a challenging problem: how can we make an absolutely-positioned item take up space in normal inline flow? We can&amp;rsquo;t! But what we &lt;em&gt;can&lt;/em&gt; do is make our normal inline words take up more space to account for the absolutely positioned balloon.&lt;/p&gt;

&lt;p&gt;When we have a label, we are now going to wrap the word in a span with &lt;code&gt;display: inline-block&lt;/code&gt; and with some top padding. This will guarantee that&amp;rsquo;s there&amp;rsquo;s always sufficient space for the balloon after we finish measuring.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve added a border around this span to make it more clear what&amp;rsquo;s happening in the screenshots:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/209990238-532fea13-9162-4122-bcab-5dc66564651b.png" alt="Screenshot showing 5 marked words each with a balloon. Each marked word and balloon pair is surrounded by a blue border."/&gt;&lt;/p&gt;

&lt;p&gt;This approach also works when the content flows on to multiple lines:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/209990943-71efd654-5ea0-41a9-802a-7c22af83b1ea.png" alt="Screenshot showing a very narrow viewport where 2 of 5 marked words with balloons have flowed on to a second line. The balloons on the second line do not cover the words on the first line."/&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{-| The height of the arrow and the total height are different, so now we need to calculate 2 different values based on our measurements. -}
type alias Position =
    { arrowHeight : Float
    , totalHeight : Float
    }


word : String -&amp;gt; Maybe { label : String, id : String, position : Maybe Position } -&amp;gt; Html msg
word word_ maybeLabel =
    let
        styles =
            [ Css.position Css.relative
            , Css.whiteSpace Css.preWrap
            ]
    in
    case maybeLabel of
        Just ({ label, position } as balloonDetails) -&amp;gt;
            mark
                [ css
                    (styles
                        ++ [ Css.before
                                [ Css.property "content" ("\" start " ++ label ++ " highlight \"")
                                , invisibleStyle
                                ]
                           , Css.after
                                [ Css.property "content" ("\" end " ++ label ++ " \"")
                                , invisibleStyle
                                ]
                           ]
                    )
                ]
                [ span
                    [ css
                        [ Css.display Css.inlineBlock
                        , Css.border3 (Css.px 2) Css.solid (Css.rgb 0 0 255)
                        , Maybe.map (Css.paddingTop &amp;lt;&amp;lt; Css.px &amp;lt;&amp;lt; .totalHeight) position
                            |&amp;gt; Maybe.withDefault (Css.batch [])
                        ]
                    ]
                    [ balloon balloonDetails
                    , text word_
                    ]
                ]

        Nothing -&amp;gt;
            span [ css styles ]
                [ text word_ ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqxQDsy3WVa1"&gt;Ellie avoiding top overlaps&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;Fixing multiple repositions logic&lt;/h2&gt;

&lt;p&gt;Alright! So we&amp;rsquo;ve prevented top overlaps and we&amp;rsquo;ve prevented balloons from overlapping each other on the sides.&lt;/p&gt;

&lt;p&gt;There is still a repositioning problem though! We need to reposition the labels again based on window events like resizing. Right now, we&amp;rsquo;re measuring the height of the entire balloon including the arrow, and then using that height to calculate how tall a neighboring balloon&amp;rsquo;s arrow needs to be. This means that subsequent remeasures can make the arrows far taller than they need to be!&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/209985698-4e4f6010-3d72-44c9-91cc-2f540a714eef.png" alt="Screenshot showing 5 marked words each with a balloon. The balloons' arrows are different heights that prevent overlaps, but the arrows are excessively tall."/&gt;&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;re measuring the entire rendered balloon when we check for overlaps and figure out our repositioning, but we should really only be taking into consideration whether balloons overlap when in their &lt;em&gt;starting positions&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Essentially, we need to disregard the measured height of the arrow entirely when calculating new arrow heights. A straightforward way to do this is to measure the content within the balloon separately from the overall balloon measurement.&lt;/p&gt;

&lt;p&gt;We add a new id to the balloon content:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;balloonContentId : String -&amp;gt; String
balloonContentId baseId =
    baseId ++ "-content"


balloonLabel : { config | label : String, id : String } -&amp;gt; Html msg
balloonLabel config =
    p
        [ css
            [ Css.backgroundColor black
            , Css.color white
            , Css.border3 (Css.px 1) Css.solid black
            , Css.margin Css.zero
            , Css.padding (Css.px 4)
            , Css.maxWidth (Css.px 175)
            , Css.property "width" "max-content"
            ]
        , id (balloonContentId config.id)
        ]
        [ text config.label ]

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and measure the balloon content when we measure the total balloon:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;measure : String -&amp;gt; Cmd Msg
measure balloonId =
    Task.map2 (\balloon_ balloonContent -&amp;gt; { balloon = balloon_, balloonContent = balloonContent })
        (Dom.getElement balloonId)
        (Dom.getElement (balloonContentId balloonId))
        |&amp;gt; Task.attempt (GotMeasurements balloonId)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We also change our position calculation helper from:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;positions : Dict.Dict String Dom.Element -&amp;gt; Dict.Dict String Position
positions model =
                    ...
                    -- then we iterate over the overlaps and account for the previous balloon's height
                    |&amp;gt; List.foldl
                        (\( idString, e ) ( index, height, acc ) -&amp;gt;
                            ( index + 1
                            , height + e.element.height
                            , ( idString
                              , { totalHeight = height + e.element.height - initialArrowSize
                                , arrowHeight = height
                                }
                              )
                                :: acc
                            )
                        )
                        ( 0, initialArrowSize, [] )
                    ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;to&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;positions : Dict.Dict String { balloon : Dom.Element, balloonContent : Dom.Element } -&amp;gt; Dict.Dict String Position
positions model =
                    ...
                    -- then we iterate over the overlaps and account for the previous balloon's height
                    |&amp;gt; List.foldl
                        (\( idString, e ) ( index, height, acc ) -&amp;gt;
                            ( index + 1
                            , height + e.balloonContent.element.height
                            , ( idString
                              , { totalHeight = height + e.balloonContent.element.height
                                , arrowHeight = height
                                }
                              )
                                :: acc
                            )
                        )
                        ( 0, initialArrowSize, [] )
                    ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqyckwmj2na1"&gt;Ellie with fixed multiple repositioning logic&lt;/a&gt;&lt;/p&gt;

&lt;h2&gt;Fixing overlaps with the arrow&lt;/h2&gt;

&lt;p&gt;I claimed previously that we fixed overlaps between the balloons. This is true-ish: we actually only fixed overlaps between pieces of balloon &lt;em&gt;content&lt;/em&gt;. A meaningful piece of balloon content can actually still overlap another balloon&amp;rsquo;s arrow! And, since the content stacks from left to right, there&amp;rsquo;s a chance that meangingful content might be obscured by an arrow:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/209994572-60f481b1-6ec1-4f3c-a4f4-9549fecc8c01.png" alt="Screenshot showing words &amp;quot;A&amp;quot;, &amp;quot;B&amp;quot;, &amp;quot;C&amp;quot; from left to right with ballons &amp;quot;longest balloon&amp;quot;, &amp;quot;medm balloon&amp;quot;, and &amp;quot;tiny balloon&amp;quot; from top to bottom. The lower two ballons' content is partially obscured by the top balloon's arrow. The top and bottom edges of the balloons touch."/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kznMp6355Cfa1"&gt;Ellie showing the balloon and arrow overlap problem&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There are two problems here:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;The balloons need a clearer indication of their edges when they&amp;rsquo;re close together.&lt;/li&gt;
&lt;li&gt;The left-to-right stacking context won&amp;rsquo;t work. We need to put the bottom balloon on top of the stacking context so that balloon content is never obscured.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The first problem is improved by adding white borders to the balloon content and shifting the balloon arrow up a corresponding amount.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/210008874-980532f5-f21d-47da-b859-ed2a31586acb.png" alt="Screenshot showing words &amp;quot;A&amp;quot;, &amp;quot;B&amp;quot;, &amp;quot;C&amp;quot; from left to right with ballons &amp;quot;longest balloon&amp;quot;, &amp;quot;medm balloon&amp;quot;, and &amp;quot;tiny balloon&amp;quot; from top to bottom. The lower two ballons' content is partially obscured by the top balloon's arrow. The edges of the balloons no longer touch and where the &amp;quot;tiny balloon&amp;quot; overlaps the &amp;quot;medm balloon&amp;quot; there is whitespace around the &amp;quot;tiny balloon&amp;quot; content."/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqHkXGx6Pza1"&gt;Ellie where each balloon has a white border around its content&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The second part of the problem can be fixed by adding a zIndex to the balloon based on position in the overlapping rows, so that arrows never cover label content:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;positions : Dict.Dict String { balloon : Dom.Element, balloonContent : Dom.Element } -&amp;gt; Dict.Dict String Position
positions model =
        ...
        -- now we have our overlaps and our singletons!
        |&amp;gt; List.concatMap
            (\overlappingBalloons -&amp;gt;
                let
                    maxOverlappingBalloonsIndex =
                        List.length overlappingBalloons - 1
                in
                overlappingBalloons
                    --
                    -- we sort each overlapping group by width: we want the widest balloon on top
                    |&amp;gt; List.sortBy (Tuple.second &amp;gt;&amp;gt; .balloon &amp;gt;&amp;gt; .element &amp;gt;&amp;gt; .width)
                    -- then we iterate over the overlaps and account for the previous balloon's height
                    |&amp;gt; List.foldl
                        (\( idString, e ) ( index, height, acc ) -&amp;gt;
                            ( index + 1
                            , height + e.balloonContent.element.height
                            , ( idString
                              , { totalHeight = height + e.balloonContent.element.height
                                , arrowHeight = height
                                , zIndex = maxOverlappingBalloonsIndex - index
                                }
                              )
                                :: acc
                            )
                        )
                        ( 0, initialArrowSize, [] )
        ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqJmVhpfJLa1"&gt;Ellie with the zIndex logic applied&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/210009093-8e99f3cd-d874-4926-b082-ca43dfb6f4f2.png" alt='Screenshot showing words "A", "B", "C" from left to right with ballons "longest balloon", "medm balloon", and "tiny balloon" from top to bottom. No content is obscured, even though the balloons overlap arrows.'/&gt;&lt;/p&gt;

&lt;h2&gt;Fixing content extending beyond the viewport&lt;/h2&gt;

&lt;p&gt;We&amp;rsquo;re almost done with ways that the balloons can overlap content!&lt;/p&gt;

&lt;p&gt;For our purposes, we expect words marked with a balloon to be the only meaningful content showing in a line. That is, we&amp;rsquo;re not worried about the balloon overlapping something meaningful to its right or left because we know how the component will be used. This is great, since it really simplifies the overlap problem for us: it means we only need to worry about the viewport edges cutting off balloons.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/210009294-557e1988-3a94-47aa-b7ae-120e855f5de1.png" alt="Screenshot showing 3 balloons cut off on the left edge of the viewport"/&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Browser.Dom.getElement&lt;/code&gt; also returns information about the viewport, which we can use to adjust our position logic to get the amount that a given balloon is &amp;ldquo;cut off&amp;rdquo; on the horizontal edges. Once we have this xOffset, using CSS to scootch a balloon over is nice and straightforward:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;balloonLabel : { label : String, id : String, position : Maybe Position } -&amp;gt; Html msg
balloonLabel config =
    p
        [ css
            [ Css.backgroundColor black
            , Css.color white
            , Css.border3 (Css.px 2) Css.solid white
            , Css.margin Css.zero
            , Css.padding (Css.px 4)
            , Css.maxWidth (Css.px 175)
            , Css.property "width" "max-content"
            , Css.transform (Css.translateX (Css.px (Maybe.map .xOffset config.position |&amp;gt; Maybe.withDefault 0)))
            ]
        , id (balloonContentId config.id)
        ]
        [ text config.label ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzqKNJnMZ7Ra1"&gt;Ellie with x-offset logic&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/210009407-7dc366b9-7b31-4e5f-aafb-99ffad0bb9f4.png" alt="Screenshot showing 3 balloons shifted right to account for the left edge of the viewport. Each arrow is still centered over the word it is marking."/&gt;&lt;/p&gt;

&lt;p&gt;Please note that when elements are pushed to the right of the viewport edge, by default, the browser will give you a scrollbar to get over to see the content.&lt;/p&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kzpnHBx297da1"&gt;Ellie demoing right-scroll when an element is translated off the right edge of the viewport.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You may want to hide overflow in the x direction to prevent the scrollbar from appearing/your mobile styles from getting messed up.&lt;/p&gt;

&lt;h2&gt;That&amp;rsquo;s (mostly) it!&lt;/h2&gt;

&lt;p&gt;You might notice that the solution isn&amp;rsquo;t maximally compact:&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/221697943-6e4cdba5-a09d-43ff-a4ad-b236e6e7efb0.png" alt="Screenshot showing 3 balloons that could have been positioned over 2 lines, but instead were positioned over 3 lines."/&gt;&lt;/p&gt;

&lt;p&gt;This is where our MVP line was. If it turns out that our content ends up taking up too much vertical space, and we want to go for the maximally compact version, we&amp;rsquo;ll revisit the implementation. Since the logic is all in one easily-testable Elm function, improving the algorithm should be pretty straightfoward.&lt;/p&gt;

&lt;p&gt;Additionally, this post didn&amp;rsquo;t get into high-contrast mode styles. The way that the balloon is styled currently is &lt;em&gt;utterly&lt;/em&gt; inaccessible in high contrast mode! Anytime you&amp;rsquo;re changing background color and font color, it&amp;rsquo;s important to check in high-contrast mode to see how the styles are being coerced. I&amp;rsquo;ve written a couple of previous posts talking about color considerations (&lt;a href="https://blog.noredink.com/post/703458632758689792/custom-focus-rings"&gt;Custom Focus Rings&lt;/a&gt;, &lt;a href="https://blog.noredink.com/post/701651083488018432/presenting-styleguide-colors"&gt;Presenting Styleguide Colors&lt;/a&gt;) so I don&amp;rsquo;t want to dig into how to fix this problem in this post. Please be aware that while the positioning styles in this post are fairly solid, the rest of the styles &lt;em&gt;are not production ready&lt;/em&gt;.&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;Thanks for reading along! I had a great time working on this project and I&amp;rsquo;m quite pleased with how it came out. I&amp;rsquo;m looking forward to sharing the next interesting project I work on with you!&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/199557776-d58d63dd-07d2-4cfb-9e37-7b2e9dca81b8.png" alt="Photo of the author"/&gt;
&lt;strong&gt;Tessa Kelly&lt;/strong&gt;
&lt;a href="https://twitter.com/t_kelly9"&gt;@t_kelly9&lt;/a&gt;&lt;/p&gt;</description><link>https://blog.noredink.com/post/710448547697426432</link><guid>https://blog.noredink.com/post/710448547697426432</guid><pubDate>Mon, 27 Feb 2023 17:22:13 -0500</pubDate></item><item><title>Custom Focus Rings</title><description>&lt;p&gt;Many people who operate their devices with a keyboard need a visual indicator of keyboard focus. Without a visual indicator of which element has focus, it&amp;rsquo;s hard to know what, say, hitting enter might do. Anything might happen!&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s reasonable to think that either the browser or the operating system should be in charge of making sure keyboard focus is perceivable to keyboard users. You might think that it&amp;rsquo;s best for devs not to overwrite focus styles at all. However, if your website is customizing the look of inputs, there&amp;rsquo;s a good chance that the default focus ring won&amp;rsquo;t actually be visible to your users.&lt;/p&gt;

&lt;p&gt;This is the situation we found ourselves in at NoRedInk, and what follows is what we did to improve things.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;The Problem&lt;/h2&gt;

&lt;h3&gt;Borders&lt;/h3&gt;

&lt;p&gt;At NoRedInk, both our primary and secondary buttons feature blue (specifically, #0A64FF) borders. On a Mac using Chrome, this particular blue color on the edge of the button essentially makes the default focus rings invisible.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/205780355-f4a7598a-2783-44b3-9757-dd2269049a60.png" alt='Screenshot of a blue "primary" button'/&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/205780358-acbc5000-9ef6-4c64-b53f-95a5a3bc09ab.png" alt='Screenshot of a blue "primary" button with the faintest hint of a blue border'/&gt;&lt;/p&gt;

&lt;p&gt;Can you tell the difference between these two pictures? The second one has a focus ring, but if the pictures weren&amp;rsquo;t side by side, there&amp;rsquo;s no way you would know.&lt;/p&gt;

&lt;p&gt;Okay, you might be thinking, don&amp;rsquo;t have blue buttons. However, changing the button color, even if it were feasible from a branding standpoint, doesn&amp;rsquo;t necessarily solve the problem. The outline color that&amp;rsquo;s used for the default focus ring depends on the browser stylesheet, the operating system, and user settings.&lt;/p&gt;

&lt;p&gt;Personally, I have my macOS accent color set to pink, which results in a focus ring that disappears against NoRedInk&amp;rsquo;s danger button style.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/205782308-65d1070e-5a37-40a4-862f-7911702db22e.png" alt='Screenshot of a red "danger" button'/&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/205783109-403a4109-06b5-4af8-930f-6ae94bdc2260.png" alt='Screenshot of a red "danger" button with the faintest hint of a pink border'/&gt;&lt;/p&gt;

&lt;h3&gt;Backgrounds&lt;/h3&gt;

&lt;p&gt;Even if we could customize all of our buttons, inputs, and components so that the border and the focus ring outline always showed cleanly against each other, we still wouldn&amp;rsquo;t have solved the entire problem.&lt;/p&gt;

&lt;p&gt;This is because there&amp;rsquo;s not only the question of the focus indicator showing up against an input to consider: we also need to consider the contrast of the focus indicator against the &lt;em&gt;background color&lt;/em&gt; of an input&amp;rsquo;s container.&lt;/p&gt;

&lt;p&gt;The importance of taking the background color into account became more apparent to us at NoRedInk when we started working on a redesign of &lt;a href="https://www.noredink.com/"&gt;NoRedInk&amp;rsquo;s logged out home page&lt;/a&gt; that made heavy use of blue and navy backgrounds.&lt;/p&gt;

&lt;p&gt;Some browsers have implemented two-toned focus rings that will show up clearly on different backgrounds, but there are major browsers that haven&amp;rsquo;t.&lt;/p&gt;

&lt;p&gt;Here are two screenshots of the same link being actively focused. The first screenshot, taken in Chrome, shows a focus indicator. The second screenshot, taken in Safari, shows only how a focus indicator can become truly and totally indistinguisable from a background.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/206328620-4a3d7d16-caa2-4c22-85e3-cc279abd994c.png" alt="Screenshot of a monochrome white version of the NoRedInk logo against a blue background. There's a clear white border around the logo. Nested directly inside the white border, there's a much harder to distinguish cobalt ring."/&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/206328421-7548d44d-634f-4e23-badb-c382fdd56a9e.png" alt="Screenshot of a monochrome white version of the NoRedInk logo against a blue background."/&gt;&lt;/p&gt;

&lt;h3&gt;Problem summary&lt;/h3&gt;

&lt;p&gt;If we are customizing input styles, we probably also need to make sure that our focus ring (1) has enough contrast with the edge color of the input and (2) has enough contrast with the input&amp;rsquo;s container&amp;rsquo;s background color.&lt;/p&gt;

&lt;h2&gt;Approach&lt;/h2&gt;

&lt;p&gt;While we could have customized the focus ring color for every input and background color individually, we worried that having the focus indicator appear differently in different contexts would make it harder for folks to understand the meaning of the indicator.&lt;/p&gt;

&lt;p&gt;Consistency in UX is really important for usability in general. We didn&amp;rsquo;t want a user to ever have to hunt for their focus. Keeping the focus indicator colors consistent and vivid helped us achieve this goal, and using a two-tone indicator allowed us to have a familiar look &amp;amp; feel everywhere.&lt;/p&gt;

&lt;p&gt;Reducing cognitive load is also important for usability: folks who &lt;em&gt;don&amp;rsquo;t&lt;/em&gt; use the keyboard for most of their interactions shouldn&amp;rsquo;t be distracted by a weird, bright ring that follows them around as they interact.&lt;/p&gt;

&lt;p&gt;The Accessibility Team&amp;rsquo;s designer, Ben Dansby, crafted a high-contrast two-toned focus ring that would appear only for users whose last interaction with the application indicated that they were keyboard users.&lt;/p&gt;

&lt;p&gt;Ben used red (&lt;code&gt;#e70d4f&lt;/code&gt;) and white (&lt;code&gt;#ffffff&lt;/code&gt;) for the two tones. These colors don&amp;rsquo;t strictly guarantee sufficient contrast for all possible inputs, but it&amp;rsquo;s straightfoward to check that our specific color palette will work well with these specific focus ring colors.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/205790591-ee429d97-c927-442a-87f4-25107f10cd41.png" alt="Line chart showing luminance on the x-axis and contrast with the two-toned focus ring on the y-axis. A line showing the contrast descends from (0, 21) to about (0.44, 2) and then ascends to (1, 4.6). The contrast between luminances of about 0.3 and about 0.6 are below 3."/&gt;
&lt;a href="https://ellie-app.com/kmQdwwgvC6Ra1"&gt;Ellie with &lt;code&gt;elm-charts&lt;/code&gt; code that produced the diagram&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Learn more about contrast requirements in the &lt;a href="https://webaim.org/articles/contrast/"&gt;WebAIM article &amp;ldquo;Contrast and Color Accessibility&amp;rdquo;&lt;/a&gt;.&lt;/p&gt;

&lt;h2&gt;Implementation&lt;/h2&gt;

&lt;p&gt;The two-toned focus ring Ben made used box-shadow to create a red and white outline with gently curved corners:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[ Css.borderRadius (Css.px 4)
, Css.property "box-shadow" &amp;lt;|
    "0 0 0px 3px "
        ++ toCssString Colors.white
        ++ ", 0 0 0 6px "
        ++ toCssString Colors.red
]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We want the focus ring to only show for keyboard users, so we use the &lt;a href="https://developer.mozilla.org/en-US/docs/Web/CSS/:focus-visible"&gt;&lt;code&gt;:focus-visible&lt;/code&gt; pseudoselector&lt;/a&gt; when attaching these styles.&lt;/p&gt;

&lt;p&gt;However, &lt;code&gt;:focus-visible&lt;/code&gt; will result in the focus ring showing for text areas and text inputs regardless of whether the user last used a key for navigation or the mouse for navigation.&lt;/p&gt;

&lt;p&gt;We wanted keyboard users&amp;rsquo; text input focus clearly indicated with the new candy-cane bright indicator alongside our usual subtle blue focus effect.&lt;/p&gt;

&lt;p&gt;Blurred text input:
&lt;img src="https://user-images.githubusercontent.com/8811312/205973225-165ccc27-d676-45b9-97ed-50b433976937.png" alt="Screenshot of text input that isn't focused. The input border is gray and there's a gray box-shadow effect suggesting depth."/&gt;&lt;/p&gt;

&lt;p&gt;Text input focused by a click:
&lt;img src="https://user-images.githubusercontent.com/8811312/205973222-f33c92f7-5c36-4d9e-9382-610f9ac93324.png" alt="Screenshot of text input with the cursor in it. The input border is blue and there's a blue box-shadow effect making the input more visually prominent."/&gt;&lt;/p&gt;

&lt;p&gt;Text input focused by a key event:
&lt;img src="https://user-images.githubusercontent.com/8811312/205973218-4febe92d-f965-4241-a042-dfbeb8637329.png" alt="Screenshot of text input with the cursor in it. The input border is blue and there's a blue box-shadow effect making the input more visually prominent, in addition to a bright red outline indicating focus."/&gt;&lt;/p&gt;

&lt;p&gt;This required a more involved approach, beyond just using &lt;code&gt;:focus-visible&lt;/code&gt; and changing the box-shadow.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;We needed to keep track of the last event type manually&lt;/li&gt;
&lt;li&gt;We needed to not overwrite the box-shadow for text input when showing the focus ring&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;To accomplish the first of these goals, we stored a custom type &lt;code&gt;type InputMethod = Keyboard | Mouse&lt;/code&gt; on the model and used &lt;code&gt;Browser.Events.onKeyDown&lt;/code&gt; and &lt;code&gt;Browser.Events.onMouseDown&lt;/code&gt; to set the &lt;code&gt;InputMethod&lt;/code&gt;. We used different styles based on the &lt;code&gt;InputMethod&lt;/code&gt;. Since we didn&amp;rsquo;t want, say, arrow events within a textarea to change the user&amp;rsquo;s &lt;code&gt;InputMethod&lt;/code&gt;, we also added some light logic based on the tagName of the event target.&lt;/p&gt;

&lt;p&gt;For the second of these goals, we needed to be able to customize focus ring styles for inputs that already had box-shadow styles. This work needed to happen one component at a time.&lt;/p&gt;

&lt;p&gt;For example, styles for the text input might be applied as follows:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;forKeyboardUsers : List Css.Global.Snippet
forKeyboardUsers =
    [ Css.Global.class "nri-input:focus-visible"
        [ [ "0 0 0 3px " ++ toCssString Colors.white
          , "0 0 0 6px " ++ toCssString Colors.red
          , "inset 0 3px 0 0 " ++ toCssString Colors.glacier
          ]
          |&amp;gt; String.join ","
          |&amp;gt; Css.property "box-shadow"
        , ...
        ]
    , ...
    ]


forMouseUsers : List Css.Global.Snippet
forMouseUsers =
    [ Css.Global.everything [ Css.outline Css.none ]
    , Css.Global.class "nri-input:focus-visible"
        [ Css.property "box-shadow" ("inset 0 3px 0 0 " ++ toCssString Colors.glacier)
        , ...
        ]
    , ...
    ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now we have nice focus styles for keyboard users, nice focus styles for mouse users, as well as nice blurred styles! Of course, these are just the styles for our text input. There are lots more components to consider!&lt;/p&gt;

&lt;p&gt;This is the kind of change where having a library of example uses of every shared component becomes super useful. Having one view to go to to check all the focus rings makes it straightforward &amp;ndash; although tedious &amp;ndash; to make sure that the focus ring will look great everywhere.&lt;/p&gt;

&lt;p&gt;For us, we discovered that we needed a &amp;ldquo;tight&amp;rdquo; focus ring as well, where the box shadow is more inset, for cases where the ring would otherwise overlap other important content.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/206325643-4879d3a8-1c5a-4352-a2b8-0e8ea8efe194.png" alt="Screenshot of a sentence containing an example link, which is focused. The focus ring does not extend outside the link and does not cover any content."/&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  [ Css.borderRadius (Css.px 4)
  , Css.property "box-shadow" &amp;lt;|
    "inset 0 0 0 2px "
        ++ toCssString Colors.white
        ++ ", 0 0 0 2px "
        ++ toCssString Colors.red
  ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We found also that some of our components already had border radiuses, and changing the border radious to 4px so that the focus ring would be nicely rounded was worse than keeping the initial border radius. This meant more per-component customization!&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/206326451-eb0c2d52-63c9-4d35-85da-487676e3eacc.png" alt='Screenshot of a "SegmentedControl" component showing the two-toned focus ring following the shape of the input: the focus ring has square edges on the left and rounded edges on the right.'/&gt;&lt;/p&gt;

&lt;h2&gt;Removing the outline&lt;/h2&gt;

&lt;p&gt;You may have noticed that so far, none of the code samples for keyboard styles have actually hidden the default browser outline focus indicator. This is an area where we initially made an error: we naively added &lt;code&gt;outline: none&lt;/code&gt;, thinking that our fancy new two-toned box-shadow-based focus ring would suffice.&lt;/p&gt;

&lt;p&gt;We were wrong!&lt;/p&gt;

&lt;p&gt;We forgot to consider and failed to test cases where users are in OS-based high contrast modes. High contrast modes essentially limit the colors that users are shown &amp;ndash; the mode is not &lt;em&gt;inherently&lt;/em&gt; high contrast, since the user can customize the palette that is used &amp;ndash; by removing extraneous styling and forcing styles to match the given palette.&lt;/p&gt;

&lt;p&gt;Guess what counts as extraneous? The box-shadow comprising our two-toned focus ring!&lt;/p&gt;

&lt;p&gt;And if you set &lt;code&gt;outline: none&lt;/code&gt;, the outline &lt;em&gt;will not show&lt;/em&gt; in high contrast mode either.&lt;/p&gt;

&lt;p&gt;Instead of setting &lt;code&gt;outline: none&lt;/code&gt;, we need to change the outline to be transparent for keyboard users: &lt;code&gt;Css.outline3 (Css.px 2) Css.solid Css.transparent&lt;/code&gt;. The transparent color will (perhaps surprisingly) be coerced to a real color in high contrast mode.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/206327081-a638b5dd-4fdb-4e2e-bb60-1b156186f21c.png" alt="Screenshot of an unfocused NoRedInk button in Windows high contrast mode. The page background and the button background are black. The border and the button text are white."/&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/206327084-de176f9b-19b2-4cb9-9cc0-dfd0391ac965.png" alt="Screenshot of a focused NoRedInk button in Windows high contrast mode. The page background and the button background are black. The button text are white. There's a thick cyan outline around the button."/&gt;&lt;/p&gt;

&lt;h2&gt;Summing it up&lt;/h2&gt;

&lt;p&gt;Customizing the look of a focus indicator can make it more useful for users, but it can take a surprising amount of work to get it &lt;em&gt;just&lt;/em&gt; right. This work will be easier if you have a centralized place to see every common focusable element from your application at once. The two-toned focus ring in particular is great if your application has content over many different colored backgrounds, but it will be harder to implement if you commonly use box-shadows to accentuate inputs. Don&amp;rsquo;t forget to consider and test high-contrast mode!&lt;/p&gt;

&lt;h2&gt;Relevant resources&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.w3.org/WAI/WCAG21/Understanding/focus-visible.html"&gt;WCAG 2.1 Understanding Success Criterion 2.4.7: Focus Visible&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.w3.org/WAI/WCAG21/Techniques/css/C40"&gt;WCAG 2.1 Technique C4: Creating a two-color focus indicator to ensure sufficient contrast with all components&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/199557776-d58d63dd-07d2-4cfb-9e37-7b2e9dca81b8.png" alt="Photo of the author"/&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Tessa Kelly&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="https://twitter.com/t_kelly9"&gt;@t_kelly9&lt;/a&gt;&lt;/p&gt;</description><link>https://blog.noredink.com/post/703458632758689792</link><guid>https://blog.noredink.com/post/703458632758689792</guid><pubDate>Mon, 12 Dec 2022 13:40:30 -0500</pubDate><category>engineering</category><category>elm</category><category>accessibility</category><category>colors</category></item><item><title>Presenting Styleguide Colors</title><description>&lt;p&gt;The &lt;a href="https://www.w3.org/WAI/standards-guidelines/wcag/"&gt;Web Content Accessibility Guidelines (WCAG)&lt;/a&gt; include guidelines around how to use colors that contrast against each other so that more people can distinguish them. Color is a fuzzy topic (brains, eyes, displays, and light conditions are all complicating factors!) so it&amp;rsquo;s a good idea to rely on industry-wide standards, like WCAG. The current version of the WCAG standards define algorithms for calculating luminance &amp;amp; contrast and set target minimum contrasts depending on the context in which the colors are used.&lt;/p&gt;

&lt;p&gt;These algorithms should be used for their primary purpose &amp;ndash; ensuring that content is accessible and conforms to WCAG &amp;ndash; but they can also be used for other purposes, like making colors in a styleguide presentable.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;Colors &amp;amp; Branding&lt;/h2&gt;

&lt;p&gt;NoRedInk is an education technology site, and the vast majority of our users are students. We use a lot of colors!&lt;/p&gt;

&lt;p&gt;To keep track of our colors, we have one file that defines all of our color values with names. We use the Elm programming language on the frontend with the Elm package &lt;code&gt;rtfeldman/elm-css&lt;/code&gt;, so our color file looks something like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;module Nri.Colors exposing (..)


import Css exposing (Color)

redLight : Color
redLight =
    Css.hex "#f98e8e"

redMedium : Color
redMedium =
    Css.hex "#ee2828"


...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(But we have around 70 named colors instead of two.)&lt;/p&gt;

&lt;p&gt;We also have a styleguide view that shows each color in an appropriately-colored tile along with the color&amp;rsquo;s name, hex value, and rgb value. These tiles help facilitate communication between Engineering and Design.&lt;/p&gt;

&lt;p&gt;But how to present information on the color tiles? How can we make sure that the name and metadata &lt;em&gt;about&lt;/em&gt; the color are readable &lt;em&gt;on top&lt;/em&gt; of an arbitrarily-colored tile?&lt;/p&gt;

&lt;p&gt;We can apply some of the color math that WCAG uses when considering contrast!&lt;/p&gt;

&lt;h2&gt;Luminance &amp;amp; Contrast&lt;/h2&gt;

&lt;p&gt;The calculation for &lt;a href="https://www.w3.org/TR/WCAG21/#dfn-relative-luminance"&gt;&amp;ldquo;relative luminance&amp;rdquo;&lt;/a&gt; takes a color defined in terms of sRGB and figures out a rough approximation of perceptual brightness. &amp;ldquo;Relative luminance&amp;rdquo; is inherently conceptually squishy, but it is a reasonable representation of how prominent a given color is to the human eye.&lt;/p&gt;

&lt;p&gt;The relative luminance of pure black is 0 and the relative luminance of pure white is 1.&lt;/p&gt;

&lt;p&gt;Once you have the relative luminance of two colors, you&amp;rsquo;re ready to figure out the &lt;a href="https://www.w3.org/TR/WCAG21/#dfn-contrast-ratio"&gt;contrast ratio&lt;/a&gt; between them.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;(L1 + 0.05) / (L2 + 0.05)&lt;/p&gt;
  
  &lt;ul&gt;
  &lt;li&gt;&lt;p&gt;L1 is the relative luminance of the lighter of the colors, and&lt;/p&gt;&lt;/li&gt;
  &lt;li&gt;&lt;p&gt;L2 is the relative luminance of the darker of the colors.&lt;/p&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;For black and white:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(whiteLuminance + 0.05) / (blackLuminance + 0.05)
(1 + 0.05) / (0 + 0.05)
21  Css.Color -&amp;gt; Html msg
viewColor name color =
    dl
        [ css
            [ -- Dimensions
              Css.flexBasis (Css.px 200)
            , Css.margin Css.zero
            , Css.padding (Css.px 20)
            , Css.borderRadius (Css.px 20)

            -- Internals
            , Css.displayFlex
            , Css.justifyContent Css.center

            -- Colors
            , Css.backgroundColor color
            , Css.color (Css.hex "#00")
            ]
        ]
        [ div []
            [ dt [] [ text "Name" ]
            , dd [] [ text name ]
            , dt [] [ text "RGB" ]
            , dd [] [ text color.value ]
            ]
        ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/k7CqGhvqKtWa1"&gt;Ellie example 1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/201212579-e8d33e34-8ce6-418d-9da9-a5aa95f7c995.png" alt='Screenshot of a website with the heading "Colors" and a grid of colored rectangles with the name of the color and its RGB value sometimes totally illegibly printed on it in black'/&gt;&lt;/p&gt;

&lt;p&gt;The content that is supposed to be showing on each tile is often totally illegible!&lt;/p&gt;

&lt;p&gt;We know, though, which colors have the minimum and maximum luminance (black and white respectively), which means we know how to figure out whether to use black or white text on &lt;em&gt;any&lt;/em&gt; arbitrary color tile.&lt;/p&gt;

&lt;p&gt;At NoRedInk, we use the &lt;code&gt;highContrast&lt;/code&gt; function from the color library &lt;code&gt;tesk9/palette&lt;/code&gt;. &lt;code&gt;tesk9/palette&lt;/code&gt; and &lt;code&gt;rtfeldman/elm-css&lt;/code&gt; model colors differently, so we do need to do conversions back and forth, but the advantage is that we get nice-looking, readable color tiles without resorting to box-shadow effects or background color tricks. Depending on what rendering libraries you&amp;rsquo;re using, you may or may not need to do conversions.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;viewColor : String -&amp;gt; Css.Color -&amp;gt; Html msg
viewColor name color =
    let
        highContrastColor =
            toCssColor (SolidColor.highContrast (fromCssColor color))
    in
    dl
        [ css
            [ -- Dimensions
              Css.flexBasis (Css.px 200)
            , Css.margin Css.zero
            , Css.padding (Css.px 20)
            , Css.borderRadius (Css.px 20)

            -- Internals
            , Css.displayFlex
            , Css.justifyContent Css.center

            -- Colors
            , Css.backgroundColor color
            , Css.color highContrastColor
            ]
        ]
        [ div []
            [ dt [] [ text "Name" ]
            , dd [] [ text name ]
            , dt [] [ text "RGB" ]
            , dd [] [ text color.value ]
            ]
        ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/k7CzQHKPjhwa1"&gt;Ellie example 2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now the content is legible on each tile!&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/201212575-66fa811d-0ba5-454d-aab8-ab9f167c8a8b.png" alt='Screenshot of a website with the heading "Colors" and a grid of colored rectangles with the name of the color and its RGB value legibly printed on it in white or in black'/&gt;&lt;/p&gt;

&lt;h2&gt;Legible according to which WCAG level?&lt;/h2&gt;

&lt;p&gt;I mentioned previously that context (including the target WCAG conformance level) influences the minimum level of contrast required. The highest WCAG level, AAA, requires 7:1 contrast for normal text sizes, which means if our high-contrast color generation always picks a color with at least a contrast of 7, we won&amp;rsquo;t need to worry about the contextual details.&lt;/p&gt;

&lt;p&gt;However, for colors with a luminance between 0.1 and 0.3, neither black nor white will be high-enough contrast for WCAG AAA. Either (not both!) black or white will be sufficient for WCAG AA, as the contrast is higher than 4.5.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/203121694-88faa169-5ef7-4ba3-87e8-42de5ed0c73b.png" alt="Line chart showing luminance on the x-axis and contrast on the y-axis and a line showing the highest possible contrast going from (0, 21) to about (0.175, 4.5) and then going directly back up to (1, 21). Between 0.1 and 0.2 on the x-axis, the contrast is below 7."/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/kdrvrTP9yzQa1"&gt;Ellie with elm-charts code that produced the diagram&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;What sorts of colors might have a luminance between 0.1 and 0.3?&lt;/p&gt;

&lt;p&gt;Relative luminance is defined as:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;L = 0.2126 * R + 0.7152 * G + 0.0722 * B where R, G and B are defined as:&lt;/p&gt;
  
  &lt;ul&gt;
  &lt;li&gt;&lt;p&gt;if RsRGB  - if GsRGB  - if BsRGB 
  and RsRGB, GsRGB, and BsRGB are defined as:&lt;/p&gt;&lt;/li&gt;
  &lt;li&gt;&lt;p&gt;RsRGB = R8bit/255&lt;/p&gt;&lt;/li&gt;
  &lt;li&gt;&lt;p&gt;GsRGB = G8bit/255&lt;/p&gt;&lt;/li&gt;
  &lt;li&gt;&lt;p&gt;BsRGB = B8bit/255&lt;/p&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a href="https://www.w3.org/TR/WCAG21/#dfn-relative-luminance"&gt;Relative luminance definition&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I don&amp;rsquo;t want to dig into the details of relative luminance too much, but it&amp;rsquo;s worth paying attention to the different weights for red, green, and blue in the equation. Since the weight for red is 0.2126, pure red falls right in the zone where it cannot be used for WCAG AAA-conformant normal text.&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
  &lt;th&gt;Name&lt;/th&gt;
  &lt;th&gt;RGB color&lt;/th&gt;
  &lt;th&gt;Luminance&lt;/th&gt;
  &lt;th&gt;White contrast&lt;/th&gt;
  &lt;th&gt;Black contrast&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
  &lt;td&gt;Red&lt;/td&gt;
  &lt;td&gt;(255, 0, 0)&lt;/td&gt;
  &lt;td&gt;0.2126&lt;/td&gt;
  &lt;td&gt;3.99&lt;/td&gt;
  &lt;td&gt;5.25&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
  &lt;td&gt;Green&lt;/td&gt;
  &lt;td&gt;(0, 255, 0)&lt;/td&gt;
  &lt;td&gt;0.7152&lt;/td&gt;
  &lt;td&gt;1.37&lt;/td&gt;
  &lt;td&gt;15.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
  &lt;td&gt;Blue&lt;/td&gt;
  &lt;td&gt;(0, 0, 255)&lt;/td&gt;
  &lt;td&gt;0.0722&lt;/td&gt;
  &lt;td&gt;8.59&lt;/td&gt;
  &lt;td&gt;2.44&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h2&gt;Going Further&lt;/h2&gt;

&lt;p&gt;There is lots more we could do with these color tiles. We could print the color value in other color spaces (if using &lt;code&gt;tesk9/palette&lt;/code&gt;, this is easy to do with &lt;code&gt;SolidColor.toHex&lt;/code&gt; and &lt;code&gt;SolidColor.toHSLString&lt;/code&gt;). We could add a grayscale toggle (see &lt;code&gt;SolidColor.grayscale&lt;/code&gt;) to help folks consider if they&amp;rsquo;re using only color to indicate meaning (see &lt;a href="https://www.w3.org/WAI/WCAG21/Understanding/use-of-color.html"&gt;&amp;ldquo;Understanding Success Criterion 1.4.1: Use of Color&amp;rdquo;&lt;/a&gt;). We could organize colors by purpose, by hue, by luminance, or by some combination thereof. We could add a chart showing all our colors &amp;amp; their contrast with all of our other colors, so it&amp;rsquo;s easy for designers to check which colors they can use in combination with other colors. We could also consider the user experience we want when users have adjusted operating system-level color settings, like the popular Windows high contrast mode (learn more about Windows high contrast mode specifically in &lt;a href="https://www.smashingmagazine.com/2022/06/guide-windows-high-contrast-mode/"&gt;&amp;ldquo;The Guide To Windows High Contrast Mode&amp;rdquo; by Cristian DÃ­az in Smashing Magazine&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Contrast &amp;amp; luminance values are key building blocks in presenting colors in a styleguide, and, luckily, they are fun values to explore as well.&lt;/p&gt;

&lt;h3&gt;Future WCAG versions&lt;/h3&gt;

&lt;p&gt;Now that I&amp;rsquo;ve got you excited about WCAG 2.1&amp;rsquo;s contrast calculation, I should also warn you that the &lt;a href="https://www.w3.org/TR/wcag-3.0/#visual-contrast-of-text"&gt;3.0 version of the color guidelines&lt;/a&gt; will almost certainly change dramatically. Until WCAG 3.0 is much further along, you likely do not need to understand the changes. The new version promises to be interesting!&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;d like to play with the WCAG 3.0 Advanced Perception of Color Algorithm (APCA), the website &lt;a href="https://contrast.tools/"&gt;Contrast tools&lt;/a&gt; is a nice place to start.&lt;/p&gt;

&lt;h3&gt;Future CSS properties&lt;/h3&gt;

&lt;p&gt;Someday, it will be possible to select high-enough contrast colors for a given context directly in CSS with &lt;a href="https://developer.mozilla.org/en-US/docs/Web/CSS/color_value/color-contrast"&gt;&lt;code&gt;color-contrast()&lt;/code&gt;&lt;/a&gt;. Watch &lt;a href="https://www.youtube.com/watch?v=Xy9ZXRRgpLk&amp;amp;t=590s"&gt;this snippet from Adam Argyle&amp;rsquo;s 2022 State of CSS presentation&lt;/a&gt; to learn more. Be sure to &lt;a href="https://caniuse.com/?search=color-contrast"&gt;check support for color-contrast&lt;/a&gt; before using it anywhere user-facing, though.&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/199557776-d58d63dd-07d2-4cfb-9e37-7b2e9dca81b8.png" alt="Photo of the author"/&gt;
&lt;strong&gt;Tessa Kelly&lt;/strong&gt;
&lt;a href="https://twitter.com/t_kelly9"&gt;@t_kelly9&lt;/a&gt;&lt;/p&gt;</description><link>https://blog.noredink.com/post/701651083488018432</link><guid>https://blog.noredink.com/post/701651083488018432</guid><pubDate>Tue, 22 Nov 2022 14:50:17 -0500</pubDate><category>engineering</category><category>elm</category><category>accessibility</category><category>colors</category></item><item><title>SVGs as Elm Code</title><description>&lt;p&gt;Moving SVGs out of the file system and into regular Elm code can make icons easier to manage, especially if you find you need to make accessibility improvements.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;p&gt;Imagine we have an arbitrary SVG file straight from our Design teamâ€™s tools:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;?xml version="1.0" encoding="utf-8"?&amp;gt;&amp;lt;svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 21 21" style="enable-background:new 0 0 21 21;" xml:space="preserve"&amp;gt;&amp;lt;style type="text/css"&amp;gt;
        .st0{fill:#FFFFFF;stroke:#146AFF;stroke-width:2;}
&amp;lt;/style&amp;gt;&amp;lt;title&amp;gt;star-outline&amp;lt;/title&amp;gt;&amp;lt;desc&amp;gt;Created with Something Proprietary 123.&amp;lt;/desc&amp;gt;&amp;lt;g id="Page-1"&amp;gt;&amp;lt;g id="star-outline"&amp;gt;&amp;lt;path id="path-1_1_" class="st0" d="M11.1,1.4l2.4,4.8c0.1,0.2,0.3,0.4,0.6,0.4l5.2,0.8c0.4,0.1,0.7,0.4,0.6,0.8
                        c0,0.2-0.1,0.3-0.2,0.4l-3.8,3.8c-0.2,0.2-0.2,0.4-0.2,0.6l0.9,5.3c0.1,0.4-0.2,0.8-0.6,0.8c-0.2,0-0.3,0-0.5-0.1l-4.7-2.5
                        c-0.2-0.1-0.5-0.1-0.7,0l-4.7,2.5c-0.4,0.2-0.8,0.1-1-0.3c-0.1-0.1-0.1-0.3-0.1-0.5l0.9-5.3c0-0.2,0-0.5-0.2-0.6L1.2,8.7
                        c-0.3-0.3-0.3-0.8,0-1c0.1-0.1,0.3-0.2,0.4-0.2l5.2-0.8c0.2,0,0.4-0.2,0.6-0.4l2.4-4.8c0.2-0.4,0.6-0.5,1-0.3
                        C10.9,1.1,11,1.3,11.1,1.4z"&amp;gt;&amp;lt;/path&amp;gt;&amp;lt;/g&amp;gt;&amp;lt;/g&amp;gt;&amp;lt;/svg&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Notice that thereâ€™s lots of extraneous information in the SVG â€” including some information thatâ€™s distinctly unhelpful! The &lt;code&gt;title&lt;/code&gt; of the SVG ends up being used as the accessible name of the SVG â€” itâ€™s more or less equivalent to an &lt;code&gt;img&lt;/code&gt; tagâ€™s &lt;code&gt;alt&lt;/code&gt;. A title of â€œstar-outlineâ€ will not help our users to understand what this icon is supposed to represent.&lt;/p&gt;

&lt;p&gt;Compare the raw SVG value to what it might look like if rewritten as Elm code and tidied-up by a human developer:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;import Svg exposing (..)
import Svg.Attributes exposing (..)


starOutline : Svg msg
starOutline =
    svg
        [ x "0px"
        , y "0px"
        , viewBox "0 0 21 21"
        ]
        [ Svg.path
                [ fill "#FFF"
                , stroke "#146AFF"
                , strokeWidth "2"
                , d "M11.1,1.4l2.4,4.8c0.1,0.2,0.3,0.4,0.6,0.4l5.2,0.8c0.4,0.1,0.7,0.4,0.6,0.8 c0,0.2-0.1,0.3-0.2,0.4l-3.8,3.8c-0.2,0.2-0.2,0.4-0.2,0.6l0.9,5.3c0.1,0.4-0.2,0.8-0.6,0.8c-0.2,0-0.3,0-0.5-0.1l-4.7-2.5  c-0.2-0.1-0.5-0.1-0.7,0l-4.7,2.5c-0.4,0.2-0.8,0.1-1-0.3c-0.1-0.1-0.1-0.3-0.1-0.5l0.9-5.3c0-0.2,0-0.5-0.2-0.6L1.2,8.7 c-0.3-0.3-0.3-0.8,0-1c0.1-0.1,0.3-0.2,0.4-0.2l5.2-0.8c0.2,0,0.4-0.2,0.6-0.4l2.4-4.8c0.2-0.4,0.6-0.5,1-0.3 C10.9,1.1,11,1.3,11.1,1.4z"
                ]
                []
        ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/k3Y9DBWSv8ta1"&gt;Example 1 Ellie link&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Once the SVG is rewritten in Elm, we can leverage the Elm type system to guarantee that icons in our application are always rendered in a consistent way. By exposing the Icon type but &lt;em&gt;not&lt;/em&gt; exposing the Icon constructor, we can ensure that there&amp;rsquo;s only one way to produce HTML from an Icon. This strategy is the opaque type pattern, which you can learn more about in &lt;a href="https://ckoster22.medium.com/advanced-types-in-elm-opaque-types-ec5ec3b84ed2"&gt;former NoRedInk engineer Charlie Koster&amp;rsquo;s blog post series on advanced types in Elm&lt;/a&gt; and in &lt;a href="https://elm-radio.com/episode/intro-to-opaque-types/"&gt;the Elm Radio podcast&amp;rsquo;s Intro to Opaque Types episode&lt;/a&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;module Icons exposing (Icon, toHtml, starOutline)

type Icon =
  -- `Never` is used here so that our Icon type doesn't need a type hole. Essentially, the `Never` is saying "this kind of Svg cannot produce messages ever"
  Icon (Svg Never)


toHtml : Icon -&amp;gt; Html msg
toHtml (Icon icon) =
    -- "Html.map never" transforms `Svg msg` into `Svg Never`
    Html.map never icon


starOutline : Icon -- notice the type changed
starOutline =
    svg
        ...
        |&amp;gt; Icon
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that we&amp;rsquo;ve got consistently-rendered icons, we can start thinking about what an &lt;em&gt;accessible&lt;/em&gt; way to render the SVGs might be. &lt;a href="https://cariefisher.com/a11y-svg-updated/"&gt;Carie Fisherâ€™s article Accessible SVGs - Perfect Patterns For Screen Reader Users&lt;/a&gt; is &lt;em&gt;the&lt;/em&gt; resource to use when considering how to render SVGs in an accessible way. We will be using Pattern 5, &lt;code&gt;&amp;lt;svg&amp;gt;&lt;/code&gt; + &lt;code&gt;role="img"&lt;/code&gt; + &lt;code&gt;&amp;lt;title&amp;gt;&lt;/code&gt;, to ensure that our meaningful icons have appropriate text alternatives. (You might also want to read through the &lt;a href="https://www.w3.org/WAI/tutorials/images/"&gt;WAIâ€™s Images Tutorial&lt;/a&gt; if you haven&amp;rsquo;t already â€” it might surprise you!)&lt;/p&gt;

&lt;p&gt;We need to conditionally insert a &lt;code&gt;title&lt;/code&gt; element into the list of SVG children â€” which means we need to change how weâ€™re modeling &lt;code&gt;Icon&lt;/code&gt;. We can easily &amp;amp; safely do this, though, because weâ€™ve used an opaque type to minimize API disturbances.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;type Icon
    = Icon
        { attributes : List (Attribute Never)
        , label : Maybe String
        , children : List (Svg Never)
        }


toHtml : Icon -&amp;gt; Html msg
toHtml (Icon icon) =
    case icon.label of
        Just label -&amp;gt;
            svg icon.attributes (Svg.title [] [ text label ] :: icon.children)
                |&amp;gt; Html.map never

        Nothing -&amp;gt;
            svg icon.attributes icon.children
                |&amp;gt; Html.map never


emptyStar : Icon
emptyStar =
    Icon
        { attributes =
            [ x "0px"
            , y "0px"
            , viewBox "0 0 21 21"
            ]
        , label = Nothing
        , children =
            [ Svg.path
                [ fill "#FFF"
                , stroke "#146AFF"
                , strokeWidth "2"
                , d "M11.1,1.4l2.4,4.8c0.1,0.2,0.3,0.4,0.6,0.4l5.2,0.8c0.4,0.1,0.7,0.4,0.6,0.8 c0,0.2-0.1,0.3-0.2,0.4l-3.8,3.8c-0.2,0.2-0.2,0.4-0.2,0.6l0.9,5.3c0.1,0.4-0.2,0.8-0.6,0.8c-0.2,0-0.3,0-0.5-0.1l-4.7-2.5  c-0.2-0.1-0.5-0.1-0.7,0l-4.7,2.5c-0.4,0.2-0.8,0.1-1-0.3c-0.1-0.1-0.1-0.3-0.1-0.5l0.9-5.3c0-0.2,0-0.5-0.2-0.6L1.2,8.7 c-0.3-0.3-0.3-0.8,0-1c0.1-0.1,0.3-0.2,0.4-0.2l5.2-0.8c0.2,0,0.4-0.2,0.6-0.4l2.4-4.8c0.2-0.4,0.6-0.5,1-0.3 C10.9,1.1,11,1.3,11.1,1.4z"
                ]
                []
            ]
        }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/k3Yb3CRHz8Ta1"&gt;Example 2 Ellie Link&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;At this point, the internals of Icon can handle a text alternative being present, but thereâ€™s no way from the API to actually set the text alternative . We need to expose a way to set the value of the label of &lt;code&gt;emptyStar&lt;/code&gt; and any other icons we later create.&lt;/p&gt;

&lt;p&gt;We could change &lt;code&gt;emptyStar&lt;/code&gt; to take a &lt;code&gt;Maybe String&lt;/code&gt;, or we could add a &lt;code&gt;withLabel : String â†’ Icon â†’ Icon&lt;/code&gt; helper, or we could move the &lt;code&gt;label&lt;/code&gt; value off of the &lt;code&gt;Icon&lt;/code&gt; type and thread the value through &lt;code&gt;toHtml&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;At NoRedInk, we use the &lt;code&gt;withLabel : String â†’ Icon â†’ Icon&lt;/code&gt; pattern, but any of these patterns could work.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;withLabel : String -&amp;gt; Icon -&amp;gt; Icon
withLabel label (Icon icon) =
    Icon { icon | label = Just label }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have a way to add the text alternative to the Icon, weâ€™re ready for the â€œroleâ€ portion of the  &lt;code&gt;&amp;lt;svg&amp;gt;&lt;/code&gt; + &lt;code&gt;role="img"&lt;/code&gt; + &lt;code&gt;&amp;lt;title&amp;gt;&lt;/code&gt; pattern.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;import Accessibility.Role as Role -- this is from tesk9/accessible-html

toHtml : Icon -&amp;gt; Html msg
toHtml (Icon icon) =
    case icon.label of
        Just label -&amp;gt;
            svg (Role.img :: icon.attributes)
                (Svg.title [] [ text label ] :: icon.children)
                |&amp;gt; Html.map never

        Nothing -&amp;gt;
            svg icon.attributes icon.children
                |&amp;gt; Html.map never
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/k3Ybkn2S6Nna1"&gt;Example 3 Ellie Link&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now, our functional icons should render nicely with a &lt;code&gt;title&lt;/code&gt; and with the appropriate role! (Although if we were supporting Internet Explorer, we would also want to add &lt;code&gt;focusable=false&lt;/code&gt;)&lt;/p&gt;

&lt;p&gt;We still have the decorative icons to consider, though. We can mark these decorative icons as hidden in the accessibility tree so that assistive technologies know to ignore it with &lt;code&gt;aria-hidden=true&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;toHtml : Icon -&amp;gt; Html msg
toHtml (Icon icon) =
    case icon.label of
        Just label -&amp;gt;
            svg (Role.img :: icon.attributes)
                (Svg.title [] [ text label ] :: icon.children)
                |&amp;gt; Html.map never

        Nothing -&amp;gt;
            svg (Aria.hidden True :: icon.attributes)
                icon.children
                |&amp;gt; Html.map never
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href="https://ellie-app.com/k3YbBhvwT4Ha1"&gt;Example 4 Ellie Link&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And thatâ€™s it!&lt;/p&gt;

&lt;p&gt;Over time, itâ€™s likely that an Elm-based SVG icon library will need to support more and more customization: colors, styles, attributes, animations, hover effects. All of these and more can be added to the Icon opaque type, without breaking current icons.&lt;/p&gt;

&lt;p&gt;There we have it: tidy icon modeling leading to tidy icons.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://user-images.githubusercontent.com/8811312/199557776-d58d63dd-07d2-4cfb-9e37-7b2e9dca81b8.png" alt="Photo of the author"/&gt;&lt;br/&gt;
&lt;strong&gt;Tessa Kelly&lt;/strong&gt;&lt;br/&gt;
&lt;a href="https://twitter.com/t_kelly9"&gt;@t_kelly9&lt;/a&gt; &lt;/p&gt;</description><link>https://blog.noredink.com/post/699829728548372480</link><guid>https://blog.noredink.com/post/699829728548372480</guid><pubDate>Wed, 02 Nov 2022 13:20:37 -0400</pubDate><category>engineering</category><category>elm</category><category>accessibility</category></item><item><title>Funding the Roc Programming Language</title><description>&lt;p&gt;At &lt;a href="https://www.noredink.com/"&gt;NoRedInk&lt;/a&gt;, we&amp;rsquo;re no strangers to cutting-edge technology or to funding open-source software. When React was released in the summer of 2013, &lt;a href="https://github.com/facebook/react/pull/892"&gt;we were early adopters&lt;/a&gt;. Shortly after that, we got into &lt;a href="https://elm-lang.org/"&gt;Elm&lt;/a&gt;â€”&lt;a href="https://youtu.be/gRFjOo-ZgK8"&gt;&lt;em&gt;really&lt;/em&gt; into it&lt;/a&gt;â€”and we began not only &lt;a href="https://2016.elm-conf.us/sponsor/"&gt;sponsoring Elm conferences&lt;/a&gt;, but also funding Elm&amp;rsquo;s development for several years by directly paying its creator, &lt;a href="https://github.com/evancz"&gt;Evan Czaplicki&lt;/a&gt;, to &lt;a href="https://elm-lang.org/news/new-adventures-for-elm"&gt;develop the language full-time&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;m beyond thrilled to announce that NoRedInk is now making a similar investment in the &lt;a href="https://www.roc-lang.org/"&gt;Roc programming language&lt;/a&gt;. Beginning in April, my job at NoRedInk will become developing Roc full-time!&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;p&gt;I created Roc in 2018 because I wanted an Elm-like language for use cases that are out of scope for Elm. &lt;a href="https://youtu.be/vzfy4EKwG_Y"&gt;Roc compiles to machine code&lt;/a&gt; instead of to JavaScript, and at NoRedInk we&amp;rsquo;re interested in using it on the server to go with our Elm frontendâ€”as well as for some command-line tooling. Although Roc isn&amp;rsquo;t ready for production use yet, funding its development like this will certainly get it to that point sooner.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s impossible to overstate how excited I am about this opportunity. When I laid out &lt;a href="https://www.youtube.com/watch?v=ZnYa99QoznE&amp;amp;t=4790s"&gt;a vision for Roc&lt;/a&gt; in a 2020 online meetup, I assumed I&amp;rsquo;d be developing it outside of work with a couple of other volunteers for the foreseeable future. I was stunned by the reaction to the video; many people started getting involved in developing the compilerâ€”most of whom had never worked on a compiler before!â€”and one brave soul even &lt;a href="https://github.com/pithub/aoc2020"&gt;did Advent of Code in Roc&lt;/a&gt; that year.&lt;/p&gt;

&lt;figure class="tmblr-full" data-orig-height="1132" data-orig-width="2350" data-orig-src="https://imgur.com/9eIlDLS.png"&gt;&lt;img width="921" alt="Graph of Roc repository commits, Jul 21, 2019 â€“ Feb 14, 2022. folkertdev has 3,478 commits; rtfeldman has 2,805 commits" src="https://64.media.tumblr.com/d190df4d2810ea36307c2f8b3d371be2/c48314e0507b6551-3e/s540x810/b8ae838c6b5b020cf0da6b5f09d430068aa4cd09.png" data-orig-height="1132" data-orig-width="2350" data-orig-src="https://imgur.com/9eIlDLS.png"/&gt;&lt;/figure&gt;

&lt;p&gt;Today Roc has 12,660 commits. The top 5 committers all have either hundreds or thousands of commits, and even though I had a considerable head start, I no longer have the most commits in the repo - the excellent &lt;a href="https://github.com/folkertdev"&gt;Folkert de Vries&lt;/a&gt; does. I&amp;rsquo;m massively grateful to every contributor for making this project exist, and although commits are easy to count, Roc&amp;rsquo;s design and community would not be what they are without so many wonderful contributions outside the code baseâ€”in video chats, on GitHub issues, and of course on &lt;a href="https://roc.zulipchat.com/"&gt;Roc chat&lt;/a&gt;. Thank you, all of you, for making Roc the language it is today.&lt;/p&gt;

&lt;p&gt;The language still has a ways to go before it&amp;rsquo;s ready for production use, but this investment from NoRedInk is both a game-changer for the project&amp;rsquo;s development as well as a strong vote of confidence in Roc&amp;rsquo;s future. Most companies benefit from the open-source ecosystem and give little to nothing back; I feel great about working for a company that builds &lt;a href="https://www.noredink.com/about/product"&gt;a product that helps English teachers&lt;/a&gt; while making serious investments in open-source software.&lt;/p&gt;

&lt;p&gt;By the way, &lt;a href="https://www.noredink.com/jobs"&gt;we&amp;rsquo;re hiring!&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;re interested in learning more about Roc, trying it out, or getting involved in its development, &lt;a href="https://www.roc-lang.org/"&gt;roc-lang.org&lt;/a&gt; has all the details. I&amp;rsquo;m so excited for the future, and can&amp;rsquo;t wait for this language to reach its full potential!&lt;/p&gt;

&lt;p&gt;&lt;img src="https://64.media.tumblr.com/055e1cd45b4f1508ede87bfd03a7ee3a/tumblr_inline_nhxl61eNo41t8do7n.png" alt=""/&gt;&lt;br/&gt;
&lt;strong&gt;Richard Feldman&lt;/strong&gt;&lt;br/&gt;
&lt;a href="https://twitter.com/rtfeldman"&gt;@rtfeldman&lt;/a&gt;&lt;/p&gt;</description><link>https://blog.noredink.com/post/676230051771138048</link><guid>https://blog.noredink.com/post/676230051771138048</guid><pubDate>Tue, 15 Feb 2022 00:33:52 -0500</pubDate></item><item><title>Tuning Haskell RTS for Kubernetes, Part 2</title><description>&lt;p&gt;We kept on tweaking our Haskell RTS after we reached &amp;ldquo;stable enough&amp;rdquo; in &lt;a href="https://blog.noredink.com/post/666020751977168896/tuning-haskell-rts-for-kubernetes-part-1"&gt;part 1 of this series&lt;/a&gt;, trying to address two main things:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Handle bursts of high concurrency more efficiently&lt;/li&gt;
&lt;li&gt;Avoid throttling due to CFS quotas in Kubernetes

&lt;ul&gt;
&lt;li&gt;&lt;em&gt;If you&amp;rsquo;re unfamiliar with it, &lt;a href="https://medium.com/omio-engineering/cpu-limits-and-aggressive-throttling-in-kubernetes-c5b20bd8a718"&gt;here&amp;rsquo;s a comprehensive article from Omio&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;We also learned some interesting properties of the parallel garbage collector in the process.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;TL;DR&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Profile your app in production&lt;/li&gt;
&lt;li&gt;Threadscope is your friend&lt;/li&gt;
&lt;li&gt;Disabling the parallel garbage collector is probably a good idea&lt;/li&gt;
&lt;li&gt;Increasing &lt;code&gt;-A&lt;/code&gt; is probably a good idea&lt;/li&gt;
&lt;/ul&gt;

&lt;h2&gt;&lt;code&gt;-NâŸ¨xâŸ© == available_cores&lt;/code&gt; is bad&lt;/h2&gt;

&lt;p&gt;We ran into this problem in the previous post of our series, where we tried to set:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-N3&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/#static-policy"&gt;&lt;code&gt;--cpu-manager-policy=static&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;requests.cpu: 3&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;requests.limits: 3&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We tried this configuration because we were hoping to disable Kubernetes CFS quotas and only rely on CPU affinity to prevent noisy neighbours and worker nodes overload.&lt;/p&gt;

&lt;p&gt;Trying this out I saw p99 response times rise from 16ms to 29ms, enough to affect stability of our upstream services.&lt;/p&gt;

&lt;p&gt;Confused, &lt;a href="https://discourse.haskell.org/t/optimal-n-for-core-count/2942"&gt;I reached out for help on the Haskell Discourse&lt;/a&gt;.&lt;/p&gt;

&lt;h2&gt;Threadscope&lt;/h2&gt;

&lt;p&gt;Folks on Discourse were quick to help me drill down into GC as a possible cause for slowness, but I had no idea how to go about tuning it, if not at random.&lt;/p&gt;

&lt;p&gt;The first helpful advice I got was to use &lt;a href="https://wiki.haskell.org/ThreadScope"&gt;Threadscope&lt;/a&gt;, a graphical viewer for thread profile information generated by GHC.&lt;/p&gt;

&lt;h3&gt;Capturing event logs for ThreadScope&lt;/h3&gt;

&lt;p&gt;The first thing I had to do to be able to use ThreadScope was to build a version of our app with the &lt;a href="https://downloads.haskell.org/~ghc/8.10.7/docs/html/users_guide/phases.html#ghc-flag--eventlog"&gt;&lt;code&gt;-eventlog&lt;/code&gt;&lt;/a&gt; flag in our &lt;code&gt;package.yaml&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class="diff"&gt; executables:
   quiz-engine-http:
     dependencies:
       ...
     ghc-options:
       - -threaded
+      - -eventlog
     main: Main.hs
     ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This makes it so our app ships with the necessary instrumentation, which we can turn on and off at launch.&lt;/p&gt;

&lt;p&gt;Then I had to enable event logging by launching our app with &lt;a href="https://downloads.haskell.org/~ghc/8.10.7/docs/html/users_guide/runtime_control.html#rts-flag--l%20%E2%9F%A8flags%E2%9F%A9"&gt;the &lt;code&gt;-l&lt;/code&gt; RTS flag&lt;/a&gt;, like so:&lt;/p&gt;

&lt;pre&gt;&lt;code class="sh"&gt;$ quiz-engine-http +RTS -N3 -M5.8g -l -RTS
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This makes it so Haskell logs events to a file while it&amp;rsquo;s running. I decided to make a single Pod use these settings alongside the rest of our fleet, taking production traffic.&lt;/p&gt;

&lt;p&gt;Last, I had to grab the event log, which gets dumped to a file like &lt;code&gt;your-executable-name.eventlog&lt;/code&gt;. That could be done with &lt;code&gt;kubectl cp&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The log grew around 1.2MB/s, and Threadscope takes a while to load large event logs, so I went for short recording sessions of around 3min.&lt;/p&gt;

&lt;h3&gt;Launching ThreadScope&lt;/h3&gt;

&lt;p&gt;With the event log in hand, I could finally launch ThreadScope:&lt;/p&gt;

&lt;pre&gt;&lt;code class="sh"&gt;$ threadscope quiz-engine-http.eventlog
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ThreadScope showed me a chart of app execution vs GC execution and a bunch of metrics.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://i.imgur.com/iKIjW8e.png" alt="ThreadScope screenshot showing 3 horizontal bars, depicting a heatmap of sorts with CPU time spent on app code in green and GC time in orange"/&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src="https://imgur.com/noxS4FH.png" alt="Another threadscope tab, showing a table with statistics on collections in total and per garbage collector generation. I'll summarize the relevant numbers in the next section"/&gt;&lt;/p&gt;

&lt;h3&gt;Interesting metrics&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;Productivity&lt;/strong&gt; was the first interesting metric I saw. It tells you what % of time your actual application code is running, the remainder of which is taken over by GC.&lt;/p&gt;

&lt;p&gt;In our case, we had 88.2% productivity, so 11.8% of the time our app was doing nothing, waiting for the garbage collector to run.&lt;/p&gt;

&lt;p&gt;Our &lt;strong&gt;average GC pause&lt;/strong&gt; was 20Î¼s long, or 0.0002s. Really fast.&lt;/p&gt;

&lt;p&gt;GHC made 103,060 &lt;strong&gt;Gen 0 collections&lt;/strong&gt; in the 210s period, which is a bit ridiculous. This means we did 490 pauses per second, or one pause every 2ms. Our app&amp;rsquo;s average response time is 1.8ms, so with 3 capabilities, we were running GC on average once every 6 requests.&lt;/p&gt;

&lt;p&gt;In comparison, we made 243 &lt;strong&gt;Gen 1 collections&lt;/strong&gt;, so a little over 1s. Gen 1 was OK.&lt;/p&gt;

&lt;h2&gt;Is the parallel GC helping me?&lt;/h2&gt;

&lt;p&gt;Another quick suggestion I got on Discourse was disabling the parallel garbage collector, so I went on to test that, with Threadscope by my side.&lt;/p&gt;

&lt;p&gt;I used the &lt;a href="https://downloads.haskell.org/~ghc/8.10.7/docs/html/users_guide/runtime_control.html#rts-flag--qg%20%E2%9F%A8gen%E2%9F%A9"&gt;&lt;code&gt;-qg&lt;/code&gt;&lt;/a&gt; RTS flag to disable parallel GC, and &lt;a href="https://downloads.haskell.org/~ghc/8.10.7/docs/html/users_guide/runtime_control.html#rts-flag--qn%20%E2%9F%A8x%E2%9F%A9"&gt;&lt;code&gt;-qnâŸ¨xâŸ©&lt;/code&gt;&lt;/a&gt; for keeping it enabled, but only using &lt;code&gt;âŸ¨xâŸ©&lt;/code&gt; threads.&lt;/p&gt;

&lt;p&gt;This is how ThreadScope metrics and our 99th percentile response times were affected by the different settings:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
  &lt;th&gt;RTS setting&lt;/th&gt;
  &lt;th align="right"&gt;p99&lt;/th&gt;
  &lt;th align="right"&gt;productivity&lt;/th&gt;
  &lt;th align="right"&gt;g0 pauses/s&lt;/th&gt;
  &lt;th align="right"&gt;avg g0 pause&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
  &lt;td&gt;-N3 -qn3&lt;/td&gt;
  &lt;td align="right"&gt;29ms&lt;/td&gt;
  &lt;td align="right"&gt;88.2%&lt;/td&gt;
  &lt;td align="right"&gt;488&lt;/td&gt;
  &lt;td align="right"&gt;0.2ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
  &lt;td&gt;-N3 -qn2&lt;/td&gt;
  &lt;td align="right"&gt;21ms&lt;/td&gt;
  &lt;td align="right"&gt;89.8%&lt;/td&gt;
  &lt;td align="right"&gt;558&lt;/td&gt;
  &lt;td align="right"&gt;0.1ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
  &lt;td&gt;-N3 -qg&lt;/td&gt;
  &lt;td align="right"&gt;17ms&lt;/td&gt;
  &lt;td align="right"&gt;88.9%&lt;/td&gt;
  &lt;td align="right"&gt;593&lt;/td&gt;
  &lt;td align="right"&gt;0.1ms&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Pauses times seemed to improve, but we don&amp;rsquo;t have enough resolution in Threadscope to see whether it was a 0.01ms improvement, or a full 0.1ms improvement.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Collections got more frequent, for reasons unknown&lt;/li&gt;
&lt;li&gt;Productivity lowered when we went down from 2 threads to 1 thread&lt;/li&gt;
&lt;li&gt;p99 response time was the best when the parallel GC was disabled&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Conclusion:&lt;/strong&gt; the parallel GC wasn&amp;rsquo;t helping us at all&lt;/p&gt;

&lt;h2&gt;Is our allocation area the right size?&lt;/h2&gt;

&lt;p&gt;The last of the helpful suggestions we got on Discourse was tweaking &lt;a href="https://downloads.haskell.org/~ghc/8.10.7/docs/html/users_guide/runtime_control.html#rts-flag--A%20%E2%9F%A8size%E2%9F%A9"&gt;&lt;code&gt;-A&lt;/code&gt;&lt;/a&gt;, which controls the size of Gen 0.&lt;/p&gt;

&lt;p&gt;The docs warn:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Increasing the allocation area size may or may not give better performance (a bigger allocation area means worse cache behaviour but fewer garbage collections and less promotion).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;What does cache behavior mean here? Googling led me to &lt;a href="https://stackoverflow.com/questions/3171922/ghcs-rts-options-for-garbage-collection/3172704#3172704"&gt;this StackOverflow answer by Simon Marlow&lt;/a&gt; explaining that using &lt;code&gt;-A&lt;/code&gt; higher than the CPU&amp;rsquo;s L2 cache size means we lower the L2 hit rate.&lt;/p&gt;

&lt;p&gt;Our AWS instances are running &lt;code&gt;Intel Xeon Platinum 8124M&lt;/code&gt;, which has 1MB of L2 cache per core, and the default &lt;code&gt;-A&lt;/code&gt; is 1MB, so any increase would already spell a reduced L2 hit rate for us.&lt;/p&gt;

&lt;p&gt;We compared 3 different scenarios:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
  &lt;th&gt;RTS setting&lt;/th&gt;
  &lt;th align="right"&gt;p99&lt;/th&gt;
  &lt;th align="right"&gt;productivity&lt;/th&gt;
  &lt;th align="right"&gt;g0 pauses/s&lt;/th&gt;
  &lt;th align="right"&gt;avg g0 pause&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
  &lt;td&gt;-N3 -qn3 -A1m&lt;/td&gt;
  &lt;td align="right"&gt;29ms&lt;/td&gt;
  &lt;td align="right"&gt;88.2%&lt;/td&gt;
  &lt;td align="right"&gt;488&lt;/td&gt;
  &lt;td align="right"&gt;0.2ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
  &lt;td&gt;-N3 -qn3 -A3m&lt;/td&gt;
  &lt;td align="right"&gt;18ms&lt;/td&gt;
  &lt;td align="right"&gt;95.6%&lt;/td&gt;
  &lt;td align="right"&gt;144&lt;/td&gt;
  &lt;td align="right"&gt;0.2ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
  &lt;td&gt;-N3 -qn3 -A128m&lt;/td&gt;
  &lt;td align="right"&gt;16ms&lt;/td&gt;
  &lt;td align="right"&gt;99.6%&lt;/td&gt;
  &lt;td align="right"&gt;1.2&lt;/td&gt;
  &lt;td align="right"&gt;2ms&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;The L2 cache hit rate penalty didn&amp;rsquo;t seem to affect the sorts of computations we are running, as -A128m still has the fastest p99 response time.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;-A128m&lt;/code&gt; seemed a bit ridiculous, but we had memory to spare, so we went with it. The 2ms average pause was close to our p75 response time, so it seemed fine to stop the world once per second for the time of 1 request slow'ish request to take out the trash.&lt;/p&gt;

&lt;h2&gt;Unlocking higher values for &lt;code&gt;-N&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;Our app had been having hiccups in production. For a second a database would get slow and would cause our Haskell processes, which usually handle around 2-4 in-flight requests at a time, to flood with 20-40 of them.&lt;/p&gt;

&lt;p&gt;Eating through this pile of requests would often take less than a minute, but would then cascade upstream into request queueing and some high-latency alerts, informing us that a high percentage of our users were having a frustrating experience with our website.&lt;/p&gt;

&lt;p&gt;Whenever this happened, we did not see CPU saturation. CPU usage remained around 65-70%. It made me think our Haskell threads were not being effective, and higher parallelism could help us leverage our cores better, even at the cost of some context switching.&lt;/p&gt;

&lt;p&gt;I was eager to try a higher &lt;code&gt;-N&lt;/code&gt; than the &lt;code&gt;taskset&lt;/code&gt; core count I gave to our processes, but was unable to until now, because setting &lt;code&gt;-N&lt;/code&gt; higher than the core count would bring the productivity metric down quickly, and would increase p99 response times.&lt;/p&gt;

&lt;p&gt;With our new findings, and a close eye on &lt;code&gt;nonvoluntary_ctxt_switches&lt;/code&gt; in &lt;code&gt;/proc/[pid]/status&lt;/code&gt;, I managed to get to us to &lt;code&gt;-N6&lt;/code&gt;, which seemed enough to reduce the frequency of our hiccups to a few times a month, versus daily.&lt;/p&gt;

&lt;p&gt;These were our final RTS settings, with &lt;code&gt;-N6&lt;/code&gt;, compared to what we started:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
  &lt;th&gt;RTS setting&lt;/th&gt;
  &lt;th align="right"&gt;p99&lt;/th&gt;
  &lt;th align="right"&gt;productivity&lt;/th&gt;
  &lt;th align="right"&gt;g0 pauses/s&lt;/th&gt;
  &lt;th align="right"&gt;avg g0 pause&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
  &lt;td&gt;-N3 -qn3 -A1m&lt;/td&gt;
  &lt;td align="right"&gt;29ms&lt;/td&gt;
  &lt;td align="right"&gt;88.2%&lt;/td&gt;
  &lt;td align="right"&gt;488&lt;/td&gt;
  &lt;td align="right"&gt;0.2ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
  &lt;td&gt;-N6 -qg -A128m&lt;/td&gt;
  &lt;td align="right"&gt;13ms&lt;/td&gt;
  &lt;td align="right"&gt;99.5%&lt;/td&gt;
  &lt;td align="right"&gt;0.8&lt;/td&gt;
  &lt;td align="right"&gt;4.2ms&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;These numbers were captured on GHC 8.8.4. We did upgrade to GHC 8.10.6 to try the new non-moving garbage collector, but saw no improvement.&lt;/p&gt;

&lt;h2&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Haskell has pretty good instrumentation to help you tune garbage collection. I was intimidated by the prospect of trying to tune it without building a mental model of all the settings available first, but profiling our workload in production proved easy to set up and quick to iterate on.&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;Juliano Solanho &lt;a href="https://twitter.com/julianobs"&gt;@julianobs&lt;/a&gt; Engineer at &lt;a href="https://www.noredink.com"&gt;NoRedInk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you Brian Hicks and Ju Liu for draft reviews and feedback! ðŸ’œ&lt;/p&gt;</description><link>https://blog.noredink.com/post/666654908557180928</link><guid>https://blog.noredink.com/post/666654908557180928</guid><pubDate>Mon, 01 Nov 2021 09:01:04 -0400</pubDate><category>haskell</category><category>kubernetes</category></item><item><title>Tuning Haskell RTS for Kubernetes, Part 1</title><description>&lt;p&gt;We&amp;rsquo;re running Haskell in production. We&amp;rsquo;ve told that story &lt;a href="https://www.youtube.com/watch?v=5CYeZ2kEiOI"&gt;before&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We are also running Haskell in production on Kubernetes, but we never talked about that. It was a long journey and it wasn&amp;rsquo;t all roses, so we&amp;rsquo;re going to share what we went through.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;Configure &lt;a href="https://downloads.haskell.org/~ghc/9.0.1/docs/html/users_guide/runtime_control.html"&gt;Haskell RTS settings&lt;/a&gt;:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Match &lt;code&gt;-NâŸ¨xâŸ©&lt;/code&gt; to your &lt;code&gt;limits.cpu&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Match &lt;code&gt;-MâŸ¨sizeâŸ©&lt;/code&gt; to your &lt;code&gt;limits.memory&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You can set them between &lt;code&gt;+RTS ... -RTS&lt;/code&gt; arguments to your program, like &lt;code&gt;+RTS -M5.7g -N3 -RTS&lt;/code&gt;.&lt;/p&gt;

&lt;h2&gt;Our scenario&lt;/h2&gt;

&lt;p&gt;We had been running Haskell in production before Kubernetes. Each application was the single inhabitant of its own EC2 instance. Things were smooth. We launched the executable, provisioned what looked like fast enough instances, and things just worked.&lt;/p&gt;

&lt;p&gt;We could have kept our conditions pretty much the same when moving to Kubernetes by giving our Haskell Pods as much &lt;code&gt;requests.memory&lt;/code&gt; and &lt;code&gt;requests.cpu&lt;/code&gt; as our worker nodes, so each machine runs a single Pod.&lt;/p&gt;

&lt;p&gt;We had two main incentives to run &lt;strong&gt;small Pods&lt;/strong&gt;, all packed together into &lt;strong&gt;beefier worker nodes&lt;/strong&gt;:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Our traffic is very seasonal, and even within a single day we go from 1000 requests per minute at night to close to 500,000 requests per minute when both east- and west-coast are at school. If we can scale down to the smallest footprint at idle, we save money.&lt;/li&gt;
&lt;li&gt;We use Datadog for infrastructure monitoring, and Datadog charges customers on a per-host basis. If we used small worker nodes, at peak traffic we&amp;rsquo;d be needing so many of them that our Datadog bill would become prohibitive.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We wanted effective resource utilization at idle and at peak while keeping costs under control.&lt;/p&gt;

&lt;p&gt;We googled for tips, war stories or even fanfiction on Haskell in Kubernetes, and the two &lt;a href="https://denibertovic.com/talks/k8s-haskell-webinar/"&gt;â½Â¹â¾&lt;/a&gt;&lt;a href="https://www.fpcomplete.com/blog/2015/11/kubernetes/"&gt;â½Â²â¾&lt;/a&gt; results we found were pretty old, and didn&amp;rsquo;t get into any specifics on how Haskell itself behaves in a containerized environment, so it seemed like there&amp;rsquo;d be no dragons here.&lt;/p&gt;

&lt;p&gt;With this in mind we launched our highest traffic Haskell service in prod with:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;2 cores&lt;/li&gt;
&lt;li&gt;200MB memory&lt;/li&gt;
&lt;li&gt;70% target CPU usage on our Horizontal Pod Autoscaler&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And called it a day.&lt;/p&gt;

&lt;h2&gt;Fires&lt;/h2&gt;

&lt;p&gt;After we went live we saw:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ðŸ˜¨ &lt;strong&gt;Terrible performance&lt;/strong&gt;: everything was slow&lt;/li&gt;
&lt;li&gt;ðŸ˜³ &lt;strong&gt;Frequent container restarts&lt;/strong&gt;: it looked like the GC wasn&amp;rsquo;t working at all and the processes were getting OOMKilled frequently&lt;/li&gt;
&lt;li&gt;ðŸ¤• &lt;strong&gt;Horrendous performance at scale-up&lt;/strong&gt;: When we got bursts of traffic, response times would shoot up and cause request queueing in our upstream service&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This last one was kind of obvious. At 70% target CPU usage, even if our app was able to saturate the machine&amp;rsquo;s CPU to 99.99% without slowing down, and even if it had linear rate for requests to CPU usage, we&amp;rsquo;d only have room for 30% growth in traffic while waiting for a scale-up. This was not enough slack, due to two main factors:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/awslabs/amazon-eks-ami/issues/417"&gt;AWS EKS takes close to 3 minutes to scale up Pods when worker node scaling is also necessary&lt;/a&gt;. 3 minutes is a lot time when we&amp;rsquo;re ramping up 500x in a few hours. At peak season, we more than double our traffic every 3 minutes during ramp-up when the East Coast is starting school.

&lt;ul&gt;
&lt;li&gt;It&amp;rsquo;s partly fixable by using the &lt;a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-can-i-configure-overprovisioning-with-cluster-autoscaler"&gt;cluster-overprovisioner pattern&lt;/a&gt;, which we do, but outside of 1-node scale-ups, &lt;a href="https://github.com/awslabs/amazon-eks-ami/issues/417#issuecomment-585592428"&gt;the option seems to be tweaking AWS VPC CNI&amp;rsquo;s startup&lt;/a&gt;, which we haven&amp;rsquo;t looked into yet.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Kubernetes has no concept of &lt;em&gt;create-before-destroy&lt;/em&gt;. Shifting Pods around for Cluster Autoscaler&amp;rsquo;s bin-packing operation and for &lt;code&gt;kubectl drain&lt;/code&gt; works by first terminating one or more Pods, then letting the scheduler recreate them on another Node. Say we have 3 Pods alive, between terminating one Pod and going Ready with its substitute, our compute capacity is reduced by 33%.

&lt;ul&gt;
&lt;li&gt;It might be fixable by writing our own create-before-destroy operation, forking cluster-autoscaler to use that instead, and also using it to write our own drain script. Things like Pod eviction due to taints will be out of reach, but that might be acceptable. Regardless, we chose not to go down that path.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So we lowered our target CPU usage to 50%, and scale-ups were safe.&lt;/p&gt;

&lt;p&gt;While fighting &lt;strong&gt;frequent container restarts&lt;/strong&gt;, we kept being less conservative about memory, going all the way up to 2GB per core. Our app consistently used ~100MB of RAM before moving to Kubernetes, so we were surprised. It might be we introduced space/memory leaks at the same time as we moved to Kubernetes, but also, the Haskell garbage collector didn&amp;rsquo;t seem to be aware it was reaching a memory limit. So we started looking at Haskell RTS GC settings.&lt;/p&gt;

&lt;p&gt;While diagnosing &lt;strong&gt;terrible performance&lt;/strong&gt;, we noticed Haskell was spinning up dozens of threads for each tiny Pod, and we knew from working with the Elm compiler (also written in Haskell), that &lt;a href="https://github.com/elm-lang/elm-make/issues/159"&gt;Haskell doesn&amp;rsquo;t care about virtualized environments when figuring out the capabilities of the machine it&amp;rsquo;s running on&lt;/a&gt;. We figured something similar was at play and we might have to tune the RTS.&lt;/p&gt;

&lt;h2&gt;Tuning the RTS&lt;/h2&gt;

&lt;p&gt;The two settings that helped us get over &lt;strong&gt;terrible performance&lt;/strong&gt; and &lt;strong&gt;frequent container restarts&lt;/strong&gt; were:&lt;/p&gt;

&lt;h3&gt;&lt;a href="https://downloads.haskell.org/~ghc/9.0.1/docs/html/users_guide/runtime_control.html#rts-flag--M%20%E2%9F%A8size%E2%9F%A9"&gt;&lt;code&gt;-MâŸ¨sizeâŸ©&lt;/code&gt;&lt;/a&gt;&lt;/h3&gt;

&lt;p&gt;This setting tells the Haskell RTS what should be the maximum Heap size, which also informs other garbage collector parameters.&lt;/p&gt;

&lt;p&gt;So we set the maximum heap size a bit below our Pods&amp;rsquo; &lt;code&gt;limits.memory&lt;/code&gt;, and the GC started acting more aggressively to prevent us from going over &lt;code&gt;limits.memory&lt;/code&gt;. We managed to stop getting OOMKilled.&lt;/p&gt;

&lt;p&gt;Eventually, as sneakily as they appeared, our space or memory leaks went away, and we went down to a stable 200MB of memory usage per process.&lt;/p&gt;

&lt;h3&gt;&lt;a href="https://downloads.haskell.org/~ghc/9.0.1/docs/html/users_guide/using-concurrent.html#rts-flag--N%20%E2%9F%A8x%E2%9F%A9"&gt;&lt;code&gt;-NâŸ¨xâŸ©&lt;/code&gt;&lt;/a&gt;&lt;/h3&gt;

&lt;p&gt;The docs are a bit misleading here:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Use âŸ¨xâŸ© simultaneous threads when running the program&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Without reading further, we thought setting &lt;code&gt;-N2&lt;/code&gt; would get us 2 threads for our 2-core Pods, but we were still seeing more than 10 threads per process.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;âŸ¨xâŸ©&lt;/code&gt; here is what the RTS calls &lt;em&gt;capabilities&lt;/em&gt;, which the docs clarify further on:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;A capability is animated by one or more OS threads; the runtime manages a pool of OS threads for each capability, so that if a Haskell thread makes a foreign call (see &lt;a href="https://downloads.haskell.org/~ghc/9.0.1/docs/html/users_guide/exts/ffi.html#ffi-threads"&gt;Multi-threading and the FFI&lt;/a&gt;) another OS thread can take over that capability.&lt;/p&gt;
  
  &lt;p&gt;Normally âŸ¨xâŸ© should be chosen to match the number of CPU cores on the machine&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Ok, that&amp;rsquo;s expected then, albeit a bit weird that it&amp;rsquo;s such a big pool for only two capabilities.&lt;/p&gt;

&lt;p&gt;Regardless, performance was actually good again with &lt;code&gt;-N&lt;/code&gt; matching our CPU count.&lt;/p&gt;

&lt;p&gt;In the end, we landed on 3 cores per Pod and &lt;code&gt;-N3&lt;/code&gt;: Kubernetes reserves a few hundred millicores of each worker node for its manager process (the kubelet) and this meant we&amp;rsquo;d only be able to use 14 cores on a 16 cores node. 2 cores would go to waste, unless we had enough pebbles in our cluster, which we didn&amp;rsquo;t.&lt;/p&gt;

&lt;h2&gt;Obligatory detour through CFS Throttling&lt;/h2&gt;

&lt;p&gt;At the same time we also learned about &lt;a href="https://github.com/kubernetes/kubernetes/issues/67577"&gt;CFS throttling&lt;/a&gt;, and learned to keep an eye on how much we were getting throttled. For &lt;code&gt;-N2&lt;/code&gt; and 2 cores, it was infrequent.&lt;/p&gt;

&lt;p&gt;In the hopes of disabling CFS completely, &lt;a href="https://github.com/zalando-incubator/kubernetes-on-aws/issues/1026"&gt;like Zalando did&lt;/a&gt;, we did trial running our Nodes with &lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/#static-policy"&gt;&lt;code&gt;--cpu-manager-policy=static&lt;/code&gt;&lt;/a&gt;. This uses &lt;a href="https://man7.org/linux/man-pages/man1/taskset.1.html"&gt;&lt;code&gt;taskset&lt;/code&gt;&lt;/a&gt; to give Pods exclusive access to certain cores.&lt;/p&gt;

&lt;p&gt;Our idea was to constrain high throughput Pods to their own cores, in order to spare processes from noisy neighbours and prevent worker nodes from overloading.&lt;/p&gt;

&lt;p&gt;We saw a steep drop in performance, so we backed away. We ended up figuring out why, but that&amp;rsquo;s the subject of another blog post. (hint: it&amp;rsquo;s the parallel GC)&lt;/p&gt;

&lt;h2&gt;Production-ready enough&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Performance was good&lt;/li&gt;
&lt;li&gt;Containers weren&amp;rsquo;t restarting anymore&lt;/li&gt;
&lt;li&gt;We were churning out close to 500,000 requests per minute on 7 Pods, each with 3 capabilities and eating less than 200MB of RAM&lt;/li&gt;
&lt;li&gt;Autoscaling was smooth&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It wasn&amp;rsquo;t the end of our ramblings on the Haskell RTS options page, we still had daily incidents where Haskell would slow down for a few seconds, cause upstream request queueing and trigger our fire alerts, but that&amp;rsquo;s a story for another day.&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;Juliano Solanho &lt;a href="https://twitter.com/julianobs"&gt;@julianobs&lt;/a&gt; Engineer at &lt;a href="https://www.noredink.com"&gt;NoRedInk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you, Brian Hicks, Ju Liu and Richard Feldman for draft reviews and feedback! â¤ï¸&lt;/p&gt;</description><link>https://blog.noredink.com/post/666020751977168896</link><guid>https://blog.noredink.com/post/666020751977168896</guid><pubDate>Mon, 25 Oct 2021 09:01:25 -0400</pubDate><category>engineering</category><category>haskell</category><category>kubernetes</category></item><item><title>Haskell for the Elm Enthusiast</title><description>&lt;p&gt;Many years ago NRI adopted Elm as a frontend language. We started small with a disposable proof of concept, and as the engineering team increasingly was bought into Elm being a &lt;em&gt;much&lt;/em&gt; better developer experience than JavaScript more and more of our frontend development happened in Elm. Today almost all of our frontend is written in Elm.&lt;/p&gt;

&lt;p&gt;Meanwhile, on the backend, we use Ruby on Rails. Rails has served us well and has supported amazing growth of our website, both in terms of the features it supports, and the number of students and teachers who use it. But weâ€™ve come to miss some of the tools that make us so productive in Elm: Tools like custom types for modeling data, or the type checker and its helpful error messages, or the ease of writing (fast) tests.&lt;/p&gt;

&lt;p&gt;A couple of years ago we started looking into Haskell as an alternative backend language that could bring to our backend some of the benefits we experience writing Elm in the frontend. Today some key parts of our backend code are written in Haskell. Over the years weâ€™ve developed our style of writing Haskell, which can be described as very Elm-like (itâ€™s also still changing!).&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h1&gt;ðŸŒ³ Why be Like Elm?&lt;/h1&gt;

&lt;p&gt;Elm is a small language with great error messages, great documentation, and a great community. Together these make Elm one of the nicest programming languages &lt;em&gt;to learn&lt;/em&gt;. Participants in an &lt;a href="https://github.com/elmbridge/curriculum"&gt;ElmBridge&lt;/a&gt; event will go from knowing nothing of the language to writing a real application using Elm in 5 hours.&lt;/p&gt;

&lt;p&gt;We have a huge amount of Elm code at NoRedInk, and it supports some pretty tricky UI work. Elm scales well to a growing and increasingly complicated codebase. The compiler stays fast and we donâ€™t lose confidence in our ability to make changes to our code. You can learn more about our Elm story &lt;a href="https://www.youtube.com/watch?v=DoA4Txr4GUs"&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h1&gt;ðŸ“¦ Unboxing Haskell&lt;/h1&gt;

&lt;p&gt;Haskell shares a lot of the language features we like in Elm: Custom types to help us model our data. Pure functions and explicit side effects. Writing code without runtime exceptions (mostly).&lt;/p&gt;

&lt;p&gt;When it comes to ease of learning, Haskell makes different trade-offs than Elm. The language is much bigger, especially when including the many optional language features that can be enabled. Itâ€™s entirely up to you whether you want to use these features in your code, but youâ€™ll need to know about many of them if you want to make use of Haskellâ€™s packages, documentation, and how-tos. Haskellâ€™s compiler errors typically arenâ€™t as helpful as Elmâ€™s are. Finally, weâ€™ve read many Haskell books and blog posts, but havenâ€™t found anything getting us from knowing no Haskell to writing a real application in it thatâ€™s anywhere near as small and effective as the &lt;a href="https://guide.elm-lang.org/"&gt;Elm Guide&lt;/a&gt;.&lt;/p&gt;

&lt;h1&gt;ðŸŸï¸ When in Rome, Act Like a Babylonian&lt;/h1&gt;

&lt;p&gt;Many of the niceties weâ€™re used to in Elm we get in Haskell too. But Haskell has many additional features, and each one we use adds to the list of things that an Elm programmer will need to learn. So instead we took a path that many in the Haskell community took before us: limit ourselves to a subset of the language.&lt;/p&gt;

&lt;p&gt;There are many styles of writing Haskell, each with its own trade-offs. Examples include Protolude, RIO, the lens ecosystem, and many more. Our approach differs in being strongly inspired by Elm. So what does our Elm-inspired style of writing Haskell look like?&lt;/p&gt;

&lt;h2&gt;ðŸ‡ Low hanging fruit: the Elm standard library&lt;/h2&gt;

&lt;p&gt;Our earliest effort in making our Haskell code more Elm-like was porting the Elm standard library to Haskell. Weâ€™ve open-sourced this port as a library named &lt;a href="https://hackage.haskell.org/package/nri-prelude"&gt;&lt;code&gt;nri-prelude&lt;/code&gt;&lt;/a&gt;. It contains Haskell counterparts of the Elm modules for working with &lt;code&gt;String&lt;/code&gt;s, &lt;code&gt;List&lt;/code&gt;s, &lt;code&gt;Dict&lt;/code&gt;s, and more.&lt;/p&gt;

&lt;p&gt;&lt;a href="https://hackage.haskell.org/package/nri-prelude"&gt;&lt;code&gt;nri-prelude&lt;/code&gt;&lt;/a&gt; also includes a port of &lt;code&gt;elm-test&lt;/code&gt;. It provides everything you need for writing unit tests and basic property tests.&lt;/p&gt;

&lt;p&gt;Finally, it includes a GHC plugin that makes it so Haskellâ€™s default &lt;code&gt;Prelude&lt;/code&gt; (basically its standard library) behaves like Elmâ€™s defaults. For example, it adds implicit qualified imports of some modules like &lt;code&gt;List&lt;/code&gt;, similar to what Elm does.&lt;/p&gt;

&lt;h2&gt;ðŸŽšï¸ Effects and the Absence of The Elm Architecture&lt;/h2&gt;

&lt;p&gt;Elm is opinionated in supporting a single architecture for frontend applications, fittingly called The Elm Architecture. One of its nice qualities is that it forces a separation of application logic (all those conditionals and loops) and effects (things like talking to a database or getting the current time). We love using The Elm Architecture writing frontend applications, but donâ€™t see a way to apply it 1:1 to backend development. In the F# community, they use the Elm Architecture for &lt;em&gt;some&lt;/em&gt; backend features (see: &lt;a href="https://safe-stack.github.io/docs/feature-clientserver-bridge/#when-to-use-elmishbridge"&gt;When to use Elmish Bridge&lt;/a&gt;), but itâ€™s not generally applicable. Weâ€™d still like to encourage that separation between application logic and effects though, having seen some of the effects of losing that distinction in our backend code. Read our other post &lt;a href="https://blog.noredink.com/post/657392972659310592/pufferfish-please-scale-the-site"&gt;Pufferfish, please scale the site!&lt;/a&gt; if you want to read more about this.&lt;/p&gt;

&lt;p&gt;Out of many options weâ€™re currently using &lt;a href="https://jaspervdj.be/posts/2018-03-08-handle-pattern.html"&gt;the handle pattern&lt;/a&gt; for managing effects. For each type of effect, we create a &lt;code&gt;Handler&lt;/code&gt; type (we added the extra &lt;code&gt;r&lt;/code&gt; in a typo way back and it has stuck around. Sorry). We use this pattern across our libraries for talking to outside systems: &lt;a href="https://hackage.haskell.org/package/nri-postgresql"&gt;&lt;code&gt;nri-postgresql&lt;/code&gt;&lt;/a&gt;, &lt;a href="https://hackage.haskell.org/package/nri-http"&gt;&lt;code&gt;nri-http&lt;/code&gt;&lt;/a&gt;, &lt;a href="https://hackage.haskell.org/package/nri-redis"&gt;&lt;code&gt;nri-redis&lt;/code&gt;&lt;/a&gt;, and &lt;a href="https://hackage.haskell.org/package/nri-kafka"&gt;&lt;code&gt;nri-kafka&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Without The Elm Architecture, we depend heavily on chaining permutations through a stateful &lt;code&gt;Task&lt;/code&gt; type. This feels similar to imperative coding: First, do A, then B, then C. Hopefully, when weâ€™re later on in our Haskell journey, weâ€™ll discover a nice architecture to simplify our backend code.&lt;/p&gt;

&lt;h2&gt;ðŸšš Bringing Elm Values to Haskell&lt;/h2&gt;

&lt;p&gt;One way in which Haskell is different from both Elm and Rails is that it is not particularly opinionated. Often the Haskell ecosystem offers multiple different ways to do one particular thing. So whether itâ€™s writing an http server, logging, or talking with a database, the first time we do any of these things weâ€™ll need to decide &lt;em&gt;how&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;When adopting a Haskell feature or library, we care about&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;smallness, e.g. introduce new concepts only when necessary&lt;/li&gt;
&lt;li&gt;how â€œmagicalâ€ is it? E.g. How &lt;em&gt;surprising&lt;/em&gt; is it?&lt;/li&gt;
&lt;li&gt;How easy is it to &lt;em&gt;learn&lt;/em&gt;?&lt;/li&gt;
&lt;li&gt;how easy is it to &lt;em&gt;use?&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;how comprehensible is the documentation?&lt;/li&gt;
&lt;li&gt;&lt;em&gt;explicitness&lt;/em&gt; over &lt;em&gt;terseness (&lt;/em&gt;but terseness isnâ€™t implicitly bad).&lt;/li&gt;
&lt;li&gt;consistency &amp;amp; predictability&lt;/li&gt;
&lt;li&gt;â€œsafetyâ€ (no runtime exceptions).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Sometimes the Haskell ecosystem provides an option that fits our Elm values, like with the handle pattern, and so we go with it. Other times a library has different values, and then the choice not to use it is easy as well. An example of this is lens/prism ecosystem, which allows one to write super succinct code, but is almost a language onto itself that one has to learn first.&lt;/p&gt;

&lt;p&gt;The hardest decisions are the ones where an approach protects us against making mistakes in some way (which we like) but requires familiarity with more language features to use (which we prefer to avoid).&lt;/p&gt;

&lt;p&gt;To help us make better decisions, we often &lt;strong&gt;try it both ways.&lt;/strong&gt; That is, weâ€™re willing to build a piece of software with &amp;amp; without a complex language feature to ensure the &lt;em&gt;cost&lt;/em&gt; of the complexity is worth the benefit that the feature brings us.&lt;/p&gt;

&lt;p&gt;Another approach we take is making decisions locally. A single team might evaluate a new feature, and then demo it and share it with other teams after they have a good sense the feature is worth it. Remember: a super-power of Haskell is easy refactorability. Unlike our ruby code, going through and doing major re-writes in our Haskell codebase is often an hours-or-days-long (rather than weeks-or-months-long) endeavor. Adopting two different patterns simultaneously has a relatively small cost!&lt;/p&gt;

&lt;h2&gt;Case studies in feature adoption:&lt;/h2&gt;

&lt;h3&gt;ðŸ˜ Type-Check All Elephants&lt;/h3&gt;

&lt;p&gt;One example where our approach is Elm-like in some ways but not in others is how we talk to the database. Weâ€™re using a GHC feature called quasiquoting for this, which allow us to embed SQL query strings directly into our Haskell code, like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{-# LANGUAGE QuasiQuotes #-}

module Animals (listAll) where

import Postgres (query, sql)

listAll :: Postgres.Handler -&amp;gt; Task Text (List (Text, Text))
listAll postgres =
  query postgres [sql|SELECT species, genus FROM animals|]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A library called &lt;a href="https://hackage.haskell.org/package/postgresql-typed"&gt;&lt;code&gt;postgresql-typed&lt;/code&gt;&lt;/a&gt; can test these queries against a real Postgres database and show us an error at compile time if the query doesnâ€™t fit the data. Such a compile-time error might happen if a table or column we reference in a query doesnâ€™t exist in the database. This way we use static checks to eliminate a whole class of potential app/database compatibility problems!&lt;/p&gt;

&lt;p&gt;The downside is that writing code like this requires everyone working with it to learn a bit about quasi quotes, and what return type to expect for different kinds of queries. That said, using some kind of querying library instead has a learning curve too, and query libraries tend to be pretty big to support all the different kinds of queries that can be made.&lt;/p&gt;

&lt;h3&gt;ðŸ”£ So Many Webserver Options&lt;/h3&gt;

&lt;p&gt;Another example where we traded additional safety against language complexity is in our choice of webserver library. We went with &lt;code&gt;servant&lt;/code&gt; here, a library that lets you express REST APIs using types, like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;import Servant

data Routes route = Routes
  { listTodos ::
      route
        :- "todos"
        :&amp;gt; Get '\[JSON\] [Todo],
    updateTodo ::
      route
        :- "todos"
        :&amp;gt; Capture "id" Int
        :&amp;gt; ReqBody '[JSON] Todo
        :&amp;gt; Put '[JSON] NoContent,
    deleteTodo ::
      route
        :- "todos"
        :&amp;gt; Capture "id" Int
        :&amp;gt; Delete '[JSON] NoContent
  }
  deriving (Generic)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Servant is a big library that makes use of a lot of type-level programming techniques, which are pretty uncommon in Elm, so thereâ€™s a steep learning cost associated with &lt;em&gt;understanding&lt;/em&gt; how the type magic works. Using it without a deep understanding is reasonably straightforward.&lt;/p&gt;

&lt;p&gt;The benefits gained from using Servant outweigh the cost of expanded complexity. Based on a type like the one in the example above, the servant ecosystem can generate functions in other languages like Elm or Ruby. Using these functions means we can save time with backend-to-frontend or service-to-service communication. If some Haskell type changes in a backward-incompatible fashion we will generate new Elm code, and this might introduce a compiler error on the Elm side.&lt;/p&gt;

&lt;p&gt;So for now weâ€™re using servant! Itâ€™s important to note that what we &lt;em&gt;want&lt;/em&gt; is compile-time server/client compatibility checking, and thatâ€™s why we swallow Servantâ€™s complexity. If we could get the same benefit without the type-level programming demonstrated above, we would prefer that. Hopefully, in the future, another library will offer the same benefits from a more Elm-like API.&lt;/p&gt;

&lt;h1&gt;ðŸ˜» Like what you see?&lt;/h1&gt;

&lt;p&gt;We&amp;rsquo;re running the libraries discussed above in production. Our most-used Haskell application receives hundreds of thousands of requests per minute without issue and produces hardly any errors.&lt;/p&gt;

&lt;p&gt;Code can be found at &lt;a href="https://github.com/NoRedInk/haskell-libraries"&gt;&lt;code&gt;NoRedInk/haskell-libraries&lt;/code&gt;&lt;/a&gt;. Libraries have been published to hackage and stackage. We&amp;rsquo;d love to know what you think!&lt;/p&gt;</description><link>https://blog.noredink.com/post/658510851000713216</link><guid>https://blog.noredink.com/post/658510851000713216</guid><pubDate>Tue, 03 Aug 2021 11:34:45 -0400</pubDate><category>engineering</category><category>haskell</category></item><item><title>ðŸŒ‰ Bridging a typed and an untyped world</title><description>&lt;p&gt;Even if you work in the orderly, bug-free, spic-and-span, statically-typed worlds of Elm and Haskell (like we do at NoRedInk, did you know weâ€™re hiring?), you still have to talk to the wild free-wheeling dynamically-typed world sometimes. Most recently: we were trying to bridge the gap between Haskell (ðŸ§) and Redis(ðŸ¤ª). Here weâ€™ll discuss two iterations of our Redis library for Haskell, &lt;a href="https://github.com/NoRedInk/haskell-libraries/tree/trunk/nri-redis"&gt;nri-redis&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;All examples in this code are in Haskell and use a few functions from NoRedInkâ€™s prelude &lt;a href="https://hackage.haskell.org/package/nri-prelude"&gt;nri-prelude&lt;/a&gt;. Specifically, we will use &lt;code&gt;|&amp;gt;&lt;/code&gt; instead of &lt;code&gt;&amp;amp;&lt;/code&gt;, &lt;code&gt;Debug.toString&lt;/code&gt; instead of &lt;code&gt;show&lt;/code&gt; and a few functions from &lt;a href="https://hackage.haskell.org/package/nri-prelude-0.6.0.3/docs/Expect.html"&gt;&lt;code&gt;Expect&lt;/code&gt;&lt;/a&gt;. Most of the example code &lt;em&gt;could be&lt;/em&gt; real tests.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h1&gt;ðŸ’¬ Redis in Haskell&lt;/h1&gt;

&lt;p&gt;Letâ€™s begin with a look at an earlier iteration of &lt;a href="https://github.com/NoRedInk/haskell-libraries/tree/trunk/nri-redis"&gt;nri-redis&lt;/a&gt; (a wrapper around &lt;a href="https://hackage.haskell.org/package/hedis"&gt;hedis&lt;/a&gt;). We are going to work with two functions &lt;code&gt;get&lt;/code&gt; and &lt;code&gt;set&lt;/code&gt; which have the following type signatures:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;set :: Data.Aeson.ToJSON a =&amp;gt; Text -&amp;gt; a -&amp;gt; Query ()
get :: Data.Aeson.ToJSON a =&amp;gt; Text -&amp;gt; Query (Maybe a)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Letâ€™s use this API for a blogging application that stored blog posts and users in Redis.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;data User = User
  { name :: Text
  -- maybe more fields later
  }
  deriving (Generic, Show, Eq)

data Post = Post
  { title :: Text
  -- ...
  }
  deriving (Generic, Show)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Maybe you noticed that we derive &lt;code&gt;Generic&lt;/code&gt; for both types. We will store users and posts as JSON in Redis. Storing data as JSON in Redis is simple, and we only need an additional instance for decoding and encoding to JSON.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;instance Data.Aeson.ToJSON User
instance Data.Aeson.FromJSON User

instance Data.Aeson.ToJSON Post
instance Data.Aeson.FromJSON Post
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now how do we write something to Redis?&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Redis.set "user-1" User { name = "Luke" } -- create a query
  |&amp;gt; Redis.query handler                  -- run the query
  |&amp;gt; Expect.succeeds                      -- fail the test if the query fails
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We use &lt;code&gt;Redis.set&lt;/code&gt;, which corresponds to &lt;a href="https://redis.io/commands/set"&gt;&lt;code&gt;set&lt;/code&gt;&lt;/a&gt;. We can then execute the query using &lt;code&gt;Redis.query&lt;/code&gt;.
We can read the data back using a &lt;a href="https://redis.io/commands/get"&gt;&lt;code&gt;get&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;maybeUser &amp;lt;- Redis.get "user-1"
  |&amp;gt; Redis.query handler
  |&amp;gt; Expect.succeeds
Expect.equal (Just User {name = "Luke" }) maybeUser
&lt;/code&gt;&lt;/pre&gt;

&lt;h1&gt;ðŸ› What can go wrong?&lt;/h1&gt;

&lt;p&gt;Now that we know how to read and write to Redis letâ€™s look at this example. Can you spot the error?&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;let key1 = "user-1"
let key2 = "post-1"

Redis.set key1 User { name = "Obi-wan Kenobi" }
  |&amp;gt; Redis.query handler
  |&amp;gt; Expect.succeeds

Redis.set key1 Post { title = "Using the force to wash your dishes" }
  |&amp;gt; Redis.query handler
  |&amp;gt; Expect.succeeds

maybeUser &amp;lt;- Redis.get key1
  |&amp;gt; Redis.query handler
  |&amp;gt; Expect.succeeds

Expect.equal (Just User {name = "Obi-wan Kenobi"}) maybeUser
  -- !!! "Could not decode value in key: Error in $: parsing User(User) failed, key 'name' not found"
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A runtime error?! in Haskell?! Say it ainâ€™t so.&lt;/p&gt;

&lt;p&gt;Maybe you spotted the bug: We are using &lt;code&gt;key1&lt;/code&gt; to &lt;code&gt;set&lt;/code&gt; the
&lt;code&gt;post&lt;/code&gt; instead of &lt;code&gt;key2&lt;/code&gt;.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;First, we set the data in &lt;code&gt;key1&lt;/code&gt; to be a &lt;code&gt;User&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;We then replaced it with a &lt;code&gt;Post&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;We fetch the data from &lt;code&gt;key1&lt;/code&gt; (a &lt;code&gt;Post&lt;/code&gt;) into &lt;code&gt;maybeUser&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;The compiler thinks &lt;code&gt;maybeUser&lt;/code&gt; is of type &lt;code&gt;Maybe User&lt;/code&gt;, because we compare it with &lt;code&gt;Maybe User&lt;/code&gt; in &lt;code&gt;Expect.Equal&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;At runtime, the generated code from the &lt;code&gt;FromJSON&lt;/code&gt; instance will then fail to decode the &lt;code&gt;Post&lt;/code&gt;â€™s json-serialization into &lt;code&gt;User&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;which will cause our program to crash.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;This is not the only thing that can go wrong!&lt;/em&gt; Letâ€™s consider the next example:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;let users =
  [ ("user-1", User { name = "Obi"})
  , ("user-2", User { name = "Yoda"})
  ]

Redis.set "user-1" users
  |&amp;gt; Redis.query handler
  |&amp;gt; Expect.succeeds

maybeUser &amp;lt;-
  Redis.get "user-1"
    |&amp;gt; Redis.query handler
    |&amp;gt; Expect.succeeds

Expect.equal (Just User { name = "Obi"}) maybeUser
  -- !!! "Could not decode value in key: Error in $: parsing User(User) failed, expected Object, but encountered Array"
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We called set with &lt;code&gt;users&lt;/code&gt; instead of a &lt;code&gt;User&lt;/code&gt; (or called Redisâ€™s &lt;code&gt;mset&lt;/code&gt; on the list &lt;code&gt;users&lt;/code&gt;). Again, this compiles but fails at runtime when we assume that we receive one &lt;code&gt;User&lt;/code&gt; when we call get for this key.&lt;/p&gt;

&lt;h1&gt;ðŸ›¡ï¸ Can we make the bug impossible?&lt;/h1&gt;

&lt;p&gt;The previous examples showed how easy it was to write bugs with such a generic APIâ€”the program compiled in both cases but failed at runtime. The compiler couldn&amp;rsquo;t save us because &lt;code&gt;set&lt;/code&gt; and &lt;code&gt;get&lt;/code&gt; both accept any &lt;code&gt;Text&lt;/code&gt; as a key and only constrain the value to have an instance of &lt;code&gt;To/FromJSON&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;-- reminder: the API that allowed all kinds of havoc
set :: Data.Aeson.ToJSON a =&amp;gt; Text -&amp;gt; a -&amp;gt; Query ()
get :: Data.Aeson.ToJSON a =&amp;gt; Text -&amp;gt; Query (Maybe a)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Want to set a &lt;code&gt;User&lt;/code&gt; and fetch a list of &lt;code&gt;Posts&lt;/code&gt; from the same key? This API will let you (and then fail loudly in production).&lt;/p&gt;

&lt;p&gt;Ideally, we would get a &lt;em&gt;compiler error&lt;/em&gt; that prevents mixing up keys or passing the wrong value when writing to Redis. We decided to use an Elm-ish approach, avoiding making the API too magic.&lt;/p&gt;

&lt;p&gt;Instead of using commands directly, we introduced a new type called &lt;code&gt;Redis.Api key value&lt;/code&gt;. Its purpose is to bind a &lt;em&gt;concrete&lt;/em&gt; type for &lt;code&gt;key&lt;/code&gt; and &lt;code&gt;value&lt;/code&gt; to commands.&lt;/p&gt;

&lt;p&gt;Letâ€™s try to make the same mistake we made earlier, using the wrong type, with our new &lt;code&gt;Redis.Api&lt;/code&gt;.
Letâ€™s first create such an &lt;code&gt;Api&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;newtype UserId = UserId Int

userApi :: Redis.Api UserId User
userApi = Redis.jsonApi (\userId -&amp;gt; "user-" ++ Debug.toString userId)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We bound &lt;code&gt;UserId&lt;/code&gt; to &lt;code&gt;User&lt;/code&gt; by adding a top-level definition and giving it a type signature.
Additionally, we created a &lt;code&gt;newtype&lt;/code&gt; instead of relying on &lt;code&gt;Text&lt;/code&gt; as the key. This will guarantee that we donâ€™t call &lt;code&gt;userApi&lt;/code&gt; with a &lt;code&gt;post&lt;/code&gt; key.&lt;/p&gt;

&lt;p&gt;Now to use this, we call functions by â€œpassingâ€ them the new &lt;code&gt;userApi&lt;/code&gt;.
&lt;strong&gt;Side note:&lt;/strong&gt; &lt;code&gt;Redis.Api&lt;/code&gt; is a record, and we get the commands from it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;let users = [(UserId 1, User { name = "Obi"}), (UserId 2, User { name = "Yoda"})]

Redis.set userApi (UserId 1) users
  |&amp;gt; Redis.query handler
  |&amp;gt; Expect.succeeds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We catch the bug at compile time without writing a test (and well before causing a fire in production).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;      â€¢ Couldn't match expected type â€˜Userâ€™
                    with actual type â€˜[(UserId, User)]â€™
      |
  325 |         Redis.set userApi key1 users
      |                                ^^^^^
&lt;/code&gt;&lt;/pre&gt;

&lt;h1&gt;ðŸ¤— Making Tools Developer-Friendly&lt;/h1&gt;

&lt;p&gt;Our initial Redis API used a very generic type for keys and values (only constraint to implement &lt;code&gt;To/FromJSON&lt;/code&gt;). This optimized the library for &lt;em&gt;versatility&lt;/em&gt; but made the resulting application code less maintainable and error-prone.&lt;/p&gt;

&lt;p&gt;Having concrete types provides the compiler with more information and therefore allows for better error messages and better maintainability (e.g., less error-prone).
The API we ended up with is a balance of simplicity and safety. Itâ€™s still possible to misuse the library and get the bugs we discussed, but it guides the user towards the intended usage.&lt;/p&gt;

&lt;p&gt;You canâ€™t always predict how your libraryâ€™s users will use your tools, so leaving them open-ended has its upsides. But if you have a specific use-case, solving it specifically will help your developers avoid pitfalls and keep them more productive.&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;Christoph Hermann &lt;a href="https://github.com/stoeffel"&gt;@stoeffel&lt;/a&gt; Engineer at NoRedInk.&lt;/p&gt;

&lt;p&gt;Thanks to Michael Glass &lt;a href="https://github.com/michaelglass/"&gt;@michaelglass&lt;/a&gt; and Jasper Woudenberg &lt;a href="https://github.com/jwoudenberg/"&gt;@jwoudenberg&lt;/a&gt; for helping building this and their support writting this blogpost! â¤ï¸&lt;/p&gt;</description><link>https://blog.noredink.com/post/657844755189972992</link><guid>https://blog.noredink.com/post/657844755189972992</guid><pubDate>Tue, 27 Jul 2021 03:07:27 -0400</pubDate><category>engineering</category><category>haskell</category></item><item><title>â˜„ï¸ Pufferfish, please scale the site!</title><description>&lt;p&gt;We created Team Pufferfish about a year ago with a specific goal: &lt;strong&gt;&lt;em&gt;to avert the MySQL apocalypse&lt;/em&gt;&lt;/strong&gt;! The MySQL apocalypse would occur when so many students would work on quizzes simultaneously that even the largest MySQL database AWS has on offer would not be able to cope with the load, bringing the site to a halt.&lt;/p&gt;

&lt;p&gt;A little over a year ago, we forecasted our growth and load-tested MySQL to find out how much wiggle room we had. In the worst case (because we dislike apocalypses), or in the best case (because we like growing), we would have about a yearâ€™s time. This meant we needed to get going!&lt;/p&gt;

&lt;p&gt;Looking back on our work now, the most important lesson we learned was the importance of timely and precise feedback at every step of the way. At times we built short-lived tooling and process to support a particular step forward. This made us so much faster in the long run.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;ðŸ” Climbing the Legacy Code Mountain&lt;/h2&gt;

&lt;p&gt;Clear from the start, Team Pufferfish would need to make some pretty fundamental changes to the Quiz Engine, the component responsible for most of the MySQL load. Somehow the Quiz Engine would need to significantly reduce its load on MySQL.&lt;/p&gt;

&lt;p&gt;Most of NoRedInk runs on a Rails monolith, including the Quiz Engine. The Quiz Engine is big! Itâ€™s got lots of features! It supports our teachers &amp;amp; students to do lots of great work together! Yay!&lt;/p&gt;

&lt;p&gt;But the Quiz Engine has some problems, too. A mix of complexity and performance-sensitivity has made engineers afraid to touch it. Previous attempts at big structural change in the Quiz Engine failed and had to be rolled back. If Pufferfish was going make significant structural changes, we would need to ensure our ability to be productive in the Quiz Engine codebase. Thinking we could &lt;em&gt;just do it&lt;/em&gt; without a new approach would be foolhardy.&lt;/p&gt;

&lt;h2&gt;âš¡ The Vengeful God of Tests&lt;/h2&gt;

&lt;p&gt;We have mixed feelings about our test suite. Itâ€™s nice that it covers a lot of code. Less nice is that we donâ€™t really know what each test is intended to check. These tests have evolved into complex bits of code by themselves with a lot of supporting logic, and in many cases, tight coupling to the implementation. Diving deep into some of these tests has uncovered tests &lt;em&gt;no longer covering any production logic at all&lt;/em&gt;. The test suite is large and we didnâ€™t have time to dive deep into each test, but we were also reluctant to delete test cases without being sure they werenâ€™t adding value.&lt;/p&gt;

&lt;p&gt;Our relationship with the Quiz Engine test suite was and still is a bit like one might have with an angry Greek god. Weâ€™re continuously investing effort to keep it happy (i.e. green), but we donâ€™t always understand what weâ€™re doing or why. Please donâ€™t spoil our harvest and protect us from (production) fires, oh mighty RSpec!&lt;/p&gt;

&lt;p&gt;The ultimate goal wasnâ€™t to change Quiz Engine functionality, but rather to reduce its load on MySQL. This is the perfect scenario for tests to help us! The test suite we want is:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;fast&lt;/li&gt;
&lt;li&gt;comprehensive, and&lt;/li&gt;
&lt;li&gt;not dependent on implementation&lt;/li&gt;
&lt;li&gt;includes performance testing&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Unfortunately, thatâ€™s not the hand we were given:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The suite takes about 30 minutes to run in CI and even longer locally.&lt;/li&gt;
&lt;li&gt;Our QA team finds bugs that sneaked past CI in PRs with Quiz Engine changes relatively frequently.&lt;/li&gt;
&lt;li&gt;Many tests ensure that &lt;em&gt;specific queries&lt;/em&gt; are performed in a &lt;em&gt;specific order&lt;/em&gt;. Considering we might replace MySQL wholesale, these tests provide little value.&lt;/li&gt;
&lt;li&gt;And because a lot of Quiz Engine code is extremely performance-sensitive, thereâ€™s an increased risk of performance regressions only surfacing with real production load.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Fighting with our tests meant that even small changes would take hours to verify in tests, and then, because of unforeseen regressions not covered by the tests, take multiple attempts to fix, resulting in multiple-day roll-outs for small changes.&lt;/p&gt;

&lt;p&gt;Our clock is ticking! &lt;strong&gt;&lt;em&gt;We needed&lt;/em&gt;&lt;/strong&gt; &lt;strong&gt;&lt;em&gt;to&lt;/em&gt;&lt;/strong&gt; &lt;strong&gt;&lt;em&gt;iterate faster than that if we were going to&lt;/em&gt;&lt;/strong&gt; &lt;strong&gt;&lt;em&gt;avert the apocalypse.&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;h2&gt;ðŸ¶ I have no idea what Iâ€™m doing ðŸ§ª&lt;/h2&gt;

&lt;p&gt;Reading complicated legacy Rails code often raises questions that take surprising amounts of effort to answer.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Is this method dead code? If not, who is calling this?&lt;/li&gt;
&lt;li&gt;Are we ever entering this conditional? When?&lt;/li&gt;
&lt;li&gt;Is this function talking to the database?&lt;/li&gt;
&lt;li&gt;Is this function &lt;em&gt;intentionally&lt;/em&gt; talking to the database?&lt;/li&gt;
&lt;li&gt;Is this function only &lt;em&gt;reading&lt;/em&gt; from the database or also &lt;em&gt;writing&lt;/em&gt; to it?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It isnâ€™t even clear &lt;em&gt;what&lt;/em&gt; code was running. There are a few features of Ruby (and Rails) which optimize for &lt;em&gt;writing&lt;/em&gt; code over &lt;em&gt;reading&lt;/em&gt; it. We did our best to unwrap this type of code:&lt;/p&gt;

&lt;p&gt;Rails provides devs the ability to wrap functionality in hooks. &lt;code&gt;before_&lt;/code&gt; and &lt;code&gt;after_&lt;/code&gt; hooks let devs write setup and tear-down code once, then forget it. However, the existence of these hooks means calling a method might &lt;em&gt;also&lt;/em&gt; evaluate code defined in a different file, and you wonâ€™t know about it unless you explicitly look for it. &lt;em&gt;Hard to read!&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Complicating things further is Rubyâ€™s dynamic dispatch based on subclassing and polymorphic associations. Which &lt;code&gt;load_students&lt;/code&gt; am I calling? The one for &lt;code&gt;Quiz&lt;/code&gt; or the one for &lt;code&gt;Practice&lt;/code&gt;? They each implement the &lt;code&gt;Assignment&lt;/code&gt; interface but have pretty different behavior! And: they each have their own set of hooksðŸ¤¦. Maybe itâ€™s something completely different!&lt;/p&gt;

&lt;p&gt;And then thereâ€™s &lt;code&gt;ActiveRecord&lt;/code&gt;. &lt;code&gt;ActiveRecord&lt;/code&gt; makes it easy to write queries â€” a little too easy. It &lt;em&gt;doesnâ€™t&lt;/em&gt; make it easy to know where queries are happening. Itâ€™s ergonomic that we can tell &lt;code&gt;ActiveRecord&lt;/code&gt; what we need, and let it figure how to fetch the data. Itâ€™s less nice when youâ€™re trying to find out where in the code your queries are happening and the answer to that question is, â€œabsolutely anywhereâ€. We want to know &lt;em&gt;exactly what queries&lt;/em&gt; are happening on these code paths. &lt;code&gt;ActiveRecord&lt;/code&gt; doesnâ€™t help.&lt;/p&gt;

&lt;h2&gt;ðŸ§µ A rich history&lt;/h2&gt;

&lt;p&gt;A final factor that makes working in Quiz Engine code daunting is the sheer size of the beast. The Quiz Engine has grown organically over many years, so thereâ€™s a lot of functionality to be aware of.&lt;/p&gt;

&lt;p&gt;Because the Quiz Engine itself has been hard to change for a while, APIs defined between bits of Quiz Engine code often havenâ€™t evolved to match our latest understanding. This means understanding the Quiz Engine code requires not just understanding what it does today, but also how we thought about it in the past, and what (partial) attempts were made to change it. This increases the sum of Quiz Engine knowledge even further.&lt;/p&gt;

&lt;p&gt;For example, we might try to refactor a bit of code, leading to tests failing. But is this conditional branch ever reached in production? ðŸ¤·&lt;/p&gt;

&lt;h2&gt;Enough complaining. What did we do about it?&lt;/h2&gt;

&lt;p&gt;We knew this was going to be a huge project, and huge projects, in the best case, are shipped late, and in the average case donâ€™t ever ship. The only way we were going to have confidence that our work would ever see the light of day was by doing the riskiest, hardest, scariest stuff first. That way, if one approach wasnâ€™t going to work, we would find out about it sooner and could try something new before weâ€™d over-invested in a direction.&lt;/p&gt;

&lt;p&gt;So: where is the risk? Whatâ€™s the scariest problem we have to solve? History dictates: The more we change the legacy system, the more likely weâ€™re going to cause regressions.&lt;/p&gt;

&lt;p&gt;So our first task: cut away the part of the Quiz Engine that performs database queries and port this logic to a separate service. Henceforth when Rails needs to read or change Quiz Engine data, it will talk to the new service instead of going to the database directly.&lt;/p&gt;

&lt;p&gt;Once the legacy-code risk has been minimized, we would be able to focus on the (still challenging) task of changing where we store Quiz Engine data from single-database MySQL to something horizontally scalable.&lt;/p&gt;

&lt;h2&gt;â›ï¸ Phase 1: Extracting queries from Rails&lt;/h2&gt;

&lt;h3&gt;ðŸ”ª Finding out where to cut&lt;/h3&gt;

&lt;p&gt;Before extracting Quiz Engine MySQL queries from our Rails service, we first needed to know where those queries were being made. As we discussed above this wasnâ€™t obvious from reading the code.&lt;/p&gt;

&lt;p&gt;To find the MySQL queries themself, we built some tooling: we monkey-patched &lt;code&gt;ActiveRecord&lt;/code&gt; to warn whenever an unknown read or write was made against one of the tables containing Quiz Engine data. We ran our monkey-patched code first in CI and later in production, letting the warnings tell us where those queries were happening. Using this information we decorated our code by marking all the reads and writes. Once code was decorated, it would no longer emit warnings. As soon as all the writes &amp;amp; reads were decorated, we changed our monkey-patch to not just warn but fail when making a query against one of those tables, to ensure we wouldnâ€™t accidentally introduce new queries touching Quiz Engine data.&lt;/p&gt;

&lt;h3&gt;ðŸš› Offloading logic: &lt;strong&gt;Our first approach&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;Now we knew where to cut, we decided our place of greatest risk was moving a single MySQL query out of our rails app. If we could move a single query, we could move all of them. There was one rub: if we &lt;em&gt;did&lt;/em&gt; move all queries to our new app, we would add a lot of network latency. because of the number of round trips needed for a single request. Now we have a constraint: Move a single query into a new service, but with very little latency.&lt;/p&gt;

&lt;p&gt;How did we reduce latency?&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Get rid of network latency by getting rid of the network â€” we hosted the service in the same hardware as our Rails app.&lt;/li&gt;
&lt;li&gt;Get rid of protocol latency by using a dead-simple protocol: socket communication.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;We ended up building a socket server in Haskell that took data requests from Rails, and transformed them into a series of MySQL queries, which rails would use to fetch the data itself.&lt;/p&gt;

&lt;h3&gt;ðŸ›¸ Leaving the Mothership: Fewer Round Trips&lt;/h3&gt;

&lt;p&gt;Although co-locating our service with rails got us off the ground, it required significant duct tape. We had invested a lot of work building nice deployment systems for HTTP services and we didnâ€™t want to re-invent that tooling for socket-based side-car apps. The thing that was preventing the migration was having too many round-trip requests to the Rails app. How could we reduce the number of round trips?&lt;/p&gt;

&lt;p&gt;As we moved MySQL query generation to our new service, we started to see this pattern in our routes:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;MySQL Read some data       â”
Ruby  Do some processing   â”‚ candidate 1 for
MySQL Read some more data  â”˜ extraction
Ruby  More processing
MySQL Write some data      â”
Ruby  Processing again!    â”‚ candidate 2 for
MySQL Write more data      â”˜ extraction
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To reduce latency, weâ€™d have to bundle reads and writes: In addition to porting reads &amp;amp; writes to the new service, weâ€™d have to port the ruby logic &lt;em&gt;between&lt;/em&gt; reads and writes, which would be a lot of work.&lt;/p&gt;

&lt;p&gt;What if instead, we could &lt;em&gt;change&lt;/em&gt; the order of operations and make it look like this?&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;MySQL Read some data       â” candidate 1 for
MySQL Read some more data  â”˜ extraction
Ruby  Do some processing
Ruby  More processing
Ruby  Processing again!
MySQL Write some data      â” candidate 2 for
MySQL Write more data      â”˜ extraction
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then weâ€™d be able to extract batches of queries to Haskell and leave the logic behind in Rails.&lt;/p&gt;

&lt;p&gt;One concern we had with changing the order of operations like this was the possibility of a request handler &lt;em&gt;first&lt;/em&gt; writing some data to the database, then reading it back again later. Changing the order of read and write queries would result in such code failing. However, since we now had a complete and accurate picture of &lt;em&gt;all&lt;/em&gt; the queries the Rails code was making, we knew (luckily!) we didnâ€™t need to worry about this.&lt;/p&gt;

&lt;p&gt;Another concern was the risk of a large refactor like this resulting in regressions causing long feedback cycles and breaking the Quiz Engine. To avoid this we tried to keep our refactors as dumb as possible: Specifically: we mostly did a lot of inlining. We would start with something like this&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;class QuizzesControllller  9000
          :super_saiyan
        else
          load_sub_syan_fun_type # TODO: inline me
        end
      end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;These are refactors with a relatively small chance of changing behavior or causing regressions.&lt;/p&gt;

&lt;p&gt;Once the query was at the top level of the code it became clear when we needed data, and that understanding allowed us to push those queries to happen first.&lt;/p&gt;

&lt;p&gt;e.g. from above, we could easily push the previously obscured &lt;code&gt;QuizForFun&lt;/code&gt; query to the beginning:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;class QuizzesControllller  9000
        :super_saiyan
      else
        load_sub_syan_fun_type # TODO: inline me
      end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You might expect our bout of inlining to introduce a ton of duplication in our code, but in practice, it surfaced a lot of dead code and made it clearer what the functions we left behind were doing. That wasnâ€™t what we set out to do, but still, nice!&lt;/p&gt;

&lt;h2&gt;ðŸ‘› Phase 2: Changing the Quiz Engine datastore&lt;/h2&gt;

&lt;p&gt;At this point all interactions with the Quiz Engine datastore were going through this &lt;strong&gt;&lt;em&gt;new&lt;/em&gt;&lt;/strong&gt; Quiz Engine service. Excellent! This means for the second part of this project, the part where we were actually going to avert the MySQL apocalypse, we wouldnâ€™t need to worry about our legacy Rails code.&lt;/p&gt;

&lt;p&gt;To facilitate easy refactoring, we built this new service in Haskell. The effect was immediately noticeable. Like an embargo had been lifted, from this point forward we saw a constant trickle of small productive refactors get mixed in the work we were doing, slowly reshaping types to reflect our latest understanding. Changes we wouldnâ€™t have made on the Rails side unless weâ€™d have set aside months of dedicated time. Haskell is a great tool to use to manage complexity!&lt;/p&gt;

&lt;p&gt;The centerpiece of this phase was the architectural change we were planning to make: switching from MySQL to a horizontally scalable storage solution. But honestly, figuring the architecture details here wasnâ€™t the most interesting or challenging portion of the work, so weâ€™re just putting that aside for now. Maybe weâ€™ll return to it in a future blog post (sneak peek: we ended up using Redis and Kafka). Like in step 1, the biggest question we had to solve was &lt;strong&gt;&lt;em&gt;â€œhow are we going to make it safe to move forward quickly?â€&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;One challenge was that we had left most of our test suite behind in Rails in phase one, so we were not doing too well on that front. We added Haskell test coverage of course, including many &lt;strong&gt;&lt;em&gt;golden result tests&lt;/em&gt;&lt;/strong&gt; which are worth a post on their own. Together with our QA team we also invested in our Cypress integration test suite which runs tests from the browser, thus integration-testing the combination of our Rails and Haskell code.&lt;/p&gt;

&lt;p&gt;Our most useful tool in making safe changes in this phase however was our production traffic. We started building up what was effectively a parallel Haskell service talking to Redis next to the existing one talking to MySQL. Both received production load from the start, but until the very end of the project only the MySQL code pathsâ€™ response values were used. When the Redis code path didnâ€™t match the MySQL, weâ€™d log a bug. Using these bug reports, we slowly massaged the Redis code path to return identical data to MySQL.&lt;/p&gt;

&lt;p&gt;Because we werenâ€™t relying on the output of the Redis code path in production, we could deploy changes to it many times a day, without fear of breaking the site for students or teachers. These deploys provided frequent and fast feedback. Deploying frequently was made possible by the Haskell Quiz Engine code living in its own service, which meant deploys contained only changes by our team, without work from other teams with a different risk profile.&lt;/p&gt;

&lt;h2&gt;ðŸ¥ So, did it work?&lt;/h2&gt;

&lt;p&gt;Itâ€™s been about a month since weâ€™ve switched entirely to the new architecture and itâ€™s been humming along happily. By the time we did the official switch-over to the new datastore it had been running at full-load (but with bugs) for a couple of months already. Still, we were standing ready with buckets of water in case we overlooked something. Our anxiety was in vain: the roll-out was a non-event.&lt;/p&gt;

&lt;p&gt;Architecture, plans, goals, were all important to making this a success. Still, we think the thing most crucial to our success was continuously improving our feedback loops. Fast feedback (lots of deploys), accurate feedback (knowing &lt;strong&gt;all&lt;/strong&gt; the MySQL queries Rails is making), detailed feedback (lots of context in error reports), high signal/noise ratio (removing errors we were not planning to act on), lots of coverage (many students doing quizzes). Getting this feedback required us to constantly tweak and create tooling and new processes. But even if these processes were sometimes short-lived, they&amp;rsquo;ve never been an overhead, allowing us to move so much faster.&lt;/p&gt;</description><link>https://blog.noredink.com/post/657392972659310592</link><guid>https://blog.noredink.com/post/657392972659310592</guid><pubDate>Thu, 22 Jul 2021 03:26:33 -0400</pubDate><category>engineering</category></item><item><title>A QA Interview We Never Used

About five years ago I was working on a QA interview process and got...</title><description>&lt;h1&gt;A QA Interview We Never Used&lt;/h1&gt;

&lt;p&gt;About five years ago I was working on a QA interview process and got the following suggestion: â€œYouâ€™ve just arrived at the airport and have two hours before your flight to Hawaii. Make a list of everything that could go wrong between now and when the flight lands.â€&lt;/p&gt;

&lt;p&gt;No information about how to assess the candidateâ€™s response was provided, and I had another concern. I remembered growing up in Maine and taking a vacation once a year: weâ€™d rent a house on a lake for a week and drive to it in the family car. For my parents, this type of vacation was a huge luxury, something the generation before had never been able to do; I doubt flying to Hawaii, or anywhere else, ever really entered their minds. At the age of 23, I had flown a total of three times in my life, and always between New England and Arizona.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;p&gt;All this is to say that I was worried about cultural bias in the interview, a worry I admit I wouldnâ€™t had thought of if it had simply been presented as, say, a road trip. But it seemed that frequent flyers, who could readily access detailed images of airport parking lots, terminals, and the planes themselves, would have a distinct advantage that was unrelated to the testing skills I wanted to measure, so I didnâ€™t include it in my set of interviews.&lt;/p&gt;

&lt;p&gt;But there was something else I liked about the interview. It got at what itâ€™s like to be a tester. Looking for risk and points of failure. Questioning assumptions. Viewing every transition from moment to moment or state to state (house, car, pre-security, post-security, boarding, flying, deplaningâ€¦) with skepticism, wondering where things might come apart and replaying them over and over, looking for faults. And as one of those people who often reflexively lists things that might go wrong in regular life for no reason and when no one asked, perhaps I felt this interview honored a behavior that annoys others. So a few years later, on a flight to San Francisco, I made my own version, which I then promptly forgot about. A few years after that, the QA team was redesigning parts of our interview process, and I remembered it and shared it with my colleagues.&lt;/p&gt;

&lt;hr&gt;

&lt;h2&gt;Testing mindset interview&lt;/h2&gt;

&lt;h3&gt;Introduction&lt;/h3&gt;

&lt;p&gt;In this interview, youâ€™ll be presented with a scenario and asked to offer reasons for how the information presented in the scenario could be possible. To avoid a list of very similar reasons, we ask that you stretch your imagination and try to consider as many different &lt;em&gt;categories&lt;/em&gt; of reasons as possible. What does &lt;em&gt;categories&lt;/em&gt; mean?&lt;/p&gt;

&lt;p&gt;Dividing anything into categories can be arbitrary, of course. To give you an idea of how weâ€™ve divided things into categories, consider the example scenario below (we donâ€™t want to spoil answers by discussing the real scenario yet). The example scenario is similar to the one weâ€™ll present as the real interview question.&lt;/p&gt;

&lt;h3&gt;Example Scenario&lt;/h3&gt;

&lt;p&gt;Suppose you were asked to make a list of every danger you might face while hiking through a forest. To start, you might say, I could get attacked by a wolf, or trampled by a deer, or struck from above by a hawk. While these experiences are undoubtedly vastly different, they all involve an animal attacking you, and weâ€™d say they fit into a single category. You might also suggest, for example, that you could be attacked by an empty suit of armor; while somewhat more poetic, this still falls, in our opinion, under the category of â€œsomething attacks meâ€, and doesnâ€™t require a new category to hold it. If you mentioned accidentally ingesting a poisonous mushroom, though, we wouldnâ€™t try to argue that the mushroom belongs in the same class as the other attacking entities â€” this is a new category, perhaps something along the lines of â€œingesting dangerous thingsâ€.&lt;/p&gt;

&lt;p&gt;For this exercise, try to keep our rough ideas of categories in mind. Weâ€™ll ask you to provide examples for a specific situation, and weâ€™ll be looking for how many different categories your examples cover. While it doesnâ€™t hurt you to list many things from the same category, it doesnâ€™t help, either. We encourage you to write down everything that comes to mind, but focus on trying to think of new ideas that arenâ€™t closely related to what youâ€™ve already written.&lt;/p&gt;

&lt;h3&gt;The Real Scenario&lt;/h3&gt;

&lt;p&gt;You enter an empty cabin. The entrance is to a kitchen, where a table holds three identical bowls of porridge. On the stovetop, a much larger pot of porridge sits over a low heat. As you brazenly devour the porridge, you notice that the contents of the bowls are not identical after all â€” the porridge in the first bowl is scalding hot, while the porridge in the second bowl is freezing cold, and the porridge in the third bowl is a pleasant temperature, somewhere between the two extremes of the other bowls.&lt;/p&gt;

&lt;p&gt;What are some possible reasons that the porridges were not all the same temperature?&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;I liked my scenario because I felt it didnâ€™t require too much knowledge from any particular domain. Deep knowledge of cooking, heating and cooling, or fairy tales wouldnâ€™t, I guessed, confer much advantage. It also offered a certain level of whimsy that I felt would serve as an appropriate warning for anyone who might have to work with me.&lt;/p&gt;

&lt;p&gt;But a concern remained. It was one of my two concerns from five years ago: how to assess the candidateâ€™s response? Was there a fair and objective way to do it? I intended to go through the candidateâ€™s list (â€œsomeone added ice to one bowl and hot water to anotherâ€, â€œsomething is wrong with my nerve endingsâ€) and check off every distinct category theyâ€™d identified (â€œinterference from outside actorâ€, â€œerror in measurementâ€), but even if I created a near-perfect list of categories (I felt close), could I really communicate what size of categories I had created to the candidate without giving away answers? (Probably not). When I actually practiced the interview with a colleague, things deteriorated further, as many of her answers fell into a gray area as to whether or not they should count for a particular category.&lt;/p&gt;

&lt;p&gt;Time ticks on, cooling our porridge and bringing deadlines rushing to meet us. I kept thinking about the problem, but an epiphany never came. With no solution to problem of a fair scoring system, I scrapped the interview and wrote this blog post instead.&lt;/p&gt;

&lt;p&gt;Do you give (or have you taken) any kind of QA interview like this? Let me know on one of the social platforms below.&lt;/p&gt;

&lt;p&gt;&lt;a href="https://imgur.com/GM9jgvG"&gt;&lt;/a&gt;&lt;/p&gt;

&lt;figure data-orig-height="120" data-orig-width="120" data-orig-src="https://i.imgur.com/GM9jgvG.png"&gt;&lt;img src="https://64.media.tumblr.com/e3bbf35e0c4b63d7555504fd1cd119b1/0038a4477b45661c-25/s540x810/85fc1b971bfe020d9fd167e7d56e4bc354d9daec.png" title="source: imgur.com" data-orig-height="120" data-orig-width="120" data-orig-src="https://i.imgur.com/GM9jgvG.png"/&gt;&lt;/figure&gt;

&lt;p&gt;
&lt;strong&gt;Alexander Roy&lt;/strong&gt;
QA Analyst | NoRedInk&lt;/p&gt;

&lt;p&gt;&lt;a href="https://www.linkedin.com/in/aroy3"&gt;LinkedIn&lt;/a&gt; | &lt;a href="https://github.com/blunderdome/"&gt;Github&lt;/a&gt; | &lt;a href="https://twitter.com/alexanderoroy"&gt;Twitter&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks to Kristine Horn for her help while I was still trying to salvage the interview, and to Michael Glass and Charlie Koster for reviewing this blog post.&lt;/p&gt;</description><link>https://blog.noredink.com/post/644458637097598977</link><guid>https://blog.noredink.com/post/644458637097598977</guid><pubDate>Mon, 01 Mar 2021 08:00:50 -0500</pubDate><category>qa</category><category>interviewing</category><category>engineering</category></item><item><title>What would you pay for type checking?</title><description>&lt;p&gt;Hereâ€™s a statement that shouldnâ€™t be controversial, but is anyway: &lt;strong&gt;JavaScript is a type-checked language.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Iâ€™ve heard people refer to JavaScript as â€œuntypedâ€ (implying that it has no concept of types), which is odd considering JS&amp;rsquo;s most infamous errorâ€”â€œundefined is not a functionâ€â€”is literally an example of the language reporting a type mismatch. How could a supposedly â€œuntypedâ€ language throw a &lt;code&gt;TypeError&lt;/code&gt;? Is JS aware of types or isn&amp;rsquo;t it?&lt;/p&gt;

&lt;p&gt;Of course, the answer is that JavaScript is a type-checked language: its types are checked at runtime. The fact that the phrase â€œJavaScript is a type-checked languageâ€ can be considered controversial is evidence of the bizarre tribalism weâ€™ve developed around when types get checked. I mean, is it not accurate to say that JavaScript checks types at runtime? Of course it&amp;rsquo;s accurate! &lt;em&gt;Undefined is not a function!&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;Truly Untyped Languages&lt;/h2&gt;

&lt;p&gt;&lt;a href="https://en.wikipedia.org/wiki/Assembly_language"&gt;Assembly language&lt;/a&gt; does not have â€œundefined is not a function.â€&lt;/p&gt;

&lt;p&gt;This is because it has neither build time nor runtime type checking. Itâ€™s essentially a human-readable translation of &lt;a href="https://en.wikipedia.org/wiki/Machine_code"&gt;machine code&lt;/a&gt;, allowing you to write &lt;code&gt;add&lt;/code&gt; instead of having to handwrite out the number corresponding to an addition machine instruction.&lt;/p&gt;

&lt;p&gt;So what happens if you get a runtime type mismatch in Assembly? If it doesnâ€™t check the types and report mismatches, like JavaScript does, what does it do?&lt;/p&gt;

&lt;p&gt;Letâ€™s suppose Iâ€™ve written a function that capitalizes the first letter in a lowercase string. I then accidentally call this code on a number instead of a string. Whoops! Letâ€™s compare what would happen in JavaScript and in Assembly.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Since Assembly doesn&amp;rsquo;t have low-level primitives called â€œnumberâ€ or â€œstring,â€ let me be a bit more specific. For â€œnumberâ€ Iâ€™ll use a 64-bit integer. For â€œstringâ€ Iâ€™ll use the definition C would use on a 64-bit system, namely â€œa 64-bit memory address pointing to a sequence of bytes ending in 0.â€ To keep the example brief, the function will assume the string is ASCII encoded and already begins with a lowercase character.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The assembly code for my â€œcapitalize the first letter in the stringâ€ function would perform roughly the following steps.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Treat my one 64-bit argument as a memory address, and load the first byte from memory at that address.&lt;/li&gt;
&lt;li&gt;â€œCapitalizeâ€ that byte by subtracting 32 from it. (In ASCII, subtracting 32 from a lowercase letterâ€™s character code makes it uppercase.)&lt;/li&gt;
&lt;li&gt;Write the resulting byte back to the original memory address.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If I call this function passing a â€œstringâ€ (that is, a memory address to the beginning of my bytes), these steps will work as intended. The function will capitalize the first letter of the string. Yay!&lt;/p&gt;

&lt;p&gt;If I call this function passing a normal integerâ€¦yikes. Here are the steps my Assembly code will once again faithfully perform:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Treat my one 64-bit argument as a memory address, even though itâ€™s actually supposed to be an integer. Load the first byte from whatever memory happens to be at that address. This may cause a &lt;a href="https://en.wikipedia.org/wiki/Segmentation_fault"&gt;segmentation fault&lt;/a&gt; (crashing the program immediately with the only error information being â€œSegmentation faultâ€) due to trying to read memory the operating system would not allow this process to read. Letâ€™s proceed assuming the memory access happened to be allowed, and the program didnâ€™t immediately crash.&lt;/li&gt;
&lt;li&gt;â€œCapitalizeâ€ whatever random byte of data we have now loaded by subtracting 32 from it. Maybe this byte happened to refer to a student&amp;rsquo;s test score, which we just reduced by 32 points. Or maybe we happened to load a character from the middle of a different string in the program, and now instead of saying â€œWelcome, Dave!â€ the screen says â€œWelcome, $ave!â€ Who knows? The data we happen to load here will vary each time we run the program.&lt;/li&gt;
&lt;li&gt;Write the resulting byte back to the original memory address. Sorry, kid - your test score is just 32 points lower now.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Hopefully we can all agree that â€œundefined is not a functionâ€ is a significant improvement over segmentation faults and corrupting random parts of memory. Runtime type checking can prevent &lt;a href="https://en.wikipedia.org/wiki/Memory_safety"&gt;memory safety&lt;/a&gt; problems like this, and much more.&lt;/p&gt;

&lt;p&gt;Bytes are bytes, and many machine instructions donâ€™t distinguish between bytes of one type or another. Whether done at build time or at runtime, having some sort of type checking is the only way to prevent disaster when weâ€™d otherwise instruct the machine to interpret the bytes the wrong way. â€œTypes for bytesâ€ was the original motivation for introducing type checking to programming, although it has long since grown beyond that.&lt;/p&gt;

&lt;h2&gt;Objective Costs of Checking Types&lt;/h2&gt;

&lt;p&gt;Itâ€™s rare to find discussions of objective tradeoffs in the sea of â€œstatic versus dynamicâ€ food fights, but this example actually illustrates one.&lt;/p&gt;

&lt;p&gt;As the name suggests, runtime type checking involves doing type checkingâ€¦at runtime! The reason JavaScript wouldnâ€™t cause a segmentation fault or corrupt data in this example, where Assembly would, is that JavaScript would generate more machine instructions than the Assembly version. Those instructions would record in memory the types of each value, and then before performing a certain operation, first read the type out of memory to decide whether to proceed with the operation or throw an error.&lt;/p&gt;

&lt;p&gt;This means that in JavaScript, a 64-bit number often takes up more than 64 bits of memory. Thereâ€™s the memory needed to store the number itself, and then the extra memory needed to store its type. Thereâ€™s also more work for the CPU to do: it has to read that extra memory and check the type before performing a given operation. In Python, for example, &lt;a href="https://code.tutsplus.com/tutorials/understand-how-much-memory-your-python-objects-use--cms-25609"&gt;a 64-bit integer takes up 192 bits&lt;/a&gt; (24 bytes) in memory.&lt;/p&gt;

&lt;p&gt;In contrast, build time type checking involves doing type checkingâ€¦at build time! This does not have a runtime cost, but it does have a build-time cost; an objective downside to build-time type checking is that you have to wait for it.&lt;/p&gt;

&lt;p&gt;Programmer time is expensive, which implies that programmers being blocked waiting for builds is expensive. Elmâ€™s compiler builds so fast that at &lt;a href="https://www.noredink.com"&gt;NoRedInk&lt;/a&gt; weâ€™d have paid a serious &lt;a href="https://www.xkcd.com/303/"&gt;â€œcodeâ€™s compilingâ€&lt;/a&gt; productivity tax if we had chosen TypeScript insteadâ€”to say nothing of what weâ€™d have missed in terms of &lt;a href="https://youtu.be/a0039_JRAQo"&gt;programmer happiness&lt;/a&gt;, &lt;a href="https://elm-lang.org/news/blazing-fast-html-round-two"&gt;runtime performance&lt;/a&gt;, or the &lt;a href="https://youtu.be/5CYeZ2kEiOI"&gt;reliability of our product&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;That said, using a language without build-time checking will not necessarily cause you to spend less time waiting. &lt;a href="https://stripe.com/"&gt;Stripe&lt;/a&gt;â€™s programmers would commonly wait 10-20 seconds for one of their Ruby tests to execute, but &lt;a href="https://sorbet.org/"&gt;the Ruby type checker they created w&lt;/a&gt;as able to give actionable feedback on &lt;a href="https://blog.nelhage.com/post/reflections-on-performance/"&gt;their entire code base in that time&lt;/a&gt;. In practice, introducing build-time type checking apparently led them to spend less time overall on waiting.&lt;/p&gt;

&lt;h2&gt;Performance Optimizations for Type Checkers&lt;/h2&gt;

&lt;p&gt;Both build time and runtime type checkers are programs, which means their performance can be optimized.&lt;/p&gt;

&lt;p&gt;For example, &lt;a href="https://en.wikipedia.org/wiki/Just-in-time_compilation"&gt;JIT compilers&lt;/a&gt; can reduce the cost of runtime type checking. JavaScript in 2020 runs multiple orders of magnitude faster than JavaScript in 2000 did, because a massive effort has gone into optimizing its runtime. Most of the gains have been outside the type checker, but JavaScriptâ€™s runtime type checking cost has gone down as well.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Conversely, between 2000 and 2020 JavaScriptâ€™s build times have explodedâ€”also primarily outside type checking. When I first learned JavaScript (almost 20 years ago now, yikes!) it had no build step. The first time I used JS professionally, the entire project had &lt;a href="https://jquery.com"&gt;one dependency&lt;/a&gt;.&lt;/p&gt;
  
  &lt;p&gt;Today, just installing the dependencies for &lt;a href="https://github.com/facebook/create-react-app"&gt;a fresh React project&lt;/a&gt; takes me over a minuteâ€”and thatâ€™s before even beginning to build the project itself, let alone type check it! By contrast, I can build a freshly git-cloned &lt;a href="https://github.com/rtfeldman/elm-spa-example"&gt;4,000-line Elm SPA&lt;/a&gt; in under 1 second total, including installing dependencies and full type checking.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;While they may improve performance overall, JIT compilers introduce their own runtime costs, and cannot make runtime type checking free. Arguably &lt;a href="https://www.rust-lang.org/"&gt;Rust&lt;/a&gt;â€˜s main reason for existence is to offer a reliable and ergonomic programming language which does not introduce the sort of runtime overhead that come with JIT compilers and garbage collectors.&lt;/p&gt;

&lt;p&gt;Build time type checkers are also programs, and their performance can also be optimized.&lt;/p&gt;

&lt;p&gt;We often lump build-time type checking performance into the bucket of â€œcompilation time,â€ but type checking isnâ€™t necessarily the biggest contributor to slow builds. For example, in the case of &lt;a href="https://www.rust-lang.org/"&gt;Rust&lt;/a&gt;, code generation is &lt;a href="https://pingcap.com/blog/rust-compilation-model-calamity/"&gt;apparently a much bigger contributor to compile times&lt;/a&gt; than type checkingâ€”and code generation only begins after type checking has fully completed.&lt;/p&gt;

&lt;p&gt;Some type checkers with essentially equivalent type systems build faster than others, because of performance optimization. For example, the 0.19.0 release of Elm did not change the type system at all, but massively improved build times by implementing &lt;a href="https://github.com/elm/compiler/blob/master/docs/upgrade-instructions/0.19.0.md#compiler-performance"&gt;certain performance optimizations&lt;/a&gt; which (among other things) made part of type inference take &lt;em&gt;O(1)&lt;/em&gt; time instead of &lt;a href="https://www.reddit.com/r/programming/comments/1f2ml3/what_does_olog_n_mean_exactly/ca691yj/"&gt;&lt;em&gt;O(log(n))&lt;/em&gt;&lt;/a&gt; time.&lt;/p&gt;

&lt;h2&gt;Type Systems Influence Performance&lt;/h2&gt;

&lt;p&gt;Type system design decisions arenâ€™t free! At both build time and runtime, type checking performance is limited by the features of the type system itself.&lt;/p&gt;

&lt;p&gt;For example, researchers have developed &lt;a href="http://gallium.inria.fr/~fpottier/publis/emlti-final.pdf"&gt;type inference strategies that run very fast&lt;/a&gt;, but these strategies rely on some assumptions being true about the design of the type system. Introducing certain &lt;a href="https://en.wikipedia.org/wiki/Subtyping"&gt;subtyping&lt;/a&gt; features can invalidate these strategies, so offering such features lowers the ceiling on how fast the compiler can beâ€”and for that matter, whether it can offer type inference.&lt;/p&gt;

&lt;p&gt;Itâ€™s easy to quip â€œyou could guarantee that at build time using ________ typesâ€ (fill in the blank with something like &lt;a href="https://en.wikipedia.org/wiki/Substructural_type_system#Linear_type_systems"&gt;linear types&lt;/a&gt;, &lt;a href="https://en.wikipedia.org/wiki/Refinement_type"&gt;refinement types&lt;/a&gt;, &lt;a href="https://en.wikipedia.org/wiki/Dependent_type"&gt;dependent types&lt;/a&gt;, etc.) but the impact this would have on compilation times is less often discussed.&lt;/p&gt;

&lt;p&gt;If your language introduced a given type system feature tomorrow, what would the impact be on compile times? Has anyone developed a way to check those types quickly? How much value does a given feature need to add to compensate for the &lt;a href="https://www.xkcd.com/303/"&gt;swordfighting downtime&lt;/a&gt; it brings along with it?&lt;/p&gt;

&lt;p&gt;Runtime type checkers are subject to these tradeoffs as well. Python and Clojure have different type systems, for example. So do Ruby and Elixir, and JavaScript and Lua. The degree to which their performance can be optimized (by JIT compilers, for example) depends in part on the design of these type systems.&lt;/p&gt;

&lt;p&gt;Because itâ€™s faster to check some type system features at runtime than at build time, these forces combine to put performance caps on languages which add build time checking to type systems which were designed only with runtime type checking in mind. For example, TypeScriptâ€™s compiler could run faster if it did not need to accommodate JavaScriptâ€™s existing type system.&lt;/p&gt;

&lt;h2&gt;What Would You Pay?&lt;/h2&gt;

&lt;p&gt;Except when writing in a truly untyped language like Assembly, weâ€™re all paying for type checking somewhereâ€”whether at build time, at runtime, or both. That cost varies based on what performance optimizations have been done (such as build-time algorithmic improvements and runtime JITs), and while type system design choices can restrict which optimizations are available, they donâ€™t directly cause performance to be fast or slow.&lt;/p&gt;

&lt;p&gt;Programming involves weighing lots of tradeoffs, and itâ€™s often challenging to anticipate at the beginning of a project what will cause problems later. â€œThe build runs too slowlyâ€ and â€œthe application runs too slowlyâ€ are both serious problems to have, and which programming language you choose puts a cap on how much you can improve either.&lt;/p&gt;

&lt;p&gt;We all have different tolerances for how much weâ€™re willing to pay for this checking, and what we expect to get out of it. Itâ€™s worth thinking critically about these tradeoffs, to make conscious decisions rather than choosing the same technology we chose last time because itâ€™s familiar.&lt;/p&gt;

&lt;p&gt;So the next time youâ€™re starting a project, think about these costs and benefits up front. What would you pay for type checking?&lt;/p&gt;

&lt;p&gt;&lt;img src="https://64.media.tumblr.com/055e1cd45b4f1508ede87bfd03a7ee3a/tumblr_inline_nhxl61eNo41t8do7n.png" alt=""/&gt;&lt;br/&gt;
&lt;strong&gt;Richard Feldman&lt;/strong&gt;&lt;br/&gt;
&lt;a href="https://twitter.com/rtfeldman"&gt;@rtfeldman&lt;/a&gt;&lt;br/&gt;
Head of Technology at &lt;a href="http://noredink.com"&gt;NoRedInk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks to &lt;a href="https://www.brianthicks.com"&gt;Brian Hicks&lt;/a&gt;, &lt;a href="http://stoeffel.github.io"&gt;Christoph Hermann&lt;/a&gt;, &lt;a href="https://medium.com/@ckoster22"&gt;Charlie Koster&lt;/a&gt;, &lt;a href="https://lexi-lambda.github.io"&gt;Alexis King&lt;/a&gt;, and &lt;a href="https://hillelwayne.com"&gt;Hillel Wayne&lt;/a&gt; for reading drafts of this.&lt;/p&gt;</description><link>https://blog.noredink.com/post/190753809533</link><guid>https://blog.noredink.com/post/190753809533</guid><pubDate>Mon, 10 Feb 2020 09:19:40 -0500</pubDate><category>types</category></item><item><title>Cypress in Action: A Few Months In

Three months ago, I wrote Going Automative: Increasing Quality....</title><description>&lt;h1&gt;Cypress in Action: A Few Months In&lt;/h1&gt;

&lt;p&gt;Three months ago, I wrote &lt;a href="https://blog.noredink.com/post/186956536122/going-automative-increasing-quality-to-misquote"&gt;Going Automative: Increasing Quality&lt;/a&gt;. At that time, we (the NoRedInk QA team) had chosen an automated testing tool to use (&lt;a href="https://cypress.io"&gt;Cypress&lt;/a&gt;), and we&amp;rsquo;d used it to start to introduce automation into our testing. Read on to learn how we&amp;rsquo;ve been getting on in the months since then!&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;What&amp;rsquo;s going well?&lt;/h2&gt;

&lt;p&gt;Let&amp;rsquo;s start with the good stuff! Learning and using Cypress has been an overwhelmingly positive experience. We went in as a team of three with very limited experience in automation or development of any kind, and we&amp;rsquo;re really pleased with what we&amp;rsquo;ve produced in a relatively short time.
We have a functional test suite that we&amp;rsquo;re running daily and is helping us achieve much wider coverage of the site than we previously could with our manual testing (as discussed in the &lt;a href="https://blog.noredink.com/post/186956536122/going-automative-increasing-quality-to-misquote"&gt;previous post&lt;/a&gt; there were a set of automated tests but these were not owned by the QA team, and didn&amp;rsquo;t run against an environment as close to production as we&amp;rsquo;d like).
The suite is continuing to expand as we add new tests, but we already have many of the key paths through the site covered.&lt;/p&gt;

&lt;h2&gt;How have we achieved this?&lt;/h2&gt;

&lt;p&gt;Getting moving so quickly has felt like a real achievement, and a number of resources have been hugely helpful to us in these first few months.
First, the Cypress documentation has been a major contributor to our success. The documentation is well written and is something we make use of consistently; the fact that it explains the &lt;em&gt;why&lt;/em&gt; as well as  the &lt;em&gt;how&lt;/em&gt; is a big plus for us.
More broadly, as we&amp;rsquo;ve had the opportunity to start from scratch, we&amp;rsquo;ve been trying to incorporate as many best practices as we can into our codebase before we build any bad habits. While the Cypress documentation helps us with automation-specific best practices, we&amp;rsquo;ve also looked into broader resources to allow us to understand JavaScript best practices. Along those lines, we&amp;rsquo;ve gone further and looped in some of our fantastic engineers, who have graciously paired with us and reviewed our code, all in the name of helping us learn.&lt;/p&gt;

&lt;p&gt;Aside from the documentation, there is also a wealth of other resources out there that we&amp;rsquo;ve used to grow our knowledge and ensure we&amp;rsquo;re doing things in the best way possible. The usefulness of these resources has varied, but some we&amp;rsquo;ve used include:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;a href="https://glebbahmutov.com/blog/"&gt;Gleb Bahmutov&amp;rsquo;s Blog&lt;/a&gt; - as the VP of Engineering at Cypress, Gleb&amp;rsquo;s blog is full of useful tips and tricks!&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href="https://github.com/cypress-io/cypress/issues"&gt;Cypress GitHub Issue Tracker&lt;/a&gt; - the first place we check whenever we see something that doesn&amp;rsquo;t seem quite right. If it&amp;rsquo;s affecting us, it&amp;rsquo;s usually already affected someone else, and the Cypress team are very responsive!&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Cypress webinars - Whilst the direct usefulness of the regular Cypress webinars has varied for us, some have been some very useful and interesting. They have allowed us to pick up a number of good tips and tricks from other Cypress users who&amp;rsquo;ve been in similar situations to ours.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a href="https://gitter.im/cypress-io/cypress"&gt;Cypress Gitter&lt;/a&gt; - the least useful way of communicating with Cypress we&amp;rsquo;ve found, Gitter is a bit of a wall of noise with many conversations taking  place at once, all intertwined with  one another. Whilst there can be useful information in Gitter, it&amp;rsquo;s definitely been a last resort.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;As a team, we&amp;rsquo;ve also made a concerted effort to upskill ourselves in Cypress, JavaScript, and general automation skills. One of our team objectives over the last quarter has been to ensure that we spend time on professional development in these areas. This has included everything from reading blog posts, to attending conferences, to completing online courses.
This effort is already contributing to the quality of the tests we&amp;rsquo;re writing and is putting us in a really strong position as the suite grows.
Thanks to everything we&amp;rsquo;re learning from these resources, we&amp;rsquo;re much better equipped to write better tests each time we start a new one, and we&amp;rsquo;ve even been able to refactor our original tests to improve and future-proof them.&lt;/p&gt;

&lt;h2&gt;It can&amp;rsquo;t all be rainbows and unicorns, right?&lt;/h2&gt;

&lt;p&gt;Whilst our experience using Cypress has been mainly a positive one, it hasn&amp;rsquo;t all been smooth sailing. There have been a few things we&amp;rsquo;ve struggled with, been unable to do, needed workarounds for, or had to follow anti-patterns to accomplish.
One limitation we&amp;rsquo;ve run into is finding that we&amp;rsquo;ve needed to use conditional logic to test some parts of our application. The Cypress docs give a &lt;a href="https://docs.cypress.io/guides/core-concepts/conditional-testing.html"&gt;good explanation&lt;/a&gt; on why using conditional logic is hard and should often be avoided, but in our case, we were stuck with needing to handle different states appearing on a page. In our app, students answer grammar questions which unpredictably appear in a variety of correct or incorrect states. We&amp;rsquo;re currently in a position where we don&amp;rsquo;t have control over the initial answer state, which means that we need to first determine the initial answer state when the question loads in order to know whether we need to change it to the state we desire. We&amp;rsquo;d have to write something along these lines:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;if (initial answer is correct) {
  // do a thing
} else {
  // do a different thing
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Eventually, we solved this thanks to &lt;a href="https://glebbahmutov.com/blog/cypress-tips-and-tricks/#conditional-logic"&gt;Gleb&amp;rsquo;s blog post on conditional logic&lt;/a&gt;, which provides a great example of how to achieve exactly what we were looking for.&lt;/p&gt;

&lt;p&gt;Another area we&amp;rsquo;ve had problems was using the Electron browser headlessly, we have a number of tests which consistently pass without any problems when ran in either Chrome or headed Electron, but will fail when ran headlessly.
This appears to be down to the speed at which actions on our site happen and, as yet, we haven&amp;rsquo;t managed to come up with reliable solution to it. This originally meant missing out on the video recording that Electron headless offered, but with the release of Cypress 3.5 that&amp;rsquo;s no longer an issue as recording is available within Chrome! ðŸŽ‰&lt;/p&gt;

&lt;p&gt;Despite Cypress tests being very quick to run we&amp;rsquo;ve also quite quickly come to a point where we going to very soon be looking into running the tests in parallel to get through them faster.
Some of this need has been caused by the way we&amp;rsquo;re running them - against a hosted staging environment that doesn&amp;rsquo;t have an accessible API we can use to set up data and speed up repetitive parts of tests, meaning everything needs to be done via the UI, which slows things down.
This need for speeding up the test runs has happened sooner than we&amp;rsquo;d initially expected, and whilst it isn&amp;rsquo;t a major issue, it&amp;rsquo;s something we&amp;rsquo;re going to have to consider in the relatively near future.&lt;/p&gt;

&lt;h2&gt;So, what&amp;rsquo;s our overall opinion?&lt;/h2&gt;

&lt;p&gt;Despite the few issues we&amp;rsquo;ve had, it has definitely been a good few months using Cypress. We&amp;rsquo;ve learnt a lot and we&amp;rsquo;ve been able to create tests which add real value in a relatively short period of time.&lt;/p&gt;

&lt;p&gt;Cypress is so easy to install, and to begin using, that we&amp;rsquo;d highly recommend teams looking to start automating their tests give it a try. As with any piece of software it has parts that don&amp;rsquo;t do exactly what we want, or work exactly how we&amp;rsquo;d like, but overall the goods comfortably outweigh the bads!&lt;/p&gt;

&lt;p&gt;From our point of view, we&amp;rsquo;re excited about what the future holds for our tests!&lt;/p&gt;

&lt;p&gt;&lt;br/&gt;&lt;br/&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;a href="https://www.linkedin.com/in/matt-charlton/"&gt;Matt Charlton&lt;/a&gt;&lt;/strong&gt;, Product Quality Specialist at &lt;a href="https://www.NoRedInk.com"&gt;NoRedInk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(thanks to Kristine Horn, Alexander Roy, Michael Newton and Ian Davies for reviewing drafts!)&lt;/p&gt;</description><link>https://blog.noredink.com/post/190625483798</link><guid>https://blog.noredink.com/post/190625483798</guid><pubDate>Mon, 03 Feb 2020 10:00:45 -0500</pubDate><category>engineering</category><category>testing</category><category>qa</category></item><item><title>Type-Safe MySQL Queries via Postgres</title><description>&lt;p&gt;My team and I are working on NoRedInk&amp;rsquo;s transition from Ruby on Rails and MySQL to Haskell and Postgres. A major benefit of our new stack (Postgres/Haskell/Elm) is type-safety between the boundaries (db to backend, backend to frontend). To ensure our code is type-safe between Haskell and &lt;a href="#(https://elm-lang.org/)"&gt;Elm&lt;/a&gt; we use &lt;a href="https://www.servant.dev/"&gt;servant&lt;/a&gt;. Servant allows us to generate types and functions for Elm based on our APIs. To ensure type-safety between Postgres and Haskell we use &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt;. This means that when we change our database schema, our Haskell code won&amp;rsquo;t compile if there is a mismatch, similarly to how our Elm code won&amp;rsquo;t compile if there is a mismatch with our backend endpoints.  We&amp;rsquo;re going to focus on type-safety between our databases and Haskell in this post and on how we introduced MySQL into this.  But first, let&amp;rsquo;s briefly look at how we can check out Postgres queries at compile-time.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2&gt;Postgres-Typed&lt;/h2&gt;

&lt;pre&gt;&lt;code class="hs"&gt;todos :: Int -&amp;gt; PGConnection -&amp;gt; IO [Todo]
todos userId postgresConn = do
  rows &amp;lt;-
    pgQuery
      postgresConn
      [pgSQL|!
        SELECT id, description, completed
        FROM todos
        WHERE user_id = ${userId}
        ORDER BY id ASC
      |]
  pure (fmap todoFromRow rows)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We use &lt;a href="https://wiki.haskell.org/Template_Haskell"&gt;Template Haskell&lt;/a&gt; to write SQL queries instead of a DSL, allowing our engineers to use their existing knowledge of SQL instead of having to learn some library. &lt;code&gt;pgSQL&lt;/code&gt; is a &lt;a href="https://wiki.haskell.org/Quasiquotation"&gt;&lt;code&gt;QuasiQuoter&lt;/code&gt;&lt;/a&gt; it creates a value of type &lt;code&gt;PGQuery&lt;/code&gt; which gets executed by &lt;code&gt;pgQuery&lt;/code&gt;. The quasi quoted query gets verified against the database schema and executed (ignoring results and without arguments) at compile-time. This is all we need to know from &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt; for this post, but I recommend checking out the &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;docs&lt;/a&gt; and looking at their &lt;a href="https://github.com/dylex/postgresql-typed/blob/master/test/Main.hs"&gt;example&lt;/a&gt;.&lt;/p&gt;

&lt;h2&gt;Moving to Haskell and Postgres&lt;/h2&gt;

&lt;p&gt;Our Rails application uses a MySQL database. Gradually moving functionality/new features to Haskell often means that we need access to data that isn&amp;rsquo;t yet moved.  We solved this initially by creating an endpoints on our Rails application and requested the data via http. This proved to be toilsome and complicated development and deploys, and therefore made it harder for teams to commit to building things in Haskell. In order to remove this hurdle, we started to think about reading data directly from our MySQL database. We really liked &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt;, because it gave us the ability to write actual SQL queries and type-safety between the database and Haskell. Unfortunatlly, there isnâ€™t a mysql-typed, but we found an interesting solution provided by Postgres itself; foreign-data-wrappers.&lt;/p&gt;

&lt;h2&gt;Foreign Data Wrappers&lt;/h2&gt;

&lt;p&gt;&lt;a href="https://wiki.postgresql.org/wiki/Foreign_data_wrappers"&gt;Foreign Data Wrappers&lt;/a&gt; (short fdw) offer a way to manage remote data directly within your Postgres database. This allows us to use &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt; to access the MySQL data via Postgres.&lt;/p&gt;

&lt;pre&gt;&lt;code class="sql"&gt;CREATE SERVER mysql-schema-name
  FOREIGN DATA WRAPPER mysql_fdw
  OPTIONS (host '${host}', port '${port}');

-- Mapping for the application user, so it can perform queries.
CREATE USER MAPPING FOR ${username}
  SERVER mysql-schema-name
  OPTIONS (username '${username}', password '${passphrase}');

CREATE SCHEMA mysql-schema-name AUTHORIZATION ${username};

IMPORT FOREIGN SCHEMA ${dbname}
  FROM SERVER mysql-schema-name
  INTO mysql-schema-name;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Unfortunately, we quickly ran into problems when converting http requests to the Rails application with queries directly to MySQL. Fdw has some limitations that were blockers for use. The schema imported as a fdw is imported without any constraints other than &lt;code&gt;NOT NULL&lt;/code&gt;. An even bigger problem was that some SQL constructs werenâ€™t pushed down to MySQL. As an example the fdw wouldnâ€™t forward &lt;code&gt;LIMIT&lt;/code&gt; clauses and therefore grab all rows of a table, send them over the wire, and then apply the &lt;code&gt;LIMIT&lt;/code&gt; in Postgres. This obviously has huge performance implications and meant that we needed to find a different solution without suffering type-safety.&lt;/p&gt;

&lt;h2&gt;Type-Safe MySQL Queries&lt;/h2&gt;

&lt;p&gt;We had three options; either find a library that would give us the guarantees we were used to from &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt; for MySQL, building our own library or somehow abusing &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt;.  Building our own library wasn&amp;rsquo;t an option because that would have exceeded the scope of this project, and we couldn&amp;rsquo;t find a library that met our requirements.  Fortunately, &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt; allows us to access &lt;code&gt;getQueryString&lt;/code&gt; to get the raw query string from the quasi-quoted query. This we can then execute with &lt;a href="http://hackage.haskell.org/package/mysql-simple-0.4.5"&gt;mysql-simple&lt;/a&gt; instead of &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt;. This allows us to check MySQL and Postgres queries at compile time using a fdw, but connecting directly to Postgres and MySQL at runtime.  Finally we can write queries to our MySQL database using the same API as for Postgres and having full type-safety between the database and Haskell.&lt;/p&gt;

&lt;pre&gt;&lt;code class="hs"&gt;cats :: Database.MySQL.Simple.Connection -&amp;gt; IO [Cat]
cats mySQLConnection = do
  rows &amp;lt;-
    Database.MySQL.Simple.query_
      mySQLConnection $ -- direct connection to MySQL
      remove "mysql-schema-name." $
      -- ^ The schemaname (fdw) only exists during compile time.
      getQueryString unknownPGTypeEnv
      [pgSql|!
        SELECT id, description, color
        FROM mysql-schema-name.cats
        ORDER BY id ASC
      |]
  pure (fmap catFromRow rows)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Iâ€™ve inlined the functions from &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt; and mysql-simple to keep the code examples simple. We actually have two modules &lt;code&gt;MySQL&lt;/code&gt; and &lt;code&gt;Postgres&lt;/code&gt; that abstract the database specific functions away allowing us to use the exact same API for both databases.&lt;/p&gt;

&lt;h2&gt;Caveats&lt;/h2&gt;

&lt;p&gt;We need to prefix tables with the schema name that we used to import the fdw (see &lt;code&gt;mysql-schema-name.cats&lt;/code&gt; in the example above). Without the prefix the compilation won&amp;rsquo;t succeed. The problem is that we don&amp;rsquo;t have a schema with this name at runtime. We can simply work around this by running &lt;code&gt;Text.replace "mysql-schema-name." "" sqlString&lt;/code&gt; before executing the query.  Queries need to use standard SQL features and shouldn&amp;rsquo;t rely on MySQL specific features. This is actually kind of a feature, because it forces us to write queries in a way that simplifies converting them to Postgres later.&lt;/p&gt;

&lt;h2&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;While this is a nice solution for us, I don&amp;rsquo;t really recommend you to use MySQL in this way. This solution allows us to simplify the transition between Rails/MySQL and Haskell/Postgres. I would love for library like &lt;a href="https://hackage.haskell.org/package/postgresql-typed-0.6.1.0"&gt;postgresql-typed&lt;/a&gt; to exist for MySQL, but it wasn&amp;rsquo;t feasable to build such a thing. Honestly, I don&amp;rsquo;t even know if it would be possible. I hope this post showed you how to create a nice experience for transitioning to a different technology.
Thanks for reading :heart:&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;Special thanks to everyone involved in building this:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href="https://dev.to/asterite"&gt;Ary&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://dev.to/allenap"&gt;Gavin&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://dev.to/jwoudenberg"&gt;Jasper&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://blog.mavnn.co.uk/"&gt;Michael&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description><link>https://blog.noredink.com/post/188829831203</link><guid>https://blog.noredink.com/post/188829831203</guid><pubDate>Tue, 05 Nov 2019 03:14:50 -0500</pubDate><category>engineering</category></item><item><title>Our Summer Retreat!</title><description>&lt;p&gt;&lt;strong&gt;Invest in and take care of each other.&lt;/strong&gt; This core value has shaped our culture and we are committed to keeping it in sight as we continue to grow.&lt;/p&gt;

&lt;p&gt;NoRedInk knows that it takes more than just a feel-great mission and the right job description for people to thrive at work; it also takes feeling connected to your co-workers. We have grown to ~80 employees, but with nearly 50% of our team working remotely across the globe, we go the extra mile(s), literally and figuratively, to ensure that this important sense of team still flourishes. Last month we all went to the Chaminade in Santa Cruz for our fourth annual summer retreat.&lt;/p&gt;

&lt;p&gt;The summer retreat gives NoRedInkers the opportunity to strengthen our connection with our mission, our vision, and each other. This yearâ€™s proved yet again that our eclectic group of personalities meshes beautifully and allows for each of us to be our authentic selves. In sum, we like each other; we really like each other!&lt;/p&gt;

&lt;p&gt;&lt;a href="https://www.flickr.com/photos/25085074@N02/48680073477/in/photostream/" title="group original_.jpg"&gt;&lt;img src="https://live.staticflickr.com/65535/48680073477_46d5977d47_b.jpg" alt="group original_.jpg"/&gt;&lt;/a&gt;&lt;script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"&gt;&lt;/script&gt;&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Day 1:&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;After three days of working together in our San Francisco headquarters, we all boarded a bus and enjoyed a musical two-hour journey south, filled with guitar solos and plenty of group karaoke. We made it just in time to share dinner together overlooking a beautiful sunsetâ€¦.&lt;/p&gt;

&lt;p&gt;&lt;a href="https://www.flickr.com/photos/25085074@N02/48023406092/in/album-72157710591422912/" title="KCL-135.jpg"&gt;&lt;img src="https://live.staticflickr.com/65535/48023406092_a4ecfdebd4_b.jpg" alt="KCL-135.jpg"/&gt;&lt;/a&gt;&lt;script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"&gt;&lt;/script&gt;&lt;/p&gt;

&lt;p&gt;â€¦ and had the rest of the evening to just hang out.&lt;/p&gt;

&lt;p&gt;&lt;a href="https://www.flickr.com/photos/25085074@N02/48680060272/in/photostream/" title="IMG_6924.jpg"&gt;&lt;img src="https://live.staticflickr.com/65535/48680060272_088d702d14_b.jpg" alt="IMG_6924.jpg"/&gt;&lt;/a&gt;&lt;script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"&gt;&lt;/script&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Day 2:Â &lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;The official retreat began with a focus on NRIâ€™s vision and mission. Jeff Scheur, our CEO, led with a presentation highlighting these and outlining this yearâ€™s wins (such as adding two new members to our leadership team, &lt;a href="https://blog.noredink.com/post/186552577578/qa-with-steve-gardner-noredinks-new-vp-of-sales"&gt;Steve&lt;/a&gt; and &lt;a href="https://www.linkedin.com/in/daileychristopher/"&gt;Chris&lt;/a&gt;), where we fell short, and what our focus will be in the next year.&lt;/p&gt;

&lt;p&gt;&lt;a href="https://www.flickr.com/photos/25085074@N02/48646468587/in/photostream/" title="48638107346_4d7df5b566_o.jpg"&gt;&lt;img src="https://live.staticflickr.com/65535/48646468587_d383a2c519_b.jpg" alt="48638107346_4d7df5b566_o.jpg"/&gt;&lt;/a&gt;&lt;script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"&gt;&lt;/script&gt;&lt;/p&gt;

&lt;p&gt;The curriculum team then took over to lead us through a fun exercise that highlighted why teachers need a tool like ours. In small groups, we evaluated student writing samples using the rubrics from three national writing assessments and discussed how our scores compared to the official results. We then came back together as a company to talk about the challenges that standardized writing tests pose for students and teachers and how we can help students develop the skills they need to succeed. Even better, though, these are skills that can be applied across every kind of writing task students will face, so the value of our platform extends well beyond test day!&lt;/p&gt;

&lt;p&gt;Though we packed a lot in, by mid-afternoon, the only thing left on our agenda was to relax and spend quality time together. NRIâ€™ers could be found enjoying the lovely hikes along the property, intense volleyball games, and spontaneous karaoke during the eveningâ€™s Happy Hour. And as it turns out, weâ€™re a group of friends that really does share a love for karaokeâ€” though definitely not the same level of talent for it. While we have some stars, the fact that no would-be singer gets silenced in this crowd is arguably the strongest proof of all that we truly support each other.&lt;/p&gt;

&lt;p&gt;&lt;a href="https://www.flickr.com/photos/25085074@N02/48640778227/in/dateposted/" title="yoga.jpg"&gt;&lt;img src="https://live.staticflickr.com/65535/48640778227_07e778cef3_b.jpg" alt="yoga.jpg"/&gt;&lt;/a&gt;&lt;script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"&gt;&lt;/script&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Day 3:&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Our last day focused on the theme of trust. Although we think this is a strength of ours, the workshop provided a valuable reminder that there is no blanket definition of the key behaviors needed to build trust between colleagues. Learning our different perspectives on the tenets of trust allows us to tailor our actions to what is most meaningful to each other on an individual basis. The mindful mentality that we collectively share is part of what makes NoRedInk a uniquely great company to work for, and this workshop gave us the opportunity to take it another step further.&lt;/p&gt;

&lt;p&gt;Last but not least, we took lots of fun team photos!&lt;/p&gt;

&lt;p&gt;&lt;a href="https://www.flickr.com/photos/25085074@N02/48679591103/in/dateposted/" title="team collage"&gt;&lt;img src="https://live.staticflickr.com/65535/48679591103_52773ef346_b.jpg" alt="team collage"/&gt;&lt;/a&gt;&lt;script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"&gt;&lt;/script&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Post-analysis:Â &lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Being a company that believes in continuous improvement, we asked our team for their feedback on the retreat. Hereâ€™s what NRIâ€™ers had to say about what they most enjoyed about it:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;â€œGetting to meet all the people I have seen only online, and those I donâ€™t regularly work with. This is because I was so impressed with how talented these people are! I feel honored to be part of this team, and challenged and motivated to live up to our standards.â€ (Kelly)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;â€œTeam time! Having the discussions about trust and team norms was really, really helpful considering half of our team is new.â€ (Paige)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;â€œSpending time with lovely coworkers in a beautiful setting, chatting with a variety of individuals in the hot tub, on the grass, at each meal! I loved small group conversations that brought out details and nuances between teams and departments in ways we hadnâ€™t previously discussed.â€ (Danielle)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;â€œItâ€™s just so nice that we truly value and make space for connecting with our coworkers.â€ (Marc)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;â€œSpending time with people I normally only see on video (or not at all). Itâ€™s also always great to see a ton of new faces, get to talking to those people, and realize that we havenâ€™t compromised on hiring and theyâ€™re all folks who are going to embody our core values.â€ (Alexander)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Our winter retreat now has an especially high bar to live up to, but then again, our team has never been one to shy away from a challenge. 95 days to go, but whoâ€™s counting?&lt;/p&gt;

&lt;p&gt;Thereâ€™s room for a few more people though; weâ€™re hiring! Check out our current openings &lt;a href="https://www.noredink.com/jobs"&gt;here&lt;/a&gt;.&lt;/p&gt;</description><link>https://blog.noredink.com/post/187498664348</link><guid>https://blog.noredink.com/post/187498664348</guid><pubDate>Wed, 04 Sep 2019 19:23:43 -0400</pubDate><category>people</category></item><item><title>Going Automative: Increasing Quality

To misquote Jane Austen: it is a truth universally...</title><description>&lt;h1&gt;Going Automative: Increasing Quality&lt;/h1&gt;

&lt;p&gt;To misquote Jane Austen: it is a truth universally acknowledged, that a QA team in possession of a rapidly growing product, must be in want of automated tests.&lt;/p&gt;

&lt;p&gt;That semi-authentic sentiment expresses nicely where the NoRedInk QA team found ourselves at the start of 2019. Our incredible engineering teams were churning out a phenomenal amount of work and new features and enhancements to the existing site were arriving almost quicker than we could keep up.
There was a rapidly approaching point in the future where the manual testing process that we had in place would no longer be enough to cover the site to the level we wanted and needed.&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;p&gt;To combat this less-than-perfect future, we decided it was time for us to start automating some of our manual tests so that we could know that key areas of the site were working even if we didn&amp;rsquo;t have time to walk through them all.
As well as reassuring us that those critical paths were still working, this automation would also help us carve out more time for exploratory testing of those areas that we don&amp;rsquo;t currently have huge opportunity to look into and to come up with new and innovative ways of verifying the site was working exactly as we wanted it to.&lt;/p&gt;

&lt;p&gt;Before we could get there, though, we had to chose a tool with which to implement automation!
To start on this journey, we came up with a number of criteria we wanted an automation tool to fill and considerations we had to bear in mind. These included:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The ability to run the test against any environment we wanted (development, staging, production, etc.)&lt;/li&gt;
&lt;li&gt;No effect on people outside of QA â€” we didn&amp;rsquo;t want to negatively impact the rest of engineering whilst building our test suite&lt;/li&gt;
&lt;li&gt;Integration with existing tools â€” namely &lt;a href="https://percy.io/"&gt;Percy&lt;/a&gt; and &lt;a href="https://www.browserstack.com/"&gt;Browserstack&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Maintainability â€” whilst anything we write will require some maintenance, we don&amp;rsquo;t want to be spending hours a day maintaining flaky tests. We also need the tests to be self-sufficent enough to continue working through events like the back-to-school period when a lot of data on the site is reset&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Having defined what we were looking for our next step was to look at what we already had; there was set of tests, written by the engineers using RSpec &amp;amp; Capybara, which had the advantage of being tied closely to the application code and having the ability to easily create/remove data.
They also covered a good amount of the site already, but came with a few major negative points, namely:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;QA don&amp;rsquo;t own them or know what they cover â€” going through them and learning what cases they include would be almost as big a project as writing our own tests&lt;/li&gt;
&lt;li&gt;They only run against the test environment, either locally or within our CI system (which doesn&amp;rsquo;t have a lot of the 3rd-party systems, etc. running that an environment like staging does), so they aren&amp;rsquo;t an accurate representation of production&lt;/li&gt;
&lt;li&gt;Some of the older ones are becoming classic legacy code and are only really understood by a few engineers&lt;/li&gt;
&lt;li&gt;Any changes we make will affect all of engineering, especially as we&amp;rsquo;re learning and causing flakes and failures, which will reduce our ability to experiment and make mistakes&lt;/li&gt;
&lt;li&gt;As a QA team our flake tolerance can be higher than the entire engineering department and we aren&amp;rsquo;t as concerned about the speed of each test run at the moment&lt;/li&gt;
&lt;li&gt;The learning curve of adding to these tests isn&amp;rsquo;t aligned to current QA skills and the direction we&amp;rsquo;d like to go&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;With those existing tests in mind, we put in place a plan to evaluate a number of possible alternative tools to see if we could find one that better met our goals and needs.
The strategy we came up with was to give each tool a trial run and create the same set of tests in all of them.
The tests we chose to implement included some that we definitely wanted in our future test suite, others that would really push tools&amp;rsquo; abilities, and others still that we were fairly sure none of the tools would be able to achieve successfully. (We weren&amp;rsquo;t wrong!).&lt;/p&gt;

&lt;p&gt;There are hundreds upon hundreds of automation tools available out there, all doing slightly different things in slightly different ways but achieving the same goal of testing a site end-to-end, and it would have been impossible to look at and evaluate all of them.
We settled on four tools, and once we&amp;rsquo;d created the proof of concept tests in each, we had a pretty solid idea of the pros and cons of them:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href="https://nightwatchjs.org/"&gt;Nightwatch&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;âœ… Percy integration&lt;/li&gt;
&lt;li&gt;âœ… Browserstack integration&lt;/li&gt;
&lt;li&gt;âœ… Good, active community support&lt;/li&gt;
&lt;li&gt;âœ… Pretty good documentation&lt;/li&gt;
&lt;li&gt;âŒ Heavy reliance on CSS selectors&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://ghostinspector.com"&gt;Ghost Inspector&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;âœ… Record tests via Chrome extension&lt;/li&gt;
&lt;li&gt;âœ… Easily schedule test runs&lt;/li&gt;
&lt;li&gt;âœ… GUI showing test results&lt;/li&gt;
&lt;li&gt;âœ… Simple Slack integration&lt;/li&gt;
&lt;li&gt;âŒ Test recording isn&amp;rsquo;t 100% accurate; recorded tests often require manual changes&lt;/li&gt;
&lt;li&gt;âŒ GUI for editing tests is confusing&lt;/li&gt;
&lt;li&gt;âŒ Recording captures dynamic CSS selectors that we want to avoid&lt;/li&gt;
&lt;li&gt;âŒ No integration with existing tools&lt;/li&gt;
&lt;li&gt;âŒ Built-in image diff tool is very limited&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://taiko.gauge.org/"&gt;Taiko&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;âœ… Simple REPL&lt;/li&gt;
&lt;li&gt;âœ… Very easy to create simple tests&lt;/li&gt;
&lt;li&gt;âœ… Doesn&amp;rsquo;t use CSS selectors at all&lt;/li&gt;
&lt;li&gt;âŒ Doesn&amp;rsquo;t handle dropdown menus well&lt;/li&gt;
&lt;li&gt;âŒ Chrome only&lt;/li&gt;
&lt;li&gt;âŒ Very limited documentation&lt;/li&gt;
&lt;li&gt;âŒ Feels very new and not fully developed&lt;/li&gt;
&lt;li&gt;âŒ Struggled with a lot of our test cases&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.cypress.io/"&gt;Cypress&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;âœ… Fantastic test runner&lt;/li&gt;
&lt;li&gt;âœ… Don&amp;rsquo;t need to use as many CSS selectors&lt;/li&gt;
&lt;li&gt;âœ… Excellent documentation&lt;/li&gt;
&lt;li&gt;âœ… Good community support&lt;/li&gt;
&lt;li&gt;âœ… Percy integration&lt;/li&gt;
&lt;li&gt;âœ… Very active company in online discussions, webinars, etc.&lt;/li&gt;
&lt;li&gt;âŒ Chrome only&lt;/li&gt;
&lt;li&gt;âŒ Tests can only be recorded in Electron browser&lt;/li&gt;
&lt;li&gt;âŒ Built-in version of Electron is currently out of date&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Following the evaluation of each tool, we gathered our thoughts to decide where we would go from here.
Each member of the team provided their thoughts and selected the tool they thought we should move forwards with, and the overwhelming choice was to introduce Cypress!
A big factor in its favor was simply how it felt to use; at no point was it frustrating, and backed up by its fantastic documentation (which not only explains &lt;em&gt;how&lt;/em&gt; to do things but also &lt;em&gt;why&lt;/em&gt; to do them in a certain way), no problem seemed insurmountable and the answer always seemed to be available.
As introducing automation was going to be a relatively steep learning curve for the team, having a tool which was straight forward to pick up and start using, whilst at the same being able to do everything we wanted, was going to be key in the success of the project.&lt;/p&gt;

&lt;p&gt;In terms of its functionality, Cypress simply seemed to do just about everything that the other tools did &lt;em&gt;better&lt;/em&gt; than any of the other tools, and the things Cypress &lt;em&gt;didn&amp;rsquo;t&lt;/em&gt; do weren&amp;rsquo;t anything that we considered critical or thought we&amp;rsquo;d miss. (The exception to this was Cypress&amp;rsquo;s lack of cross-browser testing, but as Percy allows us to capture snapshots in both Chrome &amp;amp; Firefox, and both Cypress &amp;amp; Percy have plans to introduce more browsers, we decided we could live with this for the time being. Further, around 70% of our users are using Chrome anyway.)
Cypress was also a popular choice amongst the engineering department, who&amp;rsquo;d already been considering it themselves.
Having us introduce it first is also nice way to bring it into the company without affecting any pre-existing processes; this also put us in a nice position as there&amp;rsquo;s a lot of JavaScript knowledge amongst the engineers that we can lean on if we need to!&lt;/p&gt;

&lt;p&gt;With a winner selected, it was then time to come up with an initial coverage plan and start implementing Cypress tests.&lt;/p&gt;

&lt;p&gt;Check back in a few months to see how we&amp;rsquo;re getting on!&lt;/p&gt;

&lt;p&gt;&lt;br/&gt;&lt;br/&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;a href="https://www.linkedin.com/in/matt-charlton/"&gt;Matt Charlton&lt;/a&gt;&lt;/strong&gt;, Product Quality Specialist at &lt;a href="https://www.NoRedInk.com"&gt;NoRedInk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(thanks to Alexander Roy, Brian Hicks, and Kristine Horn for reviewing drafts!)&lt;/p&gt;</description><link>https://blog.noredink.com/post/186956536122</link><guid>https://blog.noredink.com/post/186956536122</guid><pubDate>Mon, 12 Aug 2019 10:00:31 -0400</pubDate><category>engineering</category><category>qa</category></item><item><title>Drag &amp; Drop without Draggables &amp; Dropzones</title><description>&lt;p&gt;Why is building drag &amp;amp; drop UIs so hard? They&amp;rsquo;ve been around for a while, so we would be forgiven for thinking they&amp;rsquo;re a solved problem. Certainly there are high quality libraries to help us build drag &amp;amp; drop UIs, and these days we even have an official HTML5 drag &amp;amp; drop API! What&amp;rsquo;s going on here?&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve come to the conclusion a big part of the problem is our choice of tools. Draggables and dropzones are often the wrong abstraction, and choosing different tools can simplify construction of our drag &amp;amp; drop UIs massively.&lt;/p&gt;

&lt;p&gt;That&amp;rsquo;s a pretty sweeping statement for a broad term like &amp;lsquo;drag &amp;amp; drop&amp;rsquo;, so let&amp;rsquo;s look at three examples of drag &amp;amp; drop UIs built without draggables or dropzones. These examples come from real projects, but I&amp;rsquo;ve stripped them down to their drag &amp;amp; drop essentials for this post. I&amp;rsquo;ll include what I believe to be the most relevant code snippets in this post, and provide links to the full source code.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s start with a quick refresher on draggables and dropzones before we get to the examples.&lt;/p&gt;

&lt;h2&gt;A Refresher on Draggables &amp;amp; Dropzones&lt;/h2&gt;

&lt;p&gt;A draggable is a UI element that follows the cursor when the user presses down on it. A dropzone is a UI element that gets an event when we release a draggable over it.&lt;/p&gt;

&lt;p&gt;For an example lets look at the application &lt;a href="https://trello.com/"&gt;Trello&lt;/a&gt;. Trello allows us to organize cards in lists. We could make the cards draggables and the lists dropzones. That way we&amp;rsquo;d get an event every time a card gets dropped on a list, which we could use to update our app&amp;rsquo;s state with the new location of the card.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://i.imgur.com/x9lpraW.png" alt="A screenshot of the Trello app, showing a card being dragged from one list to another."/&gt;&lt;/p&gt;

&lt;p&gt;On closer inspection though things aren&amp;rsquo;t as clear cut. For example, in the real Trello application it&amp;rsquo;s not necessary to drop a card on top of a list. We can drop a card on some empty space and it will move into the list nearest to where we dropped it. That&amp;rsquo;s much nicer for the user, but it&amp;rsquo;s not clear how to create this behavior using draggables and dropzones.&lt;/p&gt;

&lt;h2&gt;Our first example, A Timeslot Selector&lt;/h2&gt;

&lt;p&gt;Our first example is a UI for selecting a time slot in a day. This UI represents a day as a horizontal bar, in which we can select a slot using drag &amp;amp; drop.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://i.imgur.com/U0Ft47l.gif" alt="Dragging to select a continuous region of time across a bar showing the hours of the day."/&gt;&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;d like to start these examples by imagining what a draggables and dropzones implementation might look like. In this first example it&amp;rsquo;s unclear what our draggables and dropzones even are. We could make the time slider the draggable, because clicking anywhere in it should start the drag operation even if we don&amp;rsquo;t drag the time slider itself. The screen as a whole might serve as a dropzone, because the user should be able to release the cursor anywhere to finish the drag. Already this approach feels pretty hacky, and we haven&amp;rsquo;t even written any code yet!&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s start from scratch without assuming draggables or dropzones. As we regularly do, we&amp;rsquo;ll begin building our Elm application by designing a Model. Our application needs to store a time slot which is nothing more than a start and end hour.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;-- In this example a time slot always covers whole hours,
-- but we could make this minutes or seconds if we wanted.
type alias Model =
    { selectionStart : Hour, selectionEnd : Hour }

type alias Hour =
    Int
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now we turn to implementing the drag &amp;amp; drop behavior, without draggables and dropzones. When the user presses down we store the hour the cursor is over as the &lt;code&gt;selectionStart&lt;/code&gt; field of the timeslot. Then as the cursor moves we will update the &lt;code&gt;selectionEnd&lt;/code&gt; field of the timeslot, until the user releases.&lt;/p&gt;

&lt;p&gt;At any point we will need to know which hour the cursor is over. We can calculate this if we know the position of the cursor and the position and dimensions of the slider on the screen. Lets be optimistic and assume we just get that information on our drag events. If so we can design our &lt;code&gt;Msg&lt;/code&gt; type like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;type alias Msg =
    { event : DragEvent
    , cursor : Coords
    , sliderPosition : Rect
    }


type DragEvent
    = Start
      -- We don't need to do anything special on a Stop event, so we can treat
      -- it the same as a Move event.
    | MoveOrStop


type alias Coords =
    { x : Float, y : Float }


type alias Rect =
    { x : Float, y : Float, width : Float, height : Float }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The information in this &lt;code&gt;Msg&lt;/code&gt; is enough to calculate the hour the cursor is over.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;cursorAtHour : Msg -&amp;gt; Hour
cursorAtHour { cursor, sliderPosition } =
    let
        dx =
            cursor.x - sliderPosition.x

        atMost =
            min

        atLeast =
            max
    in
    (24 * (dx / sliderPosition.width))
        |&amp;gt; floor
        -- Ensure we get a number between 0 and 23, even if the cursor moves to
        -- the left or right of the slider.
        |&amp;gt; atMost 23
        |&amp;gt; atLeast 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All that&amp;rsquo;s left to do is use &lt;code&gt;cursorAtHour&lt;/code&gt; in our &lt;code&gt;update&lt;/code&gt; function. When we get a &lt;code&gt;Start&lt;/code&gt; event we use it to update the &lt;code&gt;selectionStart&lt;/code&gt; field in the model, and when we get a &lt;code&gt;MoveOrStop&lt;/code&gt; event the &lt;code&gt;selectionEnd&lt;/code&gt; field.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;update : Msg -&amp;gt; Model -&amp;gt; Model
update msg model =
    let
        hour =
            cursorAtHour msg
    in
    case msg.event of
        Start -&amp;gt;
            if coordsInRect msg.cursor msg.sliderPosition then
                { selectionStart = hour
                , selectionEnd = hour
                }

            else
                model

        MoveOrStop -&amp;gt;
            { model
                | selectionEnd = hour
            }


coordsInRect : Coords -&amp;gt; Rect -&amp;gt; Bool
coordsInRect =
    Debug.todo "Implementation omitted for brevity."
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And we have an app! Well almost, we&amp;rsquo;ve not discussed where these &lt;code&gt;Msg&lt;/code&gt;s will be coming from. There&amp;rsquo;s a bit of JavaScript responsible for that, which I&amp;rsquo;ll talk more about in a bit. Those wanting to peek ahead can check out the &lt;a href="https://ellie-app.com/6gbc3wS5CYVa1"&gt;time slider source code&lt;/a&gt;.&lt;/p&gt;

&lt;h2&gt;Second example, a polygon editor&lt;/h2&gt;

&lt;p&gt;Our second example is a tool for editing polygons. We want users to be able to pick up a vertex of a polygon and move it somewhere else.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://i.imgur.com/tpsNuZS.gif" alt="Dragging a vertex of a polygon"/&gt;&lt;/p&gt;

&lt;p&gt;See those vertices? Those sure look like draggables! But these vertices are small and easy to miss, so we&amp;rsquo;d want our draggables to be bigger. We could achieve this by making the draggables invisible &lt;code&gt;div&lt;/code&gt; elements centered on these vertices, but that gets us in trouble when the &lt;code&gt;div&lt;/code&gt; elements are so close they overlap. At that point a click won&amp;rsquo;t select the closest vertex but the top vertex.&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;re going to leave those draggables in the toolbox and see how far we can get without them. As usual we start by defining a model to store the polygon we&amp;rsquo;re editing.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;type alias Model =
    { polygon : Polygon
    , draggedVertex : Maybe Id
    }


type alias Polygon =
    Dict Id Coords


type alias Id =
    Int
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The drag starts when the user presses down on a vertex to select it. For this we&amp;rsquo;ll need to calculate the vertex closest to the cursor, which we can do if we know the positions of the cursor and all vertices. Lets create a &lt;code&gt;Msg&lt;/code&gt; type that contains those positions. We can reuse the &lt;code&gt;Coords&lt;/code&gt; and &lt;code&gt;Rect&lt;/code&gt; types from the previous example.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;type alias Msg =
    { event : DragEvent
    , cursor : Coords
    , handlers : List ( Id, Rect )
    }


type DragEvent
    = Start
    | Move
    | Stop
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Perfect! Now we can calculate the rectangle closest to the cursor when the user clicks.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;closestRect : Coords -&amp;gt; List ( id, Rect ) -&amp;gt; Maybe id
closestRect cursor handlers =
    handlers
        |&amp;gt; List.map (Tuple.mapSecond (distance cursor  List.sortBy Tuple.second
        |&amp;gt; List.head
        |&amp;gt; Maybe.map Tuple.first


center : Rect -&amp;gt; Coords
center =
    Debug.todo "Implementation omitted for brevity"


distance : Coords -&amp;gt; Coords -&amp;gt; Float
distance =
    Debug.todo "Implementation omitted for brevity"
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have found the vertex the user picked up we have to move it to the cursor on every &lt;code&gt;Move&lt;/code&gt; event. The resulting &lt;code&gt;update&lt;/code&gt; function looks like this.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;update : Msg -&amp;gt; Model -&amp;gt; Model
update { event, cursor, handlers } model =
    case event of
        Start -&amp;gt;
            { model
                | draggedVertex =
                    handlers
                        |&amp;gt; List.filter
                            (\( _, handler ) -&amp;gt;
                                distance cursor (center handler)  closestRect cursor
            }

        Move -&amp;gt;
            case model.draggedVertex of
                Just id -&amp;gt;
                    { model | polygon = Dict.insert id cursor model.polygon }

                Nothing -&amp;gt;
                    -- The user is dragging the cursor, but nothing was picked up on the
                    -- start event. We'll sit this one out.
                    model

        Stop -&amp;gt;
            { model | draggedVertex = Nothing }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And that&amp;rsquo;s that! Again I skipped over the JavaScript that produces our messages and I promise we&amp;rsquo;ll get to that in a moment. The full &lt;a href="https://ellie-app.com/6gbMHDr6SbGa1"&gt;polygon editor source code&lt;/a&gt; is available for those interested!&lt;/p&gt;

&lt;h2&gt;Last example: an outline editor&lt;/h2&gt;

&lt;p&gt;Our final example is an outline editor. An outline is a tool for organizing our thoughts on a subject, but creating a list of concepts related to the thought, each of which have their own related thoughts, and so forth. The following image shows an example outline which can be re-arranged using drag &amp;amp; drop. We&amp;rsquo;ll keep our scope small again by not bothering with creating and deleting nodes.&lt;/p&gt;

&lt;p&gt;&lt;img src="https://i.imgur.com/0MuKonT.gif" alt="Grabbing a node of an outline and dragging it to a different parent node"/&gt;&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;ll start by creating a model for our outline editor. It will need to keep track of two things: the outline itself and which node we&amp;rsquo;re dragging.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;type alias Model =
    { outline : List OutlineNode
    , draggedNode : Maybe DraggedNode
    }


type alias DraggedNode =
    -- For simplicity sake we're going to use the node's contents as an id.
    -- We get away with that here because we can ensure the nodes are unique:
    -- the user will not be able to edit them in this example.
    { node : String
    , cursorOnScreen : Coords
    , cursorOnDraggable : Coords
    }


type alias OutlineNode =
    Tree String


type Tree a
    = Tree
        { node : a
        , children : List (Tree a)
        }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now we&amp;rsquo;ll need to write behavior for the drag start, move, and end events.&lt;/p&gt;

&lt;p&gt;The drag starts when the user pressed down on a node. We can put an &lt;code&gt;onClick&lt;/code&gt; handler on each node to detect when this happens. We&amp;rsquo;ll skip the implementation in this post, but it&amp;rsquo;s part of the full &lt;a href="https://ellie-app.com/6gbMfDjCnH4a1"&gt;outline editor source code&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;Then, as the user drags a node around we need to update that node&amp;rsquo;s location in the outline. This part we&amp;rsquo;re going to look at in detail.&lt;/p&gt;

&lt;p&gt;Lastly the drag stop event. We already changed the outline while the user was moving the cursor, and so all that&amp;rsquo;s left to do here is change the model to its non-dragging state by setting &lt;code&gt;draggedNode&lt;/code&gt; to &lt;code&gt;Nothing&lt;/code&gt;.&lt;/p&gt;

&lt;h3&gt;Moving nodes in an outline&lt;/h3&gt;

&lt;p&gt;The most challenging part is to decide what the user&amp;rsquo;s intention is. Are they intending to move the dragged node in front of another node, behind it, or nested beneath it?&lt;/p&gt;

&lt;p&gt;Using dropzones we could draw invisible boxes in those positions that activate when the user moves over them, but the experience is unlikely to be great. Make the boxes too small and the user will not spend a lot of time over them, making the interface unresponsive for most of the time. Make the boxes too big and they start to overlap, causing the uppermost box to receive the dragged node even if it&amp;rsquo;s not the closest. And even if we get the boxes right a future update changing page styles might move the boxes, breaking the drag &amp;amp; drop interaction.&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s forget about dropzones and think about the behavior we want. There are candidate positions in the outline where we could drop a dragged node. As the user moves we&amp;rsquo;d like to display the dragged node in whichever of those positions is closest to the cursor. To figure out which position is closest we need to know where they all are. To do that we are going to put invisible elements in the DOM at each position where we can insert the dragged node. Contrary to the dropzones approach we&amp;rsquo;re not going to bother giving these elements any special dimensions or positioning. We want them to just flow with the content on the page, and keep us apprised of their location. These aren&amp;rsquo;t dropzones but beacons.&lt;/p&gt;

&lt;p&gt;Apart from their coordinates in the DOM, our beacons will also need to describe their location in the outline. A beacon can define its location relative to another node in the outline.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;type CandidatePosition
    = Before String
    | After String
    | PrependedIn String
    | AppendedIn String
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We&amp;rsquo;ll create a JSON encoder for this type so we can tag each beacon element with a &lt;a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/data-*"&gt;data attribute&lt;/a&gt; containing its position in the outline. We&amp;rsquo;ll then set up our JavaScript to find all elements with such a data attribute in the DOM and feed their coordinates back to us on each drag event. That will allow us to define a type for drag events containing the positions of our beacons on the screen.&lt;/p&gt;

&lt;pre&gt;&lt;code class="elm"&gt;type alias DragMsg =
    { cursor : Coords
    , beacons : List Beacon
    }


type alias Beacon =
    ( CandidatePosition, Rect )
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Remember the &lt;code&gt;closestRect&lt;/code&gt; function from the polygon example? It&amp;rsquo;s what we need to find the &lt;code&gt;CandidatePosition&lt;/code&gt; closest to the cursor! Once we know which candidate position is closest, all we need is a function to that moves a node to its new position in an outline. It&amp;rsquo;s a tricky function to write, but it doesn&amp;rsquo;t have much to do with drag &amp;amp; drop and so I&amp;rsquo;m skipping the implementation here. I include a solution with the &lt;a href="https://ellie-app.com/6gbMfDjCnH4a1"&gt;outline editor source code&lt;/a&gt;. For those interested in some thoughts on how to approach data transformations like these, I refer to an earlier &lt;a href="https://dev.to/jwoudenberg/conversion-functions-five-stars-2l87"&gt;post on conversion functions&lt;/a&gt;, which includes an example of a similar tree manipulation problem.&lt;/p&gt;

&lt;h2&gt;Necessary JavaScript&lt;/h2&gt;

&lt;p&gt;I promised I&amp;rsquo;d get back at the JavaScript required to make these examples work. All three examples use the same JavaScript code, because it turns out they have the same needs. In every example there&amp;rsquo;s one or more Html elements on the page that we need to track the position and dimensions of as a drag interaction takes place. What our JavaScript code needs to do is generate events when the mouse gets pressed, moved, and released, and bundle with those events the positions of all elements we want to track. We identify those elements by giving them a data attribute with their 'beacon ID&amp;rsquo;.&lt;/p&gt;

&lt;p&gt;There&amp;rsquo;s tons of ways to write this code and I don&amp;rsquo;t believe mine is particularly insightful, so I&amp;rsquo;ll not reprint it here. The &lt;a href="https://gist.github.com/jwoudenberg/38d5f63dcdbb288525f1694f238bd4ed"&gt;draggable.js source code&lt;/a&gt; for these examples is available though for those interested.&lt;/p&gt;

&lt;h2&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;When we need to perform a complicated task it&amp;rsquo;s natural to start by looking for a library to do the heavy lifting for us. For building drag &amp;amp; drop interactions libraries give us draggables and dropzones but they are often a bad fit for drag &amp;amp; drop UIs, of which we&amp;rsquo;ve seen three in this post.&lt;/p&gt;

&lt;p&gt;Are drag &amp;amp; drop libraries always a bad idea? I don&amp;rsquo;t think so. In particular there are libraries for specific drag &amp;amp; drop widgets such as re-arrangable lists, for example &lt;a href="https://package.elm-lang.org/packages/annaghi/dnd-list/latest/"&gt;annaghi/dnd-list&lt;/a&gt;. Using those when possible could save a lot of time. There are probably UIs where draggables and dropzones are precisely the right abstraction. Please send me a note if you ran into one of those, I&amp;rsquo;d love to learn about it! Drag &amp;amp; drop covers an incredibly broad range of functionality though, and so often an off-the-shelf solution will not be available. For those I&amp;rsquo;d put serious thought into whether draggables and dropzones are going to help build the UI or make it harder.&lt;/p&gt;

&lt;p&gt;I recommend using 'beacon elements&amp;rsquo; if you build your own drag &amp;amp; drop behavior. These are regular DOM elements marked so we can access their location on every drag event. Because beacon elements don&amp;rsquo;t need to &lt;em&gt;do&lt;/em&gt; anything any element using any positioning strategy can be a beacon. This passive nature distinguishes beacons from draggables or dropzones, both of which include behavior.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve showed a different approach to building drag &amp;amp; drop UIs. In this approach we subscribe to drag &amp;amp; drop events telling us what&amp;rsquo;s happening in the DOM, update the state of our model based on those events, and finally update the screen to reflect the new state of the model. This is nothing more than the Elm architecture. I hope the examples in this post show writing drag &amp;amp; drop logic does not need to be an arduous task.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Jasper Woudenberg&lt;/strong&gt; &lt;a href="https://twitter.com/jasperwoudnberg"&gt;@jasperwoudnberg&lt;/a&gt; Engineer at &lt;a href="https://www.noredink.com/"&gt;NoRedInk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks to Ary, Blake, Brian and StÃ¶ffel for their reviews of drafts!&lt;/p&gt;</description><link>https://blog.noredink.com/post/186724971283</link><guid>https://blog.noredink.com/post/186724971283</guid><pubDate>Fri, 02 Aug 2019 12:12:20 -0400</pubDate><category>engineering</category></item><item><title>Celebrating Launches</title><description>&lt;p&gt;Imagine this: your team has just spent months on a big release, and you just hit the buttonâ€¦ it&amp;rsquo;s live! Over the next couple of days, you look at your metrics and people are using it. Hooray, this just keeps getting better and better!&lt;/p&gt;

&lt;p&gt;So, what do you do?&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;re anything like me, you celebrate quietly to yourself and keep working. Celebrating the team is something you know you should doâ€”especially as a leaderâ€”but it&amp;rsquo;s not obvious how to do it well. We&amp;rsquo;ve all seen cheerful but halfhearted office celebrations in pop cultureâ€¦ under-inflated balloons tacked to the walls of a conference room, served with stale cake and a side of awkward conversation. We could set higher standards for ourselves, and meet them too! Imagine how that&amp;rsquo;d make your team feel: appreciated and recognized for their hard work. Your team wants thatâ€¦ don&amp;rsquo;t you?&lt;/p&gt;

&lt;p&gt;So how do we get there? How do we celebrate the team&amp;rsquo;s accomplishments effectively? How do we tell our colleagues &amp;ldquo;thank you for the hard work&amp;rdquo; in a personally meaningful way?&lt;/p&gt;

&lt;p&gt;&lt;!-- more --&gt;&lt;/p&gt;

&lt;p&gt;In team celebrations at NoRedInk, we&amp;rsquo;ve found a couple big principles that help us celebrate effectively:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Involve everyone!&lt;/li&gt;
&lt;li&gt;Celebrate both individual and team accomplishments.&lt;/li&gt;
&lt;li&gt;Give people something they will remember.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Everyone knows that story of being the last picked for some class sportâ€”or worse, experienced it for themselves. Nobody likes feeling left out, so let&amp;rsquo;s make the opposite happen: involve everyone! One of my favorite ways to do this is through peer awards. Everyone gets someone else&amp;rsquo;s name, makes an award for them, and then everyone comes together to present them to each other. Awards can take any form; presenters might be inspired to say a few simple words of appreciation, write and perform a poem or parody song, utilize their amateur (or professional) photo editing skills to create a custom certificate, or even present a short set of slides. Whatever the award is, thereâ€™s always something to celebrate about each person on your team. We&amp;rsquo;ve seen people celebrate their peers for great feats of engineering, for being all around nice people, and on one notable occasion someone made a spoof Mad Max movie trailer for one of our product managersâ€¦ he became &amp;ldquo;Reasonable Max.&amp;rdquo;&lt;/p&gt;

&lt;p&gt;This is a chance for your team to let their creative side outâ€”and even those folks who don&amp;rsquo;t see themselves as &amp;ldquo;creative&amp;rdquo; can recall a time or two in the project that they genuinely appreciated another person. As long as it&amp;rsquo;s done genuinely and in the spirit of celebration, the sky&amp;rsquo;s the limit! Celebrating this way as a team also has a compounding effect: it feels good to make others feel good.&lt;/p&gt;

&lt;p&gt;In addition to recognizing individual accomplishments, don&amp;rsquo;t forget to celebrate the team&amp;rsquo;s accomplishments as a whole. For example, I really enjoy hearing how people are using and enjoying the things my team builds. It drives the point home that we&amp;rsquo;ve really accomplished something. At NoRedInk, where we&amp;rsquo;re making software to build writing skills, this means looking at feedback from students and teachers.
What are teachers seeing in their classrooms? Do students rate themselves as having grown as writers because of using our tools?
I&amp;rsquo;ve found it helpful to get together some reactions from students and teachers to show to the team. Whatever industry you&amp;rsquo;re working in, I bet you can find similar feedback. What are the important numbers in your business? Have you seen them go up? Even internal things can be helpful: how many pull requests did the team open?
How many rounds of design? There&amp;rsquo;s all kinds of great stories in any launch. Share them with your team!&lt;/p&gt;

&lt;p&gt;Finally, it&amp;rsquo;s helpful to give people something they will remember.
When I was on Team Ink, Ashley (our product manager) sculpted little squids for everyone and glued air plants inside. Whenever I visit the office, I have to smile at how folks take such good care of their little squid plant. This can be as complex or as simple as you likeâ€”some teams like creating memories: going to have a picnic at a nearby park or to the team&amp;rsquo;s favorite restaurant. Other teams like to have something physical to keep around: patches or stickers to commemorate a big launch. Whatever you choose, don&amp;rsquo;t forget to include your remote folksâ€”they&amp;rsquo;re as big a part of your team as the people in the office and should be celebrated too!&lt;/p&gt;

&lt;p&gt;â€œWow,â€ you might say, â€œthat sounds like a lot of work. Iâ€™m not sure I have time for that!â€ Iâ€™ve felt that way too. Some parts of this can take time, so if you feel that way then consider starting off with a peer awards ceremony. Itâ€™s just a matter of blocking off 60 minutes on your teamâ€™s calendar, putting everyoneâ€™s emails in a gift exchange generator, and telling them what youâ€™ll all be doing together! All told, it takes about half an hour of organization time. If a peer awards ceremony doesn&amp;rsquo;t sound like a good fit for your team, it&amp;rsquo;s time to brainstorm: write down as many ideas as you can in 10 minutes. Keep your hand moving, even if you&amp;rsquo;re just writing nonsense. What does your team like to do together? Board games? Having a special team lunch? Impromptu dance party? Surely you can come up with even better ideas. After all: you know your team best. The point is to just start. You can do it! It doesn&amp;rsquo;t have to be anything big or fancy, it just has to come from a place of appreciation.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Brian Hicks&lt;/strong&gt; &lt;a href="https://twitter.com/BrianHicks"&gt;@BrianHicks&lt;/a&gt; Engineer at &lt;a href="https://www.noredink.com/"&gt;NoRedInk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(with special thanks to Ashley Chin for extensive editing help!)&lt;/p&gt;</description><link>https://blog.noredink.com/post/186630679177</link><guid>https://blog.noredink.com/post/186630679177</guid><pubDate>Mon, 29 Jul 2019 11:00:36 -0400</pubDate></item><item><title>Q&amp;A with Steve Gardner, NoRedInkâ€™s New VP of Sales and Marketing</title><description>&lt;p&gt;After a long courtship, NoRedInk is thrilled to welcome Steve Gardner and his 26 years of edtech experience to our team as our new VP of Sales and Marketing. A valuable addition to our executive team, Steve will lead the companyâ€™s go-to-market strategy, optimizing our potential to help millions more students strengthen their writing abilities and, in turn, their future prospects.
&lt;/p&gt;

&lt;figure data-orig-width="640" data-orig-height="640" class="tmblr-full"&gt;&lt;img src="https://64.media.tumblr.com/a181401ac944b982c915510a89d66f35/35f78d98884419b5-4c/s540x810/66b99f04286057dfad0db251b2909af4a22130cd.jpg" alt="" data-orig-width="640" data-orig-height="640"/&gt;&lt;/figure&gt;&lt;p&gt;Steve has extensive experience working with high-growth edtech companies in executive roles. Prior to joining NoRedInk, he was SVP of Sales, Marketing and Support at Scientific Learning, VP of Sales at Learning.com, President and CEO of Apta, and founder of NovaNet, a startup that provided full curriculum for all core high school subjects. Over eight short years, he scaled NovaNet to $30 million in revenue before selling it to NCS/Pearson in 2000.&lt;/p&gt;

&lt;p&gt;We are excited to see how much more we can accomplish with Steve on our team. NoRedInk is one of the fastest-growing edtech companies, already used in more than 50% of US school districts, and his deep expertise will enable us to significantly build our team and our impact on students nationwide.&lt;/p&gt;

&lt;p&gt;â€œNot only does Steve have extensive experience scaling sales and marketing organizations in the edtech space,â€ said Jeff Scheur, NoRedInkâ€™s founder and CEO, â€œbut heâ€™s a highly respected leader whoâ€™s known for his aptitude, drive, collaboration skills, and strong sense of integrity. Heâ€™s an excellent culture fit for our leadership team and our organization.â€&lt;/p&gt;

&lt;p&gt;To gain further insight into who he is, we posed a number of questions to Steve. Here is what he had to share:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What excites you most about the opportunity at NoRedInk?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I am excited to join a high-growth company with an extremely talented team that is passionate about improving studentsâ€™ writing skills. With continued investment in growing our sales and marketing organization, we have the opportunity to accelerate our growth and build on the already strong adoption of NoRedInk.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What drew you to Edtech in the first place?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I literally changed my career trajectory after hearing a teacher describe the impact an edtech solution was having on their students. I have always been energized by bringing products to market that help improve student outcomes. NoRedInk is uniquely helping students improve a key skill that will impact their educational and professional success.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What are you passionate about outside of work?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;My family is my primary passion. I am the father of three great boys and our youngest just finished his freshman year at Princeton. I am also an avid road cyclist and you can find me out on the Arizona roads most weekends.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What personal connection do you have to education?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I was fortunate to go to some great schools with some amazing teachers that helped me become a lifelong learner. In my work with schools, I know how hard it can be to give every child that same opportunity. Educational technology and solutions like NoRedInk can help schools and teachers more effectively differentiate instruction to address studentsâ€™ individual needs.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What are you most proud of, personal or career-wise?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I look back on the great companies and teams I have worked with and helped build and am most proud of the difference we have made through that work. I am proud of having a role in helping millions of students become more confident learners.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;NoRedInk is hiring! Check out our &lt;a href="https://www.noredink.com/jobs"&gt;career page&lt;/a&gt; to see our current openings&lt;/b&gt;.&lt;/p&gt;</description><link>https://blog.noredink.com/post/186552577578</link><guid>https://blog.noredink.com/post/186552577578</guid><pubDate>Thu, 25 Jul 2019 22:22:16 -0400</pubDate><category>people</category></item></channel></rss>
